[
    {
        "content": "<p>does anyone know why rfl fails in this case?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">outShape</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">outShape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">outShape</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n<span class=\"n\">termination_by</span>\n<span class=\"w\">    </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">sizeOf_lt_of_mem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">assumption</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">    </span><span class=\"n\">omega</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">    type mismatch</span>\n<span class=\"cm\">    rfl</span>\n<span class=\"cm\">  has type</span>\n<span class=\"cm\">    ?m.4183 = ?m.4183 : Prop</span>\n<span class=\"cm\">  but is expected to have type</span>\n<span class=\"cm\">    (AutoDiffTree.DiffTree.ofComputed x).valid = x.valid : Prop</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 489110119,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734292364
    },
    {
        "content": "<p>Wellfounded definitions are irreducible. Use this to make it work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unseal</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 489119808,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734301422
    },
    {
        "content": "<p>what does unseal do?</p>",
        "id": 489119958,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734301521
    },
    {
        "content": "<p>It locally makes the definition semireducible.</p>",
        "id": 489119976,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734301544
    },
    {
        "content": "<p>so is it like sorry?</p>",
        "id": 489120039,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734301580
    },
    {
        "content": "<p>No, not at all.</p>",
        "id": 489120056,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734301602
    },
    {
        "content": "<p>It allows lean to see the definition of <code>AutoDiffTeee.DiffTree.valid</code>.</p>",
        "id": 489120172,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734301686
    },
    {
        "content": "<p>still broken for me</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unseal</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">rfl</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">tactic 'rfl' failed, the left-hand side</span>\n<span class=\"cm\">  (DiffTree.ofComputed c).valid</span>\n<span class=\"cm\">is not definitionally equal to the right-hand side</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 489120315,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734301812
    },
    {
        "content": "<p>Works fine for me.</p>",
        "id": 489121504,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734302807
    },
    {
        "content": "<p><a href=\"https://live.lean-lang.org/#codez=A4Jw9gLgpgxtAmACAlgO3gVzsgblRAwmALbAYICC5YAIsgGb0AqIUUAdHYy24gBSBG4EQAuREwCewfBgCU/QE3AIsZPw45ogDLIAzhEQA5AIZ7ASYTKp/YoYAeiDIjUAoAD6JiAayVFS5KPCoQtAzMrBxcIbxCimDkAMoAFoZSjo6gkLAIKOhYELj4AUHcoZzBPPiCShIWsgqVKg7qiFq6BsaIZlXlVrb2Tq4ejohD/DEQCUn4mjp6RhAyg8N8wIasqBDaShQgIIbi/IDFwIjaiVIANIgF4WUlRZGIiscTMvPDm9RXxR930XEnUC6IMD0bxkTIAb0eFimLVmAF9RCDfP53qVPqjvkc/u0LijbmF0fgopiJik0tA4H5EPAoPRCCRQX5LgSbhEODhDAAbZBIMFCUSdOywxBgxT8+o4IUQrHQmbGIUI+lIpl4lllRBEyH4MwABXAwBEAF4FvQMKhELYDQA+MQgDD/am05Ws1XFdlcnl88zSSWir0OSWapTNWUQeU4wJffF49X3YkWHV6gFAxGZGCKhBqq2INM+DOuzncgEeRAAfUQy1W60QWcAAETmxCACCJyysoGttOdrOwAEzsN2F6AgYhoYzIMCoEsAI3ECyGeiz2mQAC8oAB5WkQRzUmCsQwL1AAc0n09eiTwSgXy7X9YAPEcl6vaRXW1XhAaLttduwLw+SxyICWgRLYgoGIfgp0QXdtAwUhcjHF5hhgXcoA2awZzvUg0IXUgIL0CB4h0NCSCgfdDBSU1tCgTlw0KZ1I17AskDQRwoGsQxSA5fBeTqaofW41QA2lJpplaUN+FsBVc0ZXFaIJGMHj+Ro+Cda46OTdNKWsGR6PdatzW07lDQWEB6A5RwAHoAFo0Igeoh20KwIBgeI0OM0yhkSDYbOSV4AH5iHYAAWABGAAOABmXS/MC0KItEXUwGABYJ3IFANhYqQKSQQJEFPfAvP+V4lOklTmTUySkE0/SkDfTs+yQOLEwsszHCAA\">https://live.lean-lang.org/#codez=A4Jw9gLgpgxtAmACAlgO3gVzsgblRAwmALbAYICC5YAIsgGb0AqIUUAdHYy24gBSBG4EQAuREwCewfBgCU/QE3AIsZPw45ogDLIAzhEQA5AIZ7ASYTKp/YoYAeiDIjUAoAD6JiAayVFS5KPCoQtAzMrBxcIbxCimDkAMoAFoZSjo6gkLAIKOhYELj4AUHcoZzBPPiCShIWsgqVKg7qiFq6BsaIZlXlVrb2Tq4ejohD/DEQCUn4mjp6RhAyg8N8wIasqBDaShQgIIbi/IDFwIjaiVIANIgF4WUlRZGIiscTMvPDm9RXxR930XEnUC6IMD0bxkTIAb0eFimLVmAF9RCDfP53qVPqjvkc/u0LijbmF0fgopiJik0tA4H5EPAoPRCCRQX5LgSbhEODhDAAbZBIMFCUSdOywxBgxT8+o4IUQrHQmbGIUI+lIpl4lllRBEyH4MwABXAwBEAF4FvQMKhELYDQA+MQgDD/am05Ws1XFdlcnl88zSSWir0OSWapTNWUQeU4wJffF49X3YkWHV6gFAxGZGCKhBqq2INM+DOuzncgEeRAAfUQy1W60QWcAAETmxCACCJyysoGttOdrOwAEzsN2F6AgYhoYzIMCoEsAI3ECyGeiz2mQAC8oAB5WkQRzUmCsQwL1AAc0n09eiTwSgXy7X9YAPEcl6vaRXW1XhAaLttduwLw+SxyICWgRLYgoGIfgp0QXdtAwUhcjHF5hhgXcoA2awZzvUg0IXUgIL0CB4h0NCSCgfdDBSU1tCgTlw0KZ1I17AskDQRwoGsQxSA5fBeTqaofW41QA2lJpplaUN+FsBVc0ZXFaIJGMHj+Ro+Cda46OTdNKWsGR6PdatzW07lDQWEB6A5RwAHoAFo0Igeoh20KwIBgeI0OM0yhkSDYbOSV4AH5iHYAAWABGAAOABmXS/MC0KItEXUwGABYJ3IFANhYqQKSQQJEFPfAvP+V4lOklTmTUySkE0/SkDfTs+yQOLEwsszHCAA</a></p>",
        "id": 489121527,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734302830
    },
    {
        "content": "<p>this breaks rfl tho: <a href=\"https://live.lean-lang.org/#codez=A4Jw9gLgpgxtAmACAlgO3gVzsgblRAwmALbAYICC5YAIsgGb0AqIUUAdHYy24gBSBG4EQAuREwCewfBgCU/QE3AIsZPw45ogDLIAzhEQA5AIZ7ASYTKp/YoYAeiDIjUAoAD6JiAa0eJv/MOQDKABaGFpo6ekYQMl4+fMCGrKgQ2koUICCG4vyAxcCI2sFSADSEJGSU1FzMrByVPPhCivkhUDLRPkpEpORQ8FQQtAxVbJyDdYgNiH4QQc2OjqCQsAgo6FgQuPh9A9zVIzu8gkoSFrIKRyoO6ohaugbGiGbH+HxWtvZOrh4x3nxTM6HXcJ3KLffjxRLJVLpTI5PIFKDFLa1XbI3gTJpSVqg0RI0YovFoxCKP7wlyTeidMo9RAAbwx+DCt0iAF9RJTur0KgSatzxkS4c0HohcfseaK+Y1SfNwNA4NT4FB6CUuuV+qixUMODhDAAbZBIGlCURPOzM2mKY0XHBmunwpQ3CLGM1s0ockWavaaiUCixmAAK4GAIgAvDF6BhUIhbMGAHxiEAYKCOBVK911T3p7V6g1G8zSG0WvMOG30+1AlmpLmijPVb2l/2BslgCmu5YwVs9MaxxDtlWd3ZZ/VkjyIAD6iHBUCSKW7gAAiKOIQAQRBOElPksVrOwAEzsQfwRzQEDENDGZBgVCjgBG4lBem72mQAC8oAB5JUQZOwViGB+oADmV43u0wR4EoD7Pm+C4ADx5E+r5KpO04hsK0LiOw4HwaOOoQKOzajsQUDEPw16ID+2gYKQ6znm0PgwD+UApNYoIPqQzHIKQpF6BAgQ6KCJBQH+hhzBG2hQLqwpVh66q7rq+orI4UDWIYpA6vghrnCcBYaaoJZ2oyjoQGafC2C6facmq3I1oSkrNFcfBpvi1bNuyyzWDIMnZogwZRh5cnCKG3ggPQOqOAA9AAtAeFzHtoVgQDAgQxEFIXBCkEAqDEAD8xDsAArAALLlADMXmINleWFSVogBmAwCOJe5AoCkilSHKSD9IgIH4OlUgxPZknptJzkdkgbm+Ug3mbnuSg1XV4WhY4QA\">https://live.lean-lang.org/#codez=A4Jw9gLgpgxtAmACAlgO3gVzsgblRAwmALbAYICC5YAIsgGb0AqIUUAdHYy24gBSBG4EQAuREwCewfBgCU/QE3AIsZPw45ogDLIAzhEQA5AIZ7ASYTKp/YoYAeiDIjUAoAD6JiAa0eJv/MOQDKABaGFpo6ekYQMl4+fMCGrKgQ2koUICCG4vyAxcCI2sFSADSEJGSU1FzMrByVPPhCivkhUDLRPkpEpORQ8FQQtAxVbJyDdYgNiH4QQc2OjqCQsAgo6FgQuPh9A9zVIzu8gkoSFrIKRyoO6ohaugbGiGbH+HxWtvZOrh4x3nxTM6HXcJ3KLffjxRLJVLpTI5PIFKDFLa1XbI3gTJpSVqg0RI0YovFoxCKP7wlyTeidMo9RAAbwx+DCt0iAF9RJTur0KgSatzxkS4c0HohcfseaK+Y1SfNwNA4NT4FB6CUuuV+qixUMODhDAAbZBIGlCURPOzM2mKY0XHBmunwpQ3CLGM1s0ockWavaaiUCixmAAK4GAIgAvDF6BhUIhbMGAHxiEAYKCOBVK911T3p7V6g1G8zSG0WvMOG30+1AlmpLmijPVb2l/2BslgCmu5YwVs9MaxxDtlWd3ZZ/VkjyIAD6iHBUCSKW7gAAiKOIQAQRBOElPksVrOwAEzsQfwRzQEDENDGZBgVCjgBG4lBem72mQAC8oAB5JUQZOwViGB+oADmV43u0wR4EoD7Pm+C4ADx5E+r5KpO04hsK0LiOw4HwaOOoQKOzajsQUDEPw16ID+2gYKQ6znm0PgwD+UApNYoIPqQzHIKQpF6BAgQ6KCJBQH+hhzBG2hQLqwpVh66q7rq+orI4UDWIYpA6vghrnCcBYaaoJZ2oyjoQGafC2C6facmq3I1oSkrNFcfBpvi1bNuyyzWDIMnZogwZRh5cnCKG3ggPQOqOAA9AAtAeFzHtoVgQDAgQxEFIXBCkEAqDEAD8xDsAArAALLlADMXmINleWFSVogBmAwCOJe5AoCkilSHKSD9IgIH4OlUgxPZknptJzkdkgbm+Ug3mbnuSg1XV4WhY4QA</a></p>",
        "id": 489126451,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734307461
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">outShape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">outShape</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">outShape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">outShape</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n<span class=\"n\">termination_by</span>\n<span class=\"w\">    </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">sizeOf_lt_of_mem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">assumption</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">    </span><span class=\"n\">omega</span>\n\n<span class=\"n\">unseal</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">type mismatch</span>\n<span class=\"cm\">  rfl</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  ?m.5453 = ?m.5453 : Prop</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  (AutoDiffTree.DiffTree.ofComputed x).valid = x.valid : Prop</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 489126707,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734307686
    },
    {
        "content": "<p>Why do you think it should work?</p>",
        "id": 489130111,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1734310802
    },
    {
        "content": "<p>because of the definition of AutoDiffTree.DiffTree.valid</p>",
        "id": 489130376,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734311024
    },
    {
        "content": "<p>Note that well founded definitions don't always reduce by rfl. This is the reason they were made irreducible in the first place</p>",
        "id": 489130425,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734311045
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n</code></pre></div>",
        "id": 489130429,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734311049
    },
    {
        "content": "<p>all i did was change the definition ComputedAutoDiffTree.DiffTree<br>\nso i dont see why that should make rfl suddenly fail</p>",
        "id": 489130456,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734311093
    },
    {
        "content": "<p>If you really want this to be true by rfl, you will probably have to do the structural recursion by hand</p>",
        "id": 489130546,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734311163
    },
    {
        "content": "<p>Since this is a prop, another approach that should not be so bad is to define it as an inductive type</p>",
        "id": 489130776,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734311343
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n</code></pre></div>",
        "id": 489131040,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734311601
    },
    {
        "content": "<p>the direct function definition by mutual recursion is still quite painful to write, but it has at least some of the definitional equalities you want:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">rec</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">motive_1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive_2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">motive_3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">motive_4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ih</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">computedTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\">Array.-/</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ih</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\">List.-/</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\">List.-/</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ih1</span><span class=\"w\"> </span><span class=\"n\">ih2</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ih1</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">ih2</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\">Prod.-/</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ih</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- ok</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fail</span>\n</code></pre></div>",
        "id": 489132004,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734312426
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/rfl.20not.20working.20for.20well.20founded.20recursion/near/489130776\">said</a>:</p>\n<blockquote>\n<p>Since this is a prop, another approach that should not be so bad is to define it as an inductive type</p>\n</blockquote>\n<p>but then u still dont have a way of showing if (ofComputed c).valid then c.valid tho</p>",
        "id": 489133765,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734313840
    },
    {
        "content": "<p>nvm ig pattern matching solves that somehow</p>",
        "id": 489134504,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734314443
    },
    {
        "content": "<p>where did the additional shape✝ variable come from?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">forward</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">trivial</span>\n<span class=\"o\">}</span><span class=\"bp\">⟩</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parents</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">Σ</span><span class=\"w\"> </span><span class=\"n\">shapes</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">EFunction</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shapes</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tensor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DualTensor</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">forward</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- parents tensor</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨⟨</span><span class=\"n\">parents</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">shape</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">shape</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">tree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AutoDiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">forward</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">⟩</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"bp\">.</span><span class=\"n\">saveShapes</span><span class=\"o\">,</span>\n<span class=\"w\">            </span><span class=\"bp\">⟨⟨</span>\n<span class=\"w\">            </span><span class=\"o\">((</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">finRange</span><span class=\"w\"> </span><span class=\"n\">parents</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">                </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parents</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">                </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"n\">parents</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">tensor</span><span class=\"bp\">⟩</span>\n<span class=\"w\">                </span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"o\">,</span>\n<span class=\"w\">            </span><span class=\"gr\">sorry</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">⟩</span>\n<span class=\"w\">        </span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">⟩</span>\n<span class=\"n\">termination_by</span>\n<span class=\"w\">    </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"n\">decreasing_by</span>\n<span class=\"w\">    </span><span class=\"n\">simp_wf</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">α : Type u</span>\n<span class=\"cm\">β : Type v</span>\n<span class=\"cm\">shape✝ : List Nat</span>\n<span class=\"cm\">parents : Array ((shape : List Nat) × AutoDiffTree.DiffTree α β shape)</span>\n<span class=\"cm\">ctx : (shapes : Array (List Nat)) × EFunction α β shapes shape✝</span>\n<span class=\"cm\">tensor : DualTensor α β shape✝</span>\n<span class=\"cm\">h : (DiffTree.mk parents ctx tensor).valid</span>\n<span class=\"cm\">shape : List Nat</span>\n<span class=\"cm\">tree : AutoDiffTree.DiffTree α β shape</span>\n<span class=\"cm\">⊢ sizeOf tree &lt; 1 + sizeOf shape✝ + sizeOf parents + sizeOf ctx + sizeOf tensor</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 489144102,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734322620
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/rfl.20not.20working.20for.20well.20founded.20recursion/near/489130546\">said</a>:</p>\n<blockquote>\n<p>If you really want this to be true by rfl, you will probably have to do the structural recursion by hand</p>\n</blockquote>\n<p>so is there any way of proving stuff about well founded functions?</p>",
        "id": 489304321,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734372618
    },
    {
        "content": "<p>Yes, you can use tactics like <code>unfold</code>/<code>simp</code> to unfold the definitions. You may need to do <code>cases</code> on arguments to make them unfoldable (according to the match patterns)</p>",
        "id": 489313044,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734373863
    },
    {
        "content": "<p>For example, using the code from the first message in this thread,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 489313443,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734373976
    },
    {
        "content": "<p>In particular, it's the first equation lemma that applies here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ComputedAutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">ofComputed</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">AutoDiffTree</span><span class=\"bp\">.</span><span class=\"n\">DiffTree</span><span class=\"bp\">.</span><span class=\"n\">valid</span><span class=\"bp\">.</span><span class=\"n\">eq_1</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n</code></pre></div>\n<p>(I don't think it's good practice to refer to equation lemmas directly, that's what <code>unfold</code>/<code>simp</code> are for, but I'm mentioning it for illustration. Lean <em>does</em> know, somewhere, that the function satisfies the equation you gave it.)</p>",
        "id": 489314871,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734374435
    },
    {
        "content": "<p>i wonder if there's a brute force tactic that could do this casework automatically for simpler definitions</p>",
        "id": 489319268,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734375814
    },
    {
        "content": "<p>can grind do this?</p>",
        "id": 489319366,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1734375843
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/rfl.20not.20working.20for.20well.20founded.20recursion/near/489313443\">said</a>:</p>\n<blockquote>\n<p><code>simp [AutoDiffTree.DiffTree.valid]</code></p>\n</blockquote>\n<p><code>grind [AutoDiffTree.DiffTree.valid]</code> works equally well?</p>",
        "id": 496127593,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1737986008
    }
]