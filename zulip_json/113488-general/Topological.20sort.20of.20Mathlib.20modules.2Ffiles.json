[
    {
        "content": "<p>I'm thinking about how to go about a refactor of a definition. I am planning to grep for occurrences of the definition, and work backwards from the leaves. To do this, I'd love to have a topological sort of the modules I care about. </p>\n<p>Is there some way to plug into \"longest pole\" or any other introspecting program to achieve this? </p>\n<p>I'm imagining either generating the full topo-sort of all Mathlib modules, and then I <code>rg -f</code> using my subset, or having the application take my subset of interest and calculating the topo-sort of those.</p>",
        "id": 526898404,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1751502743
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"ch\">#!/usr/bin/env python3</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">sys</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">subprocess</span>\n\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">read_input_files</span><span class=\"p\">():</span>\n    <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">()</span> <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">stdin</span><span class=\"p\">]</span>\n\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">extract_imports</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">):</span>\n    <span class=\"n\">imports</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">,</span> <span class=\"s1\">'r'</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n        <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s1\">'import Mathlib.'</span><span class=\"p\">):</span>\n                <span class=\"n\">import_path</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">'import '</span><span class=\"p\">,</span> <span class=\"s1\">''</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s1\">'.'</span><span class=\"p\">,</span> <span class=\"s1\">'/'</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s1\">'.lean'</span>\n                <span class=\"n\">imports</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">import_path</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">imports</span>\n\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">get_all_files</span><span class=\"p\">():</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">run</span><span class=\"p\">(</span>\n        <span class=\"p\">[</span><span class=\"s1\">'git'</span><span class=\"p\">,</span> <span class=\"s1\">'ls-files'</span><span class=\"p\">],</span>\n        <span class=\"n\">capture_output</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">text</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">check</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">line</span> <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s1\">'Mathlib/'</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"s1\">'.lean'</span><span class=\"p\">)]</span>\n\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">build_dependency_graph</span><span class=\"p\">(</span><span class=\"n\">all_files</span><span class=\"p\">):</span>\n    <span class=\"n\">dep_graph</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"k\">for</span> <span class=\"n\">file</span> <span class=\"ow\">in</span> <span class=\"n\">all_files</span><span class=\"p\">:</span>\n        <span class=\"n\">imports</span> <span class=\"o\">=</span> <span class=\"n\">extract_imports</span><span class=\"p\">(</span><span class=\"n\">file</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">imp</span> <span class=\"ow\">in</span> <span class=\"n\">imports</span><span class=\"p\">:</span>\n            <span class=\"n\">dep_graph</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">\"</span><span class=\"si\">{</span><span class=\"n\">file</span><span class=\"si\">}</span><span class=\"s2\"> </span><span class=\"si\">{</span><span class=\"n\">imp</span><span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">dep_graph</span>\n\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">tsort</span><span class=\"p\">(</span><span class=\"n\">dep_graph</span><span class=\"p\">):</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">run</span><span class=\"p\">(</span>\n        <span class=\"p\">[</span><span class=\"s1\">'tsort'</span><span class=\"p\">],</span>\n        <span class=\"nb\">input</span><span class=\"o\">=</span><span class=\"s1\">'</span><span class=\"se\">\\n</span><span class=\"s1\">'</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">dep_graph</span><span class=\"p\">),</span>\n        <span class=\"n\">capture_output</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">text</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">check</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">()</span>\n\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">():</span>\n    <span class=\"n\">input_files</span> <span class=\"o\">=</span> <span class=\"n\">read_input_files</span><span class=\"p\">()</span>\n    <span class=\"n\">all_files</span> <span class=\"o\">=</span> <span class=\"n\">get_all_files</span><span class=\"p\">()</span>\n    <span class=\"n\">dep_graph</span> <span class=\"o\">=</span> <span class=\"n\">build_dependency_graph</span><span class=\"p\">(</span><span class=\"n\">all_files</span><span class=\"p\">)</span>\n    <span class=\"n\">sorted_files</span> <span class=\"o\">=</span> <span class=\"n\">tsort</span><span class=\"p\">(</span><span class=\"n\">dep_graph</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">input_files</span><span class=\"p\">:</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">'</span><span class=\"se\">\\n</span><span class=\"s1\">'</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">sorted_files</span><span class=\"p\">))</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">input_files_set</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">input_files</span><span class=\"p\">)</span>\n        <span class=\"n\">filtered_sorted_files</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">file</span> <span class=\"k\">for</span> <span class=\"n\">file</span> <span class=\"ow\">in</span> <span class=\"n\">sorted_files</span> <span class=\"k\">if</span> <span class=\"n\">file</span> <span class=\"ow\">in</span> <span class=\"n\">input_files_set</span><span class=\"p\">]</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">'</span><span class=\"se\">\\n</span><span class=\"s1\">'</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">filtered_sorted_files</span><span class=\"p\">))</span>\n\n<span class=\"k\">if</span> <span class=\"vm\">__name__</span> <span class=\"o\">==</span> <span class=\"s2\">\"__main__\"</span><span class=\"p\">:</span>\n    <span class=\"n\">main</span><span class=\"p\">()</span>\n</code></pre></div>",
        "id": 526898881,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1751503188
    },
    {
        "content": "<p>If you have the oleans, I also wrote something like this in lean.  Probably, searching for <code>sort_imports</code> may return something useful (I'm on mobile).</p>",
        "id": 526899083,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1751503365
    },
    {
        "content": "<p>import-graph can surely handle this too?</p>",
        "id": 526899237,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751503521
    },
    {
        "content": "<p>Thanks! Johan's script kind of(?) worked:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">grep</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">Valued</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cut</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">d</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">f1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rg</span><span class=\"w\"> </span><span class=\"s2\">\".lean\"</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">python</span><span class=\"w\"> </span><span class=\"n\">tsort</span><span class=\"bp\">.</span><span class=\"n\">py</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Valued</span><span class=\"bp\">/</span><span class=\"n\">LocallyCompact</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Valued</span><span class=\"bp\">/</span><span class=\"n\">WithVal</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Valued</span><span class=\"bp\">/</span><span class=\"n\">ValuedField</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Valued</span><span class=\"bp\">/</span><span class=\"n\">NormedValued</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">UniformSpace</span><span class=\"bp\">/</span><span class=\"n\">Ultra</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">&lt;--</span><span class=\"w\"> </span><span class=\"n\">Valued</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">appears</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">comment</span><span class=\"w\"> </span><span class=\"n\">here</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Valued</span><span class=\"bp\">/</span><span class=\"n\">ValuationTopology</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">&lt;--</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">would</span><span class=\"w\"> </span><span class=\"n\">imagine</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"s2\">\"root\"</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">DedekindDomain</span><span class=\"bp\">/</span><span class=\"n\">AdicValuation</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">FieldTheory</span><span class=\"bp\">/</span><span class=\"n\">RatFunc</span><span class=\"bp\">/</span><span class=\"n\">AsPolynomial</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">NumberTheory</span><span class=\"bp\">/</span><span class=\"n\">FunctionField</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">DedekindDomain</span><span class=\"bp\">/</span><span class=\"n\">FiniteAdeleRing</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Combinatorics</span><span class=\"bp\">/</span><span class=\"n\">Optimization</span><span class=\"bp\">/</span><span class=\"n\">ValuedCSP</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">LaurentSeries</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">NumberTheory</span><span class=\"bp\">/</span><span class=\"n\">NumberField</span><span class=\"bp\">/</span><span class=\"n\">FinitePlaces</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n</code></pre></div>",
        "id": 526899259,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1751503543
    },
    {
        "content": "<p><a href=\"https://stackoverflow.com/a/72753207\">https://stackoverflow.com/a/72753207</a> implies a very silly  hack for supporting this order in vscode search:</p>\n<ul>\n<li>Run a stupid bash script that sorts the  files, then sets the modified time to 1970 + n seconds</li>\n<li>Use vscode search</li>\n</ul>",
        "id": 526899376,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751503673
    },
    {
        "content": "<p>This is what I had in mind, I think:</p>\n<p><a href=\"#narrow/channel/113488-general/topic/Sort.20lines.20by.20import.20order.20of.20files/near/478346802\">https://leanprover.zulipchat.com/#narrow/channel/113488-general/topic/Sort.20lines.20by.20import.20order.20of.20files/near/478346802</a></p>",
        "id": 526899740,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1751504077
    },
    {
        "content": "<p>Awesome, thank you!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Valued</span><span class=\"bp\">.</span><span class=\"n\">ValuationTopology</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Valued</span><span class=\"bp\">.</span><span class=\"n\">NormedValued</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Valued</span><span class=\"bp\">.</span><span class=\"n\">ValuedField</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Valued</span><span class=\"bp\">.</span><span class=\"n\">WithVal</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">DedekindDomain</span><span class=\"bp\">.</span><span class=\"n\">AdicValuation</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">FieldTheory</span><span class=\"bp\">.</span><span class=\"n\">RatFunc</span><span class=\"bp\">.</span><span class=\"n\">AsPolynomial</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">NumberField</span><span class=\"bp\">.</span><span class=\"n\">FinitePlaces</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">LaurentSeries</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">UniformSpace</span><span class=\"bp\">.</span><span class=\"n\">Ultra</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">FunctionField</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Valued</span><span class=\"bp\">.</span><span class=\"n\">LocallyCompact</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">DedekindDomain</span><span class=\"bp\">.</span><span class=\"n\">FiniteAdeleRing</span>\n</code></pre></div>",
        "id": 526900703,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1751504965
    },
    {
        "content": "<p>hmm I'm still surprised to see <code>Ultra.Basic</code> so far down the list</p>",
        "id": 526900759,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1751505009
    }
]