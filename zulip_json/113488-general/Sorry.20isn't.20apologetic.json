[
    {
        "content": "<p>What is going on here?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">inv_ofNat_den</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Puzzle: guess what it does!</p>",
        "id": 523605118,
        "sender_full_name": "David Ang",
        "timestamp": 1749661892
    },
    {
        "content": "<p>Lol, this is the second time I've seen someone run into this recently (<span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> pointed it out to me too).</p>\n<p>This is the unique/labeled sorry feature's encoding being a little too visible to tactics. When designing it I was thinking \"it's going to be rare that people have <code>sorry</code> visible in their goals, they'll just be inside the definitions to prevent accidental non-theorems... right? (... right?)\"</p>\n<p>Two possible fixes:</p>\n<ul>\n<li>The encoding could put some mdata into the sorries with the source position. This won't fix the \"why does <code>rw</code> succeed here\" problem though.</li>\n<li>When <code>sorry</code>s are created, they can package up the source position information into an auxiliary definition, so the term might be <code>sorryAx (Lean.Name → Sort ?u.1) false _sorryLabel.22</code> instead <code>sorryAx (Lean.Name → Sort ?u.1) false </code>Mathlib.Foo.11.10.11.15.10.15._sorry._@.Mathlib.Foo._hyg.5<code>. This would keep </code>Expr.hasSorry` having simple definition too (compared to a version where the whole sorry term is packaged up into an auxiliary definition).</li>\n</ul>",
        "id": 523608142,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749663012
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/Sorry.20isn't.20apologetic/near/523608142\">said</a>:</p>\n<blockquote>\n<p>Two possible fixes</p>\n</blockquote>\n<p>is there really anything to fix? i don't see a bug here, if you use non-intended features on non-intended features, you get non-intended output</p>",
        "id": 523608341,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749663073
    },
    {
        "content": "<p>Yes, of course this is a bug. Why should users know that <code>sorry</code> is encoded in some way that contains hidden naturals? How is it non-intended to use <code>rw</code> on a goal?</p>",
        "id": 523609574,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749663575
    },
    {
        "content": "<p><code>sorry</code> can easily appear in goals in proofs in the goal too, e.g. you might have <code>Option.get o sorry</code> in the goal if you haven't finished writing the full theorem statement, and <code>rw</code> happily rewrites proofs.</p>",
        "id": 523609852,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749663667
    },
    {
        "content": "<p>I found this because I had some theorem of the form <code>(some simple thing) = (some complicated thing)</code>, but I extracted it to an <code>(some simple thing) = sorry</code> and tried <code>rw?</code> to see if there are any easy rewrites on the left hand side</p>",
        "id": 523609996,
        "sender_full_name": "David Ang",
        "timestamp": 1749663709
    },
    {
        "content": "<p>As a quick hack can we put the source info into the string?</p>",
        "id": 523610164,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749663770
    },
    {
        "content": "<p>It's much less likely that the user will be rewriting by the wrong string by coincidence, especially if it's just one big string</p>",
        "id": 523610243,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749663797
    },
    {
        "content": "<p>I don't think that's any quicker of a hack than fixing it. These support \"go to definition\", and it would need a parser for example.</p>",
        "id": 523610389,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749663852
    },
    {
        "content": "<p>Could we generate an <code>inductive SorryType.Mod.Line.Col where | mk</code> type for each sorry?</p>",
        "id": 523610763,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749663991
    },
    {
        "content": "<p>That way the name is in the <code>.const</code> term where it can't be rewritten</p>",
        "id": 523610824,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749664020
    },
    {
        "content": "<p>The difference between that and the aux definition idea is that <code>inductive</code> guarantees that it will never be rewritten. Do we think that there's a chance that someone will apply a theorem to rewrite an arbitrary <code>_sorryPos.22 : Lean.Name</code> position to something else? At least <code>rw</code> doesn't let the LHS of a theorem to be a variable, so even in a contradictory context with <code>forall n : Name =&gt; n = .anonymous</code>, it seems hard to get into trouble.</p>",
        "id": 523614700,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1749665550
    },
    {
        "content": "<p>Does <code>opaque sorryPos.37 : Unit</code> work, or does eta reduction make that defeq to any other pos?</p>",
        "id": 523622456,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749668792
    },
    {
        "content": "<p>That will be defeq to every other element of type <code>Unit</code></p>",
        "id": 523645652,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749679863
    }
]