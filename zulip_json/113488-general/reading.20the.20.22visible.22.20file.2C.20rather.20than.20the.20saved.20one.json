[
    {
        "content": "<p>While talking to Johan about writing the long-line linter as a syntax linter, we came up with the code below.</p>\n<p>It works well, but uses information about the <em>saved</em> file.  How do I access the actual file as it is being edited?</p>\n<p>E.g., if you copy the long line below and paste it somewhere else, you will not get a warning unless you save the file and make sure that lean re-parses the command.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fil</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getFileName</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">longLines</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"n\">fil</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filterMap</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">70</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">fil</span><span class=\"o\">[</span><span class=\"n\">l</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fm</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getFileMap</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">l_idx</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">longLines</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">longLineStart</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fm</span><span class=\"bp\">.</span><span class=\"n\">ofPosition</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">l_idx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">longLineEnd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fm</span><span class=\"bp\">.</span><span class=\"n\">ofPosition</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">l_idx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fil</span><span class=\"o\">[</span><span class=\"n\">l_idx</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">length</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">logWarningAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">longLineStart</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">longLineEnd</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"too long\"</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">0         1         2         3         4         5         6         7</span>\n<span class=\"cm\">^ flagged as too long</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 453613568,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721805184
    },
    {
        "content": "<p>(Also note that the code above does <em>not</em> work in the playground, since it tries to access the current file being used, something that does not seem to exist in the playground.)</p>",
        "id": 453613743,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721805257
    },
    {
        "content": "<p>If you're writing a syntax linter, why would you not take that information from the syntax tree given to you?</p>",
        "id": 453638984,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721811805
    },
    {
        "content": "<p>I.e. use <code>Syntax.getSubstring?</code></p>",
        "id": 453639619,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1721812008
    },
    {
        "content": "<p>Thanks!  I did not know about <code>Syntax.getSubstring?</code>!  This works as expected!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/-- flags lines longer than 70 characters in the following command -/</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"longLines \"</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sstr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">getSubstring?</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">longLines</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">sstr</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">splitOn</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">70</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">·.</span><span class=\"n\">toString</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">l_idx</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">longLines</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">logWarningAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">l_idx</span><span class=\"bp\">.</span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">l_idx</span><span class=\"bp\">.</span><span class=\"n\">stopPos</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"too long\"</span>\n\n<span class=\"n\">longLines</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">0         1         2         3         4         5         6         7</span>\n<span class=\"cm\">^ flagged as too long</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 453653877,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721816304
    },
    {
        "content": "<p>It does not flag long lines after <code>#exit</code>, but <code>#exit</code> already flags itself, so that's probably not a great deal!</p>",
        "id": 453654006,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721816368
    },
    {
        "content": "<p>In case you didn't know, this is also possible:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">ctx.fileMap.source</span>\n</code></pre></div>",
        "id": 453801920,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1721857178
    },
    {
        "content": "<p>Adam, I did not know about this, thanks!</p>",
        "id": 453845239,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721879427
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> The remaining <code>readFile</code> in the linter seems to break <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a></p>",
        "id": 454337536,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722012867
    },
    {
        "content": "<p>Oh, would putting that code behind an <code>if pathExists then</code> solve the issue?</p>",
        "id": 454381128,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722031786
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15179\">#15179</a> hopefully this fixes it, but I do not know how to test it.</p>",
        "id": 454383082,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722032449
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> I am curious, why are you re-reading the file in the linter rather than just using <code>fileMap.source</code> like Adam suggested?</p>",
        "id": 454399081,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722042048
    },
    {
        "content": "<p>Mostly, the answer is that I do not really understand the difference between the two, so I just kept using what I already had, instead of switching over.</p>",
        "id": 454413704,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722050345
    },
    {
        "content": "<p>So, I guess from your comment that using Adam's suggestion would still avoid the issue on the lean server and be more efficient?</p>",
        "id": 454413881,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722050422
    },
    {
        "content": "<p>If so, then I'll adapt the linter!</p>",
        "id": 454413921,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722050432
    },
    {
        "content": "<p>Another benefit to using the filemap is that it gives you a version whose line ending have all been normalized to \\n (vs on Windows, where they might otherwise be \\r\\n, depending on how you've got everything configured!)</p>",
        "id": 454415440,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722051274
    },
    {
        "content": "<p>Oh, never mind, I just read the linter code, and I see it goes to mkInputContext anyway. That function normalizes line endings by default.</p>",
        "id": 454415473,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1722051337
    },
    {
        "content": "<p>As far as I can see, <a href=\"https://github.com/leanprover-community/mathlib4/pull/15180\">#15180</a> should therefore be a better solution, right?  It does look better to me!</p>",
        "id": 454417235,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722052233
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/113488-general/topic/reading.20the.20.22visible.22.20file.2C.20rather.20than.20the.20saved.20one/near/454413704\">said</a>:</p>\n<blockquote>\n<p>Mostly, the answer is that I do not really understand the difference between the two, so I just kept using what I already had, instead of switching over.</p>\n</blockquote>\n<p>The key difference is that the <code>fileMap.source</code> uses the text of the current file that is already available to Lean processes, whereas the <code>readFile</code> solution attempts to find the source file on disk and read it again. The later can fail if the file cannot be accessed (e.g., on the server or when there is no file, such as with <code>lean --stdin</code>), and, even when successful, will not contain unsaved edits to the file. There are cases were these properties can be useful, but it does not seem like this linter is one of them.</p>",
        "id": 454418098,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722052619
    },
    {
        "content": "<p>Also, as a minor style note, there is a helper called <code>getFileMap</code> (like <code>getFileName</code>) that can be used instead of <code>(&lt;- read).fileMap</code> .</p>",
        "id": 454418289,
        "sender_full_name": "Mac Malone",
        "timestamp": 1722052699
    },
    {
        "content": "<p>Thanks for the explanation: that clarified some haziness that I had not even realized I had!</p>\n<p>Also, I definitely want to access the not-necessarily-saved latest version of the file.</p>\n<p>I'll edit the PR with you <code>getFileMap</code> suggestion.</p>",
        "id": 454418713,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722052881
    },
    {
        "content": "<p>(It looks like Kyle also mentioned it in the PR! <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> )</p>",
        "id": 454418899,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722052930
    }
]