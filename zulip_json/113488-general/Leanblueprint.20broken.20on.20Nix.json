[
    {
        "content": "<p>Hi all, I packaged  leanblueprint <a href=\"https://github.com/NixOS/nixpkgs/pull/328918\">to nixpkgs</a>, but as pointed out by <span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> its plasTeX integration is broken, sorry about that. I'm working on a fix but won't promise that I get it done any time soon. Here are some more details about the problem if someone wants to help with the task:</p>\n<ul>\n<li>When creating a web version of the blueprint, plasTeX tries to use the leanblueprint python module, which it cannot find as it was built without leanblueprint as a dependency. This error is seen in the output</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">plasTeX</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"mf\">3.1</span>\n<span class=\"bp\">..</span>\n<span class=\"n\">ERROR</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Loading</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"s2\">\"report\"</span><span class=\"w\"> </span><span class=\"n\">raised</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">ModuleNotFoundError</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">No</span>\n<span class=\"w\">   </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">leanblueprint'</span>\n</code></pre></div>\n<ul>\n<li>Adding leanblueprint as a dependency to plasTeX would cause a cyclic dependency resulting in \"error: infinite recursion encoutered\".</li>\n</ul>\n<p>Some possible solutions I have considered:</p>\n<ul>\n<li>Rewriting leanblueprint to use plasTeX as a python module rather than call it from a subprocess</li>\n<li>Create a wrapper for plasTeX which has leanblueprint in its PYTHONPATH</li>\n<li>Creating a package which bundles leanblueprint and plastex into one</li>\n</ul>\n<p>As far as I know there is no way to get leanblueprint to work on Nix right now. Please correct me if I'm wrong.</p>",
        "id": 493016224,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1736538783
    },
    {
        "content": "<p>I'm setting the python path in the command line, then it works.</p>",
        "id": 493040506,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1736551531
    },
    {
        "content": "<p>You can just create a wrapper around the lean blueprint command that sets the python path environment variable. On the phone, so can't give more details right now.</p>",
        "id": 493040619,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1736551599
    },
    {
        "content": "<p>I'm very sorry it took me so long, but I have finally managed to get <code>leanblueprint</code> to work on Nix. I did it by following <a href=\"https://discourse.nixos.org/t/nix-shell-with-python-packages-through-pip/45825/4\">this solution in NixOS discourse</a>. It's not idiomatic and tends to be quite slow, but it gets <code>pygrahviz</code> (from nixpkgs, as it can't compile when installed with <code>pip</code>), <code>leanblueprint</code> and <code>plastex</code> all in the same Python PATH by just downloading the tool using <code>pip</code>.</p>\n<p>Anyways, this Nix shell worked for me, hopefully it's useful to other Nix users in the meanwhile:</p>\n<div class=\"codehilite\" data-code-language=\"Nix\"><pre><span></span><code>  pkgs<span class=\"o\">.</span>mkShellNoCC <span class=\"p\">{</span>\n    <span class=\"ss\">buildInputs</span> <span class=\"o\">=</span> <span class=\"k\">with</span> pkgs<span class=\"p\">;</span> <span class=\"p\">[</span>\n      python312\n      python312Packages<span class=\"o\">.</span>pip\n      python312Packages<span class=\"o\">.</span>virtualenvwrapper\n      python312Packages<span class=\"o\">.</span>pygraphviz\n      texlive<span class=\"o\">.</span>combined<span class=\"o\">.</span>scheme-small\n    <span class=\"p\">];</span>\n\n    <span class=\"ss\">shellHook</span> <span class=\"o\">=</span> <span class=\"s s-Multiline\">''</span>\n<span class=\"s s-Multiline\">      echo \"Activating venv with --system-site-packages\"</span>\n<span class=\"s s-Multiline\">      export TMPDIR=/tmp  &amp;&amp; export VENV=$(mktemp -d)</span>\n<span class=\"s s-Multiline\">      virtualenv --system-site-packages $VENV</span>\n<span class=\"s s-Multiline\">      source $VENV/bin/activate</span>\n<span class=\"s s-Multiline\">      pip install -U leanblueprint</span>\n<span class=\"s s-Multiline\">    ''</span><span class=\"p\">;</span>\n  <span class=\"p\">};</span>\n</code></pre></div>\n<p>I have tested it on the <a href=\"https://github.com/kkytola/ExtremeValueProject/\">ExtremeValueProject formalization project</a> (part of a course by <span class=\"user-mention\" data-user-id=\"373986\">@Kalle Kytölä</span> that I attended), and it worked as expected.</p>\n<p>Next, I'll try to see what I can do about the broken <code>leanblueprint</code> in nixpkgs.</p>",
        "id": 525065491,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1750434243
    },
    {
        "content": "<p>It seems like I previosly completely missed the obvious dependency on LaTeX which probably was the reason it was not working for me before <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span> Solving the problem didn't require an intricate pip setup like I previously thought.</p>\n<p>It's enough to simply add e.g. <code>pkgs.texlive.combined.scheme-basic</code> to the shell and the old leanblueprint 0.0.10 that I PRed to nixpkgs seems to work flawlessly.</p>",
        "id": 525079446,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1750440618
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"706442\">Niklas Halonen</span> has marked this topic as resolved.</p>",
        "id": 525080577,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750441159
    },
    {
        "content": "<p>So it seems like <code>leanblueprint</code> from nixpkgs worked all along[^1], just requires presence of a LaTeX distribution, which it doesn't come with as it's a \"very dynamic/decoupled dependency\". I'm happy to help if anyone still has trouble with the tool!</p>\n<p>Here is a <a href=\"https://github.com/NixOS/nixpkgs/pull/418490\">PR to nixpkgs</a> for a bump and simple tests to leanblueprint</p>\n<p>[^1]: It does work with <code>nix-shell</code>, see my latest message about investigating why it's not working with the unstable <code>nix shell</code> command.</p>",
        "id": 525081001,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1750441349
    },
    {
        "content": "<p>I think I'm going crazy. It's still clearly not working as intended.</p>\n<p>To experiment, I started a fresh gitpod instance (on <a href=\"https://github.com/kkytola/ExtremeValueProject/\">this repository</a>) and tried entering a Nix shell with <code>nix shell nixpkgs#{texlive.combined.scheme-small,leanblueprint}</code> and when I ran <code>leanblueprint web</code> I got the error from my original post:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>plasTeX<span class=\"w\"> </span>version<span class=\"w\"> </span><span class=\"m\">3</span>.1\n..\nERROR:<span class=\"w\"> </span>Loading<span class=\"w\"> </span>package<span class=\"w\"> </span><span class=\"s2\">\"report\"</span><span class=\"w\"> </span>raised<span class=\"w\"> </span>exception<span class=\"w\"> </span>ModuleNotFoundError<span class=\"w\"> </span>:<span class=\"w\"> </span>No\n<span class=\"w\">   </span>module<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"s1\">'leanblueprint'</span>\n..\nERROR:<span class=\"w\"> </span>Loading<span class=\"w\"> </span>package<span class=\"w\"> </span><span class=\"s2\">\"amssymb\"</span><span class=\"w\"> </span>raised<span class=\"w\"> </span>exception<span class=\"w\"> </span>ModuleNotFoundError<span class=\"w\"> </span>:<span class=\"w\"> </span>No\n<span class=\"w\">   </span>module<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"s1\">'leanblueprint'</span>\nERROR:<span class=\"w\"> </span>Loading<span class=\"w\"> </span>package<span class=\"w\"> </span><span class=\"s2\">\"amsthm\"</span><span class=\"w\"> </span>raised<span class=\"w\"> </span>exception<span class=\"w\"> </span>ModuleNotFoundError<span class=\"w\"> </span>:<span class=\"w\"> </span>No\n<span class=\"w\">   </span>module<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"s1\">'leanblueprint'</span>\nERROR:<span class=\"w\"> </span>Loading<span class=\"w\"> </span>package<span class=\"w\"> </span><span class=\"s2\">\"amsmath\"</span><span class=\"w\"> </span>raised<span class=\"w\"> </span>exception<span class=\"w\"> </span>ModuleNotFoundError<span class=\"w\"> </span>:<span class=\"w\"> </span>No\n<span class=\"w\">   </span>module<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"s1\">'leanblueprint'</span>\nERROR:<span class=\"w\"> </span>Loading<span class=\"w\"> </span>package<span class=\"w\"> </span><span class=\"s2\">\"hyperref\"</span><span class=\"w\"> </span>raised<span class=\"w\"> </span>exception<span class=\"w\"> </span>ModuleNotFoundError<span class=\"w\"> </span>:<span class=\"w\"> </span>No\n<span class=\"w\">   </span>module<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"s1\">'leanblueprint'</span>\nERROR:<span class=\"w\"> </span>Loading<span class=\"w\"> </span>package<span class=\"w\"> </span><span class=\"s2\">\"blueprint\"</span><span class=\"w\"> </span>raised<span class=\"w\"> </span>exception<span class=\"w\"> </span>ModuleNotFoundError<span class=\"w\"> </span>:\n<span class=\"w\">   </span>No<span class=\"w\"> </span>module<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"s1\">'leanblueprint'</span>\n</code></pre></div>\n<p>The way <code>nix shell</code> works is quite different from <code>nix-shell</code> (the stable command; which I had begun using recently).</p>\n<p>By starting the shell with <code>nix-shell -p texlive.combined.scheme-small -p leanblueprint</code>, <code>leanblueprint</code> works again (requires forcefully removing the <code>blueprint/web</code> directory as usual):</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"o\">[</span>nix-shell:/workspace/ExtremeValueProject<span class=\"o\">]</span>$<span class=\"w\"> </span>leanblueprint<span class=\"w\"> </span>web\nplasTeX<span class=\"w\"> </span>version<span class=\"w\"> </span><span class=\"m\">3</span>.1\n..\n<span class=\"w\"> </span><span class=\"o\">(</span>loading<span class=\"w\"> </span>package<span class=\"w\"> </span>/nix/store/sgcr0jrj93zvl98q9dx26k1s679zhq4j-python3.12-\n<span class=\"w\">   </span>plasTeX-3.1/lib/python3.12/site-packages/plasTeX/Packages/report.py\n<span class=\"w\"> </span><span class=\"o\">)</span>..\n<span class=\"w\"> </span><span class=\"o\">[</span>..<span class=\"o\">]</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>index.html<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0001.html<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0002.html<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0003.html<span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0004.html<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0005.html<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0006.html<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0007.html<span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0008.html<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>sect0009.html<span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">]</span>\n</code></pre></div>\n<p>The difference between the shells seems to be to the PYTHONPATH environment variable. <code>nix-shell</code> sets PYTHONPATH to include all site-packages, like <code>leanblueprint</code>, <code>plastexdepgraph</code>, <code>plastexshowmore</code>, <code>pygraphviz</code>, whereas <code>nix shell</code> doesn't set the PYTHONPATH at all.</p>\n<p>The goal would of course be to get <code>leanblueprint</code> to work independently of the environment (PYTHONPATH), but because of the dependency cycle, I'm not sure if that's directly possible. Inspecting the <code>.leanblueprint-wrapped</code> binary reveals the site-packages, which need to be inherited by the plastex subprocess (like how environment variables are inherited). I'm now wondering how to wrap it differently, or if I should just refactor <code>leanblueprint</code> to <code>import plastex</code> instead of running it in a shell...</p>",
        "id": 525214175,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1750599964
    }
]