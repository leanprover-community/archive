[
    {
        "content": "<p>I think this function is missing in the libraries.<br>\nPR welcome?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">By swapping elements of the array one by one,</span>\n<span class=\"sd\">move `xs[old_idx]` to the position `xs[new_idx]`</span>\n<span class=\"sd\">while preserving the relative order of all other elements.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"n\">new_idx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hold</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hnew</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">new_idx</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">toVector</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">new_idx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.</span><span class=\"bp\">..</span><span class=\"o\">(</span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">new_idx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">vec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">new_idx</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.</span><span class=\"bp\">..</span><span class=\"o\">(</span><span class=\"n\">new_idx</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">old_idx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">vec</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"bp\">.</span><span class=\"n\">swap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">old_idx</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"bp\">.</span><span class=\"n\">toArray</span>\n\n<span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 565945533,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1767232303
    },
    {
        "content": "<p>If we had this function, we would also have <code>Array.push</code>. Both would be <code>O(n)</code> operations.</p>",
        "id": 565946481,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767233551
    },
    {
        "content": "<p>We have Array.push?</p>",
        "id": 565946593,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1767233708
    },
    {
        "content": "<p>sorry. I wanted to say <code>Vector.push</code>. Same issue.</p>",
        "id": 565946949,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767234306
    },
    {
        "content": "<p>I saw vector operations in the code</p>",
        "id": 565946952,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767234316
    },
    {
        "content": "<p>I suppose you mean something different because we do have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Vector.push#doc\">docs#Vector.push</a>​?</p>",
        "id": 565946982,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767234373
    },
    {
        "content": "<p>When I wrote Vector, we decided not to add push</p>",
        "id": 565946992,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767234388
    },
    {
        "content": "<p>The reasoning was that Vector and Array are meant to provide efficient API and we should not let users footgun themselves</p>",
        "id": 565947007,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767234417
    },
    {
        "content": "<p>I am guessing that line of reasoning is not valid anymore</p>",
        "id": 565947038,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767234445
    },
    {
        "content": "<p>Uhh <code>Array.push</code> and <code>Vector.push</code> is O(1), do you mean \"Array.cons\" / \"Vector.cons\"?</p>",
        "id": 565947063,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767234477
    },
    {
        "content": "<p>Right sorry cons.</p>",
        "id": 565947082,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767234511
    },
    {
        "content": "<p>I apologise, I am a bit scatter-brained right now</p>",
        "id": 565947089,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767234527
    },
    {
        "content": "<p>The <code>insert</code> function is something that is needed when trying to implement insertion sort on arrays, and I think it is also useful as a building block for other functions. Having this function and its properties available in the library would be valuable, even if it is not particularly efficient.</p>",
        "id": 565947783,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1767235771
    },
    {
        "content": "<p>then maybe you want to make cslib PR? But yeah I can also see some uses for this function. Another place to make this PR might be batteries</p>",
        "id": 565947921,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1767235988
    },
    {
        "content": "<p>I think Batteries is better</p>",
        "id": 565949198,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1767238154
    },
    {
        "content": "<p>I'll just note that the name <code>Array.insert</code> gives me more an impression that you insert a new element but really, you're only moving the values around. So a better name would probably be something like <code>Array.move</code> (which I suppose would be a more efficient way to do <code>(xs.eraseIdx old_idx).insertIdx new_idx xs[old_idx]</code>?)</p>",
        "id": 565970914,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767266228
    },
    {
        "content": "<p>Do any other languages have an operation like this in their standard libraries?</p>\n<p>The closest I can think of is std::rotate in C++ which I think(?) is a generalization of this? Edit: Rust vectors also have rotate_left and rotate _right.</p>",
        "id": 566180739,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767478461
    },
    {
        "content": "<p><code>std::rotate</code> was also what came to mind for me</p>",
        "id": 566211527,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767520567
    },
    {
        "content": "<p>Would a signature like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SubArray</span><span class=\"bp\">.</span><span class=\"n\">rotate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subarray</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subarray</span><span class=\"w\"> </span><span class=\"n\">X</span>\n</code></pre></div>\n<p>make sense, where the underlying <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subarray.array#doc\">docs#Subarray.array</a> contains the updated value?</p>",
        "id": 566212228,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767521232
    },
    {
        "content": "<p>I think the way a lot of Array functions currently work is that the primary method is defined on <code>Array</code> with optional start/stop index parameters, and then the subarray functions are defined in terms of those. My understanding (<span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> please correct me if I'm wrong) is that this is an API concession to ensure you can avoid allocating a 'Subarray' structure if you don't need to/if the compiler can't infer you don't need to.  </p>\n<p>So given that maybe something like </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">rotate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>(which then SubArray.rotate is defined in terms of)<br>\nYou could also consider making <code>i</code> an <code>Int</code> to let you write left and right rotations in an ergonomic way. (the actual implementation should probably select whichever direction leads to fewer swaps though). That's not necessary of course, but it's a bit nicer than <code>stop - i</code></p>",
        "id": 566441707,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767648633
    }
]