[
    {
        "content": "<p>when I am proving an equation,it is always hard to offset identical terms in the both sides.for example,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">tmp_1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">ℝ</span><span class=\"o\">):</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">=</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">+</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"o\">:=</span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ring</span>\n</code></pre></div>\n<p>although ring is useful here,how to just firstly delete the a^2?</p>",
        "id": 476046737,
        "sender_full_name": "Zihao Zhang",
        "timestamp": 1728542261
    },
    {
        "content": "<p>You could use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_left_inj</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 476047641,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728542509
    },
    {
        "content": "<p>While that's true, it does mean you need to massage the common terms into the right place. I've also found this annoying every now and then</p>",
        "id": 476048389,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728542717
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"753034\">@Zihao Zhang</span> I understand your frustration. One thing that can be helpful is to imagine what you would like to have written.<br>\nYour example is a nice one, because you want to cancel <code>a^2</code> on both sides. But on the right, you have two <code>a^2</code>s. So do you want to use associativity, or commutativity. Do you care about which one? Should a tactic choose randomly?</p>\n<p>So I imagine it would be helpful if you can fill in for a few more examples:</p>\n<ol>\n<li>The current goal (in this case <code>a^2+(a+b)^2=(a^2+2*a*b+b^2)+a^2</code>)</li>\n<li>What you want to type (maybe <code>cancel a^2</code> or <code>cancel_left a^2</code>?)</li>\n<li>What you would expect the goal to be after that tactic (here I think there would be two options, and I'm curious which one you would like best)</li>\n</ol>",
        "id": 476048488,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728542750
    },
    {
        "content": "<p>Starting from such examples, we can start fleshing out what a tactic should do precisely, to make this bit of Lean more convenient.</p>",
        "id": 476048686,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728542794
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/113488-general/topic/I.20think.20lean.20is.20far.20away.20from.20convenient/near/476047641\">said</a>:</p>\n<blockquote>\n<p>You could use</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_left_inj</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>In this simple example,you can do this easily,but when the left and right have 100 terms,and the first term of the left equals to the last term of the right,you must use many add_comm and add_assoc to put them in the same place,so the rw must be very long.</p>",
        "id": 476048851,
        "sender_full_name": "Zihao Zhang",
        "timestamp": 1728542843
    },
    {
        "content": "<p>What would you write on paper? Would you write the equation again, showing the result after cancelling <code>a^2</code>?</p>",
        "id": 476049281,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728542951
    },
    {
        "content": "<p>Oh, you could use <code>move_add</code> for that:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">move_add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_left_inj</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 476049752,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728543073
    },
    {
        "content": "<p>Oh yes, how do I keep forgetting about that <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 476051170,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728543411
    },
    {
        "content": "<p>Maybe <code>move_add!</code> could then also cancel the moved term</p>",
        "id": 476051428,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728543468
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> You teach me a very useful tactic!Thank you!I temporarily take back my opinion.</p>",
        "id": 476051854,
        "sender_full_name": "Zihao Zhang",
        "timestamp": 1728543563
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/113488-general/topic/Cancelling.20common.20terms.20in.20an.20equation/near/476051428\">said</a>:</p>\n<blockquote>\n<p>Maybe <code>move_add!</code> could then also cancel the moved term</p>\n</blockquote>\n<p>One of my motivations for <code>move_add</code> was precisely to also then cancel stuff, but I never got around to it.  If there is interest in doing this, I can think about implementing it, but maybe now there should be a widget-like interface where you select the terms on the two sides and you get a <code>Try this</code> suggestion that cancels them?</p>",
        "id": 476052521,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728543712
    },
    {
        "content": "<p>Such a widget would be very nice.</p>",
        "id": 476055820,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728544357
    },
    {
        "content": "<p>Does <code>move_add</code> always move things left? Or can it be configured to also move things right?</p>",
        "id": 476055969,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728544387
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">move_add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>would move to the left (the <code>_</code> is because the first occurrence should not be moved).</p>",
        "id": 476056639,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728544514
    },
    {
        "content": "<p>Why is this not moving the last <code>a ^ 2</code> to the left?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">tmp_1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">ℝ</span><span class=\"o\">):</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">=</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">+</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">move_add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 476056971,
        "sender_full_name": "Vincent Beffara",
        "timestamp": 1728544572
    },
    {
        "content": "<p>The logic is that the arguments of <code>move_add</code> are the stuff that you want to move <em>in the order in which they appear/unify</em>.  So, using <code>_</code> matches the first summand (the <code>a^2</code> on the left in this case) and moves that to the right, and the next <code>a^2</code> match is the final one, that gets moved to the left.</p>",
        "id": 476057454,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728544664
    },
    {
        "content": "<p>Oh, I had missed that there are 3 <code>a^2</code>!!</p>",
        "id": 476057716,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728544705
    },
    {
        "content": "<p>Anyway, the list of arguments pattern matches the summands in the order in which they appear in the expression and the arrows (or their absence) tell Lean whether to shove them to the left/right.</p>",
        "id": 476058207,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728544777
    },
    {
        "content": "<p>So, in this case, you can move all the <code>a^2</code> terms to the left (aka just the last one, since the others are already in place) using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">move_add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 476058877,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728544893
    },
    {
        "content": "<p>So <code>move_add [a ^ 2]</code> moves all the <code>a ^ 2</code> subterms to the right (not just the first one), one would expect <code>move_add [\\l a ^ 2]</code> to move all the <code>a ^ 2</code> subterms to the left but it doesn't.</p>",
        "id": 476058965,
        "sender_full_name": "Vincent Beffara",
        "timestamp": 1728544910
    },
    {
        "content": "<p>No, <code>move_add</code> moves <em>the first not-yet-matched</em> term.</p>",
        "id": 476059186,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728544944
    },
    {
        "content": "<p>So, with repetitions, you get control of where each \"equal\" summand goes.</p>",
        "id": 476059313,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728544967
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">tmp_1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">ℝ</span><span class=\"o\">):</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">=</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">+</span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">move_add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- (a + b) ^ 2 + a ^ 2 = 2 * a * b + b ^ 2 + a ^ 2 + a ^ 2</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 476059438,
        "sender_full_name": "Vincent Beffara",
        "timestamp": 1728544991
    },
    {
        "content": "<p>Oh, then I misremember.  The other behaviour was then a previous implementation!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 476059797,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728545048
    },
    {
        "content": "<p>The current one makes sense (if you want to cancel <code>a ^ 2</code> then move all that match all the way). But then one would expect the behavior to match between <code>move_add [a ^ 2]</code> and <code>move_add [\\l a ^ 2]</code> and IIUC it doesn't?</p>",
        "id": 476060762,
        "sender_full_name": "Vincent Beffara",
        "timestamp": 1728545221
    },
    {
        "content": "<p>Ah, I know what is happening!  The two sides of the equality generate independent matches!</p>",
        "id": 476061131,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728545286
    },
    {
        "content": "<p><code>move_add</code> extracts all maximal subexpressions that start with a <code>+</code> and on each one of them uses the \"first unmatched variable\" criterion.</p>",
        "id": 476061313,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728545326
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"753034\">Zihao Zhang</span> has marked this topic as resolved.</p>",
        "id": 476120693,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728563286
    }
]