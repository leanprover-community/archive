[
    {
        "content": "<p>I have a theorem that performs a functional induction for a function with 9 branches (<a href=\"https://github.com/pandaman64/lean-regex/blob/df13dfdd367150c8f677c84b4134b956c84398fb/correctness/RegexCorrectness/VM/EpsilonClosure/Basic.lean#L59\">code</a>). The intention is to fine-tune the auto-generated <code>.induct</code> theorem to give a meaningful name and more useful types to each case. However, Lean consumes a huge amount of memory (&gt;20GB) and time when editing this theorem, and the Lean process crashes when I'm trying to add two more branches to the theorem to support new features. I also found that the applications of the theorem is slow, and profiling didn't reveal much info (<a href=\"#narrow/channel/113489-new-members/topic/trace.2Eprofiler.20doesn't.20complete.20when.20debugging.20slow.20proofs\">previous thread</a>).</p>\n<p>Is there any way to reduce the resources used by Lean when processing the theorem? Thank you!</p>",
        "id": 494517124,
        "sender_full_name": "pandaman",
        "timestamp": 1737205243
    },
    {
        "content": "<p>Reproduction steps:</p>\n<ol>\n<li>Clone <a href=\"https://github.com/pandaman64/lean-regex\">lean-regex</a>.</li>\n<li>\n<p>Open <a href=\"https://github.com/pandaman64/lean-regex/blob/main/correctness/RegexCorrectness/VM/EpsilonClosure/Basic.lean\"><code>correctness/RegexCorrectness/VM/EpsilonClosure/Basic.lean</code></a> and try editing <code>εClosure'.induct'</code></p>\n<ul>\n<li>Alternatively, you can open <a href=\"https://github.com/pandaman64/lean-regex/blob/main/correctness/RegexCorrectness/VM/EpsilonClosure/Lemmas.lean\"><code>correctness/RegexCorrectness/VM/EpsilonClosure/Lemmas.lean</code></a> to see the slowness when applying this theorem</li>\n</ul>\n</li>\n</ol>",
        "id": 494517260,
        "sender_full_name": "pandaman",
        "timestamp": 1737205353
    },
    {
        "content": "<p>Just pinging <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> as the relevant expert.</p>",
        "id": 494581415,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1737243441
    },
    {
        "content": "<blockquote>\n<p>I also found that the applications of the theorem is slow, and profiling didn't reveal much info</p>\n</blockquote>\n<p>As for the applications of the <code>εClosure'.induct'</code>, it turned out that the slowness comes from a different issue (see <a href=\"#narrow/channel/113489-new-members/topic/trace.2Eprofiler.20doesn't.20complete.20when.20debugging.20slow.20proofs\">linked thread</a>), and it's resolved now.</p>\n<p>The definitions of the <code>εClosure'.induct'</code> itself still has the resource usage issue, so I'd welcome any help on this. Thanks!</p>",
        "id": 494599545,
        "sender_full_name": "pandaman",
        "timestamp": 1737258866
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395416\">@pandaman</span> , can you tell whether the generation of the <code>.induct</code> theorem is where lean consumes memory, or your theorem? (Just write <code>def foo := @bar.induct</code> before to trigger the generation of the theorem to make sure it happens separate from your theorem.)</p>",
        "id": 494667684,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1737313125
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> Hi! <code>def foo := @εClosure'.induct</code> is instant. So Lean is consuming memory when using it to prove my theorem.</p>",
        "id": 494753514,
        "sender_full_name": "pandaman",
        "timestamp": 1737363911
    },
    {
        "content": "<p>Ok, thanks. I don't see anything obviously wrong with your theorem (no pattern-matching in <code>let</code> or so, which could be expensive to elaborate in a large context). Maybe be worth reporting as a lean bug, if you can distill it into a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>",
        "id": 494754342,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1737364149
    },
    {
        "content": "<p>Ok, I was able to minify this a bit. It seems that Lean language server is <em>leaking memory</em> when processing the theorem definition of <code>εClosure'.induct'</code>. Every time I add or remove <code>def foo := 0</code> before <code>εClosure'.induct'</code>, the Lean server process consumes additional 1-2GB of RAM when re-processing <code>εClosure'.induct'</code>, but it never frees memory until it crashes (or WSL crashes).<br>\nThis happened <em>even when I replaced the theorem body with <code>sorry</code></em>, so functional induction is not related. Sorry for the false alarm!</p>",
        "id": 494797509,
        "sender_full_name": "pandaman",
        "timestamp": 1737376059
    },
    {
        "content": "<p>Probably the Lean server reprocessed <code>εClosure'.induct'</code> frequently when I was editing them, so it quickly exhausted all RAM in my WSL environment.</p>",
        "id": 494797887,
        "sender_full_name": "pandaman",
        "timestamp": 1737376153
    },
    {
        "content": "<p>How many CPU cores do you have? Could you try running VSCode under a lower <code>LEAN_NUM_THREADS</code>?</p>",
        "id": 494801616,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737377210
    },
    {
        "content": "<p>My machine has 6 cores, but a single <code>lean</code> process consumes 100% of CPU and several GB of RAM, so I'm not sure if multi-core is contributing the issue. I can try it anyway.</p>",
        "id": 494802966,
        "sender_full_name": "pandaman",
        "timestamp": 1737377591
    },
    {
        "content": "<p><code>LEAN_NUM_THREADS=1</code> didn't change the behavior.</p>\n<p><a href=\"/user_uploads/3121/RxlX9ySZH_voyuW5r7JeuZkr/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/RxlX9ySZH_voyuW5r7JeuZkr/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"894x255\" src=\"/user_uploads/thumbnail/3121/RxlX9ySZH_voyuW5r7JeuZkr/image.png/840x560.webp\"></a></div>",
        "id": 494806109,
        "sender_full_name": "pandaman",
        "timestamp": 1737378480
    },
    {
        "content": "<p>Oh, at least with <code>LEAN_NUM_THREADS=1</code>, the memory usage of the most memory-hungry Lean process is capped at 91% RAM (<code>RES: 14.2g</code>), so my WSL doesn't crash even after I repeatedly add and remove <code>def foo := 0</code>.</p>",
        "id": 494809861,
        "sender_full_name": "pandaman",
        "timestamp": 1737379488
    },
    {
        "content": "<p>Maybe there is a cache that doesn't evict entries early enough?</p>",
        "id": 494810077,
        "sender_full_name": "pandaman",
        "timestamp": 1737379554
    },
    {
        "content": "<p>If there is a cap using that setting, it looks like that is the memory high-water mark of elaborating the file, it's just that you found a file with an unusually high high-water mark. And then when you allow more threads, the high-water mark is replicated across the thread-local heaps, which are not currently deallocated until the end of the process. It would be great to track that in an issue!</p>",
        "id": 494892458,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737398798
    },
    {
        "content": "<p>Does running it on the cmdline take similar amounts of memory?</p>",
        "id": 494892506,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737398818
    },
    {
        "content": "<p>When running <code>lake build</code>, the memory usage peaks at around 2GB when processing the file with <code>εClosure'.induct'</code>, so it's less than when I edit the file in VSCode.</p>\n<p>Minimizing this would be tricky since just commenting out one or two argument of  <code>εClosure'.induct'</code> reduces the additional memory usage significantly.</p>",
        "id": 495041248,
        "sender_full_name": "pandaman",
        "timestamp": 1737463952
    },
    {
        "content": "<p>Filed <a href=\"https://github.com/leanprover/lean4/issues/6753\">https://github.com/leanprover/lean4/issues/6753</a>. I couldn't minimize much, but at least I made the reproduction self-contained. Thanks!</p>",
        "id": 495506671,
        "sender_full_name": "pandaman",
        "timestamp": 1737641197
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 495510217,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1737642105
    }
]