[
    {
        "content": "<p>I'm trying to write syntax/macro rules for a data format similar to JSON. In this format, unordered lists of data (i.e., multisets) are enclosed in double angle brackets (<code>&lt;&lt; ... &gt;&gt;</code>) in the same way that lists are enclosed in square brackets (<code>[ ... ]</code>). Writing a syntax for this is simple enough:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">JsonLike</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">bool</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">multiset</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">elems</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">JsonLike</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- | ...     -- Other cases here</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">behavior</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">symbol</span><span class=\"o\">)</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"true\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"false\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span>\n<span class=\"c1\">-- Other rules for lists, objects, identifiers</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;&lt;\"</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"s2\">\"&gt;&gt;\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"jsonlike% \"</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>\n<p>However, I'm having trouble writing a <code>macro_rules</code> for the double angle brackets syntax:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">jsonlike</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">JsonLike</span><span class=\"bp\">.</span><span class=\"n\">bool</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">jsonlike</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">JsonLike</span><span class=\"bp\">.</span><span class=\"n\">bool</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">jsonlike</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">&lt;&lt;$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">xs</span><span class=\"o\">],</span><span class=\"bp\">*&gt;&gt;</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">JsonLike</span><span class=\"bp\">.</span><span class=\"n\">multiset</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"n\">jsonlike</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">xs</span><span class=\"o\">],</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n</code></pre></div>\n<p>Lean gives the error <code>unexpected token '&lt;'; expected jsonlike</code>. It seems like <code>'&lt;'</code> is a reserved character for macro rules. Is there any way to include them?</p>\n<p>(These syntax/macro rules are largely copied from <code>Lean.Data.Json.Elab</code>.)</p>",
        "id": 448948048,
        "sender_full_name": "Cayden Codel",
        "timestamp": 1720040279
    },
    {
        "content": "<p>I think the issue is simply the <code>(behavior := symbol)</code> on <code>declare_syntax_cat</code>! :)</p>",
        "id": 448948945,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720040616
    },
    {
        "content": "<p>So it is - removing it fixed the issue.</p>\n<p>What does <code>(behavior := symbol)</code> do? I copied this over from <code>Lean.Data.Json.Elab</code> without knowing what it does <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 448949217,
        "sender_full_name": "Cayden Codel",
        "timestamp": 1720040724
    },
    {
        "content": "<p>Hmm, the docstrings on <code>Parser.LeadingIdentBehavior</code> constructors aren’t much help to me, since they don’t tell me when we’d want one or the other (besides something about avoiding creating a reserved symbol for each tactic). It is possible that you <em>do</em> want <code>behavior := symbol</code>, and that this should actually be fixed another way! Someone who is more familiar with how this particular knob works will probably have a more reliable answer… :)</p>",
        "id": 448951220,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720041395
    },
    {
        "content": "<p>Well it looks like I have a patch for now. Thanks!</p>",
        "id": 448951672,
        "sender_full_name": "Cayden Codel",
        "timestamp": 1720041603
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"424407\">Cayden Codel</span> has marked this topic as resolved.</p>",
        "id": 448951689,
        "sender_full_name": "Notification Bot",
        "timestamp": 1720041607
    },
    {
        "content": "<p>This might be worth investigating further, though, because e.g. that <code>true</code>’s might leak into generic parsing of <code>true</code>; it should probably be a non reserved symbol (<code>&amp;\"true\"</code>) but that breaks the macro rules too. (Maybe <code>behavior := symbol</code> helps do this without <code>&amp;</code> somehow?)</p>",
        "id": 448952593,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720042033
    },
    {
        "content": "<p>Another option is to leave <code>behavior := symbol</code> as is and write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"&lt;&lt;\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"&gt;&gt;\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">jsonlike</span>\n</code></pre></div>\n<p>I did this on a hunch that this would try to parse <code>&lt;&lt;</code> “at the same level” as <code>&lt;</code> (i.e. sort of as though it was a single token) as parsing <code>&lt;</code> instead of <code>&lt;&lt;</code> seemed to be the issue.</p>",
        "id": 448954107,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720042688
    },
    {
        "content": "<p>This is probably safer, as it seems it won’t expose <code>true</code> and <code>false</code> to the world as <code>jsonlike</code>s, but I’m still surprised at the behavior and interaction with <code>behavior := symbol</code>—mainly because <code>&lt;</code> cannot be part of an ident, so I don’t understand why <code>LeadingIdentBehavior</code> is even relevant.</p>",
        "id": 448954577,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720042872
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"733817\">Kunil Lee</span> has marked this topic as unresolved.</p>",
        "id": 449044097,
        "sender_full_name": "Notification Bot",
        "timestamp": 1720085439
    }
]