[
    {
        "content": "<p>tl;dr: what's the best way to fix a conflict in a PR which depended on another, now merged, PR, without github becoming convinced that I just changed 200 files?</p>\n<p>The details: I made a PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/14155\">#14155</a> which depended on <a href=\"https://github.com/leanprover-community/mathlib4/pull/13294\">#13294</a> (which added a new file) . The depended-on PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/13294\">#13294</a> is now merged, but changes were made to it during review. My PR also added one lemma to this file. I now need to merge master. I may or may not have typed some command a long time ago on this computer which says \"always use the following strategy for merges\" and, if I did, I don't know which strategy I chose (indeed I don't really understand what the difference between the various options is, and don't really care enough about the details to learn, I've read it before and it goes in one ear and out the other, this is beyond my git capabilities and interests). Usually things work out fine here but the last time I tried something like this (<a href=\"https://github.com/leanprover-community/mathlib4/pull/13703\">#13703</a>) I ended up with my PR changing 800+ files and I had to close it and open a new one (<a href=\"https://github.com/leanprover-community/mathlib4/pull/14176\">#14176</a>). Usually I would just do the same this time (i.e. give it a go, see if it works, and if it doesn't work then just close the PR and open a new one and move on with my life) but I noticed that the last time I did this I managed to pollute many other PRs with the message that I pushed a commit that referenced the PR, and I don't want to do this again if I can help it.</p>\n<p>a) How do I avoid this?<br>\nb) If I fail to avoid it, Is there a way where I can check that what I'm about to push to github doesn't trigger this kind of mess? Or a warning sign which I can spot before doing it? Or a way of easily undoing it if I manage to do it again, hopefully without polluting many other PRs?</p>",
        "id": 448690869,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719949995
    },
    {
        "content": "<p>i'm not a git-expert, but i believe that for fixing this situation, the keyword (and git command) you're looking for is <code>rebase</code>. i don't know the precise options that would be best suited to your case, but that should at least give you a place to start looking</p>",
        "id": 448691666,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1719950339
    },
    {
        "content": "<p>from memory, <code>git rebase</code> is a command that allows you to put the changes made from the last common commit with some branch, on top of the current head of that branch...</p>",
        "id": 448691794,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1719950398
    },
    {
        "content": "<p>Note that <code>rebase</code> is exactly the command that risks including lots of commits like that</p>",
        "id": 448691974,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719950434
    },
    {
        "content": "<p>As far as I'm aware, <code>merge</code> won't cause that</p>",
        "id": 448692129,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719950480
    },
    {
        "content": "<p>I can also just do it for you if you like, <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span></p>",
        "id": 448692248,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719950514
    },
    {
        "content": "<p>Yes. Avoid rebasing when merging with a branch with squash merges. You could do <code>git merge --no-ff --strategy=ort master</code> to make sure your settings aren't secretly rebasing things (although, I don't think they should).</p>",
        "id": 448693351,
        "sender_full_name": "Richard Osborn",
        "timestamp": 1719950856
    },
    {
        "content": "<p><a href=\"https://git-scm.com/docs/gitfaq#long-running-squash-merge\">Here's</a> the git FAQ pertaining to this issue.</p>",
        "id": 448694333,
        "sender_full_name": "Richard Osborn",
        "timestamp": 1719951157
    },
    {
        "content": "<p>I also find <code>git diff --name-only master...HEAD</code> very useful to find out which files git thinks that I have modified.</p>",
        "id": 448694487,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1719951212
    },
    {
        "content": "<p>If the output of that is 800 files, chances are that something went wrong.</p>",
        "id": 448694567,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1719951239
    },
    {
        "content": "<p>Also, make sure you aren't defaulting to <code>git pull --rebase</code>.</p>",
        "id": 448694942,
        "sender_full_name": "Richard Osborn",
        "timestamp": 1719951349
    },
    {
        "content": "<p>How? <code>git config -l</code> gives me a lot of output. What am I to make of this?</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>$ git config -l\nuser.email=k.buzzard@imperial.ac.uk\nuser.name=Kevin Buzzard\ncredential.https://github.com.helper=\ncredential.https://github.com.helper=!/usr/bin/gh auth git-credential\ncredential.https://gist.github.com.helper=\ncredential.https://gist.github.com.helper=!/usr/bin/gh auth git-credential\ninit.defaultbranch=main\ncore.repositoryformatversion=0\ncore.filemode=true\ncore.bare=false\ncore.logallrefupdates=true\nremote.origin.url=git@github.com:leanprover-community/mathlib4.git\nremote.origin.fetch=+refs/heads/*:refs/remotes/origin/*\npull.rebase=true\nbranch.master.remote=origin\nbranch.master.merge=refs/heads/master\nbranch.AK_unfolding_trick.remote=origin\nbranch.AK_unfolding_trick.merge=refs/heads/AK_unfolding_trick\nbranch.kbuzzard-group-cohomology-speedup.remote=origin\nbranch.kbuzzard-group-cohomology-speedup.merge=refs/heads/kbuzzard-group-cohomology-speedup\nbranch.hairer.remote=origin\nbranch.hairer.merge=refs/heads/hairer\nbranch.kbuzzard-coalgebra-refactor.vscode-merge-base=origin/master\nbranch.kbuzzard-squeeze-dsimp.vscode-merge-base=origin/master\nbranch.kbuzzard-pointwise-tinkering.vscode-merge-base=origin/master\nbranch.kbuzzard-pointwise-tinkering.remote=origin\nbranch.kbuzzard-pointwise-tinkering.merge=refs/heads/kbuzzard-pointwise-tinkering\nbranch.eric-wieser/pointwiseMulSemiringAction.remote=origin\nbranch.eric-wieser/pointwiseMulSemiringAction.merge=refs/heads/eric-wieser/pointwiseMulSemiringAction\nbranch.fiberedcategories_homlift.remote=origin\n...\n</code></pre></div>",
        "id": 448696746,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719951886
    },
    {
        "content": "<p>Right now I am completely confused because when merging the branches I found theorems in the file Eric added which as far as I can see were not added in either my branch or his :-)</p>",
        "id": 448696975,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719951956
    },
    {
        "content": "<p>Somehow I feel like this is something I need to learn how to do properly (I had not understood that it was the squash merge that was causing the problem) so I feel like I should persevere.</p>",
        "id": 448697150,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719952001
    },
    {
        "content": "<p>What you're running into here is a limiation of bors</p>",
        "id": 448697191,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719952015
    },
    {
        "content": "<p>Maybe we should have a wiki page for this</p>",
        "id": 448697269,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719952031
    },
    {
        "content": "<p>Ah, <code>pull.rebase=true</code></p>",
        "id": 448697521,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719952110
    },
    {
        "content": "<p>So this perhaps explains why the last time I tried this on this computer it was a catastrophe?</p>",
        "id": 448697874,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719952204
    },
    {
        "content": "<p>Yes, I think it might</p>",
        "id": 448697944,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719952214
    },
    {
        "content": "<p>I'll try on another computer :-)</p>",
        "id": 448697981,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719952224
    },
    {
        "content": "<p>So indeed, exactly the same sequence of commands had a different result on the other computer and I have managed to merge without screwing up the PR. Yikes, git is so complex. Thanks to all!</p>",
        "id": 448699135,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719952707
    },
    {
        "content": "<p>If someone wants to tell me how to replace <code>pull.rebase=true</code> with whatever it should say, that would be great :-) This is way beyond my capabilities, I'm only finding commands like <code>git config</code> through google and I don't really like doing stuff like that.</p>",
        "id": 448699521,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719952887
    },
    {
        "content": "<p>I think <code>git config --unset pull.rebase</code> will do it</p>",
        "id": 448699627,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719952926
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/113488-general/topic/how.20to.20resolve.20conflicts.20without.20messing.20up.20branch.3F/near/448697269\">said</a>:</p>\n<blockquote>\n<p>Maybe we should have a wiki page for this</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/wiki/Working-with-dependent-PRs\">https://github.com/leanprover-community/mathlib4/wiki/Working-with-dependent-PRs</a> is the start of my draft, with picture but no commands</p>",
        "id": 448699669,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719952948
    },
    {
        "content": "<p><code>git merge origin/master -X theirs</code> is the command \"merge and choose their version whenever there is a conflict\" (replace \"theirs\" by \"ours\" for the dual).</p>",
        "id": 448718287,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719961619
    },
    {
        "content": "<p>Note that for <code>git rebase</code> the meaning of \"ours\" and \"theirs\" is flipped, for some very stupid reasons.</p>",
        "id": 448718332,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719961659
    },
    {
        "content": "<p>My post <a href=\"#narrow/stream/113488-general/topic/Hint.20about.20merging/near/303510479\">here</a> (and Yury's post above it) probably complements your draft well, because it contains the commands, but little explanation. Feel free to incorporate them.</p>",
        "id": 448718769,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719961952
    },
    {
        "content": "<p>I do not recommend approach 2. You can do it, but personally I only know how to do it with interactive rebases, and then you have to make sure you keep the right files in your rebase.<br>\nBut the main reason I don't like rebases is that when you've solved a merge conflict in an earlier merge/rebase, I believe you're likely having to do it again in a new rebase? That is my memory at least, but maybe I did something stupid. Merges are nicer in any case.</p>",
        "id": 448719502,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719962366
    },
    {
        "content": "<p>But nice draft, that will be useful to have in a central location!</p>",
        "id": 448719672,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719962432
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/113488-general/topic/how.20to.20resolve.20conflicts.20without.20messing.20up.20branch.3F/near/448718287\">said</a>:</p>\n<blockquote>\n<p><code>git merge origin/master -X theirs</code> is the command \"merge and choose their version whenever there is a conflict\" (replace \"theirs\" by \"ours\" for the dual).</p>\n</blockquote>\n<p>I think in the context of this draft this is the wrong thing to do: you don't want \"use their version whenever there is a conflict\", you want plain \"use their version in its entirety\"</p>",
        "id": 448720303,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719962649
    },
    {
        "content": "<p>One reason to prefer approach 2 is that approach 1 leads to bad author information from bors if the base PR has a different author</p>",
        "id": 448720414,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719962702
    },
    {
        "content": "<p>But I agree that approach 1 is usually the safer bet</p>",
        "id": 448720445,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719962722
    },
    {
        "content": "<p>Is there a way of reliably recreating the deleted branch in our set-up? When I switched computers I tried first using my local copy of the deleted branch but it wasn't up to date, and then I tried updating it from origin but of course it was gone, and then I gave up and merged and manually fixed conflicts.</p>",
        "id": 448721905,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719963255
    },
    {
        "content": "<p>For reference, I ran into this issue twice in the last 1.5 months. The least techie but slightly tedious way to get rid of the additional commits is to <code>git reset --hard &lt;ID of the last you made before catastrophe&gt;</code>. You can find this ID by opening git log and scrolling down to your commit. There are faster ways to narrow this hunt depending on the situation. Then you run <code>git config pull.rebase false</code> followed by <code>git merge master</code>. Then to get all of this to GitHub <code>git push --force origin &lt;your PR branch name&gt;</code></p>",
        "id": 448724629,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719964373
    },
    {
        "content": "<p>That should tidy up your PR</p>",
        "id": 448724642,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719964381
    },
    {
        "content": "<p>To hunt through the logs you can also use the <code>git graph</code> vscode extension</p>",
        "id": 448725066,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719964580
    },
    {
        "content": "<p>You can do everything I mentioned above within git graph's GUI</p>",
        "id": 448725121,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719964629
    },
    {
        "content": "<p>Except the git config part, but that's a one time thing</p>",
        "id": 448725153,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719964654
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/113488-general/topic/how.20to.20resolve.20conflicts.20without.20messing.20up.20branch.3F/near/448721905\">said</a>:</p>\n<blockquote>\n<p>Is there a way of reliably recreating the deleted branch in our set-up? When I switched computers I tried first using my local copy of the deleted branch but it wasn't up to date, and then I tried updating it from origin but of course it was gone, and then I gave up and merged and manually fixed conflicts.</p>\n</blockquote>\n<p>Yes, you can pull it from the github UI</p>",
        "id": 448725168,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719964668
    },
    {
        "content": "<p><code>git fetch origin thehashfromthegithubui</code></p>",
        "id": 448725217,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719964683
    },
    {
        "content": "<p>Even if it tidies up the PR, does the force push method still pollute everyone else's PR?</p>",
        "id": 448725239,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719964698
    },
    {
        "content": "<p>Nope</p>",
        "id": 448725248,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719964705
    },
    {
        "content": "<p>Force push is only the right choice here if you screwed up the merge, pushed, and realized you created a disaster</p>",
        "id": 448725432,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719964811
    },
    {
        "content": "<p>I highly recommend the git graph extension if you want to play around with branches.</p>",
        "id": 448725483,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719964831
    },
    {
        "content": "<p>Or get used to <code>git log --decorate --oneline --graph</code></p>",
        "id": 448725512,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1719964848
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 448726067,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719965187
    },
    {
        "content": "<p>This is the extension I am talking about: <a href=\"https://marketplace.visualstudio.com/items?itemName=mhutchie.git-graph\">https://marketplace.visualstudio.com/items?itemName=mhutchie.git-graph</a></p>",
        "id": 448726088,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1719965204
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/113488-general/topic/how.20to.20resolve.20conflicts.20without.20messing.20up.20branch.3F/near/448694487\">said</a>:</p>\n<blockquote>\n<p>I also find <code>git diff --name-only master...HEAD</code> very useful to find out which files git thinks that I have modified.</p>\n</blockquote>\n<p>This is a very useful comment as far as I am concerned. Can I just clarify: is \"the files git thinks that I have modified\" equal to \"the files which github thinks that I have modified\"? I'm still a bit unclear about precisely what is git and what is github.</p>",
        "id": 449386776,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720208976
    },
    {
        "content": "<p>No unfortunately not, what the GitHub UI shows in e.g. its diffs can essentially be a black box at times and suffers from strange caching bugs in situations which are hard to reproduce and report to them.</p>",
        "id": 449387428,
        "sender_full_name": "Julian Berman",
        "timestamp": 1720209278
    },
    {
        "content": "<p>Personally I generally never trust the GitHub UI if its showing something different than what git seems to suggest what will happen, but obviously that's not a great thing when a reviewer is going to likely look at what's seen in the GitHub UI.</p>",
        "id": 449387594,
        "sender_full_name": "Julian Berman",
        "timestamp": 1720209347
    },
    {
        "content": "<p>While what Julian said is correct, I have found it fairly reliable.</p>\n<p>The main difference of course is that the command-line argument above reports information about the repository on your machine, while the GitHub webpage is based on what has been pushed.  So, my comment made the distinction</p>\n<ul>\n<li><code>git</code> -- what you have on your machine</li>\n<li><code>github</code> -- what has been pushed to the remote repository.</li>\n</ul>",
        "id": 449390610,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720210478
    },
    {
        "content": "<p>So, e.g., if your PR on GitHub shows one modified line, since you removed an extra space, locally on your machine you merge master and the command above shows 275 modified files, very likely something has gone wrong somewhere.</p>",
        "id": 449392218,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720211103
    }
]