[
    {
        "content": "<p>Qq has this weird quirk where sometimes you have to write <code>have</code> instead of <code>let</code>, because Qq sometimes unfolds your <code>let</code> variables. Even though I know this I spent quite some time stuck on such a situation again recently. Is there a reason why this can't be fixed? My example is this, with an extremely confusing error message:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">obtainExists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">@</span><span class=\"n\">Exists</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">constLevels!</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"c1\">-- use `have` instead of `let` to fix the error</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDeclDQ</span><span class=\"w\"> </span><span class=\"ss\">`α</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDeclDQ</span><span class=\"w\"> </span><span class=\"ss\">`h</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">type mismatch</span>\n<span class=\"cm\">  Exists.intro «$a» «$h»</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  Exists «$p» : Prop</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  Exists «$p» : Prop</span>\n<span class=\"cm\">-/</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 517269783,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746892438
    },
    {
        "content": "<p>The rule is that <code>let</code> is supposed to be reducible, but Qq doesn't know what to do if you unfold to a non-Qq object</p>",
        "id": 517271464,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746893655
    },
    {
        "content": "<p>Here's another way of constructing the term that avoids the <code>have</code> statements:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">obtainExists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Exists</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferTypeQ</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Expected {e} to be of the form `Exists ..`\"</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDeclDQ</span><span class=\"w\"> </span><span class=\"ss\">`α</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withLocalDeclDQ</span><span class=\"w\"> </span><span class=\"ss\">`h</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 517271515,
        "sender_full_name": "Anand Rao Tadipatri",
        "timestamp": 1746893711
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Qq.20and.20.60have.60.2F.60let.60/near/517271464\">said</a>:</p>\n<blockquote>\n<p>The rule is that <code>let</code> is supposed to be reducible, but Qq doesn't know what to do if you unfold to a non-Qq object</p>\n</blockquote>\n<p>But surely Qq could add a setting of <code>Config.zetaDelta := false</code> when elaborating?</p>",
        "id": 517271759,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746893910
    },
    {
        "content": "<p>What I mean is that this is intended behavior for <code>let</code></p>",
        "id": 517271981,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894116
    },
    {
        "content": "<p>With <code>pp.all</code> you get something a little stranger here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">_</span><span class=\"n\">private</span><span class=\"bp\">.</span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">GetElem</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">get!Internal</span><span class=\"bp\">._</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">1289</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">α</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">p</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">a</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">h</span><span class=\"bp\">»</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">_</span><span class=\"n\">private</span><span class=\"bp\">.</span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">GetElem</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">get!Internal</span><span class=\"bp\">._</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">1289</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">α</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">p</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">_</span><span class=\"n\">private</span><span class=\"bp\">.</span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">GetElem</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">get!Internal</span><span class=\"bp\">._</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">1304</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">α</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">p</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>",
        "id": 517272073,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894181
    },
    {
        "content": "<p>I doubt that it is intended behaviour that in this example the second identical line fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">obtainExists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">@</span><span class=\"n\">Exists</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">constLevels!</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 517272188,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746894246
    },
    {
        "content": "<p>Right, <code>let α : Q(Sort $u) := α</code> is not allowed because the RHS is an Expr</p>",
        "id": 517272258,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894330
    },
    {
        "content": "<p>If you type-cast between Expr and Qq, you have to use <code>have</code></p>",
        "id": 517272268,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894343
    },
    {
        "content": "<p>Using <code>let</code> tells Qq it is allowed to unfold, but if it unfolds then it finds itself with no type info</p>",
        "id": 517272336,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894375
    },
    {
        "content": "<p>Obviously the error message is lousy</p>",
        "id": 517272342,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894382
    },
    {
        "content": "<p>But my problem is that it <em>does</em> work (sometimes) to use <code>let</code> instead of <code>have</code>, so for a user it is really confusing. I didn't know that you always had to use <code>have</code></p>",
        "id": 517272397,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746894434
    },
    {
        "content": "<p>And I don't understand the andvantage of unfolding <code>let</code>s</p>",
        "id": 517272462,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746894483
    },
    {
        "content": "<p>So you can do <code>let x : Q(Nat) := q($y + $z)</code>, and get for free that <code>$x</code> is defeq to <code>$y + $z</code></p>",
        "id": 517272508,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894530
    },
    {
        "content": "<p>I also don't understand why in your example you get away with <code>let</code> the first time but not the second</p>",
        "id": 517272547,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746894578
    }
]