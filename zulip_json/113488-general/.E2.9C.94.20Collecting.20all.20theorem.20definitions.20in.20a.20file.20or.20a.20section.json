[
    {
        "content": "<p>I want to apply an axiom checker (<a href=\"https://lean-ja.github.io/lean-by-example/Diagnostic/Print.html#%E8%88%9E%E5%8F%B0%E8%A3%8F\">https://lean-ja.github.io/lean-by-example/Diagnostic/Print.html#%E8%88%9E%E5%8F%B0%E8%A3%8F</a>) to every theorem in a given file or section. For this, I need to collect definitions in a file or section.</p>\n<p>How to do it?</p>",
        "id": 515695612,
        "sender_full_name": "suhr",
        "timestamp": 1746186476
    },
    {
        "content": "<p>All constants can be found with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Environment.constants#doc\">docs#Lean.Environment.constants</a>, and you can filter the ones from a particular file using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Environment.getModuleIdxFor%3F#doc\">docs#Lean.Environment.getModuleIdxFor?</a><br>\nI don't think you can search all constants within a section, although you could search for all constants in a namespace by looking at their name.</p>",
        "id": 515697009,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1746186978
    },
    {
        "content": "<p>(use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Environment.getModuleIdx%3F#doc\">docs#Lean.Environment.getModuleIdx?</a> to find the module id of a module)</p>",
        "id": 515697224,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1746187043
    },
    {
        "content": "<p>Potentially useful: <code>env.constMap.map₂</code>, where <code>env : Environment</code>, contains only the constants from the current file.</p>",
        "id": 515698543,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1746187499
    },
    {
        "content": "<p>So I tried to do the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">section</span>\n<span class=\"w\">  </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"w\">  </span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#all_constructive \"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdx?</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">mainModule</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdx?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"kn\">end</span>\n</code></pre></div>\n<p>But I get the following error: <code>Decidable (env.getModuleIdx? name = mid)</code>. How to compare <code>ModuleIdx</code>s?</p>",
        "id": 515701855,
        "sender_full_name": "suhr",
        "timestamp": 1746188776
    },
    {
        "content": "<p>Nvm, <code>(env.getModuleIdx? name).map (·.toNat)</code> solves the problem.</p>",
        "id": 515707068,
        "sender_full_name": "suhr",
        "timestamp": 1746190472
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"394485\">@suhr</span> You can write linter against classical axiom</p>",
        "id": 524402403,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750150355
    },
    {
        "content": "<p>see this <a href=\"https://lean-ja.github.io/lean-by-example/Type/Linter.html\">https://lean-ja.github.io/lean-by-example/Type/Linter.html</a></p>",
        "id": 524402547,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750150399
    },
    {
        "content": "<p>or see this <a href=\"#narrow/channel/270676-lean4/topic/restricting.20axioms/near/501743343\">https://leanprover.zulipchat.com/#narrow/channel/270676-lean4/topic/restricting.20axioms/near/501743343</a></p>",
        "id": 524402639,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750150429
    },
    {
        "content": "<p>I already solved this a while ago:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab</span>\n\n<span class=\"kn\">section</span>\n<span class=\"w\">  </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- Ensure that a theorem is constructive -/</span>\n<span class=\"w\">  </span><span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#constructive \"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">constName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectAxioms</span><span class=\"w\"> </span><span class=\"n\">constName</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">caxes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name.isPrefixOf</span><span class=\"w\"> </span><span class=\"ss\">`Classical</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">caxes.isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{constName}' depends on classical axioms: {caxes.toList}\"</span>\n\n<span class=\"w\">  </span><span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#all_constructive \"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env.getModuleIdx</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">env.mainModule</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env.constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env.getModuleIdx</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">toNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">mid.map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">toNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">info.isTheorem</span>\n<span class=\"w\">      </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectAxioms</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">caxes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">axioms</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name.isPrefixOf</span><span class=\"w\"> </span><span class=\"ss\">`Classical</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">caxes.isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"'{name}' depends on classical axioms: {caxes.toList}\"</span>\n<span class=\"kd\">end</span>\n</code></pre></div>",
        "id": 524415448,
        "sender_full_name": "suhr",
        "timestamp": 1750154617
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"394485\">suhr</span> has marked this topic as resolved.</p>",
        "id": 524415476,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750154630
    }
]