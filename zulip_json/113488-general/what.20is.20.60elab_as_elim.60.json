[
    {
        "content": "<p>what is <code>[elab_as_elim]</code> attribute? what does this attribute? what is the difference when I add this attribute to something...?</p>",
        "id": 505631084,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1741946399
    },
    {
        "content": "<p>It changes the way the declaration is elaborated. I don't know the technical details but presumably the idea is that with the tag, Lean is more prepared to have a good guess at the type of the motive which the user means, even though this typically means solving a higher-order unification problem.</p>",
        "id": 505633483,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741947047
    },
    {
        "content": "<p>is there an example ?</p>",
        "id": 505633724,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1741947115
    },
    {
        "content": "<p>Sure, search mathlib for the attribute, then remove it from something and see what breaks.</p>",
        "id": 505633866,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741947141
    },
    {
        "content": "<p><code>@[elab_as_elim]</code> registers the declaration as an eliminator. Eliminators have special support for filling in the motives automatically with syntactic replacement instead of using second-order unification. By default, <code>.rec</code>, <code>.recOn</code>, <code>.casesOn</code>, <code>.brecOn</code> are all eliminators.</p>",
        "id": 505633961,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741947166
    },
    {
        "content": "<p>Things we want to use as recursors (i.e. stuff we want to use to do induction) is what is being tagged.</p>",
        "id": 505634009,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741947179
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 505634217,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1741947234
    },
    {
        "content": "<p>In general, <code>@[elab_as_elim]</code> is for declarations whose return type is of the form <code>p x1 x2 ... xn</code>, and during elaboration you want <code>p</code> to be solved for using the expected type. The expressions <code>x1</code> through <code>xn</code> can be arbitrary expressions. To solve for <code>p</code>, <code>xn</code> through <code>x1</code> are replaced by variables in that order; the result is the body for <code>p</code>. (This process can fail, and you may get a \"motive not type correct\" error. That's when the expression for <code>p</code> is ill-typed.) The elaborator will throw an error if there is no expected type.</p>\n<p>There are a couple of other different rules for how these are elaborated. It eagerly elaborates all arguments that appear in <code>x1</code> through <code>xn</code>. These are like \"major premises\", using eliminator terminology. The remaining arguments are \"minor premises\", and and elaboration for those is deferred until after <code>p</code> is computed.</p>\n<p><code>@[elab_as_elim]</code> at this point is only loosely related to eliminators, but every eliminator uses this elaboration procedure.</p>\n<p>This attribute shouldn't be confused with <code>@[induction_eliminator]</code> or <code>@[cases_eliminator]</code>, which are for configuring which induction or cases principle should be used for the <code>induction</code> and <code>cases</code> tactics.</p>",
        "id": 505662738,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741955514
    },
    {
        "content": "<p>I've been searching for a code example that shows what changes before and after adding the <code>elab_as_elim</code> attribute, and today I finally found one.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"sd\">/-- A pseudo-recursion function modeled after the standard recursor `Nat.rec` -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">t</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n\n<span class=\"c1\">-- If no attribute is given, we get an error message like this</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Function expected at</span>\n<span class=\"sd\">  Nat.rec' ?_ (fun x b =&gt; b + 1) ?_</span>\n<span class=\"sd\">but this term has type</span>\n<span class=\"sd\">  ?_ ?_</span>\n\n<span class=\"sd\">Note: Expected a function because this term is being applied to the argument</span>\n<span class=\"sd\">  a</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"c1\">-- Add an attribute</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">elab_as_elim</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec'</span>\n\n<span class=\"c1\">-- The error message changes to “failed to elaborate eliminator.”</span>\n<span class=\"c1\">-- It is now recognized as an eliminator!</span>\n<span class=\"sd\">/-- error: failed to elaborate eliminator, expected type is not available -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">rec'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 528673526,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1752502813
    },
    {
        "content": "<p>The documentation comment for <code>[elab_as_elim]</code> includes an intriguing code example, but unfortunately, the details are omitted and it can't be run as-is. If anyone is able to fill in the missing pieces of that example, I'd love to hear from them.</p>",
        "id": 528673957,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1752502949
    },
    {
        "content": "<p>You can also take <code>tests/lean/run/elabAsElim.lean</code> in Lean 4 and try deleting <code>@[elab_as_elim]</code> and see failures.</p>",
        "id": 528674946,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752503236
    },
    {
        "content": "<p>With the example in the docstring for <code>elab_as_elim</code>, you can replace <code>...</code> with <code>sorry</code>.</p>\n<p>(<span class=\"user-mention\" data-user-id=\"478376\">@Joseph Rotella</span> In the \"complex substitution\" example, I wonder if it's worth explaining that if <code>@[elab_as_elim]</code> weren't there then even though it looks like it works, you get a bad motive. I wonder if the docstring should include the details from my comment above on 3/14 about how the arguments to the motive can b earbitrary expressions? By the way, there's a typo with <code>evenOddRec</code> vs <code>evenOddRecOn</code>.)</p>",
        "id": 528676799,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752503757
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> I've tried to (relatively concisely) incorporate these changes in <a href=\"https://github.com/leanprover/lean4/pull/9359\">lean4#9359</a>—feel free to adjust. (Relatedly, at some point, it's probably worth turning the \"motive not type correct\" explainer text into a proper error explanation, but I figured that'd best be left to a separate PR.)</p>",
        "id": 528694993,
        "sender_full_name": "Joseph Rotella",
        "timestamp": 1752509143
    },
    {
        "content": "<p>Thanks Joseph (and thanks for adding the docstring in the first place!)</p>",
        "id": 528697053,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752509759
    },
    {
        "content": "<p>No worries—though I believe it was <span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span>  who added the docstring!</p>",
        "id": 528698160,
        "sender_full_name": "Joseph Rotella",
        "timestamp": 1752509971
    },
    {
        "content": "<p>Oh, oops, sorry for pinging you :-)</p>",
        "id": 528698537,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1752510033
    }
]