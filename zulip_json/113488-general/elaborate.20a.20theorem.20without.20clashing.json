[
    {
        "content": "<p>Often, writing linters, I want to take some theorem, modify it and elaborate it again.  However, this causes problems, since the environment already contains the declaration name.  I have a couple of workarounds for this (adding a namespace to the scope, replacing the declaration name by a fresh one, replacing the theorem by an <code>example</code>), but none of these is really satisfactory.</p>\n<p>Is there a principled way to do this?</p>\n<p>Here is some sample code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"toIntro \"</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n<span class=\"w\">  </span><span class=\"c1\">-- the next command is superfluous, I could have simply reelaborated `cmd`, but maybe it</span>\n<span class=\"w\">  </span><span class=\"c1\">-- gives some context</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newCmd</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"bp\">.</span><span class=\"n\">replaceM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Lean.Parser.Tactic.intros</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Elaborating {newCmd}\"</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">newCmd</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">Elaborating theorem with_intros : ∀ x : Nat, x = x := by</span>\n<span class=\"cm\">  intro</span>\n<span class=\"cm\">  rfl</span>\n<span class=\"cm\">-/</span>\n<span class=\"n\">toIntro</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">with_intros</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\">  </span><span class=\"c1\">-- 'with_intros' has already been declared</span>\n<span class=\"w\">  </span><span class=\"n\">intros</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 454466463,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722081843
    },
    {
        "content": "<p>withoutModifyingState ?</p>",
        "id": 454467246,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722082573
    },
    {
        "content": "<p>That is, do the first elaboration in a context where everything (except your return value) is discarded</p>",
        "id": 454467264,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722082605
    },
    {
        "content": "<p>Unfortunately, with linters, the first elaboration is already done for you, so I'm stuck having to elaborate the <em>second</em> one.</p>",
        "id": 454467618,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722082896
    },
    {
        "content": "<p>Or, alternatively, is there a way to get the linter to run <em>before</em> the corresponding command is elaborated?</p>",
        "id": 454467763,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722083013
    }
]