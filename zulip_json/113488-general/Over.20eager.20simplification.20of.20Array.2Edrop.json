[
    {
        "content": "<p>simp will simplify <code>(Array.drop xs n).toList</code>to <code>List.take (as.size - n) (List.drop n xs.toList)</code>. This seems wrong to me. The List.take there is totally superfluous, and this has made some proofs involving Array.extract/Array.drop a bit more annoying than they need to be for me. I think perhaps <code>Array.drop_eq_extract</code> and <code>Array.take_eq_extract</code> should not be simp lemmas (the analogous lemmas for lists are not), and <code>Array.toList_take</code> and <code>Array.toList_drop</code> (which do not currently exist) should be added and made simp lemmas.  MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">drop</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">drop</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>",
        "id": 571782698,
        "sender_full_name": "cmlsharp",
        "timestamp": 1770159570
    },
    {
        "content": "<p>GitHub issue: <a href=\"https://github.com/leanprover/lean4/issues/12299\">https://github.com/leanprover/lean4/issues/12299</a></p>",
        "id": 571800347,
        "sender_full_name": "cmlsharp",
        "timestamp": 1770168397
    },
    {
        "content": "<p>Hmm... the intention here had been to eliminate <code>Array.drop</code> and <code>Array.take</code> from all simp normal forms, by directly simplifying them to <code>extract</code>, so we can just write the API for that instead.</p>\n<p>This does have some bad consequences, as you point out.</p>\n<p>Would it work if we made drop_eq_extract and take_eq_extract lower priority simp lemmas, and also provide some basics like toList_take and toList_drop?</p>",
        "id": 571817404,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770181043
    },
    {
        "content": "<p>Adding</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">take_eq_self_of_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simpa</span>\n\n<span class=\"c1\">-- or</span>\n<span class=\"c1\">-- @[simp] alias ⟨_, take_eq_self_of_le⟩ := List.take_eq_self_iff</span>\n</code></pre></div>\n<p>to make things confluent also helps</p>",
        "id": 571819928,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770182803
    },
    {
        "content": "<p>(which is to say; I would support both lowing the priority, adding <code>toList_take</code>, and adding that lemma for confluence)</p>",
        "id": 571820011,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770182842
    },
    {
        "content": "<p>Well, with the current state of things, removing <code>drop_eq_extract</code> and <code>take_eq_extract</code> doesn't actually do anything because both <code>drop</code> and <code>take</code> are also <code>abbrev</code>s. So we'd at least need to convert it into a <code>@[inline] def</code>.</p>",
        "id": 571849683,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1770195186
    },
    {
        "content": "<blockquote>\n<p>Hmm... the intention here had been to eliminate <code>Array.drop</code> and <code>Array.take</code> from all simp normal forms, by directly simplifying them to <code>extract</code>, so we can just write the API for that instead</p>\n</blockquote>\n<p>Can I ask why this is desirable for Array when it is (presumably) not for List? E.g. why doesn't List.take/drop also simplify to List.extract?</p>",
        "id": 571856021,
        "sender_full_name": "cmlsharp",
        "timestamp": 1770196692
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113488-general/topic/Over.20eager.20simplification.20of.20Array.2Edrop/near/571817404\">said</a>:</p>\n<blockquote>\n<p>Hmm... the intention here had been to eliminate <code>Array.drop</code> and <code>Array.take</code> from all simp normal forms, by directly simplifying them to <code>extract</code>, so we can just write the API for that instead.</p>\n<p>This does have some bad consequences, as you point out.</p>\n<p>Would it work if we made drop_eq_extract and take_eq_extract lower priority simp lemmas, and also provide some basics like toList_take and toList_drop?</p>\n</blockquote>\n<p>To be quite honest I don't understand why this is particularly desirable. At least conceptually I don't think of <code>drop</code> and <code>take</code> as the same kind of operation - indeed to an extent they are kind of \"paired\" operations, right? Like for <code>List</code> we have <code>List.splitAt</code> - conceptually I do kind of think of drop and take as the two components that output from that. I don't think we have <code>Array.splitAt</code>... but we could. The point is, to calculate <code>Array.drop xs n</code> and <code>Array.take xs n</code> only takes <em>one</em> costly operation if you are doing it efficiently.</p>",
        "id": 571864322,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1770198926
    },
    {
        "content": "<p>We don't really provide much API for <code>splitAt</code>, mind - it is easier to just have the API for take and drop. Why you would want to involve <code>extract</code> I have never quite understood.</p>",
        "id": 571865049,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1770199120
    },
    {
        "content": "<p>Of course it's weird for <code>Array</code> I suppose - my understanding is that because of how arrays are stored, in some ways dropping from the <em>end</em> is more natural, but then you have to reverse it... I guess this is why you just use <code>extract</code>.</p>",
        "id": 571865530,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1770199262
    },
    {
        "content": "<p>I agree that 'drop' and 'take' are, at least in my mental model, atomic operations (on both list and array). I really don't want 'simp' converting them to some more general operation</p>",
        "id": 571973531,
        "sender_full_name": "cmlsharp",
        "timestamp": 1770227101
    }
]