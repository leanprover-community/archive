[
    {
        "content": "<p>I am unsure if this is the right place to post but I'm quite stuck.  I'm trying to add a computable version of <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Logic/Small/Defs.html\">Shrink</a>, to do this i am trying to use the FFI feature of lean. I have been trying for the past few days to get this to work but either I segfault when I use external_class, or I get unexpected results when i use anything else.</p>\n<p>In redefining <code>Shrink</code> i try to do it like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">ShrinkImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> @[pp_with_univ] -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">ShrinkImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">.</span><span class=\"n\">equiv_small</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"shrink_mk\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">mkImpl</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"shrink_dest\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">destImpl</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">mkImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">equivShrink</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toFun</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">destImpl</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">dest</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">equivShrink</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">invFun</span>\n</code></pre></div>\n<p>and the simplest C++ that doesnt lead to a segfault is just returning the object like this:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">shrink_mk</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inhabited</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">small</span><span class=\"p\">,</span>\n<span class=\"w\">                                  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">obj</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">shrink_dest</span><span class=\"p\">(</span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">inhabited</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">small</span><span class=\"p\">,</span>\n<span class=\"w\">                                    </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">shrink</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">shrink</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>This leads to very strange behaviour:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">999</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"bp\">.</span><span class=\"n\">dest</span><span class=\"w\"> </span><span class=\"c1\">-- Prints 0?</span>\n</code></pre></div>\n<p>If this is the wrong place to post please feel free to point me where to go.</p>",
        "id": 522917242,
        "sender_full_name": "William Sørensen",
        "timestamp": 1749328462
    },
    {
        "content": "<p><code>export</code> is overkill, just:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">equivShrinkImpl</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">unsafeCast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">unsafeCast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lcProof</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lcProof</span><span class=\"bp\">⟩</span>\n<span class=\"kd\">@[</span><span class=\"n\">csimp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">equivShrink_eq_equivShrinkImpl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">equivShrink</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">equivShrinkImpl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lcProof</span>\n</code></pre></div>\n<p>and then you can define the rest without <code>implemented_by</code> or anything (also why the indirection of <code>extern</code> + <code>implemented_by</code>? you can just do <code>extern</code> on the def. not sure what's wrong with the extern thing)</p>",
        "id": 522918952,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1749330496
    },
    {
        "content": "<p>I suspect you're in trouble here because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Shrink#doc\">docs#Shrink</a> is in <code>Prop</code> and so erased at compile-time?</p>",
        "id": 522919136,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749330731
    },
    {
        "content": "<p>It's not???</p>",
        "id": 522919146,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749330752
    },
    {
        "content": "<p>Ah sorry, I was confusing it with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Small#doc\">docs#Small</a></p>",
        "id": 522919190,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749330806
    },
    {
        "content": "<p>Presumably we could also use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Small</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">equiv_small</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Squash</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>to get some form of computability for free</p>",
        "id": 522919237,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749330873
    },
    {
        "content": "<p>the only computability you'd get for free is data which is (provably) the same up to choice of permutation, which is probably not a lot...</p>",
        "id": 522919728,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749331591
    },
    {
        "content": "<p>I agree this would be useful, I've also naturally wished for that while working on the iterator library. Unfortunately, it seems to me that one currently needs to choose two of (a) get computable <code>Shrink</code>, (b) keep <code>Small</code> in Prop` and (c) do not use unsafe...</p>",
        "id": 522919745,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1749331615
    },
    {
        "content": "<p>Why does the iterator library need <code>Small</code>?</p>",
        "id": 522919918,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749331870
    },
    {
        "content": "<p>The iterators return a value of type <code>m (IterStep α β)</code>, where <code>α</code> is the internal state type and <code>β</code> is the type of the emitted values. If <code>α</code> and <code>β</code> live in distinct universes, then <code>IterStep α β</code> lives in their <code>max</code>, so the monad needs to live in <code>max</code>. This made the API quite fragile to use. <code>Shrink</code> would allow us to compress the state as needed.</p>\n<p>Therefore, <code>α</code> and <code>β</code> are currently forced to live in the same universe. But there are some situations where it's desirable to have them live in different ones (the existing <code>Stream</code> data type is also universe-heterogeneous, but it isn't monadic, so it avoids most of the problems).</p>",
        "id": 522921305,
        "sender_full_name": "Paul Reichert",
        "timestamp": 1749333929
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/stream/113488-general/topic/Making.20Shrink.20computable/near/522918952\">said</a>:</p>\n<blockquote>\n<p><code>export</code> is overkill, just:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">equivShrinkImpl</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">unsafeCast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">unsafeCast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lcProof</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lcProof</span><span class=\"bp\">⟩</span>\n<span class=\"kd\">@[</span><span class=\"n\">csimp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">equivShrink_eq_equivShrinkImpl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">equivShrink</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">equivShrinkImpl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lcProof</span>\n</code></pre></div>\n<p>and then you can define the rest without <code>implemented_by</code> or anything (also why the indirection of <code>extern</code> + <code>implemented_by</code>? you can just do <code>extern</code> on the def. not sure what's wrong with the extern thing)</p>\n</blockquote>\n<p>Wouldn’t I need to mark mk and dest both as noncomputable? Wouldn’t this carry up?</p>",
        "id": 522924053,
        "sender_full_name": "William Sørensen",
        "timestamp": 1749338544
    },
    {
        "content": "<p>Ok I’ll try these things tomorrow at least but we’ll see</p>",
        "id": 522924264,
        "sender_full_name": "William Sørensen",
        "timestamp": 1749338938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"736115\">William Sørensen</span> <a href=\"#narrow/channel/113488-general/topic/Making.20Shrink.20computable/near/522924053\">schrieb</a>:</p>\n<blockquote>\n<p>Wouldn’t I need to mark mk and dest both as noncomputable?</p>\n</blockquote>\n<p>No, we already provided an implementation of <code>equivShrink</code> so it will use that then.</p>",
        "id": 522949189,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1749368388
    },
    {
        "content": "<p>Oh and it would probably be reasonable to mark <code>equivShrinkImpl</code> as <code>@[inline]</code></p>",
        "id": 522949582,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1749368422
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> thanks for the help here, yeah your answer is perfect.</p>",
        "id": 522978929,
        "sender_full_name": "William Sørensen",
        "timestamp": 1749391162
    },
    {
        "content": "<p>Is the code for <code>equivShrinkImpl</code> somewhere accessible?</p>",
        "id": 528510642,
        "sender_full_name": "Tristan Figueroa-Reid",
        "timestamp": 1752391507
    },
    {
        "content": "<p>If we're actually going to do this, can we keep the prop-valued <code>Small</code>? There would be very major breakage in e.g. the entirety of the combinatorial game library otherwise, since we'd have to deal with such annoying stuff such as showing that two different witnesses of <code>Small</code> construct the same game.</p>",
        "id": 528541722,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752425123
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Making.20Shrink.20computable/near/522919237\">said</a>:</p>\n<blockquote>\n<p>Presumably we could also use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Small</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">equiv_small</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Squash</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>to get some form of computability for free</p>\n</blockquote>\n<p>This would still be a bit annoying since <code>x y : Squash α</code> are propeq and not defeq. Otherwise I agree this is the best solution.</p>",
        "id": 528541847,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752425246
    },
    {
        "content": "<p>I found that <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>'s idea of just making the equiv unsafe worked wonders, I just need to check if it is correct</p>",
        "id": 528541859,
        "sender_full_name": "William Sørensen",
        "timestamp": 1752425257
    },
    {
        "content": "<p>Making small reside in type goes against the point as then it must reside in a high universe</p>",
        "id": 528541891,
        "sender_full_name": "William Sørensen",
        "timestamp": 1752425286
    },
    {
        "content": "<p>What's the problem with that? <code>Small</code> would have a \"high\" universe but the equivalent type would still have the correct one.</p>",
        "id": 528541950,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752425343
    },
    {
        "content": "<p>I think another solution might be to make a separate <code>Small'</code> (name pending) typeclass for the data-valued version, and prove <code>Small'</code> implies <code>Small</code>.</p>",
        "id": 528541994,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752425395
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/113488-general/topic/Making.20Shrink.20computable/near/528541847\">said</a>:</p>\n<blockquote>\n<p>This would still be a bit annoying since <code>x y : Squash α</code> are propeq and not defeq. Otherwise I agree this is the best solution.</p>\n</blockquote>\n<p>Isn't this the same story as <code>Fintype</code> and <code>Decidable</code>?</p>",
        "id": 528542015,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425412
    },
    {
        "content": "<p>Well, with <code>Fintype</code>, we eventually ended up making <code>Finite</code>.</p>",
        "id": 528542031,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752425428
    },
    {
        "content": "<p><code>Decidable</code> can also be basically ignored if you're doing proofs and assuming choice</p>",
        "id": 528542047,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752425443
    },
    {
        "content": "<p>Yes, your <code>Small'</code> message came in as I was typing :)</p>",
        "id": 528542055,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425448
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Making.20Shrink.20computable/near/528542015\">said</a>:</p>\n<blockquote>\n<p>Isn't this the same story as <code>Fintype</code> and <code>Decidable</code>?</p>\n</blockquote>\n<p>yes but also no</p>",
        "id": 528542116,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752425508
    },
    {
        "content": "<p>Having reread the thread I now understand that the <code>unsafe</code> idea is reasonable here</p>",
        "id": 528542226,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425595
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/113488-general/topic/Making.20Shrink.20computable/near/528541950\">said</a>:</p>\n<blockquote>\n<p>What's the problem with that? <code>Small</code> would have a \"high\" universe but the equivalent type would still have the correct one.</p>\n</blockquote>\n<p>I can try to have a look into if this is fine but i think i found i needed it to be small to work with the fixed point system i was using, i am unsure though</p>",
        "id": 528542301,
        "sender_full_name": "William Sørensen",
        "timestamp": 1752425651
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Making.20Shrink.20computable/near/528542226\">said</a>:</p>\n<blockquote>\n<p>Having reread the thread I now understand that the <code>unsafe</code> idea is reasonable here</p>\n</blockquote>\n<p>Yeah it really worked wonders for me, was super useful and I belive it is sound, I dont know how to reason that it is though...</p>",
        "id": 528542368,
        "sender_full_name": "William Sørensen",
        "timestamp": 1752425711
    },
    {
        "content": "<p>With your example above, I don't understand why you need the <code>Inhabited</code> vs using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">extern</span><span class=\"w\"> </span><span class=\"s2\">\"shrink_mk\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shrink</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">equivShrink</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toFun</span>\n</code></pre></div>",
        "id": 528542503,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425828
    },
    {
        "content": "<p>Nevermind, I guess Robin's suggestion replaces this. Can you share your working version?</p>",
        "id": 528542587,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752425905
    },
    {
        "content": "<p>Heres a link to the repo i made with it <a href=\"https://github.com/Equilibris/Shrink/blob/main/Shrink/Basic.lean\">https://github.com/Equilibris/Shrink/blob/main/Shrink/Basic.lean</a></p>",
        "id": 528542651,
        "sender_full_name": "William Sørensen",
        "timestamp": 1752425960
    },
    {
        "content": "<p>This worked fine</p>",
        "id": 528542663,
        "sender_full_name": "William Sørensen",
        "timestamp": 1752425973
    },
    {
        "content": "<p>you probably want <code>equivShrinkImpl</code> to be always inline or something</p>",
        "id": 528543330,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752426541
    },
    {
        "content": "<p>I've made a <a href=\"https://github.com/leanprover-community/mathlib4/pull/28112\">pr</a> for this now. If people want to add some comments to it before I post it in <a class=\"stream\" data-stream-id=\"144837\" href=\"/#narrow/channel/144837-PR-reviews\">#PR reviews</a> then feel free. Maybe especially you at <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> as it's your implementation and I included you in the comment if you want to be there or not. Additionally I ended up using <code>implemented_by</code> over your csimp approach, I dont quite know whats best there</p>",
        "id": 533408860,
        "sender_full_name": "William Sørensen",
        "timestamp": 1754636959
    }
]