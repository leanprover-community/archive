[
    {
        "content": "<p>When minimizing <a href=\"#narrow/channel/113488-general/topic/docgen.3A.20unkown.20facet.20.60foo.3Adocs.C2.B4\">this error</a>, I stumbled upon this behaviour:</p>\n<ul>\n<li>Run</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n<span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"n\">docbuild</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">docbuild</span>\n</code></pre></div>\n<ul>\n<li>Copy <code>lakefile.toml</code> from the <a href=\"https://github.com/leanprover/doc-gen4?tab=readme-ov-file#usage\">README</a> to <code>lakefile.toml</code>.</li>\n<li>Run <code>lake update doc-gen4</code>.</li>\n</ul>\n<p>This nukes the entire contents of the <code>bar</code> folder!</p>\n<p>The error happens because \"Your Library Name\" does not exist, the precise error message is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'«</span><span class=\"n\">Your</span><span class=\"w\"> </span><span class=\"n\">Library</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">»'</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">downloaded</span><span class=\"w\"> </span><span class=\"n\">incorrectly</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">manually</span><span class=\"w\"> </span><span class=\"n\">delete</span><span class=\"w\"> </span><span class=\"bp\">'./././../'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">docbuild</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">bar'</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">'«</span><span class=\"n\">Your</span><span class=\"w\"> </span><span class=\"n\">Library</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">»'</span>\n</code></pre></div>\n<p>This is of course fine and a user error, but nuking the entire project is maybe a bit much of a punishment :)<br>\n(Also local <code>git</code> history does not help here, since <code>.git</code> is also deleted).</p>",
        "id": 492331826,
        "sender_full_name": "Christian Merten",
        "timestamp": 1736263718
    },
    {
        "content": "<p>I guess <a href=\"https://github.com/leanprover/lean4/blob/97d07a54a353cc467e34470ca5417243cf3f9d9f/src/lake/Lake/Load/Resolve.lean#L222\">this line</a> should only be executed for downloaded dependencies, not local paths.</p>",
        "id": 492334214,
        "sender_full_name": "Christian Merten",
        "timestamp": 1736264397
    },
    {
        "content": "<p>I think <code>if matDep.manifestEntry.src matches .git .. then</code> on the line above the one you link to is intended to protect against precisely that</p>",
        "id": 492335178,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736264731
    },
    {
        "content": "<p>Ah and this was fixed in <a href=\"https://github.com/leanprover/lean4/pull/5878\">lean4#5878</a>, but I had not done <code>elan update</code> in a while, so <code>stable</code> pointed to <code>4.12.0</code> which is older than <a href=\"https://github.com/leanprover/lean4/pull/5878\">lean4#5878</a>.</p>",
        "id": 492338912,
        "sender_full_name": "Christian Merten",
        "timestamp": 1736265871
    }
]