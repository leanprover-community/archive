[
    {
        "content": "<p>Trying the following, is it possible that <code>:</code> is hard coded and cannot be used as a token in the expansion?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"o[\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"n\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Prod.mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Prod.mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Prod.mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Doesn't work</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Doesn't work</span>\n</code></pre></div>",
        "id": 477888610,
        "sender_full_name": "Ben",
        "timestamp": 1729423903
    },
    {
        "content": "<p>i think the issue here is that you haven't told lean that <code>:</code> can be part of the syntax you're writing...</p>",
        "id": 477891294,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729426899
    },
    {
        "content": "<p>looking at the syntax you're declaring and how you're using it, <code>o[ \"hi\":4]</code> being a term would mean that <code>\"hi\":4</code> itself is a term (which it isn't, afaik)</p>",
        "id": 477891388,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729426994
    },
    {
        "content": "<p>I see. So I need to have something else on the inner other than <code>term</code>?</p>",
        "id": 477895911,
        "sender_full_name": "Ben",
        "timestamp": 1729431173
    },
    {
        "content": "<p>I think this is closer to what I want, but not having any success.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">kv_association</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\": \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">kv_association</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"o[\"</span><span class=\"w\"> </span><span class=\"n\">kv_association</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"s2\">\"hi\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 477895945,
        "sender_full_name": "Ben",
        "timestamp": 1729431231
    },
    {
        "content": "<p>this should work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">kv_association</span>\n\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\": \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">kv_association</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"o[\"</span><span class=\"w\"> </span><span class=\"n\">kv_association</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"s2\">\"hi\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 477896140,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729431393
    },
    {
        "content": "<p>Yah just figured out that <code>$l:term</code> fixes it <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 477896160,
        "sender_full_name": "Ben",
        "timestamp": 1729431425
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"457144\">Ben</span> has marked this topic as resolved.</p>",
        "id": 477896164,
        "sender_full_name": "Notification Bot",
        "timestamp": 1729431431
    },
    {
        "content": "<p>Is there a <code>stringify</code> type thing possible in lean like in Rust <a href=\"https://doc.rust-lang.org/std/macro.stringify.html\">https://doc.rust-lang.org/std/macro.stringify.html</a>. </p>\n<p>It would be nice for the LHS of a KV_association to just be an ident (without quotations). In the macro construction somewhere around the <code>Prod.mk $l ...</code> it would be <code>Prod.mk (Lean.identToString $l) ...</code>?</p>",
        "id": 477896485,
        "sender_full_name": "Ben",
        "timestamp": 1729431828
    },
    {
        "content": "<p>If you want the lhs to be an ident, you should use <code>ident</code> instead of <code>term</code> there. You can quote it using <code> `(Prod.mk $(quote l) $r)</code> which will produce a <code>Name x A</code> pair</p>",
        "id": 477902645,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729436483
    },
    {
        "content": "<p>or you can parse a <code>term</code> but match <code>ident</code> specially, although in that case it's not clear what syntax people should use if they want to interpolate a variable into that position</p>",
        "id": 477902737,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729436549
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">kv_association</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\": \"</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"o[\"</span><span class=\"w\"> </span><span class=\"n\">kv_association</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">kvs</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">kvs</span><span class=\"bp\">.</span><span class=\"n\">getElems</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">kv_association</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">kv_association</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupported</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">out</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"o\">[</span><span class=\"n\">hi</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[(</span><span class=\"s2\">\"hi\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"hi\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)]</span>\n</code></pre></div>",
        "id": 477903035,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1729436839
    }
]