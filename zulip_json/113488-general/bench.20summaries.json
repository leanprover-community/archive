[
    {
        "content": "<p>Inspired by <span class=\"user-mention\" data-user-id=\"479359\">@Michael Stoll</span>'s summaries of <code>!bench</code> outputs, I wrote an action that would automatically post a similar comment on every <code>!bench</code> result.  You can see a version of this <a href=\"https://github.com/bryangingechen/mathlib4/pull/12#issuecomment-2328756897\">here</a>.</p>",
        "id": 467518677,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725453055
    },
    {
        "content": "<p>Before I open a PR, I wanted to ask whether this would be desirable and feedback for different formats.</p>",
        "id": 467518812,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725453089
    },
    {
        "content": "<p>In particular, if you really want <em>nested</em> tables, it is possible, but would require injecting some html into the markdown.  I would only look into this if there was some serious support for it!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 467519160,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725453153
    },
    {
        "content": "<p>Not answering your question, but I sometimes have to compare bench results that are not the result of <code>!bench</code>, and would enjoy having a way to get a report likes yours from two git commit shas, or from a link like <a href=\"http://speed.lean-fro.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45\">http://speed.lean-fro.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45</a></p>",
        "id": 467524996,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1725454244
    },
    {
        "content": "<p>The action described above actually scrapes  <a href=\"http://speed.lean-fro.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45\">http://speed.lean-fro.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45</a>, extracts the commit shas and then formats the json request to the speedcenter.  Integrating this with what you want <em>may</em> be straightforward.</p>",
        "id": 467526050,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725454463
    },
    {
        "content": "<p>E.g., does <a href=\"https://github.com/bryangingechen/mathlib4/pull/12#issuecomment-2328949852\">this</a> look like a reasonable summary for what you posted?</p>",
        "id": 467526490,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725454569
    },
    {
        "content": "<p>(I simply replaced your link into the analogous link from a different <code>!bench</code> and re-triggered the same action.)</p>",
        "id": 467526678,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725454601
    },
    {
        "content": "<p>I don't know much about CI, but I do know that I like very much Michael's summaries. But is there a chance that adding this will make our CI even more likely to fail/time out/whatever?</p>",
        "id": 467568716,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725462366
    },
    {
        "content": "<p>There is always the possibility of something breaking.  However, this action is triggered on comments (not on push, so the regular build would be unaffected).  I think that the worst that can happen is that the action fails and a message is not posted, not that the \"core\" mathlib CI will break.</p>",
        "id": 467569184,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725462460
    },
    {
        "content": "<p>In terms of speed, the \"full\" action takes about 20s, but this is only when the last message on the PR starts with <code>Here are the [benchmark results]</code>, so most of the times, it will just take the time it takes it to realize that this is not the case and stop processing.</p>",
        "id": 467569918,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725462581
    },
    {
        "content": "<p>After all these reassurances, let me also admit that CI has ways of breaking that are always surprising and unexpected, so, the honest answer is: if this looks a good addition, then we should risk and see if it breaks anything substantial!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 467570227,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725462637
    },
    {
        "content": "<p>(In case it was not clear from my message above: the \"regular\" CI, the one that GitHub uses for the green tick and the one that bors uses for merging into master, is in a workflow file that is <em>different</em> from the file that encodes this new action, so the risk would be really minimal!)</p>",
        "id": 467570839,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725462766
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16488\">#16488</a></p>",
        "id": 467652257,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725481058
    },
    {
        "content": "<p>You can see tests for this action and the script at the <a href=\"https://github.com/bryangingechen/mathlib4/pull/12#issuecomment-2328756897\">links above</a> on Bryan's fork of mathlib.</p>",
        "id": 467652411,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725481112
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16217#issuecomment-2381392953\">https://github.com/leanprover-community/mathlib4/pull/16217#issuecomment-2381392953</a></p>\n<p>both links of this <code>!bench</code> summary say \"site cant be resched\". Didnt look into it yet, does that have something to do with the new website?</p>",
        "id": 473476410,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1727633914
    },
    {
        "content": "<p>Works for me</p>",
        "id": 473477534,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1727634566
    },
    {
        "content": "<p>Ah maybe the browser on my phone blocks it because its not a secure connection. Works on my laptop, too (where it should \"connection not secure\"). Sorry for the noise, must be a setting in my mobile browser.</p>",
        "id": 473483020,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1727637051
    },
    {
        "content": "<p>I have never managed to view the benchmarks from my phone.</p>",
        "id": 473483061,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727637088
    },
    {
        "content": "<p>Ah, my phone sends me to <code>https://speed.lean-fro.com</code> instead of <code>http://speed.lean-fro.com</code> and the former cannot be reached. Probably the bot just needs to print the prefix <code>http://</code> and it would work. Let me see if I find where that bot is located...</p>",
        "id": 473483269,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1727637257
    },
    {
        "content": "<p>I stumbled upon this PR and just left a review.</p>",
        "id": 478157470,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1729547952
    },
    {
        "content": "<p>Bench summaries are now in mathlib!</p>\n<p>If you bench your PR, after you receive the results, another bot should post a Michael-style summary as well.</p>",
        "id": 478427193,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729667760
    },
    {
        "content": "<p>This was just added, so let me know of any issues or missing posts!</p>\n<p>Thanks!</p>",
        "id": 478427292,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729667796
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18121#issuecomment-2434721180\">This report</a> confused me for a moment: all metrics improve (i.e., go down) --- but the instructions show a negative percentage, while the percentage column shows a <code>+</code> sign. Can the percentage be fixed to match the other sign?</p>",
        "id": 478694897,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1729770012
    },
    {
        "content": "<p>The diff format was abandoned? That's a shame, I thought it was really clever.</p>",
        "id": 478696658,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1729770590
    },
    {
        "content": "<p>Michael, I'll take a look: possibly I simply subtracted numbers in different orders for one report and for the other (or maybe it is just the formatting that needs to be aware of signs).</p>",
        "id": 478699564,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729771403
    },
    {
        "content": "<p>Mauricio, the comment on the PR does not supersede whatever output bench produces: it is just a summary, but you can still click on the bench output and view the complete report.</p>",
        "id": 478699760,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729771452
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113488-general/topic/bench.20summaries/near/478699564\">said</a>:</p>\n<blockquote>\n<p>Michael, I'll take a look: possibly I simply subtracted numbers in different orders for one report and for the other (or maybe it is just the formatting that needs to be aware of signs).</p>\n</blockquote>\n<p>It turns out that I changed the sign on purpose to be the wrong one: <a href=\"https://github.com/leanprover-community/mathlib4/pull/18170\">#18170</a> fixes the mistake.</p>",
        "id": 478712227,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729775231
    },
    {
        "content": "<p>And it's already merged: thanks Matt!</p>",
        "id": 478715777,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729776165
    },
    {
        "content": "<p>I am also happy that this is getting tested: I was worried that the speed-center troubles would delay using this tool.</p>",
        "id": 478715782,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729776167
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/channel/113488-general/topic/bench.20summaries/near/467524996\">said</a>:</p>\n<blockquote>\n<p>Not answering your question, but I sometimes have to compare bench results that are not the result of <code>!bench</code>, and would enjoy having a way to get a report likes yours from two git commit shas, or from a link like <a href=\"http://speed.lean-fro.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45\">http://speed.lean-fro.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45</a></p>\n</blockquote>\n<p>Coming back to this – I see there is a <code>bench_summary</code> script in the mathlib repo, but it seems I that determining the URL to scrape and creating the report is rather tightly coupled. Have you thought about extracting the part that takes the two run ids and produces a markdown report from the rest? Even if just as a local function that I can invoke using <code>run_cmd</code> in VSCode would be helpful (but a command line tool/lake script maybe even more)</p>",
        "id": 504542547,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1741604603
    },
    {
        "content": "<p>IIRC from the PR's review discussion, the conclusion was that things could be refactored, but postponing that was fine until a use case came up. In other words, if you could use this functionality, I don't see why it can't be refactored :-)</p>",
        "id": 504546392,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1741605521
    },
    {
        "content": "<p>I see. I regularly look at urls like <a href=\"https://speed.lean-lang.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45\">https://speed.lean-lang.org/mathlib4/compare/8c347d50-8923-404f-9e41-daa5fd4ab2f7/to/dfab2686-177b-44a1-afc4-b23a55bcce45</a> when working on Lean PRs, and would love to have an easy way to produce a report for that that I can paste.</p>",
        "id": 504547225,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1741605724
    },
    {
        "content": "<p>My memory is that the speed-center identifies runs not by commit hash, but by something else that is hard to read \"externally\".</p>",
        "id": 504555062,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741607603
    },
    {
        "content": "<p>The only place where I know where to find it, is in the bot's message.</p>",
        "id": 504555133,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741607618
    },
    {
        "content": "<p>To be slightly more specific, comparing the github hashes</p>\n<ul>\n<li>git <code>77ffd776b7fb2a9fd4e4d96c32245eeed92e6924</code></li>\n</ul>\n<p>and</p>\n<ul>\n<li>git <code>fa9b36533f4059e2df709cff88edc6d9091cd4a6</code></li>\n</ul>\n<p>in the speed-center, you should retrieve the \"hashes\"</p>\n<ul>\n<li>speed-center <code>988cf51c-aadd-4440-85ef-77a6d496aa6e</code></li>\n</ul>\n<p>and</p>\n<ul>\n<li>speed-center <code>d7a661e9-3f5f-47e2-8cd7-b465c89a18c3</code>.</li>\n</ul>\n<p>I got this information from <a href=\"https://github.com/leanprover-community/mathlib4/pull/21832#issuecomment-2708856939\">this bot message</a>, but I do not know how to get any direction of the correspondence git hash &lt;--&gt; speed-center hash, without relying on the bot message.</p>",
        "id": 504564262,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741609681
    },
    {
        "content": "<p>Reading your message now, if you already know the speed-center hashes, then extracting the markdown should be straightforward from the <code>bench_summary</code> script.  Is this what you would like to have?</p>",
        "id": 504564952,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741609827
    },
    {
        "content": "<p>Yes – although going from commit to run isn’t hard, this is the script that I am using:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">speed</span><span class=\"bp\">-</span><span class=\"n\">compare</span><span class=\"bp\">.</span><span class=\"n\">sh</span>\n<span class=\"bp\">#!/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">bash</span>\n\n<span class=\"n\">rev1</span><span class=\"bp\">=$</span><span class=\"mi\">1</span>\n<span class=\"n\">shift</span>\n<span class=\"n\">rev2</span><span class=\"bp\">=$</span><span class=\"mi\">1</span>\n<span class=\"n\">shift</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"s2\">\"$rev1\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"s2\">\"$rev2\"</span><span class=\"w\"> </span><span class=\"o\">]</span>\n<span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"usage: $0 rev1 rev2\"</span>\n<span class=\"n\">fi</span>\n\n<span class=\"n\">run1</span><span class=\"bp\">=</span><span class=\"s2\">\"$(curl -sS https://speed.lean-lang.org/mathlib4/api/commit/e7b27246-a3e6-496a-b552-ff4b45c7236e/$rev1 | jq -r '.commit.runs[0].id')\"</span>\n<span class=\"n\">run2</span><span class=\"bp\">=</span><span class=\"s2\">\"$(curl -sS https://speed.lean-lang.org/mathlib4/api/commit/e7b27246-a3e6-496a-b552-ff4b45c7236e/$rev2 | jq -r '.commit.runs[0].id')\"</span>\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"https://speed.lean-lang.org/mathlib4/compare/$run1/to/$run2\"</span>\n</code></pre></div>\n<p>Pulling this into a bench report script would likely be reasonable.</p>",
        "id": 504581204,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1741613256
    },
    {
        "content": "<p>Ok, so I think that your <code>speed-compare</code> script is the link that I was missing!</p>",
        "id": 504581804,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741613388
    },
    {
        "content": "<p>What would you like the command to do?  Take as input two commit hashes and print the <code>md</code> report that the bench summary bot posts?</p>",
        "id": 504582014,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741613419
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113488-general/topic/bench.20summaries/near/504582014\">said</a>:</p>\n<blockquote>\n<p>What would you like the command to do?  Take as input two commit hashes and print the <code>md</code> report that the bench summary bot posts?</p>\n</blockquote>\n<p>Yes, that would be lovely. Maybe include a link to the comparison on <a href=\"http://speed.lean-lang.org\">speed.lean-lang.org</a> (as I’d probably want that to be included always) and also the commits, to avoid confusion (guess a line containing links to these doesn't hurt on the PR notifications either, for posterity, so this hopefully needs no separate code path)</p>",
        "id": 504638645,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1741624972
    }
]