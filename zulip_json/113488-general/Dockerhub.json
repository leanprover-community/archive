[
    {
        "content": "<p>Continuing from <a class=\"stream-topic\" data-stream-id=\"348111\" href=\"/#narrow/stream/348111-batteries/topic/Opening.20batteries.20fork.20in.20gitpod\">#batteries &gt; Opening batteries fork in gitpod</a>, I have now updated the <a href=\"https://hub.docker.com/repository/docker/leanprovercommunity/lean/\"><code>leanprovercommunity/lean</code></a> and <a href=\"https://hub.docker.com/repository/docker/leanprovercommunity/mathlib/\"><code>leanprovercommunity/mathlib</code></a> Docker images using the Dockerfiles from <a href=\"https://github.com/leanprover-community/mathlib4/pull/15936\">#15936</a> (thanks <span class=\"user-mention\" data-user-id=\"492774\">@Sky Wilshaw</span>!).</p>",
        "id": 463200104,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723998443
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>, <span class=\"user-mention\" data-user-id=\"466334\">@Shreyas Srinivas</span>, <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span></p>",
        "id": 463200118,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723998451
    },
    {
        "content": "<p>It's probably not the end of the story, but it's a good start. I have self-proclaimed myself \"image maintainer\", by which I mean \"Come annoy me with your image issues!\".</p>",
        "id": 463200344,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723998571
    },
    {
        "content": "<p>I think it might still be a better idea to manage these via <code>ghcr.io</code>, since that way we don't have to keep track of dockerhub credentials</p>",
        "id": 463201220,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723999092
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463200104\">said</a>:</p>\n<blockquote>\n<p>I have now updated the <a href=\"https://hub.docker.com/repository/docker/leanprovercommunity/lean/\"><code>leanprovercommunity/lean</code></a> and <a href=\"https://hub.docker.com/repository/docker/leanprovercommunity/mathlib/\"><code>leanprovercommunity/mathlib</code></a> Docker images</p>\n</blockquote>\n<p>I fear this will have broken any lean3 projects that were referring to the previous image without referencing a version. It would be better to create new <code>4</code> images I think, and rollback to the old versions of these.</p>",
        "id": 463201243,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723999120
    },
    {
        "content": "<p>Yeah, I can confirm that if I open one of my old lean3 repos in gitpod, <code>leanproject</code> is no longer installed.</p>",
        "id": 463203585,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724000028
    },
    {
        "content": "<p>So please can you put these images back to the ones generated from the mathlib3 repo, and choose new names (either <code>mathlib4</code>, or using ghcr) for the lean4 ones; while no one should be writing new lean3 code, that's no reason to break old archived code referenced by papers etc.</p>",
        "id": 463203831,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724000091
    },
    {
        "content": "<p>I agree with Eric. Changing the image under a given name and tag breaks compatibility for existing work making it harder to reproduce the results of old projects. New lean4 and mathlib4 images would be better.</p>",
        "id": 463242349,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724015472
    },
    {
        "content": "<p>In general, it might be a good idea to version-tag the docker images we produce, e.g. <code>leanprovercommunity/mathlib4:2024-08-19</code>, for increased reproducibility. Dockerhub/ghcr don't have maximum tag limits, right?</p>",
        "id": 463350581,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724057803
    },
    {
        "content": "<p>Don't know about tag limits. I think this was already discussed further up. The main point is existing images shouldn't be altered.</p>",
        "id": 463350731,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724057866
    },
    {
        "content": "<p>A <code>latest</code> or <code>gitpod</code> or <code>devcontainer</code> tag would be a nice addition since those containers don't need a vscode install</p>",
        "id": 463350857,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724057903
    },
    {
        "content": "<p>Who is the target audience for <code>latest</code>?</p>",
        "id": 463351044,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724057956
    },
    {
        "content": "<p>Projects in active development, I presume? I used it on the Con(NF) project a while ago (until the port to Lean 4)</p>",
        "id": 463351138,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724057979
    },
    {
        "content": "<p>For CI, I mean</p>",
        "id": 463351155,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724057992
    },
    {
        "content": "<p>It's significantly easier to set up a docker container that you can test locally than to try to understand the arcane workings of GitHub Actions</p>",
        "id": 463351261,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058019
    },
    {
        "content": "<p>I think the CI we use would already be containerized</p>",
        "id": 463351407,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058072
    },
    {
        "content": "<p>I think my claim is that even for that use-case a versioned image would be better</p>",
        "id": 463351479,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724058096
    },
    {
        "content": "<p>I suspect there would be limits for how many images can be stored</p>",
        "id": 463351595,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058128
    },
    {
        "content": "<p>Images can easily reach a gigabyte</p>",
        "id": 463351633,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058141
    },
    {
        "content": "<p>I should clarify that the images I've been working on with Yaël do not contain a version of mathlib, but (at least for now) I ask elan to download the latest stable lean just so that there's <em>something</em> there to use - so there aren't too many possible versions</p>",
        "id": 463351768,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058204
    },
    {
        "content": "<p>This means that <code>latest</code> would work for any project that can be compiled with current <code>lake</code></p>",
        "id": 463351839,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058238
    },
    {
        "content": "<p>that's more or less what the current image does</p>",
        "id": 463351918,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058258
    },
    {
        "content": "<p>Yeah - the Lean 3 image for <code>leanprovercommunity/mathlib</code> also had a <code>leanproject get</code> call in it though, which I thought was the cause for concern about versioning</p>",
        "id": 463352008,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058292
    },
    {
        "content": "<p>that line can be safely removed for mathlib4 images</p>",
        "id": 463352140,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058337
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"492774\">Sky Wilshaw</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463351839\">said</a>:</p>\n<blockquote>\n<p>This means that <code>latest</code> would work for any project that can be compiled with current <code>lake</code></p>\n</blockquote>\n<p>Ah, but using <code>latest</code> is also saying \"my project will continue to work with all futures versions of lake\".</p>",
        "id": 463352153,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724058343
    },
    {
        "content": "<p>I instead interpret it as \"my project is intended to follow current development of <code>lake</code> and I will regularly run <code>lake update</code>\"</p>",
        "id": 463352297,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058383
    },
    {
        "content": "<p>(probably this matters more for blueprint dependencies, indeed the lean-only dependencies are unlikely to have versioning issues)</p>",
        "id": 463352333,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724058394
    },
    {
        "content": "<p>When you freeze a project you would also fix that version</p>",
        "id": 463352337,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058396
    },
    {
        "content": "<p>you need the latest image to open actively maintained repositories like mathlib4 or dependents</p>",
        "id": 463352386,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058415
    },
    {
        "content": "<p>I think a lot of projects are frozen by being abandoned</p>",
        "id": 463352403,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724058422
    },
    {
        "content": "<p>Yeah, that's true</p>",
        "id": 463352426,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058427
    },
    {
        "content": "<p>The lean and mathlib images we've been working on will very very rarely need an update, only something that changes something fundamental in elan or adds a new binary will need people to update; conversely, the gitpod container (with leanblueprint etc) is liable to lots of updates</p>",
        "id": 463352611,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058486
    },
    {
        "content": "<p>(This is all to say that I agree with the points above about reverting the original images, by the way! I'm just saying that we need a better solution than just making a single Lean 4 image.)</p>",
        "id": 463352700,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058532
    },
    {
        "content": "<p>Btw, by \"reverting the original images\" you actually mean \"rerun the dockerfiles in the <code>mathlib3</code> repo and push them to dockerhub, right?</p>",
        "id": 463352835,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724058588
    },
    {
        "content": "<p><a href=\"https://github.com/features/packages\">https://github.com/features/packages</a></p>",
        "id": 463352857,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058593
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463352835\">said</a>:</p>\n<blockquote>\n<p>Btw, by \"reverting the original images\" you actually mean \"rerun the dockerfiles in the <code>mathlib3</code> repo and push them to dockerhub, right?</p>\n</blockquote>\n<p>Yes, exactly</p>",
        "id": 463352967,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724058609
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463352835\">said</a>:</p>\n<blockquote>\n<p>Btw, by \"reverting the original images\" you actually mean \"rerun the dockerfiles in the <code>mathlib3</code> repo and push them to dockerhub, right?</p>\n</blockquote>\n<p>for that repo/name/tag.</p>",
        "id": 463353013,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058618
    },
    {
        "content": "<p>I'm asking because, importantly, if I do that the images will end up with elan 3.1.1 and not elan 1.4.3 as the original images did</p>",
        "id": 463353119,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724058637
    },
    {
        "content": "<p>(I think that's an improvement)</p>",
        "id": 463353158,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724058646
    },
    {
        "content": "<p>And probably a newer <code>leanproject</code></p>",
        "id": 463353215,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058660
    },
    {
        "content": "<p>Doesn't docker hub let you revert your change?</p>",
        "id": 463353305,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058682
    },
    {
        "content": "<p>It's certainly better than having the lean4 image there!</p>",
        "id": 463353399,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724058707
    },
    {
        "content": "<p>The answer is no apparently: <a href=\"https://stackoverflow.com/questions/55475080/how-can-i-revert-my-last-push-on-hub-docker-com\">https://stackoverflow.com/questions/55475080/how-can-i-revert-my-last-push-on-hub-docker-com</a></p>",
        "id": 463353512,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058749
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463353305\">said</a>:</p>\n<blockquote>\n<p>Doesn't docker hub let you revert your change?</p>\n</blockquote>\n<p>I don't think it does. I think that tags on Docker Hub are \"supposed\" to be immutable.</p>",
        "id": 463353521,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058755
    },
    {
        "content": "<p>The second answer in that link suggests a way to recover the old image</p>",
        "id": 463353684,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058819
    },
    {
        "content": "<p>the tag is just for human readability. there is an underlying digest for each image.</p>",
        "id": 463353929,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724058896
    },
    {
        "content": "<p>The Advanced Image Management feature was removed in 2023, apparently. <a href=\"https://github.com/docker/roadmap/issues/534\">https://github.com/docker/roadmap/issues/534</a></p>",
        "id": 463354168,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724058981
    },
    {
        "content": "<p>okay. Strange decision on their part.</p>",
        "id": 463354286,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724059033
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> it is possible that you  locally have the old image.</p>",
        "id": 463382992,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724068458
    },
    {
        "content": "<p><code>docker image  ls</code></p>",
        "id": 463383080,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724068477
    },
    {
        "content": "<p>You can also look as the history of an image with a name and tag: <a href=\"https://docs.docker.com/reference/cli/docker/image/history/\">https://docs.docker.com/reference/cli/docker/image/history/</a></p>",
        "id": 463383272,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724068533
    },
    {
        "content": "<p>You might be able to locally revert the image to the previous digest by tagging it. It took me a short while but I found a gist that does this: <a href=\"https://gist.github.com/jclosure/b2bcf0686739ad6b79df\">https://gist.github.com/jclosure/b2bcf0686739ad6b79df</a></p>",
        "id": 463383629,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724068683
    },
    {
        "content": "<p>I mean is it really that terrible if the lean3 and mathlib3 images have an updated elan/leanproject?</p>",
        "id": 463385307,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724069304
    },
    {
        "content": "<p>Intuition suggests it shouldn't matter. But it is hard to predict in advance that nothing important is broken by these changes. There are all sorts of bureaucratic artefact reproducibility rules that require artefacts to be preserved for a decade or so.</p>",
        "id": 463385757,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724069481
    },
    {
        "content": "<p>Honestly I expect the probability that something is affected to be smaller than almost any positive epsilon we can pick, and we do live in the \"real\" world, but as long as we have the option to not break things, I see no reason to break them. Then again, who benefits from up to date lean3 images?</p>",
        "id": 463385990,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724069575
    },
    {
        "content": "<p>I think it's probably ok for them to end up with updated elan / leanproject</p>",
        "id": 463385995,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724069577
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463200344\">said</a>:</p>\n<blockquote>\n<p>It's probably not the end of the story, but it's a good start. I have self-proclaimed myself \"image maintainer\", by which I mean \"Come annoy me with your image issues!\".</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>, let me know if you need to share the load. I am happy to help. I am no expert but worked for a few years with it.</p>",
        "id": 463401508,
        "sender_full_name": "Yuri",
        "timestamp": 1724073341
    },
    {
        "content": "<p>I am afraid</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/348111-batteries/topic/Opening.20batteries.20fork.20in.20gitpod/near/462490333\">said</a>:</p>\n<blockquote>\n<p>It requires credentials for the account, so I would prefer to find a maintainer or (official) reviewer to take this.</p>\n</blockquote>\n<p>means I shouldn't share the load, at least for the \"pushing images to Dockerhub\" part</p>",
        "id": 463401803,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724073445
    },
    {
        "content": "<p>I think we can work out a system where the community has a repository for maintaining the docker images and you push images to docker hub. Others make PRs through forks or non-main branches.</p>",
        "id": 463402080,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724073525
    },
    {
        "content": "<p>There should be a CI setup for testing images before pushing them to registries anyway.</p>",
        "id": 463402281,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724073603
    },
    {
        "content": "<p>We're not far off: The repository is <code>mathlib4</code> and people can already open PRs to modify the dockerfiles (eg <a href=\"https://github.com/leanprover-community/mathlib4/pull/15936\">#15936</a>). We just don't have the images themselves and CI to test them</p>",
        "id": 463402482,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724073666
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463402080\">said</a>:</p>\n<blockquote>\n<p>I think we can work out a system where the community has a repository for maintaining the docker images and you push images to docker hub. Others make PRs through forks or non-main branches.</p>\n</blockquote>\n<p>There's really very little to maintain. The Dockerfiles are very small.</p>",
        "id": 463402508,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724073678
    },
    {
        "content": "<p>Yes that I know. There just needs to be a proper CI that tests an image (by maybe doing the following: running the image with mathlib, building mathlib, testing mathlib, deleting the container etc.)</p>",
        "id": 463402692,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724073726
    },
    {
        "content": "<p>Yes, in general maintenance is mostly upkeep with new versions, security updates, etc.</p>",
        "id": 463402694,
        "sender_full_name": "Yuri",
        "timestamp": 1724073728
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"463095\">Yuri de Wit</span> <a href=\"#narrow/stream/113488-general/topic/Dockerhub/near/463402694\">said</a>:</p>\n<blockquote>\n<p>Yes, in general maintenance is mostly upkeep with new versions, security updates, etc.</p>\n</blockquote>\n<p>My point is that this isn't even done on the side of the Docker image. The image only contains a version of elan, not even lean or mathlib. The only dependency that will be frequently updated is leanblueprint.</p>",
        "id": 463402798,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724073773
    },
    {
        "content": "<p>(And that of course should have CI and testing!)</p>",
        "id": 463403179,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724073911
    },
    {
        "content": "<p>As far as I'm concerned, the main priority for now is to republish (versions of) the old images, and to get the new images up so that people can use them. I think that more complicated CI can wait until we're more frequently publishing images and don't want to manually test them.</p>",
        "id": 463404579,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1724074218
    },
    {
        "content": "<p>yes please. This is probably important to get right before someone finds that they are not able to open their old lean3 project.</p>",
        "id": 463404651,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724074235
    },
    {
        "content": "<p>I have now pushed new Lean 3 images to <code>leanprovercommunity/lean</code> and <code>leanprovercommunity/mathlib</code>, and new Lean 4 images to <code>leanprovercommunity/lean4</code>, <code>leanprovercommunity/gitpod4</code>, <code>leanprovercommunity/gitpod4-blueprint</code></p>",
        "id": 463677962,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724155675
    },
    {
        "content": "<p>are the lean4 images with or withuot mathlib?</p>",
        "id": 463702161,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724160324
    },
    {
        "content": "<p>Do we have a blueprint-free mathlib-containing gitpod image?</p>",
        "id": 463702205,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724160348
    },
    {
        "content": "<p>What would \"with mathlib\" mean?</p>",
        "id": 463705196,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724161147
    },
    {
        "content": "<p>Maybe \"with the dependencies needed by <code>polyrith</code>\"?</p>",
        "id": 463705247,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724161161
    },
    {
        "content": "<p>I mean there is pure lean3 image and a lean3 image with mathlib. Similarly there could be a pure lean4 image, a lean4 image with batteries, and a lean4 image with mathlib</p>",
        "id": 463705365,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724161196
    },
    {
        "content": "<p>Appropriately initialising the project folder. The update/build/fetch cache step can safely be run from the gitpod config file</p>",
        "id": 463705565,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724161244
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> : it fails with the error \"leanproject not found\". I'll revert flypitch to the docker image from the file for now. Ref: <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/stream/113488-general/topic/Can.27t.20run.20lean.203.20project\">#general &gt; Can't run lean 3 project</a></p>",
        "id": 464070828,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724249879
    }
]