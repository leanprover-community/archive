[
    {
        "content": "<p>Discussion thread for <a class=\"stream-topic\" data-stream-id=\"113486\" href=\"/#narrow/channel/113486-announce/topic/NodeGraph\">#announce &gt; NodeGraph</a> .</p>",
        "id": 488918521,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1734123022
    },
    {
        "content": "<p>This is cool! I am wondering about the extra <code>doc</code>s in <code>@[node doc]</code> or <code>node doc in ..</code>. Does this run the risk of having documentation which only some tools can display, so wouldn't show up in doc-gen for example? Why not just stick to ordinary docstrings on declarations?</p>",
        "id": 488918608,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1734123073
    },
    {
        "content": "<p>I would be more than happy to get rid of the <code>node doc</code> functionality and rely just on docstrings if we had some way to evaluating strings at elaboration time within the docstring. For example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"world!\"</span>\n\n<span class=\"sd\">/-- Hello {world} -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">helloWorld</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Hello World!\"</span>\n</code></pre></div>\n<p>and have the docstring actually become \"Hello world!\" then that would be more than sufficient for what I am envisioning here.</p>",
        "id": 488932412,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734129526
    },
    {
        "content": "<p>Could you give an example of a situation which benefits from this functionality?</p>",
        "id": 488935617,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734131324
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/113488-general/topic/Discussion.3A.20NodeGraph/near/488935617\">said</a>:</p>\n<blockquote>\n<p>Could you give an example of a situation which benefits from this functionality?</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">include_str</span><span class=\"w\"> </span><span class=\"s2\">\"some_complicated_latex_file.tex\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n</code></pre></div>",
        "id": 488935826,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734131469
    },
    {
        "content": "<p>If I could write </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- {include_str \"thing.tex\"} -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n</code></pre></div>\n<p>that would be perfectly fine as far as I am concerned!</p>",
        "id": 488935877,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734131515
    },
    {
        "content": "<p>(well, the widget, infoview, docgen webpages, etc., all display markdown, so maybe replace <code>.tex</code> with <code>.md</code> in the pseudoexample above)</p>",
        "id": 488936147,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734131663
    },
    {
        "content": "<p>Further on Edward's question, could you give us a more concrete example where you'd need to evaluate in a doc-string?</p>",
        "id": 488982114,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734172262
    },
    {
        "content": "<p>I guess that's a way to report the lean version in the docs...</p>",
        "id": 488985238,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734175176
    },
    {
        "content": "<p>But that seems more like a gimmic than anything</p>",
        "id": 488985316,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734175222
    },
    {
        "content": "<p>I donâ€™t have a concrete example I can share yet. The purpose of this approach of evaluating strings was because I wanted to make it possible for documentation to be written separately from the lean code itself. </p>\n<p>One of the goals of this project is to enable people to write â€œformal blueprintsâ€ by liberally using sorries and axioms in the lean code itself, while also providing extensive markdown/latex documentation for each node (e.g. describing a proof or definition as one would do on paper). If the project that involves people who are not comfortable with lean syntax, then the idea is to enable such people to still make meaningful contributions by writing documentation <em>separately</em>.</p>",
        "id": 488987306,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734177081
    },
    {
        "content": "<p>This vision of â€œformal blueprintsâ€ is also why it may make sense to have some place for node documentation thatâ€™s separate from the declaration documentation. In other words, the usual docstring has its usual purpose while the additional doc can contain additional information, like a natural language proof, which doesnâ€™t necessarily belong in a docstring</p>",
        "id": 488987531,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734177260
    },
    {
        "content": "<p>One situation where I would find it convenient to \"evaluate doc-strings\" is when you want to keep in sync text that is written in the module doc and text that goes as a doc-string: in the module doc you may want to describe something with the text that you would also then want to be the doc-string.</p>",
        "id": 489028695,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734212437
    },
    {
        "content": "<p>I am not sure if you could achieve this with <code>NodeGraph</code> as it currently is, but it may be in scope nonetheless.</p>",
        "id": 489028731,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734212469
    },
    {
        "content": "<p>I've also wanted such docstring interpolation in the past when working with lean-slides. Especially if it supports evaluating meta code it could be a very nice way to write docs that stay up to date automatically by including some type information and usage exampes in the docstring. Maybe this is all obviated by verso but it's a sort of attempt at a light weight version of literate doc writing.</p>",
        "id": 489054256,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1734239187
    },
    {
        "content": "<p>Maybe it would make sense to have an RFC about interpolation in doc-comments. Or perhaps just have <span class=\"user-mention\" data-user-id=\"354934\">@David Thrane Christiansen</span> say something how this would overlap with / relate to things happening in the verso direction.</p>",
        "id": 489067417,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734253192
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/channel/113488-general/topic/Discussion.3A.20NodeGraph/near/488987531\">said</a>:</p>\n<blockquote>\n<p>like a natural language proof, which doesnâ€™t necessarily belong in a docstring</p>\n</blockquote>\n<p>Personally, I'd be happy if we were more enthusiastic about long doc-strings, e.g. including natural language proofs. Hard to maintain a consistent style across a huge library, but it seems like it's hard to go wrong by shifting the norms in favour of more and longer doc-strings!</p>",
        "id": 489067547,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734253283
    },
    {
        "content": "<p>I don't think docstrings are the place for proofs; if I'm autocompleting a lemma name or searching in the docs, I don't care at all how it was proved, only about what it says. If we want to store informal proofs in a machine-accesible way, then I claim they belong as some annotation inside the proof term along the lines of what NodeGraph is doing.</p>",
        "id": 489068424,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734254223
    },
    {
        "content": "<p>In case it's helpful at all for comparison, Python does not allow interpolation in docstrings (f-strings cannot be a docstring) but does allow assigning docstrings dynamically (and has essentially forever, including way before it had interpolating directly into strings). I assume Lean has some equivalent of the latter already (presumably more in the form of evolving a declaration to get a new one rather than mutating the old one.)? Personally I've wanted the former a time or two in 15 years programming but overall I think it's better it doesn't exist as it's somewhat easy to get around via the latter functionality.</p>\n<p>(I also find the long vs. not long bit amusing, people have argued for 10 years about \"hey Sphinx is nice because it lets you move parts of  your super long docstring to a separate file and render it into the docs later, that's great your source code is shorter!\" vs. \"please never use that put your long docstring right where it is, the whole point of a docstring is that it's local to the code it describes so that someone sees it and updates it right when they touch what it has to do with.\" I'm on team B these days, I have very long docstrings in code in many places.)</p>",
        "id": 489072843,
        "sender_full_name": "Julian Berman",
        "timestamp": 1734258820
    },
    {
        "content": "<p>Is there anything stopping mathlib defining a <code>/!-- .* -/ command</code> syntax that just means \"do interpolation in the docstring, then execute the underlying command\"?</p>",
        "id": 489104569,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734286929
    },
    {
        "content": "<p>(obviously this isn't great for consistency of Lean, but for prototyping this seems like it would work)</p>",
        "id": 489104602,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734286970
    },
    {
        "content": "<p>I spent a few minutes trying to figure out how to make such a <code>/!â€” .* -/</code> command while writing NodeGraph but I couldnâ€™t figure out how to get the syntax parser to work.</p>",
        "id": 489111574,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734293757
    },
    {
        "content": "<p>For now, the <code>doc</code> in <code>@[node doc]</code> is completely optional so Iâ€™m inclined to leave things as they are in that regard</p>",
        "id": 489111645,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734293811
    },
    {
        "content": "<p>The medium term plan is to transition to using Verso in docstrings, which makes them less and less like strings! This will be a slow transition, discussed in advance with the community to make sure you don't get stuck.</p>\n<p>This would make docstring interpolation be a quick library. Here's the pseudocode I imagine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">docstring_role</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">interpolate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RoleExpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inlines</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">noArgs</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"c1\">-- Don't accept any arguments!</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">inlines.size</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">inlines</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">inline</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"n\">code</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">evaluation</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">inlines</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"Expected inline code\"</span>\n</code></pre></div>\n<p>Then you could write</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">2 + 2 = {interpolate}`2 + 2`</span>\n<span class=\"sd\">-/</span>\n<span class=\"kd\">theorem</span><span class=\"w\"> </span><span class=\"n\">two_plus_two_eq_four</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>Would that meet your needs, assuming the documentation for writing macros like this was good?</p>",
        "id": 489259594,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1734361296
    },
    {
        "content": "<p>That sounds really great! It would certainly be more than sufficient for things like NodeGraph (although given the discussion above, it may make sense to keep the option for <code>doc</code> in <code>node doc</code>). Looking forward to seeing this in action :)</p>",
        "id": 489292454,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734369091
    },
    {
        "content": "<p>Does this mean in the long run that all the <code>docstrings with $\\LaTeX$.</code> have to be replaced with <code>docstrings with $`\\LaTeX`.</code>?</p>",
        "id": 489294541,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734369667
    },
    {
        "content": "<p>I'd say the answer is \"probably, but only gradually and with tool support, and if it's a big problem, let's talk about it\". I don't have a complete design worked out in detail yet, but I certainly wouldn't want anything where the migration path for the syntax of docs wasn't \"set the option, click the code action\" at worst</p>",
        "id": 489324616,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1734377582
    },
    {
        "content": "<p>The advantage of piggybacking on code element syntax here is that we don't end up trying to parse LaTeX, which is a huge development time tarpit - we have a parser for code elements, and it works the same here, and we don't have to worry about precise escaping rules for dollar signs in math.</p>",
        "id": 489325304,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1734377797
    },
    {
        "content": "<p>Don't worry - I won't inflict anything on you without first finding out the real costs and benefits and doing my best to minimize the former</p>",
        "id": 489327498,
        "sender_full_name": "David Thrane Christiansen",
        "timestamp": 1734378469
    },
    {
        "content": "<p>Docutils use <code>:math:`x^2` </code></p>",
        "id": 490058758,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734646989
    },
    {
        "content": "<p>I'm necroposting, but this made me think of Rust doc strings, which can include example usage code that actually gets executed as a test during compilation <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span> if there's an RFC for interpolation in docstrings, maybe we can get inspiration from Rust's implementation.</p>",
        "id": 496848589,
        "sender_full_name": "James Gallicchio",
        "timestamp": 1738263967
    }
]