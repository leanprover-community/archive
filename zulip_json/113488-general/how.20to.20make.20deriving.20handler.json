[
    {
        "content": "<p>I want to understand how to make deriving handler, so I want to create a very simple toy example.</p>\n<p>How to resolve this error?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">ToUnit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toUnit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToUnit</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toUnit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"n\">ToUnit</span><span class=\"bp\">.</span><span class=\"n\">toUnit</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">deriveToUnitInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">declNames</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">declNames</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToUnit</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">Application type mismatch: The argument</span>\n<span class=\"cm\">  `Foo</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  Name</span>\n<span class=\"cm\">of sort `Type` but is expected to have type</span>\n<span class=\"cm\">  Type ?u.1135</span>\n<span class=\"cm\">of sort `Type (?u.1135 + 1)` in the application</span>\n<span class=\"cm\">  ToUnit `Foo</span>\n<span class=\"cm\">-/</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"n\">deriveToUnitInstance</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`Foo</span><span class=\"o\">]</span>\n\n<span class=\"n\">initialize</span>\n<span class=\"w\">  </span><span class=\"n\">registerDerivingHandler</span><span class=\"w\"> </span><span class=\"ss\">``ToUnit</span><span class=\"w\"> </span><span class=\"n\">deriveToUnitInstance</span>\n</code></pre></div>",
        "id": 544995934,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1760541303
    },
    {
        "content": "<p>Replace <code>quote (k := `term)</code> with <code>mkCIdent</code></p>",
        "id": 544997590,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760541752
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> Thank you!!!!!!</p>",
        "id": 544997909,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1760541836
    },
    {
        "content": "<p><code>quote x</code> is meant to create a term that evaluates to <code>x</code></p>",
        "id": 544997929,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760541841
    },
    {
        "content": "<p><code>mkCIdent nm</code> instead creates an identifier term that resolves to the global declaration <code>nm</code></p>",
        "id": 544998056,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760541875
    },
    {
        "content": "<p><code>mkIdent nm</code> just creates an identifier which will go through namespace resolution</p>",
        "id": 544998163,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760541901
    }
]