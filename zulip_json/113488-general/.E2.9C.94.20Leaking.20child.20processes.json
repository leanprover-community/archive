[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mi\">100</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">spawn</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"echo\"</span>\n<span class=\"w\">      </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"Hello,\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"world!\"</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">      </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">      </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"s2\">\"press enter to continue\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- At this point, if you do `ps aux|grep echo`, you'll see the processes are</span>\n<span class=\"w\">  </span><span class=\"c1\">-- all still active.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Is this expected? I would have hoped that they would be automatically cleaned up</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n</code></pre></div>\n<p>You instead have to explicitly wait on them:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mi\">100</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">child</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">spawn</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"echo\"</span>\n<span class=\"w\">      </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"Hello,\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"world!\"</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">      </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">      </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">null</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">child</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"s2\">\"press enter to continue\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"s2\">\"waiting on children\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">child</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">child</span><span class=\"bp\">.</span><span class=\"n\">wait</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Now they're gone</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"s2\">\"done\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"s2\">\"press enter to continue\"</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n</code></pre></div>",
        "id": 455585449,
        "sender_full_name": "James Sully",
        "timestamp": 1722500498
    },
    {
        "content": "<p>Yes, that is how UNIX works. What you are seeing is a phenomenon known as zombie processes. A process remains in the process table until its parent ends up calling wait on it. The deallocator for <code>IO.Process</code> does not do this on purpose because just blindly calling <code>wait</code> is a bad idea, mostly due to the same reasons that blindly calling <code>close</code> on a socket is a bad idea. We could introduce a similar mechanism to <code>Socket.lean</code>'s \"closed\" flag to <code>IO.Process</code> to fix this but the current API is basically \"what a C programmer would expect\"</p>",
        "id": 455595854,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722503277
    },
    {
        "content": "<p>Oh also, blindly calling wait on a process once we wish to deallocate would of course block so it's a doubly bad idea if the process is not in fact already dead.</p>",
        "id": 455597080,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722503742
    },
    {
        "content": "<p>makes sense, thanks.</p>",
        "id": 455598932,
        "sender_full_name": "James Sully",
        "timestamp": 1722504327
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"621161\">James Sully</span> has marked this topic as resolved.</p>",
        "id": 455599007,
        "sender_full_name": "Notification Bot",
        "timestamp": 1722504355
    }
]