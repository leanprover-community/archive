[
    {
        "content": "<p>In a file that I prepared for teaching, I had annotated some <code>variable</code>s.  I then used <code>#where</code> and the comments were more noise than helpful.  Should they be excluded?  Below is an example.</p>",
        "id": 479663608,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730288522
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Where</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"c1\">-- Do you want to see me?</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"c1\">-- No one sees me</span>\n\n<span class=\"c1\">-- Let `G` be a (multiplicative) group and let `g, h` be elements of `G`</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- good, we can multiply elements of a group</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: variable</span>\n<span class=\"sd\">  (a : Nat)</span>\n<span class=\"sd\">    -- Do you want to see me?</span>\n<span class=\"sd\">  (b : Nat)</span>\n<span class=\"sd\">    -- No one sees me</span>\n<span class=\"sd\">    ⏎</span>\n<span class=\"sd\">    -- Let `G` be a (multiplicative) group and let `g, h` be elements of `G`</span>\n<span class=\"sd\">  {G : Type} [Mul G]</span>\n<span class=\"sd\">  {g h : G}</span>\n<span class=\"sd\">    -- good, we can multiply elements of a group</span>\n<span class=\"sd\">  (a b c : G)</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"kn\">where</span>\n</code></pre></div>",
        "id": 479663633,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730288526
    },
    {
        "content": "<p>I was expecting to see</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>or some reformatting of what is above.</p>",
        "id": 479664068,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730288704
    },
    {
        "content": "<p>Yes I've noticed this too and I agree that it's quite annoying! I've just been living with it so far.</p>",
        "id": 479664288,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1730288793
    },
    {
        "content": "<p>The fix should not be too hard: each syntax node includes all garbage between where it \"seems\" to end and the beginning of the next command.  It should be relatively easy to purge all trailing comments from <code>variable</code> commands, although I did not try it out specifically.</p>",
        "id": 479665049,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730289080
    },
    {
        "content": "<p>It's certainly low priority but if you could fix it I'd be very grateful! I write lots of comments when teaching or live streaming and this is why I ran into it. The first time it happened I was very confused :-) I don't think it happened in lean 3.</p>",
        "id": 479665673,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1730289321
    },
    {
        "content": "<p>OK, I'll see if the easy fix that I have in mind works and, if so, I'll PR it.</p>",
        "id": 479666173,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730289498
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/1019\">batteries#1019</a></p>",
        "id": 479692323,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730297752
    },
    {
        "content": "<p>I don't know if this is desirable, but it was easy enough to write the PR!</p>",
        "id": 479692433,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730297775
    },
    {
        "content": "<p>With the <code>#where</code> from the PR, the above code would show</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- info: variable (a : Nat) (b : Nat) {G : Type} [Mul G] {g h : G} (a b c : G) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"kn\">where</span>\n</code></pre></div>",
        "id": 479692688,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730297862
    },
    {
        "content": "<p>Kevin (or anyone else who wants to test the new <code>variable</code>-handling of <code>#where</code>), if you paste</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#where1\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getScope</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Variables</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">scope</span><span class=\"bp\">.</span><span class=\"n\">varDecls</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"bp\">.</span><span class=\"n\">varDecls</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨.</span><span class=\"n\">unsetTrailing</span><span class=\"w\"> </span><span class=\"bp\">·⟩</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">vars</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">m!</span><span class=\"s2\">\"-- In root namespace with initial scope\"</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{MessageData.joinSep msg.toList \"</span><span class=\"bp\">\\</span><span class=\"n\">n</span><span class=\"bp\">\\</span><span class=\"n\">n</span><span class=\"s2\">\"}\"</span>\n</code></pre></div>\n<p>in your file, you will have a crippled version of <code>#where</code>, called <code>#where1</code>, that prints just the <code>variable</code>s in scope, with the new format.  This should give you an idea of how the change will affect comments.</p>",
        "id": 479695367,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730298620
    },
    {
        "content": "<p>Thanks Damiano! I will also surely use this <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 479706502,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1730301582
    },
    {
        "content": "<p>It turns out <a href=\"https://github.com/leanprover/lean4/pull/5065\">lean4#5065</a> made it in for the next release, which should come out by next week. Damiano's fix made it in too.</p>",
        "id": 479742919,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730313398
    },
    {
        "content": "<p>Great!  I'll close my PR, then!</p>",
        "id": 479752379,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730317229
    },
    {
        "content": "<p>Will this also fix the annoying tendency of \"simp?\" to scramble up any comment text immediately following the simp call?</p>",
        "id": 479884846,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730383249
    },
    {
        "content": "<p>I don't this so, since this fix was <code>#where</code> specific, but... what <code>simp</code>-scrambling are you referring to?</p>",
        "id": 479885284,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730383354
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113488-general/topic/.60.23where.60.20and.20comments/near/479885284\">said</a>:</p>\n<blockquote>\n<p>what <code>simp</code>-scrambling are you referring to?</p>\n</blockquote>\n<p>See <a href=\"https://github.com/leanprover/lean4/pull/4581\">lean4#4581</a></p>",
        "id": 479885497,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1730383409
    },
    {
        "content": "<p>Oh, I see.  It looks like the same root cause: <code>Syntax</code> nodes extend until the next available command/node, so \"<code>unsetTrailing</code>\" the <code>simp</code> node would probably fix this as well.</p>",
        "id": 479885879,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730383502
    },
    {
        "content": "<p>Yes, I meant the issue <span class=\"user-mention\" data-user-id=\"260921\">@Markus Himmel</span> refers to. I'm guessing it is another manifestation of what you wrote,</p>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113488-general/topic/.60.23where.60.20and.20comments/near/479665049\">said</a>:</p>\n<blockquote>\n<p>each syntax node includes all garbage between where it \"seems\" to end and the beginning of the next command.</p>\n</blockquote>",
        "id": 479886037,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730383520
    },
    {
        "content": "<p>In particular, all \"free text\" appearing in comments \"after\" a syntax node, is actually not really \"after\", but \"trailing\".</p>",
        "id": 479886134,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730383543
    },
    {
        "content": "<p>This is harder to test, since changing a core tactic is harder than changing a batteries command, but I think that on <a href=\"https://github.com/leanprover/lean4/blob/01d414ac36dc28f3e424dabd36d818873fea655c/src/Init/Tactics.lean#L630-L630\">this line</a>, if you used <code>rest.unsetTrailing</code>, rather than <code>rest</code>, it may fix the issue.</p>",
        "id": 479887817,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730384022
    },
    {
        "content": "<p>It would have to happen also in the other variants of <code>simp?</code> and I am not sure how it would affect the code action...</p>",
        "id": 479887912,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730384046
    },
    {
        "content": "<p>In general, however, I think that humans are more likely to associate a comment with something that follows the comment, while in lean the comment is part of the previous syntax node, which can sometimes lead to surprising behaviour.</p>",
        "id": 479888171,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730384134
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5907\">lean4#5907</a> has a fix for <code>simpa?</code>. I'm a bit puzzled why using <code>unsetTrailing</code> on the syntax passed to <code>TryThis.addSuggestion</code> didn't work on its own and I had to <code>unsetTrailing</code> the <code>using</code> clause.</p>",
        "id": 479946233,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730402720
    },
    {
        "content": "<p>I couldn't reproduce any comment scrambling for <code>simp?</code> <span class=\"user-mention\" data-user-id=\"481963\">@David Loeffler</span></p>",
        "id": 479946325,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730402762
    },
    {
        "content": "<p>Wow, thanks for the quick fix! Probably I had just mixed up <code>simp</code> and <code>simpa</code>.</p>",
        "id": 479947563,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730403258
    }
]