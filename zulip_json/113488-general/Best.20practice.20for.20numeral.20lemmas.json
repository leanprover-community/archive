[
    {
        "content": "<p>It used to be the case that numerals in Lean went 0, 1, bigger. That meant that, whenever proving a lemma involving a natural number <code>n : ℕ</code> coerced to eg a ring, one would need to prove three additional lemmas: one for <code>0</code>, one for <code>1</code>, one for <code>ofNat(n)</code> where <code>(n : ℕ) [n.AtLeastTwo]</code>. But as of recently, it seems that all three cases can be dealt at once with the new <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Semiring.toGrindSemiring_ofNat#doc\">docs#Semiring.toGrindSemiring_ofNat</a> instance. Is this intended?</p>",
        "id": 544186912,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1760107455
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/113488-general/topic/Best.20practice.20for.20numeral.20lemmas/near/544186912\">said</a>:</p>\n<blockquote>\n<p>all three cases can be dealt at once</p>\n</blockquote>\n<p>but <code>grind</code> is not the universal tactic</p>",
        "id": 544187915,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760107742
    },
    {
        "content": "<p>What? This has nothing to do with grind; I am talking about rewriting tactics. Consider:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"c1\">-- This lemma used not to be stateable because of the lack</span>\n<span class=\"c1\">-- of a \"generic\" `ofNat` instance.</span>\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo_ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">-- These used to be the three cases one would need to prove.</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">AtLeastTwo</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">ofNat</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>",
        "id": 544189003,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1760108063
    },
    {
        "content": "<p>interesting, I just thought this is grind because the name contains grind</p>",
        "id": 544189167,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760108106
    },
    {
        "content": "<p>The instance was introduced to be used in grind internals, correct, but the connection stops there.</p>",
        "id": 544189443,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1760108190
    },
    {
        "content": "<p>The instance was introduced by <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> , see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Semiring.toGrindSemiring#doc\">docs#Semiring.toGrindSemiring</a>, to make <code>grind</code> work with Mathlib's (semi)rings.</p>",
        "id": 544193406,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760109221
    },
    {
        "content": "<p>I see 2 ways to go forward with it in a consistent way:</p>\n<ul>\n<li>introduce an instance for <code>OfNat</code> assuming <code>[NatCast R]</code>; we have it for semirings anyway.</li>\n<li>restrict the <code>grind</code>-related instances (incl. <code>GrindSemiring</code> -&gt; <code>OfNat</code>) to some scope and make <code>grind</code> open this scope.</li>\n</ul>",
        "id": 544194129,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760109396
    },
    {
        "content": "<p>Maybe we should bundle an <code>ofNat</code> field into <code>AddMonoidWithOne</code></p>",
        "id": 544213587,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760115446
    },
    {
        "content": "<p>I see no reason to have both <code>NatCast R</code> and <code>\\forall n, OfNat R n</code>.</p>",
        "id": 544226622,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760120920
    },
    {
        "content": "<p>It's to fix definitional equalities</p>",
        "id": 544229265,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760122171
    },
    {
        "content": "<p>since we have a <code>Zero R</code> which gives <code>OfNat R 0</code> and we have a <code>One R</code> which gives <code>OfNat R 1</code> and of course we want the <code>NatCast R</code> to be something as well</p>",
        "id": 544229498,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760122279
    },
    {
        "content": "<p>I see not issues with <code>OfNat</code> being <code>| 0 =&gt; 0 | 1 =&gt; 1 | n + 2 =&gt; Nat.cast (n + 2)</code>. It isn't defeq to <code>Nat.cast n</code> for a generic <code>n</code>, but it is defeq for any specific <code>n</code>.</p>",
        "id": 544229683,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760122362
    },
    {
        "content": "<p>(that's what the <code>grind</code> instance uses)</p>",
        "id": 544229706,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760122373
    },
    {
        "content": "<p>not defeq to the ofnat nat instance</p>",
        "id": 544229851,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760122427
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instOfNatNat#doc\">docs#instOfNatNat</a></p>",
        "id": 544229883,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760122438
    },
    {
        "content": "<p>for generic <code>n</code></p>",
        "id": 544229943,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760122462
    },
    {
        "content": "<p>It is for any specific number.</p>",
        "id": 544229952,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760122466
    },
    {
        "content": "<p>for specific <code>n</code> it is defeq I guess</p>",
        "id": 544229977,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760122477
    },
    {
        "content": "<p>CC: <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span></p>",
        "id": 544230056,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760122510
    },
    {
        "content": "<p>Doesn't this match mean that <code>[n.AtLeastTwo] : (ofNat(n) : R) = Nat.cast ofNat(n)</code> is no longer rfl?</p>",
        "id": 544252253,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760132688
    },
    {
        "content": "<p>were we ever worried about <code>OfNat.ofNat</code> being defeq to <code>Nat.cast</code></p>",
        "id": 544253210,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760133168
    },
    {
        "content": "<p>We certainly cared about the special case  <code>(Nat.cast 0 : Fin n) = 0</code> in the past</p>",
        "id": 544253366,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760133230
    },
    {
        "content": "<p>I think in the end we might have redefined <code>%</code> to make that true</p>",
        "id": 544253392,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760133244
    },
    {
        "content": "<p>I'm still a bit annoyed at <code>Nat.ble 0 x = true</code> is not defeq</p>",
        "id": 544255521,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760134273
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/Best.20practice.20for.20numeral.20lemmas/near/544252253\">said</a>:</p>\n<blockquote>\n<p>Doesn't this match mean that <code>[n.AtLeastTwo] : (ofNat(n) : R) = Nat.cast ofNat(n)</code> is no longer rfl?</p>\n</blockquote>\n<p>It will be <code>rfl</code> for all literal <code>n</code>s, but not for a generic <code>n</code>.</p>",
        "id": 544269255,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760142883
    },
    {
        "content": "<p>This will change some proofs about <code>OfNat.ofNat</code> that rely on defeq.</p>",
        "id": 544269289,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760142908
    },
    {
        "content": "<p>It seems slightly silly for the above not to hold for generic n even when <code>R := Nat</code></p>",
        "id": 544293322,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760163998
    }
]