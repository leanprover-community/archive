[
    {
        "content": "<p>My simple (initially copied from <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> from Lean Repl) is broken in both v4.20.1 and v4.20.0 though it works in v4.15.0 (in between not tested as this is part of a largish codebase). Imports don't seem to be picked up and there are some other errors:</p>\n<p>I have minimised the relevant code to 2 files. The one implementing the REPL is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">LeanAide</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">simpleRunFrontend</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{})</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">MessageLog</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">fileName</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">commandState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">mkState</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModuleParserState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">processCommands</span><span class=\"w\"> </span><span class=\"n\">inputCtx</span><span class=\"w\"> </span><span class=\"n\">parserState</span><span class=\"w\"> </span><span class=\"n\">commandState</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">commandState</span><span class=\"bp\">.</span><span class=\"n\">env</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">commandState</span><span class=\"bp\">.</span><span class=\"n\">messages</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and an exectuable calling this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">LeanAide</span><span class=\"bp\">.</span><span class=\"n\">SimpleFrontend</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">LeanAide</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">enableInitializersExecution</span>\n<span class=\"w\">  </span><span class=\"n\">withImportModules</span><span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">importAll</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"example : ‚àÄ (G : Type) [Group G], ‚àÄ a b : G, a * b = b * a := by sorry\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">text</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">logs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">simpleRunFrontend</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"s2\">\"Ran dummy example to load Mathlib\"</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">logs</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{‚Üê  log.toString}\"</span>\n</code></pre></div>\n<p>The results I get (everything is fine in the older version):</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>check_command\n‚Ñπ<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">6783</span>/6786<span class=\"o\">]</span><span class=\"w\"> </span>Replayed<span class=\"w\"> </span>LeanAide.SimpleFrontend\ninfo:<span class=\"w\"> </span>/home/gadgil/dev/LeanAide/LeanAide/SimpleFrontend.lean:132:0:<span class=\"w\"> </span>Lean.Elab.runFrontend<span class=\"w\"> </span><span class=\"o\">(</span>input<span class=\"w\"> </span>:<span class=\"w\"> </span>String<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>opts<span class=\"w\"> </span>:<span class=\"w\"> </span>Options<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>fileName<span class=\"w\"> </span>:<span class=\"w\"> </span>String<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>mainModuleName<span class=\"w\"> </span>:<span class=\"w\"> </span>Name<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span>trustLevel<span class=\"w\"> </span>:<span class=\"w\"> </span>UInt32<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>oleanFileName?<span class=\"w\"> </span>ileanFileName?<span class=\"w\"> </span>:<span class=\"w\"> </span>Option<span class=\"w\"> </span>String<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span>none<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>jsonOutput<span class=\"w\"> </span>:<span class=\"w\"> </span>Bool<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span>errorOnKinds<span class=\"w\"> </span>:<span class=\"w\"> </span>Array<span class=\"w\"> </span>Name<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"c1\">#[]) (plugins : Array System.FilePath := #[]) (printStats : Bool := false) :</span>\n<span class=\"w\">  </span>IO<span class=\"w\"> </span><span class=\"o\">(</span>Option<span class=\"w\"> </span>Environment<span class=\"o\">)</span>\nRan<span class=\"w\"> </span>dummy<span class=\"w\"> </span>example<span class=\"w\"> </span>to<span class=\"w\"> </span>load<span class=\"w\"> </span>Mathlib\n&lt;input&gt;:1:46:<span class=\"w\"> </span>error:<span class=\"w\"> </span>unexpected<span class=\"w\"> </span>token<span class=\"w\"> </span><span class=\"s1\">'*'</span><span class=\"p\">;</span><span class=\"w\"> </span>expected<span class=\"w\"> </span><span class=\"s1\">':='</span>,<span class=\"w\"> </span><span class=\"s1\">'where'</span><span class=\"w\"> </span>or<span class=\"w\"> </span><span class=\"s1\">'|'</span>\n\n&lt;input&gt;:1:24:<span class=\"w\"> </span>error:<span class=\"w\"> </span>invalid<span class=\"w\"> </span>binder<span class=\"w\"> </span>annotation,<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>is<span class=\"w\"> </span>not<span class=\"w\"> </span>a<span class=\"w\"> </span>class<span class=\"w\"> </span>instance\n<span class=\"w\">  </span>Group<span class=\"w\"> </span>G\nuse<span class=\"w\"> </span>the<span class=\"w\"> </span><span class=\"nb\">command</span><span class=\"w\"> </span><span class=\"sb\">`</span>set_option<span class=\"w\"> </span>checkBinderAnnotations<span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"sb\">`</span><span class=\"w\"> </span>to<span class=\"w\"> </span>disable<span class=\"w\"> </span>the<span class=\"w\"> </span>check\n</code></pre></div>\n<p>and </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>check_command<span class=\"w\"> </span><span class=\"s2\">\"theorem silly : (1 : Nat) = 1 := by sorry\"</span>\n‚Ñπ<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">6783</span>/6786<span class=\"o\">]</span><span class=\"w\"> </span>Replayed<span class=\"w\"> </span>LeanAide.SimpleFrontend\ninfo:<span class=\"w\"> </span>/home/gadgil/dev/LeanAide/LeanAide/SimpleFrontend.lean:132:0:<span class=\"w\"> </span>Lean.Elab.runFrontend<span class=\"w\"> </span><span class=\"o\">(</span>input<span class=\"w\"> </span>:<span class=\"w\"> </span>String<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>opts<span class=\"w\"> </span>:<span class=\"w\"> </span>Options<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>fileName<span class=\"w\"> </span>:<span class=\"w\"> </span>String<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>mainModuleName<span class=\"w\"> </span>:<span class=\"w\"> </span>Name<span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span>trustLevel<span class=\"w\"> </span>:<span class=\"w\"> </span>UInt32<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>oleanFileName?<span class=\"w\"> </span>ileanFileName?<span class=\"w\"> </span>:<span class=\"w\"> </span>Option<span class=\"w\"> </span>String<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span>none<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span>jsonOutput<span class=\"w\"> </span>:<span class=\"w\"> </span>Bool<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span>errorOnKinds<span class=\"w\"> </span>:<span class=\"w\"> </span>Array<span class=\"w\"> </span>Name<span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"c1\">#[]) (plugins : Array System.FilePath := #[]) (printStats : Bool := false) :</span>\n<span class=\"w\">  </span>IO<span class=\"w\"> </span><span class=\"o\">(</span>Option<span class=\"w\"> </span>Environment<span class=\"o\">)</span>\nRan<span class=\"w\"> </span>dummy<span class=\"w\"> </span>example<span class=\"w\"> </span>to<span class=\"w\"> </span>load<span class=\"w\"> </span>Mathlib\n&lt;input&gt;:1:26:<span class=\"w\"> </span>error:<span class=\"w\"> </span>expected<span class=\"w\"> </span>token\n\n&lt;input&gt;:1:17:<span class=\"w\"> </span>error:<span class=\"w\"> </span><span class=\"nb\">type</span><span class=\"w\"> </span>class<span class=\"w\"> </span>instance<span class=\"w\"> </span>expected\n<span class=\"w\">  </span>OfNat<span class=\"w\"> </span>Nat<span class=\"w\"> </span><span class=\"m\">1</span>\n</code></pre></div>\n<p>Any help is appreciated. In the longer run, it is probably best I add lean-repl as a dependency and use the frontend there instead of copying, but I would like to understand what is happening (and am reporting in case this is not desired behaviour for Lean).</p>",
        "id": 522486634,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1749091347
    },
    {
        "content": "<p>See <a class=\"message-link\" href=\"/#narrow/channel/113488-general/topic/modifyEnv.20and.20environment.20extensions.20.20in.20v4.2E19.2E0/near/516461387\">#general &gt; modifyEnv and environment extensions  in v4.19.0 @ üí¨</a></p>",
        "id": 522523927,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1749110072
    },
    {
        "content": "<p>Thanks a lot. The issue is fixed.</p>",
        "id": 522529739,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1749111832
    }
]