[
    {
        "content": "<p>The three ways I know to use <code>native_decide</code> to prove <code>False</code> are to:</p>\n<ul>\n<li><a href=\"#narrow/channel/113489-new-members/topic/Nat.2Eble.20.3F.3F.3F/near/482553326\">Find a compiler bug</a></li>\n<li>Sneak in axioms (<a href=\"#narrow/channel/270676-lean4/topic/Axioms.20used.20by.20csimp.20are.20not.20reported/near/505140945\">using <code>@csimp</code></a>, <a href=\"#narrow/channel/113488-general/topic/Cardinality.20model.20incompatible.20with.20Lean.20compiler/near/501673961\">using <code>cast</code></a>)</li>\n<li><a href=\"#narrow/channel/113489-new-members/topic/Nat.2Eble.20.3F.3F.3F/near/482599528\">Use<code> implemented_by</code></a></li>\n</ul>\n<p>Are there others, especially ones which currently work but don't involve making new axioms or new <code>implemented_by</code>s?</p>",
        "id": 516670187,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746622992
    },
    {
        "content": "<p>There's also <a href=\"https://github.com/leanprover/lean4/issues/7463\">https://github.com/leanprover/lean4/issues/7463</a>, which is somewhat a mix of your two and three</p>",
        "id": 516689972,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746627717
    },
    {
        "content": "<p>Well <code>@[extern]</code>, but that fits in the same realm as <code>@[implemented_by]</code>. Otherwise I'd argue that the definition of a compiler bug <em>is</em> that it allows you to prove <code>False</code> using <code>native_decide</code> under otherwise sound conditions.</p>",
        "id": 516693858,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746628489
    },
    {
        "content": "<p>Oh and well ways to prove <code>False</code> without <code>native_decide</code> (e.g. <code>skipKernelTC</code>) are naturally also ways to let <code>native_decide</code> prove <code>False</code></p>",
        "id": 516693980,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746628522
    },
    {
        "content": "<p>Example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"bp\">.</span><span class=\"n\">skipKernelTC</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">hiThere</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">myFalse</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">hiThere</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">instHAdd</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">  </span><span class=\"n\">contradiction</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">dvd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚à£</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myFalse</span><span class=\"bp\">.</span><span class=\"n\">elim</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">divExact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">dvd</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">divExact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">dvd</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">native_decide</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n<span class=\"w\">  </span><span class=\"n\">contradiction</span>\n</code></pre></div>",
        "id": 516695356,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746628838
    },
    {
        "content": "<p>although I guess that doesn't really count because you already have <code>False</code> without it</p>",
        "id": 516695510,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746628870
    },
    {
        "content": "<p>There's also examples like this one: <a href=\"https://live.lean-lang.org/#project=mathlib-stable&amp;codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOJgCmAdnAAoToCexEIwS6etxAxnWAK4xJbqFwAJoQBmcAOZwAFKQBccAHIoAlHHlL4sgLzSAGnAB6cOXEC4hAG1dAXWUA6YigAihcVEKEcaQtEIg4IKgB9ND95SQAGQzgAJjhAAyI4SO04LCohQlZgYTgAagBrQihiQiYvHz8AZ1QIAHdAkUYKgXkAMUbmnQDg1D8pVLgoGrhzcSsAbjgK0DBlIA\">https://live.lean-lang.org/#project=mathlib-stable&amp;codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOJgCmAdnAAoToCexEIwS6etxAxnWAK4xJbqFwAJoQBmcAOZwAFKQBccAHIoAlHHlL4sgLzSAGnAB6cOXEC4hAG1dAXWUA6YigAihcVEKEcaQtEIg4IKgB9ND95SQAGQzgAJjhAAyI4SO04LCohQlZgYTgAagBrQihiQiYvHz8AZ1QIAHdAkUYKgXkAMUbmnQDg1D8pVLgoGrhzcSsAbjgK0DBlIA</a>, which are fixed by <a href=\"https://github.com/leanprover/lean4/pull/8060\">lean4#8060</a> where <code>native_decide</code> isn't used. (This example is deliberately non-minimal and uses mathlib, more elementary ones are available!)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">my_thm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">kernel</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">show_false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">my_thm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">g</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 516698050,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746629434
    },
    {
        "content": "<p>Yeah, right, soundness problems count there too (hope that we don't have any more of those...)</p>",
        "id": 516700539,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746629964
    },
    {
        "content": "<p>Oh wait I forgot one: <code>IO</code> (although <code>@[export]</code> is the core reason still):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">addHeartbeats</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getNumHeartbeats</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">val</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">compareHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compareHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">native_decide</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">compareHeartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n</code></pre></div>",
        "id": 516913081,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746715285
    },
    {
        "content": "<p>That's just because <code>IO.RealWorld := Unit</code>... (I am pretty sure there are more states of the real world than one)</p>",
        "id": 516914936,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746715754
    },
    {
        "content": "<p>Why can you use <code>IO</code> operations to get back to a pure function?</p>",
        "id": 516919863,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746717043
    },
    {
        "content": "<p>Also, shouldn't <code>IO.RealWorld</code> be opaque?</p>",
        "id": 516920247,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746717145
    },
    {
        "content": "<p>That might be a compiler thing I'm not sure. At least the intention of making it opaque is stated:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\"> Like &lt;https://hackage.haskell.org/package/ghc-Prim-0.5.2.0/docs/GHC-Prim.html#t:RealWorld&gt;.</span>\n<span class=\"cm\">   Makes sure we never reorder `IO` operations.</span>\n\n<span class=\"cm\">   TODO: mark opaque -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n</code></pre></div>",
        "id": 516923594,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746718038
    },
    {
        "content": "<p>This one I find the most interesting so far because it can be inlined into a single tactic proof using only the usual tactics:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">addHeartbeats</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getNumHeartbeats</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">val</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">compareHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compareHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">native_decide</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">compareHeartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n</code></pre></div>",
        "id": 517000040,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746749667
    },
    {
        "content": "<p>By the way, should we file an issue about this last one?  It might be intentional, but it sure feels like a compiler bug.</p>",
        "id": 517209969,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746840354
    },
    {
        "content": "<p>(By \"compiler bug\", I guess I mean mismatches between pure code and their external implementations in core Lean.)</p>",
        "id": 517210115,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746840436
    },
    {
        "content": "<p>Would making IO.RealWorld opaque fix this issue?</p>",
        "id": 517210895,
        "sender_full_name": "Niels Voss",
        "timestamp": 1746841039
    },
    {
        "content": "<p>I think yes, unless we can make the above work without the <code>()</code></p>",
        "id": 517211516,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746841570
    },
    {
        "content": "<p>(I checked, you can't because <code>native_decide</code> won't operate on free variables)</p>",
        "id": 517212446,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746842380
    },
    {
        "content": "<p>A golfed version of the above:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\">  </span><span class=\"c1\">-- ensure `x` is not eliminated</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getNumHeartbeats</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"w\">    </span><span class=\"n\">val</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">native_decide</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">getHeartbeats</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n</code></pre></div>",
        "id": 517212763,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746842618
    },
    {
        "content": "<p>this seems a bit better than the random number version of this exploit I wrote a while back since that one only fails with 1/4 probability</p>",
        "id": 517231555,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746860001
    },
    {
        "content": "<p>but it was added to the lean4checker test suite so you could add this one too</p>",
        "id": 517231572,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746860028
    },
    {
        "content": "<p>I can‚Äôt find the random number exploit on the lean4checker GitHub repo.  Do you have a link?</p>",
        "id": 517254020,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746879565
    },
    {
        "content": "<p>Ok, I found the topic: <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/soundness.20bug.3A.20native_decide.20leakage/with/395967589\">#lean4 &gt; soundness bug: native_decide leakage</a></p>",
        "id": 517256142,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746881498
    },
    {
        "content": "<p>The example uses <code>Lean.reduceBool</code> (which again is a good reminder for those writing ad-hoc checks against this sort or thing that banning particular tactics, with say a regex, is not the right way to go <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> ).</p>",
        "id": 517256322,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746881644
    },
    {
        "content": "<p>And here is the corresponding test in Lean4Checker: <a href=\"https://github.com/leanprover/lean4checker/blob/master/Lean4CheckerTests/ReduceBool.lean\">https://github.com/leanprover/lean4checker/blob/master/Lean4CheckerTests/ReduceBool.lean</a></p>",
        "id": 517256501,
        "sender_full_name": "Jason Rute",
        "timestamp": 1746881819
    },
    {
        "content": "<p>I just checked on the latest nightly and I think the above exploit using <code>getHeartbeats</code> is patched.</p>",
        "id": 531825534,
        "sender_full_name": "Jason Rute",
        "timestamp": 1753877163
    },
    {
        "content": "<p>It's not, the compiler just got better at inlining. My version above still works</p>",
        "id": 531827136,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753877642
    },
    {
        "content": "<p>Ok, here is Mario's golfed version, but with a dummy parameter <code>y</code> to prevent inlining:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"c1\">-- parameter `y` prevents inlining</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\">  </span><span class=\"c1\">-- ensure `x` is not eliminated</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getNumHeartbeats</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"w\">    </span><span class=\"n\">val</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">native_decide</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">getHeartbeats</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n</code></pre></div>",
        "id": 531833328,
        "sender_full_name": "Jason Rute",
        "timestamp": 1753879368
    },
    {
        "content": "<p>Here is even a simpler example.  You don't need to use the input at all (although maybe this could get inlined away in the future).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getNumHeartbeats</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"w\">    </span><span class=\"n\">val</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"n\">getHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">native_decide</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">getHeartbeats</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n</code></pre></div>",
        "id": 531843397,
        "sender_full_name": "Jason Rute",
        "timestamp": 1753882045
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> <span class=\"user-mention\" data-user-id=\"115715\">@Jason Rute</span> thanks for making test cases for <a href=\"https://github.com/leanprover/lean4/pull/9631\">lean4#9631</a>! There are some incomplete aspects of the PR, but hopefully we can get it landed in the next week or so.</p>",
        "id": 531929749,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1753909273
    },
    {
        "content": "<p>I'd like to come up with a plan to fix all of the known bugs with <code>native_decide</code>, prioritizing issues that are likely to come up with people using RL against Mathlib than ones that would likely only come from more directly adversarial usage.</p>",
        "id": 531930795,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1753909652
    },
    {
        "content": "<p>The most likely real world cases are bad implemented_bys, but they are already fixed immediately when found.</p>",
        "id": 531931332,
        "sender_full_name": "Jason Rute",
        "timestamp": 1753909870
    },
    {
        "content": "<p>Does this PR also fix the stochastic exploit in <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/soundness.20bug.3A.20native_decide.20leakage/with/397911265\">#lean4 &gt; soundness bug: native_decide leakage</a>?</p>",
        "id": 531931880,
        "sender_full_name": "Jason Rute",
        "timestamp": 1753910105
    },
    {
        "content": "<p>Yes, it fixes the initial example Mario posted, in that the axiom list now always includes <code>sorryAx</code>.</p>",
        "id": 531933301,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1753910693
    },
    {
        "content": "<p>Note that <code>ST</code> is also problematic: <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/Ensuring.20naive.20purity/near/396153183\">#lean4 &gt; Ensuring naive purity @ üí¨</a></p>",
        "id": 532135236,
        "sender_full_name": "Parth Shastri",
        "timestamp": 1753984302
    }
]