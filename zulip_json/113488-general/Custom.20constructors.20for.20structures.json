[
    {
        "content": "<p>Declaring a structure <code>σ</code> declares a <code>σ.mk</code> operation. Can I suppress this, and instead declare a custom constructor for <code>σ</code>'s?</p>",
        "id": 496522318,
        "sender_full_name": "Oleks",
        "timestamp": 1738148863
    },
    {
        "content": "<p>The default constructor needs to exist but you can name it what you like with the <code>name ::</code> syntax. See for example the beautiful definition of <code>ULift</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ULift</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Lift a value into `ULift α` -/</span><span class=\"w\">    </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"bp\">::</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Extract a value from `ULift α` -/</span><span class=\"w\"> </span><span class=\"n\">down</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>\n<p>so now we have <code>ULift.up</code> and <code>ULift.down</code> doing what you'd expect them to do (and no <code>ULift.mk</code>).</p>",
        "id": 496522707,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738149001
    },
    {
        "content": "<p>I don't quite understand <code>::</code> and <code>: α</code> above.</p>",
        "id": 496523894,
        "sender_full_name": "Oleks",
        "timestamp": 1738149418
    },
    {
        "content": "<p>Maybe I'm just unfamiliar with declaring structures with the <code>where</code> keyword.</p>",
        "id": 496523957,
        "sender_full_name": "Oleks",
        "timestamp": 1738149453
    },
    {
        "content": "<p>Perhaps more to the point, how can I have a custom body for <code>up</code> in this example?</p>",
        "id": 496533392,
        "sender_full_name": "Oleks",
        "timestamp": 1738152577
    },
    {
        "content": "<p>You can't, a constructor is a very primitive part of both the type theory and the runtime. In type theory it has special properties such as being able to use it for induction/case splitting, in the runtime the constructor precisely describes the kind of struct you need to allocate to store a type. If you want to have custom additional stuff in a constructor you can write something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">internalMk</span><span class=\"w\"> </span><span class=\"bp\">::</span>\n<span class=\"w\">    </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">customStuff</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">internalMk</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n</code></pre></div>\n<p>The term constructor is not equivalent to the one from classical OOP languages.</p>",
        "id": 496544424,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738156179
    },
    {
        "content": "<p>Out of curiosity, what would you generally call <code>Foo.mk</code> to distinguish it from <code>Foo.internalMk</code> here?</p>",
        "id": 496554483,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738159143
    },
    {
        "content": "<p>There is no need for that, <code>internalMk</code> is private so an outside user doesn't see it. Though of course if you want to prove things about <code>Foo</code> this get's more involved, then again, if you prove stuff about <code>Foo</code> you probably don't want custom stuff in a constructor anyway</p>",
        "id": 496555134,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738159315
    },
    {
        "content": "<p>Let me try again. Are both constructors?</p>",
        "id": 496555439,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738159392
    },
    {
        "content": "<p>Not in the Lean sense no</p>",
        "id": 496555474,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738159403
    },
    {
        "content": "<p>What would you call <code>Foo.mk</code> then</p>",
        "id": 496555532,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738159419
    },
    {
        "content": "<p>I don't have a name for it, some versions of <code>Foo.mk</code> (though not this one) might be labeled smart constructors in other FP languages</p>",
        "id": 496555736,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738159467
    },
    {
        "content": "<p>Here is what I used <a href=\"https://github.com/leanprover-community/mathlib4/pull/20993\">#20993</a> when I asked myself this question. A problem is that many (most?) people will just call them all \"constructors\"</p>",
        "id": 496556288,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738159622
    },
    {
        "content": "<p>I am mainly looking for better alternatives</p>",
        "id": 496556431,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738159667
    },
    {
        "content": "<p>You can call them constructors if you want, it makes sense from an OOP perspective. But people that do type theory or work with meta code will be confused.</p>",
        "id": 496559312,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1738160453
    },
    {
        "content": "<p>The reason I ask is precisely because I want to prove things about my structure. As an example, let's say I want to implement a <code>NonEmptyArray</code> based on the underlying <code>Array</code> type. Then I would like to limit how <code>NonEmptyArray</code> may be constructed, so that no-one can construct a <code>NonEmptyArray</code> with an empty array underneath. If I can limit how <code>NonEmptyArray</code> may be constructed, I can leverage the fact that it is non-empty in subsequent proofs.</p>",
        "id": 496596418,
        "sender_full_name": "Oleks",
        "timestamp": 1738170345
    },
    {
        "content": "<p>In that case, you can add an additional proposition field that the underlying array is nonempty. That enforces the constraint that you want.</p>",
        "id": 496596910,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738170503
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NonEmptyArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toArray</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">nonempty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span>\n</code></pre></div>",
        "id": 496597071,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738170561
    },
    {
        "content": "<p>Here's an example of conditionally constructing one at runtime:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">NonEmptyArray</span><span class=\"bp\">.</span><span class=\"n\">mk?</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">array</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">NonEmptyArray</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">toArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nonempty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">none</span>\n</code></pre></div>",
        "id": 496597366,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738170646
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/113488-general/topic/Custom.20constructors.20for.20structures/near/496555532\">said</a>:</p>\n<blockquote>\n<p>What would you call <code>Foo.mk</code> then</p>\n</blockquote>\n<p>I believe we would call it \"part of the API\"</p>",
        "id": 533675153,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754858259
    },
    {
        "content": "<p>I guess you could use \"constructor\" vs <code>ctor</code> to make the technical distinction</p>",
        "id": 533680151,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754864463
    },
    {
        "content": "<p>Another answer is to call <code>Foo.mk</code> a \"factory function\"</p>",
        "id": 533680166,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754864491
    },
    {
        "content": "<p>/me discovers that <code>ctor</code> means \"constructor\" <span aria-label=\"idea\" class=\"emoji emoji-1f4a1\" role=\"img\" title=\"idea\">:idea:</span></p>",
        "id": 533706455,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1754891038
    }
]