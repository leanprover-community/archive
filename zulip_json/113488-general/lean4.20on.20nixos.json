[
    {
        "content": "<p>Thread forked from: <a href=\"#narrow/stream/113488-general/topic/binary.20package.20was.20not.20provided.20for.20'linux'/near/298433508\">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/binary.20package.20was.20not.20provided.20for.20'linux'/near/298433508</a></p>\n<p>The corresponding PR to nixpkgs was merged 4 hours ago. I just ran <code>nix-channel --update</code> and rebuilt my system. But I'm still stuck with elan 1.4.1. Why is nix letting me down?</p>",
        "id": 298581995,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663075006
    },
    {
        "content": "<p><a href=\"https://status.nixos.org/\">https://status.nixos.org/</a>  Last nixos-unstable channel update was a day ago.</p>",
        "id": 298582995,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663075341
    },
    {
        "content": "<p><a href=\"https://nixpk.gs/pr-tracker.html?pr=191035\">https://nixpk.gs/pr-tracker.html?pr=191035</a> is useful too (<a href=\"https://nixpk.gs/pr-tracker.html?pr=191039\">https://nixpk.gs/pr-tracker.html?pr=191039</a> if you're on 22.05)</p>",
        "id": 298583245,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1663075417
    },
    {
        "content": "<p>You can use a bit of mutable state in the meantime:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">nix</span><span class=\"bp\">-</span><span class=\"n\">env</span> <span class=\"bp\">-</span><span class=\"n\">f</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">nixos</span><span class=\"bp\">/</span><span class=\"n\">nixpkgs</span><span class=\"bp\">/</span><span class=\"n\">archive</span><span class=\"bp\">/</span><span class=\"n\">master.zip</span> <span class=\"bp\">-</span><span class=\"n\">iA</span> <span class=\"n\">elan</span>\n</code></pre></div>",
        "id": 298583600,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663075511
    },
    {
        "content": "<p>That's evil, right?</p>",
        "id": 298584323,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663075754
    },
    {
        "content": "<p>Can nix tell me about all the mutable state that I've used in the past, so that I can undo it?</p>",
        "id": 298584359,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663075769
    },
    {
        "content": "<p>You can also do <code>nix-shell -I nixpkgs=https://github.com/nixos/nixpkgs/archive/master.zip -p elan</code> to get a temporary shell with the newest elan. No mutable state, but slightly less convenient.</p>",
        "id": 298584570,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1663075844
    },
    {
        "content": "<p>But vscode will not know about that elan.</p>",
        "id": 298584619,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663075864
    },
    {
        "content": "<p>Maybe I should just wait for a day.</p>",
        "id": 298584631,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663075870
    },
    {
        "content": "<p>Can't I instruct <code>nix-channel --update</code> to <em>really</em> give me actual unstable?</p>",
        "id": 298584697,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663075895
    },
    {
        "content": "<p>You can do <code>nix-env -q</code> to see all of the mutable \"overrides\".  And then use <code>nix-env -e elan</code> to get rid of it again.</p>",
        "id": 298584709,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663075899
    },
    {
        "content": "<p>/me is very confused</p>",
        "id": 298729275,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663146215
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯ <span class=\"nb\">cd</span> ../mathlib\n\nmathlib on  refactor-wlog\n❯ elan show\ninstalled toolchains\n--------------------\n\nleanprover-community/lean:3.35.0\nleanprover-community/lean:3.42.0\nleanprover-community/lean:3.42.1\nleanprover-community/lean:3.44.1\nleanprover-community/lean:3.45.0\nleanprover-community/lean:3.47.0\nleanprover-community/lean:3.48.0\nleanprover/lean4:nightly-2022-09-11 <span class=\"o\">(</span>default<span class=\"o\">)</span>\nleanprover/lean4:nightly-2022-09-12\nleanprover/lean4:nightly-2022-09-13\n\nactive toolchain\n----------------\n\nleanprover-community/lean:3.48.0 <span class=\"o\">(</span>overridden by <span class=\"s1\">'/home/jmc/repos/mathlib/leanpkg.toml'</span><span class=\"o\">)</span>\nLean <span class=\"o\">(</span>version <span class=\"m\">3</span>.48.0, commit 283f6ed8083a, Release<span class=\"o\">)</span>\n\n\nmathlib on  refactor-wlog\n❯ lean --version\nLean <span class=\"o\">(</span>version <span class=\"m\">3</span>.48.0, commit 283f6ed8083a, Release<span class=\"o\">)</span>\n\nmathlib on  refactor-wlog\n❯ <span class=\"nb\">cd</span> ../mathlib4\n\nmathlib4 on  master <span class=\"o\">[</span>?<span class=\"o\">]</span>\n❯ elan show\ninstalled toolchains\n--------------------\n\nleanprover-community/lean:3.35.0\nleanprover-community/lean:3.42.0\nleanprover-community/lean:3.42.1\nleanprover-community/lean:3.44.1\nleanprover-community/lean:3.45.0\nleanprover-community/lean:3.47.0\nleanprover-community/lean:3.48.0\nleanprover/lean4:nightly-2022-09-11 <span class=\"o\">(</span>default<span class=\"o\">)</span>\nleanprover/lean4:nightly-2022-09-12\nleanprover/lean4:nightly-2022-09-13\n\nactive toolchain\n----------------\n\nleanprover/lean4:nightly-2022-09-11 <span class=\"o\">(</span>overridden by <span class=\"s1\">'/home/jmc/repos/mathlib4/lean-toolchain'</span><span class=\"o\">)</span>\n<span class=\"o\">(</span>error reading lean version<span class=\"o\">)</span>\n\n\nmathlib4 on  master <span class=\"o\">[</span>?<span class=\"o\">]</span>\n❯ lean --version\nerror: <span class=\"nb\">command</span> failed: <span class=\"s1\">'lean'</span>\ninfo: caused by: No such file or directory <span class=\"o\">(</span>os error <span class=\"m\">2</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 298729293,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663146223
    },
    {
        "content": "<p>Any idea where that error can come from?</p>",
        "id": 298729389,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663146255
    },
    {
        "content": "<p>That's because we use patchelf+makeWrapper to make the lean4 builds work on nixos.  As a result, they depend on the stdenv used in elan.  So if you run the garbage collector, old downloads will stop working.</p>",
        "id": 298733834,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663148132
    },
    {
        "content": "<p>Just run <code>elan uninstall leanprover/lean4:nightly-2022-09-11</code></p>",
        "id": 298733879,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663148150
    },
    {
        "content": "<p>But it was only downloaded this morning, and I didn't gc after that</p>",
        "id": 298733995,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663148186
    },
    {
        "content": "<p>What does <code>ldd (elan which lean)</code> say?</p>",
        "id": 298734518,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663148389
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯ ldd <span class=\"o\">(</span>elan which lean<span class=\"o\">)</span>\nzsh: missing end of string\n</code></pre></div>",
        "id": 299514250,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663572138
    },
    {
        "content": "<p>I assume it should be <code>ldd $(elan which lean)</code>, i.e. antiquotation.</p>",
        "id": 299514383,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1663572213
    },
    {
        "content": "<p>Aah, makes sense</p>",
        "id": 299515975,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663573090
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯ ldd <span class=\"k\">$(</span>elan which lean<span class=\"k\">)</span>\n        linux-vdso.so.1 <span class=\"o\">(</span>0x00007fff865e6000<span class=\"o\">)</span>\n        libleanshared.so <span class=\"o\">=</span>&gt; /home/jmc/.elan/toolchains/leanprover--lean4---nightly-2022-09-15/bin/../lib/lean/libleanshared.so <span class=\"o\">(</span>0x00007fb628911000<span class=\"o\">)</span>\n        libdl.so.2 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libdl.so.2 <span class=\"o\">(</span>0x00007fb62890c000<span class=\"o\">)</span>\n        libpthread.so.0 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libpthread.so.0 <span class=\"o\">(</span>0x00007fb6288ec000<span class=\"o\">)</span>\n        libc.so.6 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libc.so.6 <span class=\"o\">(</span>0x00007fb628717000<span class=\"o\">)</span>\n        libm.so.6 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libm.so.6 <span class=\"o\">(</span>0x00007fb6285d6000<span class=\"o\">)</span>\n        librt.so.1 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/librt.so.1 <span class=\"o\">(</span>0x00007fb6285c9000<span class=\"o\">)</span>\n        /lib64/ld-linux-x86-64.so.2 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib64/ld-linux-x86-64.so.2 <span class=\"o\">(</span>0x00007fb62bb79000<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 299516022,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663573115
    },
    {
        "content": "<p>That's a different nightly (2022-09-15) from before, do both of them fail to execute?</p>",
        "id": 299517428,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1663573817
    },
    {
        "content": "<p>I removed the <code>2022-09-11</code> version. That one is now also broken <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 299517586,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663573919
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯ elan run leanprover/lean4:nightly-2022-09-11 lean --version\nerror: <span class=\"nb\">command</span> failed: <span class=\"s1\">'lean'</span>\ninfo: caused by: No such file or directory <span class=\"o\">(</span>os error <span class=\"m\">2</span><span class=\"o\">)</span>\n\n❯ elan run leanprover/lean4:nightly-2022-09-12 lean --version\nLean <span class=\"o\">(</span>version <span class=\"m\">4</span>.0.0-nightly-2022-09-12, commit ec2372e8d4ca, Release<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 299517680,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663573948
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># version of lean that works</span>\n❯ ldd /home/jmc/.elan/toolchains/leanprover--lean4---nightly-2022-09-12/bin/lean\n        linux-vdso.so.1 <span class=\"o\">(</span>0x00007ffc6d4d1000<span class=\"o\">)</span>\n        libleanshared.so <span class=\"o\">=</span>&gt; /home/jmc/.elan/toolchains/leanprover--lean4---nightly-2022-09-12/bin/../lib/lean/libleanshared.so <span class=\"o\">(</span>0x00007f75c641c000<span class=\"o\">)</span>\n        libdl.so.2 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libdl.so.2 <span class=\"o\">(</span>0x00007f75c6417000<span class=\"o\">)</span>\n        libpthread.so.0 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libpthread.so.0 <span class=\"o\">(</span>0x00007f75c63f7000<span class=\"o\">)</span>\n        libc.so.6 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libc.so.6 <span class=\"o\">(</span>0x00007f75c6222000<span class=\"o\">)</span>\n        libm.so.6 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libm.so.6 <span class=\"o\">(</span>0x00007f75c60e1000<span class=\"o\">)</span>\n        librt.so.1 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/librt.so.1 <span class=\"o\">(</span>0x00007f75c60d4000<span class=\"o\">)</span>\n        /nix/store/bzd91shky9j9d43girrrj6vmqlw7x9m8-glibc-2.35-163/lib/ld-linux-x86-64.so.2 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib64/ld-linux-x86-64.so.2 <span class=\"o\">(</span>0x00007f75c9663000<span class=\"o\">)</span>\n\n<span class=\"c1\"># version of lean that doesn't work</span>\n❯ ldd /home/jmc/.elan/toolchains/leanprover--lean4---nightly-2022-09-15/bin/lean\n        linux-vdso.so.1 <span class=\"o\">(</span>0x00007ffc8a783000<span class=\"o\">)</span>\n        libleanshared.so <span class=\"o\">=</span>&gt; /home/jmc/.elan/toolchains/leanprover--lean4---nightly-2022-09-15/bin/../lib/lean/libleanshared.so <span class=\"o\">(</span>0x00007f225c9c2000<span class=\"o\">)</span>\n        libdl.so.2 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libdl.so.2 <span class=\"o\">(</span>0x00007f225c9bd000<span class=\"o\">)</span>\n        libpthread.so.0 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libpthread.so.0 <span class=\"o\">(</span>0x00007f225c99d000<span class=\"o\">)</span>\n        libc.so.6 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libc.so.6 <span class=\"o\">(</span>0x00007f225c7c8000<span class=\"o\">)</span>\n        libm.so.6 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/libm.so.6 <span class=\"o\">(</span>0x00007f225c687000<span class=\"o\">)</span>\n        librt.so.1 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib/librt.so.1 <span class=\"o\">(</span>0x00007f225c67a000<span class=\"o\">)</span>\n        /lib64/ld-linux-x86-64.so.2 <span class=\"o\">=</span>&gt; /nix/store/q29bwjibv9gi9n86203s38n0577w09sx-glibc-2.33-117/lib64/ld-linux-x86-64.so.2 <span class=\"o\">(</span>0x00007f225fc2a000<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 299539120,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663583572
    },
    {
        "content": "<p>The <code>/lib64/ld-linux-x86-64.so.2</code> is very suspicious.  Did you use a non-nixpkgs elan at one point?</p>",
        "id": 299545960,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663586823
    },
    {
        "content": "<p>Only via <code>nix-env -e</code> as you suggested earlier in this thread.</p>",
        "id": 299546011,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663586860
    },
    {
        "content": "<p>Hmm that should be fine.</p>",
        "id": 299546147,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663586919
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> So what can I try? I'm completely stumped.</p>",
        "id": 299547360,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663587470
    },
    {
        "content": "<p>Have you tried turning it off and on again?  Does it work again if you do <code>elan uninstall leanprover--lean4---nightly-2022-09-15</code>?</p>",
        "id": 299548425,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663588005
    },
    {
        "content": "<p>Yeah, I tried that.</p>",
        "id": 299548892,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663588213
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯ elan uninstall leanprover/lean4:nightly-2022-09-15\ninfo: uninstalling toolchain <span class=\"s1\">'leanprover/lean4:nightly-2022-09-15'</span>\ninfo: toolchain <span class=\"s1\">'leanprover/lean4:nightly-2022-09-15'</span> uninstalled\n\n❯ lean --version\ninfo: downloading component <span class=\"s1\">'lean'</span>\n<span class=\"m\">137</span>.3 MiB / <span class=\"m\">137</span>.3 MiB <span class=\"o\">(</span><span class=\"m\">100</span> %<span class=\"o\">)</span>  <span class=\"m\">20</span>.7 MiB/s ETA:   <span class=\"m\">0</span> s\ninfo: installing component <span class=\"s1\">'lean'</span>\nerror: <span class=\"nb\">command</span> failed: <span class=\"s1\">'lean'</span>\ninfo: caused by: No such file or directory <span class=\"o\">(</span>os error <span class=\"m\">2</span><span class=\"o\">)</span>\n\n❯ elan --version\nelan <span class=\"m\">1</span>.4.2 <span class=\"o\">(</span>4a1b1b918 <span class=\"m\">2022</span>-09-13<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 299548948,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663588244
    },
    {
        "content": "<p><code>which lean</code>?</p>",
        "id": 299549281,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663588421
    },
    {
        "content": "<p>That doesn't look like a nixpkgs build.</p>",
        "id": 299549343,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663588444
    },
    {
        "content": "<p>This is how it should look like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">elan</span> <span class=\"c1\">--version</span>\n<span class=\"n\">elan</span> <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">2</span> <span class=\"o\">(</span> <span class=\"o\">)</span>\n</code></pre></div>",
        "id": 299549365,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663588465
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯ which lean\n/home/jmc/.elan/bin/lean\n</code></pre></div>",
        "id": 299549416,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663588496
    },
    {
        "content": "<p>Okay, you've installed the official elan build.  This was a bad idea.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">rm</span> <span class=\"bp\">-</span><span class=\"n\">rf</span> <span class=\"bp\">~/.</span><span class=\"n\">elan</span>\n</code></pre></div>",
        "id": 299549475,
        "sender_full_name": "Gabriel Ebner",
        "timestamp": 1663588529
    },
    {
        "content": "<p>Ooh, ok</p>",
        "id": 299549510,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663588549
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯ rm -rf ~/.elan\n\n❯ lean --version\ninfo: downloading component <span class=\"s1\">'lean'</span>\nTotal: <span class=\"m\">137</span>.3 MiB Speed:   <span class=\"m\">8</span>.9 MiB/s\ninfo: installing component <span class=\"s1\">'lean'</span>\nLean <span class=\"o\">(</span>version <span class=\"m\">4</span>.0.0-nightly-2022-09-15, commit c1b7accd12f4, Release<span class=\"o\">)</span>\n\n❯ elan --version\nelan <span class=\"m\">1</span>.4.2 <span class=\"o\">(</span> <span class=\"o\">)</span>\n</code></pre></div>",
        "id": 299549668,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663588605
    },
    {
        "content": "<p>Hooray! <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span></p>",
        "id": 299549697,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1663588616
    }
]