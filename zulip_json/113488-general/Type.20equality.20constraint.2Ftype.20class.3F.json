[
    {
        "content": "<p>I'm porting some Haskell code to lean and I'm trying to find an equivalent/replacement for <a href=\"https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Type-Equality.html#t:-126-\">Data.Type.Equality</a>'s <code>a ~ b</code> class and I'm struggling. It's a type class constraint which says 'a unifies with b' and is hooked into the type checker. It serves two purposes for the code I'm working on:</p>\n<ol>\n<li>Manipulating instance resolution</li>\n<li>Improving type inference/error messages</li>\n</ol>\n<p>For example, consider the following code which only allows pairs of certain types:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Pair</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Pair</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Pair</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- All good</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">y'</span><span class=\"w\"> </span><span class=\"c1\">-- error: 'failed to synthesize instance  Pair Char Char'</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"c1\">-- : ?m -&gt; Char × ?m</span>\n</code></pre></div>\n<p>Here, <code>pair 'x' 'y'</code>(correctly) fails to synthesise an instance where <code>a</code> and <code>b</code> are both <code>Char</code>, but let's say I want to be a bit more specific about my instance: if <code>a</code> is <code>Char</code>, then <code>b</code> <em>must</em> be <code>Bool</code>. I want to write something like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Pair</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- All good</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">y'</span><span class=\"w\"> </span><span class=\"c1\">-- error: 'y' has type `Char` but is expected to have type `Bool`</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"c1\">-- : Bool -&gt; Char × Bool</span>\n</code></pre></div>\n<p>Here, only the <code>a</code>/<code>Char</code> determines which instance is selected and <code>b</code> is unified with <code>Bool</code> (or fails to unify) <em>after</em> this selection has already taken place. Is something like this possible in lean?</p>",
        "id": 527075645,
        "sender_full_name": "Jessica Foster",
        "timestamp": 1751578259
    },
    {
        "content": "<p>I don't think we have a class like that. Can't you just make a <code>Pair Char Bool</code>?</p>",
        "id": 527076199,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751578555
    },
    {
        "content": "<p>You can make <code>b</code> an <code>outParam</code> to \"constrain\" it with instances</p>",
        "id": 527076322,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751578623
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Pair</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Pair</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Pair</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- All good</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">y'</span><span class=\"w\"> </span><span class=\"c1\">-- error: 'failed to synthesize instance  Pair Char Char'</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"c1\">-- pair 'x' : Bool → Char × Bool</span>\n<span class=\"c1\">-- delay elaboration with `by exact`</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">y'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- type mismatch, 'y' has type Char but is expected to have type Bool</span>\n</code></pre></div>",
        "id": 527076574,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751578742
    },
    {
        "content": "<p>Ah, I was hopeful <code>outParam</code> might do the trick, but my actual code is recursive + has variables so I get the error 'instance does not provide concrete values for (semi-)out-params'</p>",
        "id": 527079369,
        "sender_full_name": "Jessica Foster",
        "timestamp": 1751580234
    },
    {
        "content": "<p>It'd be a shame if there's no way around this, it's a very common trick in Haskell type class programming (and important for our upcoming POPL submission <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>). Do you have any tips for debugging instance resolution? Any way to see what instances it's trying to use etc.</p>",
        "id": 527079380,
        "sender_full_name": "Jessica Foster",
        "timestamp": 1751580244
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"692054\">Jessica Foster</span> <a href=\"#narrow/channel/113488-general/topic/Type.20equality.20constraint.2Ftype.20class.3F/near/527079380\">said</a>:</p>\n<blockquote>\n<p>Do you have any tips for debugging instance resolution? Any way to see what instances it's trying to use etc.</p>\n</blockquote>\n<p>Usually <code>set_option trace.Meta.synthInstance true</code> tells me everything I need to know</p>",
        "id": 527079527,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751580343
    },
    {
        "content": "<p>If you're still having issues you can build a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> and I can take a look at it</p>",
        "id": 527079581,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751580372
    },
    {
        "content": "<p>Ah that helps a lot, thank you!</p>",
        "id": 527080108,
        "sender_full_name": "Jessica Foster",
        "timestamp": 1751580702
    }
]