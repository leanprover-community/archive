[
    {
        "content": "<p>This is probably a known issue.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">push_neg</span>\n<span class=\"w\">  </span><span class=\"n\">fail_if_success</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Q</span>\n<span class=\"w\">  </span><span class=\"n\">tauto</span>\n</code></pre></div>\n<p>This bit me because I tried to do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">error: Type mismatch</span>\n<span class=\"sd\">  h✝</span>\n<span class=\"sd\">has type</span>\n<span class=\"sd\">  a ≠ 0 → b = 0</span>\n<span class=\"sd\">but is expected to have type</span>\n<span class=\"sd\">  a = 0 ∨ b = 0</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">by_contra!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 561378181,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764672372
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> Do you have any ideas here?</p>",
        "id": 561378248,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764672396
    },
    {
        "content": "<p>Maybe, to <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> the <code>by_contra!</code> tactic shouldn't use <code>push_neg</code> but rather <code>tauto</code>?</p>",
        "id": 561378489,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764672457
    },
    {
        "content": "<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¬</span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">push_neg</span><span class=\"bp\">.</span><span class=\"n\">use_distrib</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">push_neg</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>And once <a href=\"https://github.com/leanprover-community/mathlib4/pull/31406\">#31406</a> lands, you can write <code>push_neg +distrib</code>/<code>by_contra! +distrib</code></p>",
        "id": 561378820,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764672569
    },
    {
        "content": "<p>How would that make sense? It's not a closing tactic</p>",
        "id": 561378840,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1764672578
    },
    {
        "content": "<p>It makes a little bit of sense for <code>push_neg</code> with a type annotation, for proving that the given type annotation matches the expected type. The current approach is to just <code>push_neg</code> in both and hope that they end up the same.</p>",
        "id": 561379012,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764672641
    },
    {
        "content": "<p>Do you think that <code>by_contra!</code> should use <code>+distrib</code> as the default?</p>",
        "id": 561380538,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764673061
    },
    {
        "content": "<p>What do you think of having it use <code>tauto</code> whenever the types don't line up?</p>",
        "id": 561380900,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764673177
    },
    {
        "content": "<p>Well I think that wouldn't really work because <code>tauto</code> is not aware of all <code>push_neg</code> theorems.</p>",
        "id": 561381066,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764673228
    },
    {
        "content": "<p>My question is rather why <code>by_contra!</code> should have anything to do with <code>push_neg</code> in the first place... <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 561381484,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764673338
    },
    {
        "content": "<p>Well, <code>by_contra!</code> is the combination of <code>by_contra</code> and <code>push_neg</code>... Unless you want to put type annotations in every <code>by_contra!</code>, there is no other way.</p>",
        "id": 561381880,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764673449
    },
    {
        "content": "<p>Aah, so maybe I want <code>tauto</code> as a fall-back in the non-confluent cases?</p>",
        "id": 561382506,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764673620
    },
    {
        "content": "<p>Or maybe whenever the user gives a type annotation?</p>",
        "id": 561382594,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764673643
    },
    {
        "content": "<p>If the user gives a type annotation, there is an implicit claim that they have an idea of what the negation of the goal should look like. We should accomodate that, unless the claim is false.<br>\n<code>tauto</code> will do that, even when eg commutativity is needed.</p>",
        "id": 561382918,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764673740
    },
    {
        "content": "<p>Something like this should work</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"by_contra!_disch\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n<span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">by_contra!_disch</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">push_neg</span><span class=\"o\">)</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h</span><span class=\"o\">)</span>\n<span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">by_contra!_disch</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">tauto</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">by_contra</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">push_neg</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">by_contra!_disch</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 561383340,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764673857
    },
    {
        "content": "<p>Oh wait, that will run <code>tauto</code> before running <code>try push_neg); exact $h</code>. But if we swap them, then we get the <code>tauto</code> error message instead of the error message that we want.</p>",
        "id": 561383815,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764674022
    },
    {
        "content": "<p>Ok, I think it would be reasonable to simply replace the <code>exact h</code> with <code>tauto</code> in the implementation of <code>by_contra!</code>. The only problem I see is that <code>tauto</code> gives a horribly useless error message: \"tauto failed to solve some goals.\". Instead, I'd like it to say that it couldn't solve <strong>the</strong> goal, and then print the goal.</p>",
        "id": 561385206,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764674406
    },
    {
        "content": "<p>Can that be solved by some try-catch?</p>",
        "id": 561392814,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764676767
    },
    {
        "content": "<p>If we just fix <code>tauto</code> to give a better error message, it should be fine, right?</p>",
        "id": 561397429,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764678116
    },
    {
        "content": "<p>That's the more principled approach <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 561397559,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764678161
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/113488-general/topic/push_neg.20is.20not.20confluent/near/561379012\">said</a>:</p>\n<blockquote>\n<p>It makes a little bit of sense for <code>push_neg</code> with a type annotation, for proving that the given type annotation matches the expected type. The current approach is to just <code>push_neg</code> in both and hope that they end up the same.</p>\n</blockquote>\n<p>FYI, this is what I do in Verbose Lean as well.</p>",
        "id": 561483406,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1764697982
    },
    {
        "content": "<p>Perhaps this is related: I find it undesirable that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=not_and#doc\">docs#not_and</a> is a simp lemma. Often this lemma turns a symmetrical expression into an unsymmetrical one and makes my InfoView harder to understand, I think I might prefer it more if <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=not_and_or#doc\">docs#not_and_or</a> were the lemma simp used here instead.</p>",
        "id": 561484609,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1764698347
    },
    {
        "content": "<p>I definitely want <code>¬∃ x ∈ s, P x</code> to be turned into <code>∀ x ∈ s, ¬P x</code> instead of <code>∀ x, x ∉ s ∨ ¬P x</code></p>",
        "id": 561495168,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764701512
    },
    {
        "content": "<p>It is possible to add a <code>push</code> lemma <code>¬(∃ x, Q x ∧ P x) = ∀ x, Q x → ¬P x</code>, and this would make your case still work as desired. (while also having <code>not_and_or</code> for bare conjunctions)</p>",
        "id": 561506450,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764705071
    }
]