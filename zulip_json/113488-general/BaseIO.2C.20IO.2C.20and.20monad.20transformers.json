[
    {
        "content": "<p>I recently refactored my program to use a reader. I've been running into an issue where <code>BaseIO</code> somehow automatically converts to <code>IO</code> no problem, but when I wrap them in my transformer, they're not directly compatible.<br>\nSimplified:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerEnv</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">baseIOAction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"c1\">-- ok</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">baseIOAction</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">transformedBaseIOAction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerT</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">type mismatch</span>\n<span class=\"cm\">  transformedBaseIOAction</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  CmdHandlerT BaseIO Unit : Type</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  CmdHandlerT IO Unit : Type</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerT</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">transformedBaseIOAction</span>\n</code></pre></div>\n<p>I can work around it like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">ρ</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">act</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toIO</span>\n</code></pre></div>\n<p>But this feels kind of janky and specific</p>\n<p>My questions are</p>\n<ul>\n<li>what's the mechanism by which <code>BaseIO</code> is converted to <code>IO</code> automatically? I can't find a <code>Coe</code> instance.</li>\n<li>Is there a better way to do this?</li>\n<li>could that better way be done generically in the standard library for every transformer?</li>\n</ul>",
        "id": 454583573,
        "sender_full_name": "James Sully",
        "timestamp": 1722153287
    },
    {
        "content": "<p>if instead of <code>example</code> you use <code>def foo : IO Unit := baseIOAction</code>, you can use <code>#print</code> to discover what's going on in the conversion:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerT</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">CmdHandlerEnv</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">baseIOAction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"c1\">-- ok</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">baseIOAction</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"c1\">-- def foo : IO Unit := @liftM BaseIO (EIO IO.Error) (instMonadLiftTOfMonadLift BaseIO BaseIO (EIO IO.Error)) Unit baseIOAction</span>\n<span class=\"c1\">--</span>\n</code></pre></div>\n<p>basically, it seems like there is a <code>Coe</code>-like typeclass <code>MonadLift</code> saying you can lift <code>BaseIO</code> to <code>IO</code>.<br>\nyou can check this by using <code>#synth MonadLift BaseIO IO</code></p>",
        "id": 454584649,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1722154439
    },
    {
        "content": "<p>it seems to go through an intermediate class <code>MonadLiftT</code> but that looks to me like an implementation detail</p>",
        "id": 454584715,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1722154500
    },
    {
        "content": "<p>Thanks, I'll play around with this</p>",
        "id": 454584843,
        "sender_full_name": "James Sully",
        "timestamp": 1722154676
    },
    {
        "content": "<p>Ok I fumbled around in the dark a bit and got stuck:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">ω</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">ω</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">ω</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>\"cannot find synthesization order for instance @instMonadLift with type<br>\n  {m n ω : Type → Type} →<br>\n    {t : (Type → Type) → Type → Type} → [inst : MonadLift m n] → [inst : MonadLift ω (t ω)] → MonadLift (t m) (t n)<br>\nall remaining arguments have metavariables:<br>\n  MonadLift ?ω (t ?ω)\"</p>",
        "id": 454585671,
        "sender_full_name": "James Sully",
        "timestamp": 1722155219
    },
    {
        "content": "<p>I'm not really sure whether I have the right idea here or not</p>",
        "id": 454585766,
        "sender_full_name": "James Sully",
        "timestamp": 1722155298
    },
    {
        "content": "<p>Should <code>{ω : Type → Type} [MonadLift ω (t ω)]</code> instead be <code>[∀ ω, MonadLift ω (t ω)]</code>?</p>",
        "id": 454585806,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1722155357
    },
    {
        "content": "<p>Yes!</p>",
        "id": 454585877,
        "sender_full_name": "James Sully",
        "timestamp": 1722155413
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">ω</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">ω</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">ω</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">action</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 454585886,
        "sender_full_name": "James Sully",
        "timestamp": 1722155423
    },
    {
        "content": "<p>the next thing to figure out is how to implement it</p>",
        "id": 454585902,
        "sender_full_name": "James Sully",
        "timestamp": 1722155438
    },
    {
        "content": "<p>I haven't managed to figure it out in full generality (not even sure whether it's possible), but here's one for <code>ReaderT</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">monadLiftReaderT</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span><span class=\"w\"> </span><span class=\"n\">action</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">liftM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">action</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">r</span>\n</code></pre></div>\n<p>Would this be a good addition to the standard library?</p>",
        "id": 454844697,
        "sender_full_name": "James Sully",
        "timestamp": 1722261895
    },
    {
        "content": "<p>I think such instances could be problematic when you stack the same transformer multiple times as now you get quadratically many possible instances</p>",
        "id": 455107626,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722341030
    },
    {
        "content": "<p>It definitely feels like there's an ergonomics issue here, but I'm not sure what the right solution is</p>",
        "id": 455155209,
        "sender_full_name": "James Sully",
        "timestamp": 1722354739
    },
    {
        "content": "<p>what about just </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonadLift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ReaderT</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">monadLift</span><span class=\"w\"> </span><span class=\"n\">action</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">liftM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">action</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">r</span>\n</code></pre></div>",
        "id": 455155900,
        "sender_full_name": "James Sully",
        "timestamp": 1722354917
    },
    {
        "content": "<p>Feels quite ad-hoc :) . It's a fine local instance though.</p>",
        "id": 455156368,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722355031
    },
    {
        "content": "<p>I agree it's ad hoc, but in the absence of a general solution, it feels like an 80/20 thing that would add a lot of convenience. Defining just a <code>ReaderT σ IO</code> is pretty common (at least in haskell).</p>",
        "id": 455156716,
        "sender_full_name": "James Sully",
        "timestamp": 1722355135
    }
]