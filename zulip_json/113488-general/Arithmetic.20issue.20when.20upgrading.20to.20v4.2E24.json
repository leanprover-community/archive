[
    {
        "content": "<p>I'm in the process of upgrading our Lean project from v4.23.0 to v4.24.0. The last error I need to solve is an <code>omega</code> case as follows:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">      </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">      </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">beq_eq_false_iff_ne</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ne_eq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">decide_eq_true_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat_eq_coe</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n<span class=\"w\">        </span><span class=\"n\">omega</span>\n</code></pre></div>\n<p>where the <code>omega</code> tactic yields:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">omega</span><span class=\"w\"> </span><span class=\"n\">could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">prove</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"o\">:</span>\n<span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">possible</span><span class=\"w\"> </span><span class=\"n\">counterexample</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">satisfy</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">constraints</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"bp\">*</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551615</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"bp\">*</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775807</span>\n<span class=\"kn\">where</span>\n<span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">n₂</span>\n<span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span>\n<span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">n₂</span>\n<span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span>\n</code></pre></div>\n<p>The tactic state before <code>omega</code> looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">bv₁</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">64</span>\n<span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">h₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">64</span>\n<span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n₂</span>\n<span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬↑</span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span>\n<span class=\"w\">      </span><span class=\"bp\">↑↑</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">          </span><span class=\"bp\">↑</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"bp\">↑↑</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">      </span><span class=\"bp\">↑</span><span class=\"mi\">18446744073709551616</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"bp\">↑↑</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">        </span><span class=\"bp\">↑</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span>\n<span class=\"w\">      </span><span class=\"bp\">↑</span><span class=\"mi\">18446744073709551616</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span>\n<span class=\"w\">  </span><span class=\"mi\">9223372036854775807</span>\n</code></pre></div>\n<p>I know that using <code>simp only [Fin.Internal.ofNat]</code> or <code>simp</code> solves the problem, but neither are acceptable to me (<code>Fin.Internal.ofNat</code> is internal, and we stick to <code>simp only</code> in our project). What's a clean way to solve this error? A few more things I've tried:</p>\n<ul>\n<li>using <code>norm_cast</code> but it's hitting a recursion error</li>\n<li>some combinations of conversions but I'm not familiar with <code>Fin</code> numbers so they don't simplify in most cases</li>\n</ul>",
        "id": 545029204,
        "sender_full_name": "Adrian Palacios",
        "timestamp": 1760549721
    },
    {
        "content": "<p>Can you make a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 545039935,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760550165
    },
    {
        "content": "<p>Does <code>grind</code> happen to do it?</p>",
        "id": 545061583,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1760551058
    },
    {
        "content": "<p>I think the first problem is how <code>Fin.Internal.ofNat</code> even appeared in the first place; did you unfold <code>BitVec.ofNat</code>? In that case, try to instead use its API (e.g. <code>BitVec.toFin_ofNat</code>, <code>BitVec.toNat_ofNat</code>)</p>",
        "id": 545074050,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760551588
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> I don't know how to make one. This is embedded in a long theorem proof and I assumed we were missing something obvious in this particular case.</p>\n<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> <code>grind</code> doesn't work neither:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"ss\">`grind</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"n\">bv₁</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">64</span>\n<span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">h₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551615</span>\n<span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">n₂</span>\n<span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">    </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">≤</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n<span class=\"n\">h_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">      </span><span class=\"k\">if</span>\n<span class=\"w\">          </span><span class=\"bp\">↑↑</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">                      </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">                </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">              </span><span class=\"bp\">-</span><span class=\"mi\">9223372036854775807</span><span class=\"w\"> </span><span class=\"bp\">≤</span>\n<span class=\"w\">            </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"bp\">↑↑</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">          </span><span class=\"mi\">18446744073709551616</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"bp\">↑↑</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">            </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">          </span><span class=\"bp\">-</span><span class=\"mi\">18446744073709551616</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">    </span><span class=\"mi\">9223372036854775807</span><span class=\"w\"> </span><span class=\"bp\">≤</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n<span class=\"n\">h_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑↑</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span>\n<span class=\"w\">      </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">    </span><span class=\"bp\">-</span><span class=\"mi\">9223372036854775807</span><span class=\"w\"> </span><span class=\"bp\">≤</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n<span class=\"n\">h_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">False</span>\n</code></pre></div>",
        "id": 545107672,
        "sender_full_name": "Adrian Palacios",
        "timestamp": 1760554397
    },
    {
        "content": "<p>Try using <code>extract_goal</code> for a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> .</p>",
        "id": 545108297,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1760554598
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>  my IDE says <code>unknown tactic</code> when using <code>extract_goal</code>.</p>\n<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> we do use <code>BitVec.ofNat</code> earlier in the proof so I'm trying using <code>BitVec</code> APIs in a few places to see if it makes a difference (no luck so far). Here's this entire case before the <code>omega</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Int64</span><span class=\"bp\">.</span><span class=\"n\">MAX</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">udiv_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">udiv_def</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">reducePow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toNat_intMin</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_one_sub_one</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">reduceMod</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toNat_ofNat</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">gt_iff_lt</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">reducePow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toInt_ofFin</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">msb_eq_false_iff_two_mul_lt</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h₀</span>\n<span class=\"w\">      </span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">toInt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h₀</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">↓</span><span class=\"n\">reduceIte</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat_lt</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">cast_ofNat_Int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">generalize</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">bmod_def</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">n₂</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">      </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">beq_eq_false_iff_ne</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ne_eq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">decide_eq_true_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat_eq_coe</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n</code></pre></div>",
        "id": 545111840,
        "sender_full_name": "Adrian Palacios",
        "timestamp": 1760556019
    },
    {
        "content": "<p>can you tell me the goal before the <code>simp only [BitVec.ofNat, Nat.reducePow, toInt_ofFin]</code></p>",
        "id": 545111963,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760556074
    },
    {
        "content": "<p><code>extract_goal</code> is a Mathlib tactic: <code>import Mathlib</code> or <code>import Mathlib.Tactic.ExtractGoal</code>. It can be very useful in situations like this; maybe it should be upstreamed?</p>",
        "id": 545115896,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1760557640
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> yes, it's this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">bv₁</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"mi\">64</span>\n<span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"bp\">.</span><span class=\"n\">toInt</span>\n<span class=\"n\">h₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"bp\">.</span><span class=\"n\">msb</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">18446744073709551616</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">bv₂</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">18446744073709551616</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">toInt</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span>\n<span class=\"w\">  </span><span class=\"mi\">9223372036854775807</span>\n</code></pre></div>",
        "id": 545116289,
        "sender_full_name": "Adrian Palacios",
        "timestamp": 1760557792
    },
    {
        "content": "<p>Try <code>simp only [BitVec.toInt_ofNat', Nat.reducePow]</code> instead of that one line</p>",
        "id": 545116640,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760557936
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> that worked, thanks so much!</p>\n<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> oh, that makes sense. We don't depend on Mathlib in our project (the <a href=\"https://github.com/cedar-policy/cedar-spec/tree/main/cedar-lean\">Lean formalization of Cedar</a>), but <code>extract_goal</code> sounds generic enough that could be upstreamed.</p>",
        "id": 545128523,
        "sender_full_name": "Adrian Palacios",
        "timestamp": 1760562825
    }
]