[
    {
        "content": "<p><a href=\"https://live.lean-lang.org/#project=lean-nightly&amp;codez=C4Cwpg9gTmC2AEAzCEAUBDeAjAXPAkgHbACUemAPNvIEmE8AxhLAA7ozyZbwC88AdABtg8HLywBPeAHMoAS0IATeAG0iwPoxZswAfTABHHUIC6AKFMCI9dAOlzFO1sGBgohJCh4A+DvCpYAGgYmVnZOczAAD3QWATBUQjw1Mnh3KgAGWmCtdndM3kFhUWxJU3g7eQVzS2tbGUrHdGdXd2QIb2zQsF8sCOjY+MSCYhS0+Ey6TS7U8Z5+IRExUvL6xVMgA\">All code</a></p>\n<p>I had a question about <code>grind</code> and multipatterns. I would like to teach <code>grind</code> to work with <code>compare</code>, in particular by recognizing that if <code>a &lt; b</code> is in the context, then <code>compare a b = .lt</code>. At first, I thought it would be enough to define a multipattern where both <code>a &lt; b</code> and <code>compare a b</code> must match. However, although this pattern is accepted, it doesn't appear to do what I would expect.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_lt</span><span class=\"o\">]</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">example</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"c1\">-- Failure</span>\n</code></pre></div>\n<p>If I remove <code>a &lt; b</code> from my statement, the proof goes on fine. But why is <code>grind</code> getting hung up with the added <code>a &lt; b</code>?</p>",
        "id": 563506435,
        "sender_full_name": "Ayhon",
        "timestamp": 1765554739
    },
    {
        "content": "<p>Look at the goal state in the failure of <code>grind</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"ss\">`grind</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">grind</span>\n<span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">h_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Ordering</span><span class=\"bp\">.</span><span class=\"n\">lt</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">False</span>\n</code></pre></div>\n<p><code>grind</code> normalized <code>n &lt; 0</code> to <code>n + 1 ≤ 0</code> so it doesn't find an <code>&lt;</code>. In general, it's best not to pattern on arithmetic stuff, in particular on <code>Nat</code> and <code>Int</code> (including <code>&lt;</code>, <code>≤</code>, <code>+</code>, <code>*</code>) because <code>grind</code> may decide to do whatever kind of normalization to those.</p>",
        "id": 563511142,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1765555975
    },
    {
        "content": "<p>But even putting the goal as <code>a + 1 ≤ b</code> doesn't fix the issue</p>",
        "id": 563511479,
        "sender_full_name": "Ayhon",
        "timestamp": 1765556058
    },
    {
        "content": "<p>I understand how, even if <code>grind</code> closed my goal when adding the parameter <code>a + 1 ≤ b</code>, this would not be still not be ideal. But I'm surprised that this doesn't seem to be the solution either. So there's something happening here which I don't understand</p>",
        "id": 563511785,
        "sender_full_name": "Ayhon",
        "timestamp": 1765556128
    },
    {
        "content": "<p>Some exhaustive checking I've tried: <a href=\"https://live.lean-lang.org/#project=lean-nightly&amp;codez=LTAEAEG0HMCcEsB2ATUBeAuqEoDOBTAG3wGMAXXUAAxIHsBbABwENZ9RnQAjKjyzlmTL5YiAFBkAFvlpt6ofAA8A+oTKgAFJy4AuUAElE6gJR7OAHlDdQgJMJQdJq3bb0oAHRrQOtBENk3DixsyvgAjqrqLgA+AHxuTLBicEjIyoLCogoqnmgxHKAA1KAAjKCAJkTcADT2DEHO3EkIKGnMQiKIWRHoeRZVNY5s+VyNKS1tmUpdudY91YFOQyPN6e2dOXlcoICmRFacRcVztQvaS6krE9nq08DFAFScYKU72HdchwP1w8nLrRkdk+sXvdQHkbrc3v06otvmdfqsAVdQa9QJYwcx3lCTjCxn81oigZsKlY0dgShjjg0xGIlMwmMQNIo9H5jGINJIvKBFCjQAAGFl6eaDLk81weMhibzcACeYisMKAA\">here</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">      </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\">          </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">          </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\">          </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">          </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\">          </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">          </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\">     </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">   </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\">      </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">       </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\">       </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">       </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\">       </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">ex_lt</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">       </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 563512531,
        "sender_full_name": "Ayhon",
        "timestamp": 1765556318
    },
    {
        "content": "<p>This works</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_lt</span><span class=\"o\">]</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">example</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"c1\">-- Failure</span>\n</code></pre></div>",
        "id": 563633575,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765644849
    },
    {
        "content": "<p>I'm confused. What do you mean by \"it works\"?</p>",
        "id": 563633637,
        "sender_full_name": "Ayhon",
        "timestamp": 1765644905
    },
    {
        "content": "<p>I forgot to remove <code>Failure</code> comment, but now grind does prove the goal.</p>",
        "id": 563633679,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765644954
    },
    {
        "content": "<p>Ah, I see</p>",
        "id": 563633691,
        "sender_full_name": "Ayhon",
        "timestamp": 1765644968
    },
    {
        "content": "<p>It looks to me like grind's normalization is actually hindering us, instead of helping, but maybe it's because we're using grind wrong?</p>",
        "id": 563633721,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765644996
    },
    {
        "content": "<p>A friend suggested that I'd probably want to use <code>gring_pattern</code> constraints, probably <code>guard</code>.<br>\n<a href=\"https://github.com/leanprover/lean4/blob/38c401cf3bd02d1ebf7dcf134f941aee08fbc2db/src/Lean/Meta/Tactic/Grind/Parser.lean#L108\">https://github.com/leanprover/lean4/blob/38c401cf3bd02d1ebf7dcf134f941aee08fbc2db/src/Lean/Meta/Tactic/Grind/Parser.lean#L108</a></p>",
        "id": 563633888,
        "sender_full_name": "Ayhon",
        "timestamp": 1765645157
    },
    {
        "content": "<p>Hmm, that could work.</p>",
        "id": 563634049,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765645305
    },
    {
        "content": "<p>Not available in 4.26 though :/</p>",
        "id": 563634117,
        "sender_full_name": "Ayhon",
        "timestamp": 1765645370
    },
    {
        "content": "<p>You can test Lean nightly at <a href=\"https://live.lean-lang.org/#project=lean-nightly&amp;codez=C4Cwpg9gTmC2AEAzCEAUBDeAjAXPAkgHbACUemAPNvIEmE8AxhLAA7ozyZbwC88AdABtg8HLywBPeAHMoAS0IATeAG0iwPoxZswAfTABHHUIC6AKFMBnMMB0RmwWRELxgUdPTB8Z8hXzjpgehA+eQtgdEIPFygAVzBzAQh6dAFpOUUdVmBgMChnZAgeAD4GJlZ2TngAd3AYU3hpGLYlSmxzMAAPdBYBMFRCPDUyeGcqAAZaUq12ZwneQWFRbHF6tJ94AFoN+AAxdFkBGLqgA\">https://live.lean-lang.org/#project=lean-nightly&amp;codez=C4Cwpg9gTmC2AEAzCEAUBDeAjAXPAkgHbACUemAPNvIEmE8AxhLAA7ozyZbwC88AdABtg8HLywBPeAHMoAS0IATeAG0iwPoxZswAfTABHHUIC6AKFMBnMMB0RmwWRELxgUdPTB8Z8hXzjpgehA+eQtgdEIPFygAVzBzAQh6dAFpOUUdVmBgMChnZAgeAD4GJlZ2TngAd3AYU3hpGLYlSmxzMAAPdBYBMFRCPDUyeGcqAAZaUq12ZwneQWFRbHF6tJ94AFoN+AAxdFkBGLqgA</a> by switching to nightly in the upper-right corner.</p>",
        "id": 563634321,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765645560
    },
    {
        "content": "<p>Notice, how this fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_lt</span><span class=\"o\">]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"bp\">.</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">example</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"c1\">-- Failure</span>\n</code></pre></div>\n<p>While this doesn't:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_lt</span><span class=\"o\">]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"bp\">.</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">example</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n</code></pre></div>",
        "id": 563634422,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765645668
    },
    {
        "content": "<p>Hmm, :/</p>",
        "id": 563634452,
        "sender_full_name": "Ayhon",
        "timestamp": 1765645709
    },
    {
        "content": "<p>I think that's good and what you expected? In the first case <code>grind</code> didn't finish the proof, because it never tried to use <code>foo</code>. The <code>guard a &lt; b</code> prevented it from using it.</p>",
        "id": 563634516,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765645778
    },
    {
        "content": "<p>Oh, my bad! I hadn't noticed how you changed the <code>example</code>s (tbh, I was checking your messages while playing factorio, I have stopped now and I could look at it with more pause)</p>",
        "id": 563634638,
        "sender_full_name": "Ayhon",
        "timestamp": 1765645914
    },
    {
        "content": "<p>Yeah, that's a bit what I was expecting my <code>multi-patterns</code> to achieve</p>",
        "id": 563634657,
        "sender_full_name": "Ayhon",
        "timestamp": 1765645929
    },
    {
        "content": "<p>Ah, sorry, I forgot to also mention, that it works with your original example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_lt</span><span class=\"o\">]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"bp\">.</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">example</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n</code></pre></div>",
        "id": 563634730,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765645989
    },
    {
        "content": "<p>So I guess then that what the <code>guard</code> enables you to do is handle the problem of <code>grind</code> normalizing expressions a bit more gracefully.</p>",
        "id": 563634751,
        "sender_full_name": "Ayhon",
        "timestamp": 1765646003
    },
    {
        "content": "<p>It can't prove this though:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_lt</span><span class=\"o\">]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"bp\">.</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">example</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"c1\">-- Failure</span>\n</code></pre></div>\n<p>So I'm guessing that grind doesn't make any special effort to try and prove the guard expression?</p>",
        "id": 563634892,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765646133
    },
    {
        "content": "<p>Hmm, interesting</p>",
        "id": 563634938,
        "sender_full_name": "Ayhon",
        "timestamp": 1765646205
    },
    {
        "content": "<p>Ah, wait, no, it's me being dumb, that example was just false. This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_lt</span><span class=\"o\">]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"bp\">.</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">grind_pattern</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">example</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">compare</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n</code></pre></div>",
        "id": 563635058,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1765646352
    },
    {
        "content": "<p>A theorem being false is a common cause for it being hard to prove</p>",
        "id": 563641175,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1765653278
    },
    {
        "content": "<p>I would even argue \"the most common\"</p>",
        "id": 563641228,
        "sender_full_name": "Ayhon",
        "timestamp": 1765653322
    }
]