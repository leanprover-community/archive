[
    {
        "content": "<p>A very strange thing is happening here:</p>\n<p><a href=\"https://github.com/FredericLeRoux/LEAN_ESPACES_METRIQUES/blob/master/esp_metrique.lean#L96\" title=\"https://github.com/FredericLeRoux/LEAN_ESPACES_METRIQUES/blob/master/esp_metrique.lean#L96\">https://github.com/FredericLeRoux/LEAN_ESPACES_METRIQUES/blob/master/esp_metrique.lean#L96</a></p>\n<p>The current proof ends with linarith, and it works. But then let's replace line 96,<br>\n<code> have clef : d x z ≤ d x y + d y z, from triangle x y z</code><br>\nwith the less explicit<br>\n<code> have clef, from triangle x y z</code><br>\nLean's answer to this line does not change, as expected. So the context at line 96, after this change, seems to be as before.<br>\nBut now the linarith tactic at the next line fails!</p>",
        "id": 196951550,
        "sender_full_name": "Frédéric Le Roux",
        "timestamp": 1588972491
    },
    {
        "content": "<p>Did you try looking at this with <code>set_option pp.all true</code>?</p>",
        "id": 196952394,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1588973069
    },
    {
        "content": "<p>Probably it adds <code>dist x z ≤ dist x y + dist y z</code> with a metavariable instead of an instance for <code>metric_space</code>.</p>",
        "id": 196952461,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1588973120
    },
    {
        "content": "<p>So I tried pp.all. Both lines give exactly the same result:<br>\n<code>clef :\n  @has_le.le.{0} real real.has_le (@espace_metrique.dist X _inst_1 x z)\n    (@has_add.add.{0} real (@distrib.to_has_add.{0} real (@ring.to_distrib.{0} real real.ring))\n       (@espace_metrique.dist X _inst_1 x y)\n       (@espace_metrique.dist X _inst_1 y z))</code><br>\n<code>clef2 :\n  @has_le.le.{0} real real.has_le (@espace_metrique.dist X _inst_1 x z)\n    (@has_add.add.{0} real (@distrib.to_has_add.{0} real (@ring.to_distrib.{0} real real.ring))\n       (@espace_metrique.dist X _inst_1 x y)\n       (@espace_metrique.dist X _inst_1 y z))</code></p>",
        "id": 196954447,
        "sender_full_name": "Frédéric Le Roux",
        "timestamp": 1588974560
    },
    {
        "content": "<p>Then you need a better expert on Lean internals.</p>",
        "id": 196954624,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1588974679
    },
    {
        "content": "<p><code>have clef := triangle x y z, </code> works, but <code>have clef, from triangle x y z, </code> fails</p>",
        "id": 196955186,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1588975066
    },
    {
        "content": "<p>You can by the way change the <code>linarith</code> to:</p>\n<div class=\"codehilite\"><pre><span></span><code>    <span class=\"n\">linarith</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">triangle</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"o\">,</span> <span class=\"n\">z_in</span><span class=\"o\">,</span> <span class=\"n\">y_in</span><span class=\"o\">,</span> <span class=\"n\">hε</span><span class=\"o\">]</span> <span class=\"o\">}</span>\n</code></pre></div>\n\n\n<p>which works fine</p>",
        "id": 196955437,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1588975217
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code><span class=\"bp\">...</span>\n    <span class=\"k\">have</span> <span class=\"n\">clef</span><span class=\"o\">,</span> <span class=\"k\">from</span> <span class=\"n\">triangle</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">clef2</span> <span class=\"o\">:=</span> <span class=\"n\">triangle</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"o\">,</span>\n    <span class=\"k\">have</span> <span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">clef</span> <span class=\"bp\">=</span> <span class=\"n\">clef2</span> <span class=\"o\">:=</span> <span class=\"n\">rfl</span><span class=\"o\">,</span>\n<span class=\"c1\">--    linarith only [clef, z_in, y_in, hε], -- fails!</span>\n    <span class=\"n\">linarith</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">clef2</span><span class=\"o\">,</span> <span class=\"n\">z_in</span><span class=\"o\">,</span> <span class=\"n\">y_in</span><span class=\"o\">,</span> <span class=\"n\">hε</span><span class=\"o\">],</span> <span class=\"c1\">-- works</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n\n\n<p>This is surprising (to me). With pp.all on true, clef and clef2 are identical (indeed the prettyprinter is telling me they have the same type)</p>",
        "id": 196955489,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1588975255
    },
    {
        "content": "<p>I think the <code>rfl</code> is doing some simplifications/unfolding to prove the equality, but <code>linarith</code> doesn't perform these; and the clef (in Kevin's code) has something folded differently to what the <code>linarith</code> wants</p>",
        "id": 196955671,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1588975365
    },
    {
        "content": "<p>And this also explains why <code>pp.all</code> thinks the terms are the same</p>",
        "id": 196955712,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1588975393
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>clef clef2 : d x z ≤ d x y + d y z,\nh : clef = clef2\n⊢ d x z &lt; r\n</code></pre></div>",
        "id": 196955760,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1588975433
    },
    {
        "content": "<p>Where's that Mario super-pp-all code?</p>",
        "id": 196955812,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1588975455
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code><span class=\"bp\">...</span>\n    <span class=\"k\">have</span> <span class=\"n\">clef</span><span class=\"o\">,</span> <span class=\"k\">from</span> <span class=\"n\">triangle</span> <span class=\"n\">x</span> <span class=\"n\">y</span> <span class=\"n\">z</span><span class=\"o\">,</span>\n    <span class=\"n\">simp</span> <span class=\"n\">only</span> <span class=\"o\">[]</span> <span class=\"n\">at</span> <span class=\"n\">clef</span><span class=\"o\">,</span>\n    <span class=\"n\">linarith</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">clef</span><span class=\"o\">,</span> <span class=\"n\">z_in</span><span class=\"o\">,</span> <span class=\"n\">y_in</span><span class=\"o\">,</span> <span class=\"n\">hε</span><span class=\"o\">]}</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n\n\n<p>works as well, showing that there is something to simplify in the term, and it's this simplification that makes it work</p>",
        "id": 196955882,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1588975524
    }
]