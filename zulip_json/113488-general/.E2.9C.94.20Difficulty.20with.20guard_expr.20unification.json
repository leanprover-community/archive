[
    {
        "content": "<p>I hope I don't sound like a broken record, but I have yet another issue with proof automation and unification. In this case I'm trying to use <code>guard_expr</code> to isolate a particular goal in a proof, but I can't seem to get the types to unify. Here's a MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">([]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>The issue here is that the fold accumulator is a function, and it seems like type inference can't figure that out. I had hoped this would work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">([]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">foldr</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>but now the universes won't unify.</p>\n<p>I don't mind enforcing that everything live in <code>Type</code>, but I'm not actually sure how to annotate that (or if I can). Any advice?</p>\n<p>(I realize I could just drop into an elaborator tactic and guard_expr instead—maybe that's the recommended solution? But I'm a little surprised I can't make this work.)</p>",
        "id": 527312243,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1751761202
    },
    {
        "content": "<p><code>guard_target</code> is more a tool for writing tests for metaprogramming. Is that what you are trying to do? Or is <code>change</code> (change the first goal by unification) or <code>show</code> (pick a goal by unification) what you really want to use?</p>",
        "id": 527328314,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1751785321
    },
    {
        "content": "<p>Yes sorry. My initial explanation wasn’t clear. Specifically I’m trying to apply some tactics, but only if the goal isn’t of the shape I gave in the guard. My current approach is <code>fail_if_success (guard_expr …)</code>, but right now the guard is just always failing because it can’t unify the types.</p>",
        "id": 527348234,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1751809756
    },
    {
        "content": "<p>Hmm, interesting, haven’t seen that trick before.  Is it that you are trying to apply Ltac-inspired idioms here? (Can’t blame you, I haven't fully understood yet why the Ltac-idiom of conveniently expressing “if goal matches X then do Y” somehow isn't in great demand in the Lean world.)</p>\n<p>Still, does it work differently with <code>change</code>?</p>",
        "id": 527354410,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1751816310
    },
    {
        "content": "<p>Huh. <code>change</code> seems to do it. That's fascinating. OK!</p>\n<p>Yes, I suppose this is an Ltac idiom, but as you say, it seems like a pretty natural thing to want for proof automation. Otherwise you're stuck exploring unnecessary paths.</p>",
        "id": 527358459,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1751820523
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"686704\">Harry Goldstein</span> has marked this topic as resolved.</p>",
        "id": 527358465,
        "sender_full_name": "Notification Bot",
        "timestamp": 1751820531
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 527358474,
        "sender_full_name": "Harry Goldstein",
        "timestamp": 1751820540
    },
    {
        "content": "<p>I guess <code>change</code> is a strange name for your use case. It’s justified in the sense that after <code>change e</code> the goal is changed to <code>e</code> – but only if that’s defeq to the current goal. So you can use it to check for defeqness.</p>",
        "id": 527372432,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1751835112
    },
    {
        "content": "<p>It may be a bug that <code>guard_targte</code> doesn’t work as well, maybe it elaborates its argument differently, but since it's not really meant for that kind of task, I wouldn’t bother</p>",
        "id": 527372488,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1751835171
    }
]