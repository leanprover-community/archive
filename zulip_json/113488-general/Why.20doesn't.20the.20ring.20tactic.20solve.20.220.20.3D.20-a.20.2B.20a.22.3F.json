[
    {
        "content": "<p>I was doing the following exercise in section 2.5 of \"Mathematics in Lean:</p>\n<p><a href=\"/user_uploads/3121/FSfV9F1SrxCsGMZnfi02xLz8/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/FSfV9F1SrxCsGMZnfi02xLz8/image.png\" title=\"image.png\"><img data-original-dimensions=\"435x148\" src=\"/user_uploads/thumbnail/3121/FSfV9F1SrxCsGMZnfi02xLz8/image.png/840x560.webp\"></a></div><p>To my surprise, I found that the ring tactic does not solve the equalities at either step 1 or step 3.  Why is that so?</p>\n<p>The following is the context of this exercise:</p>\n<p><a href=\"/user_uploads/3121/VvdKMOgL5tBnehuKj9yCFsMB/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/VvdKMOgL5tBnehuKj9yCFsMB/image.png\" title=\"image.png\"><img data-original-dimensions=\"382x46\" src=\"/user_uploads/thumbnail/3121/VvdKMOgL5tBnehuKj9yCFsMB/image.png/840x560.webp\"></a></div>",
        "id": 480365588,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730694318
    },
    {
        "content": "<p>Because you are working in <code>Nat</code>, which is a semiring not a ring.</p>",
        "id": 480365909,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730694511
    },
    {
        "content": "<p>Try <code>omega</code> instead.</p>",
        "id": 480365920,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730694526
    },
    {
        "content": "<p>Why am I working in Nat?  The variables an and b are of type R, which is a StrictOrderedRing.</p>",
        "id": 480366005,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730694600
    },
    {
        "content": "<p>Please use a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>, not a screenshot.</p>",
        "id": 480366081,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730694627
    },
    {
        "content": "<p>(Looking at your first screenshot there is no information about where the variables live.)</p>",
        "id": 480366102,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730694651
    },
    {
        "content": "<p>Here is a MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Delaborators</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">MetricSpace</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">StrictOrderedRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"c1\">--  sorry</span>\n<span class=\"w\"> </span><span class=\"k\">calc</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_le_add_left</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">sub_eq_add_neg</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">end</span>\n</code></pre></div>",
        "id": 480366893,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730695352
    },
    {
        "content": "<p>My question is: why doesn't the ring tactic solve steps 1 and 3?</p>",
        "id": 480366918,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730695380
    },
    {
        "content": "<p>Not your question, but</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Delaborators</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">MetricSpace</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">StrictOrderedRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"c1\">--  sorry</span>\n<span class=\"w\"> </span><span class=\"k\">calc</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">abel</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_le_add_left</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">abel</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">abel</span>\n\n<span class=\"kn\">end</span>\n</code></pre></div>\n<p>does work.</p>",
        "id": 480366967,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730695433
    },
    {
        "content": "<p>That's a good point.  But since a ring's + operation forms an abelian group, shouldn't the ring tactic be able to solve  such goals as well?</p>",
        "id": 480367257,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730695680
    },
    {
        "content": "<p><code>ring</code> likes <em>commutative</em> rings (I'm just copying the italics from the documentation when you hover over <code>ring</code>, it was a good reminder, since this example was puzzling me). Changing it to <code>StrictOrderedCommRing</code> makes it work.</p>",
        "id": 480367948,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730696262
    },
    {
        "content": "<p>Well, I tried noncomm_ring.  It worked at step 3 but still fails at step 1.</p>",
        "id": 480368104,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730696390
    },
    {
        "content": "<p>In fact, noncomm_ring cannot prove \"a = a + 0\", either.</p>",
        "id": 480368317,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730696515
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110637\">Ching-Tsun Chou</span> <a href=\"#narrow/channel/113488-general/topic/Why.20doesn't.20the.20ring.20tactic.20solve.20.220.20.3D.20-a.20.2B.20a.22.3F/near/480368317\">said</a>:</p>\n<blockquote>\n<p>In fact, noncomm_ring cannot prove \"a = a + 0\", either.</p>\n</blockquote>\n<p>This is probably irrelevant, but out of my curiosity -- how does Lean know here the 0 is the additive identity for R and not Nat/Int etc? It is inferred correctly from the type of a?</p>",
        "id": 480368976,
        "sender_full_name": "Yan Yablonovskiy",
        "timestamp": 1730697111
    },
    {
        "content": "<p>If you hover over <code>0</code> in the Infoview, you can see it's actually the more complicated <code>@OfNat.ofNat R 0 Zero.toOfNat0</code> expression that says in which way <code>0 : Nat</code> should be interpreted as an element of <code>R</code>.</p>",
        "id": 480369060,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730697171
    },
    {
        "content": "<p>It's a consequence of the elaboration process, where it does in this case get the type for the right-hand operand of <code>+</code> from the left-hand <code>a</code></p>",
        "id": 480369097,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730697222
    },
    {
        "content": "<p>Worse <span class=\"user-mention\" data-user-id=\"110637\">@Ching-Tsun Chou</span> , <code>noncomm_ring</code> doesn't work on that example even for commutative rings.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">noncomm_ring</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 480369190,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730697301
    },
    {
        "content": "<p>Though if you follow its suggestion to use <code>abel</code> it does work.</p>",
        "id": 480369296,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730697394
    },
    {
        "content": "<p>Good to know the idiosyncrasies of these tactics.</p>",
        "id": 480369719,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730697831
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110637\">Ching-Tsun Chou</span> <a href=\"#narrow/channel/113488-general/topic/Why.20doesn't.20the.20ring.20tactic.20solve.20.220.20.3D.20-a.20.2B.20a.22.3F/near/480368317\">said</a>:</p>\n<blockquote>\n<p>In fact, noncomm_ring cannot prove \"a = a + 0\", either.</p>\n</blockquote>\n<p>That sounds like a bug to me.</p>",
        "id": 480384990,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730706699
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">noncomm_ring</span>\n</code></pre></div>\n<p>prints \"Try <code>abel</code> instead\", so I think it is working fine.</p>",
        "id": 480391888,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730709556
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> , I don't quite understand your comment.  Are you saying that noncomm_ring is not supposed to work on \"a + 0 = a\"?  What exactly is noncomm_ring supposed to be capable of solving?<br>\nFurthermore, it seems that noncomm_ring \"knows\" that abel may work.  Why doesn't it just try it?<br>\nSorry for my naïveté.  I am a new user.</p>",
        "id": 480480827,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730737391
    },
    {
        "content": "<p>(these are good questions, don't worry!)</p>",
        "id": 480491756,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1730740936
    },
    {
        "content": "<p>I think the general design principle here is that if an \"expensive\" tactic notices that a \"cheap\" tactic suffices, it should work, but print a warning suggesting that you change the tactic script (e.g. how <code>simpa using X</code> suggests <code>simp</code> if it closes the goal without using <code>X</code>).</p>\n<p>Here, I think <code>noncomm_ring</code> should be printing a warning, not an error (PR very welcome!)</p>",
        "id": 480554472,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730768364
    },
    {
        "content": "<p>That said, <code>noncomm_ring</code> is not particular expensive, so I guess we could just let it run. I would be a little sad to end up with a whole lot of <code>noncomm_ring</code> proofs in Mathlib where <code>abel</code> would suffice.</p>",
        "id": 480554572,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730768409
    },
    {
        "content": "<p>I think we should write a <code>algebra?</code> tactic that tries all of <code>ring</code>, <code>noncomm_ring</code>, <code>module</code>, <code>abel</code>, etc, and reports the first one that closes the goal!</p>",
        "id": 480554669,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730768444
    },
    {
        "content": "<p>(PR welcome! :-)</p>",
        "id": 480554719,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730768462
    },
    {
        "content": "<p>Thanks for the explanation!  Unfortunately, I'm still a beginner and do not know how to write tactics yet.</p>",
        "id": 480578475,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730783533
    },
    {
        "content": "<p>Is there a combinator of some kind that can take a list of tactics and try them one by one until either one of them succeeds or none succeeds and a failure is declared?</p>",
        "id": 480578834,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730783794
    },
    {
        "content": "<p>Yes, indeed there is. It's called <code>first</code>. See for example Mathlib/Tactic/Ring/RingNF.lean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ring1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">try_this</span><span class=\"w\"> </span><span class=\"n\">ring_nf</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- line 261</span>\n</code></pre></div>",
        "id": 480580868,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730785089
    },
    {
        "content": "<p>Thanks for the pointer!</p>",
        "id": 480581318,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1730785432
    }
]