[
    {
        "content": "<p>I have a new mac laptop with an M4 Pro and 48 GB of memory. I also have an old but fast desktop running Ubuntu 24.04. I haven't updated mathlib for a while on either machine. So on both machines I did the following<br>\n(I'm on <code>master</code> in both, but behind):</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"nb\">cd</span><span class=\"w\"> </span>Mathlib\ngit<span class=\"w\"> </span>pull\nrm<span class=\"w\"> </span>-rf<span class=\"w\"> </span>.lake\nlake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get!\n<span class=\"nb\">time</span><span class=\"w\"> </span>lake<span class=\"w\"> </span>build\n<span class=\"nb\">time</span><span class=\"w\"> </span>lake<span class=\"w\"> </span>build\n<span class=\"nb\">time</span><span class=\"w\"> </span>lake<span class=\"w\"> </span>build\n</code></pre></div>\n<p>Obviously getting cache takes time because I removed .lake so I need to download everything; I only did this in an attempt to make sure I had a level playing field. But I don't care how long getting cache takes -- I care how long building takes. Here are the results.</p>\n<p>Ubuntu:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@brutus:~/Mathlib$ time lake build\nBuild completed successfully (7239 jobs).\n\nreal    0m2.911s\nuser    0m3.183s\nsys 0m0.559s\nbuzzard@brutus:~/Mathlib$ time lake build\nBuild completed successfully (7239 jobs).\n\nreal    0m1.939s\nuser    0m2.046s\nsys 0m0.522s\nbuzzard@brutus:~/Mathlib$ time lake build\nBuild completed successfully (7239 jobs).\n\nreal    0m1.549s\nuser    0m1.765s\nsys 0m0.460s\nbuzzard@brutus:~/Mathlib$\n</code></pre></div>\n<p>In practice it takes under 2 seconds to complete <code>lake build</code> on the Ubuntu machine.</p>\n<p>Here are the resuts for the expensive mac which I bought specifically to do Lean quickly:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  2.05s user 2.82s system 36% cpu 13.487 total\nbuzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  3.50s user 7.46s system 23% cpu 46.271 total\nbuzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  3.79s user 8.14s system 22% cpu 52.483 total\nbuzzard@IC-HWDXTW69VR Mathlib %\n</code></pre></div>\n<p>So in practice it takes well over 30 seconds to compile mathlib on the mac, even though we've just compiled it. Sometimes there can be a very long pause before anything happens, and then a very long wait on <code>⣯ [0/0] Running job computation (+ 0 more)</code> and then a slowish count to 7000.</p>\n<p>I then wrote this message and then went back to the mac and did <code>time lake build</code> again. </p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  1.92s user 2.45s system 138% cpu 3.156 total\nbuzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  1.92s user 2.52s system 138% cpu 3.205 total\nbuzzard@IC-HWDXTW69VR Mathlib %\n</code></pre></div>\n<p>Now it's compiling in 3 seconds.</p>\n<p>I then realised that I wanted to include the line which the mac stopped on in this message so I typed <code>time lake build</code> and after a second I hit ctrl-C so I could copy <code>⣯ [0/0] Running job computation</code> into this message.</p>\n<p>I then compiled again and we're back to 51 seconds.</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@IC-HWDXTW69VR Mathlib % time lake build\n⣯ [0/0] Running job computation (+ 0 more)^C\nlake build  0.25s user 0.50s system 64% cpu 1.153 total\nbuzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  3.67s user 7.61s system 22% cpu 51.250 total\nbuzzard@IC-HWDXTW69VR Mathlib %\n</code></pre></div>\n<p>What is going on and how do I make it stop?</p>",
        "id": 540437354,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1758283069
    },
    {
        "content": "<p>Huh, I waited for 15 minutes and then tried again.</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  3.46s user 7.10s system 20% cpu 51.025 total\nbuzzard@IC-HWDXTW69VR Mathlib % time lake build\nBuild completed successfully (7239 jobs).\nlake build  1.92s user 2.44s system 133% cpu 3.257 total\nbuzzard@IC-HWDXTW69VR Mathlib %\n</code></pre></div>\n<p>After the pause, again I'm on nearly a minute compiling mathlib the first time, and then 3 seconds the second time. Note that I didn't do anything with mathlib in the interim. Note also that even when it's not misbehaving I am consistently under 2 seconds in Ubuntu and consistently over 3 seconds on the mac (but this is not something I'm particularly fussed about, it's the 51 second runs which annoy me).</p>",
        "id": 540442459,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1758284626
    },
    {
        "content": "<p>Does your Mac have any antivirus software? ( I was having some slowdowns then realised the other day that mine had stupid windows defender since it's managed by my uni).</p>",
        "id": 540445825,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1758285659
    },
    {
        "content": "<p>It feels like macOS may be overeager at discarding the file system cache? Linux is usually happy to use any unused RAM for such purposes</p>",
        "id": 540445857,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1758285672
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"389019\">Chris Birkbeck</span> <a href=\"#narrow/channel/113488-general/topic/building.20mathlib.20on.20ubuntu.20v.20mac/near/540445825\">said</a>:</p>\n<blockquote>\n<p>Does your Mac have any antivirus software? ( I was having some slowdowns then realised the other day that mine had stupid windows defender since it's managed by my uni).</p>\n</blockquote>\n<p>I don't know, I personally didn't put any antivirus software on it but this is a work laptop and it went through someone else before it got to me.</p>",
        "id": 540447022,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1758286005
    },
    {
        "content": "<p>If you are in the UK I am guessing  they still push Sophos onto uni machines</p>",
        "id": 540508900,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1758304758
    },
    {
        "content": "<p>Performance of this is comparable natively on my Mac and in the Ubuntu VM sitting on it.</p>",
        "id": 540583251,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1758372312
    },
    {
        "content": "<p>How much RAM do you have on the Ubuntu machine?</p>",
        "id": 540592526,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1758381647
    },
    {
        "content": "<p>I want to come back to this. Yesterday I checked out the same commit of mathlib on my 5 year old desktop and my new mac. I ran <code>lake exe cache get</code> and then <code>lake build</code> on the command line, left everything to complete, and then I left both command line windows open for 24 hours. </p>\n<p>I then came back to the windows and typed <code>lake build</code> again. </p>\n<p>Here's the output on the ubuntu machine:</p>\n<p><a href=\"/user_uploads/3121/dRxIdWFfnIys580XbjSO-TOJ/ubuntu.gif\">ubuntu.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/dRxIdWFfnIys580XbjSO-TOJ/ubuntu.gif\" title=\"ubuntu.gif\"><img data-animated=\"true\" data-original-content-type=\"image/gif\" data-original-dimensions=\"1628x999\" src=\"/user_uploads/thumbnail/3121/dRxIdWFfnIys580XbjSO-TOJ/ubuntu.gif/840x560-anim.webp\"></a></div><p>1) Immediately goes to \"running job computation\"<br>\n2) two seconds later, starts counting to 7442 very quickly<br>\n3) gets there about 4 seconds later<br>\n4) one last second on \"Running mathlib/Mathlib.default\"</p>\n<p>Total time around 7 seconds.</p>\n<p>[now give me a second while I switch machines]</p>",
        "id": 548097946,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761898431
    },
    {
        "content": "<p>Here's what happens if I do exactly the same thing on the mac.</p>\n<p><a href=\"/user_uploads/3121/pOIxKZLKKlB2TUo5xV27v8lr/slow_on_mac.gif\">slow_on_mac.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/pOIxKZLKKlB2TUo5xV27v8lr/slow_on_mac.gif\" title=\"slow_on_mac.gif\"><img data-animated=\"true\" data-original-content-type=\"image/gif\" data-original-dimensions=\"1713x929\" src=\"/user_uploads/thumbnail/3121/pOIxKZLKKlB2TUo5xV27v8lr/slow_on_mac.gif/840x560-anim.webp\"></a></div><p>1) Literally nothing happens (no output, no info) for around ten seconds (note that the Ubuntu machine finishes the entire job in under ten seconds)<br>\n2) \"Running job computation\" for maybe 20+ seconds.<br>\n3) Counts to 7442 over a period of about ten seconds.</p>\n<p>Total time 46 seconds.</p>\n<p>Is there something wrong with my set-up or are all mac users in this hell?</p>",
        "id": 548099202,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761898910
    },
    {
        "content": "<p>Specs: the Ubuntu machine is a 5 year old standard desktop with 32 gigs of ram; the mac is an M4 pro with 48 gigs of ram.</p>",
        "id": 548099490,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761899012
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/113488-general/topic/building.20mathlib.20on.20ubuntu.20v.20mac/near/540583251\">said</a>:</p>\n<blockquote>\n<p>Performance of this is comparable natively on my Mac and in the Ubuntu VM sitting on it.</p>\n</blockquote>\n<p>So you're saying that this is something I just have to live with? I am now really regretting following the \"just buy an expensive mac\" suggestion when I asked for a fast laptop for Lean. I know that mac users all love their machines and I want to love my machine but it is such a step down from Ubuntu in practice when I'm working on FLT. I will do another experiment involving VS Code and post again in about 12 hours because I think there's another instance when I am seeing huge performance degradation on my laptop v desktop.</p>",
        "id": 548100261,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761899300
    },
    {
        "content": "<p>FWIW this was on mathlib commit <code>b8aaf14a892866ba8333faac94f658b9dc557afa</code></p>",
        "id": 548100559,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761899417
    },
    {
        "content": "<p>I spend a surprisingly large amount of time doing Lean with poor or no internet; the more internet I have, the more people are asking me to do things. However I am very much open to running some VM; I had naturally assumed that any attempt to emulate another OS would obviously come with a performance hit but maybe I am out of date here?</p>",
        "id": 548101627,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761899778
    },
    {
        "content": "<p>I just ran this on my mac (which is slightly older than yours) and got <code>lake build  8.97s user 2.65s system 418% cpu 2.774 total</code></p>",
        "id": 548110490,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1761902687
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113488-general/topic/building.20mathlib.20on.20ubuntu.20v.20mac/near/548099202\">said</a>:</p>\n<blockquote>\n<p>Is there something wrong with my set-up or are all mac users in this hell?</p>\n</blockquote>\n<p>I am not in that hell. Where did <code>my_venv</code> come from?</p>",
        "id": 548111316,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1761902887
    },
    {
        "content": "<p>Yes the venv is what I am wondering about as well</p>",
        "id": 548111427,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1761902914
    },
    {
        "content": "<p>Until Apple brings its M series virtualization to the iPad <span aria-label=\"prayer beads\" class=\"emoji emoji-1f4ff\" role=\"img\" title=\"prayer beads\">:prayer_beads:</span>, I’m rocking a 5 year old M series MacBook Pro to compare</p>",
        "id": 548112071,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1761903089
    },
    {
        "content": "<p>Kevin it is possible that your employer  updated your software including the antivirus which also probably reset the firewall settings</p>",
        "id": 548112095,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761903096
    },
    {
        "content": "<p>Also I think that venv comes from trying to run  blueprint</p>",
        "id": 548112483,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761903226
    },
    {
        "content": "<p>I’d suggest deactivating it anyway before a test.</p>",
        "id": 548112576,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761903265
    },
    {
        "content": "<p>Yes the my_venv is so I can use lean blueprint. <span class=\"user-mention\" data-user-id=\"389019\">@Chris Birkbeck</span> what happens if you wait an hour and then try again?</p>",
        "id": 548112748,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761903327
    },
    {
        "content": "<p>Lets find out.</p>",
        "id": 548113009,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1761903401
    },
    {
        "content": "<p>For me the second <code>lake build</code> is fast if it's just after the first one, but slow if I leave it a while</p>",
        "id": 548113076,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761903423
    },
    {
        "content": "<p>Well, as a check I just tried this on some repos I've not touched in a few days, and its still takes around the same time. The one I ran above was for just basic mathlib, so I'll try that one later and see.</p>",
        "id": 548114375,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1761903861
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113488-general/topic/building.20mathlib.20on.20ubuntu.20v.20mac/near/548113076\">said</a>:</p>\n<blockquote>\n<p>For me the second <code>lake build</code> is fast if it's just after the first one, but slow if I leave it a while</p>\n</blockquote>\n<p>were you working without cache the first time?</p>",
        "id": 548115425,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761904200
    },
    {
        "content": "<p>As in, fetching cache?</p>",
        "id": 548115463,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1761904210
    },
    {
        "content": "<p>ohnonono, I started by fetching cache. I am always running <code>lake build</code> on a project with all oleans present and correct. It's not <code>my_venv</code> (thank goodness, because I don't want to go without leanproject). </p>\n<p>I do have some Imperial-related crapware running, I will try and figure out how to remove it. I am very mac-ignorant, I think I'll do this and then come back here, but I need to worry about the 2 talks I'm giving today first so it'll have to be the weekend.</p>",
        "id": 548116217,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761904450
    },
    {
        "content": "<p>So about an hour later : <code>Build completed successfully (7454 jobs).\nlake build  7.21s user 6.47s system 341% cpu 4.007 total</code> maybe a tiny bit slower but might just be more things open. Definitely not like what you see.</p>",
        "id": 548123051,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1761906681
    },
    {
        "content": "<p>I noticed that there was a factor-10 difference in the unpacking step, too.</p>",
        "id": 548124407,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1761907135
    },
    {
        "content": "<p>So thanks to everyone who helped. After discussion with Chris Birkbeck both here and at LLL yesterday I decided that it was the crapware on the machine that was probably the problem, and given that I don't use it for anything other than Lean and everything is backed up, I decided today to just factory reset the machine and not install the crapware (in fact I was quite surprised that I'd chosen to install any crapware the first time I set it up).</p>\n<p>However it turned out to be not as easy as that. Imperial did buy this mac for me, and after the factory reset I got a popup saying \"Remote Management: This Mac is owned by Imperial College London, remote management is required\" (which is fair enough) and then I got a popup telling me that Microsoft 365, Microsoft Defender, Company Portal and Jamf Connect were going to be installed. I think Jamf connect is just doing some password management thing, and I can confirm that after just reinstalling VS Code, git and lean, I still have the same problem: \"lake build\" on mathlib is 10 seconds of no output, 20 seconds of \"[0/0] Running job computation (+ 0 more)\" and then back to normality, with a further immediate \"lake build\" being completely normal (just a few seconds) and then a third \"lake build\" five minutes later being back to being ridiculously slow.</p>\n<p>I suspect that uninstalling <del>Windows</del>Microsoft Defender is not going to be possible so I might now have to take this up with Imperial IT.</p>",
        "id": 548312206,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762007254
    },
    {
        "content": "<p>FYI if you have admin rights you can uninstall windows defender but it's not straightforward...</p>",
        "id": 548312313,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1762007387
    },
    {
        "content": "<p>I assume it's not <em>Windows</em> Defender since you're on a mac</p>",
        "id": 548312946,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1762007959
    },
    {
        "content": "<p>Well my uni did install windows defender on my Mac!</p>",
        "id": 548313010,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1762008011
    },
    {
        "content": "<p>Indeed it is called \"Microsoft Defender\".</p>",
        "id": 548313777,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762008726
    },
    {
        "content": "<p>Oh lol sure maybe is was \"Microsoft\" defender. What I noticed was that something called <code>wdavdaemon</code> was using up lots of my CPU which annoyed me and it turned out to be this.</p>",
        "id": 548313941,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1762008893
    },
    {
        "content": "<p>You can’t get rid of that managed software thing without Imperial’s IT people supporting you.</p>",
        "id": 548316467,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762010774
    },
    {
        "content": "<p>They’d basically have to agree to not have any oversight over the laptop which most orgs in the English speaking world won’t permit</p>",
        "id": 548316816,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762011008
    },
    {
        "content": "<p>Can you open Microsoft Defender and tell it not to scan your project directory? On windows, this makes a huge difference.</p>",
        "id": 548316950,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1762011110
    },
    {
        "content": "<p>I'm also reminded of this gotcha on mac (related to code signing): <a href=\"https://nnethercote.github.io/2025/09/04/faster-rust-builds-on-mac.html\">https://nnethercote.github.io/2025/09/04/faster-rust-builds-on-mac.html</a></p>",
        "id": 548326421,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762019312
    },
    {
        "content": "<p>Perhaps that's not relevant here/ perhaps it only becomes relevant if you need to compile the cache executable...</p>",
        "id": 548326477,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762019358
    },
    {
        "content": "<p>(Another very random Mac performance fact: are you charging your mac <a href=\"https://www.digitaltrends.com/computing/why-you-shouldnt-charge-macbook-pro-left-side/\">from the left</a>?)</p>",
        "id": 548326580,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762019449
    },
    {
        "content": "<p>I realise that these might not be related to the issue you're reporting, Kevin --- but they might be useful to know regardless.</p>",
        "id": 548326697,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762019558
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Do you think detecting if Gatekeeper (more precisely, XProtect) is enabled on mac and warning about this could be a useful thing for lake to do? Does lake create new executables (for lake exe cache, lake test, etc.) often enough for this to be worth it? See e.g. <a href=\"https://nnethercote.github.io/2025/09/04/faster-rust-builds-on-mac.html\">this post</a> for some detail what I'm talking about.</p>\n<p>(Disclaimer: I am not a mac user, so all my knowledge about this issue is from the above post.)</p>",
        "id": 548327262,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762020033
    },
    {
        "content": "<p>Let's not worry about issues without evidence of affecting users for now</p>",
        "id": 548335859,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1762028429
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">Sébastien Gouëzel</span> <a href=\"#narrow/channel/113488-general/topic/building.20mathlib.20on.20ubuntu.20v.20mac/near/548316950\">said</a>:</p>\n<blockquote>\n<p>Can you open Microsoft Defender and tell it not to scan your project directory? On windows, this makes a huge difference.</p>\n</blockquote>\n<p>Oh my goodness me, that is the solution.</p>\n<p>In fact it was not quite the solution: I told Windows Defender to not scan my lean project directory and the problem still persisted. So then I told it to not scan anything in my home directory and this seems to have completely solved the problem. For literally months I have opened FLT on my laptop, started a file with <code>import Mathlib</code>, pasted some code and then waited for between 30 seconds and a minute for anything to happen. Today things are very different! Thank you so much <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> , I owe you a nice bottle of wine.</p>\n<p>I know it might sound ridiculous but I literally did not even know I was running Microsoft Defender until I factory reset the machine and this time watched more carefully to see what Imperial were doing to my machine. In normal use the top right hand of my screen had a bunch of icons on them but I had never even looked at them, they were just there from day 1, I have never even used this operating system before, and I just regarded them as \"stuff which macs have and which I don't need to understand\". It was only when it dawned on me that it was the crapware which was the problem that I started to figure out exactly what I was stuck with.</p>\n<p>Thank you to everyone who helped; this has literally made a very large difference to my working life. I had even got into the habit of opening VS Code and then going to check emails or Zulip because I knew that it would be unresponsive for about a minute.</p>",
        "id": 553257509,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762101800
    },
    {
        "content": "<p>I'm really glad it made a difference for you. It also made a huge difference for me (on Windows) when I found the setting.</p>\n<p>The next question is: is it possible to detect if Windows Defender is active on the Lean directory (or whatever is relevant when starting mathlib) and issue a warning about this if so? I'm sure this would be helpful to many more people than just the two of us.</p>",
        "id": 553260683,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1762104795
    },
    {
        "content": "<p>what is the setting on windows?</p>",
        "id": 553260724,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762104838
    },
    {
        "content": "<p>Go in windows defender, protection against viruses and threats (or something like that, I am translating from French), Parameters of protection against viruses and threats, manage parameters. There is an \"Exclusions\" item for folders which shouldn't be scanned. I have added the various Lean project folders and the mathlib cache there.</p>",
        "id": 553261015,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1762105048
    },
    {
        "content": "<p>ah I did exactly that and observed no change (see <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/slowdown.20on.20initial.20use/with/553260067\">#general &gt; slowdown on initial use</a> ), do I need to restart my computer?</p>",
        "id": 553261075,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762105092
    },
    {
        "content": "<p>You should also add .elan fwiw</p>",
        "id": 553261240,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1762105212
    },
    {
        "content": "<p>Normally, the slowdown is only on the initial launch (because then the files are fresh in cache). Do you have a slowdown on each launch?</p>",
        "id": 553261259,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1762105228
    },
    {
        "content": "<p>every time i click restart file, basically</p>",
        "id": 553261276,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762105245
    },
    {
        "content": "<p>Weird. I don't know what is going on then.</p>",
        "id": 553261357,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1762105292
    },
    {
        "content": "<p>To be more explicit: start by excluding your entire home directory, like Kevin did, to ensure all relevant folders are covered</p>",
        "id": 553261513,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1762105430
    },
    {
        "content": "<p>is there a way to see which folders Lean uses?</p>",
        "id": 553261734,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762105627
    },
    {
        "content": "<p>do I need to exclude vscode as well?</p>",
        "id": 553261752,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762105644
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113488-general/topic/building.20mathlib.20on.20ubuntu.20v.20mac/near/553257509\">said</a>:</p>\n<blockquote>\n<p>Thank you so much <span class=\"user-mention silent\" data-user-id=\"110050\">Sébastien Gouëzel</span> , I owe you a nice bottle of wine.</p>\n</blockquote>\n<p>Oh, that’s a nice way to pay for productivity boosts! How many bottles do I get if I install Linux on your Mac next time I see you?</p>",
        "id": 553262497,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1762106336
    },
    {
        "content": "<p>I just saw this thread.  Here's a datapoint from my M1 MacBook Air:</p>\n<blockquote>\n<p>ctchou-macair:~/play/mathlib4 $ time lake build<br>\nBuild completed successfully (7473 jobs).<br>\nlake build  5.27s user 2.65s system 160% cpu 4.947 total<br>\nctchou-macair:~/play/mathlib4 $ time lake build<br>\nBuild completed successfully (7473 jobs).<br>\nlake build  5.25s user 2.46s system 168% cpu 4.573 total<br>\nctchou-macair:~/play/mathlib4 $ time lake build<br>\nBuild completed successfully (7473 jobs).<br>\nlake build  5.21s user 2.44s system 165% cpu 4.635 total</p>\n</blockquote>",
        "id": 553723273,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1762293087
    },
    {
        "content": "<p>Btw @Kevin: I noticed that in the output of time command in your gif for the Mac, the real time (as in what you observe on a clock while waiting for lake to finish) is much larger than the cumulative cpu time spent in both user and system (I.e. kernel mode). Typically the real time that you would observe is less than this cpu time because the cpu time is spread out across multiple cores. So what you observe could be a sign that </p>\n<ol>\n<li>you have some crapware running or</li>\n<li>You have a bad network connection or</li>\n<li>Your antivirus or firewall is blocking something.</li>\n</ol>",
        "id": 553739023,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1762301098
    },
    {
        "content": "<p>Shreyas the problem is solved: it was Microsoft Defender (which I cannot remove as when they bought the mac for me, Imperial reported its serial number to Apple who now force me to install and run software on Imperial's list). I stopped it scanning the relevant directories and now have consistently fast builds.</p>",
        "id": 553818989,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762339288
    }
]