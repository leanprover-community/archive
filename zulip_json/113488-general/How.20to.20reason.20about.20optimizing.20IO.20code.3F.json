[
    {
        "content": "<p>I've been following the <code>cat</code> example in the Lean 4 programming book, and have code that looks like the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bufsize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">USize</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">accumulateFromStream</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stream</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">Stream</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">accumulator</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">stream</span><span class=\"bp\">.</span><span class=\"n\">read</span><span class=\"w\"> </span><span class=\"n\">bufsize</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">accumulator</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">accumulateFromStream</span><span class=\"w\"> </span><span class=\"n\">stream</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">accumulator</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">stdinInputAsListOfLines</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This is fine for small text files but I'm trying to parse a text log of an strace of over 3 million lines, and I think that this code is loading the entirety of the accumulator on every loop (but am not fully sure, it is extremely slow however). How could I reason about what parts of my code are imposing a heavier burden on the parsing?</p>",
        "id": 482215519,
        "sender_full_name": "nrs",
        "timestamp": 1731515945
    },
    {
        "content": "<p>Appending to the end of a List is slow (in the sense that it contributes O(n^2) in a loop like this). You could change it to <code>List (List String)</code> and then flatten it later with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.flatten#doc\">docs#List.flatten</a>, or you could change it to an <code>Array String</code></p>",
        "id": 482215839,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731516038
    },
    {
        "content": "<p>ah great I'll try these out, thank you for the recommendations!</p>",
        "id": 482216149,
        "sender_full_name": "nrs",
        "timestamp": 1731516140
    },
    {
        "content": "<p>(or  push at the front and <code>reverse</code> in the end, but <code>Array</code> is likely the better data structure here)</p>",
        "id": 482216196,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1731516155
    },
    {
        "content": "<p>Jannis's suggestion could look like doing <code>(stdinInputAsListOfLines buf).reverse ++ accumulator</code> and then doing a List.reverse at the end</p>",
        "id": 482216321,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731516200
    },
    {
        "content": "<p>The key is the running time of <code>a ++ b</code> is <code>O(a.length)</code>.</p>",
        "id": 482216393,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731516224
    },
    {
        "content": "<p>I'll try both of these techniques, thank you very much!</p>",
        "id": 482217166,
        "sender_full_name": "nrs",
        "timestamp": 1731516447
    },
    {
        "content": "<p>execution time went from over 15 minutes to less than 20 seconds, tyvm for tips!!</p>",
        "id": 482221528,
        "sender_full_name": "nrs",
        "timestamp": 1731517753
    },
    {
        "content": "<p>Does this still require load everything into memory? Or processing can be done peacemeal?</p>",
        "id": 482309727,
        "sender_full_name": "Andrii Kurdiumov",
        "timestamp": 1731559916
    }
]