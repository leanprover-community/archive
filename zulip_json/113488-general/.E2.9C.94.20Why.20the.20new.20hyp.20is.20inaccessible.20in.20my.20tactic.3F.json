[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"add_goal_to_hyps \"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshUserName</span><span class=\"w\"> </span><span class=\"ss\">`h_1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">MetavarKind</span><span class=\"bp\">.</span><span class=\"n\">syntheticOpaque</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvarIdNew</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"bp\">.</span><span class=\"n\">intro1P</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">    </span><span class=\"n\">replaceMainGoal</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mvarIdNew</span><span class=\"o\">]</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">add_goal_to_hyps</span>\n</code></pre></div>\n<p>Why the new hyp <code>h_1</code> is inaccessible?<br>\n<a href=\"/user_uploads/3121/Zz2kLDCioUXoGs83Lic-O_jr/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Zz2kLDCioUXoGs83Lic-O_jr/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"348x131\" src=\"/user_uploads/thumbnail/3121/Zz2kLDCioUXoGs83Lic-O_jr/image.png/840x560.webp\"></a></div>",
        "id": 511789758,
        "sender_full_name": "Zihao Zhang",
        "timestamp": 1744445587
    },
    {
        "content": "<p>for hygiene purposes, i'm guessing</p>",
        "id": 511807071,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744460469
    },
    {
        "content": "<p>Note also that replacing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvarIdNew</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"bp\">.</span><span class=\"n\">intro1P</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>\n<p>by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvarIdNew</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"bp\">.</span><span class=\"n\">intro1P</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">assert</span><span class=\"w\"> </span><span class=\"ss\">`h_1</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>\n<p>does result in something accessible.</p>",
        "id": 511808441,
        "sender_full_name": "Paul Lezeau",
        "timestamp": 1744461647
    },
    {
        "content": "<p>Yes, <code>mkFreshUserName</code> is specifically for making new inaccessible names.</p>",
        "id": 511839092,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744487085
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"753034\">Zihao Zhang</span> has marked this topic as resolved.</p>",
        "id": 511863430,
        "sender_full_name": "Notification Bot",
        "timestamp": 1744509840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/113488-general/topic/.E2.9C.94.20Why.20the.20new.20hyp.20is.20inaccessible.20in.20my.20tactic.3F/near/511839092\">said</a>:</p>\n<blockquote>\n<p>Yes, <code>mkFreshUserName</code> is specifically for making new inaccessible names.</p>\n</blockquote>\n<p>I would say the name of this function is a bit misleading.</p>",
        "id": 511884832,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744530418
    },
    {
        "content": "<p>The word \"fresh\" tends to mean \"guaranteed distinct\" in (most of?) the library, and \"unused\" is used in functions like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.LocalContext.getUnusedName#doc\">docs#Lean.LocalContext.getUnusedName</a> that don't have such a strong guarantee (without guaranteeing it's distinct from not-yet-seen names). Still, the function is undocumented, and there are a number of overlapping functions. Three I know about:</p>\n<ul>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Core.mkFreshUserName#doc\">docs#Lean.Core.mkFreshUserName</a> uses the given name to make an inaccessible name.</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mkFreshBinderNameForTactic#doc\">docs#Lean.Meta.mkFreshBinderNameForTactic</a> uses the <code>tactic.hygienic</code> option to decide between <code>mkFreshUserName</code> and <code>LocalContext.getUnusedName</code>.</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.mkFreshBinderName#doc\">docs#Lean.Elab.Term.mkFreshBinderName</a> creates an inaccessible name from <code>x</code>.</li>\n</ul>",
        "id": 511928623,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744567065
    },
    {
        "content": "<p>Rather than <code>Fresh</code>, what I find surprising is that <code>UserName</code> is not a name that the user can use.</p>",
        "id": 511929153,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744567431
    },
    {
        "content": "<p>It's for the user-visible name. I think it's referring specifically to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.LocalDecl.userName#doc\">docs#Lean.LocalDecl.userName</a></p>",
        "id": 511929370,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744567570
    },
    {
        "content": "<p>Another one you didn't mention is</p>\n<ul>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.mkFreshId#doc\">docs#Lean.mkFreshId</a>, used for creating low level globally unique names (e.g. fvar uniq names)</li>\n</ul>\n<p>You almost never want to use this function, but it's easier to remember or find when looking for <code>mkFreshUserName</code> or <code>getUnusedName</code> so it misleads often</p>",
        "id": 511932386,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744570103
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/7947\">lean4#7947</a> is some incremental documentation progress</p>\n<p>(I'm not sure why <code>Lean.Core.mkFreshUserName</code> requires <code>CoreM</code>, when it could use <code>MonadQuotation</code> I believe.)</p>",
        "id": 511935191,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744572409
    },
    {
        "content": "<p>Yes, the surprising part is UserName, not Fresh.</p>",
        "id": 511938444,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744574868
    },
    {
        "content": "<p>What I'm trying to say <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> is that \"fresh\" always(?) implies inaccessible, and it is assuming that you know that <code>userName</code> is what the system uses to refer to the user-visible names for both free variables and metavariables (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.LocalDecl#doc\">docs#Lean.LocalDecl</a> constructors have a <code>userName</code> fields, and also <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MetavarDecl.userName#doc\">docs#Lean.MetavarDecl.userName</a>). If \"Fresh\" is not surprising, then I'm not sure what's surprising here about \"UserName\". I find \"Fresh\" to be the surprising part myself, because it's not clear that it doesn't simply mean unused.</p>",
        "id": 511939871,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744576167
    },
    {
        "content": "<p>Implicit is that there are user names that can't be used by the user; that's how inaccessible names work.</p>",
        "id": 511940104,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744576370
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/.E2.9C.94.20Why.20the.20new.20hyp.20is.20inaccessible.20in.20my.20tactic.3F/near/511928623\">said</a>:</p>\n<blockquote>\n<p>The word \"fresh\" tends to mean \"guaranteed distinct\" in (most of?) the library, [...]</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113488-general/topic/.E2.9C.94.20Why.20the.20new.20hyp.20is.20inaccessible.20in.20my.20tactic.3F/near/511939871\">said</a>:</p>\n<blockquote>\n<p>What I'm trying to say @Patrick Massot is that \"fresh\" always(?) implies inaccessible, [...]</p>\n</blockquote>\n<p>that's not the same, so it's good you clarify</p>",
        "id": 511940455,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744576683
    },
    {
        "content": "<p>Ok, then I’ll restate this as “not containing <code>Inaccessible</code> is surprising”. If there an analogue function that generates an unused accessible name?</p>",
        "id": 511943845,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744579472
    },
    {
        "content": "<p>Yes, I mentioned <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.LocalContext.getUnusedName#doc\">docs#Lean.LocalContext.getUnusedName</a></p>\n<p>It's unused with respect to a particular local context; it doesn't take the environment into account. (The <code>mkFreshUserName</code> creates a name that's guaranteed distinct from anything already existing or yet-to-be-mentioned. Being inaccessible is the only way to ensure this.)</p>",
        "id": 511944513,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744579963
    },
    {
        "content": "<blockquote>\n<p>(The <code>mkFreshUserName</code> creates a name that's guaranteed distinct from anything already existing or yet-to-be-mentioned. Being inaccessible is the only way to ensure this.)</p>\n</blockquote>\n<p>I don't see how that follows. It could just add <code>_1</code> to the name in order to make it distinct, without making it inaccessible</p>",
        "id": 511950770,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744585024
    },
    {
        "content": "<p>What if user code uses <code>h_1</code> later, and it's not meant to be this generated <code>h_1</code>?</p>",
        "id": 511951549,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744585572
    },
    {
        "content": "<p>I'm not saying that's an advisable thing to do, I'm saying that's a reasonable presumption about what <code>mkFreshUserName</code> could do</p>",
        "id": 511951709,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744585689
    },
    {
        "content": "<p>You said \"you don't see how that follows\" regarding how it \"creates a name that's guaranteed distinct from anything [...] yet-to-be-mentioned\" though — that's what I'm addressing. It's not possible to use a suffix to guarantee this.</p>",
        "id": 511951801,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744585782
    },
    {
        "content": "<p>sure but distinctness from things in the future is not generally expected anyway</p>",
        "id": 511951870,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744585810
    },
    {
        "content": "<p>things in the future are responsible for making themselves distinct from things in the past, not vice versa</p>",
        "id": 511951911,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744585850
    },
    {
        "content": "<p>This is the essence of hygienic macros though. The whole system is guaranteeing that intermediate expansions don't accidentally create captureable names.</p>\n<p>Maybe this is unnecessary from within a tactic script that you control yourself, but we <em>do</em> expect that if a user doesn't specify a name that the generated name is guaranteed to never matter. This is distinctness from things in the future.</p>\n<p>Can I have a clarification here about your \"I don't see how that follows\"? It's feeling like you're changing the framing on me. This conversation is only making sense to me if you ignored \"yet-to-be-mentioned\" — especially now that you're arguing that this is not expected behavior — should I assume that this is what you were trying to argue from the beginning?</p>",
        "id": 511952772,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744586623
    },
    {
        "content": "<p>(I did ignore the yet-to-be-mentioned part)</p>",
        "id": 511952846,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744586669
    },
    {
        "content": "<p>I agree that if this is not a design consideration that suffixes are sufficient.</p>",
        "id": 511952903,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744586729
    },
    {
        "content": "<p>I know that this is the point of hygienic macros, and there is a reason lean does not offer the functionality I am describing. However, I don't think one should assume that \"everyone knows this\" when writing the docs and to some extent also the names of functions</p>",
        "id": 511952910,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744586732
    },
    {
        "content": "<p>Feel free to review the PR I posted earlier (<a href=\"https://github.com/leanprover/lean4/pull/7947\">lean4#7947</a>) that tries to address the confusion.</p>",
        "id": 511953009,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744586802
    },
    {
        "content": "<p>actually I guess <code>getUnusedName</code> is exactly the function I'm describing?</p>",
        "id": 511953071,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744586869
    },
    {
        "content": "<p>it generates an accessible name according to your docstring</p>",
        "id": 511953122,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744586883
    },
    {
        "content": "<p>Yes, I've tried pointing it out a couple times in this thread <span aria-label=\"exhausted\" class=\"emoji emoji-1f625\" role=\"img\" title=\"exhausted\">:exhausted:</span></p>",
        "id": 511953194,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744586953
    },
    {
        "content": "<p>(That was the first part of the message you quoted)</p>",
        "id": 511953291,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744587007
    }
]