[
    {
        "content": "<p>A recent mathlib PR has the diff for <code>Mathlib/RingTheory/PowerSeries/WellKnown.lean</code> starting</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">- import Mathlib.RingTheory.PowerSeries.Basic</span>\n<span class=\"gi\">+ import Mathlib.RingTheory.PowerSeries.Inverse</span>\nimport Mathlib.Data.Nat.Parity\n<span class=\"gi\">+ import Mathlib.Data.Nat.Choose.Sum</span>\nimport Mathlib.Algebra.BigOperators.NatAntidiagonal\n</code></pre></div>\n<p>This file is imported by Bernoulli numbers, it's not a leaf file, so I feel obliged to check that this import change isn't disruptive in some way. But can I do this automatically? Is there some sort of program which can be run giving this change a score out of 10 for metrics which people who understand import trees care about? For example it could inform us that the longest pole just doubled.</p>",
        "id": 437810139,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1715257232
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/ok9ucK_xoJHWvcKqJLX5hncm/imports.png\">imports.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/ok9ucK_xoJHWvcKqJLX5hncm/imports.png\" title=\"imports.png\"><img src=\"/user_uploads/3121/ok9ucK_xoJHWvcKqJLX5hncm/imports.png\"></a></div><p>Here's another one on another PR. I really don't know how to judge these things.</p>",
        "id": 437820747,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1715261992
    },
    {
        "content": "<p>Metrics such as pole length could be added to the speedcenter, but need an explicit <code>!bench</code> to be reported before merging</p>",
        "id": 437821737,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1715262351
    },
    {
        "content": "<p>A much more immediate information would be the number of dependencies of a given file before and after the change. The import graph stuff should be able to say that.</p>",
        "id": 437821943,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1715262423
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"313038\">@Moritz Firsching</span> did some work investigating the number of new imports (by calling several times <code>lake exe graph</code> to some files with a build in between) for that PR: <a href=\"https://github.com/leanprover-community/mathlib4/pull/10635#issuecomment-2022734136\">https://github.com/leanprover-community/mathlib4/pull/10635#issuecomment-2022734136</a><br>\nPerhaps that can be a starting point for a new tool?</p>",
        "id": 437822875,
        "sender_full_name": "Rémy Degenne",
        "timestamp": 1715262763
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/113488-general/topic/tooling.20for.20checking.20imports.20in.20mathlib/near/437820747\">said</a>:</p>\n<blockquote>\n<p><a href=\"/user_uploads/3121/ok9ucK_xoJHWvcKqJLX5hncm/imports.png\">imports.png</a></p>\n<p>Here's another one on another PR. I really don't know how to judge these things.</p>\n</blockquote>\n<p>This looks like my PR. I've just tried <a href=\"https://github.com/leanprover-community/mathlib4/blob/690d741a2041d5670fd10338b772280cca9b47cd/LongestPole/Main.lean#L151-L161\"><code>lake exe pole --to &lt;Module&gt;</code></a> and it seems the longest pole wouldn't change. On the current master branch, <code>Mathlib.Algebra.Module.Torsion</code> has a pole length of 95 whereas the newly added <code>Mathlib.Data.ZMod.Module</code> has 76. The 4 removed imports were redundant before the change, but I haven't considered whether their removal affects the performance in any way.</p>",
        "id": 437847965,
        "sender_full_name": "Peiran Wu",
        "timestamp": 1715271837
    },
    {
        "content": "<p>I have been playing a bit with imports and have also found few tools to help with this.  What do you think of adding this function?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#imports \"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:(</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">imps</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">toString</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">idStr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">                </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">                </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">imps</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">idStr</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logWarningAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"No file starting with '{idStr}' is imported\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"'{f}' is imported\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Keep typing to refine</span><span class=\"se\">\\n</span><span class=\"s2\">{found}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"c1\">-- everything up to `Lean.Elab.Command`</span>\n\n<span class=\"bp\">#</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">N</span>\n<span class=\"c1\">-- Keep typing to refine</span>\n<span class=\"c1\">-- [Lean.Data.Name, Lean.Data.NameMap, Lean.Data.NameTrie]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">NameT</span>\n<span class=\"c1\">-- 'Lean.Data.NameTrie' is imported</span>\n\n<span class=\"bp\">#</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"c1\">-- No file starting with 'X' is imported</span>\n</code></pre></div>",
        "id": 452832984,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721476670
    },
    {
        "content": "<p>Nice would be a tool that reports a list of the transitively imported files that are not actually used. This has the usual constants / syntax / tactics problems, of course. </p>\n<p>Back in Lean 3 days we had this: the analogue of <code>lake exe graph</code> could highlight unused transitive imports (based only on observed constants).</p>",
        "id": 452847862,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721487147
    },
    {
        "content": "<p>Also nice would be if the \"incremental\" version of <code>#min_imports</code> could report on the impact (how many new files are transitively imported by the necessary import increase for this declaration?)</p>",
        "id": 452847863,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721487147
    },
    {
        "content": "<p>Kim, I think that what you want is likely close: <code>#min_imports</code> and especially the linter version seem very promising.</p>\n<p>I am testing the <code>minImports</code> linter on all of Mathlib and I am getting <em>very</em> few errors on necessary imports.  Currently, the only source of errors that I am not yet sure how to address are custom <code>attribute</code>s, especially <code>aesop</code>s <code>rule_sets</code>.  Other than that, even \"nameless <code>instance</code>s\" are yielding!</p>",
        "id": 452849310,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721487970
    },
    {
        "content": "<p>In fact, <code>#min_imports in X</code> can already report all the constants implied by <code>X</code>, whether they are syntax, tactic or <code>Expr</code>-generated.</p>",
        "id": 452850169,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721488398
    }
]