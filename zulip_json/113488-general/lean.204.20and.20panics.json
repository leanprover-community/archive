[
    {
        "content": "<p>Hi all, I've got some fundamental misunderstanding of what \"panic\" means in Lean 4 (e.g. in the context of the documentation of functions like <code>Array.get!</code> and <code>String.toNat!</code>).</p>\n<p>For example, here is a program that is utterly broken in so many different ways and that I was expecting to fail in some visible sense, either at compilation time or run time (note the array indexing overflow + attempts of parsing invalid strings as natural numbers):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkArray0</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"bad\"</span><span class=\"bp\">.</span><span class=\"n\">toNat!</span>\n<span class=\"w\">  </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad\"</span>\n<span class=\"w\">  </span><span class=\"n\">panic</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad bad\"</span>\n<span class=\"w\">  </span><span class=\"n\">unreachable!</span>\n<span class=\"w\">  </span><span class=\"n\">assert!</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">123</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"all good, got result {r}\"</span>\n</code></pre></div>\n<p>Yet if I just do <code>lake exe foo</code>, it happily compiles it and runs it and it prints out \"all good, got result 0\" and terminates successfully. And if I remove just <code>assert! false</code>, it says \"all good, got result 123\".</p>\n<p>Is there some way to ask Lean 4 to really panic in cases in which it claims to panic (when running stuff with <code>lake</code>)? Or should I just avoid all functions that say something about panicking in their documentation?</p>",
        "id": 489277051,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734365346
    },
    {
        "content": "<p>Set environment variable <code>LEAN_ABORT_ON_PANIC=1</code>.</p>",
        "id": 489282821,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1734366725
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> Many thanks, this helps! At least the program crashes now! It just doesn't print out anything useful, but it also doesn't complete successfully if I'm using <code>Array.get!</code> or <code>String.toNat!</code> incorrectly. And apparently <code>assert! false</code> is also leading to crashes now, good.</p>",
        "id": 489285604,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734367409
    },
    {
        "content": "<p>I still don't understand the semantics of stuff like <code>panic!</code> and friends, as e.g. this still succeeds:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad\"</span>\n<span class=\"w\">  </span><span class=\"n\">x</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">123</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"all good, got result {r}\"</span>\n</code></pre></div>\n<p>While e.g. this crashes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad\"</span>\n<span class=\"w\">  </span><span class=\"n\">x</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">123</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"all good, got result {r}\"</span>\n</code></pre></div>",
        "id": 489286369,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734367595
    },
    {
        "content": "<p>Also, is there any way to ask it to also print out something to stderr when it crashes, or do I need an external shell script for that?</p>",
        "id": 489286543,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734367636
    },
    {
        "content": "<p>I donâ€™t know why, but it works with single <code>=</code></p>",
        "id": 489286860,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734367708
    },
    {
        "content": "<p>I've noticed that there are lots of minor variants, some of which \"work\" and some don't and I don't really see a pattern hereâ€¦</p>",
        "id": 489287186,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734367779
    },
    {
        "content": "<p>I think the panic behavior is confusing in Lean.  Maybe this is a subtle way the developers are telling us to do things right.  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span>  Using IO monads errors, option types (<code>List.get?</code>), or just prove that the behavior is correct (<code>.List.get</code>).  But it is annoying to not be sure your code will respect panics.</p>",
        "id": 489288124,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734367991
    },
    {
        "content": "<p>I think the issue is that the compiler is free to eliminate the panic since this is the <code>Id</code> monad, and there's no data dependency on the panic.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">ir</span><span class=\"bp\">.</span><span class=\"n\">rc</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad\"</span>\n<span class=\"w\">  </span><span class=\"n\">x</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">def foo (x_1 : @&amp; obj) : obj :=</span>\n<span class=\"cm\">  inc x_1;</span>\n<span class=\"cm\">  ret x_1</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 489288234,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734368020
    },
    {
        "content": "<p>The IR is saying that the function was simplified to the identity function.</p>",
        "id": 489288373,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734368046
    },
    {
        "content": "<p>The fix is easy: make sure you have a data dependence on the panic.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>In the first case, it <em>must</em> return the result of the <code>panic!</code>, so it <em>must</em> be executed.</p>",
        "id": 489288540,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734368092
    },
    {
        "content": "<p>Oh right I should use <code>panic!</code> like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">123</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad\"</span>\n<span class=\"w\">  </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 489288981,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734368206
    },
    {
        "content": "<p>I for some reason thought <code>panic!</code> is magic that implicitly returns but it doesn't.</p>",
        "id": 489289056,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734368225
    },
    {
        "content": "<p>Would be awesome to have a compiler warning that I should use the result of <code>panic!</code>â€¦</p>",
        "id": 489289138,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734368244
    },
    {
        "content": "<p>Or a linter.</p>",
        "id": 489289198,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734368257
    },
    {
        "content": "<p>OK, stuff making more sense now. Always do <code>return panic!</code> in this kind of context and always run everything with <code>LEAN_ABORT_ON_PANIC=1</code>.</p>",
        "id": 489289377,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734368299
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"733738\">Jukka Suomela</span> <a href=\"#narrow/channel/113488-general/topic/lean.204.20and.20panics/near/489289056\">said</a>:</p>\n<blockquote>\n<p>I for some reason thought <code>panic!</code> is magic that implicitly returns but it doesn't.</p>\n</blockquote>\n<p>These examples make me think that it <em>should</em> implicitly return. That's doable, if there were a <code>doElem</code> macro for it.</p>\n<p>Feel free to create a Lean 4 issue with the feedback that the version without the <code>return</code> was surprising that it didn't work.</p>",
        "id": 489289395,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734368304
    },
    {
        "content": "<p>Btw, is there a reason <code>LEAN_ABORT_ON_PANIC=1</code> isn't a default?</p>",
        "id": 489289612,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734368367
    },
    {
        "content": "<p>Also, why does <code>assert!</code> return the default value even without a data dependency, but <code>panic!</code> doesnâ€™t?  Is assert immediately returning?</p>",
        "id": 489290089,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734368503
    },
    {
        "content": "<p><code>assert!</code> isn't a function, it's a <code>do</code> element (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Term.doAssert#doc\">docs#Lean.Parser.Term.doAssert</a>)</p>",
        "id": 489290446,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734368606
    },
    {
        "content": "<p>It turns out it expands to <code>assert! c; k</code> where <code>k</code> is the rest of the <code>do</code> block, and this expands to an <code>if</code>/<code>else</code>. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.expandAssert#doc\">docs#Lean.Elab.Term.expandAssert</a></p>",
        "id": 489290788,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734368697
    },
    {
        "content": "<p>Which is what maybe panic! should also be?  Or is the issue that panic! also works outside of do blocks?</p>",
        "id": 489290904,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734368728
    },
    {
        "content": "<p>There shouldn't be a problem with it working outside of <code>do</code> blocks. There are a few examples of multipurpose syntax like that (even <code>do</code> works as a <code>do</code> element and as a term)</p>",
        "id": 489291160,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734368779
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"733738\">Jukka Suomela</span> <a href=\"#narrow/channel/113488-general/topic/lean.204.20and.20panics/near/489289612\">said</a>:</p>\n<blockquote>\n<p>Btw, is there a reason <code>LEAN_ABORT_ON_PANIC=1</code> isn't a default?</p>\n</blockquote>\n<p>The reason is that this may invalidate proofs about programs with panics. From a logical perspective, <code>panic! \"...\" = default</code>, where <code>default</code> is some arbitrary (but fixed) element of the respective type. Hence, for example, <code>(panic! \"...\" : Nat) = 0</code>. So this is a provably correct implementation of multiplication:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Aesop</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"zero\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">times_eq_mul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">times</span><span class=\"o\">])</span>\n</code></pre></div>\n<p>It's a bit of a weird tradeoff with no clear best option.</p>",
        "id": 489292138,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1734369010
    },
    {
        "content": "<p>Arguably panics shouldnâ€™t return a predictable value (similar to <code>partial</code>).  So then you canâ€™t prove stuff about the panic route.</p>",
        "id": 489301889,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734371945
    },
    {
        "content": "<p>In other words why do you want to prove theorems like the above one?  Wouldnâ€™t you want to prove if m is not 0 then <code>times n m = n * m</code>?</p>",
        "id": 489302653,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734372142
    },
    {
        "content": "<p>And also, does that flag prevent you from proving that theorem?  (And if the issue is that Lean proves the program gives an answer but in practice it crashes, there are lots of ways to have Lean do that without that flag, like external implementations.)</p>",
        "id": 489303103,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734372267
    },
    {
        "content": "<p>It's a lot easier to apply that sort of theorem, which helps a lot with formalization. Well-chosen junk values mean you can have unconditional simp lemmas.</p>",
        "id": 489303107,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734372269
    },
    {
        "content": "<p>I'm not sure I understand your example <span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span>, unless the point is \"<code>panic!</code> has no logical meaning, it's just <code>default</code> with special runtime support, so beware\"</p>",
        "id": 489303340,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734372347
    },
    {
        "content": "<p>Yeah, why do proofs have anything to do with that flag being on as the default?</p>",
        "id": 489303549,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734372402
    },
    {
        "content": "<p>I'm not understanding this claim about the flag having anything to do with proofs</p>",
        "id": 489304191,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734372590
    },
    {
        "content": "<p>The example shows a program, <code>times</code>, that is proven to behave exactly like <code>mul</code>. So if you run this program, arguably it should behave exactly like <code>mul</code>. The <code>LEAN_ABORT_ON_PANIC</code> flag subverts this expectation. That's my understanding of why Leo wanted it off by default.</p>",
        "id": 489304239,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1734372602
    },
    {
        "content": "<p>I guess it'd be fairly easy to also write a Lean program that is provably correct but crashes at run time because it tries to allocate gazillion terabytes of memory?</p>",
        "id": 489304362,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734372628
    },
    {
        "content": "<p>FWIW I agree that this mostly produces weird behaviour in practice. But I can see the reason.</p>",
        "id": 489304376,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1734372632
    },
    {
        "content": "<p>Then List.get! Is a major footgun.  It behaves like getD, but the user doesnâ€™t realize that.  So they are surprised when 0s silently show up in their code, and it is hard to debug, no?</p>",
        "id": 489304630,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734372710
    },
    {
        "content": "<p>Yes, this occasionally happens.</p>",
        "id": 489304746,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1734372736
    },
    {
        "content": "<p>It it panicked by default then that is fine, but otherwise it is a trap.</p>",
        "id": 489304841,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734372766
    },
    {
        "content": "<p>I run the Aesop test suite with <code>LEAN_ABORT_ON_PANIC=1</code> for this reason, and I think Mathlib also does that.</p>",
        "id": 489304864,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1734372775
    },
    {
        "content": "<p>But I really like this perspective. Does a provably correct program/function in the ideal world mean:</p>\n<ol>\n<li>it always works correctly, full stop</li>\n<li>if it happens to terminate successfully (and it didn't e.g. run out of memory or panic for a similar reason) it also worked correctly?</li>\n</ol>",
        "id": 489304991,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734372807
    },
    {
        "content": "<p>Found the likely comment that told you about Leo's position <span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span>: <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/add_decl_doc.20.20panic.20loop/near/316698823\">#lean4 &gt; add_decl_doc  panic loop @ ðŸ’¬</a></p>",
        "id": 489309646,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734372925
    },
    {
        "content": "<p>(This might be the only documentation about it. The Lean 4 source doesn't have any information about the choice for the default value.)</p>",
        "id": 489309849,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734372979
    },
    {
        "content": "<p>There isnâ€™t a great match between the semantics of the kernel math and the semantics of the code.  It is at best something they try to keep functionally the same, but I donâ€™t think there are any guarantees. A proof in Lean is a proof about the ideal version of the code, not the implementation. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> complains about this sometimes.</p>",
        "id": 489310222,
        "sender_full_name": "Jason Rute",
        "timestamp": 1734373086
    },
    {
        "content": "<p>Btw, something like <code>lake exe --abort-on-panic foo</code> would be convenient. This kind of a flag would also be visible in <code>lake exe --help</code>, so unlike <code>LEAN_ABORT_ON_PANIC=1</code> one might accidentally learn about it.</p>\n<p>And it would be especially convenient if with this flag <code>lake exe</code> also printed out to stderr at least some basic stuff like \"program crashed\" when the program crashes so that it doesn't look like everything was silently OK.</p>\n<p>This would make some difference especially for programs that don't normally print out anything but just e.g. manipulate some files.</p>",
        "id": 489315967,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734374808
    },
    {
        "content": "<p>I mean writing stuff like <code>LEAN_ABORT_ON_PANIC=1 lake exe foo || echo \"something went wrong\"</code> gets somewhat tiresome and isn't that intuitive for beginners.</p>",
        "id": 489316348,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734374930
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"115715\">Jason Rute</span> <a href=\"#narrow/channel/113488-general/topic/lean.204.20and.20panics/near/489310222\">said</a>:</p>\n<blockquote>\n<p>There isnâ€™t a great match between the semantics of the kernel math and the semantics of the code.  It is at best something they try to keep functionally the same, but I donâ€™t think there are any guarantees.</p>\n</blockquote>\n<p>There is at least a soft guarantee that the compiled code does not produce different (valid) results from the kernel version of the code, because violation of this leads to proofs of false via <code>native_decide</code>. (This guarantee is invalidated when you use <code>implemented_by</code> or <code>extern</code>, which is the equivalent of <code>axiom</code> for the purpose of compiler correctness, but I believe the devs try to keep the existing <code>implemented_by</code> and <code>extern</code> implementations from violating this property.)</p>",
        "id": 489334034,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380419
    },
    {
        "content": "<p>But there is no guarantee that the compiled code won't panic while the kernel code doesn't (as indeed it can't panic, that's not a thing in the type theory)</p>",
        "id": 489334198,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380469
    },
    {
        "content": "<p>From a modeling perspective, <code>panic</code> is just a no-op</p>",
        "id": 489334438,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380541
    },
    {
        "content": "<p>in particular it does not halt execution (and as observed, it also does not halt execution in normal compiled code either, it just reports an error to some side channel and continues unless you set a certain environment variable)</p>",
        "id": 489334468,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380553
    },
    {
        "content": "<p>if you want to halt execution you should use exceptions or other mechanisms that play well with the type system</p>",
        "id": 489334554,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380586
    },
    {
        "content": "<p>Some people will tell you that <code>panic</code> itself was a mistake and you shouldn't use it at all</p>",
        "id": 489334600,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380604
    },
    {
        "content": "<p>I could see the argument for this either way. I'm somewhat worried that at some point, someone is going to perform a critical IO action like deleting a folder, without realizing that panic doesn't stop their code, and it will cause a bunch of damage. On the other hand, having panic terminate the program basically breaks the semantics</p>",
        "id": 489335255,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734380824
    },
    {
        "content": "<p>Maybe we need some way to track which implemented_by or <code>partial</code> function we rely on, in the same way that we track which <code>axiom</code>s that are relied on?</p>",
        "id": 489335351,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734380860
    },
    {
        "content": "<p>yeah, I have to remind people often not to treat <code>panic</code> like it early aborts</p>",
        "id": 489335388,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380872
    },
    {
        "content": "<p>I think it's not well named to give that impression</p>",
        "id": 489335453,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380883
    },
    {
        "content": "<p>I think it would be useful to have a way to check specifically for uses of <code>panic</code> (and a few other lean runtime functions that also have the effect of a panic, like <code>Array.get!</code>)</p>",
        "id": 489335667,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734380958
    },
    {
        "content": "<p>The other problem I can see with making it abort early by default is that people will learn to rely on this, and it might be even more likely someone will use it to safeguard dangerous IO</p>",
        "id": 489335756,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734380985
    },
    {
        "content": "<p>People coming from rust in particular are highly susceptible to this I would imagine</p>",
        "id": 489336020,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381062
    },
    {
        "content": "<p>I think it would be better to rename it</p>",
        "id": 489336072,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381080
    },
    {
        "content": "<p>Rust panics absolutely cannot continue to the next line of code</p>",
        "id": 489336112,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381093
    },
    {
        "content": "<p>they can abort or they can throw</p>",
        "id": 489336126,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381100
    },
    {
        "content": "<p>Some programming language have different logging levels like INFO, WARNING, ERROR, FATAL. If the intended behavior of panic is a fatal log, maybe that's what it should be renamed to?</p>",
        "id": 489336273,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381136
    },
    {
        "content": "<p>but rust panics have a type which amounts to <code>panic : Unit -&gt; False</code></p>",
        "id": 489336318,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381153
    },
    {
        "content": "<p>and this is problematic for a logic language</p>",
        "id": 489336341,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381161
    },
    {
        "content": "<p>fatal also sounds like it stops execution</p>",
        "id": 489336418,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381184
    },
    {
        "content": "<p>yeah, that's a problem</p>",
        "id": 489336461,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381197
    },
    {
        "content": "<p>how about just <code>bug!</code></p>",
        "id": 489336468,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381201
    },
    {
        "content": "<p>which is the name for the rustc internal macro for internal compiler errors</p>",
        "id": 489336645,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381251
    },
    {
        "content": "<p>That sounds sort of like a temporary statement, even though it isn't</p>",
        "id": 489336716,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381276
    },
    {
        "content": "<p>if we rename panic, should we also have an <code>abort!</code> to actually stop execution?</p>",
        "id": 489336788,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381301
    },
    {
        "content": "<p>the point is that we can't really have that to begin with</p>",
        "id": 489336836,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381319
    },
    {
        "content": "<p><code>no!</code> or <code>drat!</code> would be a little amusing</p>",
        "id": 489336879,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734381330
    },
    {
        "content": "<p>at least not without bringing back all the flaws that <code>panic!</code> has</p>",
        "id": 489336902,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381338
    },
    {
        "content": "<p>(it's easy to have this in the IO monad, but the problem is having it in pure code)</p>",
        "id": 489337083,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381385
    },
    {
        "content": "<p>well, I think the idea would be that <code>abort!</code> should only be used in areas of the code we don't care about semantics that much, like <code>partial</code> or <code>unsafe</code></p>",
        "id": 489337088,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381387
    },
    {
        "content": "<blockquote>\n<p><code>no!</code> or <code>drat!</code> would be a little amusing</p>\n</blockquote>\n<p>What about <code>d'oh!</code></p>",
        "id": 489337282,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381453
    },
    {
        "content": "<p>Keep in mind that this is not the entirety of the macro, it's followed by a string literal</p>",
        "id": 489337894,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381561
    },
    {
        "content": "<p>Would we also need to rename <code>unreachable!</code>?</p>",
        "id": 489338100,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381627
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">d'oh!</span><span class=\"w\"> </span><span class=\"s2\">\"the argument is out of bounds\"</span>\n</code></pre></div>",
        "id": 489338380,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734381723
    },
    {
        "content": "<p>Just a quick note: even if we set <code>LEAN_ABORT_ON_PANIC=1</code>, the panic <em>message</em> is not shown anywhere or logged anywhere, it seems to be completely lost, right? So this isn't really comparable to \"logging\" in other programming languages?</p>",
        "id": 489338459,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734381747
    },
    {
        "content": "<p>that seems like a bug</p>",
        "id": 489338499,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381768
    },
    {
        "content": "<p>in vscode it ends up in the output panel</p>",
        "id": 489338552,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381784
    },
    {
        "content": "<p>I mean if you run e.g. <code>LEAN_ABORT_ON_PANIC=1 lake exe foo</code> in the terminal, you don't see anything? At least on macOS and Lean 4.14.0?</p>",
        "id": 489338720,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734381840
    },
    {
        "content": "<p>there seems to be a flag to enable</p>",
        "id": 489338801,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381857
    },
    {
        "content": "<p>Would it be feasible to create an <code>abort!</code> that only works in <code>partial</code> and <code>unsafe</code> functions? I feel like terminating abruptly fits my conception of a partial function (and in most cases, aborting is probably better than looping forever)</p>",
        "id": 489338804,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734381857
    },
    {
        "content": "<p>but no, the flag seems to be always on during regular code, so it should print to stderr</p>",
        "id": 489339014,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734381935
    },
    {
        "content": "<p>I do like the idea of renaming <code>panic!</code></p>",
        "id": 489339107,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734381963
    },
    {
        "content": "<p>they aren't particularly panicked, just more of a mild concern</p>",
        "id": 489339271,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382013
    },
    {
        "content": "<p>Even something verbose like <code>raise_panic_flag!</code> might be helpful. (Less suggestive that it makes execution? Longer, to discourage people using it?)</p>",
        "id": 489339313,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734382028
    },
    {
        "content": "<p>I don't think it's feasible to get rid of all the <code>!</code> suffixes though</p>",
        "id": 489339379,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382052
    },
    {
        "content": "<p>even something like <code>raise!</code> is probably better than <code>panic!</code></p>",
        "id": 489339520,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734382091
    },
    {
        "content": "<p>nope, that one also sounds like non-local control flow</p>",
        "id": 489339566,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382106
    },
    {
        "content": "<p>In any case, certainly the doc-string for <code>panic!</code> should mention <code>LEAN_ABORT_ON_PANIC</code>.</p>",
        "id": 489339594,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734382115
    },
    {
        "content": "<p>oh, that's fair</p>",
        "id": 489339602,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734382117
    },
    {
        "content": "<p>it does, although maybe not with that capitalization</p>",
        "id": 489339707,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382149
    },
    {
        "content": "<p>if <code>panic!</code> is renamed, would this mean getting rid of <code>LEAN_ABORT_ON_PANIC</code>?<br>\nIf not, I'm not sure it will be easy to find a word that means \"Possibly abort, but also possibly just log an error\"</p>",
        "id": 489339708,
        "sender_full_name": "Niels Voss",
        "timestamp": 1734382150
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113488-general/topic/lean.204.20and.20panics/near/489339014\">said</a>:</p>\n<blockquote>\n<p>but no, the flag seems to be always on during regular code, so it should print to stderr</p>\n</blockquote>\n<p>Sorry, do you mean that the message <em>is</em> visible currently and I'm doing something wrong if I'm not seeing it?</p>\n<p>Or do you mean that there is a bug but the <em>intended</em> behavior is that the message would get printed to stderr?</p>",
        "id": 489339747,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734382165
    },
    {
        "content": "<p>it seems the intended behavior is to print to stderr, and from what I can tell it is going through the motions</p>",
        "id": 489339819,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382194
    },
    {
        "content": "<p>I have not tested the code</p>",
        "id": 489339835,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382198
    },
    {
        "content": "<p>does it work if you pass <code>lean -e</code>?</p>",
        "id": 489340261,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382321
    },
    {
        "content": "<p>this uses a slightly different code path but should be the same as <code>LEAN_ABORT_ON_PANIC</code></p>",
        "id": 489340342,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382338
    },
    {
        "content": "<p>Here is a very simple example that reproduces it for me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">panic!</span><span class=\"w\"> </span><span class=\"s2\">\"bad bad bad\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"all well, got result {r}\"</span>\n</code></pre></div>\n<p>Running <code>lake exe foo</code> in the terminal gives \"all well, got result 0\".</p>\n<p>And running <code>LEAN_ABORT_ON_PANIC=1 lake exe foo</code> in the terminal gives nothing (which was surprising to me), but the program crashes with a non-zero error code (which is of course good and intended here).</p>",
        "id": 489340476,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734382385
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> If I add <code>#eval main</code> in the end of the file, and then run it with <code>lean -e</code>, I can see the panic error message. Is this what you meant? I don't really know how to use <code>lean -e</code> to properly run a full Lean program (comparable to <code>lake exe</code>)?</p>",
        "id": 489341544,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734382734
    },
    {
        "content": "<p>yes, I'm starting to suspect the issue has to do with the fact that you aren't using <code>lean</code></p>",
        "id": 489341620,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382761
    },
    {
        "content": "<p>Oh, I didn't know I'm doing something wrong or unusual. :)</p>\n<p>Isn't <code>lake</code> the right frontend for everything? It's after all using <code>lean</code> to generate C code, etc.?</p>",
        "id": 489342062,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734382895
    },
    {
        "content": "<p>not wrong, there are simply multiple ways to run lean code and panic messages go in different directions depending</p>",
        "id": 489342195,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382934
    },
    {
        "content": "<p>the point here is that you are building a standalone program and running it, rather than panicking in the elaborator (e.g. via <code>#eval</code>)</p>",
        "id": 489342296,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734382974
    },
    {
        "content": "<p>Yes, I do usually see panic messages and all kinds of useful stuff if I do quick interactive experiments by adding <code>#eval</code> in VS Code and looking at Lean Infoview.</p>",
        "id": 489342584,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734383072
    },
    {
        "content": "<p>oh! it's panicking during initialization due to closed term extraction</p>",
        "id": 489342688,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383111
    },
    {
        "content": "<p>this is <a href=\"https://github.com/leanprover/lean4/pull/1965\">lean#1965</a></p>",
        "id": 489343655,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383410
    },
    {
        "content": "<p>error messages are masked during initialization</p>",
        "id": 489343691,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383424
    },
    {
        "content": "<p>to fix it you need to make your panic message not constant</p>",
        "id": 489343777,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383457
    },
    {
        "content": "<p>It also happens with e.g. this, where I guess the problem is the same (<code>get!</code> uses a fixed error message)?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkArray0</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"mi\">123</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"all well, got result {r}\"</span>\n</code></pre></div>",
        "id": 489344191,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734383621
    },
    {
        "content": "<p>no, here the issue is that the entire computation of <code>foo</code> happens at initialization time</p>",
        "id": 489344491,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383713
    },
    {
        "content": "<p>because <code>foo</code> is a constant</p>",
        "id": 489344503,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383719
    },
    {
        "content": "<p>Oh I see, makes sense.</p>",
        "id": 489344573,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734383751
    },
    {
        "content": "<p>I tried setting <code>set_option compiler.extract_closed false</code> which should help but it's apparently not enough when you have global constants like <code>foo</code></p>",
        "id": 489344609,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383762
    },
    {
        "content": "<p>if you make <code>foo (_ : Unit) : Nat</code> then it will finally output a message</p>",
        "id": 489344742,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383805
    },
    {
        "content": "<p>No, that's not enough, or at least this doesn't fix it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkArray0</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"mi\">123</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"all well, got result {r}\"</span>\n</code></pre></div>",
        "id": 489344949,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734383885
    },
    {
        "content": "<p>you also need the extract_closed option</p>",
        "id": 489344987,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734383899
    },
    {
        "content": "<p>Oh, right, got it!</p>",
        "id": 489345058,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734383927
    },
    {
        "content": "<p>So stuff like this is apparently enough to get error messages:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">extract_closed</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkArray0</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"mi\">123</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"all well, got result {r}\"</span>\n</code></pre></div>",
        "id": 489345351,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734384023
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Exactly what does <code>compiler.extract_closed</code> do? I've got a program with this behavior:</p>\n<ul>\n<li>Seems to work fine with <code>lake exe</code></li>\n<li>Crashes with no message with <code>LEAN_ABORT_ON_PANIC=1 lake exe</code></li>\n<li>Seems to work fine with <code>set_option compiler.extract_closed false</code> + <code>LEAN_ABORT_ON_PANIC=1 lake exe</code></li>\n</ul>",
        "id": 489549864,
        "sender_full_name": "Jukka Suomela",
        "timestamp": 1734460843
    },
    {
        "content": "<p><code>extract_closed</code> is an optimization the compiler performs to move all closed subterms into top level definitions, which are calculated at initialization time. <a href=\"https://github.com/leanprover/lean4/pull/1965\">lean#1965</a> is the bug that this process occurs even to closed subterms which contain <code>panic!</code>, meaning that the code will panic (and abort if you have the appropriate setting) at initialization time, even if the code it was extracted from is never called. So it can cause a perfectly well defined program to crash. (This crash also occurs at initialization time, which is why there is no message.)</p>",
        "id": 489552217,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1734461788
    }
]