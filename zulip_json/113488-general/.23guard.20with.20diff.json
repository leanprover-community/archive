[
    {
        "content": "<p>I think command #guard A = B should tell us the evaluation result of A and B when A = B is not evaluated to true.</p>",
        "id": 541146864,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1758692658
    },
    {
        "content": "<p>I want this because I usually use #guard for unit test of functions.</p>",
        "id": 541147083,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1758692798
    },
    {
        "content": "<p>PR welcome.</p>",
        "id": 541168293,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758701715
    },
    {
        "content": "<p>I'm playing around with adding this, but I'm stuck at one point when modifying <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.GuardExpr.evalGuardCmd#doc\">docs#Lean.Elab.Tactic.GuardExpr.evalGuardCmd</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">evalGuardCmd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab.Command.CommandElab</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n<span class=\"c1\">-- I've added this:</span>\n<span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Throw an error with a special error message when the expression was of the form `decide (_ = _)`.</span>\n<span class=\"w\">  </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Decidable.decide</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\">       </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"c1\">-- STUCK</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\">  </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">lhs</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\">  </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">rhs</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- throw an error with the more specific error message</span>\n\n<span class=\"w\">  </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Expression{indentExpr e}</span><span class=\"se\">\\n</span><span class=\"s2\">did not evaluate to `true`\"</span>\n</code></pre></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>MWE</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalGuardCmd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Throw an error with a special error message when the expression was of the form `decide (_ = _)`.</span>\n<span class=\"w\">  </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\">       </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- unsafe evalExpr sorry sorry α -- STUCK</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\">  </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">lhs</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\">  </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">rhs</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- throw an error with the more specific error message</span>\n\n<span class=\"w\">  </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Expression{indentExpr e}</span><span class=\"se\">\\n</span><span class=\"s2\">did not evaluate to `true`\"</span>\n</code></pre></div>\n</div></div>\n<p>The first two arguments to the <code>evalExpr</code> function are <code>(α : Type)</code> and <code>(expectedType : Expr)</code>. Thus, if I want to call <code>evalExpr</code> on the two values <code>lhs</code> and <code>rhs</code> of the equality, I first need to obtain the type of <code>lhs</code> and <code>rhs</code>. In the code above this type is <code>α</code>. However, <code>α</code> is an <code>Expr</code>, so I would again want to use <code>evalExpr</code> to lift this back into a \"normal\" value. But to do that, I would need to have the type of <code>α</code>, etc. I don't understand how to resolve this.</p>",
        "id": 541179279,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758705020
    },
    {
        "content": "<p>One thing you do know is that the type of <code>α</code> is going to be <code>Sort u</code>, and i imagine it isn't too difficult to figure out <code>u</code> here?</p>",
        "id": 541181127,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1758705571
    },
    {
        "content": "<p>(<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.evalExpr#doc\">docs#Lean.Meta.evalExpr</a>)</p>",
        "id": 541181271,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1758705610
    },
    {
        "content": "<p>You can't eval a type. Types have no runtime representation</p>",
        "id": 541181658,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758705722
    },
    {
        "content": "<p>So consequently, you can only <code>evalExpr</code> terms whose type you know beforehand?</p>",
        "id": 541181813,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758705776
    },
    {
        "content": "<p>Actually, you should be able to figure out the universe from the application of <code>Eq</code></p>",
        "id": 541181979,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1758705823
    },
    {
        "content": "<p>Well, <code>#eval</code> can evaluate anything you give it so clearly there is a way but this way is certainly not to evaluate a type in the compiler.</p>",
        "id": 541182090,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758705857
    },
    {
        "content": "<p>But, how do you reflect that universe back into the \"normal\" (non-<code>Expr</code>) Lean term <code>Sort u</code>?<br>\nAs in:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lvl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Level</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\">What do you write here?-/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"n\">lvl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>",
        "id": 541182091,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758705857
    },
    {
        "content": "<p>I hadn't thought that far</p>",
        "id": 541182250,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1758705906
    },
    {
        "content": "<p>I haven't looked yet but I imagine the trick is to do something like infer a <code>Repr</code> instance etc. for the type you infer from the expression and then because you can statically know the return type of calling <code>repr</code> you can <code>eval</code></p>",
        "id": 541182285,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758705916
    },
    {
        "content": "<p>Looking at <code>BuiltinEvalCommand.lean</code> that is indeed what is happening</p>",
        "id": 541182925,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758706099
    },
    {
        "content": "<p>I'm having a hard time following <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.elabEvalCoreUnsafe#doc\">docs#Lean.Elab.Command.elabEvalCoreUnsafe</a>. But independent of that, would it make sense to reuse (most of) <code>elabEvalCoreUnsafe</code> for the current <code>#guard</code> use case? Or is there a small core of <code>elabEvalCoreUnsafe</code> that could be factored out for reuse?</p>",
        "id": 541197937,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758710943
    },
    {
        "content": "<p>(Is the <code>[Inhabited t]</code> instance in <code>mkAct</code> playing the role of the <code>Repr</code> instance you were mentioning?)</p>",
        "id": 541198288,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758711045
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541146864\">said</a>:</p>\n<blockquote>\n<p>I think command #guard A = B should tell us the evaluation result of A and B when A = B is not evaluated to true.</p>\n</blockquote>\n<p>do you have an example?</p>",
        "id": 541198837,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758711224
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541198837\">said</a>:</p>\n<blockquote>\n<p>do you have an example?</p>\n</blockquote>\n<p>If I understand correctly, they would want to have some behaviour like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">Expression</span>\n<span class=\"cm\">  decide (1 + 1 = 3)</span>\n<span class=\"cm\">did not evaluate to `true`</span>\n<span class=\"cm\">---</span>\n<span class=\"cm\">Left side of equation evaluates to</span>\n<span class=\"cm\">  2</span>\n<span class=\"cm\">but the right side evaluates to</span>\n<span class=\"cm\">  3</span>\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>",
        "id": 541199152,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758711325
    },
    {
        "content": "<p>because it seems like the discussion above is somehow stuck on \"Type u\"...???</p>",
        "id": 541199153,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758711325
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541199153\">said</a>:</p>\n<blockquote>\n<p>because it seems like the discussion above is somehow stuck on \"Type u\"...???</p>\n</blockquote>\n<p><code>Type u</code> not in the sense that <code>u</code> is a universe mvar, but only in the sense that <code>u</code> is some concrete universe level which would need to be determined. But as <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> has pointed out, the initial approach I was trying is doomed anyway.</p>",
        "id": 541199535,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758711449
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">section</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"c1\">-- copied from https://github.com/leanprover/lean4/blob/90db9ef006467ae5998f8707e420a392a88a05b8/src/Lean/Elab/Tactic/Guard.lean#L155</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalGuardAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTermEnsuringType</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Bool</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">synthesizeSyntheticMVarsNoPostponing</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Expression{indentExpr e}</span><span class=\"se\">\\n</span><span class=\"s2\">did not evaluate to `true`\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">logUnassignedUsingErrorInfos</span><span class=\"w\"> </span><span class=\"n\">mvars</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#guard_diff \"</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">evalGuardAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">snd</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">catch</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">enableInitializersExecution</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fstE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fstTE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">fstE</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sndE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sndTE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">sndE</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">fstTE</span><span class=\"w\"> </span><span class=\"n\">sndTE</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"The two terms have different types:</span>\n<span class=\"s2\">        {fstTE}, {sndTE}\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">fstTN</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fstTE</span><span class=\"bp\">.</span><span class=\"n\">getAppFnArgs</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"The type is not a constant: {fstTE}\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"bp\">.</span><span class=\"n\">evalConst</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">fstTN</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Failed to resolve type: {fstTN}\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mdE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``ToMessageData</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">fstTE</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ToMessageData</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``ToMessageData</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">fstTE</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">mdE</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fstEval</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">fstTE</span><span class=\"w\"> </span><span class=\"n\">fstE</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sndEval</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">sndTE</span><span class=\"w\"> </span><span class=\"n\">sndE</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Given terms elaborate differently: {fstEval}, {sndEval}\"</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"bp\">.</span><span class=\"n\">evalConst</span>\n\n<span class=\"kn\">end</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n\n<span class=\"bp\">#</span><span class=\"n\">guard_diff</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"c1\">-- Failed to resolve type: Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span>\n<span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>",
        "id": 541205568,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758713468
    },
    {
        "content": "<p>So I tried to write the meta code but it failed to resolve <code>Nat</code> to a type, can anyone debug this?</p>",
        "id": 541205635,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758713486
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541198288\">said</a>:</p>\n<blockquote>\n<p>(Is the <code>[Inhabited t]</code> instance in <code>mkAct</code> playing the role of the <code>Repr</code> instance you were mentioning?)</p>\n</blockquote>\n<p>What #eval seems to be doing to me is given some arbitrary expression <code>e</code> basically build a new expression that calls repr (and then converts that to message data), then evaluate that expression using the expression evaluator. Because it knows that this new expression contains a MessageData it can just put MessageData as the target type and be happy. I would suggest to essentially follow the same approach. I guess the idea of trying to reuse eval infra structure is indeed a good one.</p>",
        "id": 541206398,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758713736
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541205635\">said</a>:</p>\n<blockquote>\n<p>So I tried to write the meta code but it failed to resolve <code>Nat</code> to a type, can anyone debug this?</p>\n</blockquote>\n<p>as I have explained above what you are trying to do is impossible</p>",
        "id": 541206429,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758713747
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> ah, ok, do you know what are the functions that are like <code>elabCommand</code> but catches the logs?</p>",
        "id": 541206841,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758713892
    },
    {
        "content": "<p>so I realised that this functionality would be contained in #guard_msgs, so I looked at its <a href=\"https://github.com/leanprover/lean4/blob/90db9ef006467ae5998f8707e420a392a88a05b8/src/Lean/Elab/GuardMsgs.lean#L180\">source code</a>... why is it so long?</p>",
        "id": 541208391,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758714395
    },
    {
        "content": "<p>it uses <code>withReader</code> and the code looks very complicated and fine-tuned to this specific usecase that i can't really copy it easily...</p>",
        "id": 541208497,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758714435
    },
    {
        "content": "<p>I guess what I want would be to first factor out a part of the above code into a function with the following type:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elabCommandWithLog</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageLog</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 541208836,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758714531
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541205635\">said</a>:</p>\n<blockquote>\n<p>So I tried to write the meta code but it failed to resolve <code>Nat</code> to a type, can anyone debug this?</p>\n</blockquote>\n<p>Just pass in <code>lcErased</code> where you're currently passing <code>type</code> and delete the part where you eval the type</p>",
        "id": 541214046,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758716197
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541208391\">said</a>:</p>\n<blockquote>\n<p>so I realised that this functionality would be contained in #guard_msgs, so I looked at its <a href=\"https://github.com/leanprover/lean4/blob/90db9ef006467ae5998f8707e420a392a88a05b8/src/Lean/Elab/GuardMsgs.lean#L180\">source code</a>... why is it so long?</p>\n</blockquote>\n<p>I think it's so long because <code>#guard_msgs</code> has to put in some work to ensure that error messages are produced/formatted exactly as expected. Most of the code seems to be related to that.</p>",
        "id": 541219681,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758717880
    },
    {
        "content": "<p>(Somewhat) following <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>'s explanation, this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Expression{indentExpr e}</span><span class=\"se\">\\n</span><span class=\"s2\">did not evaluate to `true`\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\">         </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``repr</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">lhs</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``repr</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">rhs</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Format</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">lhs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Format</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">rhs</span>\n<span class=\"w\">  </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Expression{indentExpr e}</span><span class=\"se\">\\n</span><span class=\"s2\">did not evaluate to `true`</span><span class=\"se\">\\n</span><span class=\"s2\">---</span><span class=\"se\">\\n</span><span class=\"s2\">{lhs}</span><span class=\"se\">\\n</span><span class=\"s2\">vs</span><span class=\"se\">\\n</span><span class=\"s2\">{rhs}\"</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#guard_diff\"</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTermEnsuringType</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Bool</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">synthesizeSyntheticMVarsNoPostponing</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">logUnassignedUsingErrorInfos</span><span class=\"w\"> </span><span class=\"n\">mvars</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">Expression</span>\n<span class=\"cm\">  decide (3 * 4 = 2 + 2)</span>\n<span class=\"cm\">did not evaluate to `true`</span>\n<span class=\"cm\">---</span>\n<span class=\"cm\">12</span>\n<span class=\"cm\">vs</span>\n<span class=\"cm\">4</span>\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_diff</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>\n<p>... at least as long as the result type has a <code>Repr</code> instance. I don't understand how <code>#eval</code> manages to print something for types which don't have <code>Repr</code>.</p>",
        "id": 541231231,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758720870
    },
    {
        "content": "<p>iirc #eval has a mechanism that attempts to automatically derive a <code>Repr</code> instance on the fly and if it fails it just gives up</p>",
        "id": 541231386,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1758720911
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"372804\">@Marcus Rossel</span> oh wow that's nice</p>",
        "id": 541231792,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758720999
    },
    {
        "content": "<p>i guess the lesson here to use <code>repr</code> directly and skip the step of \"actually\" building the objects</p>",
        "id": 541232249,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758721093
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/113488-general/topic/.23guard.20with.20diff/near/541232249\">said</a>:</p>\n<blockquote>\n<p>i guess the lesson here to use <code>repr</code> directly and skip the step of \"actually\" building the objects</p>\n</blockquote>\n<p>Or analogously, you can use <code>evalExpr</code> with any term as long as you know what the <em>final</em> result type of using that term is.</p>",
        "id": 541234742,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1758721741
    },
    {
        "content": "<p>This sort of works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">DiffResult</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ok</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">DiffResult</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DiffResult</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">doc?</span><span class=\"o\">:(</span><span class=\"n\">docComment</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"s2\">\"#guard_diff \"</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">51</span><span class=\"w\"> </span><span class=\"s2\">\" = \"</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">51</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">doc?</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">DiffResult</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">snd</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: DiffResult.different 2 3</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_diff</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: DiffResult.ok</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_diff</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>\n<p>The <code>#guard_msgs</code> code action does not apply to this though.</p>",
        "id": 541897761,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759070981
    },
    {
        "content": "<p>(What Henrik says is exactly right for how <code>#eval</code> is able to work: it needs to be able to synthesize a formatting function to adapt the evaluated value so that <code>evalExpr</code> can evaluate the value using known type, Unit, String or MessageData. It's funny how pretty printing is essential to its function.)</p>",
        "id": 541898112,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1759071267
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"372804\">@Marcus Rossel</span> Thank you!!</p>",
        "id": 544636034,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1760400319
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <span class=\"user-mention\" data-user-id=\"372804\">@Marcus Rossel</span> </p>\n<p>Kim said that “PRs welcome,” and I think this command would be useful.<br>\nThe question is what format to use for the output message — how about something like this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"Expression{indentExpr e}</span><span class=\"se\">\\n</span><span class=\"s2\">did not evaluate to `true`\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">let_expr</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\">         </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failGenerically</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs_fmt_expr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``repr</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">lhs</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs_fmt_expr</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``repr</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">rhs</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lhs_fmt</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Format</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">lhs_fmt_expr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rhs_fmt</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Format</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Format</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">rhs_fmt_expr</span>\n<span class=\"w\">  </span><span class=\"n\">throwError</span>\n<span class=\"w\">    </span><span class=\"s2\">\"Expression{indentExpr e}</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">    did not evaluate to `true`</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">    ---</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">    {lhs} = {lhs_fmt}</span><span class=\"se\">\\n\\</span>\n<span class=\"s2\">    {rhs} = {rhs_fmt}\"</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#guard_diff\"</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftTermElabM</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTermEnsuringType</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Bool</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">synthesizeSyntheticMVarsNoPostponing</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMVars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">fail</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">logUnassignedUsingErrorInfos</span><span class=\"w\"> </span><span class=\"n\">mvars</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Expression</span>\n<span class=\"sd\">  decide (3 * 4 = 2 + 2)</span>\n<span class=\"sd\">did not evaluate to `true`</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">3 * 4 = 12</span>\n<span class=\"sd\">2 + 2 = 4</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_diff</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>",
        "id": 545752546,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1760790341
    }
]