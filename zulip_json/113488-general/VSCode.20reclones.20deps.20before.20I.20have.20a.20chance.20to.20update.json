[
    {
        "content": "<p>I have noticed the following pattern in my use of how the VSCode lean extension deals with the lake dependencies of my projects as I switch between branches. I haven't been paying close attention to it until recently, but it goes something like this:</p>\n<ol>\n<li>I on the main branch of a project, or a branch of the project with the same toolchain as main.</li>\n<li>I switch to an old branch with an older lean-toolchain</li>\n<li>I open a lean file</li>\n<li>\n<p>VSCode somehow immediately realizes that the old toolchain I am now on doesn't match the contents of .lake. It sends a message like \"info: plausible: URL has changed; deleting '/Users/boltonbailey/mathlib-contribution/mathlib4/.lake/packages/plausible' and cloning again<br>\ninfo: plausible: cloning\" for all my dependencies</p>\n</li>\n<li>\n<p>I now have to wait for all my dependencies to be recloned, when often I would be happy to merge main into this feature branch and use the dependencies I already have.</p>\n</li>\n</ol>\n<p>Is there a way I could stop this from happening? I guess it is not really an option for me to just not open any lean file before merging because I have the \"Restore Git Branch Tabs\" extension and that is just way too convenient to give up when I am working on PRs and need to reopen a bunch of specific files for each branch.</p>",
        "id": 575234759,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771829971
    },
    {
        "content": "<p>I just use different cslib clones for the different branches I work on.</p>",
        "id": 575236030,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1771830761
    },
    {
        "content": "<p>I guess there are a few weird things at play here:</p>\n<ol>\n<li>Why is it saying the URL for plausible has changed? Has it really moved to a different github repo in the 2 months since this PR was made?</li>\n<li>I guess if it didn't think the URL had changed it could just pull/checkout from the repo rather than clone it from scratch, so maybe that is the key issue here.</li>\n<li>OTOH it would be nice if the little blue button that says \"restart file\" would simply change to say \"refresh .lake\" when that is what is necessary to restart the file, so that I can take the chance to update the toolchain first.</li>\n</ol>",
        "id": 575236350,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771830920
    },
    {
        "content": "<p>Indeed, the docstring of the function giving this error <a href=\"https://github.com/leanprover/lean4/blob/e7e3588c973226e85d79ed0f3154cfca79b61c6f/src/lake/Lake/Load/Materialize.lean#L48C1-L53C18\">reads</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/--</span>\n<span class=\"sd\">Update the Git repository from `url` in `repo` to `rev?`.</span>\n<span class=\"sd\">If `repo` is already from `url`, just checkout the new revision.</span>\n<span class=\"sd\">Otherwise, delete the local repository and clone a fresh copy from `url`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">updateGitRepo</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 575236824,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771831177
    },
    {
        "content": "<p>I am a bit concerned that this is manifesting because the lakefile says the git repo is <code>\"https://github.com/leanprover-community/plausible\"</code> but <code>git remote get-url origin</code>, the command used by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=updateGitRepo#doc\">docs#updateGitRepo</a> to compare against, gives <code>git@github.com:leanprover-community/plausible</code></p>",
        "id": 575239327,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771832360
    },
    {
        "content": "<p>Aha! Perhaps the culprit is that I have configured my git to use </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">url</span><span class=\"w\"> </span><span class=\"s2\">\"git@github.com:\"</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">insteadOf</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span>\n</code></pre></div>",
        "id": 575240596,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771833030
    },
    {
        "content": "<p>Indeed, changing this changes the error. But I understand that SSH is more secure than https, so I am a bit sad to remove it.</p>",
        "id": 575241420,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771833495
    },
    {
        "content": "<p>Still seems to be an issue though that I am clicking \"Restart file\" in a branch with toolchain 4.27 and it is running <code>/Users/boltonbailey/.elan/toolchains/leanprover--lean4---v4.29.0-rc1/bin/lake setup-file</code>.</p>",
        "id": 575242584,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771833940
    },
    {
        "content": "<p>I believe this insteadOf trick was something a previous employer asked me to do to improve security, and when I google for why https was not show up in my remote name, google suggested it might be because that exact snippet could be in my config file, so perhaps this is some kind of standard security practice?</p>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> have you heard of anything like this before? Is allowing this URL/insteadOf switching something worth filing an issue over or trying to get lake to support?</p>",
        "id": 575244026,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1771834570
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110637\">Ching-Tsun Chou</span> <a href=\"#narrow/channel/113488-general/topic/VSCode.20reclones.20deps.20before.20I.20have.20a.20chance.20to.20update/near/575236030\">said</a>:</p>\n<blockquote>\n<p>I just use different cslib clones for the different branches I work on.</p>\n</blockquote>\n<p>With <code>git worktree</code> you can have a single clone but multiple worktrees. You can create a new worktree with e.g. <code>git worktree add ../cslib_clone</code>. They all have their own separate <code>.lake</code> folder, they just share their git history.<br>\n(I have 6 worktrees of Mathlib on my laptop)</p>",
        "id": 575282674,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1771848080
    },
    {
        "content": "<p>Thanks for the tip about <code>git worktree</code>!  I'll look into using it for new PRs.  But the space saving from sharing <code>.git</code> is probably negligible in the case of cslib, because &gt;99.7% of the space in a cslib repo is used by <code>.lake</code> anyway.</p>",
        "id": 575355368,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1771867812
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"282271\">Bolton Bailey</span> <a href=\"#narrow/channel/113488-general/topic/VSCode.20reclones.20deps.20before.20I.20have.20a.20chance.20to.20update/near/575244026\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> have you heard of anything like this before? Is allowing this URL/insteadOf switching something worth filing an issue over or trying to get lake to support?</p>\n</blockquote>\n<p>This replacement issue has appeared before. However, it is not something Lake can feasibly support. Lake needs to ensure the URL provided in the lakefile matches that of the git remote.</p>",
        "id": 575637773,
        "sender_full_name": "Mac Malone",
        "timestamp": 1771965839
    }
]