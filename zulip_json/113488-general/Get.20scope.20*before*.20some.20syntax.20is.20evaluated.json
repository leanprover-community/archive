[
    {
        "content": "<p>I'm writing a linter which inspects <code>variable</code> commands. I'd like to know which variables were in scope <em>before</em> a particular variable command was executed. Is there a way to achieve this?</p>\n<p>Simply looking at <code>getScope</code> includes the effect of that command already. (This examples requires two files; probably, one file is also possible with further effort.) </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">badVariableLinter</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linter</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withSetOptionIn</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"c1\">-- TODO: how to access the current scope *before* the `variable` command was parsed?</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">previousVariablesOld</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getScope</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">varDecls</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"bp\">.</span><span class=\"n\">raw</span>\n<span class=\"w\">    </span><span class=\"c1\">-- This already prints current variable names...</span>\n<span class=\"w\">    </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">previousVariablesOld</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Now, the actual linter can do whatever</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">addLinter</span><span class=\"w\"> </span><span class=\"n\">badVariableLinter</span>\n\n<span class=\"c1\">-- In a new file, importing just this linter and containing \"variable (a)\", and observe that a is printed.</span>\n</code></pre></div>",
        "id": 455459346,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722451752
    },
    {
        "content": "<p>There certainly is a small hack I could use: elaborate a bare <code>section</code> command before <code>stx</code> and using the not-current-anymore scope to compare. I'd be happy to learn about better solutions, though!</p>",
        "id": 455470691,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722455307
    },
    {
        "content": "<p>The variables in <code>Scopes</code> (note the plural!) seem to remember each layer already:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"sd\">/--  `gs i` shows the available `variable`s `i` scopes ago (defaulting to 0 if not given). -/</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"gs\"</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:(</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">scopes</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"bp\">|</span><span class=\"mi\">0</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Number of available scopes: {sc.length}\"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">sc</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">varDecls</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">getBracketedBinderIds</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">flatten</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">section</span>\n<span class=\"c1\">-- try various numbers to see how you \"climb up\" the variables in scope</span>\n<span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>",
        "id": 455473937,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722456489
    },
    {
        "content": "<p>I know! But isn't this basically what I'm saying above? Put differently, using <code>gs n</code> in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"sd\">/--  `gs i` shows the available `variable`s `i` scopes ago (defaulting to 0 if not given). -/</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"gs\"</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:(</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">scopes</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">num</span><span class=\"bp\">|</span><span class=\"mi\">0</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"Number of available scopes: {sc.length}\"</span>\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">sc</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">varDecls</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">getBracketedBinderIds</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">flatten</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">section</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">section</span>\n<span class=\"c1\">-- try various numbers to see how you \"climb up\" the variables in scope</span>\n<span class=\"n\">gs</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n</code></pre></div>\n<p>does not distinguish a3 and a4.</p>",
        "id": 455483799,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722459700
    },
    {
        "content": "<p>So you are trying to distinguish between <code>variable (a b)</code> and <code>variable a variable b</code>?  I.e. if, within a given scope, whether the variables were added in separate variable commands or in the same?</p>",
        "id": 455484700,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722460054
    },
    {
        "content": "<p>The case I'm really interested in is <code>variable {a} variable (a)</code> (two separate commands, the binder type of <code>a</code> is changed in the second one).</p>",
        "id": 455595565,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1722503157
    }
]