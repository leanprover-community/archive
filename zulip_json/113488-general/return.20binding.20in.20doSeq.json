[
    {
        "content": "<p>Why does the following code evaluate to <code>1</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n</code></pre></div>\n<p>I had essentially this in my codebase which caused a bug, and I spent hours trying to figure out what was wrong. Anyway is this expected behaviour, and why?</p>",
        "id": 533382726,
        "sender_full_name": "Yicheng Qian",
        "timestamp": 1754615149
    },
    {
        "content": "<p>My understanding is that anything to the right of <code>←</code> shouldn't mess with the control flow, and by the way</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n</code></pre></div>\n<p>evaluates to <code>11</code>.</p>",
        "id": 533382880,
        "sender_full_name": "Yicheng Qian",
        "timestamp": 1754615326
    },
    {
        "content": "<p>This is a subtle but intentional part of <code>do</code> notation. The control flow can extend into <code>let ... ←</code> for <code>if</code>, <code>do</code>, <code>match</code>, and other doElems. It's how you can bind the result of the doElem. If you have something that looks like it could extend the control flow, it's best to use <code>pure</code> to avoid an accidental early return.</p>\n<p>There's a bit of feedback that the editor provides you that you can use to check the interpretation: if you move your cursor right before <code>return</code>, the corresponding <code>do</code> that it returns from is highlighted.</p>\n<p>And, yeah, parentheses currently cause it to switch from parsing the <code>if</code> as a doElem to as a term. The <code>return</code> keyword works in as a term as well, and I think it's equivalent to writing <code>do return</code>.</p>\n<p>It's unfortunate how subtle <code>return</code> can be, and also how it's not always clear when control flow is joined together in <code>do</code> notation. I've found being able to return from such an <code>if</code> is useful though.</p>",
        "id": 533386519,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754618993
    }
]