[
    {
        "content": "<p>I've noticed a couple of times that <code>count_heartbeat</code> doesn't seem to behave very nicely with <code>decide</code>. </p>\n<p>In particular, I have some theorems using <code>decide</code> which report <code>3</code> heartbeats are being used, however they take a lot longer to run in practice (the theorems correspond to e.g.  searches over large finsets). </p>\n<p>Does anyone have an explanation of what is going on here?<br>\nWhat I also want to know then, is if the <code>maxHeartBeat</code> check works accurately with proofs containing <code>decide</code>?</p>\n<p>I've struggled to find a mwe but will keep looking for one.</p>\n<p>(I should point out that I am talking about just <code>decide</code> not e.g. <code>decide +native</code>).</p>",
        "id": 521743784,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1748870005
    },
    {
        "content": "<p>Here is a mwe some ambiguity with decide an heartbeats (but not exactly as I reported above):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">400</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">500</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"c1\">-- profiler reports 2,125,674 heartbeats (?), but no error</span>\n</code></pre></div>",
        "id": 521745855,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1748870576
    },
    {
        "content": "<p>The number after <code>maxHeartbeats</code> is scaled by 1000 as mentioned in the docstring, so it is correct that your example succeeds under the default value but not under <code>maxHeartbeats 2000</code></p>",
        "id": 521783557,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1748879791
    },
    {
        "content": "<p>Ok, thanks <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> , this explains the issue in my mwe, but it doesn't solve the discrepancy  when <code>count_heartbeat </code> which report <code>3</code> heartbeats using <code>decide</code>, yet the proofs take a fairly long time e.g. 10 seconds.</p>",
        "id": 521784542,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1748879997
    },
    {
        "content": "<p>Have you seen <a href=\"#narrow/channel/287929-mathlib4/topic/.60.23count_heartbeats.60.20vs.2E.20.60trace.2Eprofiler.2EuseHeartbeats.20true.60\">#mathlib4 &gt; &#96;#count_heartbeats&#96; vs. &#96;trace.profiler.useHeartbeats true&#96;</a>?</p>",
        "id": 521785224,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1748880119
    },
    {
        "content": "<p>Ah, sorry I think I understand, at least half the story. Many thanks for the link! </p>\n<p>Namely, that I can get an accurate count of heartbeats for decide using </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>but I need to divide this number by 1000 to compare it to the 200,000 maxHeartbeats limit.</p>",
        "id": 521791009,
        "sender_full_name": "Joseph Tooby-Smith",
        "timestamp": 1748881376
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"653351\">Joseph Tooby-Smith</span> has marked this topic as resolved.</p>",
        "id": 521791476,
        "sender_full_name": "Notification Bot",
        "timestamp": 1748881520
    }
]