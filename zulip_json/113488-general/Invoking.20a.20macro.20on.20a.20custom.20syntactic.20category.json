[
    {
        "content": "<p>Consider the following attempt at defining custom syntax of the form <code>C ‚ä¢ T</code> where <code>T</code> will be a term and <code>C</code> comes from a custom syntactic category:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"moo\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"eat\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">moo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">eat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">13</span><span class=\"o\">)</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">barn</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"s2\">\" ‚ä¢ \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>In the last line, it complains that <code>$c</code> on the rhs has the wrong syntactic category (namely <code>cow</code> instead of <code>term</code>). How do i tell it to elaborate <code>$c</code> using the first macro?</p>",
        "id": 488862553,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734102802
    },
    {
        "content": "<p>I came up with this, but is it an idiomatic solution?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"moo\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"eat\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">moo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">eat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">13</span><span class=\"o\">)</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">barn</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"s2\">\" ‚ä¢ \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"mkCow\"</span><span class=\"w\"> </span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(((</span><span class=\"n\">mkCow</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 488865143,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734103559
    },
    {
        "content": "<p>the canonical way is to bring the syntax trees of category <code>cow</code> to <code>term</code>.</p>",
        "id": 488866085,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734103796
    },
    {
        "content": "<p>How?</p>",
        "id": 488866178,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734103811
    },
    {
        "content": "<p>you are already doing it right</p>",
        "id": 488866224,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734103822
    },
    {
        "content": "<p>the MPIL book would suggest something slightly different like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"moo\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"eat\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">moo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">eat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">13</span><span class=\"o\">)</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">barn</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"s2\">\" ‚ä¢ \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"[cow| \"</span><span class=\"w\"> </span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(([</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 488866284,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734103838
    },
    {
        "content": "<p>But this is just to spare oneself parsing agonies I think</p>",
        "id": 488866364,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734103858
    },
    {
        "content": "<p>Yes, that makes sense. I am now hitting the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"moo\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"eat\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cow</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">moo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cow</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">eat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">13</span><span class=\"o\">)</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">barn</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"s2\">\" ‚ä¢ \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"mkCow\"</span><span class=\"w\"> </span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"n\">cow</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>It complains about the last line: \"unexpected token '‚ä¢'; expected ')' or '|'\". Help!</p>",
        "id": 488866783,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734103991
    },
    {
        "content": "<p><code>$c</code> by itself is too greedy, it assumes it stands for the entire <code>term</code> and so there is nothing left to parse. Try <code>$c:cow</code> there too.</p>",
        "id": 488867052,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1734104066
    },
    {
        "content": "<p>But coming back to your original issue, macros should stay in the same category (we haven't integrated <code>TSyntax</code> far enough yet to make that a compile-time check). Depending on your specific use case, what you likely want to say is that the <em>denotation</em> of <code>moo</code> is <code>42</code>, i.e. <code> `(mkCow moo) =&gt; `(42) </code>, which stays in <code>term</code></p>",
        "id": 488867470,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1734104189
    },
    {
        "content": "<p>I checked and the <code>$c:cow</code> solution is already an error in the original example because it is trying to construct a tuple, and tuple syntax expects terms. It works in the third example though.</p>",
        "id": 488868225,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734104433
    },
    {
        "content": "<p>I can tell you what I'd really like. I am trying to implement an internal language, and in particular sequents of the form <code>x : X, y : Y ‚ä¢ e</code>, where <code>e</code> comes from some inductive type of expressions and <code>x : X, y : Y</code> is notation for an <code>AssocList Lean.Name C</code> (where <code>C</code> is some random type). So I defined a syntactic entity for contexts, and then for terms, like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">fpentry</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpentry</span>\n\n<span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">fpcontext</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">fpentry</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpcontext</span>\n\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"fpcontext|\"</span><span class=\"w\"> </span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"w\">  </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">],</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"bp\">$</span><span class=\"o\">[(</span><span class=\"bp\">$</span><span class=\"n\">key</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">value</span><span class=\"o\">)],</span><span class=\"bp\">*</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">toAssocList'</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">fpterm</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpterm</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"tt\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpterm</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"‚ü®\"</span><span class=\"w\"> </span><span class=\"n\">fpterm</span><span class=\"w\"> </span><span class=\"s2\">\",\"</span><span class=\"w\"> </span><span class=\"n\">fpterm</span><span class=\"w\"> </span><span class=\"s2\">\"‚ü©\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpterm</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"fst\"</span><span class=\"w\"> </span><span class=\"n\">fpterm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpterm</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"snd\"</span><span class=\"w\"> </span><span class=\"n\">fpterm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpterm</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">fpterm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpterm</span>\n\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"s2\">\"‚ä¢‚Çë\"</span><span class=\"w\"> </span><span class=\"n\">fpterm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"w\">  </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">proj</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">fpcontext</span><span class=\"bp\">|$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">fpterm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">fpterm</span><span class=\"w\"> </span><span class=\"bp\">‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fp</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">fpterm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">fp</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">fpterm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">fp</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">fpterm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>(Sorry, this is not a MWE). However, things are not working as expected. What's the right way?</p>",
        "id": 488868557,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734104541
    },
    {
        "content": "<p>Give me a moment I will fix this in the live server</p>",
        "id": 488868953,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734104644
    },
    {
        "content": "<p>When I try to use the syntax like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ü©</span>\n</code></pre></div>\n<p>It says \"elaboration function for '¬´term_‚ä¢‚Çë_¬ª' has not been implemented<br>\n  x:X, y:Y‚ä¢‚Çë‚ü®y,x‚ü©\"</p>",
        "id": 488869030,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734104672
    },
    {
        "content": "<p>Ah, I had a silly error, it's working now.</p>",
        "id": 488869248,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734104739
    },
    {
        "content": "<p>Usually this means that the syntax category has not been lifted correctly to term</p>",
        "id": 488869297,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734104757
    },
    {
        "content": "<p>Thanks for the help. I can now define morphisms in a category with chosen finite products like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ùíû</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">fp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ChosenFiniteProducts</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">]</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- the twist morphism -/</span>\n<span class=\"w\">  </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ü©</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- the diagonal -/</span>\n<span class=\"w\">  </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚ü©</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- identity on the terminal -/</span>\n<span class=\"w\">  </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">ùüô</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"mi\">ùüô</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"n\">tt</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- composition of morphisms -/</span>\n<span class=\"w\">  </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">g</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- right associator -/</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">assocRight</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">‚ü©‚ü©</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- left associator -/</span>\n<span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">assocLeft</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ä¢‚Çë</span><span class=\"w\"> </span><span class=\"bp\">‚ü®‚ü®</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- the associators are inverses -/</span>\n<span class=\"w\">  </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíû</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">assocLeft</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">assocRight</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">ùüô</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">   </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">assocLeft</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">assocRight</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">proj</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">toAssocList'</span><span class=\"o\">]</span>\n<span class=\"w\">   </span><span class=\"n\">aesop_cat</span>\n</code></pre></div>",
        "id": 488874973,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734106387
    },
    {
        "content": "<p>Coming next: Œª-calculus and cartesian-closed-categories</p>",
        "id": 488875055,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734106412
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"345260\">Andrej Bauer</span> has marked this topic as resolved.</p>",
        "id": 488875332,
        "sender_full_name": "Notification Bot",
        "timestamp": 1734106490
    },
    {
        "content": "<p>I already did lambda calc a year ago. You might find the boilerplate useful for the syntax parts</p>",
        "id": 488875649,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734106584
    },
    {
        "content": "<p>Aha, where do I see what you did?</p>",
        "id": 488875721,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734106612
    },
    {
        "content": "<p><a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAGQKYEMB2BYAUKSs4CyKMAFgDbABGAdACooDGMwD2EYSaiqXy61AZQCeaGCgAe3fgAUoSGDCGzgopFGzYVAEwCuTYADckcAELa1cAO4k1SbHDgAfUwDkUIJFrgAKAM5wALjgBGCgVAHMASnsnUwBBNAhMLC01Qwi4ACUkMCgAGjgAESQGYC0USjIkAFEARw0cNF19I0Rq8VyrGzkY5wA1FCgfSSCQsLQo3sR3YcDTcyhIn2MghHbc6KwHZziwMGXAQII4JEAggjm1jsWphGAYAElRHy4gwBJCTe24aTIdf28kI9O53WVxSaQMGWyuQKxVK5UqNXqWDYHF4wOwqQYZEGSAA+r4RGJxDiGMQ4CoYNh8aIJD4AEQAWlpkQA/HA0DoQHNyZSCTTaQBtABazlpZMeooAuqKgjA1CAGiBGFAIDioDoqr5sM4AAbeIWOAAkaAC7JAEqWAF4AHxwXVGzY6vXC+lGk0c81wa227wutCbBrokpYuR43lEknwSgLHnUyRlTjwIJRppqGOEuACkyOUXJ1JDWlSuayqDypFYRUMZWq9VITVYR38rMG8QBeOiD1euBaCAxBwOKrwcRjDIBC1SNDUWo6CCynwwCDDiZwcTUcLyO5ad59hy6swpqDUExuDxeZuLyZljHB3FUwnE0lIS5pmltxPHJ9YW8vx5BR+5Z+SLSgDdwBmcC5hYoqAGWEoF/kMv4fl+kiwaBADtMGXHMsEAe+nSigA1OhnTwf+n5hhm3iEfmcCRNKOHqKRsYZvyWIgCKdGgYWMpygqSoqmqGpat6zHuM4zatqk7aWjauoXLk1ADEMBreHwE5TjOxjePO57Lqu66bpEDpCSxzggQalABOBQzQQaSABLBHbScpwLUAgMyNoalASnAwmsXANnmoJuo+aJ/xwGhNknA53qyQeuz7MFNkHF5CWnAF9ZGSJfnGuSUUyc5Nz3I8+pGmlDbGT4Nl2ZckS5Xq5X+YZQX1aFBERbVMXUF8Pzec1SU9ZlbX+mW9L0nAtA2L4xgMBAailEk/jYnAPyeGBQhwKQxg6Ggf7oHm/iUEgZAQJYmhoL4YhoAwKxwAAwjNcAuByBU+LQwiMdqsFLNYtgxNNxj+KOcCABfkvjUFAKCWIAl+QNCo53oFdcx3Rpr1kdq5JLN4KPvZ9XQ/VscB/XAANjiDYMQ9DZanXDl3XUjcAbgmL1vemH3VbjPT44TxPA6D4NQzDZ0XQjQR02Mz2Y8zNLapZX3dHYnP3dzpN8xTsNC7T91i7cTOozj30cw4XOBCTvPkwGZYAAL8igew4ltO37vM+6HsengSoGABmS3bR0u1Hu4K1BAAqj7YC7am+OOgaOJ7nmLsB6eLbnYsnqOe5fniGlHw4qn60kMqlg+ENVs22Aduh+HQwdQVDwwO7oJe/bvtNDXP5wCHDt5lMdo582Um9nAiowAwJDLlYtwkAPUctqaUkZb5zZZ32joujPHJz01mWr0v2e56QBdF1MOdevvx2H5b1u203YeOx1XW+PXqSNxXTT33MHfN13kfetHd/fP4wU/L/CqrkZKzUTggKgLVQBiU4CtVSluZwx8bSn0Lt4Yul8y7X0rm0S4Ll3CPyQM/TurlOTBxfl/D4Pdq5uSzH5cylkwEDVsvZDedURKmUoHAaySAl5IL3vnM+6CGglyvhQiwHU4qEOIZ/OK79xH0Sod4X+zk5EwOAfZfqC9TiQOgb1MKQDIqILgMgvOB9hEX1LuXTuEjnIKWkd7TuCl5E2MUbEahdjBgZwCMnNhMDM7GNMag8+5sADEI8SgAGstHOEznAEaMSMziElHMVUEAZw4hcmiLA4SbAMGiYAkCa1oJrQIqU5cXkEmFIzEIKCNT8L1LgUklJQQ0kZKyR+XJUTEn0gAIyVNGtXW4tcfB9KWK05U7SYrm20HoZgrQBhkHZvLD4rcYB9CeHMN41x3AbO8CMJ2eYMbXRipsPM6QlyQnyEUEoZQKhVDqMiTgcBFkNCvNiUMsZ7zwAMCgMg2FyRzF+f8hi6ZgKgUsqBaCopkJBGBdhAUwK2LAo4rRYspZsAVirPxWsgU9RIqyq2SSuddSLJcsM0QGz9RZVKkJAlnCLILG4UA3RbCyWkKpU2TyMSGoC2psLW691HogHFljFmwLZZ40NorY2PMyb80aPyjWyNJaSDRqIDGYqpYSuWb9GVgNlZmywKIrBCiXl/PJYVdZDjsEt1uH0EZ5DXHd2Ub3cQ/d8YOCHiPMelgJ5Tx/mvEAfiCWLy3Eo1ebpg0kvxX85w29w2xCCYItBgSBHmIwVY21eZzVkHwSAPoNqKEcpcZ/COSjo7st2d5JscSUrQPpRnZlvLv7JozQ0Lp+TvIEv6dgTtBTG2SGguIFCI7M59oiV2/kBK+n1yAA\">This should work hopefully</a></p>",
        "id": 488876107,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734106744
    },
    {
        "content": "<p>It is a year too old. Lean has changed a lot since then. But it also shows how to write unexpanders</p>",
        "id": 488876144,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734106759
    },
    {
        "content": "<p>One thing to note is that it might be easier to do this with <code>notation</code></p>",
        "id": 488876858,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734107005
    },
    {
        "content": "<p>Let's see if I can translate the above into notation</p>",
        "id": 488876893,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734107020
    },
    {
        "content": "<p>What do unexpanders do?</p>",
        "id": 488877123,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734107081
    },
    {
        "content": "<p>I am hoping to be able to handle bound variables properly one day. All Lean implementations I've seen so far use strings or <code>Lean.Name</code> for variables. And another thing that puzzles me is whether we could use <code>u v</code> as the syntax for application (rather than <code>u ¬∑ v</code>).</p>",
        "id": 488877425,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734107169
    },
    {
        "content": "<p>Unexpanders in this case are just a simpler form of delaborators</p>",
        "id": 488879093,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734107724
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/extra/03_pretty-printing.html?highlight=Unexpanders#unexpanders\">https://leanprover-community.github.io/lean4-metaprogramming-book/extra/03_pretty-printing.html?highlight=Unexpanders#unexpanders</a></p>",
        "id": 488879096,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734107726
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"345260\">Andrej Bauer</span> <a href=\"#narrow/channel/113488-general/topic/.E2.9C.94.20Invoking.20a.20macro.20on.20a.20custom.20syntactic.20category/near/488877425\">said</a>:</p>\n<blockquote>\n<p>I am hoping to be able to handle bound variables properly one day. All Lean implementations I've seen so far use strings or <code>Lean.Name</code> for variables. And another thing that puzzles me is whether we could use <code>u v</code> as the syntax for application (rather than <code>u ¬∑ v</code>).</p>\n</blockquote>\n<p>There is also an <code>ident</code> syntax category to handle this naturally. I have used it here. I didn't do nameless binders because this formalisation was for a course (which used Coq).</p>",
        "id": 488879303,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734107798
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"345260\">Andrej Bauer</span> <a href=\"#narrow/channel/113488-general/topic/.E2.9C.94.20Invoking.20a.20macro.20on.20a.20custom.20syntactic.20category/near/488877425\">said</a>:</p>\n<blockquote>\n<p>I am hoping to be able to handle bound variables properly one day. All Lean implementations I've seen so far use strings or <code>Lean.Name</code> for variables. And another thing that puzzles me is whether we could use <code>u v</code> as the syntax for application (rather than <code>u ¬∑ v</code>).</p>\n</blockquote>\n<p>I don't see an obstacle to any syntax outside the <code>term</code> syntax category other than parsing issues.</p>",
        "id": 488879409,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734107843
    },
    {
        "content": "<p>Naively replacing \" \\. \" with \" \" throws invalid atom in <code>syntax</code> declarations.</p>",
        "id": 488879684,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734107944
    },
    {
        "content": "<p>But lean also lets you write your own parser functions</p>",
        "id": 488879809,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734108001
    },
    {
        "content": "<p>When I wrote the above I used this repo to learn the basics by example: <a href=\"https://github.com/arthurpaulino/FxyLang/blob/master/FxyLang/Implementation/Syntax.lean\">https://github.com/arthurpaulino/FxyLang/blob/master/FxyLang/Implementation/Syntax.lean</a></p>",
        "id": 488880013,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734108074
    },
    {
        "content": "<p>Thanks. I know about <code>ident</code> and I am using it, just like you. What needs to be done is proper error handling of undeclared variables. For example, in <code>x : X, y : Y |  ‚å©x, z‚å™</code> should say \"unknown variable <code>z</code>\". And we should use <a href=\"http://adam.chlipala.net/papers/PhoasICFP08/\">PHOAS</a> to build expressions. In case you're interested, here is the <a href=\"https://github.com/andrejbauer/triposes/blob/1100a005e18a32e092e83969b2fc664c67b5a761/Triposes/FPCatDSL2.lean\">current version of the code</a> we're working on.</p>",
        "id": 488882143,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734108755
    },
    {
        "content": "<p>There is a phoas example in lean's manual</p>",
        "id": 488893430,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734112664
    },
    {
        "content": "<p>It is borrowed from cpdt if I remember correctly</p>",
        "id": 488893517,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734112688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"345260\">Andrej Bauer</span> <a href=\"#narrow/channel/113488-general/topic/.E2.9C.94.20Invoking.20a.20macro.20on.20a.20custom.20syntactic.20category/near/488882143\">said</a>:</p>\n<blockquote>\n<p>Thanks. I know about <code>ident</code> and I am using it, just like you. What needs to be done is proper error handling of undeclared variables. For example, in <code>x : X, y : Y |  ‚å©x, z‚å™</code> should say \"unknown variable <code>z</code>\". And we should use <a href=\"http://adam.chlipala.net/papers/PhoasICFP08/\">PHOAS</a> to build expressions. In case you're interested, here is the <a href=\"https://github.com/andrejbauer/triposes/blob/1100a005e18a32e092e83969b2fc664c67b5a761/Triposes/FPCatDSL2.lean\">current version of the code</a> we're working on.</p>\n</blockquote>\n<p>Looks very interesting. I am currently commuting. I'll take a  closer look when I am back</p>",
        "id": 488906465,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734117958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"345260\">Andrej Bauer</span> has marked this topic as unresolved.</p>",
        "id": 488936367,
        "sender_full_name": "Notification Bot",
        "timestamp": 1734131792
    },
    {
        "content": "<p>If I can have your attention a bit more, I would greatly appreciate it. Consider the following syntax, which is meant to capture typing contexts like <code>x  :  X , y : Y, z : Z</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">fpentry</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpentry</span>\n\n<span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">fpcontext</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">fpentry</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fpcontext</span>\n</code></pre></div>\n<p>I would like to implement a function that converts the above syntax to an <code>AssocList Lean.Name Lean.Term</code>. Here's my try:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mapify</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">AssocList</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">A</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpentry</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mapify</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n</code></pre></div>\n<p>It doesn't like <code>(fpcontext| $Œì:,* )</code> in the recursive call to <code>mapify</code>, it says \"unexpected token ',*'; expected ')'\" I tried a bunch of things and I always end up with some sort of an error like that. What's the Right Way to do this sort of thing?</p>",
        "id": 488936852,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734132082
    },
    {
        "content": "<p>This works, if we ignore the silly <code>.toList.toAssocList'</code> thing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mapify</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">AssocList</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">xs</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">ts</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">],</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">zipWith</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">toAssocList'</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n</code></pre></div>\n<p>And having a default case is also a bit annoying. I'll have to figure out what monad I want to be in.</p>",
        "id": 488938072,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734132861
    },
    {
        "content": "<p>There's a combination of two small errors, the first is it wants <code>$Œì:fpentry,*</code>, and the second is that syntax quotations are monadic. Since there's nothing that needs to be hygienic, it's fine to run it unhygienically:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"w\">  </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mapify</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`fpcontext</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">AssocList</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">A</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpentry</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mapify</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Unhygienic</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">fpcontext</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">Œì</span><span class=\"o\">:</span><span class=\"n\">fpentry</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">nil</span>\n</code></pre></div>",
        "id": 488940690,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734134555
    },
    {
        "content": "<p>It also has to be <code>partial</code> unfortunately (without who knows how much more work) because it can't see that the arguments are getting smaller.</p>",
        "id": 488940770,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734134611
    },
    {
        "content": "<p>There's also a bug here in that it won't be able to handle the single-element case due to the fact that the second rule is matching a <code>,</code> after <code>$A:term</code>.</p>\n<p>Given that, your zipWith solution seems cleanest to me.</p>",
        "id": 488940868,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734134668
    },
    {
        "content": "<p>I have run into this monadicness of syntax quotations before and I think it was you who suggested <a href=\"http://unhygienic.run\">unhygienic.run</a> @Kyle.</p>",
        "id": 488941325,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734134998
    },
    {
        "content": "<p>If I may say this, lean's quotation system is incredibly confusing to use because it doesn't lend itself to natural recursive definitions. I have made this same mistake many times before, and back then I thought it was because I was a beginner. I wish there was a cleaner way to handle quotations.</p>",
        "id": 488941691,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1734135235
    },
    {
        "content": "<p>We are all beginners in <span class=\"user-mention\" data-user-id=\"112857\">@Leonardo de Moura</span>'s eyes.</p>",
        "id": 488941933,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734135410
    },
    {
        "content": "<p>Maybe it's worth remembering that <code>t:term,*</code> yields an <code>Array</code> of terms, so you shouldn't expect to write recursive macro definitions as if it were a <code>List</code> of cons cells. It's more efficient doing a fold yourself.</p>\n<p>If you're used to Scheme-style <code>syntax-rules</code> it can be a little surprising. (I was tripped up by this comma issue when making that Python-style list comprehension demo.)</p>",
        "id": 488942235,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734135630
    },
    {
        "content": "<p>I wouldn't even argue from a performance PoV. There simply isn't a nice recursive representation that solves the separator issue so it's more natural to think in terms of repetition.</p>",
        "id": 488942690,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1734135996
    },
    {
        "content": "<p>I almost edited to clarify that I meant \"efficient in the number of cases you have to write\" (though I also was thinking about the small performance impact of the splices needing to copy Arrays)</p>",
        "id": 488942888,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1734136168
    },
    {
        "content": "<p>I think I am getting the hang of it. I moved a lot of the computation to the elaboration phase, which results in much nicer terms, see <a href=\"https://github.com/andrejbauer/triposes/blob/1512151a45ea6f2cec995dbba922599fe45ef782/Triposes/FPCatDSL2.lean\">current version</a></p>",
        "id": 488945587,
        "sender_full_name": "Andrej Bauer",
        "timestamp": 1734138092
    }
]