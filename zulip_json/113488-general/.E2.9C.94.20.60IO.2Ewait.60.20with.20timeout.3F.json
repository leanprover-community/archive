[
    {
        "content": "<p>I want to call a partial pure function <code>f</code> in <code>main : IO Unit</code>. If the <strong>execution of <code>f</code> times out</strong>, the main function exits directly.<br>\nI try to implement likes this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">infiniteLoop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">infiniteLoop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">job</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">infiniteLoop</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">task</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"n\">job</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prio</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">Priority</span><span class=\"bp\">.</span><span class=\"n\">max</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2000</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sleepInterval</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finished</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">hasFinished</span><span class=\"w\"> </span><span class=\"n\">task</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">finished</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Task completed\"</span>\n<span class=\"w\">      </span><span class=\"n\">return</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Elapsed time: {elapsed}ms\"</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"n\">sleepInterval</span>\n<span class=\"w\">    </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">elapsed</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">sleepInterval</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Task timed out after {timeout}ms\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Main function completed\"</span>\n</code></pre></div>\n<p>But the program runs without outputting anything or exiting, which is not what I expected.</p>\n<p><strong>My question is</strong>: In <code>main : IO Unit</code>, how can I wait for the execution result of a pure function with a timeout mechanism? Do I have to use the <code>IO.Process</code> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.Process.Child.kill\">IO.Process.Child.kill</a> API? Is there a simpler way to implement this?</p>",
        "id": 495435218,
        "sender_full_name": "White Chen",
        "timestamp": 1737615369
    },
    {
        "content": "<p>Well, it seems that <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Elab/Tactic/BVDecide/External.html#Lean.Elab.Tactic.BVDecide.External.runInterruptible\">Lean.Elab.Tactic.BVDecide.External.runInterruptible</a> is a good reference, which use <code>IO.Process.spawn</code>, <code>IO.Process.Child.kill</code>.</p>",
        "id": 495445553,
        "sender_full_name": "White Chen",
        "timestamp": 1737620082
    },
    {
        "content": "<p>But that is for spawning external processes not for running concurrently with other lLan functions. The <code>Task</code> you are spawning should periodically check its cancellation token and give up when the token gets set. Lean tasks are a cooperative concurrency primitive not a preemptive one.</p>",
        "id": 495445982,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737620260
    },
    {
        "content": "<p>Yes, I had considered <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.checkCanceled\">IO.checkCanceled</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.cancel\">IO.cancel</a>, but the question is that <strong><code>infiniteLoop</code> is a pure function</strong>, it can not access the IO monad.  once the task execute <code>infiniteLoop</code>, it may not return and hence can not <code>IO.checkCanceled</code>.</p>",
        "id": 495446900,
        "sender_full_name": "White Chen",
        "timestamp": 1737620621
    },
    {
        "content": "<p>Yeah if you want cancellation you need to spawn at least a task with access to <code>BaseIO</code> through e.g. <code>BaseIO.asTask</code></p>",
        "id": 495447187,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1737620727
    },
    {
        "content": "<p>Something like this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">TimeoutResult</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">timeout</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withTimeout</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt32</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">timeoutTask</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">TimeoutResult</span><span class=\"bp\">.</span><span class=\"n\">timeout</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mainTask</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">asTask</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prio</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">dedicated</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">TimeoutResult</span><span class=\"bp\">.</span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">waitAny</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mainTask</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">timeoutTask</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">timeoutTask</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">mainTask</span>\n<span class=\"w\">    </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Operation timed out after {timeout}ms\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">mainTask</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">timeoutTask</span>\n<span class=\"w\">    </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">e</span>\n</code></pre></div>",
        "id": 495512662,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1737642698
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span>  Yes, this seems works as my expect.</p>",
        "id": 495725394,
        "sender_full_name": "White Chen",
        "timestamp": 1737728457
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"670422\">White Chen</span> has marked this topic as resolved.</p>",
        "id": 495725416,
        "sender_full_name": "Notification Bot",
        "timestamp": 1737728464
    }
]