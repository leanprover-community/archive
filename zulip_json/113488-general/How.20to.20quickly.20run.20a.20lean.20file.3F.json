[
    {
        "content": "<p>On minif2f dataset I generated a lot of proof and want to check validity of these proof. Each proof is a single lean file, so I only want to run one file. Howevery, I can't find good way to do this. Now I use <code>lake exe repl</code> to do this. Some time it works but sometimes don't know why, lake exe repl cannot run any command and just stuck at the first input command(input is command\\n\\n). Also, I find it strange to use repl to do this simple thing, though a benefit to use repl is that I can let all proof to share the import environment to cut the time. Another method I found (lake run) is just too time consuming on my labtop (maybe my config have problem?). I want to run these lean files as fast(&lt;0.1s or &lt;1s) as possible. What should I do?</p>",
        "id": 512227400,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744694938
    },
    {
        "content": "<p>Using the REPL to just run Lean files might indeed be a bit of an overkill. But as you said, the main benefit of the REPL is that you can reuse environments, thus speeding up proof checks by quite a lot in comparison to running complete files. In general, I found it is an order in magnitude faster on traditional benchmarks (miniF2f and ProofNet). In the kimina report, they also say they get a 10x speedup. Yesterday, I posted a message in <a class=\"stream\" data-stream-id=\"219941\" href=\"/#narrow/channel/219941-Machine-Learning-for-Theorem-Proving\">#Machine Learning for Theorem Proving</a> on how to do this with LeanInteract (see this <a href=\"#narrow/stream/219941-Machine-Learning-for-Theorem-Proving/topic/Interacting.20with.20Lean.204\">topic</a>), but you can reimplement this directly using the REPL :)</p>",
        "id": 512237211,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744699261
    },
    {
        "content": "<p>What blocks me now is that strangely REPL don't work  these days (it works before). Sometimes it just don't respond. Is there any potential thing I can do, like caching?</p>",
        "id": 512374726,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744737342
    },
    {
        "content": "<p>If you delete your .lake folder and rerun <code>lake build</code> it might fix some issues. But I am not sure how you are using the REPL. If you import Mathlib in your commands, you should make sure that it is added to the lakefile, otherwise it will not work. Or you can use <a href=\"https://github.com/augustepoiroux/LeanInteract\">LeanInteract</a>, which does all this for you under the hood. To have Mathlib, you can configure the REPL by running something like this <code>config = LeanREPLConfig(lean_version=\"v4.18.0\", project=TempRequireProject(\"mathlib\"))</code>.</p>",
        "id": 512379088,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744738691
    },
    {
        "content": "<blockquote>\n<p>But as you said, the main benefit of the REPL is that you can reuse environments, thus speeding up proof checks by quite a lot in comparison to running complete files</p>\n</blockquote>\n<p>Does the repl produce oleans when used in this way?</p>",
        "id": 512379335,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744738762
    },
    {
        "content": "<p>Probably any check against miniF2F should:</p>\n<ul>\n<li>Run <code>leanchecker</code> against the found proof <code>olean</code>s</li>\n<li>Do an axiom check (maybe REPL already does this)</li>\n</ul>",
        "id": 512379517,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744738805
    },
    {
        "content": "<p>The pickle feature of the repl produces olean files, but I am not sure these will be compatible with leanchecker.</p>",
        "id": 512379912,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744738933
    },
    {
        "content": "<p>I tried LeanInteract and it works! Thanks a lot!</p>",
        "id": 512387796,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744741395
    },
    {
        "content": "<p>But for tactic mode (or say with in a 'by' block), can't I just run a code block (just as the cmd mode)? I don't want to split my proof to tactics line by line and run in tactic mode. It seems that I can not save the state within a by block except that I use sorry and enter tactic mode, but if I do that I cannot run code block directly.The reason I want to do that is: I want to run a lot of proof with only 1 line is different, so I want to save the proof state above that line (it'swithin a 'by' block!) and only run the code behind that line, so maximized redundant run time can be saved.</p>",
        "id": 512389066,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744741807
    },
    {
        "content": "<p>if you are changing lines within a by block, then you are in tactic mode</p>",
        "id": 512389472,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744741957
    },
    {
        "content": "<p>you can't run commands in tactic mode because they would terminate the tactic block you are in</p>",
        "id": 512389547,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744741984
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113488-general/topic/How.20to.20quickly.20run.20a.20lean.20file.3F/near/512379335\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>But as you said, the main benefit of the REPL is that you can reuse environments, thus speeding up proof checks by quite a lot in comparison to running complete files</p>\n</blockquote>\n<p>Does the repl produce oleans when used in this way?</p>\n</blockquote>\n<p>I don't think the REPL ever produces oleans</p>",
        "id": 512389780,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744742070
    },
    {
        "content": "<p>(the oleans produced by pickle are not real oleans, they can only be read by unpickle)</p>",
        "id": 512389852,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744742104
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"899153\">Jiaming Shan</span> <a href=\"#narrow/channel/113488-general/topic/How.20to.20quickly.20run.20a.20lean.20file.3F/near/512389066\">said</a>:</p>\n<blockquote>\n<p>But for tactic mode (or say with in a 'by' block), can't I just run a code block (just as the cmd mode)? I don't want to split my proof to tactics line by line and run in tactic mode. It seems that I can not save the state within a by block except that I use sorry and enter tactic mode, but if I do that I cannot run code block directly.The reason I want to do that is: I want to run a lot of proof with only 1 line is different, so I want to save the proof state above that line (it'swithin a 'by' block!) and only run the code behind that line, so maximized redundant run time can be saved.</p>\n</blockquote>\n<p>There are two ways to deal with this:</p>\n<ul>\n<li>In tactic mode, you add parentheses around your proof: <code>(\\n&lt;your-proof&gt;)</code>. The breakline is important. However, I am not sure if this works in all cases. If someone can confirm this that would be amazing <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></li>\n<li>The other option is to replace the <code>sorry</code> by the proof before sending the theorem in command mode. And you do that for each proof.</li>\n</ul>",
        "id": 512395072,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744743939
    },
    {
        "content": "<p>Oh, I misread your comment. Forget the second option I mentioned.<br>\nSo, you can run the first part of your proof in tactic mode by sending <code>(\\n&lt;proof-part-1&gt;)</code> as a tactic, and then you can send <code>(\\n&lt;proof-part-2&gt;)</code> as the next tactic. You then check the <code>proof_status</code> attribute of the response. If it says <code>Completed</code>, the proof type-checks. Let me know how this goes.</p>",
        "id": 512396286,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744744382
    },
    {
        "content": "<p>Actually the second option kind of work as well if you end the first part of the proof with <code>sorry</code>. Then, you still have to continue with tactic mode though</p>",
        "id": 512398454,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744745190
    },
    {
        "content": "<p>Sorry but the problem of REPL go back again even if I use LeanInteract. That's because previously I actually implemented something that is exactly the same as LeanInteract and that doesn't work because REPL doesn't work (or say unstable, will stuck at command import Mathlib, sometime it can run very fast and sometime it will stuck forever). So 9 hours ago it works and now it stuck. <span class=\"user-mention\" data-user-id=\"321854\">@Auguste Poiroux</span></p>",
        "id": 512460455,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744778486
    },
    {
        "content": "<p>And after I ./clear-lean-cache it works again, and then after some run or passed some time it fails again</p>",
        "id": 512461165,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744778895
    },
    {
        "content": "<p>Interesting, if possible, would you mind sharing a minimal example causing this?</p>",
        "id": 512466818,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744782217
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">lean_interact</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">LeanREPLConfig</span><span class=\"p\">,</span> <span class=\"n\">LeanServer</span><span class=\"p\">,</span> <span class=\"n\">Command</span><span class=\"p\">,</span> <span class=\"n\">TempRequireProject</span>\n\n<span class=\"n\">config</span> <span class=\"o\">=</span> <span class=\"n\">LeanREPLConfig</span><span class=\"p\">(</span><span class=\"n\">verbose</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">project</span><span class=\"o\">=</span><span class=\"n\">TempRequireProject</span><span class=\"p\">(</span><span class=\"s2\">\"mathlib\"</span><span class=\"p\">))</span> <span class=\"c1\"># download and build Lean REPL</span>\n<span class=\"n\">server</span> <span class=\"o\">=</span> <span class=\"n\">LeanServer</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span> <span class=\"c1\"># start Lean REPL</span>\n\n<span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">server</span><span class=\"o\">.</span><span class=\"n\">run</span><span class=\"p\">(</span><span class=\"n\">Command</span><span class=\"p\">(</span><span class=\"n\">cmd</span><span class=\"o\">=</span><span class=\"s2\">\"import Mathlib\"</span><span class=\"p\">))</span> <span class=\"c1\">#stucks here</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Execute with options to get tactics information</span>\n<span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">server</span><span class=\"o\">.</span><span class=\"n\">run</span><span class=\"p\">(</span><span class=\"n\">Command</span><span class=\"p\">(</span><span class=\"n\">cmd</span><span class=\"o\">=</span><span class=\"s2\">\"theorem ex (n : Nat) : n = 5 â†’ n = 5 := by simp\"</span><span class=\"p\">,</span> <span class=\"n\">all_tactics</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">))</span> <span class=\"c1\">#works here</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Continue in the same environment</span>\n<span class=\"c1\"># response = server.run(Command(cmd=\"#check ex\", env=response.env))  #works here</span>\n<span class=\"c1\"># print(response)</span>\n</code></pre></div>",
        "id": 512571389,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744814621
    },
    {
        "content": "<p>Or this is more fundemental:</p>\n<p>lake exe repl<br>\n{\"cmd\":\"import Mathlib\"}</p>\n<p>And it doesn't respond. I tried this on two different machines but they both had't respond on this command (while responding {\"cmd\":\"#check 1+1\"}).<br>\nThough I haven't find any issue talking about this in lean repl github.</p>",
        "id": 512591348,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744819544
    },
    {
        "content": "<p>I am a bit surprised as well. The only case I know where the repl freezes like this is when there is not enough memory left. Are you trying to limit the memory of the process? Or are you running on a system with limited memory / high memory usage besides the repl?</p>",
        "id": 512675013,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744833549
    },
    {
        "content": "<p>I think it doesn't? For the remote machine, I run this command as soon as I start the machine, so it will have a lot of memory to use.</p>",
        "id": 512676037,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744833713
    },
    {
        "content": "<p>This is curious, and I unfortunately didn't manage to reproduce this behavior. Can you try these different things and report what they do:</p>\n<ul>\n<li>Running <code>{\"cmd\":\"import Mathlib\"}</code>. If it freezes, stop the process and retry. If you do this multiple times, does it always hang?</li>\n<li>Running <code>{\"cmd\":\"import Lean\"}</code> or other imports</li>\n<li>Running <code>{\"cmd\":\"import Mathlib\\n#check 1+1\"}</code> or other variants with more than just imports</li>\n<li>Any other idea you come up with to help narrow down the issue<br>\nTry to do that while running <code>htop</code> in another terminal to check memory and CPU usage.</li>\n</ul>",
        "id": 512680281,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744835229
    },
    {
        "content": "<p>Another thing I am thinking of: it is possible that, for some reasons, Lean tries to recompile Mathlib from scratch when you send the command <code>{\"cmd\":\"import Mathlib\"}</code>, hence the freeze. I don't know why this would happen though.<br>\nLet me know what the experiments above return, we will probably have more information about this.</p>",
        "id": 512680684,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744835396
    },
    {
        "content": "<p>For remote machine with enough memory and CPU, only import Mathlib doesn't work, import Lean and non-import calculation works. But after some time I tried import Mathlib and it worked again. It's so unstable that multiple tries at different time gives different results.</p>",
        "id": 512685866,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744837509
    },
    {
        "content": "<p>And for my personal computer (which is slower), <br>\n{\"cmd\":\"#check 1+1\"}  works,<br>\nand {\"cmd\":\"import Mathlib\"} sometimes works but sometimes not (when it works, it takes more than 1 min to get the result)</p>",
        "id": 512686490,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744837730
    },
    {
        "content": "<p>This is interesting that you get the same issue on several computers. Which version of the repl are you using? I imagine you get the same issues with LeanInteract. Can you check again the experiments above with LeanInteract?<br>\nWhich version of <code>elan</code> and <code>lake</code> are you using?</p>",
        "id": 512687571,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744837919
    },
    {
        "content": "<p>For the remote computer, I tried both LeanInteract and lake exe repl, the result is the same. Also, I add <code>elan default stable</code> before every run.</p>",
        "id": 512688547,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744838090
    },
    {
        "content": "<p>For lake verision, I have tried Lake version 5.0.0-be6c489 (Lean version 4.9.0-rc1) for lake exe repl, and the default version in LeanInteract (as the minimal code snippet shows) for LeanInteract</p>",
        "id": 512689171,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744838208
    },
    {
        "content": "<p>Oh, that's good to know. What does <code>elan --version</code> return?</p>",
        "id": 512689293,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744838238
    },
    {
        "content": "<p>elan 4.0.0 (bb75b50d2 2025-01-30)</p>",
        "id": 512689353,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744838277
    },
    {
        "content": "<blockquote>\n<p>Lean version 4.9.0-rc1</p>\n</blockquote>\n<p>If I understand well, you are using Lean v4.9.0-rc1 for both the raw repl and LeanInteract?</p>",
        "id": 512689622,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744838379
    },
    {
        "content": "<p>It's possible that <code>elan default stable</code> messes up with the repl (not sure though). What is the rationale behind running this before every run?</p>",
        "id": 512689947,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1744838509
    },
    {
        "content": "<p>No, LeanInteract is another lake version. I don't know how to check it.</p>",
        "id": 512690106,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744838564
    },
    {
        "content": "<p>you are right, maybe I don't need <code>elan default stable</code>, though I don't know how to remove the effect of this command after it is run.</p>",
        "id": 512693284,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744840037
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321854\">@Auguste Poiroux</span>  Since you remind me it might be the problem of elan, I start a new env with new elan installed, and it works! Let's hope it will not have problems from now on.</p>",
        "id": 512715191,
        "sender_full_name": "Jiaming Shan",
        "timestamp": 1744852500
    }
]