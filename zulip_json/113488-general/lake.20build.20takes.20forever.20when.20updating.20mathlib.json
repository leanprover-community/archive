[
    {
        "content": "<p>I've been doing some work in the Compfiles project and I've found an annoyance whenever mathlib gets updated there. I have to rebuild the files using <code>lake build</code>, which causes my laptop to build over 4500 files. This takes over an hour and puts my laptop's CPU under a lot of strain. However, if I delete my <code>.lake</code> folder and then build, it builds a fraction of the files. Is there a way to build without deleting and redownloading everything?</p>",
        "id": 451196437,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720888528
    },
    {
        "content": "<p>You should be able to just run <code>lake exe cache get</code> to download mathlib's build cache</p>",
        "id": 451197402,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720889163
    },
    {
        "content": "<p>I did make sure to do that. The same problem occurs.</p>",
        "id": 451197468,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720889218
    },
    {
        "content": "<p>That's unusual. Is your toolchain the same as the one from the mathlib commit you are using as well?</p>",
        "id": 451197610,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720889316
    },
    {
        "content": "<p>I ran <code>elan update</code> and <code>lake update</code>.</p>",
        "id": 451197759,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720889419
    },
    {
        "content": "<p>That's not going to fix your toolchain to the one mathlib uses. Mathlib's master branch usually uses the latest stable version available (up to relese candidates), you can check their lean-toolchain file. Your lean-toolchain file must match that such that you can use mathlib's build cache.</p>",
        "id": 451198096,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720889683
    },
    {
        "content": "<p>Ours are both <code>leanprover/lean4:v4.10.0-rc2</code></p>",
        "id": 451198249,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720889804
    },
    {
        "content": "<p>Then it's not quite clear to me why the cache doesn't work I'm afraid</p>",
        "id": 451198388,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720889902
    },
    {
        "content": "<p>Maybe someone else who knows that part of the infra better can help.</p>",
        "id": 451198399,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720889911
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"632788\">@shortc1rcuit</span>, could you provide a commit that someone could check out, at which <code>lake exe cache get</code> appears to work, but <code>lake build</code> still needs to recompile?</p>",
        "id": 451198910,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720890166
    },
    {
        "content": "<p>Jumping to <a href=\"https://github.com/dwrensha/compfiles/commit/457f6fc560d4e6a3893fbf9885ea0959e4fa5af2\">this commit</a> (i.e. the one before <a href=\"https://github.com/dwrensha/compfiles/commit/629f636e966e5c907b04bfab95d2057b8420312b\">this commit</a>) seems to recreate the issue for me.</p>",
        "id": 451200940,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720891103
    },
    {
        "content": "<p>Also it may be an issue with <code>lake exe cache get</code></p>",
        "id": 451200981,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720891133
    },
    {
        "content": "<p>What's the normal output for that command?</p>",
        "id": 451200994,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720891145
    },
    {
        "content": "<p>When successful, it outputs a success message: <code>Completed successfully!</code>.</p>",
        "id": 451203925,
        "sender_full_name": "Rida Hamadani",
        "timestamp": 1720892821
    },
    {
        "content": "<p>Ok that all seems to work</p>",
        "id": 451207446,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720894766
    },
    {
        "content": "<p>So if it's not getting the cache I'm not sure what is wrong</p>",
        "id": 451224945,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720903275
    },
    {
        "content": "<p>Does running <code>lake exe cache get!</code> make your build fast? (To be clear: this is a band-aid fix, not a real solution. I'd rather use that than have to manually rebuild everything, though.)</p>",
        "id": 451334561,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720946185
    },
    {
        "content": "<p>It does not seem to no</p>",
        "id": 451361638,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720969383
    },
    {
        "content": "<p>Actually it does</p>",
        "id": 451361739,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720969489
    },
    {
        "content": "<p>In fact everything seems to be working.</p>",
        "id": 451362097,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720969837
    },
    {
        "content": "<p>Not sure what fixed that</p>",
        "id": 451362103,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720969845
    },
    {
        "content": "<p>But now getting the cache normally doesn't mean the builds take forever.</p>",
        "id": 451362120,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720969867
    },
    {
        "content": "<p>Yay?</p>",
        "id": 451362124,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720969876
    },
    {
        "content": "<p>Sorry to anyone in the future who came here thinking this would contain the solution</p>",
        "id": 451362131,
        "sender_full_name": "shortc1rcuit",
        "timestamp": 1720969904
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"632788\">shortc1rcuit</span> has marked this topic as resolved.</p>",
        "id": 451374730,
        "sender_full_name": "Notification Bot",
        "timestamp": 1720983548
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"632788\">shortc1rcuit</span> has marked this topic as unresolved.</p>",
        "id": 451374735,
        "sender_full_name": "Notification Bot",
        "timestamp": 1720983554
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"632788\">@shortc1rcuit</span> Probably some file in the cache was corrupted (e.g. by an interrupted download) and <code>lake exe cache get!</code> forcefully redownloaded the file, thereby fixing the problem.</p>",
        "id": 451415484,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721022619
    }
]