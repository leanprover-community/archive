[
    {
        "content": "<p>Hi everyone, I'm very new to Lean metaprogramming. In one of the toy tactics I'm trying to implement, I have a localDecl from the local context, and want to pass it as an argument to a tactic (e. g. <code>cases</code>). I tried a few things, but I ended up creating a new hypothesis and passing it to the tactic instead. Here's a minimal example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"h_cases\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">fvarId</span><span class=\"bp\">.</span><span class=\"n\">getUserName</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"h\"</span><span class=\"bp\">.</span><span class=\"n\">toName</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">continue</span>\n<span class=\"w\">      </span><span class=\"c1\">-- Both of these approaches create a new hypothesis named ``h and try to run the tactic on it,</span>\n<span class=\"w\">      </span><span class=\"c1\">-- instead of running the tactic on h</span>\n\n<span class=\"w\">      </span><span class=\"c1\">-- let hExpr := Expr.fvar h.fvarId</span>\n<span class=\"w\">      </span><span class=\"c1\">-- let eTerm : TSyntax `Lean.Parser.Tactic.elimTarget := ⟨← PrettyPrinter.delab hExpr⟩</span>\n<span class=\"w\">      </span><span class=\"c1\">-- evalTactic (← `(tactic| cases $eTerm))</span>\n\n<span class=\"w\">      </span><span class=\"c1\">-- let eStx : Syntax := Syntax.ident SourceInfo.none userName.toString.toSubstring userName []</span>\n<span class=\"w\">      </span><span class=\"c1\">-- evalTactic (← `(tactic| cases $(⟨eStx⟩)))</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- If I uncomment one of the code blocks above, h_cases creates a new unnamed hypothesis and fails</span>\n<span class=\"w\">  </span><span class=\"c1\">-- with the following error:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Tactic `cases` failed: major premise type is not an inductive type</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ?m.4</span>\n<span class=\"w\">  </span><span class=\"n\">h_cases</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Does anyone know how to do this properly?</p>",
        "id": 569973123,
        "sender_full_name": "Iva Dashevskii",
        "timestamp": 1769366192
    },
    {
        "content": "<p>does it need to be an <code>evalTactic</code>?</p>",
        "id": 569973258,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769366294
    },
    {
        "content": "<p>if you have the fvarid then for <code>cases</code> for example you can just use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.MVarId.cases#doc\">docs#Lean.MVarId.cases</a> it</p>",
        "id": 569973292,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769366330
    },
    {
        "content": "<p>there's also <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.exprToSyntax#doc\">docs#Lean.Elab.Term.exprToSyntax</a> if you really do need to embed it into syntax</p>",
        "id": 569973405,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769366426
    },
    {
        "content": "<p>your first attempt is actually quite close, <code>cases</code> was failing because you had malformed syntax</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"h_cases\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">fvarId</span><span class=\"bp\">.</span><span class=\"n\">getUserName</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"h\"</span><span class=\"bp\">.</span><span class=\"n\">toName</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">continue</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">fvarId</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eTerm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Tactic.elimTarget</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">elimTarget</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">hExpr</span><span class=\"o\">):</span><span class=\"n\">term</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">eTerm</span><span class=\"o\">))</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">h_cases</span>\n<span class=\"w\">  </span><span class=\"c1\">-- it works</span>\n</code></pre></div>",
        "id": 569974084,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769367060
    }
]