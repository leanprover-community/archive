[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"c1\">-- | _ =&gt; 0</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">failed to compile pattern matching, stuck at</span>\n<span class=\"cm\">  remaining variables: [x✝:(Array ℕ)]</span>\n<span class=\"cm\">  alternatives:</span>\n<span class=\"cm\">    [a:(ℕ), b:(ℕ), c:(ℕ)] |- [#[a, b, c]] =&gt; h_1 a b c</span>\n<span class=\"cm\">    [a:(ℕ), c:(ℕ)] |- [#[a, c]] =&gt; h_2 a c</span>\n<span class=\"cm\">    [a:(ℕ)] |- [#[a]] =&gt; h_3 a</span>\n<span class=\"cm\">    [] |- [#[]] =&gt; h_4 ()</span>\n<span class=\"cm\">  examples:_</span>\n\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"c1\">-- | _ =&gt; 0</span>\n<span class=\"c1\">-- missing cases: (List.cons _ (List.cons _ (List.cons _ (List.cons _ (List.cons _ _)))))</span>\n</code></pre></div>\n<p>I have an idea of why but wanted to be sure. Is it that the pattern matcher does not have access to any length info, so it assumes any length array/list can be passed, so there needs to be a catchall for arbitrary length cases?</p>",
        "id": 483346542,
        "sender_full_name": "Alok Singh",
        "timestamp": 1732047747
    },
    {
        "content": "<p>yes, that seems right to me.</p>",
        "id": 483346690,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732047814
    },
    {
        "content": "<p>if you want to match an exact number of values, you can use <code>match (1,2,3) with |(a,b,c) =&gt; a+ b+ c</code></p>",
        "id": 483346848,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732047872
    },
    {
        "content": "<p>i.e. match on a tuple, where lean can tell that indeed there is an exact number of items.</p>",
        "id": 483346895,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732047896
    },
    {
        "content": "<p>makes sense, was curious about specifically array/list after reading that pattern matching supports array literals</p>",
        "id": 483346902,
        "sender_full_name": "Alok Singh",
        "timestamp": 1732047900
    },
    {
        "content": "<p>slight digression, if i wanted to write a custom pattern matcher, is that possible?</p>\n<p>say for </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"c1\">-- assume some literal syntax like (v[1,2,3] : Vector Nat 3) is defined</span>\n\n<span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"c1\">-- no catch all needed</span>\n</code></pre></div>",
        "id": 483347231,
        "sender_full_name": "Alok Singh",
        "timestamp": 1732048026
    },
    {
        "content": "<p>you are matching on an array here, so of course the longer arrays have to be handled?</p>",
        "id": 483347282,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732048043
    },
    {
        "content": "<p>No, there is no way to extend the pattern language currently, the match compiler is not extensible</p>",
        "id": 483347348,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732048076
    },
    {
        "content": "<p>you can make macros that fire in pattern position though</p>",
        "id": 483347419,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732048092
    },
    {
        "content": "<p>Actually, I bet you could make that example work, although it probably won't generate very good code</p>",
        "id": 483347566,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732048171
    },
    {
        "content": "<p>dang, so close and yet so far</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Vector</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">vecNotation</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"#v[\"</span><span class=\"w\"> </span><span class=\"n\">withoutPosition</span><span class=\"o\">(</span><span class=\"n\">sepBy</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\", \"</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Vector</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">vecNotation</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabVectorNotation</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">elems</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">inPattern</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">elems</span><span class=\"bp\">.</span><span class=\"n\">getElems</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">elems</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">]</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">elems</span><span class=\"bp\">.</span><span class=\"n\">getElems</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">elems</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"o\">]</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"c1\">-- invalid pattern</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"n\">c</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n</code></pre></div>\n<p>It doesn't work because <code>match</code> only expands macros, not elabs, and macros are not given access to <code>inPattern</code></p>",
        "id": 483349403,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732048883
    },
    {
        "content": "<p>i'm very appreciative but a bit apprehensive that you're so nerd-snipable <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span></p>",
        "id": 483350496,
        "sender_full_name": "Alok Singh",
        "timestamp": 1732049284
    },
    {
        "content": "<p>what? that's, like, my thing</p>",
        "id": 483350547,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732049308
    },
    {
        "content": "<p>it is? i thought that was yaels?</p>",
        "id": 483350606,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732049340
    },
    {
        "content": "<p>Oh, there are many nerds here...</p>",
        "id": 483350683,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732049380
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113489-new-members/topic/why.20does.20this.20array.2Flist.20pattern.20match.20fail.3F/near/483350683\">said</a>:</p>\n<blockquote>\n<p>Oh, there are many nerds here...</p>\n</blockquote>\n<p>understatement of the year</p>",
        "id": 483350711,
        "sender_full_name": "Alok Singh",
        "timestamp": 1732049397
    },
    {
        "content": "<p>like sniping nerds in a barrel</p>",
        "id": 483350862,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732049443
    },
    {
        "content": "<p>this isn't even full on nerd sniped, it's a few lines of code. Full nerd sniping is writing a fix to lean core, and then belatedly making an RFC for that because that's what you need to do now</p>",
        "id": 483351007,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732049498
    },
    {
        "content": "<p>I can see where you are headed, Mario.</p>",
        "id": 483351138,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732049537
    },
    {
        "content": "<p>well, he <em>had</em> to do it guys</p>",
        "id": 483351227,
        "sender_full_name": "Alok Singh",
        "timestamp": 1732049572
    },
    {
        "content": "<p>at least i never wrote a tool because i felt it was missing... <a href=\"https://github.com/leanprover-community/batteries/pull/948\">ahem</a></p>",
        "id": 483351280,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732049595
    },
    {
        "content": "<p>TBH I'm <em>not</em> headed there, it's the part of the process that is not fun</p>",
        "id": 483351290,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732049602
    },
    {
        "content": "<p>the actual way to do this kind of thing now is to hint to FRO members that it's a worthwhile problem and then maybe later it will show up on the lean commit feed</p>",
        "id": 483351437,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732049652
    },
    {
        "content": "<p>transitive nerdsniping?</p>",
        "id": 483351498,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732049678
    },
    {
        "content": "<p>remote sniping</p>",
        "id": 483351588,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732049706
    }
]