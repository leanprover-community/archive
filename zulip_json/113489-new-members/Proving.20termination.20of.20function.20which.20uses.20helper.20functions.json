[
    {
        "content": "<p>Consider the following example (<a href=\"https://live.lean-lang.org/#codez=JYOwJgrgxgLsBuBTABAFQE6MQLjQTwAcUBaAPnyOQHcALRTAKAB9kAZRAQwDNlkBvAIK5UhRAF8AFPA4AbCDmQCAlMmGYUA5sgBC6DiCg1Bw0ZMPAZYTCFwA5DjGRk06xUrVZFDBmEQ8MWAB0UAD2IHAg8gDk/AI6JkSSXB4aTuQBKNruLp5xzhk6WuzcyNJyKAC85DwSxTxl8kpauvqGyOaW1shVOnoGNMgSPIAYRO00FlaIIE0+fjmIgVwyDgCyHASC8RTiQ7h56a5Z2AX784UsdaWy8t3VV+VaAM6IMlwAAhIt/e1hMCpVDF4vGer2Cv1A0UGAHbFssYGsCMguEogA\">see code</a>)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Leaf</span><span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Branch</span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">children</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">continue'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">flatMap</span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">):</span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">value</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">@</span><span class=\"o\">(</span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"n\">cont</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">continue'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">flatMap</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Lean4 complains that <code>Tree.flatMap</code> cannot be proven terminating in this instance. However, if I unfold the definition of <code>continue'</code> in the <code>Tree.flatMap</code> implementation (<a href=\"https://live.lean-lang.org/#codez=JYOwJgrgxgLsBuBTABAFQE6MQLjQTwAcUBaAPnyOQHcALRTAKAB9kAZRAQwDNlkBvAIK5UhRAF8AFPA4AbCDmQCAlMmGYUA5sgBC6DiCg1Bw0ZMPAZYTCFwA5DjGRk06xUrVZFDBmEQ8MWAB0UAD2IHAg8gDk/AI6JkSSXB4aTuQBKNruLp5xzhk6WuzcyNJyKAC85DwSxTxl8kpauvqGyOaW1shVOnoGNMgSPIAYRO00FlaIIE0+fjmIgVwyDgCyHASC8RTiQ7h56a5Z2AX784UsdaWy8t3VV+VaAM6IMlwAAhIt/WMT1ipVDF4vC+bS4EBAyAAHrdBh1JhDoUxSItljA1gRkFwlEA\">see code</a>), then termination is accepted.</p>\n<p>I see that this is because in the first case I'm not executing the function on a subterm on the arguments, but I don't know how to prove termination in this case in a \"simple\" way. I feel it shouldn't be too difficult, but proofs of termination is an area in Lean4 I'm not too familiar with yet.</p>\n<p>Any guidance is appreciated <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>",
        "id": 495911822,
        "sender_full_name": "Ayhon",
        "timestamp": 1737845529
    },
    {
        "content": "<p>I think lean would like to have some simp lemmas about <code>continue'</code></p>",
        "id": 495946805,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1737880155
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/113489-new-members/topic/Proving.20termination.20of.20function.20which.20uses.20helper.20functions/near/495946805\">said</a>:</p>\n<blockquote>\n<p>I think lean would like to have some simp lemmas about <code>continue'</code></p>\n</blockquote>\n<p>What kind of lemmas? Those supported by definitional equality? This is what I first thought of, but it doesn't seem to be enough (<a href=\"https://live.lean-lang.org/#codez=JYOwJgrgxgLsBuBTABAFQE6MQLjQTwAcUBaAPnyOQHcALRTAKAB9kAZRAQwDNlkBvAIK5UhRAF8AFPA4AbCDmQCAlMmGYUA5sgBC6DiCg1Bw0ZMPAZYTCFwA5DjGRk06xUrVZFDBmEQ8MWAB0UAD2IHAg8gDk/AI6JkSSXB4aTuQBKNruLp5xzhk6WuzcyNJyKAC85DwSxTxl8kpauvqGyOaW1shVOnoGNMgSPIAYRO00FlaIIE0MAAIA2gDOwAC2BAC6DDB0IZgrOYjBYRHRAPoARn2GgvEU4kMpimkHOkoSHZM2yPaO+a7KDBSR3CoGiyBqLX6Ywm1hUFV6rQGQ2Qow+sMB8POeGQ6C4Mm8vn86kCeIcAFkOAQbtoEvdkk8/p4stgCnl0q5tEVOPVZPJutVSrzEFpFogZFxZhJIW1QuE4aQGLxeKLxcCTogYhIAO0kmTkyngppAA\">see code</a>)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Leaf</span><span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Branch</span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">children</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">continue'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">continue'_branch</span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)(</span><span class=\"n\">children</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n<span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">continue'</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"o\">)</span>\n<span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"bp\">.</span><span class=\"n\">flatMap</span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}(</span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">):</span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Tree</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Leaf</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">value</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">@</span><span class=\"o\">(</span><span class=\"n\">Branch</span><span class=\"w\"> </span><span class=\"n\">cont</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">continue'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">flatMap</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 496056998,
        "sender_full_name": "Ayhon",
        "timestamp": 1737965064
    },
    {
        "content": "<p>Doesn't your definition allow me to encode infinite trees? Then the functions are probably not terminating in the most cases either.<br>\n<code>def infiniteTree: Tree Nat := Tree.Branch (fun n =&gt; Tree.Leaf n)</code></p>\n<p>Do you need that many children in your tree or would a list of trees suffice?</p>",
        "id": 496068654,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1737968899
    },
    {
        "content": "<p>Actually, this is a simplification of some other definitions I have, but without as much context. I made the mistake of using Nat, which is infinite, where something like Fin n would have been more appropriate. However, it's still true that Lean4 accepts the definition of <code>flatMap</code> if I unfold <code>continue'</code>, which is why I didn't edit my previous message. See <a href=\"https://live.lean-lang.org/#codez=JYOwJgrgxgLsBuBTABAFQE6MQLjQTwAcUBaAPnyOQHcALRTAKAB9kAZRAQwDNlkBvAIK5UhRAF8AFPA4AbCDmQCAlMmGYUA5sgBC6DiCg1Bw0ZMPAZYTCFwA5DjGRk06xUrVZFDBmEQ8MWAB0UAD2IHAg8gDk/AI6JkSSXB4aTuQBKNruLp5xzhk6WuzcyNJyKAC85DwSxTxl8kpauvqGyOaW1shVOnoGNMgSPIAYRO00FlaIIE0+fjmIgVwyDgCyHASC8RTiQ7h56a5Z2AX784UsdaWy8t3VV+VaAM6IMlwAAhIt/WMT1ipVDF4vC+bS4EBAyAAHrdBh1JhDoUxSItljA1gRkFwlEA\">https://live.lean-lang.org/#codez=JYOwJgrgxgLsBuBTABAFQE6MQLjQTwAcUBaAPnyOQHcALRTAKAB9kAZRAQwDNlkBvAIK5UhRAF8AFPA4AbCDmQCAlMmGYUA5sgBC6DiCg1Bw0ZMPAZYTCFwA5DjGRk06xUrVZFDBmEQ8MWAB0UAD2IHAg8gDk/AI6JkSSXB4aTuQBKNruLp5xzhk6WuzcyNJyKAC85DwSxTxl8kpauvqGyOaW1shVOnoGNMgSPIAYRO00FlaIIE0+fjmIgVwyDgCyHASC8RTiQ7h56a5Z2AX784UsdaWy8t3VV+VaAM6IMlwAAhIt/WMT1ipVDF4vC+bS4EBAyAAHrdBh1JhDoUxSItljA1gRkFwlEA</a></p>",
        "id": 496071252,
        "sender_full_name": "Ayhon",
        "timestamp": 1737969806
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"619540\">Johannes Tantow</span> <a href=\"#narrow/channel/113489-new-members/topic/Proving.20termination.20of.20function.20which.20uses.20helper.20functions/near/496068654\">said</a>:</p>\n<blockquote>\n<p>Doesn't your definition allow me to encode infinite trees? Then the functions are probably not terminating in the most cases either.<br>\n<code>def infiniteTree: Tree Nat := Tree.Branch (fun n =&gt; Tree.Leaf n)</code></p>\n<p>Do you need that many children in your tree or would a list of trees suffice?</p>\n</blockquote>\n<p>Actually, upon thinking about it more closely, while this definition does encode inifinite trees, it does so lazily so there's no worries of it being non-terminating. In the end, I'm just morphing the definition of the <code>children</code> function through function composition. This is  evident by the generated <code>SizeOf</code> instance for it, which is constantly <code>1</code> (<a href=\"https://live.lean-lang.org/#codez=JYOwJgrgxgLsBuBTABAFQE6MQLjQTwAcUB3AC0UwCgAfZAGUQEMAzZN3DLG5AIXUZBRSACiHAANmEwhcAOUYxkAWgB8aTIgCUHDZUoBiAM54QMUsmEBlYAC9EAeVactBgulCLnAOgD6h2w7MPqCGMK7upupYvv52jj4AjHoA9Ep6YIhOGl5QAPamoBCIAOTIAN4AgrwchIgAvsLMOljIVapRKDzaHa3Kas683AwsyPCM4kXIALxqrMLDrGMTLrR8AkLIYpLS02prguaNyIAYRJukElKIIJrpmR1ezOIKALKMBJXV+EQNTb3tA11sAM2v0NINaAtRuNJjNkItoYhuIZEOJmAABYT7DZ5UyaXaUNhsZGonL5OAgIqlYQAdoeTxgrwIcJueiUySAA\">source</a>).</p>",
        "id": 496842276,
        "sender_full_name": "Ayhon",
        "timestamp": 1738261908
    }
]