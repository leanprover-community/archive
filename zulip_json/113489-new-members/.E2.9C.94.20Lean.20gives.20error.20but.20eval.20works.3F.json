[
    {
        "content": "<p>Hi,</p>\n<p>I am working through FPiL and I'm trying to \"generalize\" the <code>CoeFun</code> example presented in Ch4.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\">  </span><span class=\"n\">Adder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">howMuch</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">add5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Adder</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">5</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Adder</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"bp\">.</span><span class=\"n\">howMuch</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">add5</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n</code></pre></div>\n<p>Both in VSCode and from the cmdline, I get the following output:</p>\n<p><code>\nerror: cannot find synthesization order for instance @instCoeFunAdderForallOfHAdd with type\n  {a : Type} → {b : Type u_1} → {c : Type u_2} → [inst : HAdd a b c] → CoeFun (Adder a) fun x =&gt; b → c\nall remaining arguments have metavariables:\n  HAdd a ?b ?c\n9\n</code></p>\n<p>Trying to interpret the error, I _think_ that it's saying that it's not able to figure out b and c because they are not mentioned in the instance signature (is that the terminology?)</p>\n<p>How is it possible to get a type error, yet the code seems to \"work\"?  Is there a way to fix the example?</p>\n<p>Thanks,</p>\n<p>Tom</p>",
        "id": 471419009,
        "sender_full_name": "Tom",
        "timestamp": 1726730039
    },
    {
        "content": "<p>Hi Tom, I'm sure someone else can supply better answer, until then, I've seen other examples where lean will eval expressions that are not well typed, but that is still mysterious for me. I think the issue is that <code>b</code> and <code>c</code> are unbound type variables at compile time, which sounds like a lot like what you're thinking.</p>\n<p>I did manage to get an example that works (and type checks), but I'm not sure it does what you intended. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyAdder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">howMuch</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">float_add5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyAdder</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"mf\">5.0</span><span class=\"o\">:</span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">int_add5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyAdder</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">complex_add5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyAdder</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"n\">ℂ</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyAdder</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">my_adder</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">my_adder</span><span class=\"bp\">.</span><span class=\"n\">howMuch</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">float_add5</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">int_add5</span><span class=\"w\"> </span><span class=\"mi\">4</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">complex_add5</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n</code></pre></div>\n<p>I hope someone can clear this up for you because I'd also like to hear the details and terminology.</p>",
        "id": 471503898,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1726757376
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"317929\">@Derek Rhodes</span> ,</p>\n<p>Thank you for your response and providing the example.  <code>HAdd a a a</code> definitely works;  the main reason why I used <code>HAdd a b c</code> rather than just <code>HAdd a a a</code>/<code>Add a</code> was to specifically explore the heterogeneity of the addition and learn about how the constraints of the \"signature\" and the function body interact; I can't say I have a good grasp of the process involved.<br>\nI also find it bewildering that I'm getting an error but the code runs. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> .  Hopefully someone with better grasp of the compiler than me can  help me!</p>\n<p>Thanks!</p>\n<p>Tom</p>",
        "id": 471522126,
        "sender_full_name": "Tom",
        "timestamp": 1726762920
    },
    {
        "content": "<p>It's not due to the compiler, <code>#check add5 4</code> also works</p>",
        "id": 471536308,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726768112
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span> ,<br>\nWhat do you mean in your last message?  The compiler is emitting an error at the line with the instance definition.</p>",
        "id": 471536774,
        "sender_full_name": "Tom",
        "timestamp": 1726768294
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> <a href=\"#narrow/stream/113489-new-members/topic/Lean.20gives.20error.20but.20eval.20works.3F/near/471536774\">said</a>:</p>\n<blockquote>\n<p>Hi <span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> ,<br>\nWhat do you mean in your last message?  The compiler is emitting an error at the line with the instance definition.</p>\n</blockquote>\n<p>That's not the compiler, that's a different component (the elaborator, I believe)</p>",
        "id": 471536890,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726768323
    },
    {
        "content": "<p>The compiler is responsible for producing executable code</p>",
        "id": 471536926,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726768334
    },
    {
        "content": "<p>I see.  However, from my current/learner's point of view the \"lean compiler\" is the <code>f(input text)</code>, even though I understand that compilers usually have multiple stages.<br>\nDoes understanding that the error is coming from the Eleborator help clarify my question?  Why does an error in the Eleborator allow the code to still type check/work?</p>",
        "id": 471537678,
        "sender_full_name": "Tom",
        "timestamp": 1726768621
    },
    {
        "content": "<p>Looking at the output of <code>set_option trace.Meta.synthInstance true</code> it seems like despite the error the instance is still registered. This might be a bug</p>",
        "id": 471538887,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726769003
    },
    {
        "content": "<p>It looks like the \"cannot find synthesization order\" error isn't a hard error, and the instance is still added as an instance. If you hover over the <code>instance</code> keyword you can see that the name of the definition it adds is <code>instCoeFunAdderForallOfHAdd</code> (just like in the error message). You can <code>#print instCoeFunAdderForallOfHAdd</code> too.</p>\n<p>Somehow this coercion instance still works even without a synthesization order, which explains why <code>add5 4</code> can elaborate. There are no errors in <code>add5 4</code>. The only problem is that the instance has some theoretical problems that could limit its applicability.</p>",
        "id": 471538935,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769023
    },
    {
        "content": "<p>There's a mechanism to turn off the error too:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">synthInstance</span><span class=\"bp\">.</span><span class=\"n\">checkSynthOrder</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Adder</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"bp\">.</span><span class=\"n\">howMuch</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 471539194,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769107
    },
    {
        "content": "<p>Thanks for the answers!  I will cross-link to <code>lean 4</code> and ask if this is a bug.</p>",
        "id": 471539408,
        "sender_full_name": "Tom",
        "timestamp": 1726769180
    },
    {
        "content": "<p>I don't think it's a bug</p>",
        "id": 471539471,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769204
    },
    {
        "content": "<p>I think it's definitely confusing behavior, even if it's not strictly a bug</p>",
        "id": 471539605,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726769253
    },
    {
        "content": "<p>If I understand correctly, this happens to work in the end even though the instance is \"bad\" because the <code>Add</code> default instance kicks in.</p>",
        "id": 471539613,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769255
    },
    {
        "content": "<p>What would you want instead? A better error message that explains what synth orders are and that it doesn't mean the instance wasn't added and that it doesn't mean there's any type errors? To not add the instance at all and make it a hard error? Something else?</p>",
        "id": 471539895,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769381
    },
    {
        "content": "<p>(conversation continued at <a href=\"#narrow/stream/270676-lean4/topic/Confusing.20instance.20error/near/471539940\">https://leanprover.zulipchat.com/#narrow/stream/270676-lean4/topic/Confusing.20instance.20error/near/471539940</a>)</p>",
        "id": 471540499,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1726769624
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> ,</p>\n<p>Thanks.  I don't have a preference because I don't know enough to have an opinion.  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>\n<p>I'm trying my best to learn Lean and the mountain of theory behind how it works.  I guess as a learner (and someone who has built compilers in the past) when I see an error (like e.g. from other compilers I've used), I feel confused by why things still \"work\".  At times, I don't know if it's some basic misunderstanding on my part, or something else. <br>\nSorry I don't have a better answer!</p>",
        "id": 471541005,
        "sender_full_name": "Tom",
        "timestamp": 1726769826
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> has marked this topic as resolved.</p>",
        "id": 471558730,
        "sender_full_name": "Notification Bot",
        "timestamp": 1726777787
    }
]