[
    {
        "content": "<p>I'm trying to emulate record types with dynamic field names and types using a <code>DHashMap</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fieldTypesList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"s2\">\"age\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"name\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">HashMap</span><span class=\"bp\">.</span><span class=\"n\">ofList</span><span class=\"w\"> </span><span class=\"n\">fieldTypesList</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">RecordType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DHashMap</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span><span class=\"o\">[</span><span class=\"n\">field</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"n\">h</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myRecord</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RecordType</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">DHashMap</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"s2\">\"age\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"s2\">\"name\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"myName\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But I get these errors:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span><span class=\"o\">[</span><span class=\"s2\">\"age\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">numerals</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">polymorphic</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">numeral</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"mi\">0</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">  </span><span class=\"n\">fieldTypes</span><span class=\"o\">[</span><span class=\"s2\">\"age\"</span><span class=\"o\">]</span>\n<span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">absence</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">above</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"s2\">\"myName\"</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">fieldTypes</span><span class=\"o\">[</span><span class=\"s2\">\"name\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>For some reason Lean can't figure out that <code>fieldTypes[\"age\"]'h</code> reduces to <code>Nat</code> and that <code>fieldTypes[\"name\"]'h</code> reduces to <code>String</code>. Am I doing something wrong here?</p>",
        "id": 511815393,
        "sender_full_name": "aron",
        "timestamp": 1744467630
    },
    {
        "content": "<p>I don't know what you should do instead, but I'm not surprised to see that <code>fieldTypes[\"name\"]'h</code> doesn't reduce to <code>String</code>.</p>\n<p>Maybe it's complex enough that it needs some custom elaborator?</p>",
        "id": 511869174,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744515352
    },
    {
        "content": "<p><code>Std.HashMap</code> wasn't designed for kernel computations. Have you seen <a href=\"https://youtu.be/pao0UQKoKO0?si=jmHdpPeMIOKA7wbv\">https://youtu.be/pao0UQKoKO0?si=jmHdpPeMIOKA7wbv</a> ? The library described there might be a better fit for your use case.</p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"pao0UQKoKO0\" href=\"https://youtu.be/pao0UQKoKO0?si=jmHdpPeMIOKA7wbv\"><img src=\"https://uploads.zulipusercontent.net/88f6f77e0d3271c1bc0c3faba2b3778805eb7e87/68747470733a2f2f692e7974696d672e636f6d2f76692f70616f3055514b6f4b4f302f6d7164656661756c742e6a7067\"></a></div>",
        "id": 511880819,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1744526217
    },
    {
        "content": "<p>This works a bit better:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"age\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"name\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">Empty</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">RecordType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DHashMap</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myRecord</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RecordType</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">∅</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DHashMap</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"s2\">\"age\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"s2\">\"name\"</span><span class=\"w\"> </span><span class=\"s2\">\"myName\"</span>\n</code></pre></div>",
        "id": 511882906,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1744528448
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260921\">Markus Himmel</span> <a href=\"#narrow/channel/113489-new-members/topic/Type-level.20dhashmap.5B.22name.22.5D'h.20doesn't.20reduce.20to.20value/near/511880819\">said</a>:</p>\n<blockquote>\n<p><code>Std.HashMap</code> wasn't designed for kernel computations. Have you seen <a href=\"https://youtu.be/pao0UQKoKO0?si=jmHdpPeMIOKA7wbv\">https://youtu.be/pao0UQKoKO0?si=jmHdpPeMIOKA7wbv</a> ? The library described there might be a better fit for your use case.</p>\n</blockquote>\n<p><del>Mm that looks interesting. I'm about 10m into the video but he hasn't mentioned the name of the library yet and it's not in the description either. Do you have a link to the library?</del></p>\n<p>Looks like it's this <a href=\"https://github.com/jrr6/lean-tables\">https://github.com/jrr6/lean-tables</a></p>",
        "id": 511893760,
        "sender_full_name": "aron",
        "timestamp": 1744538523
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> yeah but the point of this is to be able to make the fields a bit more dynamic. If I could hardcode all the field names in an if expression ahead of time I wouldn't be trying to do this in the first place</p>",
        "id": 511893860,
        "sender_full_name": "aron",
        "timestamp": 1744538631
    },
    {
        "content": "<p>I thought this would just work tbh, I don't see why maps would work any differently if they are at the type level vs if they are values.</p>\n<p>Are there any resources that would explain why this doesn't \"just work\" as I was expecting it to? Is it that Lean has a limit on how much computation it does at the type level and inserting things into a <code>DHashMap</code> crosses that limit so it stops evaluation the type expression?</p>",
        "id": 511916361,
        "sender_full_name": "aron",
        "timestamp": 1744557372
    },
    {
        "content": "<p>well, kernel \"evaluation\" is unlike normal evaluation in that it has more limits and in particular recursive functions don't always work well</p>",
        "id": 511916424,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1744557464
    },
    {
        "content": "<p>not sure what it is this time but you can quickly get \"defeq blockers\" from e.g. irreducible definitions or well-founded recursion</p>",
        "id": 511916486,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1744557502
    },
    {
        "content": "<p>oh I found the culprit: <code>protected opaque String.hash : String → UInt64</code> (yeah, opaque is another case of a blocker)</p>",
        "id": 511916632,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1744557637
    },
    {
        "content": "<p>maybe it's worth trying <code>TreeMap</code>? although this table library might be a better fit</p>",
        "id": 511916680,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1744557672
    },
    {
        "content": "<p>yup, seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">TreeMap</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fieldTypesList</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"s2\">\"age\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"name\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TreeMap</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TreeMap</span><span class=\"bp\">.</span><span class=\"n\">ofList</span><span class=\"w\"> </span><span class=\"n\">fieldTypesList</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">RecordType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DHashMap</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fieldTypes</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">field</span><span class=\"w\"> </span><span class=\"n\">Empty</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myRecord</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RecordType</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"bp\">∅</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DHashMap</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"s2\">\"age\"</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|&gt;.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"s2\">\"name\"</span><span class=\"w\"> </span><span class=\"s2\">\"myName\"</span>\n</code></pre></div>",
        "id": 511916716,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1744557722
    },
    {
        "content": "<p>Ahh amazing!! yeah that works <span aria-label=\"fire\" class=\"emoji emoji-1f525\" role=\"img\" title=\"fire\">:fire:</span> thanks so much <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span></p>",
        "id": 511925672,
        "sender_full_name": "aron",
        "timestamp": 1744564614
    }
]