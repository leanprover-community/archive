[
    {
        "content": "<p>Hello! Where can I find information on Lean's iteration primitives? I have been working through Functional Programming in Lean, but (unsurprisingly) it doesn't seem to cover this.</p>\n<p>I've also been having trouble knowing where to look when trying to understand language features in general... is there a standard place to look besides the FP in Lean / Theorem Proving in Lean books and the Core.lean and Prelude.lean files? I have not had very good luck with the manual. Most of the pages I was hoping to find information in have been empty.</p>",
        "id": 463553540,
        "sender_full_name": "JJ",
        "timestamp": 1724117554
    },
    {
        "content": "<p>lean doesn't really have iteration primitives per se, but if you mean things accepted by the <code>do</code> notation it's basically <code>for</code>, <code>while</code>, and <code>repeat</code>, with the latter two desugared to a form of <code>for</code></p>",
        "id": 463553747,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724117706
    },
    {
        "content": "<p>the actual primitive from lean's perspective is (tail) recursion</p>",
        "id": 463553784,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724117734
    },
    {
        "content": "<p>oh yeah that's exactly what i'm looking for - where can i read about how they work?</p>",
        "id": 463554429,
        "sender_full_name": "JJ",
        "timestamp": 1724118173
    },
    {
        "content": "<p><code>for</code> desugars to an application of the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ForIn.forIn#doc\">docs#ForIn.forIn</a> typeclass function, so data structures etc can implement that to define what iteration means for them</p>",
        "id": 463554965,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724118428
    },
    {
        "content": "<p>hmm okay ty</p>",
        "id": 463555848,
        "sender_full_name": "JJ",
        "timestamp": 1724118654
    },
    {
        "content": "<p>this is a bit dense, do you know if there is any documentation with more examples? i am struggling to follow the types a bit</p>",
        "id": 463555969,
        "sender_full_name": "JJ",
        "timestamp": 1724118683
    },
    {
        "content": "<p>(also i might as well ask - i'm writing a parser and was hoping to manually manipulate the iterator with something like <code>.next()</code> like in rust. are there existing abstractions for this, or is there a more idiomatic way to manipulate parser state, or is this doable/not doable?)</p>",
        "id": 463556724,
        "sender_full_name": "JJ",
        "timestamp": 1724118850
    },
    {
        "content": "<p>The iteration implemented by <code>ForIn</code> is called \"internal iteration\", which means it is a higher order function where you give the body of the loop to it and it runs it on the elements yielded by the iterator in order. This is in contrast to \"external iteration\" in the style of rust, where the iterator has a function returning the next value of the iterator. Lean also has an external iteration typeclass, called <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Stream#doc\">docs#Stream</a>, but it is not used as much</p>",
        "id": 463557720,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724119085
    },
    {
        "content": "<p>One reason to prefer internal iteration style is that it is easier to verify termination that way</p>",
        "id": 463557953,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724119154
    },
    {
        "content": "<p>but it is a less flexible model than external iteration, you can't just convert an internal iterator to an external iterator</p>",
        "id": 463557988,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724119184
    },
    {
        "content": "<p>oh neat ok! i think stream is what i'm looking for. does <code>for</code> <code>while</code> <code>repeat</code> work with it at all?</p>",
        "id": 463558902,
        "sender_full_name": "JJ",
        "timestamp": 1724119690
    },
    {
        "content": "<p>They should, thanks to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instForInOfStream#doc\">docs#instForInOfStream</a></p>",
        "id": 463595843,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1724131722
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634325\">JJ</span> has marked this topic as resolved.</p>",
        "id": 463799588,
        "sender_full_name": "Notification Bot",
        "timestamp": 1724184210
    },
    {
        "content": "<p>i have hit a couple of snags with iteration. reading <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Stream.html#instStreamList\">Stream#instStreamList</a> seems to suggest that List should implement the Stream class. but the following code fails to compile, due to not resolving <a href=\"http://List.next\">List.next</a>?:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"JJ\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"Hello, {hello}!\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"{i}\"</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">data.next</span><span class=\"bp\">?</span>\n</code></pre></div>",
        "id": 463899873,
        "sender_full_name": "JJ",
        "timestamp": 1724200215
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634325\">JJ</span> has marked this topic as unresolved.</p>",
        "id": 463899887,
        "sender_full_name": "Notification Bot",
        "timestamp": 1724200229
    },
    {
        "content": "<p>also: i've noticed that next? returns <code>Option (value Ã— stream)</code>. is there a way to get around needing to shadow <code>stream</code> each time <code>next?</code> is called, perhaps with mutability?</p>",
        "id": 463900003,
        "sender_full_name": "JJ",
        "timestamp": 1724200317
    },
    {
        "content": "<p>Unlike in rust, you can only use dot notation in lean when there is literally a function in the namespace (what you would call an inherent method in rust), not when there is a typeclass function (although in many cases the typeclass function will be defined to equal an inherent method with the expected name, so this can be confusing). To call the typeclass function you should use its name directly and without dot notation, as in <code>Stream.next? data</code></p>",
        "id": 463900220,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724200485
    },
    {
        "content": "<p>oh! interesting. can i import the class / every class so i can use dot notation at all / always? (i really like dot notation <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span>)</p>",
        "id": 463900370,
        "sender_full_name": "JJ",
        "timestamp": 1724200600
    },
    {
        "content": "<p>You need to define <code>List.next?</code> if you want to use dot notation</p>",
        "id": 463900387,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724200619
    },
    {
        "content": "<p>To use a stream with mutable variables, you need the following dance:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"JJ\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Hello, {hello}!\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">data'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">next?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">break</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{i}\"</span>\n<span class=\"w\">    </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">data'</span>\n</code></pre></div>",
        "id": 463900439,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724200667
    },
    {
        "content": "<p>in fact, <code>List.next?</code> already exists in Batteries: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.next%3F#doc\">docs#List.next?</a></p>",
        "id": 463900577,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724200784
    },
    {
        "content": "<p>hmm. that's pretty rough. i guess it would be bad to implicitly have a mutable iterator though.</p>",
        "id": 463901374,
        "sender_full_name": "JJ",
        "timestamp": 1724201091
    },
    {
        "content": "<p>and i guess because mutation isn't first class you can't really define a <code>next?</code> to do that to begin with...</p>",
        "id": 463901511,
        "sender_full_name": "JJ",
        "timestamp": 1724201125
    },
    {
        "content": "<p>hmmmm. i guess i have some motivation for learning the macro system now <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 463902311,
        "sender_full_name": "JJ",
        "timestamp": 1724201358
    },
    {
        "content": "<p>You can do something more like first class mutation if you have a function with the type <code>StateT (List A) (Option A)</code></p>",
        "id": 463902782,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724201538
    },
    {
        "content": "<p>Why are you calling <code>next?</code>? You can just do a <code>for</code> loop over the list:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"JJ\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Hello, {hello}!\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{i}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">main</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">Hello, JJ!</span>\n<span class=\"cm\">1</span>\n<span class=\"cm\">2</span>\n<span class=\"cm\">3</span>\n<span class=\"cm\">4</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 463904473,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724201939
    },
    {
        "content": "<p>oh, i was calling <code>next</code> to get a sense of how iterators work! that would be a remarkably complicated list iteration haha</p>",
        "id": 463904691,
        "sender_full_name": "JJ",
        "timestamp": 1724201989
    },
    {
        "content": "<p>but i do actually want to call <code>next</code> explicitly because i'm writing a parser. being able to have an external <code>while</code> loop but skip iterations of it inline with <code>.next()</code> (and have helper functions ex. <code>peek(&amp;mut self): Option&lt;T&gt;</code>, <code>expect(&amp;self, T): Option&lt;Unit&gt;</code>, etc) has been super helpful in rust. the same pattern is maybe seeming more trouble than it's worth with lean's purity though...</p>",
        "id": 463905506,
        "sender_full_name": "JJ",
        "timestamp": 1724202155
    },
    {
        "content": "<p>mutation using <code>let mut</code> is not really first class, <code>do</code> is an elaborate macro that desugars it to state passing</p>",
        "id": 463909299,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724203531
    },
    {
        "content": "<p>I think if you have a state object you want to pass around and modify from several functions, you want to define a monad using <code>StateT</code></p>",
        "id": 463909485,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724203586
    },
    {
        "content": "<p>oh yeah, i mean that <em>rust</em> has first class mutation... and its external iterators work well because <code>next</code> has the signature <code>&amp;mut Self -&gt; Option&lt;T&gt;</code>. so it can update the iterator in-place and not need to return a new iterator like <code>Stream</code> does</p>",
        "id": 463909972,
        "sender_full_name": "JJ",
        "timestamp": 1724203790
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113489-new-members/topic/iteration.20documentation.3F/near/463909485\">said</a>:</p>\n<blockquote>\n<p>I think if you have a state object you want to pass around and modify from several functions, you want to define a monad using <code>StateT</code></p>\n</blockquote>\n<p>i might try that once i understand lean a bit better... i think i understand how to (maybe) implement nice sugar for rust-style external iteration with macros, but monads are quite beyond me rn</p>",
        "id": 463910385,
        "sender_full_name": "JJ",
        "timestamp": 1724203913
    },
    {
        "content": "<p>it's easier than writing macros to do the same thing, that's for sure</p>",
        "id": 463911941,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724205070
    },
    {
        "content": "<p>The equivalent of the rust signature <code>&amp;mut Self -&gt; Option&lt;T&gt;</code> is <code>StateM Self (Option T)</code></p>",
        "id": 463911997,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724205109
    }
]