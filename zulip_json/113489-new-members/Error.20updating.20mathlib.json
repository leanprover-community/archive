[
    {
        "content": "<p>I am trying to update my mathlib dependency to 4.15.0 for a project I am working on. To do this, I clicked \"Project: Update Dependency\" in VS Code. I get the following error: \"Cannot update dependency. Command output: error: external command 'git' exited with code 1\". How can I fix this?</p>",
        "id": 493375769,
        "sender_full_name": "Benjamin",
        "timestamp": 1736781099
    },
    {
        "content": "<p>Can you figure out what <code>git</code> was doing?</p>",
        "id": 493376159,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736781198
    },
    {
        "content": "<p>I don't see what git was doing, but I see that VS Code tried to run the command <code>lake update mathlib</code>.</p>",
        "id": 493376483,
        "sender_full_name": "Benjamin",
        "timestamp": 1736781278
    },
    {
        "content": "<p>What's also weird is that it runs <code>lean --version</code> and the output is <code>Lean (version 4.15.0-rc1, x86_64-w64-windows-gnu, commit ffac974dba79, Release)</code>. But that is not the version I should have installed. When I run the same command in my own terminal, I get <code>Lean (version 4.15.0, x86_64-w64-windows-gnu, commit 11651562caae, Release)</code>, which is what I expect.</p>",
        "id": 493377578,
        "sender_full_name": "Benjamin",
        "timestamp": 1736781573
    },
    {
        "content": "<p>The version of lean used depends on the lean-toolchain file in your project</p>",
        "id": 493377796,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736781626
    },
    {
        "content": "<p>Each project can use a different version of lean, if it wants to</p>",
        "id": 493377858,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736781643
    },
    {
        "content": "<p>OK, so should I change <code>leanprover/lean4:v4.15.0-rc1</code> to <code>leanprover/lean4:v4.15.0</code>?</p>",
        "id": 493378027,
        "sender_full_name": "Benjamin",
        "timestamp": 1736781693
    },
    {
        "content": "<p>And is there anything else I need to change if I want to have the latest version of other dependencies, like batteries? Or will these be updated automatically?</p>",
        "id": 493378324,
        "sender_full_name": "Benjamin",
        "timestamp": 1736781762
    },
    {
        "content": "<p>Do you depend on mathlib?</p>",
        "id": 493379414,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736782033
    },
    {
        "content": "<p>I do.</p>",
        "id": 493379571,
        "sender_full_name": "Benjamin",
        "timestamp": 1736782081
    },
    {
        "content": "<p>Okay, then you need to make sure you depend on the \"v4.15.0\" revision of mathlib, and then <code>lake update</code> should update your <code>lean-toolchain</code> by itself</p>",
        "id": 493379775,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736782122
    },
    {
        "content": "<p>What do you mean by 'make sure you depend on the \"v4.15.0\" revision of mathlib'? How do I do that without changing <code>lean-toolchain</code>?</p>",
        "id": 493381370,
        "sender_full_name": "Benjamin",
        "timestamp": 1736782516
    },
    {
        "content": "<p>I ran <code>lake update --verbose</code>, and this is the output:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">celine</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">mathlib'</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.\\.\\.</span><span class=\"n\">lake</span><span class=\"bp\">\\</span><span class=\"n\">packages</span><span class=\"bp\">\\</span><span class=\"n\">mathlib</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">fetch</span><span class=\"w\"> </span><span class=\"c1\">--tags --force origin</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">lock</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">refs</span><span class=\"bp\">/</span><span class=\"n\">remotes</span><span class=\"bp\">/</span><span class=\"n\">origin</span><span class=\"bp\">/</span><span class=\"n\">SM</span><span class=\"bp\">.</span><span class=\"n\">AdjointTriangulated'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"mi\">6372</span><span class=\"n\">b3aa48ddaf69fadf52c677ee53f95f766deb</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"mi\">8705</span><span class=\"n\">b21ea16aa7d2b8b94af1295cd1f81f83586f</span>\n<span class=\"n\">From</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span>\n<span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"mi\">8705</span><span class=\"n\">b21ea1</span><span class=\"bp\">..</span><span class=\"n\">cc486a7f77</span><span class=\"w\">  </span><span class=\"n\">SM</span><span class=\"bp\">.</span><span class=\"n\">AdjointTriangulated</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">origin</span><span class=\"bp\">/</span><span class=\"n\">SM</span><span class=\"bp\">.</span><span class=\"n\">AdjointTriangulated</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">unable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"o\">)</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">git'</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 493389997,
        "sender_full_name": "Benjamin",
        "timestamp": 1736784790
    },
    {
        "content": "<p>!</p>",
        "id": 493399248,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736787219
    },
    {
        "content": "<p>At this point I would delete the <code>.lake</code> folder in your project directory and try again</p>",
        "id": 493399569,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736787304
    },
    {
        "content": "<p>I did that and now my lean-toolchain file says <code>leanprover/lean4:v4.16.0-rc1</code>, but I wanted <code>leanprover/lean4:v4.15.0</code>.</p>",
        "id": 493406681,
        "sender_full_name": "Benjamin",
        "timestamp": 1736789269
    },
    {
        "content": "<p>Is there a reason lake automatically updates to the release candidate? I prefer to use the stable release.</p>",
        "id": 493407205,
        "sender_full_name": "Benjamin",
        "timestamp": 1736789429
    },
    {
        "content": "<p>Lake should never automatically update anything, but it will try to update <code>lean-toolchain</code> to match whatever version of mathlib is in your <code>lake-manifest.json</code>. If you're not requiring a specific version of mathlib in your lakefile, you can manually ask for mathlib updates by running <code>lake update</code> (which will update the manifest).</p>",
        "id": 493407880,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1736789653
    },
    {
        "content": "<p>So if I update to the latest version of mathlib, do I have to use <code>v4.16.0-rc1</code>?</p>",
        "id": 493408474,
        "sender_full_name": "Benjamin",
        "timestamp": 1736789851
    },
    {
        "content": "<p>I think I understand now. Mathlib depends on <code>v4.16.0-rc1</code>, so updating mathlib bumps Lean to that version as well.</p>",
        "id": 493409941,
        "sender_full_name": "Benjamin",
        "timestamp": 1736790260
    },
    {
        "content": "<p>Yes, mathlib tracks the most recent version of Lean, which is almost always an unstable one. But whenever a stable version of Lean is released, a mathlib commit compatible with that stable version is tagged <code>v4.X.0</code> for the appropriate value of <code>X</code>. You can change your lakefile to point to such tags if you want to use a stable version.</p>",
        "id": 493431514,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1736796777
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"325367\">Mauricio Collares</span> <a href=\"#narrow/channel/113489-new-members/topic/Error.20updating.20mathlib/near/493407880\">said</a>:</p>\n<blockquote>\n<p>Lake should never automatically update anything</p>\n</blockquote>\n<p>I don't think this is true at the moment. I think lake now always tries to update to the latest Lean toolchain (regardless of which one is specified in Mathlib), which has caused some recent headaches with downstream projects and the cache. But as I understand it, this is also on track to be fixed sometime this week.</p>",
        "id": 493436373,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736798402
    },
    {
        "content": "<p>Do you mean it does that even if you don't run <code>lake update</code>? I've never seen that, and I'm curious now. Do you have an example?</p>",
        "id": 493443558,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1736800685
    },
    {
        "content": "<p>What I've definitely seen is lake updating the toolchain to match some dependency's <code>lean-toolchain</code> file, even if that dependency is not mathlib.</p>",
        "id": 493445641,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1736801311
    },
    {
        "content": "<p>Yes, this is a relatively new feature - mathlib has had something like it since before it was built into lake</p>",
        "id": 493446007,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736801439
    },
    {
        "content": "<p>Now, right this week, you do not want to create a project that depends on the most recent version of mathlib. You should stick to the \"v4.15.0\" revision due to a bug that will hopefully be fixed in the next few days</p>",
        "id": 493446162,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736801501
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/113489-new-members/topic/Error.20updating.20mathlib/near/493446007\">said</a>:</p>\n<blockquote>\n<p>Yes, this is a relatively new feature - mathlib has had something like it since before it was built into lake</p>\n</blockquote>\n<p>Yes. <code>lake update --keep-toolchain</code> helps with that. But, still, I think the <code>lean-toolchain</code> overwriting only happens when you run <code>lake update</code> (or when you don't have a <code>lake-manifest.json</code> at all).</p>",
        "id": 493450421,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1736802807
    }
]