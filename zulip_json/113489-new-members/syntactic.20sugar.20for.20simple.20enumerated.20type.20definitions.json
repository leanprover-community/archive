[
    {
        "content": "<p>I'm teaching a first-year course on logic and discrete math to computer engineers.  I'd like to enable the students to write simple enumerated type definitions such as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"n\">Ty1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A2</span>\n</code></pre></div>\n<p>and have this elaborate to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Ty1</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A2</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Ty1</span>\n</code></pre></div>\n<p>The issues I'm facing are:</p>\n<ol>\n<li>Writing a macro for the <code>| A1 | A2</code> expansion.</li>\n<li>Writing a macro that expands to 2 commands (<code>inductive</code> and <code>open</code>)</li>\n</ol>\n<p>For the <code>| A1 | A2</code> expansion, I started with the simple case of just one constructor, (e.g., <code>Typedef Ty1 := A1</code>)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Typedef\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"w\"> </span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This gives a syntax error just after <code>$val1</code> of <code>expected token</code>.  I get a similar message with multiple <code>val</code>s.</p>\n<p>Any suggestions on how to write this macro?</p>\n<p>For the second issue, is it possible to write a macro that expands to 2 commands?</p>\n<p>-mark</p>",
        "id": 497194541,
        "sender_full_name": "Mark Aagaard",
        "timestamp": 1738440732
    },
    {
        "content": "<p>It looks like the parser is expecting some <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Command.declModifiers#doc\">docs#Lean.Parser.Command.declModifiers</a>. It works if you annotate it.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Typedef\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 497195305,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738441434
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"741196\">Mark Aagaard</span> <a href=\"#narrow/channel/113489-new-members/topic/syntactic.20sugar.20for.20simple.20enumerated.20type.20definitions/near/497194541\">said</a>:</p>\n<blockquote>\n<p>For the second issue, is it possible to write a macro that expands to 2 commands?</p>\n</blockquote>\n<p>Yes, you can put multiple commands into the <code> `(...)</code> syntax.</p>\n<p>Or you can do something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cmd1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">cmd2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">other</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkNullNode</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">cmd1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">cmd2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>This has the same effect. Null nodes can be processed by the command elaborator.</p>",
        "id": 497195598,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738441654
    },
    {
        "content": "<p>Thanks, I didn't know that it was possible to put a declModifier on the rhs of a macro expansion.</p>\n<p>Aaron-  How did you identify that the parser was looking for a <code>declModifier</code>?   Debugging macros is still more art than science for me.</p>\n<p>-mark</p>",
        "id": 497196133,
        "sender_full_name": "Mark Aagaard",
        "timestamp": 1738442146
    },
    {
        "content": "<p>Step 1</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Typedef\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> expected token -/</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Step 2</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Typedef\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" := \"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val1</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> i put a token -/</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Step 3</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">val1</span><span class=\"bp\">.</span><span class=\"n\">raw</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">val1</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Parser.Command.declModifiers</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>",
        "id": 497196815,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738442712
    },
    {
        "content": "<p>Got it.  Thanks!</p>",
        "id": 497197449,
        "sender_full_name": "Mark Aagaard",
        "timestamp": 1738443246
    },
    {
        "content": "<p>Key tidbit: the lhs and rhs are both the same kind of syntax, known as syntax quotations. The quotations get interpreted in different ways depending on the context (e.g. as a pattern or as a value), but syntax quotations all have the same parsing rules.</p>",
        "id": 497197882,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738443662
    },
    {
        "content": "<p>Here's my attempt at making this.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Typedef\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":=\"</span><span class=\"w\"> </span><span class=\"n\">sepBy</span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"|\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">vals</span><span class=\"o\">]</span><span class=\"bp\">|*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctors</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">vals</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">ctor</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">val</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">ctors</span><span class=\"o\">]</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 497203799,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738448626
    },
    {
        "content": "<p>Here's how you do it with a single syntax quotation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Typedef</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">vals</span><span class=\"o\">]</span><span class=\"bp\">|*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">        </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">vals</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">]</span><span class=\"bp\">*</span>\n<span class=\"w\">      </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 497204812,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738449569
    },
    {
        "content": "<p>The <code>syntax</code> and <code>macro_rules</code> can also be done together using the <code>macro</code> command:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"Typedef\"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\":=\"</span><span class=\"w\"> </span><span class=\"n\">vals</span><span class=\"o\">:</span><span class=\"n\">sepBy</span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"|\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">      </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">vals</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">]</span><span class=\"bp\">*</span>\n<span class=\"w\">    </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 497204899,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738449626
    }
]