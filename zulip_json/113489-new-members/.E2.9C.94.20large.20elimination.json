[
    {
        "content": "<p>Why doesn't my type <code>PProd'</code> have large elimination? My logic is as follows.<br>\nIf <code>α</code> and <code>β</code> are both <code>Prop</code>s, then this looks like <code>And</code>, which has large elimination<br>\nIf one of <code>α</code> or <code>β</code> is not a <code>Prop</code>, then the resulting universe is also not <code>Prop</code>, so it should have large elimination.<br>\nThis exhausts all of the cases.<br>\nI know it's possible to have everything (we have <code>And</code>, <code>Prod</code>, and <code>Subtype</code>), but isn't the point of universe polymorphism to have everything compactly?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">prelude</span>\n\n<span class=\"c1\">-- \"6d22e0e5cc5a4392466e3d6dd8522486d1fd038b\"</span>\n<span class=\"c1\">-- #eval Lean.getGithash ()</span>\n\n<span class=\"c1\">-- this doesn't work in the web editor</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">bootstrap</span><span class=\"bp\">.</span><span class=\"n\">inductiveCheckResultingUniverse</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c1\">-- if I import Init.SizeOf, I get the confusing error</span>\n<span class=\"c1\">-- (kernel) invalid reference to undefined universe level parameter 'u'</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">PProd'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span>\n\n<span class=\"c1\">-- why does this not have large elimination</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">PProd'.rec.{u, v} {α : Sort u} {β : Sort v} {motive : PProd' α β → Prop}</span>\n<span class=\"cm\">  (mk : ∀ (fst : α) (snd : β), motive { fst := fst, snd := snd }) (t : PProd' α β) : motive t</span>\n<span class=\"cm\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">PProd'</span><span class=\"bp\">.</span><span class=\"n\">rec</span>\n</code></pre></div>",
        "id": 494891433,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737398390
    },
    {
        "content": "<p>Universe polymorphism usually works great, but things can get weird when we make things polymorphic across <code>Prop</code> and <code>Type _</code>. This is a reason there are all these variants in Lean for different kinds of pairs (And, Prod, Sigma, Subtype, Exists).</p>\n<p>If you don't override this internal flag, then there's an error message that points toward how the elaborator thinks you shouldn't be constructing inductive types whose universe can vary across <code>Prop</code> and <code>Type _</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">PProd'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">invalid universe polymorphic resulting type, the resulting universe is not 'Prop',</span>\n<span class=\"cm\">but it may be 'Prop' for some parameter values:</span>\n<span class=\"cm\">  Sort (max u v)</span>\n<span class=\"cm\">Possible solution: use levels of the form 'max 1 _' or '_ + 1' to ensure the universe</span>\n<span class=\"cm\">is of the form 'Type _'.</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>And, as you can see when you set the flag, the kernel decides to construct a type that doesn't have large elimination. I'm not familiar with the rules it's following here. I'm not too surprised that it isn't doing <code>Prop</code>/<code>Type _</code> case analysis to find a more general recursor.</p>",
        "id": 494894484,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737399638
    },
    {
        "content": "<p>I found the kernel code responsible for the motive universe level if you want to read through it: <a href=\"https://github.com/leanprover/lean4/blob/c07f64a6212247ef789d4cef39e237b4a4b61696/src/kernel/inductive.cpp#L477\">https://github.com/leanprover/lean4/blob/c07f64a6212247ef789d4cef39e237b4a4b61696/src/kernel/inductive.cpp#L477</a></p>",
        "id": 494895254,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737399954
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/issues/3310\">https://github.com/leanprover/lean4/issues/3310</a> tracks the <code>bootstrap</code> issue</p>",
        "id": 494895663,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737400117
    },
    {
        "content": "<p>The current status of that error <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> is that there's an error message that you cannot disable. The <code>structure</code> command no longer attempts to allow <code>Prop</code>/<code>Type _</code> polymorphic types.</p>",
        "id": 494896313,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737400393
    },
    {
        "content": "<p>(This is why Aaron needs to work with an older Lean version for the bootstrap option to have any effect.)</p>",
        "id": 494896552,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737400500
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> has marked this topic as resolved.</p>",
        "id": 494900528,
        "sender_full_name": "Notification Bot",
        "timestamp": 1737402229
    },
    {
        "content": "<p>Does <code>inductive</code> attempt to allow such types? This gives the kernel error in the web editor:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">bootstrap</span><span class=\"bp\">.</span><span class=\"n\">inductiveCheckResultingUniverse</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">PProd'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 494901643,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737402686
    },
    {
        "content": "<p>Yes, though as Sebastian said, that option comes with no warranty</p>",
        "id": 494901862,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737402792
    },
    {
        "content": "<p>Would anything break if the option were just removed?</p>",
        "id": 494902049,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737402870
    },
    {
        "content": "<p>Yes, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=PUnit#doc\">docs#PUnit</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=PEmpty#doc\">docs#PEmpty</a></p>",
        "id": 494905696,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737404355
    },
    {
        "content": "<p>I figured out why this fails:<br>\n<span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113489-new-members/topic/.E2.9C.94.20large.20elimination/near/494901643\">said</a>:</p>\n<blockquote>\n<p>Does <code>inductive</code> attempt to allow such types? This gives the kernel error in the web editor:<br>\n<em>(omitted)</em></p>\n</blockquote>\n<p>The automatically generated <code>SizeOf</code> instance for <code>PProd'</code> fails to eliminate to <code>Nat</code> because <code>PProd'</code> does not have large elimination.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">bootstrap</span><span class=\"bp\">.</span><span class=\"n\">inductiveCheckResultingUniverse</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">PProd'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- same error</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">SizeOf</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">PProd'</span>\n</code></pre></div>",
        "id": 494937159,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737418215
    }
]