[
    {
        "content": "<p>I have a concrete 3x3 matrix A and a concrete 2x3 submatrix S. I can show that S has rank 2 and want to use <code>Matrix.rank_submatrix_le</code> to show that rank A ≥ 2. But my index functions are not accepted:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Matrix</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">!!</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">!!</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">S_is_submatrix</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">submatrix</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">ext_of_single_vecMul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">congrFun</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">S_rank_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span><span class=\"w\">  </span><span class=\"c1\">-- its proof doesn't matter here</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">A_rank_ge_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rank_submatrix_le</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- error: application type mismatch</span>\n</code></pre></div>\n<p>The error shows that <code>id</code> should have type <code>Fin 2 ≃ Fin 3</code><br>\nand a look at <code>rank_submatrix_le</code> confirms that. But wouldn't that imply that the dimensions of S and A have to be equal? But then, the \"submatrix\" in the theorem isn't a submatrix at all!</p>\n<p>Obviously, I don't properly understand the formulation of the theorem and am completely lost ...</p>",
        "id": 525290801,
        "sender_full_name": "Peter Junglas",
        "timestamp": 1750671093
    },
    {
        "content": "<p><code>submatrix</code> is also used to reorder rows / columns, not just take a subset of them</p>",
        "id": 525291846,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750671448
    },
    {
        "content": "<p>Indeed, the docstring for the theorem you're trying to use (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=rank_submatrix_le#doc\">docs#rank_submatrix_le</a>) says \"Taking a subset of the rows and permuting the columns reduces the rank.\"</p>",
        "id": 525291962,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750671477
    },
    {
        "content": "<p>Sure, but I don't want to reorder, so I thought, id should work. But it doesn't ...</p>",
        "id": 525292515,
        "sender_full_name": "Peter Junglas",
        "timestamp": 1750671663
    },
    {
        "content": "<p>There is at least one mistake here, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Matrix.rank_submatrix_le#doc\">docs#Matrix.rank_submatrix_le</a> should be stated for rectangular <code>A</code>.</p>",
        "id": 525292549,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750671674
    },
    {
        "content": "<p>Ok, you have encouraged me (a newbie) to have a critical look at the theorem and its proof. As far as I understand it, the assumption <code>(e : n ≃ m)</code> is too strong. One only needs that <code>range e = ⊤</code>.  I guess, I'll have to look closely at the \"abstract nonsense\" part of the proof  <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span>  - tomorrow.</p>",
        "id": 525358181,
        "sender_full_name": "Peter Junglas",
        "timestamp": 1750692549
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"888762\">@Peter Junglas</span> different things that are mathematically equivalent are still different in Lean.<br>\nNamely, <code>id</code> is the function <code>α → α</code>, and you can't just turn it into type <code>α ≃ α</code>. The idiom for the latter is <code>Equiv.refl α</code>.</p>",
        "id": 525368183,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750695846
    },
    {
        "content": "<p>but yeah the lemma in Mathlib might be wrong</p>",
        "id": 525368315,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750695900
    },
    {
        "content": "<p>I was able to proceed a bit:</p>\n<p>The original version of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Matrix.rank_submatrix_le#doc\">docs#Matrix.rank_submatrix_le</a> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">rank_submatrix_le0</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">StrongRankCondition</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">submatrix</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>\n<p>I'm now quite sure that this is not correct: Setting <code>n ≃ m</code> implies that the sizes of n and m are the same.  Therefore there is no \"submatrix\" here, its just renumbering. But it is trivial to fix:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">omit</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">rank_submatrix_le</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">StrongRankCondition</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m₀</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">submatrix</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>\n<p>Now, n is arbitrary - even non-finite -, and the exact same proof as before works.</p>\n<p>It would be nice, if Mathlib could be fixed here. But of course, the real theorem needed here should work with non-square matrices and even with shortening of the rows (i.e. not  m₀ ≃ m, but arbitrary m₀ ). This will need a new proof, which is too much for me at my current level of expertise.</p>\n<p>Btw: Is this the proper channel for this discussion or should I switch to the mathlib4 channel?</p>",
        "id": 525457640,
        "sender_full_name": "Peter Junglas",
        "timestamp": 1750750578
    },
    {
        "content": "<p>At this point,  the best place for discussion would be a PR that fixes the problem! Can I interest you in opening one?</p>",
        "id": 525464967,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750753222
    },
    {
        "content": "<p>Ok, I will try. Can you give me a pointer, where to start?</p>",
        "id": 525472427,
        "sender_full_name": "Peter Junglas",
        "timestamp": 1750755786
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/contribute/git.html\">https://leanprover-community.github.io/contribute/git.html</a></p>",
        "id": 525478796,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1750757908
    },
    {
        "content": "<p>Using the slightly extended version of <code>rank_submatrix_le</code> and <code>Equiv.refl (Fin 3)</code> as index function, I finally succeeded to prove that A has rank 2. <br>\nThanks a lot to you, guys!</p>",
        "id": 525486213,
        "sender_full_name": "Peter Junglas",
        "timestamp": 1750760679
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"888762\">Peter Junglas</span> has marked this topic as resolved.</p>",
        "id": 525836369,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750921728
    }
]