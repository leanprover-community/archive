[
    {
        "content": "<p>I'm trying to embed a language in Lean. It seems like there is a conflict between lean's syntax and my language. The if syntax for the language looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>I've defined it like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">if_else</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"if\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"s2\">\"else\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">if_else</span>\n</code></pre></div>\n<p>And I try to translate it to Lean with the following macro rule:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro_rules</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">if_else</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">}{</span><span class=\"bp\">$</span><span class=\"n\">if_body</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">$</span><span class=\"n\">else_body</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">   </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">if_body</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">else_body</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Notice the <code>{$a}</code>. If I don't include it  I get an error.<code>a</code> has the type <code>TSyntax </code>Lean.Parser.Term.structInstField`</p>\n<p>Regardless, if I write an if statement in my language Lean complains about a missing <code>then</code> so obviously, the macro rule is not being applied.</p>",
        "id": 538085657,
        "sender_full_name": "Jack Hackshaw",
        "timestamp": 1757257826
    },
    {
        "content": "<p>It seems like you're trying to parse your if in the context where lean expects <code>term</code>. You declared your if to belong to <code>if_else</code> category, which is not <code>term</code>.</p>",
        "id": 538090203,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1757262058
    },
    {
        "content": "<p>You might be interested in reading <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/08_dsls.html\">https://leanprover-community.github.io/lean4-metaprogramming-book/main/08_dsls.html</a>.</p>",
        "id": 538090767,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1757262529
    },
    {
        "content": "<p>A significant issue with this syntax is that terms can be followed by curly braces; for example <code>f { return 2 }</code> is valid as a term, because <code>return 2</code> is a term and <code>{ ... }</code> is a term (singleton set). It goes for the longest valid parse.</p>\n<p>What MrQubo points out should not be a problem for the macro rule, just as long as you are aware this is in the <code>if_else</code> category, and that you might need to make an <code>if_else</code> macro expander (macros are not expanded automatically, each category writes its own hook for that), and that you'll definitely need to use the <code>if_else</code> category in some syntax available to terms/doElems/etc.</p>\n<p>It's possible set forbidden tokens to get this to parse, though <code>withForbidden</code> doesn't appear to be available in <code>syntax</code>, only lower-level parsers. Another option might be to adjust the precedence, but it's not possible to disambiguate <code>x &gt; 0 { return 1 }</code> that way. Easiest is to change your DSL to use C syntax, <code>if (x &gt; 0) { ... } else { ... }</code>. Harder is to make your own <code>term</code> category from scratch with exactly the term syntaxes you want.</p>",
        "id": 538093747,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1757265557
    },
    {
        "content": "<p>Unfortunately, changing the DSL is not an option.</p>\n<p>I am not wedded to using <code>syntax</code>, if I can get the desired result with a lower level parser that allows <code>withForbidden</code> then that is an option. Otherwise I guess I will have to do it the hard way and implement my own <code>term</code> category.</p>\n<p>Do you have a recommendation on where I might look to get started?</p>",
        "id": 538113700,
        "sender_full_name": "Jack Hackshaw",
        "timestamp": 1757290213
    }
]