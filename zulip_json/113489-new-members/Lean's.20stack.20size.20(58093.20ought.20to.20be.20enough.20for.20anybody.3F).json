[
    {
        "content": "<p>I’d like to increase Lean’s stack size—how can I do that, and how can I query the current setting?</p>\n<p>For context, this is the test case that prompted me to look into the stack-size configuration:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase_58093</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n<span class=\"w\">   </span><span class=\"mi\">58093</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase_58094</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n\n<span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Aborting</span><span class=\"bp\">.</span>\n<span class=\"w\">       </span><span class=\"mi\">0</span>\n<span class=\"n\">zsh</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">abort</span><span class=\"w\">      </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase_58094</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"n\">zsh</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">done</span><span class=\"w\">       </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">testcase_58093</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">58093</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">testcase_58094</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">58094</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>\n<p>(I recognize there are code-level workarounds—such as iterating over the list—but for the sake of discussion, let’s assume the above code is immutable; I’m interested in how the stack size configuration works, and how it can be tweaked to make the second test case work as-is.)</p>",
        "id": 515548498,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1746120764
    },
    {
        "content": "<p>I’m also curious whether the <code>n=58093</code> limit here is specific to my setup, inherent to macOS (my OS) more broadly, or a universal default. Put differently, what’s the largest <code>n</code> <strong><em>your</em></strong> system can handle before triggering a stack overflow?</p>",
        "id": 515550077,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1746121341
    },
    {
        "content": "<p>Stack size for programs is a general concept. You can query it on macOS on the command line like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">ulimit</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">s</span>\n<span class=\"mi\">8176</span>\n</code></pre></div>\n<p>That's in kilobytes.</p>\n<p>However, when Lean uses multithreading, there's configuration for the thread stack sizes.</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>% lean -h\n...\n  -s, --tstack=num       thread stack size in Kb\n...\n</code></pre></div>\n<p>It looks like the default is either 8MB or 16MB, not sure.</p>\n<blockquote>\n<p>I’m also curious whether the <code>n=58093</code> limit here is specific to my setup</p>\n</blockquote>\n<p>Yes, definitely. (Variables: which Lean version it is, how was the binary built, what ulimits you might have set, which versions of system libraries you have, and possible a couple other factors.)</p>",
        "id": 515552237,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1746122161
    },
    {
        "content": "<p>Independently, there's also the maxRecDepth option inside Lean, which is intended to let Lean check that a recursion (likely) isn't going to overflow the stack. Increasing maxRecDepth doesn't increase the stack itself, so adjusting it should be done with care.</p>",
        "id": 515552718,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1746122320
    },
    {
        "content": "<p>Thanks! When setting <code>ulimit -s unlimited</code> (which is <code>ulimit -s 65520</code>) I'm able to reach <code>n=131096</code> (with a stack overflow at <code>n=131097</code>).</p>\n<p>Is there some way to push <code>n</code> higher that does not require <code>root</code> access, or changing the code?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">ulimit</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">unlimited</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">ulimit</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">s</span>\n<span class=\"mi\">65520</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase_ulimit_max</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n<span class=\"w\">  </span><span class=\"mi\">131096</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase_ulimit_max_succ</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n\n<span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Aborting</span><span class=\"bp\">.</span>\n<span class=\"w\">       </span><span class=\"mi\">0</span>\n<span class=\"n\">zsh</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">abort</span><span class=\"w\">      </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase_ulimit_max_succ</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"n\">zsh</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">done</span><span class=\"w\">       </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">testcase_ulimit_max</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">131096</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">testcase_ulimit_max_succ</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">131096</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>",
        "id": 515554792,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1746123002
    },
    {
        "content": "<p>The message data is not constructed very effectively, try this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">joinSepArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sep</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_of_ne_zero</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">le_refl</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">a</span><span class=\"o\">[</span><span class=\"n\">start</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">sep</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">right</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">131096</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">joinSepArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\", \"</span>\n<span class=\"w\">  </span><span class=\"c1\">--Lean.logInfo c</span>\n</code></pre></div>\n<p>I found that after uncommenting the line and then going onto <code>run_meta</code> it takes just a short while and then it crashes with \"window not responding\"</p>",
        "id": 515712977,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746192139
    },
    {
        "content": "<p>However, constructing the message data is pretty fast</p>",
        "id": 515713050,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746192160
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/DK7Utttj9boDBMnwnAuGjmnr/Screenshot-2025-05-02-152343.png\">Screenshot 2025-05-02 152343.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/DK7Utttj9boDBMnwnAuGjmnr/Screenshot-2025-05-02-152343.png\" title=\"Screenshot 2025-05-02 152343.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1912x918\" src=\"/user_uploads/thumbnail/3121/DK7Utttj9boDBMnwnAuGjmnr/Screenshot-2025-05-02-152343.png/840x560.webp\"></a></div>",
        "id": 515713377,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1746192268
    }
]