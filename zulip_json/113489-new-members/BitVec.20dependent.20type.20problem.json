[
    {
        "content": "<p>Hi Folks<br>\nI'm new to Lean, so probably a rookie mistake.</p>\n<p>Background:<br>\nI teach a course on digital design at Luleå University of Technology. Among other things students learn to build an adder (based on FullAdders with carry propagation). There is a neat trick where you can check overflow for signed addition, by just C[N] ^ C[N-1] (^ being exor), where C is carry out from the full addition for bit N. While this just works, it would be neat to show a proof that it actually works. I tried with Why3, got stuck, and I did not dare to approach Coq. </p>\n<p>Lean:<br>\nLooked around a bit, and found Lean (I've seen it before, but never tried it seriously). So why not, did some tutorials, and found it more approachable (vscode integration feels like home). </p>\n<p>Problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">BitVec</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">MIL</span><span class=\"bp\">.</span><span class=\"n\">Common</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">BitVec</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^^</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">^^</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c_in</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s_in</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">truncate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">truncate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c_out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">c_in</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">c_out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">s_in</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>So the idea here is to recursively compute the addition by invoking the <code>full_adder</code> for each bit. </p>\n<p>Also as this is my very first Lean program (besides the tutorials), the whole approach might be stupid.  There might be better (leaner) ways of defining addition and proving the overflow \"rule\". (By the way, this is not yet even an attempt of proving anything, its just to get the definition correct in the first place.)</p>\n<p>I ran into the problem where Lean reports the type: BitVec (w - 1 + 1) : Type (for  BitVec.cons s s_in), which is incompatible to the expected BitVec (w ) : Type.</p>\n<p>Any tips, both to the adder definition and if it seems reasonable to the type error problem.</p>\n<p>Thanks in advance<br>\n  Per</p>",
        "id": 511011638,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744140929
    },
    {
        "content": "<p>Instead of doing <code>if w = 0 then ... else ...</code>, you should do <code>match w with | 0 =&gt; ... | n + 1 =&gt; ...</code></p>",
        "id": 511012130,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744141116
    },
    {
        "content": "<p>This gives you better definitional properties. In particular, you won't run into the problem with <code>BitVec (w - 1 + 1)</code> because you won't have subtraction.</p>",
        "id": 511012229,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744141162
    },
    {
        "content": "<p>Ahh thanks, that makes sense, will try and check back, guess this is not my last problem :)</p>",
        "id": 511012436,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744141248
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"897577\">@Per Lindgren</span> FYI, these concepts are already mechanized in Lean as we have a bit blasting decision procedure called <code>bv_decide</code> which makes use of this, the overflow property is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BitVec.uaddOverflow#doc\">docs#BitVec.uaddOverflow</a> and we have a proof of the property you want here <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BitVec.uaddOverflow_eq#doc\">docs#BitVec.uaddOverflow_eq</a></p>",
        "id": 511013013,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744141470
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c_in</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s_in</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a.truncate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b.truncate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c_out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">full_adder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a.getMsb'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b.getMsb'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">c_in</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">c_out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">BitVec.cons</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">s_in</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 511013097,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744141515
    },
    {
        "content": "<p>And the fact that add corresponds to a full adder is here: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BitVec.getLsbD_add#doc\">docs#BitVec.getLsbD_add</a></p>",
        "id": 511013285,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744141584
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> , thanks for the tip. </p>\n<p>However, the point here is not the correctness of the bitvector additon in Lean, but rather, the implementation in terms of full adders with carry propagation (and the \"neat\" overflow checking mechanism). </p>\n<p>The equation in Lean is: <code>x.uaddOverflow y = decide (x.toNat + y.toNat ≥ 2 ^ w)</code>, so no direct connection to the carry propagation, or am I missing something?</p>",
        "id": 511014075,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744141889
    },
    {
        "content": "<p>Ahh you beat me to it...</p>",
        "id": 511014120,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744141907
    },
    {
        "content": "<p>The definitions in Lean are built after the SMTLIB standard for quantifier free bitvector theory which defines the semantics of bitvector operations in terms of integer operations. We thus copy these integer operations and then demonstrate that they correspond to certain equations that you would be used to from a bitwise point of view. The great thing about this is, that we do not need to mechanize <code>BitVec</code> as a <code>List Bool</code> and thus actually retain the ability to efficiently execute code that is built using <code>BitVec</code> + we get the entire arithmetic theory from <code>Int</code> modulo <code>2^n</code> for free.</p>",
        "id": 511014831,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744142165
    },
    {
        "content": "<p>This is truly awesome!!!!</p>",
        "id": 511014944,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744142215
    },
    {
        "content": "<p>So the trick I mentioned that overflow can be checked by exor of the two most significant carries, can it bee seen/proven directly from the Lean definitions?</p>",
        "id": 511015332,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744142350
    },
    {
        "content": "<p>(My thought was to model the adder, and then somehow attack the problem... but if the full-adder connection is already there, there might be easier ways...)</p>",
        "id": 511015632,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744142442
    },
    {
        "content": "<p>So you want to essentially prove:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">saddOverflow</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>?</p>",
        "id": 511016427,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744142699
    },
    {
        "content": "<p>Yes</p>\n<p>By the way, the homebrew adder did work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- (false, 0#0)</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- (false, 0#1)</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- (false, 1#1)</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- (false, 1#1)</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adder</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- (true, 0#1)</span>\n</code></pre></div>",
        "id": 511016874,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744142867
    },
    {
        "content": "<p>I can offer you a very quick proof like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">BVDecide</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">saddOverflow</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">saddOverflow_eq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">msb_add</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">revert</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry_succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">atLeastTwo</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">bv_decide</span>\n</code></pre></div>\n<p>though there is no need to go as hard as <code>bv_decide</code> here, I'll try to get rid of that in a moment.</p>",
        "id": 511017670,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744143169
    },
    {
        "content": "<p>Wow that's crazy!!!!</p>",
        "id": 511017736,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744143199
    },
    {
        "content": "<p>Hmm, I was not able to replay your proof, got an error on <code>BitVec.saddOverflow x y </code></p>\n<p>Am I missing some import (I used the BVDecide import), or do I have another BitVec lib perhaps (installed through vscode example quickstart... under macos).</p>",
        "id": 511018428,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744143447
    },
    {
        "content": "<p><code>saddOverflow</code> was added very recently as we focused on getting all other BitVec operations in first, what is your Lean version?</p>",
        "id": 511018508,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744143480
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">saddOverflow</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">saddOverflow_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">msb_add</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">revert</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry_succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">atLeastTwo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">msb_eq_getLsbD_last</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">BitVec</span><span class=\"bp\">.</span><span class=\"n\">carry</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">[</span><span class=\"n\">w</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">[</span><span class=\"n\">w</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>this one is without <code>bv_decide</code>, you could also decide to play out the <code>Bool</code> simplification game that the last line uses yourself but I think it's just easier to do it like this if you are not into that :D</p>",
        "id": 511018784,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744143574
    },
    {
        "content": "<p>I assume it installs lean according to toml.</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mil\"</span>\n<span class=\"n\">defaultTargets</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s2\">\"MIL\"</span><span class=\"p\">]</span>\n\n<span class=\"k\">[leanOptions]</span>\n<span class=\"n\">pp</span><span class=\"p\">.</span><span class=\"n\">unicode</span><span class=\"p\">.</span><span class=\"n\">fun</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"> </span><span class=\"c1\"># pretty-prints `fun a ↦ b`</span>\n<span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n<span class=\"n\">relaxedAutoImplicit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">false</span>\n\n<span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/mathlib4\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.17.0\"</span>\n\n<span class=\"k\">[[lean_lib]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"MIL\"</span>\n</code></pre></div>",
        "id": 511018945,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744143627
    },
    {
        "content": "<p>Ah, so v4.17.0, that's unfortunately exactly one version behind 4.18.0 which was the first version that had this overflow theory already</p>",
        "id": 511019121,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744143709
    },
    {
        "content": "<p>Though as all the theory is in lean core and there is no need for mathlib to do this kind of stuff you could create a project that uses 4.18.0 and do things there, alternatively if you just wanna do a quick demo and not get too deep into Lean there is also the option of the Lean web editor: <a href=\"https://live.lean-lang.org/\">https://live.lean-lang.org/</a></p>",
        "id": 511019272,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744143770
    },
    {
        "content": "<p>I changed the toml to 4.18 and restarted the file (in vscode), but it still does show the same error.</p>",
        "id": 511019517,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744143876
    },
    {
        "content": "<p>I assume you got this toml from here: <a href=\"https://github.com/leanprover-community/mathematics_in_lean\">https://github.com/leanprover-community/mathematics_in_lean</a> right?</p>",
        "id": 511019608,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744143922
    },
    {
        "content": "<p>exactly that</p>",
        "id": 511019651,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744143940
    },
    {
        "content": "<p>Right, that's more of a tutorial repository and it hasn't been made compatible to 4.18 yet as that is the latest stable release. What you can do to get a fresh project quickly is go into the command line and type <code>lake +leanprover/lean4:v4.18.0 new overflow lib</code> to get project set up called overflow (of course names may vary) in a directory of the same name. That project is going to contain nothing but the core installation of 4.18.0 and there the proof should work.</p>",
        "id": 511019934,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744144064
    },
    {
        "content": "<p>Would you be interested in giving a talk to our students in digital design? Just to raise some curiosity among the students.</p>",
        "id": 511020053,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744144108
    },
    {
        "content": "<p>I'd definitely be interested yes!</p>",
        "id": 511020223,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1744144179
    },
    {
        "content": "<p>Awesome, we could move the discussion to a private channel.</p>",
        "id": 511020398,
        "sender_full_name": "Per Lindgren",
        "timestamp": 1744144224
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"897577\">@Per Lindgren</span> just alerting you to Henrik's recent talk at Lean Together: <a href=\"https://www.youtube.com/watch?v=Q1LDavBJ94A\">https://www.youtube.com/watch?v=Q1LDavBJ94A</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"Q1LDavBJ94A\" href=\"https://www.youtube.com/watch?v=Q1LDavBJ94A\"><img src=\"https://uploads.zulipusercontent.net/3c12982a3b3ce8192de56bd5ec798c621239e6f9/68747470733a2f2f692e7974696d672e636f6d2f76692f51314c446176424a3934412f6d7164656661756c742e6a7067\"></a></div>",
        "id": 511025821,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744146414
    }
]