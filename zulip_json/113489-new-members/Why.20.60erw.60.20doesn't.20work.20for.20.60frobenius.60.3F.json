[
    {
        "content": "<p>Hi everyone,<br>\nI encountered the following example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pchar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CharP</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- exact frobenius_add R p x y</span>\n<span class=\"w\">  </span><span class=\"n\">erw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">frobenius_add</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- failed</span>\n</code></pre></div>\n<p>The <code>exact frobenius_add R p x y</code> tactic will close the goal but erw does not work. Does anyone has some clue for this? Thank you!</p>",
        "id": 485918294,
        "sender_full_name": "Jiang Jiedong",
        "timestamp": 1733249045
    },
    {
        "content": "<p>I'm not sure, but I think it would be best to do <code>rw [&lt;- frobenius_def (x + y), frobenius_add]</code> (I did not test this)</p>",
        "id": 485920497,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1733249724
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Why.20.60erw.60.20doesn't.20work.20for.20.60frobenius.60.3F/near/485920497\">said</a>:</p>\n<blockquote>\n<p><code>&lt;- frobenius_def (x + y)</code></p>\n</blockquote>\n<p>Thank you! This works. But still I'm curious about what is special about this <code>frobenius</code> that makes <code>erw</code> cannot see through it. (But <code>exact</code> and <code>rfl</code> can)</p>",
        "id": 485922661,
        "sender_full_name": "Jiang Jiedong",
        "timestamp": 1733250439
    },
    {
        "content": "<p>It's more that <code>erw</code> isn't seeing it in the expression. Tactics like <code>exact</code> and <code>rfl</code> just need to check definitional equality, but <code>erw</code> needs to locate a term to rewrite.</p>",
        "id": 485924354,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1733250937
    },
    {
        "content": "<p>One of my guesses is that <code>frobenius</code> is a ring homomorphism, so applying it involves a coercion, and somehow that's obstructing <code>rw</code> from seeing the pattern.</p>",
        "id": 485925028,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1733251119
    },
    {
        "content": "<p>But more likely is that <code>rw</code> uses \"key matching\" when looking for a term to rewrite. It only considers doing a rewrite if the theorem's LHS and the target subexpression have the same \"key\".</p>",
        "id": 485925346,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1733251212
    },
    {
        "content": "<p>Yeah, in this case <code>(x + y) ^ p</code> has the key <code>HPow.hPow</code>, but the LHS of <code>frobenius_add</code> is going to be the name of the coercion function for ring homomorphisms.</p>",
        "id": 485925631,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1733251304
    },
    {
        "content": "<p>(I wonder if <code>erw</code> should turn off key matching? There's also no configuration option to turn it off yet.)</p>",
        "id": 485925850,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1733251369
    }
]