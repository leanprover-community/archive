[
    {
        "content": "<p>The way that <code>#eval ...</code> reports inductive type objects is surprising.  It's not causing any trouble for me, but I wanted to ask about it.  I'm not sure whether or not the behavior is intended.</p>\n<p>Using Lean 4.12.0-rc1 (with lean.nvim in neovim):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>The report from <code>#eval foo</code> is \"<a href=\"http://Foo.mk\">Foo.mk</a> 1\".    This seems inaccurate, but it occurred to me that perhaps indexes are intentionally removed from the reported object description to give a more succinct report. You can see the indexes using<code>#check</code>, after all.  So my hypothesis was that the rule for <code>#eval</code> report strings is \"Don't list indexes; only list non-index arguments.\"  This is confirmed by using a constructor with no non-index arguments (with obvious changes to the code); in that case <code>#eval foo</code> reports \"<a href=\"http://Foo.mk\">Foo.mk</a>\"</p>\n<p>However, the following case doesn't follow my hypothesized rule:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n</code></pre></div>\n<p>In this case <code>#eval bar</code> reports \"<a href=\"http://Bar.mk\">Bar.mk</a> 1 2\".  Maybe the rule for <code>#eval</code> report strings is \"Don't list indexes that appear as arguments before the first non-index argument.\"?</p>",
        "id": 472301282,
        "sender_full_name": "mars0i",
        "timestamp": 1727116217
    },
    {
        "content": "<p>This isn't an issue with <code>#eval</code>. The way <code>#eval</code> works is that it uses a <code>Repr</code> instance to turn the result into a string. The deriving handler for <code>Repr</code> seems to have a bug:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"c1\">-- Foo.mk 1</span>\n</code></pre></div>",
        "id": 472302087,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727116497
    },
    {
        "content": "<p>This is a bug because <code>Foo.mk</code> has three explicit arguments:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">mk</span>\n<span class=\"c1\">-- Foo.mk (loc : ℤ) (state id : ℕ) : Foo loc state</span>\n</code></pre></div>",
        "id": 472302204,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727116528
    },
    {
        "content": "<p>That makes sense.  Thanks <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>.  I don't understand details of the functioning of <code>Repr</code>, but I can submit an issue using my examples.</p>",
        "id": 472304416,
        "sender_full_name": "mars0i",
        "timestamp": 1727117308
    },
    {
        "content": "<p>I'm looking at fixing it right now. I'll let you know if I give up and you should submit an issue.</p>",
        "id": 472304557,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727117345
    },
    {
        "content": "<p>OK, great--thanks.</p>",
        "id": 472304599,
        "sender_full_name": "mars0i",
        "timestamp": 1727117362
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> <br>\nSince I'm already digging into <code>Repr</code> in my other PRs, if you could point me at a good starting point, I am happy to take a crack at this.</p>",
        "id": 472321235,
        "sender_full_name": "Tom",
        "timestamp": 1727121876
    },
    {
        "content": "<p>Sorry <span class=\"user-mention\" data-user-id=\"515083\">@Tom</span>, I already fixed it. <a href=\"https://github.com/leanprover/lean4/pull/5432\">lean4#5432</a></p>",
        "id": 472321346,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727121916
    },
    {
        "content": "<p>Thanks for reporting this <span class=\"user-mention\" data-user-id=\"617444\">@mars0i</span>!</p>",
        "id": 472321370,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727121923
    }
]