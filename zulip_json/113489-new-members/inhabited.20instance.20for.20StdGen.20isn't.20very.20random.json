[
    {
        "content": "<p>I am very confused by the fact that <code>stdNext</code> seems to return its input unchanged when its input is <code>(default : StdGen)</code>. Is this really the intended behavior?</p>\n<p>I ran into this problem when I was having trouble producing different random numbers using <code>randNat</code>.</p>\n<p><a href=\"https://live.lean-lang.org/#codez=MQUwbghgNgBAJgewFAxlEAXGBzEA7GALhgGUM4BxfIgXnhADMIBXKDFNTGACggBoc+AJS0YAJwh44AOQhZcBAAwwAjIvWKO6LNwBGAhSMJ0JU2fOrK1GrV24BjA8NGmZcwUtUbNqbTzhOeEYmkm4WntbqtjoggcHioeYeMFbe0TwMAqgA+vGuSQopXjaoAJIA8gB0AA5iAJZ4GFAEAM4AhABEAN4QAL4dMAC0gzAAHKMAzACsHBU19Y3NMO3duv1DI+PTs1W1DU2tnV3268NjkzNluwsHy0dwp5sXO/P7SytdII/n21evi4dugxvlsZkA\">Lean 4 Web example</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StdGen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">randNat</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">randNat</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">randNat</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">randNat</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">randNat</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\">   </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">randNat</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{a}\"</span><span class=\"w\"> </span><span class=\"c1\">-- 8835</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{b}\"</span><span class=\"w\"> </span><span class=\"c1\">-- 8835</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{c}\"</span><span class=\"w\"> </span><span class=\"c1\">-- 8835</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{d}\"</span><span class=\"w\"> </span><span class=\"c1\">-- 8835</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{e}\"</span><span class=\"w\"> </span><span class=\"c1\">-- 8835</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{f}\"</span><span class=\"w\"> </span><span class=\"c1\">-- 8835</span>\n</code></pre></div>\n<p>I expected that calling randNat successively would produce different numbers, but it instead produces the same number, <code>8835</code>. As far as I can tell, <code>randNat</code> returns the same generator it received. A little experimentation shows that when <code>stdNext</code> is passed <code>default</code>, we get <code>default</code> back, which I believe is the culprit here:</p>\n<p><a href=\"https://live.lean-lang.org/#codez=MQUwbghgNgBAJgewFAxlEAXGBzEA7GALhgGUM4BxfIgXnhADMIBXKDFNTGACgH0AaHPgDkASlowAzuQByIAB5ZceDgEsGQvADpJARhiADIk3Cd+wBREmnQCZDx6zAwALfB1QAnTMzcEARACUQAGNVcBA4GAh4dQYQDzwlfFiIDAQ3Hw4PDC8CSQBCfyCQVTAwh2cpCABbEE0klLSgA\">Lean 4 Web example</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StdGen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">gen'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stdNext</span><span class=\"w\"> </span><span class=\"n\">gen</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"bp\">.</span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">gen'</span><span class=\"bp\">.</span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">gen</span><span class=\"bp\">.</span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">gen'</span><span class=\"bp\">.</span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"Recieved a different generator\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Received the same generator\"</span>\n</code></pre></div>\n<p>(this evaluates to \"Received the same generator\")</p>\n<p>Here's a better proof:<br>\n<a href=\"https://live.lean-lang.org/#codez=C4Cwpg9gTmC2AEBLAdgZ2ASWSAhgI0WDABMBlYYgcTGQDpkJgB9ANzCgE8modliIEALngAKdMQByYAB7B4xMADMcAVwA2wAJS1UfeAF55S1RviDDeDgCh48VIlgAHeAG1xU2QBokaTNnyEJORUNAC6QA\">Lean 4 Web example</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">instInhabitedStdGen</span><span class=\"bp\">.</span><span class=\"n\">not_very_random</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stdNext</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">stdNext</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">instInhabitedStdGen</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 533196534,
        "sender_full_name": "Michael MacLeod",
        "timestamp": 1754526195
    },
    {
        "content": "<p>The default <code>StdGen</code> is <code>⟨0, 0⟩</code></p>",
        "id": 533197216,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754526707
    },
    {
        "content": "<p>Looking at <code>mkStdGen</code>, it suggests that the generator should have nonzero state, but <code>default</code> sets the state to <code>0</code>.</p>",
        "id": 533197220,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754526713
    },
    {
        "content": "<p>you should input a random generator instead</p>",
        "id": 533197238,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754526723
    },
    {
        "content": "<p>How about as a workaround, use <code>mkStdGen</code>?</p>\n<p>I'm not sure that the Inhabited instance is meant to be the way you create generators (but I don't know that it's not)</p>",
        "id": 533197271,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754526747
    },
    {
        "content": "<p>Are you using <code>default</code> intentionally, or is <code>default</code> being used because of something else, like a derived <code>Inhabited</code> instance?</p>",
        "id": 533197354,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754526817
    },
    {
        "content": "<p>Yes, the problem is what Aaron said about <code>⟨0, 0⟩</code> returning itself when passed to <code>stdNext</code>. If you use <code>mkStdGen</code> then this avoids the issue. </p>\n<p>I was using it intentionally to test some code out I was working on. I just expected that the default instance of a random number generator would actually function as a random number generator, not a constant number generator. (is there a good reason to have the default instance be <code>⟨0, 0⟩</code>?) I get that zero is a nice value to use as a default, but using it breaks the randomness.</p>",
        "id": 533197491,
        "sender_full_name": "Michael MacLeod",
        "timestamp": 1754526905
    },
    {
        "content": "<p>It's even explicitly defined!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">StdGen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>Changing this to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">StdGen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>would probably fix the problems.</p>",
        "id": 533247146,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754556743
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/9782\">lean4#9782</a></p>",
        "id": 533255375,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754559434
    }
]