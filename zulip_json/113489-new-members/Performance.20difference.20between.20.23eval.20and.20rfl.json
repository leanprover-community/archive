[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">divisors</span><span class=\"w\">  </span><span class=\"c1\">-- {1, 2, 4, 5, 10, 20} : Finset ℕ</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">divisors</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\">  </span><span class=\"c1\">-- 6</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">divisors</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- 1. 4 is divisible by the 3 numbers {1, 2, 4}</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Icc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\">  </span><span class=\"c1\">-- {1, 2, 3, 4, 5, 6, 7, 8, 9, 10}</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Icc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">divisors</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- 11</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Icc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">divisors</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- this line is slow</span>\n</code></pre></div>\n<p>I was experimenting with the MiniF2F solutions by DeepSeek. Among the 439 files the <code>valid/mathd_numbertheory_221.lean</code> is the only file I cannot compile on my laptop. It is running a <code>rfl</code> on a goal that looks like the above, which is a bruteforce proof that there are 11 integers in 1...1000 that have exactly 3 divisors. (It seems like this happens iff the number is a perfect square.)</p>\n<p>I think logically the <code>#eval</code> and <code>rfl</code> line are doing the same computation, but in practice <code>#eval</code> finishes instantly on my laptop, while <code>rfl</code> eats up the 16GB of RAM of my laptop and does not terminate after a few minutes.</p>\n<p>If I understand it correctly, <code>#eval</code> will compile the code before running it, while in <code>rfl</code> the computation is done by the Lean kernel type checker, so there will be some performance difference, but I did not expect it to be so serious.</p>\n<p>Do you know what data might be taking up the 16GB of RAM in the <code>rfl</code> proof?</p>",
        "id": 515932313,
        "sender_full_name": "David Xu",
        "timestamp": 1746294555
    },
    {
        "content": "<p><code>#eval</code> and <code>rfl</code> are not doing the same computation, because the <code>#eval</code> goes through the compiler, while the <code>rfl</code> goes through the kernel. If you want to prove this with the same computation that <code>#eval</code> does, you can do <code>native_decide</code> (or <code>decide +native</code>), but beware that you are now trusting the compiler too, which can be fed lies.</p>",
        "id": 515932875,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746294907
    },
    {
        "content": "<p><del>I suspect computing the divisors is what is taking so long</del></p>",
        "id": 515933001,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746294972
    },
    {
        "content": "<p>Divisors is actually pretty fast, but <code>#reduce Finset.Icc 1 1000</code> reaches the recursion limit</p>",
        "id": 515933196,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746295096
    },
    {
        "content": "<p>Everything's pretty fast! What could be taking so long???</p>",
        "id": 515933455,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746295245
    },
    {
        "content": "<p>Setting <code>trace.profiler</code> reveals that kernel typechecking is what is taking so long, and I can't peek inside due to lack of trace options, so I'm stuck now...</p>",
        "id": 515933928,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746295510
    },
    {
        "content": "<p>We've seen that phenomenon in algebraic geometry files because of universe issues but that's almost certainly not what's happening here. I agree that it's frustrating when this is the bottleneck. Can you remove imports and reproduce in core lean only? If so you can ask in <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4\">#lean4</a></p>",
        "id": 516002944,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746344046
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/113489-new-members/topic/Performance.20difference.20between.20.23eval.20and.20rfl/near/515933196\">said</a>:</p>\n<blockquote>\n<p>Divisors is actually pretty fast, but <code>#reduce Finset.Icc 1 1000</code> reaches the recursion limit</p>\n</blockquote>\n<p>Are you sure it's not the printing that hits the limit?</p>",
        "id": 516012547,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746351868
    }
]