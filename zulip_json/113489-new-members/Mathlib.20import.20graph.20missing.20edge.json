[
    {
        "content": "<p>I downloaded Mathlib's latest import graph from <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/18793996662\">the latest CI build</a>, and I noticed it's missing the edge</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"s2\">\"Mathlib.RingTheory.SimpleRing.Basic\"</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"Mathlib.RingTheory.Localization.FractionRing\"</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>even though <code>FractionRing</code> does import <code>SimpleRing.Basic</code> <a href=\"https://github.com/leanprover-community/mathlib4/blob/97d68c420815bcbd8abc9915155055423d8775c7/Mathlib/RingTheory/Localization/FractionRing.lean#L12C8-L12C43\">on line 12</a>.</p>\n<p>I haven't checked for any other missing edges, just ran into this one.<br>\nIs this intended (maybe it only lists minimal imports in some sense) or is this a bug?</p>",
        "id": 547018944,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761357426
    },
    {
        "content": "<p>I think by default it removes transitively redundant edges, see the CLI flag:</p>\n<p><a href=\"https://github.com/leanprover-community/import-graph/blob/451499ea6e97cee4c8979b507a9af5581a849161/Main.lean#L19\">https://github.com/leanprover-community/import-graph/blob/451499ea6e97cee4c8979b507a9af5581a849161/Main.lean#L19</a></p>",
        "id": 547059863,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1761400934
    },
    {
        "content": "<p>running <code>lake exe graph --show-transitive</code> would show all edges</p>",
        "id": 547059957,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1761401024
    },
    {
        "content": "<p>Nice, that explains it</p>",
        "id": 547061615,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761402648
    },
    {
        "content": "<p>I prefer turning this flag on in Mathlib's CI, or at least generate both versions.<br>\nI find the full version useful to find common ancestors, for placing theorems which depend on multiple files.<br>\nDoes anyone have any opinion on the matter?</p>",
        "id": 547061750,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761402810
    },
    {
        "content": "<p>Doesn't <code>#find_home</code> help with finding common ancestors?</p>",
        "id": 547072178,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761414121
    },
    {
        "content": "<p>I needed to find a file which imports both A and B, and is imported by C.<br>\nidk how to use <code>#find_home</code>, can it help with such constraints?</p>",
        "id": 547072265,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761414208
    },
    {
        "content": "<p>Slightly artificially: you could create a declaration that is the conjunction of two results from A and B inside C and then ask find home.</p>",
        "id": 547072362,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761414311
    },
    {
        "content": "<p>Wow that sounds very useful, I'll try it<br>\nI still would like to have the exact graph for more complex analysis, though I don't have a specific use case in mind (that isn't covered by find_home)</p>",
        "id": 547072508,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761414437
    },
    {
        "content": "<p>I think I added the import-graph artifact upload (which was previously just being built and then not persisted) not too long ago and that probably there aren't a ton of \"real\" users of the one uploaded during CI. A PR adding the other version I suspect wouldn't be too controversial to merge unless it's gigantic relative to the non-transitive version.</p>",
        "id": 547072567,
        "sender_full_name": "Julian Berman",
        "timestamp": 1761414506
    },
    {
        "content": "<p>It'd be nice to only generate the non-transitive version and then generate the other one from it (or generate both at once) rather than needing to parse things twice but probably running import-graph isn't a huge amount of time relative to the rest of the CI job.</p>",
        "id": 547072616,
        "sender_full_name": "Julian Berman",
        "timestamp": 1761414567
    },
    {
        "content": "<p>How about just having the non-transitive version?</p>",
        "id": 547072731,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761414720
    },
    {
        "content": "<p>Mathlib has 7k files, so at most 25mil edges.  Storing the transitive graph could occupy the order of 1Gb of space, right?  Do you know how much the \"slim\" one occupies?</p>",
        "id": 547072900,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761414902
    },
    {
        "content": "<p>The current one zipped is 270kb</p>",
        "id": 547072935,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761414932
    },
    {
        "content": "<p>Ok, I'm not sure how much zipping reduced, but I'm guessing that it is not 3 orders of magnitude, right?</p>",
        "id": 547072969,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761414978
    },
    {
        "content": "<p>Anyway, if you could compute the two locally and the sizes are comparable within one or two orders of magnitude, I'd imagine it is not a big deal to have both.</p>",
        "id": 547073004,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761415031
    },
    {
        "content": "<p>The cache is various gigabytes, so storing a few extra Mbs won't be a problem</p>",
        "id": 547073052,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761415082
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113489-new-members/topic/Mathlib.20import.20graph.20missing.20edge/near/547072969\">said</a>:</p>\n<blockquote>\n<p>Ok, I'm not sure how much zipping reduced, but I'm guessing that it is not 3 orders of magnitude, right?</p>\n</blockquote>\n<p>2mb uncompressed</p>",
        "id": 547073096,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761415142
    },
    {
        "content": "<p>Yeah it's less the file size I'm worried about, but CI time</p>",
        "id": 547073150,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761415202
    },
    {
        "content": "<p>How much longer to compute the full graph?</p>",
        "id": 547073198,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761415236
    },
    {
        "content": "<p>Keeping in mind that the computation of the \"big\" one from the \"small\" one could be done locally, and not burden all CI runs with it, I'd be more cautious about that.</p>",
        "id": 547073265,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761415313
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113489-new-members/topic/Mathlib.20import.20graph.20missing.20edge/near/547073265\">said</a>:</p>\n<blockquote>\n<p>Keeping in mind that the computation of the \"big\" one from the \"small\" one could be done locally, and not burden all CI runs with it, I'd be more cautious about that.</p>\n</blockquote>\n<p>I'm pretty sure it can't be done at all, the reduction is lossy. Only the other direction is possible.</p>",
        "id": 547073361,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761415378
    },
    {
        "content": "<p>You can certainly compute the transitive closure.</p>",
        "id": 547073453,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761415464
    },
    {
        "content": "<p>What you may not be able to recover is if a file contains a redundant import that gets pruned, but you would not be able to recover that from either the small nor the big version.</p>",
        "id": 547073498,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761415519
    },
    {
        "content": "<p>Ideally this should happen very rarely, though, since shake tries to trim imports.</p>",
        "id": 547073528,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761415553
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113489-new-members/topic/Mathlib.20import.20graph.20missing.20edge/near/547073453\">said</a>:</p>\n<blockquote>\n<p>You can certainly compute the transitive closure.</p>\n</blockquote>\n<p>A transitive closure is not the inverse of a transitive reduction.<br>\nBoth operations are lossy.</p>",
        "id": 547073749,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761415762
    },
    {
        "content": "<p>I think they for a galois connection between directed trees and irreflexive transitive relations</p>",
        "id": 547074068,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761416081
    },
    {
        "content": "<p>Stats based on my laptop:<br>\nFull graph - avg 5s to generate, 2.5 MiB, 309 KiB zipped<br>\nReduced graph - avg 10s to generate, 2.0 MiB, 249 KiB zipped</p>\n<p>So I think I'll open a PR to add the full graph as an artifact.</p>",
        "id": 547080350,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761423362
    },
    {
        "content": "<p>What? Why? I don't understand the motivation here.</p>",
        "id": 547087640,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761433593
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/113489-new-members/topic/Mathlib.20import.20graph.20missing.20edge/near/547087640\">said</a>:</p>\n<blockquote>\n<p>What? Why? I don't understand the motivation here.</p>\n</blockquote>\n<p>Having the import graph (and not just a transitive reduction of it) can be helpful to do various things.<br>\nThis thread has a few examples: <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members/topic/Exploring.20Mathlib/with/545146499\">#new members &gt; Exploring Mathlib</a> </p>\n<p>My favorite is that PhysLean have a web version of <code>lake exe graph --from X --to Y</code>: <a href=\"https://physlean.com/Dependencies.html?sources=PhysLean.SpaceAndTime.SpaceTime.Basic,PhysLean.Mathematics.List.InsertIdx,PhysLean.Mathematics.Fin,PhysLean.QFT.PerturbationTheory.CreateAnnihilate&amp;targets=PhysLean.QFT.PerturbationTheory.WickAlgebra.WicksTheorem\">https://physlean.com/Dependencies.html?sources=PhysLean.SpaceAndTime.SpaceTime.Basic,PhysLean.Mathematics.List.InsertIdx,PhysLean.Mathematics.Fin,PhysLean.QFT.PerturbationTheory.CreateAnnihilate&amp;targets=PhysLean.QFT.PerturbationTheory.WickAlgebra.WicksTheorem</a><br>\nI don't know it if uses the transitive reduction or not, but I find it helpful to see the exact import graph.</p>\n<p>If my opinion isn't popular then I can generate it locally instead of opening a PR, I didn't know it was that fast to generate.</p>",
        "id": 547088066,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1761434238
    }
]