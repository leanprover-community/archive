[
    {
        "content": "<p>I'm just starting to learn Lean 4 and was attempting to write a program that would read lines from a file and perform some action for each line.</p>\n<p>In Haskell, I would use something like <code>whileM</code>, but I have not seen a similar function in Lean 4.</p>\n<p>Here is a minimal example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">readLines</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">Handle</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"bp\">.</span><span class=\"n\">getLine</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"c1\">-- End of file, terminate</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">readLines</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"c1\">-- Recursive call for the next line</span>\n</code></pre></div>\n<p>which produces the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">well</span><span class=\"bp\">-</span><span class=\"n\">founded</span><span class=\"w\"> </span><span class=\"n\">recursion</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">readLines'</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">non</span><span class=\"bp\">-</span><span class=\"n\">fixed</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">arguments</span>\n</code></pre></div>\n<p>While I think I understand that error in general (no inductive type/no base case), I'm not sure how I can define a function which will exhaustively read and process lines from the file. Any suggestions or links to relevant references appreciated!</p>",
        "id": 486708500,
        "sender_full_name": "drone",
        "timestamp": 1733608987
    },
    {
        "content": "<p>Does <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IO.FS.lines#doc\">docs#IO.FS.lines</a> do what you want?</p>",
        "id": 486710131,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1733610355
    },
    {
        "content": "<p>Thanks! That should work for this case where the file isn't too large. But I'm curious if there is a way to process individual lines at a time without reading all lines from the file into memory first.</p>",
        "id": 486710380,
        "sender_full_name": "drone",
        "timestamp": 1733610556
    },
    {
        "content": "<p>Could this be a good use case for using <code>partial def</code>? That's the escape hatch that lets you write potentially non-terminating functions</p>",
        "id": 486710963,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1733611023
    },
    {
        "content": "<p>Marking <code>readLines</code> as <code>partial</code> does remove the error and the code does run as expected. Thank you!</p>",
        "id": 486711741,
        "sender_full_name": "drone",
        "timestamp": 1733611713
    },
    {
        "content": "<p>Indeed this has to partial, because the handle might be an infinite file like dev/urandom</p>",
        "id": 486712772,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733612689
    }
]