[
    {
        "content": "<p>Hi everyone!</p>\n<p>In a proof that I'm writing I have a variable with some constraint in the theorem. I one case I introduce a hypothesis i = 0 and then try to use rw to rewrite it in the goal. But it fails because it is not type correct. Reduced example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">make_array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">values_make_array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">make_array</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">make_array</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">make_array</span>\n<span class=\"w\">  </span><span class=\"n\">split</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">iz</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">iz</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- fails even though we have iz : i = 0</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">get_set_eq</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">nz</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>The error message suggests the error is related to the constraint h1. But I can't figure out how to make the rewrite work.<br>\nError message:<br>\ntactic 'rewrite' failed, motive is not type correct:<br>\n  fun _a =&gt; ((mkArray (n + 1) 0).set 0 1 ⋯)[_a] = 1<br>\nError: application type mismatch<br>\n  eq_true h1<br>\nargument<br>\n  h1<br>\nhas type<br>\n  i &lt; n + 1 : Prop<br>\nbut is expected to have type<br>\n  _a &lt; n + 1 : Prop</p>",
        "id": 497149471,
        "sender_full_name": "ssar",
        "timestamp": 1738403117
    },
    {
        "content": "<p>Welcome to dependent type theory! Core lean's <code>rw</code> is not strong enough to replace all i's with 0 and after the naive rewrite you get an expression which does not elaborate to a correct term. If you use mathlib's more powerful <code>simp_rw</code> it works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">make_array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">mkArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">values_make_array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">make_array</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">make_array</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">make_array</span>\n<span class=\"w\">  </span><span class=\"n\">split</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">iz</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">simp_rw</span><span class=\"o\">[</span><span class=\"n\">iz</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- more motive-aware `rw` works</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"o\">[</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">get_set_eq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">nz</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 497149744,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738403342
    },
    {
        "content": "<p>Hah, that works. thanks a lot for the quick help!<br>\nI kind of understood that I'm not supposed to 'dodge' the constraint on i by rewriting the goal, but the problem resisted all my attempts using just rw and simp :)</p>",
        "id": 497150316,
        "sender_full_name": "ssar",
        "timestamp": 1738403820
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870275\">ssar</span> has marked this topic as resolved.</p>",
        "id": 497150323,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738403824
    },
    {
        "content": "<p>You could try <code>simp only [iz]</code>, that sometimes works (not at a computer right now), and I think someone was talking recently about proposing a more motive-aware <code>rw</code> recently (edit: it was Aaron Liu, see below). It's an extremely difficult problem though because higher-order unification is undecidable so even though it's easy to say \"the solution here is obvious\", it's much much harder to write an algorithm which succeeds every time the solution is \"obvious\".</p>",
        "id": 497150897,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738404361
    },
    {
        "content": "<p>I recently wrote a tactic that does <code>rw</code> but better, and I haven't had any <code>motive is not type correct</code> errors with it yet.<br>\nI put it here: <a class=\"stream-topic\" data-stream-id=\"239415\" href=\"/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/dependent.20rewrite.20tactic\">#metaprogramming / tactics &gt; dependent rewrite tactic</a></p>",
        "id": 497184370,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738432592
    },
    {
        "content": "<p>Whenever you have a variable equaling a value(*), you can <em>always</em> eliminate it by a step where you substitute it everywhere it appears in the local context. Tactics that do that are <code>subst iz</code>, <code>subst i</code>, <code>subst_vars</code>, and <code>cases ih</code>.</p>\n<p>(*) The value can't itself refer to the variable, but it could otherwise be some complex expression.</p>",
        "id": 497184580,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738432777
    },
    {
        "content": "<p>Ah, nice that works as well. subst seems strictly more useful than rw in most cases where we replace a variable.</p>",
        "id": 497191699,
        "sender_full_name": "ssar",
        "timestamp": 1738438414
    },
    {
        "content": "<p>If you want the details, the way <code>subst</code> works is that it does <code>revert</code> first to everything that depends on the variable, does <code>rw</code>, does <code>clear</code> to remove the value, and then does <code>intro</code> to bring everything back into context. (Technically it does it all itself without using other tactics, but the effect is basically the same.)</p>",
        "id": 497191825,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738438521
    },
    {
        "content": "<p>It's useful to know because sometimes the answer to a failed <code>rw</code> is to <code>revert</code> something relevant.</p>",
        "id": 497191839,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738438546
    },
    {
        "content": "<p>Example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">values_make_array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">make_array</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">make_array</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">make_array</span>\n<span class=\"w\">  </span><span class=\"n\">split</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"n\">iz</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">revert</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">iz</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">      </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"n\">nz</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 497191930,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738438618
    }
]