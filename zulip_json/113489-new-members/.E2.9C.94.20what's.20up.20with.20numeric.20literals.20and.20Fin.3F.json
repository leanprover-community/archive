[
    {
        "content": "<p>Hello, I've been messing around with <code>Fin</code> some and have run into some strange behavior. I found one thing that I'm pretty sure is a bug, but I also ran into this, which seems more likely to be a misunderstanding on my part. Why does the following code typecheck + compile + evaluate to <code>0</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1025</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>\n<p>I would expect that this code would fail to typecheck in the same way ascribing it as a String would. But it doesn't, and somehow coerces it to <code>0</code>. What is the reason for this behavior?</p>",
        "id": 527991284,
        "sender_full_name": "JJ",
        "timestamp": 1752114278
    },
    {
        "content": "<p>I've now found a note in the manual documenting this behavior:</p>\n<blockquote>\n<p>When the literal is greater than or equal to <code>n</code>, the remainder when dividing by <code>n</code> is used</p>\n</blockquote>\n<p>Why is this the case, though?</p>",
        "id": 527991587,
        "sender_full_name": "JJ",
        "timestamp": 1752114630
    },
    {
        "content": "<p>(also having a manual is very nice!)</p>",
        "id": 527991610,
        "sender_full_name": "JJ",
        "timestamp": 1752114656
    },
    {
        "content": "<p>relevant thread: <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members/topic/3.20incorrectly.20accepted.20as.20Fin.201.3F/with/521448102\">#new members &gt; 3 incorrectly accepted as Fin 1?</a></p>",
        "id": 527992628,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1752115782
    },
    {
        "content": "<p>Oh, yikes. Yeah, count me down as very much not liking that <code>#eval (256 : UInt8) == 0</code> is true</p>",
        "id": 527992798,
        "sender_full_name": "JJ",
        "timestamp": 1752115990
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634325\">JJ</span> has marked this topic as resolved.</p>",
        "id": 527992824,
        "sender_full_name": "Notification Bot",
        "timestamp": 1752116018
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"634325\">@JJ</span> what's the thing you think is a bug?</p>",
        "id": 527993244,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1752116379
    },
    {
        "content": "<p>I filed it here: <a href=\"https://github.com/leanprover/lean4/issues/9292\">https://github.com/leanprover/lean4/issues/9292</a></p>\n<p>There's very weird behavior around pattern matching on a term of type <code>Fin n</code>.</p>",
        "id": 527993340,
        "sender_full_name": "JJ",
        "timestamp": 1752116444
    },
    {
        "content": "<p>(what's the syntax to eval examples again?)</p>",
        "id": 527993397,
        "sender_full_name": "JJ",
        "timestamp": 1752116485
    },
    {
        "content": "<p>you just wrote #eval above, is that not it?</p>",
        "id": 527993492,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1752116563
    },
    {
        "content": "<p>Oh I meant on Zulip. I swore something existed</p>",
        "id": 527993508,
        "sender_full_name": "JJ",
        "timestamp": 1752116578
    },
    {
        "content": "<p>there's a \"View in Lean 4 playground\" link in the upper right corner of code blocks</p>",
        "id": 527993569,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1752116633
    },
    {
        "content": "<p>The bug is that this compiles fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">toBase15</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Char</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">0</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">2</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">3</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">4</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">5</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">6</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">7</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">8</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">9</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">A'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">B'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">C'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">E'</span>\n</code></pre></div>\n<p>while this does not:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">toBase16</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Char</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">0</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">2</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">3</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">4</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">5</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">6</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">7</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">8</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">9</span><span class=\"bp\">'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">A'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">B'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">C'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">E'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">F'</span>\n</code></pre></div>",
        "id": 527993601,
        "sender_full_name": "JJ",
        "timestamp": 1752116658
    },
    {
        "content": "<p>I see</p>",
        "id": 527993717,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1752116757
    },
    {
        "content": "<p>kind of bizarre!</p>",
        "id": 527993774,
        "sender_full_name": "JJ",
        "timestamp": 1752116797
    },
    {
        "content": "<p>maybe it's a limitation on how far Lean is willing to expand numeric literals into <code>succ</code> and <code>zero</code> in pattern matching? <span aria-label=\"man shrugging\" class=\"emoji emoji-1f937-200d-2642\" role=\"img\" title=\"man shrugging\">:man_shrugging:</span> someone else here probably knows the answer</p>",
        "id": 527994115,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1752117118
    },
    {
        "content": "<p>Not relevant to your bug I think, but <a href=\"https://leanprover-community.github.io/extras/pitfalls.html#wrapping-arithmetic-in-fin\">https://leanprover-community.github.io/extras/pitfalls.html#wrapping-arithmetic-in-fin</a> has a bit of discussion on the general topic of wrapping in <code>Fin</code></p>",
        "id": 528123348,
        "sender_full_name": "Jason Reed",
        "timestamp": 1752165980
    },
    {
        "content": "<p>(I'm mostly saying this just to advertise the rest of the stuff on <a href=\"https://leanprover-community.github.io/extras/pitfalls.html\">https://leanprover-community.github.io/extras/pitfalls.html</a> which is <a href=\"#narrow/channel/113488-general/topic/Documenting.20lean.20pitfalls.3A.20feedback.20requested/with/520155520\">somewhat new</a> and helped me a lot)</p>",
        "id": 528123567,
        "sender_full_name": "Jason Reed",
        "timestamp": 1752166082
    },
    {
        "content": "<p>Cool! Didn't know that page existed.</p>\n<p>It seems silly for wraparound to apply to literals, imo. At the least I think it would be useful if that was a compile time warning.</p>",
        "id": 528147223,
        "sender_full_name": "JJ",
        "timestamp": 1752175904
    },
    {
        "content": "<p>For anyone coming here from the future, the <code>ℕ → Fin n</code> coercion was removed from Lean core in <a href=\"https://github.com/leanprover/lean4/pull/8620\">lean#8620</a>, and in mathlib <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instCommRing#doc\">docs#Fin.instCommRing</a> isn't an instance either anymore.</p>",
        "id": 528147717,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1752176136
    }
]