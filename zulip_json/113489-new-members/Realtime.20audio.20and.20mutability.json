[
    {
        "content": "<p>Hi all, new here; I have a question about practicality in application</p>\n<p>From what I can tell, Lean4 wants to say that it is possible to function as a general purpose language (to some degree). At the same time, it appears to be purely functional with sugar that might suggest otherwise.</p>\n<p>Let's say I was interested in writing a DSP from scratch and had a need to reuse memory (so, mutability) to extend the amount of computability that could be performed in realtime versus a system designed in purity that might become more limited depending exactly on how things are resolved from Lean to C to Assembly</p>\n<p>My question, I suppose, are multiple:</p>\n<ul>\n<li>Do I misunderstand Lean? I'd also like to explore sound ideas in a space that is not necessarily listenable, but I'd still want things to work efficiently when rendering realtime audio</li>\n<li>Do I misunderstand mutability in Lean? it appears to be sugar and the language is purely functional and anything otherwise under the covers is happenstance and there's not practical way to reuse something like an Array through multiple function calls</li>\n<li>Do I misunderstand design? This question asks if there is some design where, through a system of mutability perhaps I can reason about something that functions in realtime but through lack of experience I don't know how to make the comparable in a system that does otherwise (like pure functional)</li>\n</ul>\n<p>Anyway, I appreciate feedback and insight, and I would like to say that Lean4 has been one of the most interesting languages to learn as of recent with excellent tooling for developers and I appreciate that.</p>",
        "id": 570695710,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769654761
    },
    {
        "content": "<p><a href=\"#narrow/channel/113489-new-members/topic/Realtime.20audio.20and.20mutability/near/570695710\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members/topic/Absolute.20minimum.20vs.2E.20interesting.20minimum.20mixins.2E/with/570693311\">#new members &gt; Absolute minimum vs. interesting minimum mixins.</a> by <span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span>.</p>",
        "id": 570721980,
        "sender_full_name": "Notification Bot",
        "timestamp": 1769672289
    },
    {
        "content": "<p>If your concern is that Lean wouldn't allow directly mutating something like an array in place, then no, Lean <em>does</em> allow modifying an array in place. To be precise, whenever something like an <code>Array</code> or a <code>ByteArray</code> or whatever has a reference count of 1, the mutation happens in place and nothing new is allocated. In particular that means that as long as you don't use the original array anymore after mutation, the mutation happens in place and no copying is performed. This way of not using the original after mutation is often referred to as \"linear use\" and can be compared to ownership in rust. For example, this code uses the array linearly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fillArray</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">*...</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span>\n</code></pre></div>\n<p>As you can see, computations like <code>#eval (fillArray 100_000).size</code> happen very quickly and even <code>#eval (fillArray 10_000_000).size</code> doesn't take too long (and in compiled code it would be even faster).<br>\nIf we compare this to a nonlinear implementation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fillArrayNonlinear</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">*...</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">orig</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">    </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">orig</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"c1\">-- orig is used after `push`</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span>\n</code></pre></div>\n<p>Even <code>#eval (fillArrayNonlinear 100000).size</code> takes a long time here. That's because the original array is still used so it can't mutate in place, so it copies <em>every time</em>, resulting in quadratic runtime.<br>\nAnother way to introduce mutation is through <code>IO</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fillArrayIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">*...</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">modifyGet</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span>\n</code></pre></div>\n<p>Here we use an actual mutable reference cell and thus need <code>IO</code> (or at least <code>BaseIO</code>, which is IO without exceptions) to preserve purity. The runtime of this one is comparable to the first one, maybe a tiny bit slower.<br>\nSo in a sense, yes, Lean doesn't have mutation, since it is purely functional but really, by being reference counted, Lean can turn things that look like mutation into actual mutation.</p>",
        "id": 570860852,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769709104
    },
    {
        "content": "<p>Although, linearization doesn't work in multi-threaded context. <a href=\"#narrow/channel/270676-lean4/topic/.5Bcache.5D.20attribute/near/564254453\">#lean4 &gt; &#91;cache&#93; attribute @ üí¨</a></p>",
        "id": 570911654,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769727664
    },
    {
        "content": "<p>I was trying something similar, drawing an image</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Pixel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">UInt8</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Image</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Pixel</span><span class=\"o\">)</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">doit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">img</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Image</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span>\n<span class=\"w\">          </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newrow</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">img</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">255</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"n\">img</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">img</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">newrow</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">img</span>\n</code></pre></div>\n<p>It isn't clear to me that the reference count of the row would be 1? Is nesting like this a bad data format and how can I tell if I've achieved the reasonable implementation? Is there some <code>#set_option</code> I can do to see such things? Also any other suggestions for improvement welcome</p>",
        "id": 570915705,
        "sender_full_name": "Philip Zucker",
        "timestamp": 1769730012
    },
    {
        "content": "<p>The right thing to do here is to <code>img.modify i fun row =&gt; row.set! j (0, 0, 255)</code>; <code>modify</code> clears the value out of the array before running the inner function</p>",
        "id": 570916731,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769730641
    },
    {
        "content": "<p><del>Looking at the generated C code I think that Lean was able to optimize away copy'ing row.</del></p>",
        "id": 570916946,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769730777
    },
    {
        "content": "<p>I was familiar with mutating in place as long as ref count is 1 as documentation I think does a good job describing this behavior but I just wasn't sure about making that work in composing a larger system that may consist of multiple various buffers persisted and then reused through various iterations of repeated function calls. From my naive experimentation, it seemed like multiple copies were created during a recalculation.</p>\n<p>For example, a structure that holds a private array that acts as a small buffer and then repeated function calls that recalculate the private buffer, as a single recalculation may then be followed by multiple reads. And so the issue arises because I make a local mutable reference of the private (which presumably bumps ref count) but then also have to solve updating the structure requiring pushing some logic up the chain to build a larger system, and so on.</p>\n<p>But, I was not at all familiar with IO.mkRef and it seems like maybe this might resolve my immediate problem and it's not something I've seen come up in the documentation yet. It seems like that can let me do encapsulation without also having to redefine a structure when encapsulated mutability occurs, so I'll definitely have a look at this.</p>\n<p>Thank you!</p>",
        "id": 570936760,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769744525
    },
    {
        "content": "<p>well I was finishing chapter 18 and then went on a tangent into metaprogramming guide to build a DSL for something else, whereas IO.mkRef shows up in chapter 21, so more reading to do still</p>",
        "id": 570942704,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769748898
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/113489-new-members/topic/Realtime.20audio.20and.20mutability/near/570916946\">said</a>:</p>\n<blockquote>\n<p>Looking at the generated C code I think that Lean was able to optimize away copy'ing row.</p>\n</blockquote>\n<p>You cannot directly see array copies in the generated code, the original code without modify very much does always copy</p>",
        "id": 570962419,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1769760144
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik B√∂ving</span> <a href=\"#narrow/channel/113489-new-members/topic/Realtime.20audio.20and.20mutability/near/570962419\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/113489-new-members/topic/Realtime.20audio.20and.20mutability/near/570916946\">said</a>:</p>\n<blockquote>\n<p>Looking at the generated C code I think that Lean was able to optimize away copy'ing row.</p>\n</blockquote>\n<p>You cannot directly see array copies in the generated code, the original code without modify very much does always copy</p>\n</blockquote>\n<p>Oh, wait, why is that? Is the code generated by <code>lean --c=main.c Main.lean</code> not the same as compiled by <code>lake build</code>? I can see the call to <code>lean_copy_expand_array</code> in assembly of the generated binary, but couldn't find where is it called from in the C code.</p>",
        "id": 570994961,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769770018
    },
    {
        "content": "<p>In <code>Array.set!</code>, all relevant linearity checks for array happen inside of the runtime.</p>",
        "id": 570995663,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1769770209
    },
    {
        "content": "<p>Ah, yes, I found it, the copy is in <code>lean_ensure_exclusive_array</code>. Thanks!<br>\nAnd there's <code>lean_inc</code> call for the row, so the copy will happen.</p>",
        "id": 571000291,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1769771569
    },
    {
        "content": "<p>when I benchmarked the 3 implementations, compiled, fillArrayIO had performance similar to fillArrayNonlinear and not fillArray</p>",
        "id": 571035017,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769781386
    },
    {
        "content": "<p>also, noting the comment on ordering in fillArrayNonlinear, I revisited using structure with private array issue i was having and see that it is possible to do what I wanted without needing to introduce BaseIO at that level, so the rest is just however I want to build out my graph. Thanks for the assistance</p>",
        "id": 571052855,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769785499
    },
    {
        "content": "<p>replacing <code>ref.modifyGet</code> from fillArrayIO example as follows then puts it in comparable runtime as first example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">    </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n</code></pre></div>\n<p>though if lines are reversed it then becomes comparable to second; so, however <code>ref.modifyGet</code> is handled does impact runtime of the example.</p>\n<p>I was also able to define things like this too and it just seemed to work as I might expect</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Discrete</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Discrete</span><span class=\"bp\">.</span><span class=\"n\">fill</span><span class=\"o\">(</span><span class=\"n\">sig</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Discrete</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 571151729,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769823154
    },
    {
        "content": "<p>Hmm I see you're probably on a version without <a href=\"https://github.com/leanprover/lean4/pull/11983\">lean4#11983</a>. I'll also note though that the PR title is somewhat misleading because the <code>floatLetIn</code> compiler pass <em>still</em> doesn't <em>ensure</em> linearity (<code>floatLetIn</code> is basically a pass for moving let declarations using the purity guarantee but this reorder can break linearity).</p>",
        "id": 571152123,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769823506
    },
    {
        "content": "<p>ah yeah that looks pretty recent</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>cat<span class=\"w\"> </span>lean-toolchain\nleanprover/lean4:v4.27.0\n</code></pre></div>",
        "id": 571152310,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769823672
    },
    {
        "content": "<p>Yeah right, <a href=\"https://github.com/leanprover/lean4/pull/11983\">lean4#11983</a> is only on 4.28.0-rc1</p>",
        "id": 571152670,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769823952
    },
    {
        "content": "<p>Otherwise, one way you can prevent such problems is to offload all critical operations to <code>IO</code> functions</p>",
        "id": 571152765,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769824044
    },
    {
        "content": "<p>so e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">refArraySize</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">&lt;$&gt;</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">refArrayPush</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BaseIO</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">ref</span><span class=\"bp\">.</span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">arr</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">val</span>\n</code></pre></div>\n<p>and then</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sizeSum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">refArraySize</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"o\">)</span>\n<span class=\"n\">refArrayPush</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>",
        "id": 571152838,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1769824120
    },
    {
        "content": "<p>hey that's cute, I looked away from your example and tried myself, just lifted offending line into <code>IO.Ref (Array Nat) -&gt; BaseIO Nat</code> and it instantly sped back up.</p>\n<p>At some level I'm going to be pushing operations to IO functions, but I imagine that will be higher up the design stack as this kind of idea is still new to me.</p>\n<p>i also need to see what the norm is for benchmarking lean programs so I can identify when I introduce problems.</p>",
        "id": 571153665,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1769824953
    },
    {
        "content": "<p>I have a follow up question for identifying problematic copying. I have this minimal example of three different <code>prepare</code> functions.</p>\n<ul>\n<li><code>prepareA</code> is problematic</li>\n<li><code>prepareB</code> resolves the problem but has roughly same performance</li>\n<li><code>prepareC</code> matches performance expectations running at 7x speed of previous but I don't understand why</li>\n</ul>\n<p>Using <code>dbgTraceIfShared</code> helped me identify one of the problems with <code>prepareA</code> but I assume there are more still and using <code>dbgTraceIfShared</code> on other parts doesn't appear to yield anything. Is there some other method to identify the issue? And, I don't know what the issue is or why the global resolves.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Œît</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">440</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">48000</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">fract</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">floor</span>\n\n<span class=\"c1\">-- original code uses class and instance but found I needed inline, otherwise prepareC below has same performance</span>\n<span class=\"c1\">-- removing inline does not appear to affect prepareA or prepareB benchmarks below</span>\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">sample</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">abs</span><span class=\"bp\">.</span><span class=\"n\">fract</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"bp\">.</span><span class=\"n\">toFloat</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"bp\">.</span><span class=\"n\">toNat</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"mi\">4096</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"mi\">256</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"c1\">-- prepareA osc.out is shared so RC &gt; 1 and copies</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"bp\">.</span><span class=\"n\">prepareA</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceIfShared</span><span class=\"w\"> </span><span class=\"s2\">\"osc.out\"</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">phase</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">sample</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- problematic osc.inp</span>\n<span class=\"w\">    </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Œît</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- prepareB osc.out no longer prints shared but has same performance as prepareA ???</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"bp\">.</span><span class=\"n\">prepareB</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">inp</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceIfShared</span><span class=\"w\"> </span><span class=\"s2\">\"osc.out\"</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">phase</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">sample</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Œît</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- prepareC uses global input versus stored input on Osc and has very different performance</span>\n<span class=\"c1\">-- which is near what I would expect for no copying</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g_inp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FloatArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"mi\">4096</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"bp\">.</span><span class=\"n\">prepareC</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceIfShared</span><span class=\"w\"> </span><span class=\"s2\">\"osc.out\"</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">phase</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g_inp</span><span class=\"bp\">.</span><span class=\"n\">sample</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Œît</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- 1.794s</span>\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bench_prepareA</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">*...</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">prepareA</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"c1\">-- 1.665s</span>\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bench_prepareB</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">*...</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">prepareB</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"c1\">-- 0.254s</span>\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bench_prepareC</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">*...</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">prepareC</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">_</span><span class=\"mi\">000</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- bench_prepareA N</span>\n<span class=\"w\">  </span><span class=\"c1\">-- bench_prepareB N</span>\n<span class=\"w\">  </span><span class=\"n\">bench_prepareC</span><span class=\"w\"> </span><span class=\"n\">N</span>\n</code></pre></div>",
        "id": 573320340,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1770824408
    },
    {
        "content": "<p>Well it appears to have something to do with converting Nat to Float in <code>FloatArray.sample</code> but only if the array is in a structure? This is on lean v4.28.0-rc1</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- inline FloatArray.sample and extract osc.inp.size, but still convert to float in loop</span>\n<span class=\"c1\">-- 1.733s</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"bp\">.</span><span class=\"n\">prepareD</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">inp</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inpsize</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceIfShared</span><span class=\"w\"> </span><span class=\"s2\">\"osc.out\"</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">phase</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">phase</span><span class=\"bp\">.</span><span class=\"n\">abs</span><span class=\"bp\">.</span><span class=\"n\">fract</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">inpsize</span><span class=\"bp\">.</span><span class=\"n\">toFloat</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUSize</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Œît</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- inline again but this time convert to float outside of loop</span>\n<span class=\"c1\">-- yet, prepareC just uses FloatArray.sample as-is without issue and same performance</span>\n<span class=\"c1\">-- 0.271s</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"bp\">.</span><span class=\"n\">prepareE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Osc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">inp</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inpsize</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"bp\">.</span><span class=\"n\">toFloat</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceIfShared</span><span class=\"w\"> </span><span class=\"s2\">\"osc.out\"</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">out</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"bp\">.</span><span class=\"n\">phase</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">set!</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">phase</span><span class=\"bp\">.</span><span class=\"n\">abs</span><span class=\"bp\">.</span><span class=\"n\">fract</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">inpsize</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUSize</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Œît</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">osc</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">phase</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 573328954,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1770826386
    },
    {
        "content": "<p>heaptrack helped identify the issue in this case</p>",
        "id": 573329250,
        "sender_full_name": "Daniel Skinner",
        "timestamp": 1770826450
    }
]