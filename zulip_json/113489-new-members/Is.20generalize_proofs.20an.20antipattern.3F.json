[
    {
        "content": "<p>I often have to resort to <code>generalize_proofs</code> to pull out some proofs from the otherwise-inscrutable goal in situations like this:</p>\n<p><a href=\"/user_uploads/3121/FLjpCpRzaJx8cpLqdZpnCokl/Screenshot-2025-09-05-at-23.22.15.png\">Screenshot 2025-09-05 at 23.22.15.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/FLjpCpRzaJx8cpLqdZpnCokl/Screenshot-2025-09-05-at-23.22.15.png\" title=\"Screenshot 2025-09-05 at 23.22.15.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1414x278\" src=\"/user_uploads/thumbnail/3121/FLjpCpRzaJx8cpLqdZpnCokl/Screenshot-2025-09-05-at-23.22.15.png/840x560.webp\"></a></div><p>And then hopefully it gives me something I can turn into a proof:</p>\n<p><a href=\"/user_uploads/3121/bTjiDIedW_HLzNRkO-C0jrei/Screenshot-2025-09-05-at-23.23.03.png\">Screenshot 2025-09-05 at 23.23.03.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/bTjiDIedW_HLzNRkO-C0jrei/Screenshot-2025-09-05-at-23.23.03.png\" title=\"Screenshot 2025-09-05 at 23.23.03.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1430x284\" src=\"/user_uploads/thumbnail/3121/bTjiDIedW_HLzNRkO-C0jrei/Screenshot-2025-09-05-at-23.23.03.png/840x560.webp\"></a></div><p>I was wondering whether this technique is common or considered an anti-pattern. I suspect I'm missing some explicit APIs that would remove a need for this. In particular, it feels fragile to depend on the order of proofs being extracted — it's usually like a grabbag of stuff.</p>\n<p>Is my intuition about this right? Should I be grossed out by doing it?</p>",
        "id": 537954823,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1757111052
    },
    {
        "content": "<p>No, it's fine, as far as I understand it. But you probably don't want to spend too long with <code>Exists.choose</code> terms in your state; hopefully you'll wrap those in a definition and won't need to see them again when you've set up basic api</p>",
        "id": 537955131,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1757111222
    },
    {
        "content": "<p>Why are you doing <code>have := h1.choose_spec</code> rather than <code>obtain ⟨f, this⟩ := hf</code>? Your goal is a Prop (as it should be, in tactic mode) so you don't need AC here.</p>",
        "id": 537992057,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757153648
    },
    {
        "content": "<p>probably the choosing was done in some other definition which was then unfolded</p>",
        "id": 537992248,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757153878
    },
    {
        "content": "<p>Yeah, this is spilled guts from an abbrev.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">pow_fun_equiv</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">powerset_axiom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"bp\">.</span><span class=\"n\">property</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">choose</span>\n<span class=\"w\">  </span><span class=\"n\">invFun</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">powerset_axiom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"bp\">⟩⟩</span>\n<span class=\"w\">  </span><span class=\"n\">left_inv</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">powerset_axiom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"bp\">.</span><span class=\"n\">property</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">choose_spec</span>\n<span class=\"w\">  </span><span class=\"n\">right_inv</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>I've since <a href=\"https://github.com/gaearon/analysis-solutions/pull/9/commits/7c097cab99dd42595713de5244a3651cfd1615e2\">tweaked the approach</a> to make this a <code>def</code> with a <code>lemma</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">pow_fun_equiv</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">powerset_axiom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"bp\">.</span><span class=\"n\">property</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">choose</span>\n<span class=\"w\">  </span><span class=\"n\">invFun</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">powerset_axiom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">f</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"bp\">⟩⟩</span>\n<span class=\"w\">  </span><span class=\"n\">left_inv</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">powerset_axiom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"bp\">.</span><span class=\"n\">property</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">choose_spec</span>\n<span class=\"w\">  </span><span class=\"n\">right_inv</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">pow_fun_eq_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">pow_fun_equiv</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pow_fun_equiv</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"n\">pow_fun_equiv</span><span class=\"bp\">.</span><span class=\"n\">apply_eq_iff_eq</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>So now it no longer \"spills out\" the choice-y guts, and this part of the proof just closes by simp.</p>",
        "id": 538007986,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1757169284
    },
    {
        "content": "<p>And to answer the question directly, <code>obtain</code> wouldn't help close the goal here because the statements I'd get out of two of those would \"talk about\" different functions than the ones in my goal's expression. The goal is to bridge them together.</p>\n<p><a href=\"/user_uploads/3121/sYICWqgOJCUh4vVAwJis0QjF/Screenshot-2025-09-06-at-15.37.24.png\">Screenshot 2025-09-06 at 15.37.24.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/sYICWqgOJCUh4vVAwJis0QjF/Screenshot-2025-09-06-at-15.37.24.png\" title=\"Screenshot 2025-09-06 at 15.37.24.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2284x422\" src=\"/user_uploads/thumbnail/3121/sYICWqgOJCUh4vVAwJis0QjF/Screenshot-2025-09-06-at-15.37.24.png/840x560.webp\"></a></div><p>Using a <code>def</code> instead of <code>abbrev</code> avoids this problem altogether though because choice stays behind an opaque <code>pow_fun_equiv</code> call.</p>\n<p>So this entire section <a href=\"https://github.com/gaearon/analysis-solutions/pull/9/commits/7c097cab99dd42595713de5244a3651cfd1615e2#diff-bdbce9316b0da44300e6ff2f64d06ded54094b2931acf093a6642b96397ad779R903\">goes away</a>.</p>",
        "id": 538008521,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1757169672
    }
]