[
    {
        "content": "<p>I found the following surprising, and would love to know what's really going on here. When I have:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">realmat1</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">toLin'</span><span class=\"w\">  </span><span class=\"bp\">!!</span><span class=\"o\">[(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I get an error</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">toMatrix'</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">toMatrix</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">toLin</span><span class=\"bp\">._</span><span class=\"n\">at_</span><span class=\"bp\">.</span><span class=\"n\">fderivPolarCoordSymm</span><span class=\"bp\">.</span><span class=\"n\">spec_16</span><span class=\"bp\">.</span><span class=\"n\">spec_16</span><span class=\"bp\">.</span><span class=\"n\">spec_38'</span>\n</code></pre></div>\n<p>But if I prefix the declaration with <code>noncomputable</code>, lean is happy and the definition checks ok. Is this expected behavior? I just happened to get lucky guessing \"noncomputable\". Any thoughts on how to divine what to do if I get other 'unknown constant' errors for constants I didn't introduce references to? Is this macro shenanigans going wrong deep in mathlib? Or something I'm doing wrong invoking <code>Matrix.toLin'</code>?</p>",
        "id": 526869358,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751485513
    },
    {
        "content": "<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">ToLin</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">realmat1</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">!!</span><span class=\"o\">[(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">toLin'</span>\n</code></pre></div>",
        "id": 526870419,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486030
    },
    {
        "content": "<p>Good to know. I remain curious why I got such a seemingly unrelated error there though.</p>",
        "id": 526870520,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486072
    },
    {
        "content": "<p>If you want to debug then perhaps the next step is to keep importing more and more of mathlib until you find the file which causes the problem</p>",
        "id": 526870604,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1751486112
    },
    {
        "content": "<p>It might be something to do with the new compiler?</p>",
        "id": 526870622,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1751486122
    },
    {
        "content": "<p>Something fishy seems to be going on in Mathlib/Analysis/SpecialFunctions/PolarCoord.lean (which is what defines <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=fderivPolarCoordSymm#doc\">docs#fderivPolarCoordSymm</a>)</p>",
        "id": 526870693,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486157
    },
    {
        "content": "<p><code>import Mathlib.Analysis.SpecialFunctions.PolarCoord</code> breaks it, but everything is fine if you paste the entire contents of that file above the <code>def</code></p>",
        "id": 526870764,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486193
    },
    {
        "content": "<p>Maybe <span class=\"user-mention\" data-user-id=\"656225\">@Cameron Zwarich</span> would be interested here</p>",
        "id": 526870779,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486201
    },
    {
        "content": "<p>\"<code>spec_16</code>\" suggests there's a compiler bug — so no impact on theory.</p>\n<p>Given that this is a <code>Real</code> matrix, there's not much use in compiling the definition (so <code>noncomputable</code> is completely justified), but I'm sure Cameron would want to figure out what's going on.</p>",
        "id": 526870877,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751486247
    },
    {
        "content": "<p>(\"Compiler\" as in the compiler that makes executable code, not the elaborator or kernel typechecking)</p>",
        "id": 526870930,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1751486279
    },
    {
        "content": "<p>Right, seeing it work for N and not for R was what made me guess the experiment of seeing what noncomputable would do to it in the first place</p>",
        "id": 526870987,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486303
    },
    {
        "content": "<p>More debugging:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Jacobian</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">Lebesgue</span><span class=\"bp\">.</span><span class=\"n\">Complex</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">SpecialFunctions</span><span class=\"bp\">.</span><span class=\"n\">Trigonometric</span><span class=\"bp\">.</span><span class=\"n\">Deriv</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"c1\">-- noncomputable -- uncomment this line to fix it</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fderivPolarCoordSymm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">toContinuousLinearMap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">toLin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Basis</span><span class=\"bp\">.</span><span class=\"n\">finTwoProd</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Basis</span><span class=\"bp\">.</span><span class=\"n\">finTwoProd</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">!!</span><span class=\"o\">[</span><span class=\"n\">cos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">sin</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">sin</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">cos</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">])</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">realmat1</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">!!</span><span class=\"o\">[(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">toLin'</span>\n</code></pre></div>",
        "id": 526871112,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486367
    },
    {
        "content": "<p>From reading this error message, I'm 99% sure it's the issue fixed by <a href=\"https://github.com/leanprover/lean4/pull/8691\">lean4#8691</a>, which will be going into an upcoming 4.22rc3. I'll rebuild it with my 4.22 branch to double check.</p>",
        "id": 526871134,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751486376
    },
    {
        "content": "<p>Nice, then I'm happy to stop worrying about it for now</p>",
        "id": 526871198,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486407
    },
    {
        "content": "<p>Thanks for the debugging effort</p>",
        "id": 526871217,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486416
    },
    {
        "content": "<p>In the meantime, if you use <code>Rat</code> instead of <code>ℝ</code> then your function will be _usefully_ computable!</p>",
        "id": 526871249,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486430
    },
    {
        "content": "<p>ah, it would be nice if I could use rationals, but I'm trying to match a definition in the literature that refers to reals :)</p>",
        "id": 526871389,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486506
    },
    {
        "content": "<p>You could define the function over any field</p>",
        "id": 526871607,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486601
    },
    {
        "content": "<p>(I guess if your matrix has square roots or trigonometry then you can't)</p>",
        "id": 526871667,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486639
    },
    {
        "content": "<p>Ah, actually in fact I think wanting to use <code>EuclideanGeometry.orthogonalProjection</code> which is tied to affine spaces over real inner product spaces may be what's tying me to R also...</p>",
        "id": 526871894,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486749
    },
    {
        "content": "<p>anyway, the brainstorming is appreciated, but I'm not too worried, R is fine, marking it temporarily as noncomputable is totally fine for my purposes :)</p>",
        "id": 526871947,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486770
    },
    {
        "content": "<p>I just wanted to know if that error message was a bug, and it sounds like it is, and that makes me content to know that</p>",
        "id": 526872050,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751486818
    },
    {
        "content": "<p>Thanks for the report!</p>",
        "id": 526872182,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751486877
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"662452\">Jason Reed</span> has marked this topic as resolved.</p>",
        "id": 526872210,
        "sender_full_name": "Notification Bot",
        "timestamp": 1751486896
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"656225\">Cameron Zwarich</span> <a href=\"#narrow/channel/113489-new-members/topic/.E2.9C.94.20'unknown.20constant'.20in.20absence.20of.20noncomputable.3F/near/526871134\">said</a>:</p>\n<blockquote>\n<p>From reading this error message, I'm 99% sure it's the issue fixed by <a href=\"https://github.com/leanprover/lean4/pull/8691\">lean4#8691</a>, which will be going into an upcoming 4.22rc3. I'll rebuild it with my 4.22 branch to double check.</p>\n</blockquote>\n<p>Indeed, this is fixed by the same change.</p>",
        "id": 526874549,
        "sender_full_name": "Cameron Zwarich",
        "timestamp": 1751488101
    },
    {
        "content": "<p>Thanks retroactively for the fix!</p>",
        "id": 526874623,
        "sender_full_name": "Jason Reed",
        "timestamp": 1751488135
    }
]