[
    {
        "content": "<p>Hello! I'm new to the Lean community. I spent almost whole forenoon time trying to understand some subtle behavior of <code>rw</code> tactic. Consider the following example code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">rp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">rq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span>\n<span class=\"kd\">axiom</span><span class=\"w\"> </span><span class=\"n\">fx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rp.mp</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rq.mp</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"o\">)</span>\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rq.mp</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rp.mp</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">test₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">fx</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">test.symm</span>\n</code></pre></div>\n<p>The <code>exact test.symm</code> reports an error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">test</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">184</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p>That may seem strange, because the metavariable <code>?m.184</code> can be unified with <code>g x</code>. So why the assignment step failed? I read the Lean source code trying to understand it. The <code>rw</code> tactic changes a hypothesis (<code>FVar</code>) called <code>test</code>, and because the original hypothesis can't be safely deleted, it was daggered (<code>test✝</code>). However, after <code>rw</code>, the FVar <code>test₂</code> was then became a new <code>FVar</code> with different <code>FVarId</code> but the same name (<code>test₂</code>), that may be the reason.<br>\nThe hole in <code>rw [fx _] at test</code> creates a new metavariable, say <code>?m.149</code> (thats the value in <a href=\"https://live.lean-lang.org\">https://live.lean-lang.org</a>). The expression <code>g x ...</code> contains the metavariable <code>?m.149</code>, and it will be assigned to <code>?m.184</code>. In function <code>processAssignment</code> of file <code>Lean.Meta.ExprDefEq</code>, it will call <code>checkAssignment</code> to check if an expression can be assigned to a metavariable, and if not it will try first-order unification (<code>processAssignmentFOApprox</code> and then <code>processConstApprox</code>).<br>\nIn <code>checkAssignment</code>, it will use <code>checkMVar</code> to check if a metavariable (like <code>?m.149</code>, we use <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> to denote it) is suitable for assignmented to another metavariable (like <code>?m.184</code>, use <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>q</mi></mrow><annotation encoding=\"application/x-tex\">q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span></span></span></span> to denote). If the context of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">p</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">p</span></span></span></span> is part of current context (to speak rigorously, \"part of\" means function <code>Lean.LocalContext.isSubPrefixOf</code>), the check would succeed. If <code>config.ctxApprox</code> is <code>true</code> and the current context is part of context of <code>p</code>, it also succeeds. However, it's not both the case: <code>?m.149</code> has context <code>test</code> and <code>test₂</code>, the current context is <code>test</code> (display with dagger), <code>test</code>(new, rewrited) and <code>test₂</code>. Note that two <code>test₂</code> have different <code>FVarId</code>, so neither context are part of each other.<br>\nThen it is easy to understand why the <code>exact test.symm</code> would succeed, if you remove <code>have test₂ : 0 = 0 := by rfl</code>, even these two tactics seems not relevant to each other.</p>",
        "id": 456107768,
        "sender_full_name": "Shuhao Song",
        "timestamp": 1722663107
    },
    {
        "content": "<p>Can we modify the implementation of <code>rw</code> to make this better?</p>",
        "id": 456237861,
        "sender_full_name": "Shuhao Song",
        "timestamp": 1722727399
    },
    {
        "content": "<p>I think this example might be worth filing as a bug report.</p>",
        "id": 456247207,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722732876
    },
    {
        "content": "<p><code>let n := 1</code> is also enough to trigger the issue, instead of <code>have test₂ : 0 = 0 := by rfl</code></p>",
        "id": 456248034,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722733072
    },
    {
        "content": "<p>Even more surprisingly, <code>have test2 := test</code> instead of <code>exact test.symm</code> still fails!</p>",
        "id": 456248611,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722733199
    },
    {
        "content": "<p>Yes because it modifies the local context. The difference of <code>have</code> and <code>let</code> is just <code>.cdecl</code> and <code>.ldecl</code> in <code>LocalDecl</code> type, so they don't difference a lot.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/113489-new-members/topic/A.20subtle.20detail.20about.20Lean.20.60rw.60.20tactic/near/456248034\">said</a>:</p>\n<blockquote>\n<p><code>let n := 1</code> is also enough to trigger the issue, instead of <code>have test₂ : 0 = 0 := by rfl</code></p>\n</blockquote>",
        "id": 456253422,
        "sender_full_name": "Shuhao Song",
        "timestamp": 1722736260
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/113489-new-members/topic/A.20subtle.20detail.20about.20Lean.20.60rw.60.20tactic/near/456247207\">said</a>:</p>\n<blockquote>\n<p>I think this example might be worth filing as a bug report.</p>\n</blockquote>\n<p>How can I submit a bug report?</p>",
        "id": 456253443,
        "sender_full_name": "Shuhao Song",
        "timestamp": 1722736300
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/113489-new-members/topic/A.20subtle.20detail.20about.20Lean.20.60rw.60.20tactic/near/456248611\">said</a>:</p>\n<blockquote>\n<p><code>have test2 := test</code></p>\n</blockquote>\n<p>Because it need to fill the metavariable of type of <code>test2</code>.</p>",
        "id": 456256122,
        "sender_full_name": "Shuhao Song",
        "timestamp": 1722737647
    },
    {
        "content": "<p><a href=\"http://github.com/leanprover/lean4/issues\">github.com/leanprover/lean4/issues</a></p>",
        "id": 456311207,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722772918
    }
]