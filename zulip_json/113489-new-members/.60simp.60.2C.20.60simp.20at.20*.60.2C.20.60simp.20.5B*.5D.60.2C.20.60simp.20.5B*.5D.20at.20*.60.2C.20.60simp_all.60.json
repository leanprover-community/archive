[
    {
        "content": "<p>I'm trying to understand why <code>simp</code> and <code>simp at *</code> fail to close this goal, while <code>simp [*]</code>, <code>simp [*] at *</code>, and <code>simp_all</code> do close this goal.</p>\n<p>Because the examples match the <code>@[simp]</code> tagged theorem exactly, I naïvely assumed they would all close this goal. Where did I go wrong in my thinking?</p>\n<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">tiny_theorem</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FiniteField</span><span class=\"bp\">.</span><span class=\"n\">pow_card_sub_one_eq_one</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n<span class=\"w\">  </span><span class=\"n\">rwa</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"c1\">-- does not close the goal: \"simp made no progress\"</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n<span class=\"c1\">-- does not close the goal: \"unsolved goals\"</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n\n<span class=\"c1\">-- closes the goal (as expected)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">*</span><span class=\"o\">]</span>\n<span class=\"c1\">-- closes the goal (as expected)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">*</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"c1\">-- closes the goal (as expected)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_all</span>\n</code></pre></div>",
        "id": 506561437,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1742325528
    },
    {
        "content": "<p><code>simp at *</code> means \"simplify everywhere\".<br>\n<code>simp [*]</code> means \"simplify using everything\".<br>\n<code>simp [*] at *</code> means \"simplify everywhereusing everything\".<br>\n<code>simp_all</code> means \"recursively simplify everywhere using everything\".</p>",
        "id": 506561684,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1742325625
    },
    {
        "content": "<p>You need to be \"using everything\" to have access to <code>ha : a ≠ 0</code>.</p>",
        "id": 506562018,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1742325758
    },
    {
        "content": "<p><code>simp</code> without arguments can definitely not close this goal, because it does not include hypotheses unless you pass them in like <code>simp [ha]</code> or <code>simp [*]</code></p>",
        "id": 506562027,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742325762
    },
    {
        "content": "<p>it does apply your theorem but it gets stuck proving the side goal and so decides against the conditional rewrite</p>",
        "id": 506562095,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742325798
    },
    {
        "content": "<p>if the goal was <code>a ≠ 0 -&gt; a ^ (p - 1) = 1</code> instead I think <code>simp</code> would prove it, or possibly <code>simp +contextual</code></p>",
        "id": 506562242,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742325849
    },
    {
        "content": "<p>Ah, I think I see now. So <code>simp</code> effectively means “simplify as though there are no hypotheses.” This might be a naive question (apologies in advance!), but isn’t the most common scenario one where we want to include the hypotheses as well? I understand there are likely good reasons behind the current design, but I’m curious why that isn’t the default behavior when no parameters are specified (<code>simp</code>).</p>",
        "id": 506563433,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1742326286
    },
    {
        "content": "<p>This won't work well. Multiple hypotheses can apply at a given point, it's unclear which order and which direction they should be applied in, and if you are trying to demonstrate a contradiction and have inconsistent hypotheses, <code>simp [*]</code> can easily give you the wrong result</p>",
        "id": 506575242,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742330000
    },
    {
        "content": "<p>simp lemmas from the hypotheses can also cause simp to become nonconfluent or loop</p>",
        "id": 506575422,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742330071
    },
    {
        "content": "<p>also if you are not careful, simp can end up simplifying a hypothesis with itself, reducing it to true and effectively deleting it from your proof state</p>",
        "id": 506575573,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742330130
    },
    {
        "content": "<p>the aforementioned simp variants all have to do something to work around this. For example <code>simp [*] at *</code> doesn't <em>actually</em> mean simp all the hypotheses with all of the hypotheses, it means simp the hypotheses with all of the <em>other</em> hypotheses</p>",
        "id": 506575723,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742330179
    },
    {
        "content": "<p>but in the larger scale context of a proof, this kind of self-detection becomes brittle and unreliable</p>",
        "id": 506575860,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742330253
    },
    {
        "content": "<p>Thank you for explaining how these variants work—I hadn’t realized there was so much nuance involved.</p>\n<p>What is the best resource on <code>simp</code> for end-users? I came across the “Using the Simplifier” guide (linked from <a href=\"https://www.ma.imperial.ac.uk/~buzzard/xena/formalising-mathematics-2024/Part_C/tactics/simp.html\">Formalizing Mathematics 2024</a>), which looks promising, but it doesn’t seem fully up to date for Lean 4.</p>",
        "id": 506594281,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1742337769
    },
    {
        "content": "<p>What's not up to date in that link?</p>",
        "id": 506595008,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742338102
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> Your guide is indeed up to date and an excellent resource! However, the linked document at <a href=\"https://leanprover.github.io/theorem_proving_in_lean/tactics.html#using-the-simplifier\">https://leanprover.github.io/theorem_proving_in_lean/tactics.html#using-the-simplifier</a> is from \"Theorem Proving in Lean 3 (outdated)\" (see document title).</p>",
        "id": 506595763,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1742338465
    },
    {
        "content": "<p>Aha, thanks! Then I recommend looking at the analogous section in Theorem Proving In Lean 4 :-)</p>",
        "id": 506595881,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742338527
    },
    {
        "content": "<p>There should presumably be a 2025 version of that document for the course which is running currently</p>",
        "id": 506596004,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742338579
    },
    {
        "content": "<p>I searched for <code>Lean TPIL \"Using the Simplifier\"</code> on Google before asking, but strangely, only TPIL 3 showed up. However, after some extra searching (without using Google) following your last message, I found the corresponding section in TPIL 4: <a href=\"https://lean-lang.org/theorem_proving_in_lean4/tactics.html#using-the-simplifier\">https://lean-lang.org/theorem_proving_in_lean4/tactics.html#using-the-simplifier</a></p>",
        "id": 506596860,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1742338937
    },
    {
        "content": "<p>I updated the link locally but unfortunately due to changes in security procedures at Imperial I have no idea how deploy the fix. But more importantly I added a warning to the README for the 2024 course, directing people to the 2025 course notes and repo; the course notes are <a href=\"https://b-mehta.github.io/formalising-mathematics-notes/\">here</a>. The link in the <code>simp</code> documentation still goes to the Lean 3 version of TPIL though; I'll let Bhavik know.</p>",
        "id": 506599848,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742340354
    }
]