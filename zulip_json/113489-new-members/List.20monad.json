[
    {
        "content": "<p>Hi all. I'm trying out this language again (tried it out for a bit 6 months ago maybe), and it seems very cool and powerful, but there are points of confusion for me. Could someone please clarify whether the List monad is a thing in Lean4? I was surprised the following code didn't work.</p>\n<p>I appreciate it.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addLists</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ys</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ys</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 508920244,
        "sender_full_name": "misterdrgn",
        "timestamp": 1743253101
    },
    {
        "content": "<p>return x + y doesnâ€™t work?</p>",
        "id": 508920672,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1743253455
    },
    {
        "content": "<p>You have to import the list monad first</p>",
        "id": 508921681,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743254291
    },
    {
        "content": "<p>It lives in <a href=\"https://tqft.net/mathlib4files/Data/List/Monad\">file#Data/List/Monad</a></p>",
        "id": 508921694,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743254308
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> Ah ok, that's what I needed. Thanks.</p>",
        "id": 508922247,
        "sender_full_name": "misterdrgn",
        "timestamp": 1743254750
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> Actually I have a follow-up question, if you don't mind and you have some experience with monads in Lean. After following your suggestion, the following works for me.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>However, the following does not work.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">[(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">1</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I would _guess_ (I could test it) that that would work in Haskell, and would produce a list where the (x,y) pairs alternate with (1,1). However, I might simply be confused. The reason I think this should work is that in the IO monad, when writing a do statement, you can have lines like <code>stdout.putStrLn ...</code> that don't involve the bind operator--they simply add another line to the IO monad. I'm assuming these lines are combined with mplus from the MonadPlus or Monoid type class. In Lean, maybe this doesn't work because List isn't made an instance of MonadPlus?</p>\n<p>Or maybe I'm totally confused.</p>",
        "id": 508976119,
        "sender_full_name": "misterdrgn",
        "timestamp": 1743297993
    },
    {
        "content": "<p>Maybe it will work if you write <code>discard [(1, 1)]</code>.</p>",
        "id": 508977188,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743298719
    },
    {
        "content": "<p><a href=\"https://play.haskell.org/saved/6DzZEYhY\">https://play.haskell.org/saved/6DzZEYhY</a></p>",
        "id": 508977343,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1743298840
    },
    {
        "content": "<p>in Haskell it just ignores the <code>(1, 1)</code></p>",
        "id": 508977668,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1743299070
    },
    {
        "content": "<p>Isn't a line without <code>&lt;-</code> roughly equivalent to one with <code>_ &lt;-</code>, i.e. discarding the bound variable, and the IO monad can be thought of as a state monad (where printing modifies the state) whereas the list monad has no state?</p>",
        "id": 508977683,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1743299095
    },
    {
        "content": "<p>Thus you could write, for example, <code>[0, 0, 0]</code> in a line on its own to repeat each item in the resulting list three times, but if you don't bind it, the values in the list are just ignored.</p>",
        "id": 508977821,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1743299182
    },
    {
        "content": "<p><a href=\"https://play.haskell.org/saved/UMU6jszb\">https://play.haskell.org/saved/UMU6jszb</a></p>",
        "id": 508977902,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1743299240
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"421885\">Joscha Mennicken</span> <a href=\"#narrow/channel/113489-new-members/topic/List.20monad/near/508977683\">said</a>:</p>\n<blockquote>\n<p>Isn't a line without <code>&lt;-</code> roughly equivalent to one with <code>_ &lt;-</code>, i.e. discarding the bound variable, and the IO monad can be thought of as a state monad (where printing modifies the state) whereas the list monad has no state?</p>\n</blockquote>\n<p>no, it's more like <code>let () &lt;-</code></p>",
        "id": 508978210,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743299449
    },
    {
        "content": "<p>so it discards but it also enforces the type of the discarded thing is unit</p>",
        "id": 508978228,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743299466
    },
    {
        "content": "<p>But if you did <code>_ &lt;- [(1,1)]</code> it wouldn't put <code>(1,1)</code> in the result because it isn't used subsequently. You would need the MonadPlus operation, not bind, to do this</p>",
        "id": 508978370,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743299565
    },
    {
        "content": "<p>I think the lean spelling for that operation is <code>&lt;|&gt;</code></p>",
        "id": 508978387,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743299583
    },
    {
        "content": "<p>I think there's still a question here of why the code resulted in an error in Lean, even if it wouldn't have accomplished what misterdrgn wanted</p>",
        "id": 508978506,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1743299675
    },
    {
        "content": "<p>but yeah, the result makes total sense when you consider that List bind is just <code>flatMap</code></p>",
        "id": 508978635,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1743299779
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113489-new-members/topic/List.20monad/near/508978210\">said</a>:</p>\n<blockquote>\n<p>no, it's more like <code>let () &lt;-</code></p>\n</blockquote>\n<p>The error is that the list elements must be units but are instead tuples, unlike Haskell, where the list elements are just ignored no matter their type.</p>",
        "id": 508978765,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1743299889
    },
    {
        "content": "<p>ah ha</p>",
        "id": 508978793,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1743299919
    },
    {
        "content": "<p>For completeness, the <a href=\"https://lean-lang.org/doc/reference/latest//Functors___-Monads-and--do--Notation/Syntax/#do-notation\">lean language reference</a> says this:</p>\n<blockquote>\n<p>A term followed by a sequence of items is translated to a use of <code>bind</code>; in particular, <code>do e1; es</code> is translated to <code>e1 &gt;&gt;= fun () =&gt; do es</code>.</p>\n</blockquote>",
        "id": 508979167,
        "sender_full_name": "Joscha Mennicken",
        "timestamp": 1743300240
    },
    {
        "content": "<p>Thanks everyone and especially <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>. I understand things somewhat better now. The issue with my broken code wasn't that I left out the <code>let something &lt;-</code>. In fact, the following works.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Here, <code>[6,7,8]</code> becomes <code>let () &lt;- [6,7,8]</code>, which means that those numbers are discarded, but the results are repeated three times, once for each item in that list.</p>\n<p>So if that works, why does <code>[(1,1)]</code> fail? I guess I'm still not 100% clear on this...</p>",
        "id": 508980275,
        "sender_full_name": "misterdrgn",
        "timestamp": 1743301173
    },
    {
        "content": "<p>warning (I got caught by this too): I'm willing to bet that your <code>[6,7,8]</code> is a <code>List Unit</code> and <code>6,7,8</code> are all just funny ways of writing <code>()</code></p>",
        "id": 508980394,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301242
    },
    {
        "content": "<p>because <code>Unit</code> is a ring</p>",
        "id": 508980435,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301289
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/113489-new-members/topic/List.20monad/near/508980394\">said</a>:</p>\n<blockquote>\n<p>warning (I got caught by this too): I'm willing to bet that your <code>[6,7,8]</code> is a <code>List Unit</code> and <code>6,7,8</code> are all just funny ways of writing <code>()</code></p>\n</blockquote>\n<p>I just checked, and it says it's a <code>List PUnit.{1}</code>. This is some Lean black magic that's beyond my current understanding.</p>",
        "id": 508980519,
        "sender_full_name": "misterdrgn",
        "timestamp": 1743301351
    },
    {
        "content": "<p><code>PUnit.{1}</code> is <code>Unit</code></p>",
        "id": 508980530,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301364
    },
    {
        "content": "<p>numerals like <code>6</code> are interpreted into any type that \"has numbers\", with a fallback default of <code>Nat</code></p>",
        "id": 508980571,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301411
    },
    {
        "content": "<p>Okay, so it's managing to coerce Nat to Unit?</p>",
        "id": 508980572,
        "sender_full_name": "misterdrgn",
        "timestamp": 1743301412
    },
    {
        "content": "<p>not exactly</p>",
        "id": 508980582,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301424
    },
    {
        "content": "<p>it's interpreting <code>6</code> directly as an element of <code>Unit</code></p>",
        "id": 508980592,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301440
    },
    {
        "content": "<p>by searching for an instance of <code>OfNat Unit 6</code></p>",
        "id": 508980669,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301479
    },
    {
        "content": "<p>but yeah that mostly amounts to an embedding of <code>Nat</code> in <code>Unit</code></p>",
        "id": 508980692,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301508
    },
    {
        "content": "<p>in this case it exists because there is an embedding from <code>Nat</code> to any semiring and <code>Unit</code> is a semiring</p>",
        "id": 508980716,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743301539
    },
    {
        "content": "<p>Yeah, I see that I can do <code>#eval (6: Unit)</code></p>\n<p>Well thank you, this has certainly been eye-opening.</p>",
        "id": 508980719,
        "sender_full_name": "misterdrgn",
        "timestamp": 1743301549
    }
]