[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">expose</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimpleGraph</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">bar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n</code></pre></div>\n<p>The goal state at the start of the theorem is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"n\">h₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Adding <code>public</code> before the import fixes it, but surely there should be errors everywhere, and the file shouldn't just build?</p>",
        "id": 569146824,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768952882
    },
    {
        "content": "<p>Here's a compiling proof of the Riemann hypothesis with no <code>sorry</code> in the source (although it does mark it as <code>declaration uses 'sorry'</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">LSeries</span><span class=\"bp\">.</span><span class=\"n\">RiemannZeta</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">expose</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimpleGraph</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">bar</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RiemannHypothesis</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h₁</span>\n</code></pre></div>",
        "id": 569146852,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768952897
    },
    {
        "content": "<p>I wonder if it's possible to even avoid the warning</p>",
        "id": 569147194,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768953135
    },
    {
        "content": "<p>that's weird, I would've expected \"unknown identifier\"</p>",
        "id": 569148896,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768954215
    },
    {
        "content": "<p>the hover information for <code>G.foo</code> and <code>G.bar</code> is also missing</p>",
        "id": 569148919,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768954239
    },
    {
        "content": "<p>maybe it's because <code>G</code> has been extracted to a <code>variable</code>?</p>",
        "id": 569148944,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768954258
    },
    {
        "content": "<p>I expect this error on the <code>variable</code> command:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"w\"> </span><span class=\"ss\">`SimpleGraph</span><span class=\"bp\">`</span>\n\n<span class=\"n\">Note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">public</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"ss\">`SimpleGraph</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">imported</span><span class=\"w\"> </span><span class=\"n\">privately</span><span class=\"bp\">;</span>\n<span class=\"n\">consider</span><span class=\"w\"> </span><span class=\"n\">adding</span><span class=\"w\"> </span><span class=\"ss\">`public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"bp\">`.</span>\n</code></pre></div>",
        "id": 569149241,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768954448
    },
    {
        "content": "<p>but that's only because you're using the <code>variable</code> in a public theorem</p>",
        "id": 569149338,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768954517
    },
    {
        "content": "<p>AFAICT this is a bug with the <code>variable</code> command. I can use private declarations in it, then they get turned to <code>sorry</code> so the theorem can access any fake property of <code>G</code></p>",
        "id": 569149358,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768954535
    },
    {
        "content": "<p>if <code>theorem foo</code> were instead <code>private theorem foo</code> then you should expect no error on the <code>variable</code> I think</p>",
        "id": 569149364,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768954541
    },
    {
        "content": "<p>Hmm, even with a private foo the <code>variable</code> command creates <code>G : sorry</code></p>",
        "id": 569149441,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768954591
    },
    {
        "content": "<p>hmm, replacing it with <code>private theorem foo</code> doesn't make a difference</p>",
        "id": 569149444,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768954595
    },
    {
        "content": "<p>the <code>public section</code> seems to negate the <code>private</code> modifier, though it shouldn't</p>",
        "id": 569149760,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768954817
    },
    {
        "content": "<p>the <code>sorry</code>s in the goal state still have source information on them</p>",
        "id": 569149927,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768954952
    },
    {
        "content": "<p>Technically a proof of RH with no warnings:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">LSeries</span><span class=\"bp\">.</span><span class=\"n\">RiemannZeta</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimpleGraph</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">RH</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">RiemannHypothesis</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">RH</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">‹_›</span>\n</code></pre></div>",
        "id": 569149940,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768954959
    },
    {
        "content": "<p>oh it eats <em>all</em> the errors</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">LSeries</span><span class=\"bp\">.</span><span class=\"n\">RiemannZeta</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimpleGraph</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">RH</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">RiemannHypothesis</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"bp\">.</span><span class=\"n\">RH</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">‹_›</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: [Error pretty printing signature: incorrect number of universe levels foo]</span>\n<span class=\"sd\">foo</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>",
        "id": 569150068,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768955067
    },
    {
        "content": "<p>I wonder what Comparator or lean4checker would make of this</p>",
        "id": 569150292,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768955291
    },
    {
        "content": "<p>Perhaps they'd complain that the conclusion of <code>foo</code> is of type <code>sorry</code></p>",
        "id": 569150326,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768955321
    },
    {
        "content": "<p>I sneaked a <code>SimpleGraph</code> into the public scope even though it's only imported privated</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"c1\">-- public section</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimpleGraph</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">}</span>\n\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">G</span>\n<span class=\"w\">  </span><span class=\"n\">h₁</span>\n\n<span class=\"sd\">/-- info: foo.{u_1} {V : Type u_1} {G : SimpleGraph V} (h₁ h₂ : ℕ) : ℕ -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>",
        "id": 569150332,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768955324
    },
    {
        "content": "<p>Mmh, indeed it's a problem that <code>variable</code>s are checked only once for errors (in the private scope) and then assumed to be well-formed in any subsequent declaration. I think the principled solution would be to add support for <code>public variable</code>, and deny use of private <code>variable</code>s in public declarations.</p>",
        "id": 569213169,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1768989775
    },
    {
        "content": "<p>This is <a href=\"https://github.com/leanprover/lean4/pull/10760\">lean4#10760</a></p>",
        "id": 573775765,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1770998141
    },
    {
        "content": "<p>I discovered some examples where this actually goes wrong in mathlib, thanks to <a href=\"https://github.com/leanprover-community/batteries/pull/1688\">batteries#1688</a>.</p>\n<p>The <code>variable</code> command can contain a <code>by</code>-block that produces a proof that becomes a private auxiliary theorem. For example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.FormalCoproduct.pullbackCone#doc\">docs#CategoryTheory.Limits.FormalCoproduct.pullbackCone</a> contains a private proof inside one of its parameters. When importing this into another module and inspecting the type, we get an unknown constant error.</p>",
        "id": 575101431,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771694214
    }
]