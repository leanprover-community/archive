[
    {
        "content": "<p>I've got a type that contains type indices <code>n : Nat</code> and a <code>Fin n</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Ctx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ctx</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ctx</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tip</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ctx</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">HasType</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Ctx</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasType</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ctx</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">Ctx</span><span class=\"bp\">.</span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"c1\">-- &lt;-- 3 works here?</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">pop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasType</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">fin</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">HasType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">fin</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ctx</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">otherTy</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n</code></pre></div>\n<p>In the <code>stop</code> constructor it looks like lean has no problem with me setting the <code>Fin n</code> to a value of 3, even though obviously <code>3 &lt; 1</code> is false.</p>\n<p>This also works when I do <code>⟨ 3, _ ⟩</code>. Although when I do <code>⟨ 3, by sorry ⟩</code> it clearly shows that the goal is <code>3 &lt; 1</code>. So why does this work? Is this a bug?</p>",
        "id": 521448102,
        "sender_full_name": "aron",
        "timestamp": 1748702426
    },
    {
        "content": "<p>It wraps around.</p>",
        "id": 521448567,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748702765
    },
    {
        "content": "<p>Sorry what does that mean?</p>",
        "id": 521448679,
        "sender_full_name": "aron",
        "timestamp": 1748702867
    },
    {
        "content": "<p>It comes from this: <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Fin/Basic.html#Fin.ofNat'\">Fin.ofNat'</a>. It uses <code>3 % n</code>.</p>",
        "id": 521448815,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1748702966
    },
    {
        "content": "<p><code>3 : Fin 1</code> means <code>⟨3 % 1, (some_proof : 3 % 1 &lt; 1)⟩ : Fin 1</code></p>",
        "id": 521448819,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1748702969
    },
    {
        "content": "<p>In particular, <code>(3 : Fin 1) = (0 : Fin 1)</code></p>",
        "id": 521448831,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1748702984
    },
    {
        "content": "<p>oh. that seems.. unexpected.</p>",
        "id": 521448843,
        "sender_full_name": "aron",
        "timestamp": 1748702999
    },
    {
        "content": "<p><span aria-label=\"neutral\" class=\"emoji emoji-1f610\" role=\"img\" title=\"neutral\">:neutral:</span></p>",
        "id": 521448897,
        "sender_full_name": "aron",
        "timestamp": 1748703014
    },
    {
        "content": "<p>Well it's because <code>Fin n</code> is meant to model a modular ring with addition, subtraction and multiplication and in particular it is also the basis for <code>UInt8</code> etc. which have similar behavior.</p>",
        "id": 521449317,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1748703345
    },
    {
        "content": "<p><span aria-label=\"neutral\" class=\"emoji emoji-1f610\" role=\"img\" title=\"neutral\">:neutral:</span><br>\n<span aria-label=\"expressionless\" class=\"emoji emoji-1f611\" role=\"img\" title=\"expressionless\">:expressionless:</span><br>\n<span aria-label=\"neutral\" class=\"emoji emoji-1f610\" role=\"img\" title=\"neutral\">:neutral:</span></p>",
        "id": 521449412,
        "sender_full_name": "aron",
        "timestamp": 1748703405
    },
    {
        "content": "<p>Someone should be making a list of everyone who is caught out by this clearly unexpected behaviour</p>",
        "id": 521489230,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748738643
    },
    {
        "content": "<p>I thought <code>ZMod</code> was meant to model a modular ring... maybe <code>Fin</code> should be more strict while <code>ZMod</code> continues with the existing behavior</p>",
        "id": 521492614,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1748742199
    },
    {
        "content": "<p>This <code>OfNat</code> is in core, as are the arithmetic instances. I don't think they're changing. Moreover, I've never seen another suggestion for behavior that makes more sense / is better.</p>\n<p>If you want a <code>Fin</code> with different arithmetic, create a type synonym.</p>",
        "id": 521497715,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1748745852
    },
    {
        "content": "<p>Here's a concrete suggestion: If you want to verify that index <code>i : ℕ</code> isn't out of bounds, do <code>⟨i, some_proof⟩ : Fin n</code>, rather than <code>i : Fin n</code>.</p>",
        "id": 521512403,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1748755990
    },
    {
        "content": "<p>For anyone coming here from the future, the <code>ℕ → Fin n</code> coercion was removed from Lean core in <a href=\"https://github.com/leanprover/lean4/pull/8620\">lean#8620</a>, and in mathlib <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.instCommRing#doc\">docs#Fin.instCommRing</a> isn't an instance either anymore.</p>",
        "id": 528124409,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1752166391
    }
]