[
    {
        "content": "<p>I've been advised a few times that 1-line calc sections are not good.</p>\n<p>Is it possible to explain why?</p>\n<p>I vaguely recall something about \"it messes up the parsing\" but that doesn't seem plausible, given my albeit limited understanding of how languages work.</p>",
        "id": 495899224,
        "sender_full_name": "rzeta0",
        "timestamp": 1737834035
    },
    {
        "content": "<p>i don't exactly understand why either... but empirically, it is true.</p>",
        "id": 495899785,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1737834511
    },
    {
        "content": "<p>take for example one of the codesnippets <a href=\"#narrow/channel/113489-new-members/topic/error.20in.20thinking.20-.3E.20unexpected.20token.20'calc'.3B.20expected.20'.3A.3D'/near/465732011\">you sent</a></p>",
        "id": 495899813,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1737834552
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"724904\">rzeta0</span> <a href=\"#narrow/channel/113489-new-members/topic/error.20in.20thinking.20-.3E.20unexpected.20token.20'calc'.3B.20expected.20'.3A.3D'/near/465732011\">said</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hx</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eq_zero_or_eq_zero_of_mul_eq_zero</span><span class=\"w\"> </span><span class=\"n\">h1</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">hb</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n<span class=\"w\">  </span><span class=\"n\">left</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">addarith</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ha</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">right</span><span class=\"w\">  </span><span class=\"c1\">-- &lt;- error here \"unexpected token 'calc'; expected ':='Lean 4\"</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span><span class=\"w\"> </span><span class=\"c1\">-- &lt;-- error here \"unexpected token 'calc'; expected ':='Lean 4\"</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">addarith</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ha</span><span class=\"o\">]</span>\n</code></pre></div>\n</blockquote>",
        "id": 495899902,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737834617
    },
    {
        "content": "<p>These errors illustrate the fact that <code>calc</code> was not designed for one-line computations I think. The purpose of <code>calc</code> is to be able to decompose a computation between different steps in a paper-like way. It allows you to state each step clearly, while doing it without stating the steps might be harder (it is always easier to prove something in Lean when you told it what you want to prove beforehand, because it might be impossible to infer some data and this forces you to specify some arguments which might have been unnecessary otherwise). In the case of a one line though, the goal is already stated, so there is nothing to be gained with a one-line <code>calc</code> IMO.</p>",
        "id": 495900536,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1737835237
    },
    {
        "content": "<p>if you search public zulip channels for <code>calc error</code>, you will find that the parsing aspect is something that has been run into on multiple occasions.</p>",
        "id": 495900802,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1737835465
    },
    {
        "content": "<p>I don't think this syntax should be valid.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 495903634,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737837874
    },
    {
        "content": "<p>Since you can do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>when you have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">someTactic</span>\n</code></pre></div>\n<p>the <code>someTactic</code> gets parsed as a <code>calc</code> line, and then fails when there is no accompanying <code>:=</code>.<br>\nThis is the source of all the errors coming from one-line <code>calc</code> blocks.</p>",
        "id": 495903821,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737838054
    },
    {
        "content": "<p>A 1-line calc is completely pointless, isn't it? <code>calc x = y := by tactic</code> is just the same as writing <code>tactic</code>, right?</p>",
        "id": 495903883,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1737838088
    },
    {
        "content": "<p>yes</p>",
        "id": 495903893,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737838099
    },
    {
        "content": "<p>The problem is that <code>calc</code> supports indenting the first line freely, and then all the other lines must be lined up.</p>",
        "id": 495904237,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737838397
    },
    {
        "content": "<p>The underlying issue is that <code>calc</code> supports not having a <code>:=</code> for the first line:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">        </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>This might be something you're looking for <span class=\"user-mention\" data-user-id=\"724904\">@rzeta0</span>, a way to do one-line calcs. You do it over two lines like so.</p>",
        "id": 495905742,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737839584
    },
    {
        "content": "<p>Or you could use <code>exact show</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 495905776,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737839614
    },
    {
        "content": "<p>It might be possible to add a <code>withPosition</code> and some <code>colGt</code>s to the syntax definition for <code>calc</code> help with the one-line calc problem.</p>",
        "id": 495905874,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737839702
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/113489-new-members/topic/why.20exactly.20are.201-line.20calc.20sections.20bad.3F/near/495903883\">said</a>:</p>\n<blockquote>\n<p>A 1-line calc is completely pointless, isn't it? <code>calc x = y := by tactic</code> is just the same as writing <code>tactic</code>, right?</p>\n</blockquote>\n<p>Only if <code>y</code> is defeq to the RHS (and actually if <code>x = y</code> is synteq to the goal). Otherwise it's more like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">transitivity</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">tactic</span>\n</code></pre></div>",
        "id": 495908862,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1737842637
    },
    {
        "content": "<p>Thanks for the continuing replies - very insightful.</p>\n<p>To be clear, I don't want to do 1-line calcs, I wanted to understand better what they actually are (they're different from the other structures like <code>have</code> and <code>induction</code> ) .. and when I asked the original question weeks ago I hadn't learned to just apply a tactic.</p>",
        "id": 495909538,
        "sender_full_name": "rzeta0",
        "timestamp": 1737843281
    },
    {
        "content": "<p>Just a naive suggestion - perhaps <code>calc</code> could have a more rigorous syntax to avoid the syntax errors? something like <code>begincalc</code> and <code>endcalc</code> or <code>[ .. ]</code> .. that sort of thing?</p>",
        "id": 495909575,
        "sender_full_name": "rzeta0",
        "timestamp": 1737843337
    },
    {
        "content": "<p><code>calc a = b := by tac</code> is (pretty much) the same as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"n\">tac</span>\n</code></pre></div>\n<p>or <code>exact show a = b by tac</code> as a one-liner.</p>\n<p>It ensures the goal is <code>a = b</code>, and then it runs the tactic.</p>\n<p>If you know the goal is <code>a = b</code>, then there is no need for it, you just do <code>tac</code>.</p>",
        "id": 495913252,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1737847008
    },
    {
        "content": "<p>I think the syntax should be \"an optional first line without a <code>:=</code>, followed by one or more indentation-aligned lines with <code>:=</code>\", instead of what it is now, which is \"a first line that optionally has a <code>:=</code>, followed by zero or more indentation aligned lines with <code>:=</code>\". In addition to solving the problems with 1-line calc, this also makes the zero-line calc invalid:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">calc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- this elaborates as `rfl`</span>\n</code></pre></div>",
        "id": 496035732,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737953141
    }
]