[
    {
        "content": "<p>Hi, im wondering on what is the most elegant way to match on a finset. what i try:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"s2\">\"a\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"o\">}:</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"s2\">\"a\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"s2\">\"b\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">--maybe solve by contradiction somehow?</span>\n</code></pre></div>\n<p>can Lean figure out the dead branch here itself? What i rather would write is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"s2\">\"a\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"o\">}:</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>",
        "id": 509409950,
        "sender_full_name": "Simon Daniel",
        "timestamp": 1743501874
    },
    {
        "content": "<p>Note it works fine for integers:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">}:</span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">12</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>\n<p>I think the problem is that string decidable equality is not reducible</p>",
        "id": 509432925,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743509032
    },
    {
        "content": "<p>It's not running any decidable equality procedure, but using dependent elimination to eliminate the remaining cases</p>",
        "id": 509434429,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743509488
    },
    {
        "content": "<p>I think the problem is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.isValidChar#doc\">docs#Nat.isValidChar</a>, which has these huge numbers in it.</p>",
        "id": 509437390,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743510333
    },
    {
        "content": "<p>This works, but it takes a while</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"bp\">'</span><span class=\"n\">a'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">b'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">ofBitVec</span><span class=\"w\"> </span><span class=\"mi\">97</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">ofBitVec</span><span class=\"w\"> </span><span class=\"mi\">98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>",
        "id": 509439783,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743510992
    },
    {
        "content": "<p>It's also very bloated</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">[result]</span>\n<span class=\"cm\">def f (x_1 : u32) : obj :=</span>\n<span class=\"cm\">  let x_2 : obj := UInt32.toNat x_1;</span>\n<span class=\"cm\">  let x_3 : obj := 0;</span>\n<span class=\"cm\">  let x_4 : obj := 1;</span>\n<span class=\"cm\">  let x_5 : obj := Nat.sub x_2 x_4;</span>\n<span class=\"cm\">  dec x_2;</span>\n<span class=\"cm\">  let x_6 : obj := Nat.sub x_5 x_4;</span>\n<span class=\"cm\">  dec x_5;</span>\n<span class=\"cm\">  let x_7 : obj := Nat.sub x_6 x_4;</span>\n<span class=\"cm\">  dec x_6;</span>\n<span class=\"cm\">  let x_8 : obj := Nat.sub x_7 x_4;</span>\n<span class=\"cm\">  dec x_7;</span>\n<span class=\"cm\">  let x_9 : obj := Nat.sub x_8 x_4;</span>\n<span class=\"cm\">  dec x_8;</span>\n<span class=\"cm\">  let x_10 : obj := Nat.sub x_9 x_4;</span>\n<span class=\"cm\">  dec x_9;</span>\n<span class=\"cm\">  let x_11 : obj := Nat.sub x_10 x_4;</span>\n<span class=\"cm\">  dec x_10;</span>\n<span class=\"cm\">  let x_12 : obj := Nat.sub x_11 x_4;</span>\n<span class=\"cm\">  dec x_11;</span>\n<span class=\"cm\">  let x_13 : obj := Nat.sub x_12 x_4;</span>\n<span class=\"cm\">  dec x_12;</span>\n<span class=\"cm\">  let x_14 : obj := Nat.sub x_13 x_4;</span>\n<span class=\"cm\">  dec x_13;</span>\n<span class=\"cm\">  let x_15 : obj := Nat.sub x_14 x_4;</span>\n<span class=\"cm\">  dec x_14;</span>\n<span class=\"cm\">  let x_16 : obj := Nat.sub x_15 x_4;</span>\n<span class=\"cm\">  dec x_15;</span>\n<span class=\"cm\">  let x_17 : obj := Nat.sub x_16 x_4;</span>\n<span class=\"cm\">  dec x_16;</span>\n<span class=\"cm\">  let x_18 : obj := Nat.sub x_17 x_4;</span>\n<span class=\"cm\">  dec x_17;</span>\n<span class=\"cm\">  let x_19 : obj := Nat.sub x_18 x_4;</span>\n<span class=\"cm\">  dec x_18;</span>\n<span class=\"cm\">  let x_20 : obj := Nat.sub x_19 x_4;</span>\n<span class=\"cm\">  dec x_19;</span>\n<span class=\"cm\">  let x_21 : obj := Nat.sub x_20 x_4;</span>\n<span class=\"cm\">  dec x_20;</span>\n<span class=\"cm\">  let x_22 : obj := Nat.sub x_21 x_4;</span>\n<span class=\"cm\">  dec x_21;</span>\n<span class=\"cm\">  let x_23 : obj := Nat.sub x_22 x_4;</span>\n<span class=\"cm\">  dec x_22;</span>\n<span class=\"cm\">  let x_24 : obj := Nat.sub x_23 x_4;</span>\n<span class=\"cm\">  dec x_23;</span>\n<span class=\"cm\">  let x_25 : obj := Nat.sub x_24 x_4;</span>\n<span class=\"cm\">  dec x_24;</span>\n<span class=\"cm\">  let x_26 : obj := Nat.sub x_25 x_4;</span>\n<span class=\"cm\">  dec x_25;</span>\n<span class=\"cm\">  let x_27 : obj := Nat.sub x_26 x_4;</span>\n<span class=\"cm\">  dec x_26;</span>\n<span class=\"cm\">  let x_28 : obj := Nat.sub x_27 x_4;</span>\n<span class=\"cm\">  dec x_27;</span>\n<span class=\"cm\">  let x_29 : obj := Nat.sub x_28 x_4;</span>\n<span class=\"cm\">  dec x_28;</span>\n<span class=\"cm\">  let x_30 : obj := Nat.sub x_29 x_4;</span>\n<span class=\"cm\">  dec x_29;</span>\n<span class=\"cm\">  let x_31 : obj := Nat.sub x_30 x_4;</span>\n<span class=\"cm\">  dec x_30;</span>\n<span class=\"cm\">  let x_32 : obj := Nat.sub x_31 x_4;</span>\n<span class=\"cm\">  dec x_31;</span>\n<span class=\"cm\">  let x_33 : obj := Nat.sub x_32 x_4;</span>\n<span class=\"cm\">  dec x_32;</span>\n<span class=\"cm\">  let x_34 : obj := Nat.sub x_33 x_4;</span>\n<span class=\"cm\">  dec x_33;</span>\n<span class=\"cm\">  let x_35 : obj := Nat.sub x_34 x_4;</span>\n<span class=\"cm\">  dec x_34;</span>\n<span class=\"cm\">  let x_36 : obj := Nat.sub x_35 x_4;</span>\n<span class=\"cm\">  dec x_35;</span>\n<span class=\"cm\">  let x_37 : obj := Nat.sub x_36 x_4;</span>\n<span class=\"cm\">  dec x_36;</span>\n<span class=\"cm\">  let x_38 : obj := Nat.sub x_37 x_4;</span>\n<span class=\"cm\">  dec x_37;</span>\n<span class=\"cm\">  let x_39 : obj := Nat.sub x_38 x_4;</span>\n<span class=\"cm\">  dec x_38;</span>\n<span class=\"cm\">  let x_40 : obj := Nat.sub x_39 x_4;</span>\n<span class=\"cm\">  dec x_39;</span>\n<span class=\"cm\">  let x_41 : obj := Nat.sub x_40 x_4;</span>\n<span class=\"cm\">  dec x_40;</span>\n<span class=\"cm\">  let x_42 : obj := Nat.sub x_41 x_4;</span>\n<span class=\"cm\">  dec x_41;</span>\n<span class=\"cm\">  let x_43 : obj := Nat.sub x_42 x_4;</span>\n<span class=\"cm\">  dec x_42;</span>\n<span class=\"cm\">  let x_44 : obj := Nat.sub x_43 x_4;</span>\n<span class=\"cm\">  dec x_43;</span>\n<span class=\"cm\">  let x_45 : obj := Nat.sub x_44 x_4;</span>\n<span class=\"cm\">  dec x_44;</span>\n<span class=\"cm\">  let x_46 : obj := Nat.sub x_45 x_4;</span>\n<span class=\"cm\">  dec x_45;</span>\n<span class=\"cm\">  let x_47 : obj := Nat.sub x_46 x_4;</span>\n<span class=\"cm\">  dec x_46;</span>\n<span class=\"cm\">  let x_48 : obj := Nat.sub x_47 x_4;</span>\n<span class=\"cm\">  dec x_47;</span>\n<span class=\"cm\">  let x_49 : obj := Nat.sub x_48 x_4;</span>\n<span class=\"cm\">  dec x_48;</span>\n<span class=\"cm\">  let x_50 : obj := Nat.sub x_49 x_4;</span>\n<span class=\"cm\">  dec x_49;</span>\n<span class=\"cm\">  let x_51 : obj := Nat.sub x_50 x_4;</span>\n<span class=\"cm\">  dec x_50;</span>\n<span class=\"cm\">  let x_52 : obj := Nat.sub x_51 x_4;</span>\n<span class=\"cm\">  dec x_51;</span>\n<span class=\"cm\">  let x_53 : obj := Nat.sub x_52 x_4;</span>\n<span class=\"cm\">  dec x_52;</span>\n<span class=\"cm\">  let x_54 : obj := Nat.sub x_53 x_4;</span>\n<span class=\"cm\">  dec x_53;</span>\n<span class=\"cm\">  let x_55 : obj := Nat.sub x_54 x_4;</span>\n<span class=\"cm\">  dec x_54;</span>\n<span class=\"cm\">  let x_56 : obj := Nat.sub x_55 x_4;</span>\n<span class=\"cm\">  dec x_55;</span>\n<span class=\"cm\">  let x_57 : obj := Nat.sub x_56 x_4;</span>\n<span class=\"cm\">  dec x_56;</span>\n<span class=\"cm\">  let x_58 : obj := Nat.sub x_57 x_4;</span>\n<span class=\"cm\">  dec x_57;</span>\n<span class=\"cm\">  let x_59 : obj := Nat.sub x_58 x_4;</span>\n<span class=\"cm\">  dec x_58;</span>\n<span class=\"cm\">  let x_60 : obj := Nat.sub x_59 x_4;</span>\n<span class=\"cm\">  dec x_59;</span>\n<span class=\"cm\">  let x_61 : obj := Nat.sub x_60 x_4;</span>\n<span class=\"cm\">  dec x_60;</span>\n<span class=\"cm\">  let x_62 : obj := Nat.sub x_61 x_4;</span>\n<span class=\"cm\">  dec x_61;</span>\n<span class=\"cm\">  let x_63 : obj := Nat.sub x_62 x_4;</span>\n<span class=\"cm\">  dec x_62;</span>\n<span class=\"cm\">  let x_64 : obj := Nat.sub x_63 x_4;</span>\n<span class=\"cm\">  dec x_63;</span>\n<span class=\"cm\">  let x_65 : obj := Nat.sub x_64 x_4;</span>\n<span class=\"cm\">  dec x_64;</span>\n<span class=\"cm\">  let x_66 : obj := Nat.sub x_65 x_4;</span>\n<span class=\"cm\">  dec x_65;</span>\n<span class=\"cm\">  let x_67 : obj := Nat.sub x_66 x_4;</span>\n<span class=\"cm\">  dec x_66;</span>\n<span class=\"cm\">  let x_68 : obj := Nat.sub x_67 x_4;</span>\n<span class=\"cm\">  dec x_67;</span>\n<span class=\"cm\">  let x_69 : obj := Nat.sub x_68 x_4;</span>\n<span class=\"cm\">  dec x_68;</span>\n<span class=\"cm\">  let x_70 : obj := Nat.sub x_69 x_4;</span>\n<span class=\"cm\">  dec x_69;</span>\n<span class=\"cm\">  let x_71 : obj := Nat.sub x_70 x_4;</span>\n<span class=\"cm\">  dec x_70;</span>\n<span class=\"cm\">  let x_72 : obj := Nat.sub x_71 x_4;</span>\n<span class=\"cm\">  dec x_71;</span>\n<span class=\"cm\">  let x_73 : obj := Nat.sub x_72 x_4;</span>\n<span class=\"cm\">  dec x_72;</span>\n<span class=\"cm\">  let x_74 : obj := Nat.sub x_73 x_4;</span>\n<span class=\"cm\">  dec x_73;</span>\n<span class=\"cm\">  let x_75 : obj := Nat.sub x_74 x_4;</span>\n<span class=\"cm\">  dec x_74;</span>\n<span class=\"cm\">  let x_76 : obj := Nat.sub x_75 x_4;</span>\n<span class=\"cm\">  dec x_75;</span>\n<span class=\"cm\">  let x_77 : obj := Nat.sub x_76 x_4;</span>\n<span class=\"cm\">  dec x_76;</span>\n<span class=\"cm\">  let x_78 : obj := Nat.sub x_77 x_4;</span>\n<span class=\"cm\">  dec x_77;</span>\n<span class=\"cm\">  let x_79 : obj := Nat.sub x_78 x_4;</span>\n<span class=\"cm\">  dec x_78;</span>\n<span class=\"cm\">  let x_80 : obj := Nat.sub x_79 x_4;</span>\n<span class=\"cm\">  dec x_79;</span>\n<span class=\"cm\">  let x_81 : obj := Nat.sub x_80 x_4;</span>\n<span class=\"cm\">  dec x_80;</span>\n<span class=\"cm\">  let x_82 : obj := Nat.sub x_81 x_4;</span>\n<span class=\"cm\">  dec x_81;</span>\n<span class=\"cm\">  let x_83 : obj := Nat.sub x_82 x_4;</span>\n<span class=\"cm\">  dec x_82;</span>\n<span class=\"cm\">  let x_84 : obj := Nat.sub x_83 x_4;</span>\n<span class=\"cm\">  dec x_83;</span>\n<span class=\"cm\">  let x_85 : obj := Nat.sub x_84 x_4;</span>\n<span class=\"cm\">  dec x_84;</span>\n<span class=\"cm\">  let x_86 : obj := Nat.sub x_85 x_4;</span>\n<span class=\"cm\">  dec x_85;</span>\n<span class=\"cm\">  let x_87 : obj := Nat.sub x_86 x_4;</span>\n<span class=\"cm\">  dec x_86;</span>\n<span class=\"cm\">  let x_88 : obj := Nat.sub x_87 x_4;</span>\n<span class=\"cm\">  dec x_87;</span>\n<span class=\"cm\">  let x_89 : obj := Nat.sub x_88 x_4;</span>\n<span class=\"cm\">  dec x_88;</span>\n<span class=\"cm\">  let x_90 : obj := Nat.sub x_89 x_4;</span>\n<span class=\"cm\">  dec x_89;</span>\n<span class=\"cm\">  let x_91 : obj := Nat.sub x_90 x_4;</span>\n<span class=\"cm\">  dec x_90;</span>\n<span class=\"cm\">  let x_92 : obj := Nat.sub x_91 x_4;</span>\n<span class=\"cm\">  dec x_91;</span>\n<span class=\"cm\">  let x_93 : obj := Nat.sub x_92 x_4;</span>\n<span class=\"cm\">  dec x_92;</span>\n<span class=\"cm\">  let x_94 : obj := Nat.sub x_93 x_4;</span>\n<span class=\"cm\">  dec x_93;</span>\n<span class=\"cm\">  let x_95 : obj := Nat.sub x_94 x_4;</span>\n<span class=\"cm\">  dec x_94;</span>\n<span class=\"cm\">  let x_96 : obj := Nat.sub x_95 x_4;</span>\n<span class=\"cm\">  dec x_95;</span>\n<span class=\"cm\">  let x_97 : obj := Nat.sub x_96 x_4;</span>\n<span class=\"cm\">  dec x_96;</span>\n<span class=\"cm\">  let x_98 : obj := Nat.sub x_97 x_4;</span>\n<span class=\"cm\">  dec x_97;</span>\n<span class=\"cm\">  let x_99 : obj := Nat.sub x_98 x_4;</span>\n<span class=\"cm\">  dec x_98;</span>\n<span class=\"cm\">  let x_100 : obj := Nat.sub x_99 x_4;</span>\n<span class=\"cm\">  dec x_99;</span>\n<span class=\"cm\">  let x_101 : obj := Nat.sub x_100 x_4;</span>\n<span class=\"cm\">  dec x_100;</span>\n<span class=\"cm\">  let x_102 : u8 := Nat.decEq x_101 x_3;</span>\n<span class=\"cm\">  dec x_101;</span>\n<span class=\"cm\">  case x_102 : u8 of</span>\n<span class=\"cm\">  Bool.false →</span>\n<span class=\"cm\">    let x_103 : obj := 2;</span>\n<span class=\"cm\">    ret x_103</span>\n<span class=\"cm\">  Bool.true →</span>\n<span class=\"cm\">    let x_104 : obj := 1;</span>\n<span class=\"cm\">    ret x_104</span>\n<span class=\"cm\">def f._boxed (x_1 : obj) : obj :=</span>\n<span class=\"cm\">  let x_2 : u32 := unbox x_1;</span>\n<span class=\"cm\">  dec x_1;</span>\n<span class=\"cm\">  let x_3 : obj := f x_2</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">ir</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"bp\">'</span><span class=\"n\">a'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">b'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">ofBitVec</span><span class=\"w\"> </span><span class=\"mi\">97</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UInt32</span><span class=\"bp\">.</span><span class=\"n\">ofBitVec</span><span class=\"w\"> </span><span class=\"mi\">98</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">function size: 365</span>\n<span class=\"cm\">matcher size: 2739221</span>\n<span class=\"cm\">-/</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"ss\">``f</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">matcher</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"ss\">``f.match_1</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"function size: {f.value!.size}</span><span class=\"se\">\\n</span><span class=\"s2\">matcher size: {matcher.value!.size}\"</span>\n</code></pre></div>",
        "id": 509441253,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743511411
    },
    {
        "content": "<p>In contrast, this is not bloat:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">[result]</span>\n<span class=\"cm\">def f (x_1 : u32) : obj :=</span>\n<span class=\"cm\">  let x_2 : u32 := 97;</span>\n<span class=\"cm\">  let x_3 : u8 := UInt32.decEq x_1 x_2;</span>\n<span class=\"cm\">  case x_3 : u8 of</span>\n<span class=\"cm\">  Bool.false →</span>\n<span class=\"cm\">    let x_4 : obj := 2;</span>\n<span class=\"cm\">    ret x_4</span>\n<span class=\"cm\">  Bool.true →</span>\n<span class=\"cm\">    let x_5 : obj := 1;</span>\n<span class=\"cm\">    ret x_5</span>\n<span class=\"cm\">def f._boxed (x_1 : obj) : obj :=</span>\n<span class=\"cm\">  let x_2 : u32 := unbox x_1;</span>\n<span class=\"cm\">  dec x_1;</span>\n<span class=\"cm\">  let x_3 : obj := f x_2;</span>\n<span class=\"cm\">  ret x_3</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">compiler</span><span class=\"bp\">.</span><span class=\"n\">ir</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"bp\">'</span><span class=\"n\">a'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">b'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">hb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">b'</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">fin_cases</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">contradiction</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">function size: 605</span>\n<span class=\"cm\">proof size: 43185</span>\n<span class=\"cm\">-/</span>\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"ss\">``f</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">prf</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"ss\">``f.proof_1</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"function size: {f.value!.size}</span><span class=\"se\">\\n</span><span class=\"s2\">proof size: {prf.value!.size}\"</span>\n</code></pre></div>",
        "id": 509445488,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743512522
    },
    {
        "content": "<p>I imagine this works for <code>Finset String</code> as well</p>",
        "id": 509446785,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743512840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113489-new-members/topic/matching.20on.20Finset/near/509434429\">said</a>:</p>\n<blockquote>\n<p>It's not running any decidable equality procedure, but using dependent elimination to eliminate the remaining cases</p>\n</blockquote>\n<p><code>{a, b}</code> invokes decidable equality of <code>a</code> and <code>b</code> to reduce to a constructor, so I think decidability is still to blame</p>",
        "id": 509454037,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743514570
    }
]