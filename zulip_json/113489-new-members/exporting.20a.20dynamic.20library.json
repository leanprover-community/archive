[
    {
        "content": "<p>I'm trying to get Lean to output a dynamic library <code>.so</code> file suitable for linking against. I've managed to get lake to output <code>.so</code> files, with <code>lake build Main:dynlib</code> (for a file named <code>Main</code>) but these all include a bunch of undefined symbols for standard library functions, which is causing issues when I try to open the <code>.so</code> in a different languages's FFI. </p>\n<p>After learning a little bit about linking (I knew nothing beginning of today) and inspecting the <code>.so</code> with <code>nm -D</code> the other language's FFI seems correct in yelling at me as a bunch of standard library functions are undefind... but I can't seem to figure out, how can I get a standalone dynamic library? The structure of my project is, I have one <code>Main.lean</code> file containing several functions. My lakefile looks like the following:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Main\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.1.0\"</span>\n\n<span class=\"k\">[[lean_lib]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Main\"</span>\n</code></pre></div>\n<p>How might I build a self-contained dynamic library with the standard library included?</p>",
        "id": 494722887,
        "sender_full_name": "JJ",
        "timestamp": 1737351614
    },
    {
        "content": "<p>Hi, I have not done any FFI programming with Lean, however I did get this example to build an .so on linux.</p>\n<p><a href=\"https://github.com/leanprover/lean4/tree/master/src/lake/examples/reverse-ffi\">https://github.com/leanprover/lean4/tree/master/src/lake/examples/reverse-ffi</a></p>\n<p>check in <code>main.c</code>,  to see the goal, which was to use an exported lean function to compute the length of a string:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">//...</span><span class=\"w\"> </span><span class=\"n\">preamble</span>\n<span class=\"w\">  </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"n\">program</span>\n\n<span class=\"w\">  </span><span class=\"n\">lean_object</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">lean_mk_string</span><span class=\"o\">(</span><span class=\"s2\">\"hello!\"</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">my_length</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"o\">(</span><span class=\"s2\">\"output: %ld</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>However, I had to remove mentions of <code>-lleanshared_1</code> in the Makefile to get it to build. (also, I have no idea how much of the stdlib is available from C)</p>",
        "id": 494866905,
        "sender_full_name": "Derek Rhodes",
        "timestamp": 1737394255
    },
    {
        "content": "<blockquote>\n<p>How might I build a self-contained dynamic library with the standard library included?</p>\n</blockquote>\n<p>This kind of \"fat\" dynamic library is not supported yet (as it does not compose if you mix dynlibs from multiple Lean libraries). It would be great if you could open a small RFC with your use case. Pending that, copying over the dynlibs from the toolchain directory should work.</p>",
        "id": 494891296,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737398323
    },
    {
        "content": "<p>Thanks! I've found the symbols I was missing in <code>libleanshared.so</code> there.</p>",
        "id": 495119721,
        "sender_full_name": "JJ",
        "timestamp": 1737484070
    },
    {
        "content": "<p>I'm doing something very stupid (calling Lean from Racket for no real reason)... I think having the symbols in a separate library will <em>probably</em> work for my use case, though I haven't gotten it to work yet. Not supporting this outright makes sense from how you're describing it.</p>",
        "id": 495120327,
        "sender_full_name": "JJ",
        "timestamp": 1737484289
    },
    {
        "content": "<p>Update: I have gotten it working. Many thanks!</p>",
        "id": 495121286,
        "sender_full_name": "JJ",
        "timestamp": 1737484643
    },
    {
        "content": "<p>(also <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> are you at POPL?)</p>",
        "id": 495122908,
        "sender_full_name": "JJ",
        "timestamp": 1737485266
    },
    {
        "content": "<p>(I am, always happy to talk about anything Lean-related and even other things!)</p>",
        "id": 495125428,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1737486163
    },
    {
        "content": "<p>Hi, Sorry for opening this 1 year old thread. I am trying something with dynamic library. I created a simple lean module from which I am trying to create a dynamic library so that I can load it from a Python program. I was able to generate the *.so file, but there are some missing definitions. I have linked libLean.a, libStd.a, libInit.a during the compilation. But, when I try to load the library from python it complains that \"lean_dec_ref_cold\" is not defined. I tried to look under all the libraries under $LEAN_LIB/lib/lean folder using \"nm\" command but still couldn't find the library where \"lean_def_rec_cold\" is defined. If I can get some help that would be amazing.<br>\nThank you.</p>",
        "id": 566244312,
        "sender_full_name": "Sparsa Roychowdhury",
        "timestamp": 1767554587
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"710005\">Sparsa Roychowdhury</span> <a href=\"#narrow/channel/113489-new-members/topic/exporting.20a.20dynamic.20library/near/566244312\">said</a>:</p>\n<blockquote>\n<p>Hi, Sorry for opening this 1 year old thread. I am trying something with dynamic library. I created a simple lean module from which I am trying to create a dynamic library so that I can load it from a Python program. I was able to generate the *.so file, but there are some missing definitions. I have linked libLean.a, libStd.a, libInit.a during the compilation. But, when I try to load the library from python it complains that \"lean_dec_ref_cold\" is not defined. I tried to look under all the libraries under $LEAN_LIB/lib/lean folder using \"nm\" command but still couldn't find the library where \"lean_def_rec_cold\" is defined. If I can get some help that would be amazing.<br>\nThank you.</p>\n</blockquote>\n<p>I have found \"lean_dec_ref_cold\" in libleanrt.a library. But still not able to complete the process. Will update.</p>",
        "id": 566245035,
        "sender_full_name": "Sparsa Roychowdhury",
        "timestamp": 1767555396
    },
    {
        "content": "<p>all were declared under <a href=\"http://libleanshared.so\">libleanshared.so</a>.<br>\nable to figure out.</p>",
        "id": 566245272,
        "sender_full_name": "Sparsa Roychowdhury",
        "timestamp": 1767555612
    }
]