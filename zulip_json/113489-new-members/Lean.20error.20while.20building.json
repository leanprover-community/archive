[
    {
        "content": "<p>Hey guys, I am trying to build a Lean4 project. Below I try to recreate a minimal example of the project. When I run <code>lake build</code> for the example below, I get the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4.git</span> <span class=\"n\">to</span> <span class=\"bp\">./</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">./</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">lakefile.lean</span><span class=\"o\">:</span><span class=\"mi\">29</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">'</span><span class=\"n\">weakLeanArgs'</span> <span class=\"n\">is</span> <span class=\"n\">not</span> <span class=\"n\">a</span> <span class=\"n\">field</span> <span class=\"n\">of</span> <span class=\"kd\">structure</span> <span class=\"bp\">'</span><span class=\"n\">Lake.LeanLibConfig'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">./</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">lakefile.lean</span><span class=\"o\">:</span><span class=\"mi\">52</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">'</span><span class=\"n\">weakLeanArgs'</span> <span class=\"n\">is</span> <span class=\"n\">not</span> <span class=\"n\">a</span> <span class=\"n\">field</span> <span class=\"n\">of</span> <span class=\"kd\">structure</span> <span class=\"bp\">'</span><span class=\"n\">Lake.LeanLibConfig'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">./</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">lakefile.lean</span><span class=\"o\">:</span> <span class=\"n\">package</span> <span class=\"n\">configuration</span> <span class=\"n\">has</span> <span class=\"n\">errors</span>\n</code></pre></div>\n<p>I have reasons to believe this is because I set the revision of mathlib4 to the latest commit. (see the bottom of the post for context)<br>\nBefore calling <code>lake build</code> the project directory structure is as follows: </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">PackageName</span>\n    <span class=\"bp\">|</span><span class=\"n\">_</span>  <span class=\"n\">PackageName</span>\n             <span class=\"bp\">|</span><span class=\"n\">_</span> <span class=\"n\">All.lean</span>\n             <span class=\"bp\">|</span><span class=\"n\">_</span> <span class=\"n\">theorems.lean</span>\n    <span class=\"bp\">|</span><span class=\"n\">_</span> <span class=\"n\">Package.lean</span>\n    <span class=\"bp\">|</span><span class=\"n\">_</span> <span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">manifest.lean</span>\n    <span class=\"bp\">|</span><span class=\"n\">_</span> <span class=\"n\">lakefile.lean</span>\n    <span class=\"bp\">|</span><span class=\"n\">_</span> <span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n</code></pre></div>\n<p><code>All.lean</code> is an empty file. The <code>lakefile.lean</code> is as follows: </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Lake</span>\n<span class=\"kn\">open</span> <span class=\"n\">Lake</span> <span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span> <span class=\"bp\">«</span><span class=\"n\">packageName</span><span class=\"bp\">»</span> <span class=\"o\">{</span>\n  <span class=\"c1\">-- add any package configuration options here</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">require</span> <span class=\"n\">mathlib</span> <span class=\"k\">from</span> <span class=\"n\">git</span>\n  <span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span>\n\n<span class=\"kd\">@[default_target]</span>\n<span class=\"n\">lean_lib</span> <span class=\"bp\">«</span><span class=\"n\">PackageName</span><span class=\"bp\">»</span> <span class=\"o\">{</span>\n  <span class=\"c1\">-- add any library configuration options here</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>My <code>lake-manifest.json</code> looks like this: </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"o\">{</span><span class=\"s2\">\"version\"</span><span class=\"o\">:</span> <span class=\"mi\">4</span><span class=\"o\">,</span>\n <span class=\"s2\">\"packagesDir\"</span><span class=\"o\">:</span> <span class=\"s2\">\"lake-packages\"</span><span class=\"o\">,</span>\n <span class=\"s2\">\"packages\"</span><span class=\"o\">:</span>\n <span class=\"o\">[{</span><span class=\"s2\">\"git\"</span><span class=\"o\">:</span>\n   <span class=\"o\">{</span><span class=\"s2\">\"url\"</span><span class=\"o\">:</span> <span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"subDir?\"</span><span class=\"o\">:</span> <span class=\"n\">null</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"rev\"</span><span class=\"o\">:</span> <span class=\"s2\">\"c532d7b8b62ae053ce3d894ac69b52564e644696\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"name\"</span><span class=\"o\">:</span> <span class=\"s2\">\"mathlib\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"inputRev?\"</span><span class=\"o\">:</span> <span class=\"n\">null</span><span class=\"o\">}},</span>\n  <span class=\"o\">{</span><span class=\"s2\">\"git\"</span><span class=\"o\">:</span>\n   <span class=\"o\">{</span><span class=\"s2\">\"url\"</span><span class=\"o\">:</span> <span class=\"s2\">\"https://github.com/gebner/quote4\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"subDir?\"</span><span class=\"o\">:</span> <span class=\"n\">null</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"rev\"</span><span class=\"o\">:</span> <span class=\"s2\">\"c71f94e34c1cda52eef5c93dc9da409ab2727420\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"name\"</span><span class=\"o\">:</span> <span class=\"s2\">\"Qq\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"inputRev?\"</span><span class=\"o\">:</span> <span class=\"s2\">\"master\"</span><span class=\"o\">}},</span>\n  <span class=\"o\">{</span><span class=\"s2\">\"git\"</span><span class=\"o\">:</span>\n   <span class=\"o\">{</span><span class=\"s2\">\"url\"</span><span class=\"o\">:</span> <span class=\"s2\">\"https://github.com/JLimperg/aesop\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"subDir?\"</span><span class=\"o\">:</span> <span class=\"n\">null</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"rev\"</span><span class=\"o\">:</span> <span class=\"s2\">\"cdc00b640d0179910ebaa9c931e3b733a04b881c\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"name\"</span><span class=\"o\">:</span> <span class=\"s2\">\"aesop\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"inputRev?\"</span><span class=\"o\">:</span> <span class=\"s2\">\"master\"</span><span class=\"o\">}},</span>\n  <span class=\"o\">{</span><span class=\"s2\">\"git\"</span><span class=\"o\">:</span>\n   <span class=\"o\">{</span><span class=\"s2\">\"url\"</span><span class=\"o\">:</span> <span class=\"s2\">\"https://github.com/leanprover/std4\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"subDir?\"</span><span class=\"o\">:</span> <span class=\"n\">null</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"rev\"</span><span class=\"o\">:</span> <span class=\"s2\">\"6006307d2ceb8743fea7e00ba0036af8654d0347\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"name\"</span><span class=\"o\">:</span> <span class=\"s2\">\"std\"</span><span class=\"o\">,</span>\n    <span class=\"s2\">\"inputRev?\"</span><span class=\"o\">:</span> <span class=\"s2\">\"main\"</span><span class=\"o\">}}]}</span>\n</code></pre></div>\n<p>Note: The revision for mathlib4 is set to the latest commit (perhaps this is where the error is?).</p>\n<p>One thing of note is that if I replace the current commit version with the following commit hash: <code>f52ba342fc94eccad393169be575cc94f22d6ca9</code>, the package builds and works just fine, so that is where the issue is happening. The reason I am trying to build the latest version is because the previous one is from March and misses out on a lot of development that has happened since then. </p>\n<p>Any advice on building this would be appreciated. Thanks!</p>\n<p>ADDENDUM: If I try <code>lake update</code> on the commit that works, it gives the same error.</p>",
        "id": 384560972,
        "sender_full_name": "Rahul Saha",
        "timestamp": 1691951878
    },
    {
        "content": "<p>Try removing the <code>lake-packages</code> directory and then run <code>lake exe cache get</code>. There is no problem using the latest mathlib commit. If removing the directory doesn't work then just delete the repo and make a new one with <code>lake new name-of-project math</code> then <code>lake exe cache get</code> and don't touch any config files.</p>",
        "id": 384572225,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1691955444
    },
    {
        "content": "<p>The correct way to update a project which depends on mathlib is explained in the mathlib readme IIRC (it involves a <code>curl</code> command)</p>",
        "id": 384572527,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1691955582
    },
    {
        "content": "<p>Ah gotcha, the following worked for the update. </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">curl</span> <span class=\"bp\">-</span><span class=\"n\">L</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">raw.githubusercontent.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">/</span><span class=\"n\">master</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span> <span class=\"bp\">-</span><span class=\"n\">o</span> <span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span>\n<span class=\"n\">lake</span> <span class=\"n\">update</span>\n<span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span>\n</code></pre></div>\n<p>Thanks!</p>",
        "id": 384573980,
        "sender_full_name": "Rahul Saha",
        "timestamp": 1691956210
    },
    {
        "content": "<p>(I think the <code>curl</code> command is just copying mathlib's version of Lean and making it your project's version of Lean BTW)</p>",
        "id": 384592206,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1691964945
    }
]