[
    {
        "content": "<p>This typechecks:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"s2\">\"Enter your name: \"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"Hello, \"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Now let's remove the first <code>print</code>. Suddenly it doesn't:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">type mismatch</span>\n<span class=\"sd\">  stdin.getLine</span>\n<span class=\"sd\">has type</span>\n<span class=\"sd\">  IO String : Type</span>\n<span class=\"sd\">but is expected to have type</span>\n<span class=\"sd\">  BaseIO ?m.10048 : Type</span>\n<span class=\"sd\">--/</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"Hello, \"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I can fix it by adding <code>: IO Unit</code> though:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"Hello, \"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>How do I make sense of this? What is the chain of inferences that breaks this?</p>\n<p>I'm asking both because it would kind of feel neater to not have to write <code>: IO Unit</code>, and because I don't understand what's happening. I was actually stuck on this error message for a while.</p>",
        "id": 537016481,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1756684791
    },
    {
        "content": "<p>probably some sort of monad lift stuff</p>",
        "id": 537016953,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756685149
    },
    {
        "content": "<p><code>IO.getStdin</code> is guaranteed to never error, and that is reflected in its return type being <code>BaseIO</code> instead of <code>IO</code></p>",
        "id": 537017020,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756685194
    },
    {
        "content": "<p>but that also means when you bind it you need to convert the <code>BaseIO</code> into <code>IO</code></p>",
        "id": 537017069,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756685231
    },
    {
        "content": "<p>and that is usually done automatically</p>",
        "id": 537017080,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756685245
    },
    {
        "content": "<p>but this time it wasn't done because we didn't know it had to be converted since there was no expected type</p>",
        "id": 537017100,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756685267
    },
    {
        "content": "<p>The other consideration here is that <code>main</code> is not special when it comes to type-checking, and so there is no expected type available of the form \"well this is the <code>main</code> function so it must be <code>IO</code>\"</p>",
        "id": 537017193,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756685346
    },
    {
        "content": "<p>Thanks. Is there any other place I could've done this annotation? Purely scientific interest. I tried putting <code>IO</code> in a few places but I'm not sure I understand which type is flowing where.</p>",
        "id": 537017236,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1756685389
    },
    {
        "content": "<p>I've tried</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">Stream</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"Hello, \"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>but now the problem is it's being inferred as <code>EIO IO.Error Unit</code> which I'm not sure where it's coming from.</p>",
        "id": 537017346,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1756685504
    },
    {
        "content": "<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"Hello, \"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 537017356,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756685514
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"418569\">Dan Abramov</span> <a href=\"#narrow/channel/113489-new-members/topic/Why.20does.20not.20declaring.20.60main.60.20type.20cause.20this.20error.3F/near/537017346\">said</a>:</p>\n<blockquote>\n<p>but now the problem is it's being inferred as <code>EIO IO.Error Unit</code> which I'm not sure where it's coming from.</p>\n</blockquote>\n<p><code>IO Unit = EIO IO.Error Unit</code> is true by definition</p>",
        "id": 537017381,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756685533
    },
    {
        "content": "<p>I think this error message is a bug</p>",
        "id": 537017400,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756685552
    },
    {
        "content": "<p>Something somewhere is saying \"is the type exactly <code>IO Unit</code>?\", but should probably be saying \"Is the type reducibly defeq to <code>IO Unit</code>?\".</p>",
        "id": 537017449,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756685593
    }
]