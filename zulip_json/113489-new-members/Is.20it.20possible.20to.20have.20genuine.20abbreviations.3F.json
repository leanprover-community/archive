[
    {
        "content": "<p>Consider the following definition:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span>\n</code></pre></div>\n<p>Subsequently the term <code>foo</code> denotes a function <code>foo : ℕ → ℕ → ℕ → ℕ</code>, not the sum <code>x + y  + z</code>.  To refer to that sum, I need to write <code>foo x y z</code>.  After all, <code>abbrev</code>is just a variant of <code>def</code>.   But is it possible to have a genuine abbreviation or \"macro\" so that I can write <code>foo</code> for the expression <code>x + y + z</code>?</p>\n<p>Needless to say, in the actual use case I have in mind, the identifiers and expressions involved are more complicated than those in the above example and I hope a genuine abbreviation mechanism can improve the readability of my code.</p>",
        "id": 536500532,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1756331335
    },
    {
        "content": "<p>In Lean 3, there used to be a <code>parameter</code> command which did something similar, but it was removed in Lean 4 for reasons I don't quite understand. You can probably do something like <code>local notation \"foo\" =&gt; x + y + z</code>, and I know this is possible to implement using macros.</p>",
        "id": 536500820,
        "sender_full_name": "Niels Voss",
        "timestamp": 1756331571
    },
    {
        "content": "<p>Is this documented somewhere or there are examples I can look at?</p>",
        "id": 536500965,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1756331649
    },
    {
        "content": "<p>I'm not sure, sorry. One thing to watch out for is this bug <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/Local.20notation.20leads.20to.20hidden.20sorry/with/428045501\">#general &gt; Local notation leads to hidden sorry</a>. It's possible it has been fixed, but I haven't checked recently.</p>",
        "id": 536501294,
        "sender_full_name": "Niels Voss",
        "timestamp": 1756331892
    },
    {
        "content": "<p>I think the bug is still present</p>",
        "id": 536501636,
        "sender_full_name": "Niels Voss",
        "timestamp": 1756332104
    },
    {
        "content": "<p>Macro also works <code>macro \"foo\" : term  =&gt; </code>(x + y + z)`.</p>",
        "id": 536502100,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1756332410
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foobar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">-- doesn't work (as expected)</span>\n<span class=\"c1\">-- theorem foobar2 x y z : foo = bar x y z := by rfl</span>\n</code></pre></div>",
        "id": 536502190,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1756332486
    },
    {
        "content": "<p>Yes, you can do it as follows using <code>local notation</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">omega</span>\n</code></pre></div>\n<p>The <code>local</code> just means that the notation isn't defined globally. Writing <code>x:max</code> instead of <code>x</code> tells Lean about the precedence it needs to use to parse <code>x</code>. Without this, it would think that  <code>foo x y z</code> is <code>foo (x y z)</code>, i.e. <code>x</code> applied to <code>y</code> and <code>z</code>.</p>",
        "id": 536655214,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756402516
    },
    {
        "content": "<p>I'm not sure that's what I wanted.  What I wanted is to write <code>foo</code> for the expression <code>x + y  + z</code> without having to mention any of x, y, and z.</p>",
        "id": 536656634,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1756403085
    },
    {
        "content": "<p>I suggest searching for examples of <code>local notation</code> in mathlib. There are plenty that capture variables defined in <code>variables</code>.</p>",
        "id": 536657059,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1756403261
    },
    {
        "content": "<p>One compromise that works for me is to place all ambient variables inside a custom class that one then exports back to the environment, and also introduces as a variable instance.  Abbreviations then depend on that class instance, but that is handled invisibly and so it becomes visually indistinguishable from a \"genuine\" abbreviation.  Example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Data</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"n\">z</span><span class=\"o\">:</span><span class=\"n\">ℕ</span>\n\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">Data</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Data</span><span class=\"o\">]</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 536665584,
        "sender_full_name": "Terence Tao",
        "timestamp": 1756406747
    }
]