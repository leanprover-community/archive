[
    {
        "content": "<p>I want to prove that if <code>r</code> is a list (of some subtype) and <code>a</code> is an element of <code>r</code>, then <code>r[List.idxOf a r] = a</code>. I failed because of a type class instance problem. May someone help me understand what I did wrong?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Set</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Iic</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Iic</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">mar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">}</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">idxOf_lt_length_of_mem</span><span class=\"w\"> </span><span class=\"n\">mar</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">getElem_idxOf</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">idxOf_lt_length_of_mem</span><span class=\"w\"> </span><span class=\"n\">mar</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 558873463,
        "sender_full_name": "Yongxi Lin (Aaron)",
        "timestamp": 1763882765
    },
    {
        "content": "<p>I believe the problem is that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.getElem_idxOf#doc\">docs#List.getElem_idxOf</a> requires <code>[DecidableEq α]</code> while <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_lt_length_of_mem#doc\">docs#List.idxOf_lt_length_of_mem</a> requires <code>[BEq α]</code>.</p>\n<p>There's a \"diamond\" in the typeclasses because <code>Subtype</code> is involved, which causes there to be two different instances of <code>BEq</code>:</p>\n<ul>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.instBEq#doc\">docs#Subtype.instBEq</a></li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.instDecidableEq#doc\">docs#Subtype.instDecidableEq</a> + <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instBEqOfDecidableEq#doc\">docs#instBEqOfDecidableEq</a></li>\n</ul>\n<p>Apart from changing both theorems to use <code>DecidableEq</code>, or deleting <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.instBEq#doc\">docs#Subtype.instBEq</a>, I don't know how to fix it.</p>",
        "id": 558898069,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1763907848
    },
    {
        "content": "<p>But you can do <code>Option.some_injective _ &lt;| getElem?_pos .. |&gt;.symm.trans &lt;| List.getElem?_idxOf mar</code> instead, it only uses <code>DecidableEq</code></p>",
        "id": 558898111,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1763907894
    },
    {
        "content": "<p>Also if you don't need to know the underlying type <code>Iic t</code> of the list for what you need from <code>idxOf</code>, you can prove lemmas with <code>{α : Type*} [DecidableEq α]</code> and use them from the part of the code that does know about <code>Iic t</code>.<br>\nE.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">getElem_idxOf_of_mem</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">l</span><span class=\"o\">[</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">idxOf</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">idxOf_lt_length_of_mem</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">getElem_idxOf</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Set</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Iic</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Iic</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">mar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">}</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">getElem_idxOf_of_mem</span><span class=\"w\"> </span><span class=\"n\">mar</span>\n</code></pre></div>",
        "id": 558898486,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1763908270
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"933054\">Snir Broshi</span> <a href=\"#narrow/channel/113489-new-members/topic/Question.20about.20List.2EgetElem_idxOf/near/558898069\">schrieb</a>:</p>\n<blockquote>\n<p>Apart from changing both theorems to use <code>DecidableEq</code>, or deleting <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subtype.instBEq#doc\">docs#Subtype.instBEq</a>, I don't know how to fix it.</p>\n</blockquote>\n<p>The real fix would be to make both theorems use <code>[BEq α] [LawfulBEq α]</code></p>",
        "id": 558902997,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1763912259
    },
    {
        "content": "<p>I thought <a href=\"https://github.com/leanprover/lean4/pull/8309\">https://github.com/leanprover/lean4/pull/8309</a> was the real fix</p>",
        "id": 558903338,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1763912527
    },
    {
        "content": "<p>Also that :-) But until then, you should use <code>BEq</code> + <code>LawfulBEq</code> when talking about functions that use <code>BEq</code> (and maybe even after then to help unification)</p>",
        "id": 558904097,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1763913289
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113489-new-members/topic/Question.20about.20List.2EgetElem_idxOf/near/558904097\">said</a>:</p>\n<blockquote>\n<p>Also that :-) But until then, you should use <code>BEq</code> + <code>LawfulBEq</code> when talking about functions that use <code>BEq</code> (and maybe even after then to help unification)</p>\n</blockquote>\n<p>So how should <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.getElem_idxOf#doc\">docs#List.getElem_idxOf</a> / <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_lt_length_of_mem#doc\">docs#List.idxOf_lt_length_of_mem</a> be changed?</p>",
        "id": 559120236,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764008370
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_lt_length_of_mem#doc\">docs#List.idxOf_lt_length_of_mem</a> is perfectly fine,<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.getElem_idxOf#doc\">docs#List.getElem_idxOf</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_get#doc\">docs#List.idxOf_get</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.getElem%3F_idxOf#doc\">docs#List.getElem?_idxOf</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_inj#doc\">docs#List.idxOf_inj</a> should all take <code>[BEq α] [LawfulBEq α]</code> instead of <code>[DecidableEq α]</code></p>",
        "id": 560019486,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1764019731
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113489-new-members/topic/Question.20about.20List.2EgetElem_idxOf/near/560019486\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_lt_length_of_mem#doc\">docs#List.idxOf_lt_length_of_mem</a> is perfectly fine,<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.getElem_idxOf#doc\">docs#List.getElem_idxOf</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_get#doc\">docs#List.idxOf_get</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.getElem%3F_idxOf#doc\">docs#List.getElem?_idxOf</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf_inj#doc\">docs#List.idxOf_inj</a> should all take <code>[BEq α] [LawfulBEq α]</code> instead of <code>[DecidableEq α]</code></p>\n</blockquote>\n<p>Is the eventual goal to deprecate <code>DecidableEq</code>?</p>",
        "id": 560023000,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1764021038
    },
    {
        "content": "<p>No, <code>DecidableEq</code> is good and all but <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.idxOf#doc\">docs#List.idxOf</a> has a <code>BEq</code> assumption, not a <code>DecidableEq</code> one</p>",
        "id": 560025185,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1764021828
    }
]