[
    {
        "content": "<p>I have an inductive type that contains a list in the type, and a function that returns that type with no constraints set on the list in the type. Since <code>returnsAnyList</code> imposes no constraints on what list should contain, why does it have a problem if I return a type where the list is empty? </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">emptyCtor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">consCtor</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">l'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l'</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">returnsAnyList</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">MyDepType</span><span class=\"bp\">.</span><span class=\"n\">emptyCtor</span>\n</code></pre></div>\n<p>has error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">MyDepType</span><span class=\"bp\">.</span><span class=\"n\">emptyCtor</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">19530</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">19530</span>\n</code></pre></div>\n<p>I'd understand if it was the other way around, but this way around I don't understand what the error even means. \"We're expecting any list, therefore an empty list is not allowed because that's not 'any' list\"? what?</p>",
        "id": 495177980,
        "sender_full_name": "aron",
        "timestamp": 1737509506
    },
    {
        "content": "<p>The function you have written says</p>\n<blockquote>\n<p>given a value <code>α</code>, which is a <code>Type</code> (infer this value automatically) and<br>\ngiven a value <code>l</code>, which is a <code>List α</code> (also infer this value automatically)<br>\nreturn a value of type <code>MyDepType α l</code></p>\n</blockquote>\n<p>In particular notice that <code>α</code> and <code>l</code> are supplied at the use site and the function should work no matter what they are specialized to.<br>\nSo for example I should be able to write <code>@returnsAnyList Nat [1, 2, 3]</code> and get a <code>MyDepType Nat [1, 2, 3]</code> (here <code>α := Nat</code> and <code>l := [1, 2, 3]</code>). The problem is, with the way you've written your function, <code>@returnsAnyList Nat [1, 2, 3]</code> gives a <code>MyDepType Nat []</code>, which is not the same type.</p>",
        "id": 495179301,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737510233
    },
    {
        "content": "<p>ok, so how do I write a function that can return <code>MyDepType</code> with any list then?</p>",
        "id": 495179412,
        "sender_full_name": "aron",
        "timestamp": 1737510284
    },
    {
        "content": "<p>Please clarify: what do you mean by \"any list\"? do you mean that I (the user of the function) get to decide what list it is, or do you mean you (the writer of the function) get to decide what list it is?</p>",
        "id": 495179679,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737510437
    },
    {
        "content": "<p>let's say the author of the function, but without leaking the information about the size of the list to the caller</p>",
        "id": 495179915,
        "sender_full_name": "aron",
        "timestamp": 1737510575
    },
    {
        "content": "<p>Then, probably how I would write this is to return a <code>Sigma (MyDepType α)</code>. In other words, a pair consisting of a list <code>l</code> and a value <code>MyDepType α l</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">returnsSomeList</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MyDepType</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"n\">MyDepType</span><span class=\"bp\">.</span><span class=\"n\">emptyCtor</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 495180255,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737510778
    },
    {
        "content": "<p>This does not have any information about the list in the type of the function, but the caller will still be able to determine what the list is at runtime.</p>",
        "id": 495180379,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737510846
    },
    {
        "content": "<p>hm I see. Is there no way to implicitly \"loosen\" the exact shape of a dependent type's value when that information isn't needed, or we even actively want to hide it?</p>",
        "id": 495180514,
        "sender_full_name": "aron",
        "timestamp": 1737510946
    },
    {
        "content": "<p>like if I wanted to make a version of <code>returnsAnyList</code> that has a type annotation but whose type I don't have to change depending on what precise value I returned from inside it?</p>",
        "id": 495180635,
        "sender_full_name": "aron",
        "timestamp": 1737511017
    },
    {
        "content": "<p>This is exactly what my solution does: it returns \"some list\", without saying exactly which list it is (in the type annotation at least).<br>\nSince Lean is made for proving things, if you don't mark your definition as opaque then any code downstream will implicitly have access to the internals of your function.</p>",
        "id": 495180848,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737511158
    },
    {
        "content": "<p>For an example of hiding information, you can take a look at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=System.Platform.getNumBits#doc\">docs#System.Platform.getNumBits</a>.</p>",
        "id": 495181290,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737511383
    },
    {
        "content": "<p>The return type is \"a <code>Nat</code> which is either <code>32</code> or <code>64</code> but I won't say which\". Since it is opaque, you can't just look inside of it either.</p>",
        "id": 495181416,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737511452
    },
    {
        "content": "<p>hmmm. is the reason you can't just ask the type checker to loosen a type's specificity because that would be equivalent to letting you prove much more general statements than what you could actually prove?</p>",
        "id": 495181444,
        "sender_full_name": "aron",
        "timestamp": 1737511470
    },
    {
        "content": "<p>sorry, I don't understand what you mean by \"loosen\"</p>",
        "id": 495181473,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737511500
    },
    {
        "content": "<p>to tell the type checker that i don't want the exact size of list in the type even though it does know that information</p>",
        "id": 495182108,
        "sender_full_name": "aron",
        "timestamp": 1737511817
    },
    {
        "content": "<p>Unfortunately, I don't think you can do that in Lean's type theory. Since the type of <code>MyDepType</code> is (roughly) <code>(α : Type) → List α → Type</code>, you need to supply a list to be able to get a type. The compromise is to \"bundle\" the list with the object, and that is what <code>Sigma</code> does.<br>\nDifference :<br>\nIf the function returns a <code>MyDepType α []</code> then it is clearly using the empty list.<br>\nIf the function returns a <code>Sigma (MyDepType α)</code> then <strong>you don't see the list in the type declaration</strong>.</p>",
        "id": 495182948,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1737512140
    },
    {
        "content": "<p>mhmmm ok I see. I think that makes sense. I think this means I can't quite write my code in the way I wanted to, but I think the reasons for this make sense</p>",
        "id": 495183416,
        "sender_full_name": "aron",
        "timestamp": 1737512338
    },
    {
        "content": "<p>thanks <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> for helping me!! <span aria-label=\"raised hands\" class=\"emoji emoji-1f64c\" role=\"img\" title=\"raised hands\">:raised_hands:</span></p>",
        "id": 495183474,
        "sender_full_name": "aron",
        "timestamp": 1737512357
    }
]