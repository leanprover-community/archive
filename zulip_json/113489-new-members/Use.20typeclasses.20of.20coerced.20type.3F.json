[
    {
        "content": "<p>Is there any way to use the typeclasses of a coerced type without manually specifying the coercion? E.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">wrap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">coe</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"bp\">.</span><span class=\"n\">wrap</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"bp\">.</span><span class=\"n\">wrap</span><span class=\"w\"> </span><span class=\"n\">l</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">--works</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"c1\">-- failed to synthesize Membership ?m.18521 WrappedList</span>\n</code></pre></div>",
        "id": 530927789,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753526369
    },
    {
        "content": "<p>Seems not. Is there at least an easy way for <code>Foo</code> to inherit all of  <code>List ‚Ñï</code>'s typeclasses?</p>",
        "id": 531272459,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753677454
    },
    {
        "content": "<p><code>abbrev</code> is the easy way (but it's not applicable here and i hate abbrev)</p>",
        "id": 531307138,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753691467
    },
    {
        "content": "<p>Please don't use <code>abbrev</code> anymore. It now has (or always had?) confusing reduction behavior, and one should instead use <code>@[reducible] def</code></p>",
        "id": 531307425,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753691553
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531307425\">said</a>:</p>\n<blockquote>\n<p>Please don't use <code>abbrev</code> anymore. It now has (or always had?) confusing reduction behavior, and one should instead use <code>@[reducible] def</code></p>\n</blockquote>\n<p>Oh that's interesting, could you please point to one such example?</p>",
        "id": 531307574,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753691606
    },
    {
        "content": "<p>Very unminimised, but <span class=\"user-mention\" data-user-id=\"699016\">@Edison Xie</span>'s repo <a href=\"https://github.com/Whysoserioushah/BrauerGroup_new\">https://github.com/Whysoserioushah/BrauerGroup_new</a> got much faster once we replaced <code>abbrev</code> with <code>@[reducible] def</code>. I believe <span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span> was the one teaching this to us.</p>",
        "id": 531307951,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753691731
    },
    {
        "content": "<p>please just pretend abbrev doesn't exist, i really hate abbrev</p>",
        "id": 531308055,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753691766
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531307425\">said</a>:</p>\n<blockquote>\n<p>Please don't use <code>abbrev</code> anymore. It now has (or always had?) confusing reduction behavior, and one should instead use <code>@[reducible] def</code></p>\n</blockquote>\n<p><code>abbrev</code> is short for <code>@[reducible, inline] def</code>, so when it comes to reduction, it should be <em>exactly</em> the same as <code>@[reducible] def</code>.</p>\n<p>Maybe you ran into some <em>code generation</em> slowness from <code>@[inline]</code>?</p>",
        "id": 531311860,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753692933
    },
    {
        "content": "<p>That link is certainly unminimized. What kind of declaration did you switch from <code>abbrev</code>? A type synonym? Or some other term?</p>",
        "id": 531312197,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753693017
    },
    {
        "content": "<p>What I understood from Bhavik was that <code>abbrev A := B</code> meant \"reduce <code>A</code> to <code>B</code>\" AND \"reduce <code>B</code> to <code>A</code>\". I suggest we wait for him to confirm/infirm my understanding of what he said</p>",
        "id": 531312283,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753693041
    },
    {
        "content": "<p>That's definitely is not the case. An <code>abbrev</code> is like any other <code>def</code>, except for the additional attributes.</p>",
        "id": 531312503,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753693107
    },
    {
        "content": "<p>I guess there's one other difference: <code>abbrev</code> also marks the definition to be an abbrev in the kernel. I thought that meant the definition is preferred to be unfolded in kernel defeqs, but I'm not completely sure. (Edit: yes, some details below.)</p>",
        "id": 531313137,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753693273
    },
    {
        "content": "<p>Maybe \"reduce\" in my understanding above should be \"kernel-reduce\"</p>",
        "id": 531313261,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753693308
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531312197\">said</a>:</p>\n<blockquote>\n<p>That link is certainly unminimized. What kind of declaration did you switch from <code>abbrev</code>? A type synonym? Or some other term?</p>\n</blockquote>\n<p>It was a term. Edison will know more</p>",
        "id": 531313324,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753693324
    },
    {
        "content": "<p>(<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.mkDefViewOfAbbrev#doc\">docs#Lean.Elab.Command.mkDefViewOfAbbrev</a> is where an <code>abbrev</code> gains <code>@[inline, reducible]</code>, and <code>Lean.Elab.addNonRecAux</code> is where the definition is added to the environment with <code>ReducibilityHints.abbrev</code> instead of <code>ReducibilityHints.regular</code>.)</p>",
        "id": 531313599,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753693398
    },
    {
        "content": "<p>I think we shouldn't tell people that <code>abbrev</code> is somehow deprecated. We use it frequently for type synonyms in core Lean.</p>",
        "id": 531313922,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753693483
    },
    {
        "content": "<p>I am certainly not trying to say it is deprecated. And I do not exactly know what's wrong with it, but for sure <em>something</em> is wrong</p>",
        "id": 531314330,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753693602
    },
    {
        "content": "<p>Ok, then please don't say things like this:<br>\n<span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531307425\">said</a>:</p>\n<blockquote>\n<p>Please don't use <code>abbrev</code> anymore. [...] one should instead use¬†<code>@[reducible] def</code></p>\n</blockquote>\n<p>That seems like a clear deprecation to me.</p>\n<p>Are you able to point out which definition was changed to <code>@[reducible]</code> in that repo?</p>\n<p>(I just checked the kernel code: <code>abbrev</code> only affects tie-breaking when you have <code>f x1 ... xn =?= g y1 ... yn</code> and something needs to be unfolded. Normally, regular definitions use the heuristic that the more-or-less newer definition gets unfolded. Using <code>abbrev</code> causes the definition to be \"newer\" than even definitions that haven't been defined yet. There are definitely cases where this is the wrong heuristic, but that doesn't mean that <code>abbrev</code> itself is incorrect. It's worth getting some examples to see what's going on.)</p>",
        "id": 531316807,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753694282
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"587858\">@Fernando Chu</span> Sorry, this is getting off-topic.</p>\n<p>Answering your question, there's not an easy way to inherit all typeclasses in a wrapper like that.</p>\n<p>The problem you were running into with the <code>Membership</code> instance is that in <code>1 ‚àà Foo</code>, the existence of the coercion and the existence of a List membership instance isn't enough to trigger inserting the coercion.</p>\n<p>I assume in your application <code>WrappedList</code> has other fields too, not just <code>wrap</code>?</p>",
        "id": 531317424,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753694474
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531317424\">said</a>:</p>\n<blockquote>\n<p>I assume in your application <code>WrappedList</code> has other fields too, not just <code>wrap</code>?</p>\n</blockquote>\n<p>Indeed. The <code>abbrev</code> thing is still quite interesting to me though; since I'm doing stuff with syntax, I do have been also struggling with getting the right reduction behaviour.</p>",
        "id": 531317994,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753694636
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531316807\">said</a>:</p>\n<blockquote>\n<p>Ok, then please don't say things like this:</p>\n</blockquote>\n<p>but can I say that I hate abbrev?</p>",
        "id": 531318548,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753694793
    },
    {
        "content": "<p>Maybe there are other techniques, but copying instances seems like it takes a lot of boilerplate:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">wrap</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"bp\">.</span><span class=\"n\">wrap</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Membership</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">wrap</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"bp\">.</span><span class=\"n\">mem_coe</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WrappedList</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Üî</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>You need that last lemma to normalize which membership instance is actually being used when you're proving things.</p>",
        "id": 531318626,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753694814
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531317424\">said</a>:</p>\n<blockquote>\n<p>The problem you were running into with the <code>Membership</code> instance is that in <code>1 ‚àà Foo</code>, the existence of the coercion and the existence of a List membership instance isn't enough to trigger inserting the coercion.</p>\n</blockquote>\n<p>The <a href=\"https://lean-lang.org/doc/reference/latest/Coercions/Coercion-Insertion/#coercion-insertion\">reference</a> says</p>\n<blockquote>\n<p>Coercion insertion is attempted in the following situations where an error would otherwise occur:<br>\n- The expected type for a term is not equal to the type found for the term.</p>\n</blockquote>\n<p>Is this not totally accurate? At least my interpretation is that it should trigger in your described case</p>",
        "id": 531318689,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753694826
    },
    {
        "content": "<p>There's no expected type here, that's the problem.</p>",
        "id": 531318760,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753694847
    },
    {
        "content": "<p>Ah! I see, thanks that clears things up.</p>",
        "id": 531318837,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753694867
    },
    {
        "content": "<p>you also want <code>attribute [coe] WrappedList.wrap</code></p>",
        "id": 531318925,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753694893
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531316807\">said</a>:</p>\n<blockquote>\n<p>Ok, then please don't say things like this:<br>\nYa√´l Dillies <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531307425\">said</a>:</p>\n<blockquote>\n<p>Please don't use <code>abbrev</code> anymore. [...] one should instead use¬†<code>@[reducible] def</code></p>\n</blockquote>\n<p>That seems like a clear deprecation to me.</p>\n</blockquote>\n<p>Apologies, I took the <code>abbrev</code> news from Bhavik/Edison a bit too uncritically, and I thought that the worst thing that could happen was that you would look up the source code to disprove me</p>",
        "id": 531321462,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753695652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/stream/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531307951\">said</a>:</p>\n<blockquote>\n<p>Very unminimised, but <span class=\"user-mention silent\" data-user-id=\"699016\">Edison Xie</span>'s repo <a href=\"https://github.com/Whysoserioushah/BrauerGroup_new\">https://github.com/Whysoserioushah/BrauerGroup_new</a> got much faster once we replaced <code>abbrev</code> with <code>@[reducible] def</code>. I believe <span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> was the one teaching this to us.</p>\n</blockquote>\n<p>I‚Äôm already an expert in making things slow and thanks to you and Bhavik I‚Äôm on my way to become an expert to make things fast! :))</p>",
        "id": 531383435,
        "sender_full_name": "Edison Xie",
        "timestamp": 1753712479
    },
    {
        "content": "<p>What I think I said to Ya√´l and Edison is that <code>abbrev</code> often does things which I think are undesirable, and so I personally don't use it. <br>\nThe case which is somewhat related to reduction (but I don't think is just because of reduction) happened with determinants in sphere packing, see <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMB0ARFJHAJQFMl0cAhJAZ2AGMAoUSWRFDbHAGWADtyUAILoA5qSxQiyGFGAAPfKRikoIAUn4xqdRkyYA3JPKRZ0pOAG9icAFxwAKgE8wpAFQBfAwBNSAMzgAUQAOWXkFOAAKWwcXN3cASjgAbQAxYFJ0HzhiAF17DjlFaIz+OBDkqLKK5NiAXjgARgM0UmhSEGCwlAiAfT8YPtIARz6IQWjYp1cPZPTM7NyClIA5UgAtNQhogCZC4kSChyjQ8JLDnEG4Rqb7RqxnJjg4WmgoJ6YLEBAkOFVaPATmdeiVALiEiSuKhuzXu3XOCgGKmGYwmljBTCAA\">example 1</a> and <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOBuSUwSW6ApnAN4BKcAXHACoCeY5AVAL54Am5AMzgBRABzIYxAB5wAFHUat2HAJRwA2gDFg5dLzg0Aug0Qppc7QDs4otbKs21CgLxwAhG/U44PuACYAGl8ABiCfUJCwuAjwqJjogG5vHwBaAEYojMjs2JzouKTffNSsn1Li3MqKxOSqmPTMuKa84MKW5rgG33L43ra6joqussHW2ure0bDhuB62v0BvAgBOoMWV/2XVzY31ta3d5cM8NHJochARcTNgKQB9fhhb8gBHW4hLSnkTJU41LR09AZjOoAHLkABa5CgEDkfhMNBUxkYsjEEnMCIAdA84K40gxXFgWMkAM7QKBEnCWd4AYwg4AArjBSBQ4PwhGIAEJIYnAYlyBTMNi/DTaXT6IwaMGQ6Gw+GIkwICC8ekUDFcnl8+zAay2AwWbU2OCAJMIDGp6M5korlar1byMSAANZyfD4uSo64yTHQgDualJUHJcH95LwFBAICQcAgAluWG5vKerwjkhuIoB4uBAGFUERpTCJYw0TcMdG3aJbXyETjLkXPa7CSTQGAo5Z0CwNJz48SglaVeQ1V2MbTyLdHUcfFABOg8BB2NYEORufSoOQmKhToHwQBlMBISx4FAprCMyjqFLa4lMyzU8jGGiL9BDukgGjagDmcG1OBOZwunY1tz4BA6D0iAlCMEBIFgXIAj0pYvBIGBlhMugAAidJIAaKLll2cCALiEKhqLi9bttSSDoNS4yQaBnywfBiHkMh5HoRGWH/ry+GEdWwggiC97kSWAj8egcC3CRcBQN6GjUWBtx0QhSEoSxmGWOOvhia4PF8Q+gnCXAAA+tZYuQ8DYbWnH6eJkkaNGsZdomo4empPgaSIvHCbpD4GWklnmnADZFD4tKWG+UBuP44w+OQUhINS8DuimdwPA57yUHh4yuXifmEkGTY4EAA\">example 2</a>, where in both cases <code>abbrev</code> doesn't work but changing <code>Matrix.det</code> to a reducible inline def did work (if I remember correctly).<br>\nThe other case, which is what I think the A -&gt; B and B -&gt; A bit is referring to, was in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26494\">#26494</a>, where inference was working \"backwards\" (in my eyes) to get a TopologicalSpace instance using Scott in a case where Scott was never mentioned. Note this is now fixed in mathlib4 master, so you'll need to look at an earlier version to reproduce</p>",
        "id": 531400064,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753716818
    },
    {
        "content": "<p>On the second one, to quote from DMs with Sebastian Ullrich:</p>\n<blockquote>\n<p>Bhavik Mehta: I observed recently that we sometimes end up with an instance getting applied on X if that instance exists for F X, where F X is an abbrev type synonym for X, and leads to what I think is confusing/unintended behaviour in mathlib, eg <a href=\"https://github.com/leanprover-community/mathlib4/pull/26494\">#26494</a>. Is this expected behaviour of abbrev? More specifically, given <code>abbrev Scott (X : Type*) := X</code>, and <code>instance : TopologicalSpace (Scott X) := ...</code>, is it expected that <code>TopologicalSpace X</code> is synthesised by the scott version?</p>\n<p>Sebastian Ullrich: Yes, that's expected. It is how the normalized indexing for instance lookup works/must work. </p>\n</blockquote>\n<p>In the space of a week, Ya√´l and I found three independent projects which were unintentionally using this instance, and therefore had false sorries!</p>",
        "id": 531400619,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753716998
    },
    {
        "content": "<p>Well <code>Scott</code> should never have been an <code>abbrev</code></p>",
        "id": 531400959,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753717105
    },
    {
        "content": "<p>Sure, that's why the fix here was to remove Scott rather than change the behaviour of abbrev wrt typeclass search. (We have WithScott which correctly handles it instead) But the behaviour was still surprising to me</p>",
        "id": 531401170,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753717178
    },
    {
        "content": "<p>Wait, that rings a bell! <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Bug.20in.20instance.20synthesis.3F/near/529889141\">#mathlib4 &gt; Bug in instance synthesis? @ üí¨</a></p>",
        "id": 531402668,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1753717613
    },
    {
        "content": "<p>I think that's different still actually, since that's about why <code>def</code> is also not good for type synonyms, whereas this is about why <code>abbrev</code> is not good for type synonyms</p>",
        "id": 531402842,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753717663
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531402842\">said</a>:</p>\n<blockquote>\n<p>this is about why <code>abbrev</code> is not good for type synonyms</p>\n</blockquote>\n<p>I'm not understanding why it's not good for type synonyms? This <code>Scott</code> example shows that typeclass instance sees directly through the abbreviation, so it's a perfect synonym, and it shouldn't have been a synonym. It's like <code>type</code> in Haskell.</p>\n<p>The other thread is that <code>def</code> is actually not enough like Haskell's <code>newtype</code>.</p>",
        "id": 531407790,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753719057
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531407790\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531402842\">said</a>:</p>\n<blockquote>\n<p>this is about why <code>abbrev</code> is not good for type synonyms</p>\n</blockquote>\n<p>I'm not understanding why it's not good for type synonyms? This <code>Scott</code> example shows that typeclass instance sees directly through the abbreviation, so it's a perfect synonym, and it shouldn't have been a synonym. It's like <code>type</code> in Haskell.</p>\n</blockquote>\n<p>\"not good\" was too strong, you're right. All I mean is that it's surprising to me that <code>Scott</code> got introduced in a situation where it wasn't mentioned at all, and that this (in combination with the bad synonym in mathlib) ended up being a footgun for beginners</p>",
        "id": 531408964,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753719452
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531400064\">said</a>:</p>\n<blockquote>\n<p>see <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMB0ARFJHAJQFMl0cAhJAZ2AGMAoUSWRFDbHAGWADtyUAILoA5qSxQiyGFGAAPfKRikoIAUn4xqdRkyYA3JPKRZ0pOAG9icAFxwAKgE8wpAFQBfAwBNSAMzgAUQAOWXkFOAAKWwcXN3cASjgAbQAxYFJ0HzhiAF17DjlFaIz+OBDkqLKK5NiAXjgARgM0UmhSEGCwlAiAfT8YPtIARz6IQWjYp1cPZPTM7NyClIA5UgAtNQhogCZC4kSChyjQ8JLDnEG4Rqb7RqxnJjg4WmgoJ6YLEBAkOFVaPATmdeiVALiEiSuKhuzXu3XOCgGKmGYwmljBTCAA\">example 1</a> and <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOBuSUwSW6ApnAN4BKcAXHACoCeY5AVAL54Am5AMzgBRABzIYxAB5wAFHUat2HAJRwA2gDFg5dLzg0Aug0Qppc7QDs4otbKs21CgLxwAhG/U44PuACYAGl8ABiCfUJCwuAjwqJjogG5vHwBaAEYojMjs2JzouKTffNSsn1Li3MqKxOSqmPTMuKa84MKW5rgG33L43ra6joqussHW2ure0bDhuB62v0BvAgBOoMWV/2XVzY31ta3d5cM8NHJochARcTNgKQB9fhhb8gBHW4hLSnkTJU41LR09AZjOoAHLkABa5CgEDkfhMNBUxkYsjEEnMCIAdA84K40gxXFgWMkAM7QKBEnCWd4AYwg4AArjBSBQ4PwhGIAEJIYnAYlyBTMNi/DTaXT6IwaMGQ6Gw+GIkwICC8ekUDFcnl8+zAay2AwWbU2OCAJMIDGp6M5korlar1byMSAANZyfD4uSo64yTHQgDualJUHJcH95LwFBAICQcAgAluWG5vKerwjkhuIoB4uBAGFUERpTCJYw0TcMdG3aJbXyETjLkXPa7CSTQGAo5Z0CwNJz48SglaVeQ1V2MbTyLdHUcfFABOg8BB2NYEORufSoOQmKhToHwQBlMBISx4FAprCMyjqFLa4lMyzU8jGGiL9BDukgGjagDmcG1OBOZwunY1tz4BA6D0iAlCMEBIFgXIAj0pYvBIGBlhMugAAidJIAaKLll2cCALiEKhqLi9bttSSDoNS4yQaBnywfBiHkMh5HoRGWH/ry+GEdWwggiC97kSWAj8egcC3CRcBQN6GjUWBtx0QhSEoSxmGWOOvhia4PF8Q+gnCXAAA+tZYuQ8DYbWnH6eJkkaNGsZdomo4empPgaSIvHCbpD4GWklnmnADZFD4tKWG+UBuP44w+OQUhINS8DuimdwPA57yUHh4yuXifmEkGTY4EAA\">example 2</a>,</p>\n</blockquote>\n<p>Can you help me interpret these? What needs to be <code>@[reducible] def</code> instead of an <code>abbrev</code>?</p>",
        "id": 531409110,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753719501
    },
    {
        "content": "<p>Matrix.det needed to be a reducible def rather than an abbrev</p>",
        "id": 531409161,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753719516
    },
    {
        "content": "<p>Why is <code>Matrix.det</code> reducible at all?</p>",
        "id": 531409409,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753719597
    },
    {
        "content": "<p>After seeing these examples, I agree it shouldn't be :)</p>",
        "id": 531409474,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753719618
    },
    {
        "content": "<p>I'm surprised though that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">det</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">detRowAlternating</span><span class=\"w\"> </span><span class=\"n\">M</span>\n</code></pre></div>\n<p>could cause any troubles. The <code>detRowAlternating</code> function isn't reducible, so it seems like it's a straightforward sort of abbreviation.</p>",
        "id": 531409636,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753719668
    },
    {
        "content": "<p>I spent quite a bit of time discussing very similar things with Sebastian a couple of weeks ago :) eg</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span>:</p>\n<blockquote>\n<p>Here is a question that may have very subjective answers: after looking at the output of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">det</span>\n</code></pre></div>\n<p>would you say that Mathlib is correct in making <code>det</code> an abbrev? :)</p>\n</blockquote>",
        "id": 531409947,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753719762
    },
    {
        "content": "<p>In the second example, I also tried</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">allowUnsafeReducibility</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">semireducible</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">det</span><span class=\"w\"> </span><span class=\"k\">in</span>\n</code></pre></div>\n<p>before the theorem which gives a kernel error, but Sebastian told me </p>\n<blockquote>\n<p>Ah, this behavior is actually specific to¬†<code>abbrev</code>, not¬†<code>[reducible]</code><br>\nIt creates a¬†<code>ReducibilityHints.abbrev</code>¬†definition which cannot be adjusted after the fact<br>\nAnd this kind of hint is the only one shared by the elaborator and the kernel, which explains why both are affected</p>\n</blockquote>",
        "id": 531410728,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753720013
    },
    {
        "content": "<p>(cc <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>. I'm quoting directly to avoid accidentally spreading misinformation, but perhaps you can explain better than I can)</p>",
        "id": 531410855,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753720053
    },
    {
        "content": "<p>Oh and the conclusion of the discussion:</p>\n<blockquote>\n<p>Bhavik Mehta: Is it your opinion that Matrix.det should be a <code>def</code> (or reducible def)? I expect mathlib will be okay with that if there isn't much fallout in mathlib as a consequence, but if lots of other things need to be changed then it might be trickier</p>\n<p>Sebastian Ullrich: Reducible def sounds like a good compromise to me, that should not break any code</p>\n</blockquote>",
        "id": 531411168,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753720139
    },
    {
        "content": "<p>(The <code>ReducibilityHints.abbrev</code> is definitely a property of <code>abbrev</code>s, and it's inside the definition's environment declaration itself. It's used inside defeq to decide, when you have two function applications, and no progress can be made without unfolding, which of the functions to unfold first.)</p>",
        "id": 531411359,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753720198
    },
    {
        "content": "<p>My interpretation is that that's what Ya√´l's</p>\n<blockquote>\n<p>It now has (or always had?) confusing reduction behavior, and one should instead use¬†<code>@[reducible] def</code></p>\n</blockquote>\n<p>was intending to say, but got mangled into something unhelpful because it was third- or fourth-hand information</p>",
        "id": 531411825,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753720342
    },
    {
        "content": "<p>Since I haven't seen it being mentioned explicitly yet: please note that there is no difference between <code>abbrev</code> and <code>@[reducible] def</code> in the \"backwards instance\" case</p>",
        "id": 531413039,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1753720767
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531400064\">schrieb</a>:</p>\n<blockquote>\n<p>see <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMB0ARFJHAJQFMl0cAhJAZ2AGMAoUSWRFDbHAGWADtyUAILoA5qSxQiyGFGAAPfKRikoIAUn4xqdRkyYA3JPKRZ0pOAG9icAFxwAKgE8wpAFQBfAwBNSAMzgAUQAOWXkFOAAKWwcXN3cASjgAbQAxYFJ0HzhiAF17DjlFaIz+OBDkqLKK5NiAXjgARgM0UmhSEGCwlAiAfT8YPtIARz6IQWjYp1cPZPTM7NyClIA5UgAtNQhogCZC4kSChyjQ8JLDnEG4Rqb7RqxnJjg4WmgoJ6YLEBAkOFVaPATmdeiVALiEiSuKhuzXu3XOCgGKmGYwmljBTCAA\">example 1</a> and <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOBuSUwSW6ApnAN4BKcAXHACoCeY5AVAL54Am5AMzgBRABzIYxAB5wAFHUat2HAJRwA2gDFg5dLzg0Aug0Qppc7QDs4otbKs21CgLxwAhG/U44PuACYAGl8ABiCfUJCwuAjwqJjogG5vHwBaAEYojMjs2JzouKTffNSsn1Li3MqKxOSqmPTMuKa84MKW5rgG33L43ra6joqussHW2ure0bDhuB62v0BvAgBOoMWV/2XVzY31ta3d5cM8NHJochARcTNgKQB9fhhb8gBHW4hLSnkTJU41LR09AZjOoAHLkABa5CgEDkfhMNBUxkYsjEEnMCIAdA84K40gxXFgWMkAM7QKBEnCWd4AYwg4AArjBSBQ4PwhGIAEJIYnAYlyBTMNi/DTaXT6IwaMGQ6Gw+GIkwICC8ekUDFcnl8+zAay2AwWbU2OCAJMIDGp6M5korlar1byMSAANZyfD4uSo64yTHQgDualJUHJcH95LwFBAICQcAgAluWG5vKerwjkhuIoB4uBAGFUERpTCJYw0TcMdG3aJbXyETjLkXPa7CSTQGAo5Z0CwNJz48SglaVeQ1V2MbTyLdHUcfFABOg8BB2NYEORufSoOQmKhToHwQBlMBISx4FAprCMyjqFLa4lMyzU8jGGiL9BDukgGjagDmcG1OBOZwunY1tz4BA6D0iAlCMEBIFgXIAj0pYvBIGBlhMugAAidJIAaKLll2cCALiEKhqLi9bttSSDoNS4yQaBnywfBiHkMh5HoRGWH/ry+GEdWwggiC97kSWAj8egcC3CRcBQN6GjUWBtx0QhSEoSxmGWOOvhia4PF8Q+gnCXAAA+tZYuQ8DYbWnH6eJkkaNGsZdomo4empPgaSIvHCbpD4GWklnmnADZFD4tKWG+UBuP44w+OQUhINS8DuimdwPA57yUHh4yuXifmEkGTY4EAA\">example 2</a></p>\n</blockquote>\n<p>I'm not sure if you can blame this on <code>abbrev</code>, really:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">Determinant</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">E8Matrix_det_eq_one</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">detRowAlternating</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">detRowAlternating</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">E8Matrix_det_eq_one</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span>\n</code></pre></div>\n<p>has the same problem</p>",
        "id": 531413101,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753720786
    },
    {
        "content": "<p>I think <code>abbrev</code> is really intuitive. It's what you do when you have some long term and you want to introduce an <em>abbrev</em>iation for it. So the <code>abbrev</code> will inherit all the typeclass instances on the original type, and <code>simp</code> will see through it, and if you put an instance on an <code>abbrev</code> then it will apply to the original type too.</p>",
        "id": 531413223,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753720824
    },
    {
        "content": "<p>Like notation but it also gives you a constant</p>",
        "id": 531413351,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753720868
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531413223\">said</a>:</p>\n<blockquote>\n<p><code>simp</code> will see through it</p>\n</blockquote>\n<p>I would argue that \"<code>simp</code> will see through it\" implies the first of these should succeed, but it doesn't</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">gcd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test_bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"bp\">¬¨</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">contextual</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test_no_bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">gcd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"bp\">¬¨</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">gcd</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">contextual</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 531414180,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753721153
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531413101\">said</a>:</p>\n<blockquote>\n<p>I'm not sure if you can blame this on <code>abbrev</code>, really:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">Determinant</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">E8Matrix_det_eq_one</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">detRowAlternating</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">detRowAlternating</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">E8Matrix_det_eq_one</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span>\n</code></pre></div>\n<p>has the same problem</p>\n</blockquote>\n<p>That's perhaps fair, although the fix for example 2 was to make a local version of Matrix.det which wasn't an abbrev, and then it goes through completely fine. Since making the single change of avoiding abbrev fixes it, I think it's not unreasonable to say <code>abbrev</code> was at fault</p>",
        "id": 531414506,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753721256
    },
    {
        "content": "<p>Was just about to mention that, see also <a href=\"https://github.com/leanprover/lean4/issues/5606#issue-2563872329\">this</a>. Abbrev is not really an abbreviation, at least not in the usual math or programming way</p>",
        "id": 531414527,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753721261
    },
    {
        "content": "<p>As a summary, is my following interpretation of abbrev correct?</p>\n<blockquote>\n<p><code>abbrev</code> is an abbreviation (i.e. writing the definition again in its place) except that:</p>\n<ul>\n<li>It creates a¬†<code>ReducibilityHints.abbrev</code>¬†definition which cannot be adjusted after the fact. This is used to decide, when you have two function applications, and no progress can be made without unfolding, which of the functions to unfold first.  (I'm not sure if this breaks <code>abbrev</code> being an abbreviation)</li>\n<li>Tactics may not always work as explained in the <a href=\"https://github.com/leanprover/lean4/issues/5606#issue-2563872329\">issue</a></li>\n</ul>\n</blockquote>",
        "id": 531416097,
        "sender_full_name": "Fernando Chu",
        "timestamp": 1753721798
    },
    {
        "content": "<p>It's possible that <a href=\"https://github.com/leanprover/lean4/pull/5606\">lean4#5606</a> could be reopened...</p>\n<p>We don't want <code>simp</code> to unfold every reducible definition, since the abbreviations are helpful to understand goal states. However, <code>simp</code> could <em>tentatively</em> unfold definitions, see whether or not the result simplifies any further, and if no progress is made, revert to the original term.</p>",
        "id": 531416719,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753722006
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531414506\">said</a>:</p>\n<blockquote>\n<p>I think it's not unreasonable to say <code>abbrev</code> was at fault</p>\n</blockquote>\n<p>Lean's a very complex system though, and while <code>abbrev</code> might be an ingredient (a proximal cause) it might not be what's at fault...</p>",
        "id": 531416917,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753722063
    },
    {
        "content": "<p>That's fair, if you have suggestions for other fixes here then I'd be very happy to hear them; I spent quite a lot of time on this and this is the only way I could find to make example 2 work</p>",
        "id": 531417115,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753722122
    },
    {
        "content": "<p>I think that it's reasonable having this <code>abbrev</code> -&gt; <code>@[reducible] def</code> trick in the toolbox of workarounds, and it's worth telling people about it, so long as it's clear that we're not really sure what it's working around precisely yet.</p>",
        "id": 531417400,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753722216
    },
    {
        "content": "<p>Isn't it precisely working around <code>ReducibilityHints.abbrev</code> as you mentioned?</p>",
        "id": 531417515,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753722251
    },
    {
        "content": "<p>No, I wouldn't say that. There seems to be something weird about these terms that triggers more unfolding than necessary.</p>\n<p>Analogue: let's say you find out that setting the priority of some instance to 100 fixes a problem. Would it make sense to say that priority 1000 is at fault? No, it's how the priorities interact with everything else in the whole collection of instances.</p>",
        "id": 531418048,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753722429
    },
    {
        "content": "<p><a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531413101\"><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span>'s example</a> suggests something is amiss, right? Why is the definition <code>Matrix.detRowAlternating</code> being unfolded at all?</p>\n<p>It seems significant that it's <code>‚Ñù</code> rather than a general field. Maybe there's an instance diamond? (Or a diamond in some weaker sense that causes defeq to decide the arguments aren't similar enough, triggering unfolding?)</p>",
        "id": 531418571,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753722604
    },
    {
        "content": "<p>I agree it's significant; the particular specialisation of R to \\R is what seems to break it. My interpretation of this was that now the lhs is a closed term, and so reduction can fire at all, but that's just a guess</p>",
        "id": 531418863,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753722705
    },
    {
        "content": "<p>Note, as I mentioned before, that <code>attribute [-instance] Real.commRing in</code> fixes Robin's example, but not example 2</p>",
        "id": 531419097,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753722778
    },
    {
        "content": "<p>There's also some chance that the fact that <code>Matrix.detRowAlternating</code> is a funlike is breaking some of the elaborator's isdefeq heurstics. That could explain why having a semireducible <code>Matrix.det</code> would make it go through.</p>\n<p>The heuristic is \"for <code>f a1 ... an =?= f b1 ... bn</code>, see if <code>ai =?= bi</code> for each <code>i</code>. When there are higher-order things going on (like in DFunLike.coe) the logic is more complicated, and it could be hitting some bug or other limitation.</p>",
        "id": 531419958,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753723069
    },
    {
        "content": "<p>It looks like <code>attribute [-instance] Real.commRing</code> causes the expressions in Robin's example to be structurally equal, so defeq doesn't have to do any work. In particular, <code>Matrix.detRowAlternating (E8Matrix ‚Ñù) =?= Matrix.detRowAlternating (E8Matrix ‚Ñù)</code></p>",
        "id": 531420108,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753723137
    },
    {
        "content": "<p>This seems to be the most promising explanation at the moment. When it's an <code>abbrev</code>, then <code>DFunLike.coe Matrix.detRowAlternating</code> is exposed to defeq checks, and that's apparently <em>very</em> sensitive to some relevant arguments being only defeq.</p>\n<p>I don't know these defeq internals well enough though. It could also be that since <code>DFunLike.coe</code> is a class projection that the elaborator likes to reduce these.</p>",
        "id": 531421284,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753723483
    },
    {
        "content": "<p>That doesn't explain the second example though right, since there it's a kernel problem rather than an elaborator problem?</p>",
        "id": 531424009,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753724379
    },
    {
        "content": "<p>You're right, the second example succeeds with <code>set_option debug.skipKernelTC true</code>.</p>",
        "id": 531424803,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753724664
    },
    {
        "content": "<p>The heuristics between the kernel and elaborator might be a bit different though. It could be a similar phenomenon, but it's unclear.</p>",
        "id": 531425054,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753724749
    },
    {
        "content": "<p>In the kernel, <code>lazy_delta_reduction_step</code> prefers unfolding projections (and skips the are-the-arguments-defeq heuristic), so it could still be that <code>DFunLike.coe</code> explains it to some degree.</p>",
        "id": 531425755,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753724982
    },
    {
        "content": "<p>I'll note something that <span class=\"user-mention\" data-user-id=\"311453\">@Fr√©d√©ric Dupuis</span> and I observed related to this \"backwards instance\" problem:<br>\n<span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531400064\">said</a>:</p>\n<blockquote>\n<p>The other case, which is what I think the A -&gt; B and B -&gt; A bit is referring to, was in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26494\">#26494</a>, where inference was working \"backwards\" (in my eyes) to get a TopologicalSpace instance using Scott in a case where Scott was never mentioned.</p>\n</blockquote>\n<p>We needed to create a type synyonym for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Matrix#doc\">docs#Matrix</a> which is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CStarMatrix#doc\">docs#CStarMatrix</a>. This is just <code>Matrix</code> with a new norm. The norm is defined by action on vectors with entries in a C‚ãÜ-algebra. Originally, we had tried using <code>abbrev</code>, but we also experienced a situation in the middle of a proof where a term of type <code>Matrix</code> picked up the instance from <code>CStarMatrix</code>. So, we had to resort to a <code>def</code> synonym at default transparency (although now <a href=\"https://github.com/leanprover/lean4/pull/9077\">lean4#9077</a> even makes <em>that</em> choice suspect, which is very frightening).</p>\n<p>The issue with using default transparency, of course, is that every algebraic <code>Matrix</code> operation we need must be ported to the new type (and there are a hell of a lot). If we use one-field <code>structures</code>, this would be even more painful I suspect.</p>",
        "id": 531427157,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1753725426
    },
    {
        "content": "<p>I was hoping that pulling the toFun definition out like this would be a fix:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">alternatization</span><span class=\"bp\">.</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MultilinearMap</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">N'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚ãÄ^</span><span class=\"n\">Œπ</span><span class=\"o\">]</span><span class=\"bp\">‚Üí‚Çó</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">‚àë</span><span class=\"w\"> </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">sign</span><span class=\"w\"> </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">domDomCongr</span><span class=\"w\"> </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚áë</span><span class=\"o\">(</span><span class=\"bp\">‚àë</span><span class=\"w\"> </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">sign</span><span class=\"w\"> </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">domDomCongr</span><span class=\"w\"> </span><span class=\"n\">œÉ</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">map_eq_zero_of_eq'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">hvij</span><span class=\"w\"> </span><span class=\"n\">hij</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">alternization_map_eq_zero_of_eq_aux</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">hij</span><span class=\"w\"> </span><span class=\"n\">hvij</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"sd\">/-- Produce an `AlternatingMap` out of a `MultilinearMap`, by summing over all argument</span>\n<span class=\"sd\">permutations. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">alternatization</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MultilinearMap</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">N'</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚ãÄ^</span><span class=\"n\">Œπ</span><span class=\"o\">]</span><span class=\"bp\">‚Üí‚Çó</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N'</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">alternatization</span><span class=\"bp\">.</span><span class=\"n\">f</span>\n<span class=\"w\">  </span><span class=\"n\">map_add'</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">ext</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mk_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AlternatingMap</span><span class=\"bp\">.</span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sum_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">smul_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">domDomCongr_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_apply</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">smul_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_add_distrib</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AlternatingMap</span><span class=\"bp\">.</span><span class=\"n\">add_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">alternatization</span><span class=\"bp\">.</span><span class=\"n\">f</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">map_zero'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">ext</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mk_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AlternatingMap</span><span class=\"bp\">.</span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sum_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">smul_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">domDomCongr_apply</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">zero_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">smul_zero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_const_zero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AlternatingMap</span><span class=\"bp\">.</span><span class=\"n\">zero_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">alternatization</span><span class=\"bp\">.</span><span class=\"n\">f</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>but it seems that the default <code>ProjReductionKind.yesWithDelta</code> somehow causes this to still unfold <code>alternatization.f</code> unnecessarily (or at least, changing this option prevents the unfolding from happing in some way!)</p>\n<p>Setting this to <code>ProjReductionKind.no</code> or <code>.yes</code> prevents it from being unfolded. The following even works without any changes to <code>alternatization</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">Determinant</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"foo \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">expectedType?</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">withConfig</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">proj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">yes</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">expectedType?</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">E8Matrix_det_eq_one</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">detRowAlternating</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">debug</span><span class=\"bp\">.</span><span class=\"n\">skipKernelTC</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">detRowAlternating</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E8Matrix</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E8Matrix_det_eq_one</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>(the <code>id</code> is to make sure that the defeq is definitely done within the scope of <code>foo</code>)</p>",
        "id": 531431130,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1753726780
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531427157\">said</a>:</p>\n<blockquote>\n<p>The issue with using default transparency, of course, is that every algebraic <code>Matrix</code> operation we need must be ported to the new type (and there are a hell of a lot). If we use one-field <code>structures</code>, this would be even more painful I suspect.</p>\n</blockquote>\n<p>I wonder if we should try to introduce some automation to make the one-field structure instance copying easier, generalizing the existing <code>deriving</code> machinery</p>",
        "id": 531436905,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753728875
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531424803\">said</a>:</p>\n<blockquote>\n<p>You're right, the second example succeeds with <code>set_option debug.skipKernelTC true</code>.</p>\n</blockquote>\n<p>It may be the case that the first and second examples have different root causes. The second is closer to the actual case that showed up, and the first was my first attempt at minimising, except I think I over-minimised; since the instance change solves the first and not the second. They're both solved by changing Matrix.det to a def, but as you say this might not be the true cause</p>",
        "id": 531437352,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1753729050
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/113489-new-members/topic/Use.20typeclasses.20of.20coerced.20type.3F/near/531436905\">said</a>:</p>\n<blockquote>\n<p>I wonder if we should try to introduce some automation to make the one-field structure instance copying easier, generalizing the existing <code>deriving</code> machinery</p>\n</blockquote>\n<p>I think that's a good idea in general, but it would have to be quite sophisticated to copy over all the relevant bits of <code>Matrix</code>.</p>",
        "id": 531452704,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1753733336
    }
]