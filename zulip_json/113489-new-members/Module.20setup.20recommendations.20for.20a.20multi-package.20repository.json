[
    {
        "content": "<p>Hi! I’m considering adopting <a href=\"https://lean-lang.org/doc/reference/latest/Source-Files-and-Modules/\">the module system</a> for <a href=\"https://github.com/pandaman64/lean-regex\">lean-regex</a>, but the setup is a bit unusual, so I’d appreciate some advice.</p>\n<p>The repository currently contains multiple Lake packages:</p>\n<ul>\n<li><code>regex</code>: the main implementation, with no dependencies</li>\n<li><code>correctness</code>: depends on <code>regex</code> and Mathlib, and proves theorems about the implementation</li>\n<li>(<code>docbuild</code> also exists for documentation, but it’s not relevant here)</li>\n</ul>\n<p>My main constraints are:</p>\n<ul>\n<li>I don’t want <code>regex</code> to depend on Mathlib. Lean projects that use it purely as a programming language shouldn’t need Mathlib just to use regex. Ideally, it should even be possible for Mathlib to depend on <code>lean-regex</code> (e.g. for linters).</li>\n<li>The <code>correctness</code> package is expected to rely on the exact implementation details of <code>regex</code>. Breakages are acceptable, since I can update both packages in a single PR.</li>\n</ul>\n<p>Given this setup, it seems that I would effectively need to expose all definitions from <code>regex</code>. If that’s the case, is there still a benefit to adopting the module system?</p>\n<p>An alternative I’m considering is moving equalities that characterizes <code>regex</code> definitions into <code>regex</code> instead of <code>correctness</code> (<a href=\"https://github.com/pandaman64/lean-regex/blob/70af08353b5604b56b2b8f99e626b2c2dc0111eb/correctness/RegexCorrectness/VM/EpsilonClosure/Basic.lean#L144\">example</a>). I'm curious if it's a clearer design.</p>\n<p>I'd appreciate any suggestions or experience with similar setups. Thanks!</p>",
        "id": 576007920,
        "sender_full_name": "pandaman",
        "timestamp": 1772108326
    },
    {
        "content": "<p>You can also not expose the definitions but use <code>import all</code> in <code>correctness</code>. This used to be disallowed but it should be possible now.</p>",
        "id": 576009769,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772108939
    },
    {
        "content": "<p>Just to confirm, are you suggesting allowImportAll?<br>\n<a href=\"https://lean-lang.org/doc/reference/latest/Build-Tools-and-Distribution/Lake/#Lake___PackageConfig-allowImportAll\">https://lean-lang.org/doc/reference/latest/Build-Tools-and-Distribution/Lake/#Lake___PackageConfig-allowImportAll</a></p>",
        "id": 576012444,
        "sender_full_name": "pandaman",
        "timestamp": 1772109780
    },
    {
        "content": "<p>I don't think you need anything, see <a href=\"https://github.com/leanprover/lean4/pull/12045\">lean4#12045</a>; unless I missed a more recent change?</p>",
        "id": 576014861,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772110438
    },
    {
        "content": "<p>Nice!</p>\n<p>Progress: I started the porting but I cannot access <code>String.singleton_append_inj</code> in v4.28.0 for some reason. v4.29.0-rc2 seems fine, so it might be that I just need to wait for a few days.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"c1\">-- comment out to make the following pass</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">singleton_append_inj</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">versionString</span>\n</code></pre></div>",
        "id": 576380960,
        "sender_full_name": "pandaman",
        "timestamp": 1772245841
    },
    {
        "content": "<p>You can also <code>public import Init.Data.String.Lemmas.Basic</code> in the meanwhile but yeah, it seems like the <a href=\"https://github.com/leanprover/lean4/blob/master/tests/elab/importStructure.lean\">orphaned modules checker</a> doesn't account for the module system</p>",
        "id": 576413045,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772275771
    }
]