[
    {
        "content": "<p>I roughly understand what these do:</p>\n<ul>\n<li><code>refine</code> is like a more general version of <code>apply</code> / <code>exact</code> / <code>use</code></li>\n<li><code>_</code> is like \"try to fill this in using inference\"</li>\n<li><code>?_</code> is like \"let me fill this in later as a goal\"</li>\n</ul>\n<p>However whenever I try to use them I tend to get a mess in the tactic state and give up. I'm not sure why that is (and unfortunately I don't have a ready example at the moment).</p>\n<p>But I was wondering if there's a good crash course showing <em>canonical</em> examples for using them. I mean, like, literal two or three-liners that show \"before\" and \"after\" so that I can get a good intuition for <em>when</em> I'd want to reach for them. Right now I don't have an intuition for <em>when</em> they're most useful, so I end up not using them, and I feel like at this point it's a disadvantage for me.</p>\n<p>Thanks!</p>",
        "id": 503701748,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1741239789
    },
    {
        "content": "<p>I guess it would also be helpful to understand what they <em>cannot</em> do. For example in which case is <code>_</code> placeholder possible to fill in? Also, where to look for documentation for these questions? It's very hard to google.</p>",
        "id": 503702079,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1741239931
    },
    {
        "content": "<p>Also, which of these are compatible with which ones? E.g. is <code>_</code> only usable with <code>refine</code> or also with <code>apply</code>? How about with <code>exact</code>? Is it usable with everything? What about <code>?_</code>?</p>",
        "id": 503702301,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1741240025
    },
    {
        "content": "<p>Also, is it possible to express <code>use</code> / <code>exact</code> / <code>apply</code> in terms of <code>refine</code>? I.e. do they \"desugar\" to <code>refine</code>? If yes, is this documented anywhere? It would be nice to not have to guess. I've seen <a href=\"https://www.ma.imperial.ac.uk/~buzzard/xena/formalising-mathematics-2023/Part_C/tactics/refine.html\">this documentation</a> but it doesn't give a clear complete picture, just a patchwork of concrete cases.</p>",
        "id": 503702456,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1741240083
    },
    {
        "content": "<p>I would say that a <em>terminal</em> <code>refine</code> is almost the same as <code>exact</code>.  If I remember correctly, there are situations where they cannot be replaced by one another, but they are \"rare\".</p>",
        "id": 503703192,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741240304
    },
    {
        "content": "<p><code>apply</code> and <code>refine</code> are also close, but <code>refine</code> requires every explicit argument to be marked as <code>_</code> or <code>?_</code>, while <code>apply</code> tries to be more independent.</p>",
        "id": 503703396,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741240386
    },
    {
        "content": "<p>This comes with a cost, though: <code>refine</code> uses the type of the goal to unify, while <code>apply</code> tries on its own and then performs a check.</p>",
        "id": 503703496,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741240438
    },
    {
        "content": "<p>This leads to somewhat more common situations where one of <code>apply</code> or <code>refine</code> works, but not the other.</p>",
        "id": 503703585,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741240469
    },
    {
        "content": "<p>Finally, <code>use x</code> is pretty similar to <code>refine \\&lt;x, ?_\\&gt;</code>, though <code>use</code> tries a (very) little to solve the trivial leftover goal.</p>",
        "id": 503703734,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741240552
    },
    {
        "content": "<p>In general, it is almost never the case that two tactics can be replaced for one another: there are usually situations where one works but the other does not.</p>",
        "id": 503703846,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741240597
    },
    {
        "content": "<p>About <code>_</code> and <code>?_</code>: <a href=\"https://lean-lang.org/doc/reference/latest/Terms/Holes/#The-Lean-Language-Reference--Terms--Holes\">https://lean-lang.org/doc/reference/latest/Terms/Holes/#The-Lean-Language-Reference--Terms--Holes</a></p>\n<p>About <code>refine</code>: <a href=\"https://lean-lang.org/doc/reference/latest/Tactic-Proofs/Tactic-Reference/#refine\">https://lean-lang.org/doc/reference/latest/Tactic-Proofs/Tactic-Reference/#refine</a></p>\n<p>There are certainly more expert users of refine here who may chime in, but I find it's very useful when you know the general structure of a proof and want to set up a sketch of it with the missing pieces marked as holes, or when you just want to be sure you're even going in the right direction (\"does <code>refine x ?_ y ?_ z ?_ ?_</code> work here as long as I can eventually fill in the holes or am I getting a type error\", that kind of thing).</p>\n<p>Very contrived example, but maybe illustrative if you imagine the principles applied to a more complex problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"bp\">⟨?</span><span class=\"n\">mp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">mpr</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  The state after refine tells you the remaining cases /obligations:</span>\n<span class=\"cm\">    case mp</span>\n<span class=\"cm\">    p q r : Prop</span>\n<span class=\"cm\">    h1 : p → q</span>\n<span class=\"cm\">    h2 : q → p</span>\n<span class=\"cm\">    ⊢ p → q</span>\n<span class=\"cm\">    case mpr</span>\n<span class=\"cm\">    p q r : Prop</span>\n<span class=\"cm\">    h1 : p → q</span>\n<span class=\"cm\">    h2 : q → p</span>\n<span class=\"cm\">    ⊢ q → p</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">assumption</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">assumption</span>\n</code></pre></div>",
        "id": 503707222,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1741241859
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/113489-new-members/topic/What.20are.20canonical.20examples.20for.20refine.2C.20_.2C.20.3F_/near/503703734\">said</a>:</p>\n<blockquote>\n<p>Finally, <code>use x</code> is pretty similar to <code>refine \\&lt;x, ?_\\&gt;</code>, though <code>use</code> tries a (very) little to solve the trivial leftover goal.</p>\n</blockquote>\n<p>It's a bit more complicated than that — <code>use a, b, c</code> is like doing <code>exact a; exact b; exact c</code> with at most one <code>constructor</code> before and between the <code>exact</code>s, and then it does something like <code>try trivial</code> on remaining goals. The <code>use!</code> tactic modifies the strategy, where it can use <code>constructor</code> more than once.</p>",
        "id": 503718074,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741245718
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418569\">@Dan Abramov</span> I think the best source here might be to grep mathlib for these tactics and move your cursor around to inspect the before/after states. You'll see the patterns I think.</p>",
        "id": 503718485,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741245835
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"418569\">Dan Abramov</span> <a href=\"#narrow/channel/113489-new-members/topic/What.20are.20canonical.20examples.20for.20refine.2C.20_.2C.20.3F_/near/503702456\">said</a>:</p>\n<blockquote>\n<p>is it possible to express <code>use</code> / <code>exact</code> / <code>apply</code> in terms of <code>refine</code></p>\n</blockquote>\n<p>Yes, and furthermore, pretty much every tactic can be rewritten as <code>refine</code> in some way. Not a fixed <code>refine</code> of course, since tactics generally look at the local context and the goal to decide how to proceed, but there's <em>some</em> term you can use with <code>refine</code>.</p>\n<p><code>constructor</code>/<code>use</code> are similar, and are like using <code>refine</code> with an appropriate constructor expression with <code>?_</code>'s per constructor field.</p>\n<p>I see you noticed that <code>_</code> works with <code>apply</code>. I personally think this is an oversight, but it's hard to fix at the moment. Only <code>?_</code> is really meant to be the way you create new goals. (The oversight is that <code>apply</code> turns all unassigned placeholders (\"metavariables\") into new goals.) </p>\n<p>The relationship between <code>exact</code> and <code>refine</code> is that <code>exact</code> must close the goal.</p>",
        "id": 503719646,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741246159
    }
]