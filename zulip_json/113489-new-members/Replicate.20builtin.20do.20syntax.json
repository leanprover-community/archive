[
    {
        "content": "<p>Hi all. Trying to understand how to create intrusive DSL with Lean4. Want to create syntax that replicate 'do' builtin syntax into more lightweight 'mm'. My try was:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">prelude</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Category</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmElem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Category</span>\n\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">registerBuiltinParserAttribute</span><span class=\"w\"> </span><span class=\"ss\">`builtin_mmElem_parser</span><span class=\"w\"> </span><span class=\"ss\">``Category.mmElem</span>\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">registerBuiltinDynamicParserAttribute</span><span class=\"w\"> </span><span class=\"ss\">`mmElem_parser</span><span class=\"w\"> </span><span class=\"ss\">`mmElem</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmElemParser</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rbp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">categoryParser</span><span class=\"w\"> </span><span class=\"ss\">`mmElem</span><span class=\"w\"> </span><span class=\"n\">rbp</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeqItem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span>\n<span class=\"w\">  </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">mmElemParser</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">optional</span><span class=\"w\"> </span><span class=\"s2\">\"; \"</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeqIndent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span>\n<span class=\"w\">  </span><span class=\"n\">many1Indent</span><span class=\"w\"> </span><span class=\"n\">mmSeqItem</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeqBracketed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span>\n<span class=\"w\">  </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">withoutPosition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">many1</span><span class=\"w\"> </span><span class=\"n\">mmSeqItem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span>\n<span class=\"kd\">@[</span><span class=\"n\">builtin_doc</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withAntiquot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAntiquot</span><span class=\"w\"> </span><span class=\"s2\">\"mmSeq\"</span><span class=\"w\"> </span><span class=\"n\">decl_name</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isPseudoKind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">    </span><span class=\"n\">mmSeqBracketed</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">mmSeqIndent</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">run_builtin_parser_attribute_hooks</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span>\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">register_parser_alias</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">builtin_mmElem_parser</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmReturn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span><span class=\"o\">:</span><span class=\"n\">leadPrec</span>\n<span class=\"w\">  </span><span class=\"n\">withPosition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"return\"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">optional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ppSpace</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">checkLineEq</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">termParser</span><span class=\"o\">))</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">builtin_term_parser</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">mm</span><span class=\"bp\">»</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span><span class=\"o\">:</span><span class=\"n\">argPrec</span>\n<span class=\"w\">  </span><span class=\"n\">ppAllowUngrouped</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"mm \"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">builtin_term_parser</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">termReturn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span><span class=\"o\">:</span><span class=\"n\">leadPrec</span>\n<span class=\"w\">  </span><span class=\"n\">withPosition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"return\"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">optional</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ppSpace</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">checkLineEq</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">termParser</span><span class=\"o\">))</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n</code></pre></div>\n<p>But that not worked with error \"<code>unknown attribute [builtin_mmElem_parser]</code>\" on latest Lean 4.13.0. Is that doable? Appreciate some guidance from knowledgeables here.</p>",
        "id": 484143524,
        "sender_full_name": "Alex M",
        "timestamp": 1732446828
    },
    {
        "content": "<p>Have you read Metaprogramming in Lean? In particular <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/08_dsls.html\">https://leanprover-community.github.io/lean4-metaprogramming-book/main/08_dsls.html</a> should be helpful. I don't think you're supposed to use the <code>@[builtin_</code>... attributes, those are for builtin parts of Lean itself</p>",
        "id": 484147007,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1732450077
    },
    {
        "content": "<p>Thank you for reply.</p>\n<p>Ok, may be <code>@[builtin..</code> attributes not for users, but if i get rid of failing attribute <code>mm</code> not considered anyway by Lean. That not worked:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">prelude</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Category</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmElem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Category</span>\n\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">registerBuiltinParserAttribute</span><span class=\"w\"> </span><span class=\"ss\">`builtin_mmElem_parser</span><span class=\"w\"> </span><span class=\"ss\">``Category.mmElem</span>\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">registerBuiltinDynamicParserAttribute</span><span class=\"w\"> </span><span class=\"ss\">`mmElem_parser</span><span class=\"w\"> </span><span class=\"ss\">`mmElem</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inline</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmElemParser</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rbp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">categoryParser</span><span class=\"w\"> </span><span class=\"ss\">`mmElem</span><span class=\"w\"> </span><span class=\"n\">rbp</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeqItem</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span>\n<span class=\"w\">  </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">mmElemParser</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">optional</span><span class=\"w\"> </span><span class=\"s2\">\"; \"</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeqIndent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span>\n<span class=\"w\">  </span><span class=\"n\">many1Indent</span><span class=\"w\"> </span><span class=\"n\">mmSeqItem</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeqBracketed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span>\n<span class=\"w\">  </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">withoutPosition</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">many1</span><span class=\"w\"> </span><span class=\"n\">mmSeqItem</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span>\n<span class=\"kd\">@[</span><span class=\"n\">builtin_doc</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withAntiquot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAntiquot</span><span class=\"w\"> </span><span class=\"s2\">\"mmSeq\"</span><span class=\"w\"> </span><span class=\"n\">decl_name</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isPseudoKind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">    </span><span class=\"n\">mmSeqBracketed</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">mmSeqIndent</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">run_builtin_parser_attribute_hooks</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span>\n<span class=\"n\">builtin_initialize</span><span class=\"w\"> </span><span class=\"n\">register_parser_alias</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">builtin_term_parser</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">mm</span><span class=\"bp\">»</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span><span class=\"o\">:</span><span class=\"n\">argPrec</span>\n<span class=\"w\">  </span><span class=\"n\">ppAllowUngrouped</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"mm \"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">mmSeq</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mm</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Hello\"</span>\n</code></pre></div>\n<p>I will try Embedding DSLs By Elaboration approach, that was referenced by you, thanx.</p>",
        "id": 484159915,
        "sender_full_name": "Alex M",
        "timestamp": 1732462473
    },
    {
        "content": "<p>You should also avoid using <code>prelude</code> and <code>builtin_initialize</code></p>",
        "id": 484159946,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1732462526
    },
    {
        "content": "<p>In particular, remove <code>prelude</code> and remove <code>builtin_</code> everywhere, but there's an issue that these are low-level parsing facilities. Maybe the notation will work from within a module that imports this one.</p>",
        "id": 484176876,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1732479081
    },
    {
        "content": "<p>In case it's helpful, a while back I made a little do-like notation of my own: <a href=\"https://gist.github.com/kmill/be21ca7017d4b1d2eadd47ded5168dd1\">https://gist.github.com/kmill/be21ca7017d4b1d2eadd47ded5168dd1</a></p>\n<p>Here's a variant: <a href=\"https://gist.github.com/kmill/db96b331b9f86579d5dea8e17a49425f\">https://gist.github.com/kmill/db96b331b9f86579d5dea8e17a49425f</a></p>\n<p>Both of these use <code>syntax</code> instead of <code>leading_parser</code>s, which is a higher-level interface.</p>",
        "id": 484176957,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1732479172
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Cool. Your code works as expected, second variant too (aside from checkMaxHeartbeats). That is exactly what example i needed. Thank you. My try apparently was in wrong direction.</p>",
        "id": 484251877,
        "sender_full_name": "Alex M",
        "timestamp": 1732528268
    }
]