[
    {
        "content": "<p>I have the following structures</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Bin</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Bit</span>\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">Bin</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">enc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bin.Binary</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">List.length</span><span class=\"w\"> </span><span class=\"n\">enc</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Count</span>\n<span class=\"sd\">/-- Custom binary type with both value and weight. -/</span>\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bin.Binary</span>\n<span class=\"w\">  </span><span class=\"n\">weight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"n\">Bin.Binary</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x.val</span><span class=\"o\">⟩</span>\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">Count</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Relative</span>\n<span class=\"sd\">/-- Custom C-length binary type with both value and weight. -/</span>\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool.Binary</span><span class=\"w\"> </span><span class=\"n\">C</span>\n<span class=\"w\">  </span><span class=\"n\">weight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Count.Binary</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x.val.val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">weight</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x.weight</span><span class=\"w\"> </span><span class=\"o\">}⟩</span>\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">Relative</span>\n</code></pre></div>\n<p>Why for the final coercion I cannot use</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Count.Binary</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x.val.val</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">weight</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x.weight</span><span class=\"w\"> </span><span class=\"o\">}⟩</span>\n</code></pre></div>\n<p>which would instead lead to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">provide</span><span class=\"w\"> </span><span class=\"n\">concrete</span><span class=\"w\"> </span><span class=\"n\">values</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">semi</span><span class=\"bp\">-</span><span class=\"o\">)</span><span class=\"n\">out</span><span class=\"bp\">-</span><span class=\"n\">params</span>\n<span class=\"w\">  </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">C</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>A similar coercion will work if the input and output type both contain the C parameter for instance. I clearly cannot list all of the possible C values and I need the typeclass-based coercions in situation where an explicit one won't do.</p>",
        "id": 540278317,
        "sender_full_name": "Plamen Dimitrov",
        "timestamp": 1758213622
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CoeOut#doc\">docs#CoeOut</a></p>",
        "id": 540281217,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758214542
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>, interesting that the various LLMs I tried with all of their verbosity could not have suggested that the Coe being 2-way coercion is the cause of this and one way like this would fix it.</p>",
        "id": 540365067,
        "sender_full_name": "Plamen Dimitrov",
        "timestamp": 1758253137
    },
    {
        "content": "<p>Looking at simpler case here like</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">Bit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bit</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bit</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span>\n<span class=\"n\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Bit</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">CBinary</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">enc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">List.length</span><span class=\"w\"> </span><span class=\"n\">enc</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeOut</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">CBinary</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x.val</span><span class=\"o\">⟩</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Binary</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b.foldr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">Bit.one</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"1\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"s2\">\"0\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BooleanAlgebra</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">CBinary</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">literal_encoding4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CBinary</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bit.zero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bit.one</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bit.zero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Bit.one</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">literal_encoding4</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">literal_encoding4</span><span class=\"w\"> </span><span class=\"bp\">⊓</span><span class=\"w\"> </span><span class=\"n\">literal_encoding4</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n</code></pre></div>\n<p>it seems like I cannot use <code>#eval print (literal_encoding4 ⊓ literal_encoding4)</code> instead as the last line since the coercion would not work with the <code>⊓</code> meet, isn't the <code>⊓</code> interpret simply as a bi-argument function that should then apply automatically to make use of the explicit coercion defined above?</p>",
        "id": 541045235,
        "sender_full_name": "Plamen Dimitrov",
        "timestamp": 1758641551
    },
    {
        "content": "<p>All of this is assuming a BooleanAlgebra instance proof that I have omitted here for brevity and the fact that <code>`literal_encoding4 ⊓ literal_encoding4 : CBinary C</code> already where the coercion is defined.</p>",
        "id": 541045578,
        "sender_full_name": "Plamen Dimitrov",
        "timestamp": 1758641637
    },
    {
        "content": "<p>The types are propagated \"outside-in\" so since <code>print</code> expects a <code>Binary</code> it tries to find a way to do inf on <code>Binary</code> and fails</p>",
        "id": 541050755,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758643037
    },
    {
        "content": "<p>Is there any way to make to work around this outside-in order then? Override the order via brackets or some other way to tell Lean how to process this?</p>",
        "id": 541065396,
        "sender_full_name": "Plamen Dimitrov",
        "timestamp": 1758648219
    },
    {
        "content": "<p>You can write <code>print (literal_encoding4 ⊓ literal_encoding4:)</code>. Writing <code>( ... :)</code> is a way to tell lean to elaborate that expression without an expected type. It is mostly the same as <code>(... : _)</code>. You can also give the expected type explicitly as <code>print (literal_encoding4 ⊓ literal_encoding4 : CBinary 4)</code></p>",
        "id": 541106234,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758664189
    },
    {
        "content": "<p>Thank you, the \"smiley face\" worked splendidly and preserves as much of the coercion automation as possible with a minimum extra typing overhead.</p>",
        "id": 541373328,
        "sender_full_name": "Plamen Dimitrov",
        "timestamp": 1758779118
    }
]