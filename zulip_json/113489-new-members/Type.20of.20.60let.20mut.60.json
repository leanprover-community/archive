[
    {
        "content": "<p>I am reading through \"Functional Programming in Lean\" and I tried the following, which surprisingly typechecks:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">two</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>Namely, why can the type of this be any <code>Monad</code>? From the explanation in the text, I would think that the <code>let mut</code> restricts us to the state monad (or at least a <code>StateT</code> transformer), but the overall expression inside the <code>do</code> block has no such restriction. How does <code>let mut</code> work?</p>",
        "id": 537496986,
        "sender_full_name": "Josh Cohen",
        "timestamp": 1756911906
    },
    {
        "content": "<blockquote>\n<p>Monads are primarily used via do-notation, which is an embedded language for programming in an imperative style. It provides familiar syntax for sequencing effectful operations, early return, local mutable variables, loops, and exception handling. All of these features are translated to the operations of the Monad type class, with a few of them requiring addition instances of classes such as ForIn that specify iteration over containers.</p>\n</blockquote>\n<blockquote>\n<p>Sebastian Ullrich and Leonardo de Moura, 2022. <a href=\"https://dl.acm.org/doi/10.1145/3547640\">“<code>do</code> Unchained: Embracing Local Imperativity in a Purely Functional Language”</a>. In <em>Proceedings of the ACM on Programming Languages: ICFP 2022.</em></p>\n</blockquote>\n<p><a href=\"https://lean-lang.org/doc/reference/latest//Functors___-Monads-and--do--Notation/Syntax/#do-notation\">https://lean-lang.org/doc/reference/latest//Functors___-Monads-and--do--Notation/Syntax/#do-notation</a></p>",
        "id": 537497695,
        "sender_full_name": "David Renshaw",
        "timestamp": 1756912095
    },
    {
        "content": "<p>Thanks for the pointer. So it seems from the paper (Figure 5) that <code>let mut</code> desugars to a local <code>StateT</code> instance that is then evaluated by <code>StateT.run'</code>, is this correct?</p>",
        "id": 537501544,
        "sender_full_name": "Josh Cohen",
        "timestamp": 1756913235
    },
    {
        "content": "<p>that's consistent with my understanding</p>",
        "id": 537501654,
        "sender_full_name": "David Renshaw",
        "timestamp": 1756913266
    },
    {
        "content": "<p>clearly that's not what happens since <code>#print two</code> gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">two</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 537503747,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756913913
    },
    {
        "content": "<p>no local instance here</p>",
        "id": 537503795,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756913926
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"952838\">Josh Cohen</span> <a href=\"#narrow/channel/113489-new-members/topic/Type.20of.20.60let.20mut.60/near/537501544\">said</a>:</p>\n<blockquote>\n<p>Thanks for the pointer. So it seems from the paper (Figure 5) that <code>let mut</code> desugars to a local <code>StateT</code> instance that is then evaluated by <code>StateT.run'</code>, is this correct?</p>\n</blockquote>\n<p>The paper is not at all what is currently implemented in Lean and more of an ideal world type of situation.</p>",
        "id": 537514317,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1756917005
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/113489-new-members/topic/Type.20of.20.60let.20mut.60/near/537503747\">said</a>:</p>\n<blockquote>\n<p>clearly that's not what happens since <code>#print two</code> gives</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">two</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>In this case, what does the <code>let mut</code> give beyond just <code>have</code>?</p>",
        "id": 537527858,
        "sender_full_name": "Josh Cohen",
        "timestamp": 1756921887
    },
    {
        "content": "<p>it gives nothing (in this case)</p>",
        "id": 537528113,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756921977
    },
    {
        "content": "<p>but you can do stuff with it if you mutate inside a loop</p>",
        "id": 537528138,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756921989
    }
]