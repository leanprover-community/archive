[
    {
        "content": "<p>Hi everyone! My name is Alexey, I'm a mathematician mostly working on Kolmogorov complexity. I recently formalized some foundations of Kolmogorov complexity in a Lean repository (<a href=\"#narrow/channel/113488-general/topic/Foundations.20of.20Kolmogorov.20complexity\">https://leanprover.zulipchat.com/#narrow/channel/113488-general/topic/Foundations.20of.20Kolmogorov.20complexity</a>).</p>\n<p>I am now trying to make a PR to Mathlib with a small, foundational part of this project (Bijective Base-2 Numeration). However, I've run into a tricky build issue that I cannot resolve.</p>\n<p>Whenever I add <em>any</em> new file to Mathlib, the root <code>Mathlib</code> build fails at the very last step. After extensive debugging, I managed to reproduce this on a completely fresh, clean clone in <code>/tmp</code>.<br>\n<strong>Environment:</strong> WSL2 (Ubuntu), Lean <code>v4.29.0-rc2</code> (toolchain verified), Lake <code>v5.0.0-src</code>.<br>\n<strong>Minimal Reproducible Example (in a clean <code>/tmp</code> directory):</strong></p>\n<p>Bash</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">.</span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"bp\">-</span><span class=\"n\">test</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"bp\">-</span><span class=\"n\">test</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"bp\">&lt;--</span><span class=\"w\"> </span><span class=\"n\">SUCCESS</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">jobs</span><span class=\"w\"> </span><span class=\"n\">complete</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">dummy</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">index</span>\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"import Mathlib.Data.Nat.Basic\"</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Logic</span><span class=\"bp\">/</span><span class=\"n\">Equiv</span><span class=\"bp\">/</span><span class=\"n\">FooTest</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Logic</span><span class=\"bp\">/</span><span class=\"n\">Equiv</span><span class=\"bp\">/</span><span class=\"n\">FooTest</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">mk_all</span>\n\n<span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Rebuild</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"bp\">&lt;--</span><span class=\"w\"> </span><span class=\"n\">FAILS</span>\n</code></pre></div>\n<p><strong>The Error:</strong></p>\n<p>Plaintext</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">non</span><span class=\"bp\">-</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Logic</span><span class=\"bp\">.</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">FooTest</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">module</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>It seems Lake compiles the new <code>.olean</code> locally without issues, but refuses to treat it as a valid <code>module</code> within the <code>lean_lib</code> target graph during the root build, even when the file is tracked by git.</p>\n<p>Is this a known issue with the current RC on WSL, or am I missing a specific step required to register new modules in Mathlib4? Any help would be greatly appreciated!</p>\n<hr>",
        "id": 576327092,
        "sender_full_name": "Alexey Milovanov",
        "timestamp": 1772217385
    },
    {
        "content": "<p>If you look at another file in Mathlib you will see that they all begin with the <code>module</code> keyword which is likely what you're missing</p>",
        "id": 576327950,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1772217677
    }
]