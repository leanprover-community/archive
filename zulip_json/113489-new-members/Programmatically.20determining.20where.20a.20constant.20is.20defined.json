[
    {
        "content": "<p>Given a constant name‚Äîsay¬†<code>mul_assoc</code>‚Äîhow can I programmatically determine where it is defined?</p>\n<p>Is there a command (for example,¬†something like <code>#which mul_assoc</code>) that would report this?</p>\n<p>For the <code>mul_assoc </code> example I‚Äôd like to get¬†<code>Mathlib.Algebra.Group.Defs</code>¬†ideally together with the line number.</p>",
        "id": 515961687,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746312435
    },
    {
        "content": "<p>I answered this question already, let me pull that up</p>",
        "id": 515962014,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312651
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/239415-metaprogramming-.2F-tactics/topic/.E2.9C.94.20how.20to.20get.20related.20theorems/near/512130559\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">``add_comm</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">module?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleFor?</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{module?}\"</span><span class=\"w\"> </span><span class=\"c1\">-- some (Mathlib.Algebra.Group.Defs)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`not_a_theorem</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">module?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleFor?</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{module?}\"</span><span class=\"w\"> </span><span class=\"c1\">-- none</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 515962314,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312874
    },
    {
        "content": "<p>I'm not sure how to get the line number though</p>",
        "id": 515962699,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746313168
    },
    {
        "content": "<p>You can get line numbers from the <code>DeclarationsRangeExt</code>ension.  I'm on mobile, though.</p>",
        "id": 515978316,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746323440
    },
    {
        "content": "<p>There should also already be a thread with such a function in <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4\">#lean4</a> somewhere: maybe searching there for messages sent by me and containing the name of the extension may yield it.</p>",
        "id": 515978400,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746323510
    },
    {
        "content": "<p>Found it: <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/Return.20definition.20of.20a.20declaration.3F/near/480819355\">#lean4 &gt; Return definition of a declaration? @ üí¨</a></p>",
        "id": 515978585,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746323612
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"683979\">Isak Colboubrani</span> <a href=\"#narrow/channel/113489-new-members/topic/Programmatically.20determining.20where.20a.20constant.20is.20defined/near/515961687\">said</a>:</p>\n<blockquote>\n<p>For the <code>mul_assoc </code> example I‚Äôd like to get¬†<code>Mathlib.Algebra.Group.Defs</code>¬†ideally together with the line number.</p>\n</blockquote>\n<p>Upon reflection, the¬†<code>(module, line number)</code>¬†pair doesn‚Äôt make sense -- modules may be spread across several files, but line numbers are file-specific.</p>",
        "id": 516015185,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746354164
    },
    {
        "content": "<p>Thanks Damiano and Aaron!</p>\n<p>As a first step I managed to create a¬†<code>#loc &lt;identifier&gt;</code>¬†command that returns the number of lines in an identifier‚Äôs definition. Code review request: any tips for making this code more idiomatic are welcome.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#loc\"</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">findDeclarationRanges?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">declarationRanges</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">declarationRanges</span><span class=\"bp\">.</span><span class=\"n\">range</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"bp\">.</span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Lines of code for '{name}': {lines}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"unknown identifier '{name}'\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">mul_assoc</span>\n<span class=\"c1\">-- Output:</span>\n<span class=\"c1\">-- Lines of code for 'mul_assoc': 3</span>\n</code></pre></div>",
        "id": 516016052,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746354922
    },
    {
        "content": "<p>If you use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">identifier</span>\n</code></pre></div>\n<p>instead of simply getting the identifier, then you leave the error management of what happens when the constant does not exist to the core functions.</p>",
        "id": 516036369,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746370633
    },
    {
        "content": "<p>Also, using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Lines of code for '{.ofConstName name}': {lines}\"</span>\n</code></pre></div>\n<p>with <code>.ofConstName</code>, makes the name clickable in the infoview.</p>",
        "id": 516036404,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746370661
    },
    {
        "content": "<p>So, you could compress your code to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#loc\"</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">identifier</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">findDeclarationRanges?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"bp\">.</span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Lines of code for '{.ofConstName name}': {lines}\"</span>\n</code></pre></div>",
        "id": 516036677,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746370811
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"683979\">Isak Colboubrani</span> <a href=\"#narrow/channel/113489-new-members/topic/Programmatically.20determining.20where.20a.20constant.20is.20defined/near/516015185\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"683979\">Isak Colboubrani</span> <a href=\"#narrow/channel/113489-new-members/topic/Programmatically.20determining.20where.20a.20constant.20is.20defined/near/515961687\">said</a>:</p>\n<blockquote>\n<p>For the <code>mul_assoc </code> example I‚Äôd like to get¬†<code>Mathlib.Algebra.Group.Defs</code>¬†ideally together with the line number.</p>\n</blockquote>\n<p>Upon reflection, the¬†<code>(module, line number)</code>¬†pair doesn‚Äôt make sense -- modules may be spread across several files, but line numbers are file-specific.</p>\n</blockquote>\n<p>I'm going through most of mathlib right now and so far all the modules are one file.</p>",
        "id": 516036904,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746370964
    },
    {
        "content": "<p>I don't think that there is a distinction between <code>module</code> and <code>file</code>.  What would it be?</p>",
        "id": 516038119,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746371780
    },
    {
        "content": "<p>Apologies -- I conflated modules and namespaces. There exists a¬†bijection¬†between the set of files and the set of modules (whereas the correspondence between files and namespaces is a¬†non-functional, many-to-many relation).</p>\n<p>Thus, a pair of the form¬†<code>(module, line number)</code>¬†uniquely identifies a location in the code , whereas a pair¬†<code>(namespace, line number)</code>¬†does not (since namespaces may span multiple files).</p>",
        "id": 516068008,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746392512
    },
    {
        "content": "<p>Thanks for the code review <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>!</p>\n<p>This is my current version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#loc\"</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">identifier</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">findDeclarationRanges?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"bp\">.</span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Lines of code for '{.ofConstName name}': {lines}\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Cannot compute lines of code for '{.ofConstName name}'\"</span>\n</code></pre></div>\n<p>Please let me know if anything can be improved further.</p>",
        "id": 516190414,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746450211
    },
    {
        "content": "<p>I ran into an unexpected issue: it seems like <code>Lean.findDeclarationRanges</code> fails for <code>MvPFunctor.WPath.root.inj</code>.</p>\n<p>Example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Works:</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">mul_assoc</span>\n<span class=\"c1\">-- Lines of code for 'mul_assoc': 3</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">mul_assoc</span>\n<span class=\"c1\">-- mul_assoc.{u_1} {G : Type u_1} [Semigroup G] (a b c : G) ‚Ä¶</span>\n\n<span class=\"c1\">-- Does not work:</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">MvPFunctor</span><span class=\"bp\">.</span><span class=\"n\">WPath</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"bp\">.</span><span class=\"n\">inj</span>\n<span class=\"c1\">-- Unknown line count for 'MvPFunctor.WPath.root.inj'</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPFunctor</span><span class=\"bp\">.</span><span class=\"n\">WPath</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"bp\">.</span><span class=\"n\">inj</span>\n<span class=\"c1\">-- MvPFunctor.WPath.root.inj.{u} {n : ‚Ñï} ‚Ä¶</span>\n</code></pre></div>\n<p>What is special about <code>MvPFunctor.WPath.root.inj</code>?</p>",
        "id": 516191660,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746450491
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MvPFunctor.WPath.root.inj#doc\">docs#MvPFunctor.WPath.root.inj</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MvPFunctor.WPath.root#doc\">docs#MvPFunctor.WPath.root</a></p>",
        "id": 516202677,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746452849
    },
    {
        "content": "<p>It looks like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MvPFunctor.WPath.root.inj#doc\">docs#MvPFunctor.WPath.root.inj</a> is not a declaration.</p>",
        "id": 516202735,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746452868
    },
    {
        "content": "<p><code>MvPFunctor.WPath.root.inj</code> is the automatically generated injectivity theorem for the constructor <code>MvPFunctor.WPath.root</code>. Compare with, for example, <code>Nat.succ.inj</code>.</p>",
        "id": 516203566,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746453099
    },
    {
        "content": "<p>Thanks -- TIL! Is it precisely for automatically generated code that this behavior will be triggered, or can anyone think of other scenarios in which¬†<code>Lean.findDeclarationRanges</code>¬†might fail (given an existing identifier <code>name</code> acquired via <code>let name ‚Üê liftCoreM do Lean.realizeGlobalConstNoOverload identifier</code>)?</p>",
        "id": 516209437,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746454419
    },
    {
        "content": "<p>Maybe on stuff like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=UInt8.zero_def#doc\">docs#UInt8.zero_def</a> which was generated by a command?</p>",
        "id": 516214129,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746455418
    },
    {
        "content": "<p>Interestingly, <code>#loc Nat.succ.inj</code> does work, as well as <code>#loc Nat.succ.injEq</code> and <code>#loc Nat.noConfusion</code>.</p>",
        "id": 516215675,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746455795
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>. That's a bit surprising. I can‚Äôt see the exact pattern separating the working cases from the failing ones with regards to <code>Lean.findDeclarationRanges</code> (and thus line numbers). In each case, however, the module name (<code>env.getModuleFor</code>) is reported correctly.</p>\n<p>These are some working and non-working examples:</p>\n<ul>\n<li><code>UInt8.zero_def</code> works (line number is reported), <code>List.reverseRecOn.eq_def</code> does not.</li>\n<li><code>Nat.noConfusion</code> works, <code>NatPowAssoc.noConfusionType</code> does not.</li>\n<li><code>Nat.succ.injEq</code> works, <code>AbsoluteValue.mk.injEq</code> does not.</li>\n<li><code>Nat.succ.inj</code> works, <code>DihedralGroup.r.inj</code> does not.</li>\n</ul>\n<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#loc\"</span><span class=\"w\"> </span><span class=\"n\">identifier</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">identifier</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">findDeclarationRanges?</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">endPos</span><span class=\"bp\">.</span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Lines of code for '{.ofConstName name}': {lines}\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Cannot compute lines of code for '{.ofConstName name}'\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"bp\">.</span><span class=\"n\">zero_def</span><span class=\"w\"> </span><span class=\"c1\">-- Lines of code for 'UInt8.zero_def': 1</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">reverseRecOn</span><span class=\"bp\">.</span><span class=\"n\">eq_def</span><span class=\"w\"> </span><span class=\"c1\">-- Cannot compute lines of code for 'List.reverseRecOn.eq_def'</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">noConfusion</span><span class=\"w\"> </span><span class=\"c1\">-- Lines of code for 'Nat.noConfusion': 22</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">NatPowAssoc</span><span class=\"bp\">.</span><span class=\"n\">noConfusionType</span><span class=\"w\"> </span><span class=\"c1\">-- Cannot compute lines of code for 'NatPowAssoc.noConfusionType'</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">injEq</span><span class=\"w\"> </span><span class=\"c1\">-- Lines of code for 'Nat.succ.injEq': 2</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">AbsoluteValue</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"bp\">.</span><span class=\"n\">injEq</span><span class=\"w\"> </span><span class=\"c1\">-- Cannot compute lines of code for 'AbsoluteValue.mk.injEq'</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"c1\">-- Lines of code for 'Nat.succ.inj': 2</span>\n<span class=\"bp\">#</span><span class=\"n\">loc</span><span class=\"w\"> </span><span class=\"n\">DihedralGroup</span><span class=\"bp\">.</span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">inj</span><span class=\"w\"> </span><span class=\"c1\">-- Cannot compute lines of code for 'DihedralGroup.r.inj'</span>\n</code></pre></div>",
        "id": 516291493,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1746477353
    }
]