[
    {
        "content": "<p>I’m interested in Lean’s LSP and would like to fix some bugs or add new features. I followed the configuration steps outlined in these two documents <a href=\"https://lean-lang.org/lean4/doc/dev/index.html#development-workflow\">Development Workflow</a> and <a href=\"https://github.com/leanprover/lean4/blob/master/src/Lean/Server/README.md\">Lean Server Readme</a>, and attempted to modify the LSP code (by commenting out the logic in the <code>handleRequest</code> functions in <code>Watchdog.lean</code> and <code>FileWorker.lean</code>). However, after recompiling the source code and restarting VS Code, the changes I made to the LSP code didn’t take effect. Could anybody help me understand why this is happening? Below are the steps I took.</p>\n<ol>\n<li>open workspace</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"bp\">.</span><span class=\"n\">code</span><span class=\"bp\">-</span><span class=\"n\">workspace</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>setup toolchain</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage1</span>\n<span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">stage0</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage0</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>comment out <code>handleRequest</code></li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Watchdog.lean</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleRequest</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RequestID</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">method</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ServerM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span>\n<span class=\"c1\">-- FileWorker.lean</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleRequest</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RequestID</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">method</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WorkerM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n</code></pre></div>\n<ol start=\"4\">\n<li>build lean</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span>\n<span class=\"n\">make</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">j6</span>\n</code></pre></div>\n<ol start=\"5\">\n<li>reload<br>\nRefresh File Dependencies<br>\nRestart Server</li>\n</ol>\n<p>Even after following these steps, I expected the LSP to stop functioning properly (for example, “Go to Definition” shouldn’t work), but the LSP is still working as usual. When I checked the Lean version using the ps command, I noticed it was running stage0. From what I understand, stage0 shouldn’t include the compiled Lean server. Could this be related to the issue?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">$</span><span class=\"n\">ps</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">grep</span><span class=\"w\"> </span><span class=\"n\">lean</span>\n<span class=\"n\">luoyangze</span><span class=\"w\">        </span><span class=\"mi\">22456</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"w\">  </span><span class=\"mf\">0.2</span><span class=\"w\"> </span><span class=\"mi\">412147840</span><span class=\"w\">  </span><span class=\"mi\">78624</span><span class=\"w\">   </span><span class=\"bp\">??</span><span class=\"w\">  </span><span class=\"n\">S</span><span class=\"w\">     </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"mi\">48</span><span class=\"n\">PM</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mf\">01.66</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">luoyangze</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">stage0</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"c1\">--server /Users/luoyangze/lean/lean4/src</span>\n<span class=\"n\">luoyangze</span><span class=\"w\">        </span><span class=\"mi\">34849</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"w\">  </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"mi\">412193424</span><span class=\"w\"> </span><span class=\"mi\">369552</span><span class=\"w\">   </span><span class=\"bp\">??</span><span class=\"w\">  </span><span class=\"n\">Ss</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"mi\">59</span><span class=\"n\">PM</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mf\">02.47</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">luoyangze</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage0</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"c1\">--worker file:///Users/luoyangze/lean/lean4/src/Lean/Server/Watchdog.lean</span>\n<span class=\"n\">luoyangze</span><span class=\"w\">        </span><span class=\"mi\">34842</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"w\">  </span><span class=\"mf\">1.1</span><span class=\"w\"> </span><span class=\"mi\">412372000</span><span class=\"w\"> </span><span class=\"mi\">403488</span><span class=\"w\">   </span><span class=\"bp\">??</span><span class=\"w\">  </span><span class=\"n\">Ss</span><span class=\"w\">    </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"mi\">59</span><span class=\"n\">PM</span><span class=\"w\">   </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mf\">04.46</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">luoyangze</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">release</span><span class=\"bp\">/</span><span class=\"n\">stage0</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"c1\">--worker file:///Users/luoyangze/lean/lean4/src/Lean/Server/FileWorker.lean</span>\n</code></pre></div>",
        "id": 462509535,
        "sender_full_name": "ptrl",
        "timestamp": 1723713519
    },
    {
        "content": "<p>Stage 0 is used to both build and while editing src/ - otherwise we couldn't do any editing before a first successful build. If you want to test changes, you should do it in tests/, which uses stage 1. I usually keep an untracked file tests/scratch.lean around for experimentation</p>",
        "id": 462512958,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723715008
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/113489-new-members/topic/LSP.20development.20setup.20problem/near/462512958\">said</a>:</p>\n<blockquote>\n<p>Stage 0 is used to both build and while editing src/ - otherwise we couldn't do any editing before a first successful build. If you want to test changes, you should do it in tests/, which uses stage 1. I usually keep an untracked file tests/scratch.lean around for experimentation</p>\n</blockquote>\n<p>I want to see the effects of my changes to the Lean/Server code in VS Code (for example, if I modify the semantic highlight logic, I want to see the color changes in VS Code). I found a somewhat hacky solution: I modified the code in <a href=\"https://github.com/leanprover/vscode-lean4/blob/93095f9ed971ac59019408942ac295b56e56807c/vscode-lean4/src/leanclient.ts#L454\">vscode-lean</a> to force the LSP to run from a specific path, changing it to build/release/stage1/bin/lean, and that works. Although it’s a bit cumbersome, it does the job. Is there a better way to achieve this?</p>",
        "id": 462514358,
        "sender_full_name": "ptrl",
        "timestamp": 1723715594
    },
    {
        "content": "<p>You can temporarily change src/lean-toolchain to <code>lean4</code> and restart the server</p>",
        "id": 462515973,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723716253
    }
]