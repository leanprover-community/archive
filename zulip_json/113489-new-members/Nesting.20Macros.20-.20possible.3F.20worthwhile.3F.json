[
    {
        "content": "<p>My knowledge of metaprogramming is limited to some rudimentary common lisp. In trying a learning exercise for myself I was led into a side question about macros. In my case I wanted to create a \"state\" type that was essentially just a <code>Fin n</code>. I wanted to be able to create new values for a state type of a particular n without my users (or myself) having to always specify the bound or provide a proof like <code>(by omega)</code> that seemed boiler plate. I just wanted compile time failure for bad values. Trying to work with <a href=\"http://claude.ai\">claude.ai</a> to create a nested structure for my macros we came up with the following. It doesn't work, but may be a clearer way of showing what I was going for. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"makeFinMacro\"</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">bound</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)))</span>\n\n<span class=\"n\">makeFinMacro</span><span class=\"w\"> </span><span class=\"n\">myFin8</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myFin8</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\">   </span><span class=\"c1\">-- Expands to @Fin.mk 8 3 (by omega)</span>\n</code></pre></div>\n<p>Of course this doesn't actually work. My question is not so much about the specifics here, though I would be happy to see a corrected implementation, but a more general comment on this type of \"nesting\". Is it thought to be useful? If so, is there a more standard way to implement it, and can I be pointed to something to read? Thank you.</p>",
        "id": 536024774,
        "sender_full_name": "Britt Anderson",
        "timestamp": 1756128212
    },
    {
        "content": "<p>Possible? Yes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"makeFinMacro\"</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkStrLit</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">bound</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"o\">)))</span>\n\n<span class=\"n\">makeFinMacro</span><span class=\"w\"> </span><span class=\"n\">myFin8</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myFin8</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\">   </span><span class=\"c1\">-- Expands to @Fin.mk 8 3 (by omega)</span>\n</code></pre></div>\n<p>Worthwhile? Definitely sometimes, core also does something similar with <code>declare_simp_like_tactic</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_simp_like_tactic</span><span class=\"w\"> </span><span class=\"n\">simpOnce</span><span class=\"w\"> </span><span class=\"s2\">\"simp_once\"</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">singlePass</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_once</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">eq_iff_iff</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 536032890,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1756130762
    },
    {
        "content": "<p>Thank you.  Can you explain why we need <code>$(Lean.Syntax.mkStrLit name.getId.toString):str</code> in place of $name. I am not quite sure what to look up to understand this better. I can see the source for mkStrLit, but I don't understand why it is needed here or where to read to better understand that.</p>",
        "id": 536120701,
        "sender_full_name": "Britt Anderson",
        "timestamp": 1756161814
    }
]