[
    {
        "content": "<p>Is there a way to generate a random float number, like Python's <code>random()</code>? (using uniform distribution)</p>",
        "id": 492557639,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736359058
    },
    {
        "content": "<p>You mean \"there are only finitely many floats so pick one at random with every one having equal probability\"? Is that what \"uniform\" means in this context?</p>",
        "id": 492559589,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1736359856
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> Generally these random float functions generate a random number in <code>[0.0,1.0)</code> uniformly at random. That's what Python's <code>random()</code> does at least.</p>",
        "id": 492559994,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736360040
    },
    {
        "content": "<p>Oh I was about to come up with something using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Float.ofScientific#doc\">docs#Float.ofScientific</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=randNat#doc\">docs#randNat</a> ;-)</p>",
        "id": 492560268,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1736360126
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> I guess no, I want something that usual libraries in programming languages would do. In my understanding, Python's <code>random()</code> behaves like: sampling an element over the uniform distribution in Real numbers (in interval [0,1)) and getting the closest Float representation for that.</p>",
        "id": 492560339,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736360159
    },
    {
        "content": "<p>Yes that would be a lot more sensible!</p>",
        "id": 492560406,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1736360176
    },
    {
        "content": "<p>At the moment I am doing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">rand</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">64</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toFloat</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"mi\">64</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>but I guess there is a better way than this.</p>",
        "id": 492562138,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736360890
    },
    {
        "content": "<p>What meaning of \"better\" are you after?</p>",
        "id": 492562256,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736360944
    },
    {
        "content": "<p>If you want to implement exactly what python's random does (which is btw. of course not related at all to real numbers):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">BPF</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">53</span><span class=\"w\">        </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">bits</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">float</span>\n<span class=\"n\">RECIP_BPF</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">**</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">BPF</span>\n\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">random</span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"o\">):</span>\n<span class=\"w\">        </span><span class=\"s2\">\"\"\"Get the next random number in the range 0.0 &lt;= X &lt; 1.0.\"\"\"</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"bp\">.</span><span class=\"n\">from_bytes</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">urandom</span><span class=\"o\">(</span><span class=\"mi\">7</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">RECIP_BPF</span>\n</code></pre></div>\n<p>you can use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bpf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">53</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">recip_bfp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"n\">bpf</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">random</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ByteArray</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getRandomBytes</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toUInt64BE!</span>\n\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"bp\">.</span><span class=\"n\">toFloat</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">recip_bfp</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">random</span>\n</code></pre></div>\n<p>Note that this not <em>exactly</em> as good as python because their implementation uses urandom whereas getRandomBytes is not guaranteed to be cryptographically secure but it should be acceptable for statistical experimentation.</p>",
        "id": 492562264,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736360950
    },
    {
        "content": "<p>\"Number of bits in a float\" seems like a strange comment</p>",
        "id": 492562466,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736361019
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"748258\">Youngju Song</span> <a href=\"#narrow/channel/113489-new-members/topic/Generating.20a.20random.20float.20number.3F/near/492560339\">said</a>:</p>\n<blockquote>\n<p>sampling an element over the uniform distribution in Real numbers (in interval [0,1)) and getting the closest Float representation for that.</p>\n</blockquote>\n<p>This is not what your code or python does; neither will ever sample <code>2^-1074</code></p>",
        "id": 492562836,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736361181
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/113489-new-members/topic/Generating.20a.20random.20float.20number.3F/near/492562466\">said</a>:</p>\n<blockquote>\n<p>\"Number of bits in a float\" seems like a strange comment</p>\n</blockquote>\n<p>I'm just copying python source code here :P besides, the mantissa is of that length so that's likely what they are after here.</p>",
        "id": 492563812,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736361603
    },
    {
        "content": "<p>Thank you for the comments!</p>\n<blockquote>\n<p>What meaning of \"better\" are you after?</p>\n</blockquote>\n<p>I was expecting the random libraries e.g., in Python to implement some serious complicated black-box algorithm to sample as faithfully as possible to Real numbers, but as <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> brought up here, the implementation in Python is (to my surprise) rather straightforward! I am happy with whatever implementation that is as good as Python's. Thank you very much for your code <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> !</p>",
        "id": 492564337,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736361828
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>  Maybe it is worth putting your implementation to the Lean's standard library?</p>",
        "id": 492564462,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736361892
    },
    {
        "content": "<p>It could be in principle but I don't think this does justice to what we'd want in <code>Std</code>. Ideally there would be some random monad that can be fed with <code>IO.getRandomBytes</code> among other things and then we can build generically on top of that so I don't think I'll put this code into <code>Std</code> as is.</p>",
        "id": 492564754,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736362029
    },
    {
        "content": "<p>You could usefully take a look at the <a href=\"https://hackage.haskell.org/package/random-1.3.0/docs/System-Random.html\">Haskell random number library</a> and its <a href=\"https://hackage.haskell.org/package/random-1.3.0/docs/System-Random-Stateful.html\">monadic counterpart</a>. We spent a lot of time on its design as an interface allowing users (should they so wish) to use their own source of randomness: <a href=\"https://hackage.haskell.org/package/random-1.3.0/docs/System-Random-Stateful.html#g:21\">https://hackage.haskell.org/package/random-1.3.0/docs/System-Random-Stateful.html#g:21</a> and <a href=\"https://hackage.haskell.org/package/random-1.3.0/docs/System-Random.html#g:16\">https://hackage.haskell.org/package/random-1.3.0/docs/System-Random.html#g:16</a>. See especially the <a href=\"https://hackage.haskell.org/package/random-1.3.0/docs/System-Random-Stateful.html#g:fpcaveats\">caveats</a> on floating point.</p>\n<p>Of course, it all depends on what you want random numbers for. The default implementation passes most of the standard (pseudo) random number generator tests: <a href=\"https://github.com/tweag/random-quality\">https://github.com/tweag/random-quality</a> (I recommend using these to check the quality of your implementation). Good enough for pricing financial derivatives but not maybe for cryptographic applications.</p>\n<p>This is an area that sounds straightforward but will take you on a long journey.</p>",
        "id": 492662760,
        "sender_full_name": "Dominic Steinitz",
        "timestamp": 1736411717
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"748258\">Youngju Song</span> <a href=\"#narrow/channel/113489-new-members/topic/Generating.20a.20random.20float.20number.3F/near/492560339\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> I guess no, I want something that usual libraries in programming languages would do. In my understanding, Python's <code>random()</code> behaves like: sampling an element over the uniform distribution in Real numbers (in interval [0,1)) and getting the closest Float representation for that.</p>\n</blockquote>\n<p>And Floating Point is its own rabbit hole. You should think about a mantissa with 3 bits and exponent of 2 bits for example to get a feel for how they are distributed. And as everyone knows they don't even obey the usual arithmetical laws.</p>",
        "id": 492663604,
        "sender_full_name": "Dominic Steinitz",
        "timestamp": 1736411985
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/113489-new-members/topic/Generating.20a.20random.20float.20number.3F/near/492562264\">said</a>:</p>\n<blockquote>\n<p>If you want to implement exactly what python's random does (which is btw. of course not related at all to real numbers):</p>\n</blockquote>\n<p>Also, this is not guaranteed to output the closest floating point number to a \"random real in the range <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">[</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">[0,1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span>\". If the result is close to 0 where the <code>float</code>s are closer together, using a fixed number of random bits will result in truncation in the mantissa. If I read correctly your example code it uses 56 random bits, and this is only 3 more than the mantissa length in a float, so a small but not negligible of random floats obtained this way will have fixed 0 bits at the end of their mantissa.</p>\n<p>(I don't think there are many standard libraries that try to deal with this issue, as using a non-fixed number of random bits would likely increase run times; I don't know if the need for cryptographic-level random floats is that high either)</p>",
        "id": 492669642,
        "sender_full_name": "Philippe Duchon",
        "timestamp": 1736413861
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"726077\">Philippe Duchon</span> <a href=\"#narrow/stream/113489-new-members/topic/Generating.20a.20random.20float.20number.3F/near/492669642\">said</a>:</p>\n<blockquote>\n<p>If I read correctly your example code it uses 56 random bits, and this is only 3 more than the mantissa length in a float, so a small but not negligible of random floats obtained this way will have fixed 0 bits at the end of their mantissa.<br>\n</p>\n</blockquote>\n<p>It generates exactly 53 random bits (it immediately discards 3 of the 56), so I think \"small\" here is 50% of random floats having at least one fixed zero bit in the mantissa</p>",
        "id": 492677162,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736416019
    }
]