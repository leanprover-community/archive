[
    {
        "content": "<p>I have created a <code>BoundedNat</code> type to practice Lean. It works mostly like a <code>Fin n</code>, but with an additional lower bound over the upper bound. I'd like to be able to implement <code>OfNat</code> for this type, which I tried with the following declaration:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"kd\">instance</span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">    </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">      </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">And.intro</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lt_add_one</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"w\">  </span><span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>In the final example, Lean is unable to type the expression, giving the following error output</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">typeclass</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">problem</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">stuck</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">often</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">metavariables</span>\n<span class=\"w\">  </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">23968</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">23969</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"n\">numerals</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">polymorphic</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">numeral</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"mi\">2</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">  </span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">23968</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">23969</span>\n<span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">absence</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">above</span>\n</code></pre></div>\n<p>I don't understand why Lean would get caught in this example. If I provide the holes directly, it has no problems accepting them. Could someone help me figure out why?</p>",
        "id": 472331951,
        "sender_full_name": "Ayhon",
        "timestamp": 1727125809
    },
    {
        "content": "<p>Instance synthesis isn't allowed to fill metavariables like that, not unless you use <code>outParam</code></p>",
        "id": 472334045,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727126680
    },
    {
        "content": "<p>But I cannot use <code>outParam</code> in this case since I don't control the class definition, right?</p>",
        "id": 472334169,
        "sender_full_name": "Ayhon",
        "timestamp": 1727126738
    },
    {
        "content": "<p>Why this restriction?</p>",
        "id": 472334176,
        "sender_full_name": "Ayhon",
        "timestamp": 1727126744
    },
    {
        "content": "<p>Perhaps also worth noting that <code>outParam</code> inside the definition of <code>OfNat</code> would also let the whole thing be guessed at once, which is obviously no good because <code>OfNat _ n</code> shouldn't pick <code>BoundedNat n (n + 1)</code></p>",
        "id": 472334428,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727126850
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690100\">Ayhon</span> <a href=\"#narrow/stream/113489-new-members/topic/Why.20.60OfNat.20.28P.20n.29.20n.60.20doesn't.20guess.20.60n.60.20with.20literals.3F/near/472334176\">said</a>:</p>\n<blockquote>\n<p>Why this restriction?</p>\n</blockquote>\n<p>Unification during typeclass search would be very fragile, as the order that instances are visited in highly unpredictable. As a result, the library is usually designed around the assumption that the resolution order doesn't matter, such that all possible results are the same. If the search is allowed to fill in metavariables as it goes, this invariant is lost.</p>\n<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> might have a better explanation here.</p>",
        "id": 472334932,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727127037
    },
    {
        "content": "<p>If instances could assign metavariables, then they could specialize things too early.</p>\n<p>For example, if you had</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>then when you write <code>let x := 5; ...</code> the <code>5</code> would be <code>Int</code>. This is because the type of <code>5</code> is unknown when it's elaborated, so the instance problem is <code>OfNat ?_ 5</code>, and the <code>OfNat Int 5</code> instance would apply.</p>",
        "id": 472336839,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727127925
    },
    {
        "content": "<p>Default instances are allowed to assign metavariables once everything else fails, for example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"o\">}</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_instance</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">    </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">And</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 472337495,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727128099
    },
    {
        "content": "<p>This breaks natural number literals however:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"c1\">-- 2 : BoundedNat 2 (2 + 1)</span>\n</code></pre></div>",
        "id": 472337657,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727128136
    },
    {
        "content": "<p>I see. However, I can only see this problem of overspecializing too early when you're guessing whole types. Could there be a way to decide more granularly what type parameters can be \"guessed\" and which can't?</p>\n<p>I fully understand that this may be a feature which is only relevant to me, or that even if feasible there might not be anyone interested in implementing it. It's more out of curiosity and because I feel that it should be feasible in practice. </p>\n<p>It might also be that allowing only metavariables one level bellow is not solving the problem, just hiding it a bit more. I feel, however, that if I have defined a type <code>T</code>, it should be ok to control how a literal is handled as a <code>T</code>, since it doesn't impact other use cases.</p>",
        "id": 472339216,
        "sender_full_name": "Ayhon",
        "timestamp": 1727128660
    },
    {
        "content": "<p>In any case, thank you for your time, I think my original question has been answered in full <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>",
        "id": 472339421,
        "sender_full_name": "Ayhon",
        "timestamp": 1727128742
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690100\">Ayhon</span> has marked this topic as resolved.</p>",
        "id": 472339432,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727128750
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"690100\">@Ayhon</span> </p>\n<p>Would something like this work?  I took inspiration from <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> 's example but wanted to fix the <code>default_instance</code> problem with Nats.  I did it by the typical \"Every problem in computer science can be solved by an additional layer of indirection\":  Basically, I introduce a \"fake\" type class and only implement it for <code>BoundedNat</code>.  This way, I can have a default_instance but still not override the one for other types like e.g. <code>Nat</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">lo</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"o\">}</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Bounded</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bounded</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">BoundedNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">property</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">And</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_instance</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">bd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bounded</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">OfNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">bd</span><span class=\"bp\">.</span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">bn</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">bn</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"c1\">-- still a Nat</span>\n</code></pre></div>\n<p>It's a hack and I'm sure there's some issue with this that the more experienced developers here will find.... but it seems to work for me.</p>",
        "id": 472386504,
        "sender_full_name": "Tom",
        "timestamp": 1727147759
    },
    {
        "content": "<p>As an aside, I also considered  implementing a <code>CoeDep </code> instance to convert a <code>Nat</code> to a <code>BoundedNat</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"c1\">-- a Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BoundedNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>but I couldn't make it work.  Perhaps someone more experienced can suggest if that could be made to work.</p>",
        "id": 472387084,
        "sender_full_name": "Tom",
        "timestamp": 1727148097
    },
    {
        "content": "<p>I believe you have to explicitly give the type: <code>#check (x : BoundedNat x (x + 1))</code></p>",
        "id": 472387849,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727148499
    }
]