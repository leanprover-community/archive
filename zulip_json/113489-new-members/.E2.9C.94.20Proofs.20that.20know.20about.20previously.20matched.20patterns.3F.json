[
    {
        "content": "<p>I'm writing a function that decomposes a program M into an evaluation context and a redex. This function is only defined when M is not a value.  Here's how it's going:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">IsValue</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Exp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Exp</span><span class=\"bp\">.</span><span class=\"n\">decompose</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Exp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M_notValue</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬¨</span><span class=\"n\">IsValue</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ECtx</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Exp</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">V‚ÇÅ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">V‚ÇÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">hole</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">M‚ÇÇ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">ùìî'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Œî</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decompose</span><span class=\"w\"> </span><span class=\"n\">M‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">admit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- !!!</span>\n</code></pre></div>\n<p>How do I prove <code>M‚ÇÇ</code> is not a value in the last line? </p>\n<p>Also, is this how you would typically approach the problem of defining a function like <code>decompose</code>? I was thinking about returning an Option type instead, but then I'd have to handle <code>none</code> in cases where I know it will never be <code>none</code>.</p>",
        "id": 497702866,
        "sender_full_name": "Dan Plyukhin",
        "timestamp": 1738685205
    },
    {
        "content": "<p>This is something you can prove things about a function after the fact, but not from within a <code>match</code>.</p>\n<p>The next best thing is explicitly matching on M2. If you use <code>| pat1 | pat2 | pat3 =&gt; ...</code> syntax, you might be able to save some duplication.</p>\n<p>Another option (seems better) is to use an <code>if h : M2.isValue then ... else ...</code> rather than <code>match</code> on it.</p>",
        "id": 497707677,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738686615
    },
    {
        "content": "<p>Design note: you could write <code>IsValue</code> as being <code>Bool</code>-valued, which would save you from needing to add a Decidable instance for it.</p>\n<p>The <code>match</code> also has a variant syntax for <code>true</code>/<code>false</code> results based on matching:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Exp</span><span class=\"bp\">.</span><span class=\"n\">isValue</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Exp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>(I renamed it <code>Exp.isValue</code> so you can write <code>M.isValue</code> later.)</p>",
        "id": 497707991,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738686695
    },
    {
        "content": "<blockquote>\n<p>The next best thing is explicitly matching on M2.</p>\n</blockquote>\n<p>Wouldn't I have the same issue? Here's my attempt to realize that:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">M‚ÇÅ</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">V‚ÇÅ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">M‚ÇÇ</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">V‚ÇÇ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">hole</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">V‚ÇÅ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">V‚ÇÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">M‚ÇÇ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">ùìî'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Œî</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decompose</span><span class=\"w\"> </span><span class=\"n\">M‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">admit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- !!!</span>\n</code></pre></div>\n<p>The <code>Exp.isValue</code> and <code>if h : M2.isValue</code> idea works though!</p>",
        "id": 497713899,
        "sender_full_name": "Dan Plyukhin",
        "timestamp": 1738688300
    },
    {
        "content": "<p>By \"explicitly matching on M2\", I meant that you'd exhaust all the possibilities for it. That way in the remaining cases you know you're not in the <code>.val</code> case.</p>",
        "id": 497714998,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738688604
    },
    {
        "content": "<p>Ah got it, I only need to know \"is it a val or not\" so explicitly matching on the other cases would be less desirable. Thanks!</p>",
        "id": 497715449,
        "sender_full_name": "Dan Plyukhin",
        "timestamp": 1738688732
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"871585\">Dan Plyukhin</span> has marked this topic as resolved.</p>",
        "id": 497778627,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738712868
    }
]