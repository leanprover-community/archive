[
    {
        "content": "<p>Hi. Is it possible to assign mutable variables with dependent types inside a do notation? Here is an example what I'm trying to do:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"bp\">⟩</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">Σ'</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x₂</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_inj'</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x₁</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">break</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">x₁</span>\n</code></pre></div>\n<p>It doesn't compile because of some type mismatch. Maybe I just miss some part of lean syntax? :)</p>\n<p>It works if I assign them into a single variable like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">Σ'</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_inj'</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">break</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">fst</span>\n</code></pre></div>\n<p>It's less readable.</p>",
        "id": 465801564,
        "sender_full_name": "Evgeny Kurnevsky",
        "timestamp": 1724859863
    },
    {
        "content": "<p>Will you settle for this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">psig</span><span class=\"bp\">@⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"bp\">⟩</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">Σ'</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"n\">psig</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x₁</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x₂</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_inj'</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x₁</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">break</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">x₁</span>\n</code></pre></div>",
        "id": 465817494,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1724865535
    },
    {
        "content": "<p>Oh boy, that makes a really subtle change to the evaluation.</p>",
        "id": 465819077,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1724866272
    },
    {
        "content": "<p>Yeah, unfortunately it doesn't change x₁ outside the loop, otherwise it would look good :)</p>",
        "id": 465819547,
        "sender_full_name": "Evgeny Kurnevsky",
        "timestamp": 1724866478
    },
    {
        "content": "<p>And if I change it to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id.run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">psig</span><span class=\"bp\">@</span><span class=\"o\">⟨</span><span class=\"n\">x₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x₂</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"o\">⟩:</span><span class=\"w\"> </span><span class=\"bp\">Σ'</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span>\n<span class=\"w\">    </span><span class=\"n\">psig</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">⟨</span><span class=\"n\">x₁.succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x₂.succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat.succ_inj'.mpr</span><span class=\"w\"> </span><span class=\"n\">prop</span><span class=\"o\">⟩</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x₁</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">break</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">psig.fst</span>\n</code></pre></div>\n<p>it just gets stuck in the loop :)</p>",
        "id": 465821690,
        "sender_full_name": "Evgeny Kurnevsky",
        "timestamp": 1724867177
    },
    {
        "content": "<p>Yeah that behavior of the @- binding is rough. I would almost prefer that use of pattern bindings to be prohibited if it's going to create a second copy of the underlying value behind the scenes.</p>",
        "id": 465822625,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1724867570
    },
    {
        "content": "<p>I think I saw a proposal somewhere to force pattern bindings to be spelt with <code>have</code> instead</p>",
        "id": 465857268,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724882824
    }
]