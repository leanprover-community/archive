[
    {
        "content": "<p>For instance, <code>def abc</code> adds <code>abc.eq_def</code> as a top-level lemma, and <code>inductive xyz</code> adds <code>xyz.brecOn</code>, <code>xyz.below</code>, and <code>xyz.rec</code>.</p>\n<p>I have by chance figured out what I wrote above, but I would like to know exhaustive list of these. It would be very nice if there is a systematic way to do this e.g., I wish there is some flag that, when set to <code>true</code>, makes these information (what collaterals are added) to be printed to the <code>messages</code> whenever I execute a top-level command. Or maybe having some command <code>#print_all_defs_so_far</code> that prints all top-level definitions/theorems added so far in this file could also do the job (then I can try <code>#print_all_defs_so_far \\\\ def abc := 0 \\\\ #print_all_defs_so_far</code> to see what definitions are added).</p>\n<ul>\n<li>This will be useful for educational purpose, and also</li>\n<li>make the behavior of the <code>deriving</code> keywords more transparent. For example, when I have</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Hashable</span>\n</code></pre></div>\n<p>figuring out exactly what instance is being added is not straightforward for me. I fortunately was able to figure out the name of the instance usually follows <code>inst[classname][typename]</code>, so I tried <code>#print instHashablefoo</code> but it failed, and then tried the snakecase <code>#print instHashableFoo</code> and succeded.</p>",
        "id": 493008239,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736535345
    },
    {
        "content": "<p>you can use <code>whatsnew in</code> for that, i think</p>",
        "id": 493008671,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736535525
    },
    {
        "content": "<p>(i think that does require mathlib, tho)</p>",
        "id": 493008768,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736535575
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> That is amazing, thanks! There are quite a lot of definitions under the hood <span aria-label=\"surprise\" class=\"emoji emoji-1f62e\" role=\"img\" title=\"surprise\">:surprise:</span></p>",
        "id": 493011601,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736536794
    },
    {
        "content": "<p><code>whatsnew</code> is definitely informative, but still the printed information doesn't seem to be exhaustive (e.g., it doesn't include <code>.eq_def</code>, <code>.brecOn</code>, and <code>.below</code>).</p>",
        "id": 493012660,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736537214
    },
    {
        "content": "<p>Can you give an explicit example of where <code>whatsnew</code> fails to display a declaration which was created by a definition?</p>",
        "id": 493014062,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1736537745
    },
    {
        "content": "<p>from the looks of it, <code>brecOn</code> isn't always created, which may explain what you've observed?</p>",
        "id": 493014414,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736537904
    },
    {
        "content": "<p>(likely similar for the other names)</p>",
        "id": 493014450,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736537917
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> Right, my bad. Sorry for the confusion.<br>\n<span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> Still, in the following, <code>abc.eq_def</code> doesn't seem to be printed while it is defined.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">whatsnew</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">abc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">abc</span><span class=\"bp\">.</span><span class=\"n\">eq_def</span>\n</code></pre></div>",
        "id": 493014966,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736538180
    },
    {
        "content": "<p>Oh nice, I can indeed reproduce. That is definitely unexpected behaviour as far as I am concerned. The output of <code>whatsnew in</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>unsafe def abc._cstage2 : _obj :=\n0\n\ndef abc : ℕ :=\n0\n\nunsafe def abc._cstage1 : ℕ :=\n0\n\n-- Lean.declRangeExt extension: 1 new entries\n\n-- Lean.Compiler.specExtension extension: 1 new entries\n\n-- Lean.IR.declMapExt extension: 1 new entries\n\n-- Lean.IR.UnreachableBranches.functionSummariesExt extension: 1 new entries\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> is that expected?</p>",
        "id": 493018025,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1736539632
    },
    {
        "content": "<p><code>abc.eq_def</code> is generated on-demand, so it doesn't exist at that point <span class=\"user-mention\" data-user-id=\"748258\">@Youngju Song</span></p>",
        "id": 493021530,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736541232
    },
    {
        "content": "<p>but it's also not cached, is it? because <code>whatsnew in #check abc.eq_def</code> also doesn't say it now exists...</p>",
        "id": 493021881,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736541389
    },
    {
        "content": "<p>It is, but <code>#check</code> runs with <code>Lean.withoutModifyingEnv</code>, so the extended environment with this additional lemmas is immediately thrown away.</p>",
        "id": 493022064,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736541482
    },
    {
        "content": "<p>(If you search the Lean codebase for <code>registerReservedNameAction</code> you can see different modules that register code that does additional actions when resolving names, for example these <code>eq_*</code> lemmas.)</p>",
        "id": 493022191,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736541539
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Thanks for the clarification. It is interesting that definitions can be generated on-demand...! This is a rather exotic feature for me. Just out of curiosity, do you know the rationale behind this feature? I can imagine that this could potentially reduce the binary size (compared to always generating the definition), but not sure if that is the original intent.</p>",
        "id": 493024228,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736542544
    },
    {
        "content": "<p>I'm not sure of the exact rationale, but my understanding has been that the idea is that in programming applications you don't need any of the equation lemmas. Generating equation lemmas on-demand ensures that the cost is only paid once you start proving theorems about the definitions.</p>\n<p>I believe this doesn't affect executable sizes, only olean sizes. I don't recall any on-demand definitions, just on-demand theorems.</p>",
        "id": 493024753,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736542792
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Thank you for the explanations, that makes very much sense.</p>",
        "id": 493025875,
        "sender_full_name": "Youngju Song",
        "timestamp": 1736543320
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"748258\">Youngju Song</span> has marked this topic as resolved.</p>",
        "id": 493025893,
        "sender_full_name": "Notification Bot",
        "timestamp": 1736543326
    }
]