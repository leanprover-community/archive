[
    {
        "content": "<p>In this example copied from \"Metaprogramming in Lean 4\". Is it possible to get <code>type?</code> that is available in <code>myTerm1Impl</code> using the short <code>elab</code> syntax below?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myterm1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"myterm_1\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mytermValues</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">myterm1</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myTerm1Impl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">type?</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``List.get!</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``mytermValues</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- `MetaM` code</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myterm_1</span><span class=\"w\"> </span><span class=\"c1\">-- 1</span>\n\n<span class=\"c1\">-- Also works with `elab`</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"myterm_2\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``List.get!</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``mytermValues</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- `MetaM` code</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myterm_2</span><span class=\"w\"> </span><span class=\"c1\">-- 2</span>\n</code></pre></div>",
        "id": 561825519,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1764839084
    },
    {
        "content": "<p>That works ig <code>let type? := ‹Option Expr›</code>.</p>",
        "id": 561826962,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1764839485
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"myterm_2\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">myterm_2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- `type` is a metavariable</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">myterm_2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- `type` is ``Nat`</span>\n</code></pre></div>\n<p>The reference manual seems to not have documentation on <code>elab</code>, yet. But its elaborator can be found as<code>Lean.Elab.Command.elabElab</code>. <em>Metaprogramming in Lean 4</em> mentions the <code>&lt;= type</code> syntax at the very bottom of the <em>Elaboration</em> chapter, just before the exercises.</p>",
        "id": 561838816,
        "sender_full_name": "Sebastian Miele",
        "timestamp": 1764843174
    },
    {
        "content": "<p>Hm, but <code>type</code> is <code>Lean.Expr</code> in this case. Reading <code>Lean.Elab.Command.elabElab</code> it looks like it's using <code>Lean.Elab.Term.withExpectedType</code>, which will error when expected type is not known. So it's not the same.</p>\n<p>I could probably use both <code>elab \"myterm_2\" : term =&gt; commonLogic .none</code> and <code>elab \"myterm_2\" : term &lt;= type =&gt; do commonLogic (.some type)</code>.</p>\n<p>I think I'll just use <code>let type? := ‹Option Expr›</code>. It looks a bit hacky, but I think it's ok.</p>",
        "id": 561849888,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1764846625
    },
    {
        "content": "<p>Yeah, idk how you're supposed to do it but I always just used <code>‹_›</code> for this purpose (e.g. as in <code>elabTerm stx ‹_›</code>)</p>",
        "id": 561940315,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1764870147
    }
]