[
    {
        "content": "<p>Would you guys agree that the snippet below should not cause a stack overflow or would it be considered user error if I posted it as a GitHub issue? For a <em>slightly</em> less minimal example, cf. also my <a href=\"https://stackoverflow.com/q/79795377/2748899\">Stack Overflow question</a> about it.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Countdown</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">one</span>\n\n<span class=\"c1\">-- ForM.forM implementation that does absolutely nothing &amp; should terminate</span>\n<span class=\"c1\">-- after a single recursive call of itself (indirectly via `for` loop):</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Countdown</span><span class=\"bp\">.</span><span class=\"n\">forM</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Monad</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Countdown</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">action</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">PUnit</span>\n<span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"c1\">-- Functions that allow synthesis of local ForM &amp; ForIn instances, as</span>\n<span class=\"w\">      </span><span class=\"c1\">-- suggested in \"Instances for nested types\" example from [1]:</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">Countdown</span><span class=\"bp\">.</span><span class=\"n\">forM</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ForM</span><span class=\"w\"> </span><span class=\"n\">m'</span><span class=\"w\"> </span><span class=\"n\">Countdown</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m''</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">ForM</span><span class=\"bp\">.</span><span class=\"n\">forIn</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ForIn</span><span class=\"w\"> </span><span class=\"n\">m''</span><span class=\"w\"> </span><span class=\"n\">Countdown</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">return</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Countdown</span><span class=\"bp\">.</span><span class=\"n\">one</span><span class=\"bp\">.</span><span class=\"n\">forM</span><span class=\"w\"> </span><span class=\"n\">pure</span>\n\n<span class=\"c1\">-- Uncomment to cause stack overflow in Lean 4 Web version:</span>\n<span class=\"c1\">-- #eval main</span>\n\n<span class=\"c1\">-- [1]: https://lean-lang.org/doc/reference/latest//Type-Classes/Instance-Declarations/#recursive-instances</span>\n</code></pre></div>\n<p>It <a href=\"https://live.lean-lang.org/#project=lean-nightly&amp;codez=JYOwJgrgxgLsBuBTABAYQPYRDM6DuIyeAFogE6IBQyyAPsgF7nrV3LohWViIBmyAMXRkAsgDpewgJIgAcuhkAbUFRoBtERwCGYZAFsAusjVDRyABQBlGFpiIAKskBNwBYCiADyiIADjEcu9AEpA5EBB4GRARuADVnN3ZAAuMJDzACME52T+RIjkQCTCZzz9C1MZax8MkMS9Z0p4gF5BYXFJMhlkOLTeSkoAWh7G0Qkm5GA9b0VEPURsW2AOZBhiW2RcRABnZC0UtfRFCDtFAE9kEHRF0ABzZAAyZDXiTEVdOzI9UFsqPs3eF827y4myAoUAgZDWCBQUC0ikU7H4wBga0Qin45lAYGAwJgR2Q8GAWmQAAMWoTkIp0OhvIF4pRvFoyHBoSs+GhMNhcAQhqJWBptLpDBYoOkMFgcPgQMkAPpaWBzQiJACqIARhWqAAUlQjKkUNcqYLUGrh9LYoMRkEK8AjiKx6EwyOhkHUAHzIbyglDmQI29icR1O1g0GhfARYWUcDaLZbQ8l4O6HbCkcEbdD8clQ2GmEQ3AZtUBrGwgLxrAA0mzWAcDXzWEAuF3Wdl0oGQACIZPmtIX1sgWid64hnodvOtm8hEO4tGNAbx7dU1ABGAw0wOBiYwZAAbz0AHIAL4JBrmQAX5CL2eKuSJAJfk6Uz+i3rNFHMImpgXuXNFXG+3u/3FkPma5MjyEoKhXokJSEF+96ngQyDPq+b49p6IyEHaDq4BWy4UDAoIgN0PD8HoWhNokUgAPKwXq+6sCeYqchwiDnq67rdAAxIg8BMoRoDdF886LsgxAwDA3hrPEAD0YkTB2PSKB2FxiMIFxibgUBiRQvDkNMXiSR8+YSfYg6ID0qCyWsSJrGJbYFl4PQACKIFAslkLM4ZiSxwKguCSA9Hm1nrEAA\">works fine</a> if you explicitly use a non-inline version of <code>ForM.forIn</code>.</p>",
        "id": 546600254,
        "sender_full_name": "smheidrich",
        "timestamp": 1761201504
    },
    {
        "content": "<p>Thank you for the report. This is a miscompilation introduced by the new compiler which was enabled in Lean 4.22.0. I have created an issue with some further minimization at <a href=\"https://github.com/leanprover/lean4/pull/10925\">lean4#10925</a>.</p>",
        "id": 546620404,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1761208557
    },
    {
        "content": "<p>Thank you for looking into it! <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> So the non-inline thing fixing it was pure luck <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 546643001,
        "sender_full_name": "smheidrich",
        "timestamp": 1761215226
    }
]