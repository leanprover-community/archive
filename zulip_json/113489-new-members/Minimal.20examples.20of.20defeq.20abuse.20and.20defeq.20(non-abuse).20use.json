[
    {
        "content": "<p>For educational purposes, I'm putting together some simple and minimal examples that illustrate bothÂ defeq abuse (cases where relying on definitional equality becomes problematic) andÂ safe usesÂ of definitional equality, where such reliance is unproblematic.</p>\n<ol>\n<li>\n<p>What are some good examples (and non-examples) of defeq abuse?</p>\n</li>\n<li>\n<p>Are there any tools, linters, or similar mechanisms that can help detect the presence (or absence) of defeq abuse?</p>\n</li>\n<li>\n<p>Given a proof diff, whatâ€™s the recommended approach for identifying any defeq abuse introduced by the changes?</p>\n</li>\n</ol>",
        "id": 527039860,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1751561640
    },
    {
        "content": "<p>I would love to see those too. Is there a similar version of <code>simp</code> abuse?</p>",
        "id": 527040395,
        "sender_full_name": "Rado Kirov",
        "timestamp": 1751561840
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"488971\">@Rado Kirov</span> These are the <a href=\"https://leanprover-community.github.io/extras/simp.html#non-terminal-simps\"><code>simp</code> guidelines</a>.</p>\n<p>As I understand them (please correct me if I'm wrong!):</p>\n<ul>\n<li>If a <code>simp</code> invocation closes the goal (i.e., it is a terminal <code>simp</code>), then using <code>simp</code> is recommended (using <code>simp only [â€¦]</code> is discouraged).</li>\n<li>If a <code>simp</code> does not close the goal (i.e., it is a non-terminal <code>simp</code>), then it should typically be replaced with a more specific <code>simp only [â€¦]</code>, as identified using <code>simp?</code>.</li>\n</ul>",
        "id": 527044395,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1751563463
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"683979\">Isak Colboubrani</span> <a href=\"#narrow/channel/113489-new-members/topic/Minimal.20examples.20of.20defeq.20abuse.20and.20defeq.20.28non-abuse.29.20use/near/527044395\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"488971\">Rado Kirov</span> These are the <a href=\"https://leanprover-community.github.io/extras/simp.html#non-terminal-simps\"><code>simp</code> guidelines</a>.</p>\n<p>As I understand them (please correct me if I'm wrong!):</p>\n<ul>\n<li>If a <code>simp</code> invocation closes the goal (i.e., it is a terminal <code>simp</code>), then using <code>simp</code> is recommended (using <code>simp only [â€¦]</code> is discouraged).</li>\n<li>If a <code>simp</code> does not close the goal (i.e., it is a non-terminal <code>simp</code>), then it should typically be replaced with a more specific <code>simp only [â€¦]</code>, as identified using <code>simp?</code>.</li>\n</ul>\n</blockquote>\n<p>Looks alright to me. You can use mathlib's flexible linter (enable through <code>set_option linter.flexible true</code>) to detect one direction of this (namely, non-terminal <code>simp</code>s).</p>",
        "id": 527053027,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1751567074
    },
    {
        "content": "<p>Don't have good examples right now, but-</p>\n<ol>\n<li>It's fine to punch through a layer (typically no more than one at a time) of definitions while setting up the basic lemmas for that definition (so these should  be right next to the definition)</li>\n<li>It's typically not a good idea to rely on a definition as one step in a bigger proof or far away from the definition</li>\n<li>There's a few definitions where, in practice, we make use of the definition anyway, even though the general rule would frown upon it (e.g. <code>intro x hx</code> to prove a subset, or treating <code>Dvd.dvd</code> as an exists)</li>\n<li>There's a few red flags that make me double-check what's going on, like using <code>erw</code>, <code>change</code>, or <code>rfl</code> after <code>rw</code>/<code>simp</code></li>\n</ol>",
        "id": 527058586,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1751569381
    },
    {
        "content": "<p>Not examples, but my working definition of defeq abuse is here: <a class=\"message-link\" href=\"/#narrow/channel/113489-new-members/topic/Definitions.20of.20.22defeq.22.2C.20.22diamond.22.20and.20.22.CE.B2.2F.CE.B4.2F.CE.B7.2F.CE.B6.20reductions.22/near/508091884\">#new members &gt; Definitions of \"defeq\", \"diamond\" and \"Î²/Î´/Î·/Î¶ reductions\" @ ðŸ’¬</a></p>",
        "id": 527067507,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1751573965
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"683979\">@Isak Colboubrani</span> the biggest and most problematic defeq abuse I've seen and which is actually discussed about, is the various Lp norms on a space, which are introduced as type synonyms. As in, the sup norm and L2 norm on R^n, the underlying sets (i.e. types) are actually defeq</p>",
        "id": 527085115,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1751584308
    },
    {
        "content": "<p>Here's an example of the sort that I run into. By definition, <code>Î±áµ’áµˆ</code> is the same thing as <code>Î±</code> and so in the first definition of <code>dual</code>, it looks past this definition. But then the following proofs cannot be solved by <code>simp</code>. On the other hand, <code>dual'</code> respects the definition and so <code>simp</code> works. One way to avoid this is by writing <code>seal OrderDual</code> at the top of the file.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"bp\">â†ª</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"bp\">áµ’áµˆ</span><span class=\"w\"> </span><span class=\"bp\">â†ª</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"bp\">áµ’áµˆ</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">map_rel_iff'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">dual'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"bp\">â†ª</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"bp\">áµ’áµˆ</span><span class=\"w\"> </span><span class=\"bp\">â†ª</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"bp\">áµ’áµˆ</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">OrderDual</span><span class=\"bp\">.</span><span class=\"n\">toDual</span><span class=\"w\"> </span><span class=\"bp\">âˆ˜</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">âˆ˜</span><span class=\"w\"> </span><span class=\"n\">OrderDual</span><span class=\"bp\">.</span><span class=\"n\">ofDual</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">map_rel_iff'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>",
        "id": 527100802,
        "sender_full_name": "Eric Paul",
        "timestamp": 1751599530
    }
]