[
    {
        "content": "<p>In my 3-day lean course (first time teaching it this week, having an amazing time) I rely heavily on <code>#guard_msgs</code> and it seems <del>in 4.9.0</del> (true for 4.8.0 also) I can use it to get things that don't compile in the binary:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">Fls</span>\n\n<span class=\"sd\">/-- error: failed to synthesize</span>\n<span class=\"sd\">  Inhabited Fls</span>\n<span class=\"sd\">use `set_option diagnostics true` to get diagnostic information</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">illogicPanic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fls</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">panic</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"just trust me\"</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"running\"</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>❯ lake exe guardmsgs\nINTERNAL PANIC: executed 'sorry'\n</code></pre></div>",
        "id": 448995325,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1720066169
    },
    {
        "content": "<p>This caused a crash, but I can also cause <code>main</code> to loop forever:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">Fls</span>\n\n<span class=\"sd\">/-- error:</span>\n<span class=\"sd\">fail to show termination for</span>\n<span class=\"sd\">  illogicRec</span>\n<span class=\"sd\">with errors</span>\n<span class=\"sd\">structural recursion cannot be used</span>\n\n<span class=\"sd\">well-founded recursion cannot be used, 'illogicRec' does not take any (non-fixed) arguments</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">illogicRec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fls</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">illogicRec</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"running\"</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>❯ time lake exe guardmsgs\n^C\n________________________________________________________\nExecuted in    6.67 secs      fish           external\n   usr time  111.11 millis    0.12 millis  110.99 millis\n   sys time   56.48 millis    1.44 millis   55.03 millis\n</code></pre></div>",
        "id": 448995748,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1720066308
    },
    {
        "content": "<p>Should I go ahead and open an issue?</p>",
        "id": 448995870,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1720066350
    },
    {
        "content": "<p>Separately, and I don't think this is related to 4.9.0, but I find it strange that error-producing definitions are added to the environment as long as you <code>#guard_msgs</code> the errors. For example, I would expect this not to compile (unlike my examples above which do and should compile, just not impact runtime):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">inductive</span><span class=\"w\"> </span><span class=\"n\">Fls</span>\n\n<span class=\"sd\">/-- error:</span>\n<span class=\"sd\">fail to show termination for</span>\n<span class=\"sd\">  illogicRec</span>\n<span class=\"sd\">with errors</span>\n<span class=\"sd\">structural recursion cannot be used</span>\n\n<span class=\"sd\">well-founded recursion cannot be used, 'illogicRec' does not take any (non-fixed) arguments</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">illogicRec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fls</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">illogicRec</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">illogicRec</span>\n<span class=\"w\">  </span><span class=\"n\">println</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"s2\">\"probably not reaching that\"</span>\n</code></pre></div>\n<p>but it does compile and (unsuprisingly) loops forever when <code>lean exe</code>-d</p>",
        "id": 448996238,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1720066595
    },
    {
        "content": "<p>Obviously you can <em>seemingly</em> prove <code>False</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- error:</span>\n<span class=\"sd\">fail to show termination for</span>\n<span class=\"sd\">  illogicRec</span>\n<span class=\"sd\">with errors</span>\n<span class=\"sd\">structural recursion cannot be used</span>\n\n<span class=\"sd\">well-founded recursion cannot be used, 'illogicRec' does not take any (non-fixed) arguments</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">illogicRec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">illogicRec</span>\n\n<span class=\"kd\">theorem</span><span class=\"w\"> </span><span class=\"n\">explode</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">illogicRec</span>\n</code></pre></div>",
        "id": 448996843,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1720066852
    },
    {
        "content": "<p>Fortunately <code>#print axioms explode</code> shows that <code>sorryAx</code> is used.</p>",
        "id": 449001738,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1720069224
    },
    {
        "content": "<p>Yeah, the bug I’m reporting is thankfully not a soundness bug!</p>",
        "id": 449003086,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1720069796
    },
    {
        "content": "<p>The nontermination issue is the same as <a href=\"https://github.com/leanprover/lean4/pull/1965\">lean4#1965</a>: <code>illogicRec</code> is extracted as a closed term and evaluated at initialization time</p>",
        "id": 449078388,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720096943
    }
]