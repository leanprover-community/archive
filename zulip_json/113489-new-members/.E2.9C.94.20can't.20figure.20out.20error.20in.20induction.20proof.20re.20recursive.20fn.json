[
    {
        "content": "<p>The following is a translation to vanilla Lean from an MoP exercise solution I'm working on.</p>\n<p>It looks ok to me but Lean is complaining about the line I've highlighted.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"c1\">---</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"c1\">---</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction'</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">IH</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"c1\">-- base case</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pascal</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"c1\">-- induction step</span>\n<span class=\"w\">    </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pascal</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">--- -- -- --  error</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pascal</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IH</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n</code></pre></div>\n<p>The error is not as helpful as I'd like:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>unsolved goals\nk : ℕ\nIH : pascal k 1 = k + 1\n⊢ pascal (k + 1) (0 + 1) = 1 + pascal k (0 + 1)\n</code></pre></div>\n<p>I can't see what the issue is.  I have used <code>rw [pascal]</code> in the hope it selects the 3rd constructor which I hope says:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 498142210,
        "sender_full_name": "rzeta0",
        "timestamp": 1738854229
    },
    {
        "content": "<p><code>simp [pascal]</code> does it immediately.</p>",
        "id": 498144227,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1738854731
    },
    {
        "content": "<p>The issue is that the LHS and RHS don't match because it's rewriting a different term than what you expect. To force the LHS to be unfolded, you can use <code>conv =&gt; lhs; rw [pascal] </code></p>",
        "id": 498145261,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738855022
    },
    {
        "content": "<p>Also <code>rw [pascal, IH, pascal, IH, pascal]</code> works</p>",
        "id": 498145337,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1738855045
    },
    {
        "content": "<p>thanks for the replies.</p>\n<p>I'm interested in why it doesn't work because in the MoP we've only learned to use <code>rw</code> to select \"arms \\ constructors\" of a recursive definition. We've not learned about <code>simp</code>. (Actually <code>simp</code> is disabled in MoP)</p>\n<p>Why isn't the LHS not the RHS, as <span class=\"user-mention\" data-user-id=\"761203\">@Vlad Tsyrklevich</span> mentions?</p>",
        "id": 498147352,
        "sender_full_name": "rzeta0",
        "timestamp": 1738855552
    },
    {
        "content": "<p><code>rw [pascal, pascal, pascal]</code> or Riccardo's version also works, so you can do it without simp or conv</p>",
        "id": 498148672,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738855885
    },
    {
        "content": "<p>I think what happens is that <code>rw</code> first tries the <em>first</em> equational lemma of <code>pascal</code> and finds a place where it applies (the first occurrence on the right hand side).</p>",
        "id": 498149170,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1738856001
    },
    {
        "content": "<p>If you add <code>; sorry</code> after <code>rw [pascal]</code> where the error occurs and put the cursor before the <code>sorry</code>, you can see that the goal was changed to <code>pascal (k + 1) (0 + 1) = 1 + pascal k (0 + 1)</code>.</p>",
        "id": 498150120,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1738856238
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover/lean4/pull/5026\">lean4#5026</a></p>",
        "id": 498154202,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738857258
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479359\">@Michael Stoll</span>  by \"first equational lemma\" do you mean it matches </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>.. this surprises me because the second parameter is not <code>0</code>, it is <code>(0+1)</code>.</p>",
        "id": 498157594,
        "sender_full_name": "rzeta0",
        "timestamp": 1738858107
    },
    {
        "content": "<p><del>I guess it is the first that matches somewhere (sorry; I may not have looked too carefully).</del><br>\nIt does rewrite <code>pascal (k + 1) 0</code> to <code>1</code>, which is an application of the first arm in the definition.</p>",
        "id": 498158138,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1738858258
    },
    {
        "content": "<p>One way to fix this is to prove a lemma that states exactly the rewriting you want, like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">pascal_step</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pascal</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pascal</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Now, in the step in your proof where you got your error, you can use <code>by rw [pascal_step]</code> and it will work.</p>\n<p>I often find it useful to prove a lemma that specifies a particular way of rewriting something, and then appeal to the lemma in a rewriting step.</p>",
        "id": 498182850,
        "sender_full_name": "Dan Velleman",
        "timestamp": 1738865562
    },
    {
        "content": "<p>I've gone with <code>by rw [pascal._eq_3]</code> as a fix, because semantically it is closest to what I intended the code to actually do.</p>\n<p>Do we all agree this is a bug in the language?</p>",
        "id": 498216069,
        "sender_full_name": "rzeta0",
        "timestamp": 1738878368
    },
    {
        "content": "<p>I wouldn't call it a bug.  I would say <code>rw [pascal]</code> is ambiguous.  It means \"find something that can be rewritten by the definition of <code>pascal</code> and rewrite it.\"  If there's more than one thing that can be rewritten by applying the definition, then Lean has to try to guess which one you meant, and you can't expect that it will always guess what you had in mind.  If it doesn't, the solution is to be more explicit and tell Lean exactly what rewriting you wanted.</p>",
        "id": 498216642,
        "sender_full_name": "Dan Velleman",
        "timestamp": 1738878610
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"453098\">@Dan Velleman</span>  - I'm struggling to see how <code>pascal (k + 1) (0 + 1)</code> matches with any of the first two options:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>I could if the variables were integers, but they're naturals so both <code>k+1</code> and <code>0+1</code> are <code>&gt;0</code> and shouldn't match.</p>\n<p>What have I missed?</p>",
        "id": 498220764,
        "sender_full_name": "rzeta0",
        "timestamp": 1738880246
    },
    {
        "content": "<p>No, that's not the one that matches.  In the step where you had an error, the goal was: <code>pascal (k + 1) (0 + 1) = pascal (k + 1) 0 + pascal k (0 + 1)</code>.  So there were three occurrences of <code>pascal</code>, and Lean had to guess which one you wanted it to rewrite.  It chose the second one, <code>pascal (k + 1) 0</code>, and it rewrote it as <code>1</code>.</p>\n<p>When you have <code>rw [...]</code>, if you put the cursor right after the open square bracket, in the Infoview, the expression that is going to get rewritten is highlighted.  If you have <code>rw [..., ..., ...]</code>, try putting the cursor right after the open square bracket and then move it one character at a time to the right.  You will see the rewrites happen, one by one, in the Infoview.</p>",
        "id": 498221580,
        "sender_full_name": "Dan Velleman",
        "timestamp": 1738880598
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"724904\">rzeta0</span> has marked this topic as resolved.</p>",
        "id": 498229338,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738884101
    },
    {
        "content": "<p>an excellent explanation - thanks Dan.</p>",
        "id": 498229358,
        "sender_full_name": "rzeta0",
        "timestamp": 1738884114
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"724904\">rzeta0</span> has marked this topic as unresolved.</p>",
        "id": 498229911,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738884400
    },
    {
        "content": "<p>I think my misunderstanding here is that in a general calc</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">calc</span>\n<span class=\"w\">  </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">.</span><span class=\"w\">    </span><span class=\"c1\">--- goal is A=B</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span><span class=\"w\">    </span><span class=\"c1\">--- goal is B=C</span>\n</code></pre></div>\n<p>I had thought that <code>rw [h]</code> only looks at <code>B</code> for expressions to rewrite in order to justify <code>C</code>.</p>\n<p>I am wrong it seems. It seems that <code>rw</code> look at the entire LHS and RHS of a goal for candidate expressions for rewriting</p>\n<p>Have I got this right?</p>",
        "id": 498230205,
        "sender_full_name": "rzeta0",
        "timestamp": 1738884555
    },
    {
        "content": "<p><code>rw</code> works on anything. So if your goal is <code>Even n</code> and you have <code>h : n = m</code>, you can <code>rw [h]</code> to turn the goal into <code>Even m</code>. It does not only work on the lhs of equalities, and will search the entire goal for occurrences of the pattern.</p>",
        "id": 498231177,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738885098
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"724904\">rzeta0</span> has marked this topic as resolved.</p>",
        "id": 498232299,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738885768
    }
]