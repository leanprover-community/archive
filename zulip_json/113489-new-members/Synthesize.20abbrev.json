[
    {
        "content": "<p>I think I've probably asked a similar (but not quite) question before, but why things I define using <code>abbrev</code> do not work well with typeclass synthesis? An example would be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Inner</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"n\">V</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Inner</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>The second command works well, the first doesn't...</p>",
        "id": 466203527,
        "sender_full_name": "jsodd",
        "timestamp": 1725008273
    },
    {
        "content": "<p>Is this a bug/not yet implemented or I'm wrong to expect it to work and there is a deeper reason not to?</p>",
        "id": 466204396,
        "sender_full_name": "jsodd",
        "timestamp": 1725008473
    },
    {
        "content": "<p>Where did <code>n</code> come from?</p>",
        "id": 466205242,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725008652
    },
    {
        "content": "<p>Sorry, added to the post.</p>",
        "id": 466205448,
        "sender_full_name": "jsodd",
        "timestamp": 1725008694
    },
    {
        "content": "<p>Here <code>V</code> is not a euclidean space, but a function which to a type <code>n</code> associates a euclidean space.</p>",
        "id": 466209992,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1725009853
    },
    {
        "content": "<p>indeed; this works : <code>#synth Inner ℝ (V (n := n))</code></p>",
        "id": 466210347,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725009951
    },
    {
        "content": "<p>I don't know the technical details, but okay. Still, you see what I wanted to do? Just give <code>EuclideanSpace ℝ n</code> a name in order to not rewrite it a hundred times.</p>",
        "id": 466210503,
        "sender_full_name": "jsodd",
        "timestamp": 1725009989
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/stream/113489-new-members/topic/Synthesize.20abbrev/near/466210347\">said</a>:</p>\n<blockquote>\n<p>indeed; this works : <code>#synth Inner ℝ (V (n := n))</code></p>\n</blockquote>\n<p>This is nice to know, but it's virtually of the same length as <code>EuclideanSpace ℝ n</code>, and I wanted to curtail the notation.</p>",
        "id": 466211034,
        "sender_full_name": "jsodd",
        "timestamp": 1725010110
    },
    {
        "content": "<p>you could use the following trick:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">hygiene</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"V\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>i would advise you to namespace this notation, as it is quite context-sensitive</p>",
        "id": 466212132,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725010361
    },
    {
        "content": "<p>as well as prone to collision</p>",
        "id": 466212253,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725010378
    },
    {
        "content": "<p>you could alternatively (and possibly preferably) make the argument <code>n</code> to <code>V</code> explicit like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 466213512,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725010641
    },
    {
        "content": "<p>this way, <code>V n</code> will refer to the type you intend</p>",
        "id": 466213619,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725010669
    },
    {
        "content": "<p>What does <code>hygiene false</code> mean?</p>",
        "id": 466213622,
        "sender_full_name": "jsodd",
        "timestamp": 1725010670
    },
    {
        "content": "<p>(and then <code>#synth Inner ℝ (V n)</code>)</p>",
        "id": 466213649,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725010677
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"743246\">jsodd</span> <a href=\"#narrow/stream/113489-new-members/topic/Synthesize.20abbrev/near/466213622\">said</a>:</p>\n<blockquote>\n<p>What does <code>hygiene false</code> mean?</p>\n</blockquote>\n<p>the primary issue why your earlier attempt failed was that <code>n</code> is not some constant, but a free variable introduced in the context. (particularly an implicit free variable) </p>\n<p>Lean warns against hiding a statement containing such a free variable behind notation, because it can cause an issue; the notation will still be made available even when a surrounding section ends, but the context may no longer contain the same <code>n</code>. Worse even: it may contain a different, entirely unrelated <code>n</code>! <br>\nIn this sense the notation is \"unhygienic\", as it can be contaminated by switching contexts. Setting the <code>hygiene</code> option to <code>false</code> makes lean accept this unhygienic notation.</p>",
        "id": 466215471,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725011036
    },
    {
        "content": "<p>So the problem is that Lean doesn't interpret <code>n</code> in <code>abbrev V := ...</code> as the <code>n</code> from <code>variable {n : Type} [Fintype n]</code>? Instead, <code>n</code> in <code>abbrev V := ...</code> is a free variable? I see how this can be problematic</p>",
        "id": 466216933,
        "sender_full_name": "jsodd",
        "timestamp": 1725011250
    },
    {
        "content": "<p>well... once you defined <code>V</code> as an <code>abbrev</code>, the <code>n</code> in it is no longer free but <em>bound</em>, but you seem to understand the issue.</p>",
        "id": 466218961,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725011594
    },
    {
        "content": "<p>the <code>n</code> from <code>variable {n : Type} [Fintype n]</code> <em>is</em> free though.</p>",
        "id": 466219193,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725011633
    },
    {
        "content": "<p><code>variable n</code> does not mean \"make a new variable and call it <code>n</code>\". It means \"do nothing, but the next time someone mentions n in a statement, silently add a \"for all n\" at the beginning\"</p>",
        "id": 466247848,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1725018017
    },
    {
        "content": "<p>lets add an asterisk* for the behaviour relating to <code>theorem</code> (and <code>lemma</code> in mathlib), but yes, that is usually effectively what happens</p>",
        "id": 466248581,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1725018232
    }
]