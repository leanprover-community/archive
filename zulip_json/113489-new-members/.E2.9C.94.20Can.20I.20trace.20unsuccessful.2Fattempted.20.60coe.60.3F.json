[
    {
        "content": "<p>I am trying to figure out why my type conversion is not getting applied.</p>\n<p>I've tried <code>trace.Meta.synthInstance</code> and <code>trace.Elab.coe</code> but they only show me the results when the application was successful, not when the line contains an error (i.e. because my <code>coe</code> wasn't applied).</p>\n<p>Is there a way to do that?</p>",
        "id": 474110557,
        "sender_full_name": "Tom",
        "timestamp": 1727810464
    },
    {
        "content": "<p>Yes, the first option shows you that. Do you have a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> where it doesn't? (These kinds of questions are always easier to answer with a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>.)</p>\n<p>Here's my mwe showing that there's a failed CoeT:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"c1\">-- [Meta.synthInstance] ‚ùåÔ∏è CoeT ‚Ñ§ n ‚Ñï</span>\n</code></pre></div>",
        "id": 474112132,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727810975
    },
    {
        "content": "<p>Thanks - sorry, you're right.  I was reading the output wrong.</p>\n<p>Still, it still doesn't give me enough information to try and figure out why this MWE doesn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">range</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">‚àà</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoeDep</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">arr1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[:</span><span class=\"n\">arr1</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>I am not sure if something like that is possible.</p>",
        "id": 474115331,
        "sender_full_name": "Tom",
        "timestamp": 1727812094
    },
    {
        "content": "<p>One issue I see is that in that instance there's no way to solve for such an <code>h</code> using <code>Nat</code> or <code>Fin range.stop</code>. That would take some automation trying to prove it automatically.</p>\n<p>Typeclass inference doesn't make use of local hypotheses, other than local instances.</p>",
        "id": 474115995,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727812324
    },
    {
        "content": "<p>Though the actual failure seems to be this line:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">CoeDep</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1148</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">‚úù</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">CoeDep</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1275</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1276</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>It's not willing to solve for <code>?m.1148</code> (which comes from <code>_</code> in <code>Fin _</code>). Generally coercions can't fill in metavariables. It's a limitation for indexed types like this, though I think someone came up with a hack on a recent Zulip post for this.</p>",
        "id": 474116153,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727812402
    },
    {
        "content": "<p>Oh, that someone was you: <a href=\"#narrow/stream/113489-new-members/topic/.E2.9C.94.20Why.20.60OfNat.20.28P.20n.29.20n.60.20doesn't.20guess.20.60n.60.20with.20literals.3F/near/472386504\">https://leanprover.zulipchat.com/#narrow/stream/113489-new-members/topic/.E2.9C.94.20Why.20.60OfNat.20.28P.20n.29.20n.60.20doesn't.20guess.20.60n.60.20with.20literals.3F/near/472386504</a></p>",
        "id": 474116526,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727812555
    },
    {
        "content": "<p><span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span> <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> , I didn't realize people replied!  I will go re-read.</p>",
        "id": 474116970,
        "sender_full_name": "Tom",
        "timestamp": 1727812704
    },
    {
        "content": "<p>I see.  You mean at the end of the discussion after my \"hack\" solution, the answer from Daniel Weber saying that</p>\n<blockquote>\n<p>I believe you have to explicitly give the type:¬†<code>#check (x : BoundedNat x (x + 1))</code></p>\n</blockquote>",
        "id": 474117756,
        "sender_full_name": "Tom",
        "timestamp": 1727812984
    },
    {
        "content": "<p>I do mean your hack, not Daniel's suggestion. Daniel is saying you're normally supposed to just give the expected type, but the default instances are a way to circumvent this restriction.</p>\n<p>It's definitely a hack though, and we couldn't want to rely on it for real, but it's nice to have for experimental purposes.</p>",
        "id": 474130611,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727818031
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> has marked this topic as resolved.</p>",
        "id": 474134179,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727819621
    }
]