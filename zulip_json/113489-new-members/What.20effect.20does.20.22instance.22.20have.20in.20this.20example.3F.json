[
    {
        "content": "<p>I was just trying things and was surprised that the following compiled without warnings or errors:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>I am quite confused as to what <code>instance</code> could possibly mean here. In particular, what is <code>bar</code> an instance of?</p>",
        "id": 472569008,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727209935
    },
    {
        "content": "<p>My understanding is that an \"instance\" is a specific instantiation (value) of a type (class).  These get registered with the elaborator and can be automatically found later during type class synthesis and as such, typically don't need a name, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n</code></pre></div>\n<p>is effectively converted to something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">elaboratorGeneratedName</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"n\">fields</span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"n\">elaborator_magic</span><span class=\"bp\">.</span><span class=\"n\">register_instance</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">elaboratorGeneratedName</span><span class=\"bp\">&gt;</span>\n</code></pre></div>\n<p>E.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">myTypeAdd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">myTypeAdd</span>\n</code></pre></div>\n<p>is <code>{ add := fun x y =&gt; sorryAx ?m.233 }</code></p>\n<p>I think in this instance (ha!), it looks like your type is a function, so the instance is a value of a function type:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n</code></pre></div>\n<p>is <code>fun n =&gt; &lt;snip&gt;</code></p>\n<p>You can try this by e.g. by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>produces <code>fun x =&gt; x.succ</code></p>\n<p>So it seems <code>instance</code> is just a \"surface level\"/Elaborator syntax for the above.</p>\n<p>Unfortunately, I'm just a noob so don't know if</p>\n<p>1) This/using functions has any implications on instance synthesis/registration (or whatever that may mean in this case)<br>\n2) I don't know whether the explicit name for the instance is useful beyond giving a name which is more \"readable\" to you</p>",
        "id": 472573650,
        "sender_full_name": "Tom",
        "timestamp": 1727211930
    },
    {
        "content": "<p>FWIW, I <em>think</em> the \"registration magic\" looks like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 472574041,
        "sender_full_name": "Tom",
        "timestamp": 1727212106
    },
    {
        "content": "<p>(Terminology: \"elaborator\" instead of \"compiler\". There's a compiler too, but it's for turning elaborated declarations into executable code.)</p>",
        "id": 472575430,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727212816
    },
    {
        "content": "<p>I am still trying to make sense of this. So <code>instance</code> is basically <code>attribute [instance]</code> before a <code>def</code>? Does that mean that it can never fail?</p>",
        "id": 472575985,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213116
    },
    {
        "content": "<p>Yes, <code>instance foo ...</code> is pretty much <code>@[instance] def foo ...</code>. If <code>foo</code> isn't provided, it generates a name for you.</p>\n<p>Could you say a bit more what you're confused about? Why did you expect it to fail?</p>",
        "id": 472576198,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213229
    },
    {
        "content": "<p>I thought an instance has to be associated with a class definition.</p>",
        "id": 472576254,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213268
    },
    {
        "content": "<p>In my example, no class was defined. So I wasn't sure what class the definition was an instance of.</p>",
        "id": 472576398,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213329
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Decidable#doc\">docs#Decidable</a> is a class, does that help?</p>",
        "id": 472576939,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213450
    },
    {
        "content": "<p>I can understand that if the part <code>(n : Nat)</code> wasn't there.</p>",
        "id": 472577056,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213502
    },
    {
        "content": "<p>Something like <code>instance : Decidable (1 = 1)</code> makes sense to me.</p>",
        "id": 472577169,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213544
    },
    {
        "content": "<p>(<em>Edit</em>: This isn't quite right.) It turns out that <code>(n : ℕ) → Decidable (n = 1)</code> is a class too. So long as the resulting value for a function type is a class, then it's a class. This class is parameterized by the variable <code>n</code>. It applies to <code>Decidable (0 = 1)</code>, <code>Decidable (1 = 1)</code>, <code>Decidable (2 = 1)</code>, etc.</p>",
        "id": 472577345,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213645
    },
    {
        "content": "<p>Also, just like for normal definitions, both of these are equivalent:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 472577383,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213674
    },
    {
        "content": "<p>So, it is a class that takes a parameter?</p>",
        "id": 472577445,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213722
    },
    {
        "content": "<p>Yes. Many (most?) instances take parameters.</p>",
        "id": 472577462,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213738
    },
    {
        "content": "<p>At least internally, <code>(n : ℕ) → Decidable (n = 1)</code> is a class, but the class \"is\" <code>Decidable</code>. Not sure if this phrasing helps at all.</p>",
        "id": 472577587,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213797
    },
    {
        "content": "<p>I guess I was confused by that <code>Decidable</code> takes a <code>Prop</code> and didn't know that <code>Prop</code> can be parametrized.</p>",
        "id": 472577615,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213816
    },
    {
        "content": "<p>Sorry, I'm really messing this up.</p>",
        "id": 472577618,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213819
    },
    {
        "content": "<p>I'm meaning to say that the class is <code>Decidable</code>, but <code>(n : ℕ) → Decidable (n = 1)</code> is a valid type for an instance.</p>",
        "id": 472577653,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213837
    },
    {
        "content": "<p>It's a parameterized instance.</p>",
        "id": 472577662,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727213843
    },
    {
        "content": "<p>Interesting.</p>",
        "id": 472577691,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727213867
    },
    {
        "content": "<p>During instance synthesis, this corresponds to the rule that <code>Decidable (_ = 1)</code> can always be satisfied, with any Nat in place of _</p>",
        "id": 472577971,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727214023
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/113489-new-members/topic/What.20effect.20does.20.22instance.22.20have.20in.20this.20example.3F/near/472575430\">said</a>:</p>\n<blockquote>\n<p>(Terminology: \"elaborator\" instead of \"compiler\". There's a compiler too, but it's for turning elaborated declarations into executable code.)</p>\n</blockquote>\n<p>Thanks, fixed.  I promised I'll start getting this right.  <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 472580198,
        "sender_full_name": "Tom",
        "timestamp": 1727215346
    },
    {
        "content": "<p>Thanks for the explanation. Very helpful.</p>",
        "id": 472582852,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1727216979
    }
]