[
    {
        "content": "<p>I am continuing in my attempts at breaking things.  <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span><br>\nI am surprised that the following doesn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getFoo</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instBar</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Hi\"</span>\n</code></pre></div>\n<p>I receive an error </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"s2\">\"HI\"</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>\n<p>From my understanding of how type classes and <code>outParam</code> works, I would expect Lean to<br>\n1) Search for <code>Fooable Nat B</code><br>\n2) Find the instance <code>Fooable Nat String</code><br>\n3) Unify <code>B</code> with <code>String</code></p>\n<p>By the way, I tried making the instance \"local, too, i.e.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instBar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getFoo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">B</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]:</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Hi\"</span>\n</code></pre></div>\n<p>but I get the same error.</p>\n<p>Why doesn't the above work?</p>",
        "id": 473469502,
        "sender_full_name": "Tom",
        "timestamp": 1727629923
    },
    {
        "content": "<p>your logic is correct, except that it can't unify <code>B</code> with <code>String</code>, because <code>B</code> is a variable.</p>",
        "id": 473469662,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727630049
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> .  What do you mean by</p>\n<blockquote>\n<p>it can't unify <code>B</code> with <code>String</code>, because <code>B</code> is a variable.</p>\n</blockquote>\n<p>I am not sure what you mean.  In unification, don't you unify variables with values?  I.e. I understand that e.g. the ground terms <code>String</code> and <code>Int</code> won't unify but <code>B</code> (a variable) and <code>String</code> should unify with the substitution <code>{B : String}</code>, no?</p>\n<p>I think I'm misunderstanding what you mean.</p>",
        "id": 473470105,
        "sender_full_name": "Tom",
        "timestamp": 1727630262
    },
    {
        "content": "<p>you unify <em>meta</em>variables</p>",
        "id": 473470219,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727630283
    },
    {
        "content": "<p>So is there a way to make the above work?</p>",
        "id": 473470596,
        "sender_full_name": "Tom",
        "timestamp": 1727630386
    },
    {
        "content": "<p>i'm not sure what the intention is with this code, so before i go suggesting changes, could you shed some light on that?</p>",
        "id": 473471294,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727630551
    },
    {
        "content": "<p>I guess I still have a misunderstanding between \"variables\" and \"metavariables\".  So in an example like e.g. like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">test</span>\n</code></pre></div>\n<p>Would it be correct to say that <code>v1</code> and <code>v2</code> both introduce metavaribles in <code>Fin</code> (e.g. Fin N1 and Fin N2), then proceed to unify N1 and N2 and hence produce the <strong>variable</strong> <code>n</code>?</p>\n<p>Given an expression, is there a way to see the metavariables?</p>",
        "id": 473472876,
        "sender_full_name": "Tom",
        "timestamp": 1727631016
    },
    {
        "content": "<p>No, that's not correct to say. Metavariables are how implicit arguments work, they're expressions that haven't been solved for yet. In your example, <code>Fin n</code> is completely known.</p>",
        "id": 473473185,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631321
    },
    {
        "content": "<p>You can set <code>set_option pp.instantiateMVars false</code> in some contexts, to prevent solved-for metavariables from getting substituted in while pretty printing. It doesn't work in the Infoview though.</p>",
        "id": 473473217,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631360
    },
    {
        "content": "<p>i think there might be a small moment in elaboration when it isn't known, right after it is added as an implicit variable because of <code>autoImplicit</code>? but it does indeed get resolved right away.</p>",
        "id": 473473314,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727631416
    },
    {
        "content": "<p>The main issue with your first example is that <code>Fooable Nat B</code> doesn't imply that <code>B</code> is <code>String</code>. It's just supposed to be <code>String</code>, since you've said <code>B</code> is an outParam and you've given an instance, but Lean isn't able to make use of this fact.</p>",
        "id": 473473323,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631432
    },
    {
        "content": "<p>it simply might not be true.</p>",
        "id": 473473353,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727631459
    },
    {
        "content": "<p>You're right regarding autoimplicit: there will be a metavariable for the type of <code>n</code></p>",
        "id": 473473407,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631492
    },
    {
        "content": "<p>(i think, i have not tested making conflicting instances using autoimplicit)</p>",
        "id": 473473408,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727631494
    },
    {
        "content": "<p>It gets solved for once <code>Fin n</code> is elaborated, and the type of <code>n</code> becomes <code>Nat</code>.</p>",
        "id": 473473426,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631515
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> </p>\n<p>Thank you for helping me.</p>\n<blockquote>\n<p>It's just supposed to be <code>String</code>, since you've said <code>B</code> is an outParam and you've given an instance, but Lean isn't able to make use of this fact.</p>\n</blockquote>\n<p>I don't quite understand this sentence, sorry.</p>",
        "id": 473473471,
        "sender_full_name": "Tom",
        "timestamp": 1727631576
    },
    {
        "content": "<p>I don't know what you're going for <span class=\"user-mention\" data-user-id=\"515083\">@Tom</span>, but this looks like what I'd expect:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instBar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getFoo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Hi\"</span>\n</code></pre></div>",
        "id": 473473490,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631598
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/113489-new-members/topic/Why.20doesn't.20this.20outParam.20work.3F/near/473473426\">said</a>:</p>\n<blockquote>\n<p>It gets solved for once <code>Fin n</code> is elaborated, and the type of <code>n</code> becomes <code>Nat</code>.</p>\n</blockquote>\n<p>So are you saying that my example/explanation is correct?  I am sorry, I don't quite follow the back-and-forth between you and <span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> ... <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 473473569,
        "sender_full_name": "Tom",
        "timestamp": 1727631626
    },
    {
        "content": "<p>No, I'm not. There's just a subtle detail that autoImplicit introduces <code>{n : _}</code>. The variable <code>n</code> is never a metavariable.</p>",
        "id": 473473601,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631667
    },
    {
        "content": "<p>I'm saying that while <code>instFoo</code> shows that given <code>A := Nat</code> that <code>B := String</code>, that doesn't mean that there can't be other instances with other values of <code>B</code>. The typeclass system isn't constraints, it's a way to synthesize data.</p>",
        "id": 473473628,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631704
    },
    {
        "content": "<p>The <code>outParam</code> directive tells typeclass synthesis \"you are allowed to assign <code>B</code>\". The effect is that it's as-if <code>B</code> is determined by <code>A</code>. However, it's not rigid enough to be able to reason that there is no such thing as a <code>Fooable Nat Bool</code> instance for example.</p>",
        "id": 473473716,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727631767
    },
    {
        "content": "<p>I see... Just to restate what you said to unsure I understand:</p>\n<p>You point is that while <code>outParam</code> can assign B, I was treating it as a function of A -&gt; Type, while you're saying that it's still just a relation...</p>",
        "id": 473474118,
        "sender_full_name": "Tom",
        "timestamp": 1727632106
    },
    {
        "content": "<p>Yes, it's still just a relation, but one that the typeclass system is empowered to treat as a function while it's synthesizing instances.</p>\n<p>In general, just because you have <code>[Fooable Nat String]</code>, you can't assume it's <code>instFoo</code>.</p>",
        "id": 473474213,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727632200
    },
    {
        "content": "<p>Notice in my version of your code, <code>instBar</code> <em>does</em> get to assume it's <code>instFoo</code>, but that's because implicitly <code>Bar Nat</code> has solved for the <code>Fooable Nat _</code> instance.</p>",
        "id": 473474329,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727632275
    },
    {
        "content": "<p>Also (and <span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span>), just to clarify what I was trying to accomplish.  I was thinking about</p>\n<p>\"How could I ensure/express in the type class interface that my result type satisfies a specific other type class that's dependent on the original type?\"  How could I make something like this work?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getFoo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">what</span><span class=\"w\"> </span><span class=\"n\">goes</span><span class=\"w\"> </span><span class=\"n\">here?</span><span class=\"bp\">&gt;</span><span class=\"w\">   </span><span class=\"c1\">-- This produces a type which satisfies Fooable</span>\n<span class=\"w\">                                                 </span><span class=\"c1\">-- and its implementation depends on A</span>\n</code></pre></div>\n<p>So I thought I was being rather clever by changing <code>Fooable</code> to have two parameters: One to constrain the \"containing\" class and one to return a \"implementation type\".   Hope that makes sense. </p>\n<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> 's example with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fooable</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">getFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">B</span>\n</code></pre></div>\n<p>works but the problem is that the <code>Bar</code> type class I'm working with has a few <code>getFoo</code>-like functions each with its own return type.  This in turns would mean that the users would have to specify all the additional type classes when using it.  I thought I had found a \"workaround\" <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span>   </p>\n<p>(<span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> and I had discussed this issue <a href=\"#narrow/stream/113489-new-members/topic/Class.2Finstance.20syntax.20clarification/near/472564318\">previously</a>)</p>",
        "id": 473475648,
        "sender_full_name": "Tom",
        "timestamp": 1727633264
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515083\">Tom</span> has marked this topic as resolved.</p>",
        "id": 474092928,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727804738
    }
]