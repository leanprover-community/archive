[
    {
        "content": "<p>Running the following code fails with <code>Stack overflow detected. Aborting.</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">list_constants</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofConstName</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">list_constants</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n\n<span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Aborting</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>Is a stack overflow expected here? Am I doing something wrong?</p>",
        "id": 514178758,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745514228
    },
    {
        "content": "<p>I think it might just be too many elements:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"c1\">-- 317248</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n</code></pre></div>",
        "id": 514179384,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1745514427
    },
    {
        "content": "<p>Even with a fresh Lean file that just imports <code>Init</code>, you'll already have ~250k constants. Performing a <code>.toList</code> and then a <code>.map</code> in a meta program is probably too much</p>",
        "id": 514179410,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1745514436
    },
    {
        "content": "<p>317248 constants it is</p>",
        "id": 514179496,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1745514471
    },
    {
        "content": "<p>The problem is not handling the list, which is fine, but printing it, which requires assembling an enormous amount of message data and is what I suspect caused the stack overflow.</p>",
        "id": 514179835,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1745514592
    },
    {
        "content": "<p>If you do it incrementally instead of all at once and put your results to a file instead of logging it, I think it will be fine.</p>",
        "id": 514180176,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1745514705
    },
    {
        "content": "<p>If you need to perform intensive computations over Lean metadata, I'd recommend running the Lean frontend on your target file in an proper IO program, getting the heavy work out of the elaborator</p>",
        "id": 514180379,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1745514767
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"451983\">@Arthur Paulino</span> Is there something in particular that makes you think doing the <code>.toList</code> and the <code>.map</code> in a meta program is too much? Everything up until the call to <code>Lean.logInfo</code> is fine as far as I can tell.</p>",
        "id": 514206237,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745520637
    },
    {
        "content": "<p>Those are two consecutive linear operations - one of them being arbitrarily expensive (depends on you map function) - over a dataset that can get pretty big. God knows how many constants you'd get if you <code>import Mathlib</code>, for example</p>",
        "id": 514206773,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1745520802
    },
    {
        "content": "<p>Wouldn't I get a stack overflow also for this code then?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofConstName</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Number of constants: {consts.length}\"</span>\n</code></pre></div>",
        "id": 514207189,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745520940
    },
    {
        "content": "<p>It runs fine and gives output <code>Number of constants: 1170846</code>.</p>",
        "id": 514207555,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745521021
    },
    {
        "content": "<p>Then It's probably due to printing, as pointed out. So you might want to persist your data to a text file via an IO file operation, which is possible from <code>MetaM</code></p>\n<p>The reason why I mention the limitations of meta programs is because I've hit a bottleneck there recently. And the solution was to do what I wanted in a regular IO program, compiled etc</p>",
        "id": 514208973,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1745521289
    },
    {
        "content": "<p>I should probably have made it more clear that I'm interested in understanding precisely what the root cause of the stack overflow is. I'm aware of workarounds :)</p>",
        "id": 514210752,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745521745
    },
    {
        "content": "<p>Using a workaround reveals that a working version of the program yields 1,859,729 bytes written to standard output.</p>\n<p>That is less than the average page size of top sites worldwide (\"According to the HTTP Archive, the current average page size of top sites worldwide is around 2484 KB , which has steadily increased over the years\").</p>",
        "id": 514211864,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745522214
    },
    {
        "content": "<p>Yes, but it's not just about the size of the output, but also about the total memory consumption of the computation</p>",
        "id": 514212231,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1745522344
    },
    {
        "content": "<p>Oh, sorry I gave the wrong numbers.</p>",
        "id": 514214438,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745523227
    },
    {
        "content": "<p>14,713,890 bytes are written to standard output.</p>",
        "id": 514214537,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745523252
    },
    {
        "content": "<p>To be precise about the issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- testcase1.lean (works)</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofConstName</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{name}\"</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- testcase2.lean (does not work)</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MessageData</span><span class=\"bp\">.</span><span class=\"n\">ofConstName</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">consts</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase1</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">l</span>\n<span class=\"w\">  </span><span class=\"mi\">258634</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase1</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">wc</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span>\n<span class=\"w\"> </span><span class=\"mi\">14713890</span>\n<span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">testcase2</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n\n<span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">overflow</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Aborting</span><span class=\"bp\">.</span>\n<span class=\"bp\">%</span>\n</code></pre></div>",
        "id": 514216706,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745524028
    },
    {
        "content": "<p>Logging a list requires building a <code>\"[\" + str(x) +  \",\" + str(xs) + \"]\"</code> where that <code>str(xs)</code> is a recursive call</p>",
        "id": 514218511,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1745524680
    },
    {
        "content": "<p>so you have very large stack because there's no way to TCO the string that is about to be logged</p>",
        "id": 514218621,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1745524714
    },
    {
        "content": "<p>Thanks, <span class=\"user-mention\" data-user-id=\"308899\">@Yakov Pechersky</span>! I now see the root cause. Do you happen to know where in the code the list-to-string conversion (the code that builds <code>\"[\" ++ str(x) ++ \",\" ++ str(xs) ++ \"]\"</code>) is implemented? It would be interesting to see.</p>",
        "id": 514221246,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1745525823
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.format#doc\">docs#List.format</a></p>",
        "id": 514224898,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1745527158
    },
    {
        "content": "<p>Because <code>Lean.MessageData</code> likely uses the <code>ofFormatWithInfos</code> constructor, which takes a <code>Lean.FormatWithInfos</code> which has a <code>fmt : Format</code>. And I knew that there is a <code>ToFormat</code> class.</p>",
        "id": 514225185,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1745527271
    }
]