[
    {
        "content": "<p>I have this simple node js server setup to test out interacting with the Lean Language server.</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nx\">spawn</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'child_process'</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// Start the Lean language server</span>\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">leanServer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">spawn</span><span class=\"p\">(</span><span class=\"s1\">'lean'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s1\">'--server'</span><span class=\"p\">]);</span>\n\n<span class=\"c1\">// Function to send JSON-RPC messages</span>\n<span class=\"kd\">function</span><span class=\"w\"> </span><span class=\"nx\">sendRequest</span><span class=\"p\">(</span><span class=\"nx\">request</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">jsonRequest</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">request</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">message</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"sb\">`Content-Length: </span><span class=\"si\">${</span><span class=\"nx\">Buffer</span><span class=\"p\">.</span><span class=\"nx\">byteLength</span><span class=\"p\">(</span><span class=\"nx\">jsonRequest</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s1\">'utf8'</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"sb\">\\r\\n\\r\\n</span><span class=\"si\">${</span><span class=\"nx\">jsonRequest</span><span class=\"si\">}</span><span class=\"sb\">`</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"nx\">leanServer</span><span class=\"p\">.</span><span class=\"nx\">stdin</span><span class=\"p\">.</span><span class=\"nx\">write</span><span class=\"p\">(</span><span class=\"nx\">message</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// Listen for server responses</span>\n<span class=\"nx\">leanServer</span><span class=\"p\">.</span><span class=\"nx\">stdout</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">'data'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">responses</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">toString</span><span class=\"p\">().</span><span class=\"nx\">split</span><span class=\"p\">(</span><span class=\"s1\">'\\r\\n\\r\\n'</span><span class=\"p\">).</span><span class=\"nx\">filter</span><span class=\"p\">(</span><span class=\"nb\">Boolean</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"nx\">responses</span><span class=\"p\">.</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">response</span><span class=\"w\"> </span><span class=\"p\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">response</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">});</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// Send the initialize request first</span>\n<span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">initializeRequest</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nx\">jsonrpc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"2.0\"</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nx\">method</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"initialize\"</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nx\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">1</span><span class=\"p\">,</span>\n<span class=\"w\">  </span><span class=\"nx\">params</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">processId</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">pid</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nx\">rootUri</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"file:///home/jafar/godot/CalcuLean/tests/lakeinit\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nx\">capabilities</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"p\">};</span>\n<span class=\"nx\">sendRequest</span><span class=\"p\">(</span><span class=\"nx\">initializeRequest</span><span class=\"p\">);</span>\n\n\n<span class=\"w\">   </span><span class=\"nx\">leanServer</span><span class=\"p\">.</span><span class=\"nx\">stdout</span><span class=\"p\">.</span><span class=\"nx\">once</span><span class=\"p\">(</span><span class=\"s1\">'data'</span><span class=\"p\">,()=&gt;{</span>\n\n<span class=\"w\">       </span><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">hoverRequest</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"nx\">jsonrpc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"2.0\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"nx\">method</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"textDocument/hover\"</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"nx\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">2</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"nx\">params</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"nx\">textDocument</span><span class=\"o\">:</span><span class=\"p\">{</span>\n<span class=\"w\">                    </span><span class=\"nx\">uri</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"file:///home/jafar/godot/CalcuLean/tests/lakeinit/Lakeinit/Basic.lean\"</span><span class=\"p\">,</span>\n<span class=\"w\">                </span><span class=\"p\">},</span>\n<span class=\"w\">                </span><span class=\"nx\">position</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                    </span><span class=\"nx\">line</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">1</span><span class=\"p\">,</span>\n<span class=\"w\">                    </span><span class=\"nx\">character</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">21</span>\n<span class=\"w\">                </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">};</span>\n<span class=\"w\">        </span><span class=\"nx\">sendRequest</span><span class=\"p\">(</span><span class=\"nx\">hoverRequest</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// Handle errors</span>\n<span class=\"nx\">leanServer</span><span class=\"p\">.</span><span class=\"nx\">stderr</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">'data'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">error</span><span class=\"p\">(</span><span class=\"s1\">'Error:'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">toString</span><span class=\"p\">());</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// Handle process exit</span>\n<span class=\"nx\">leanServer</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">'exit'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">code</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"sb\">`Lean server exited with code </span><span class=\"si\">${</span><span class=\"nx\">code</span><span class=\"si\">}</span><span class=\"sb\">`</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div>\n<p>The server initializes properly with the expected output (capabilities, serverInfo, responseId...) but when the next request is sent i receive this error :</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Watchdog</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cannot</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"w\"> </span><span class=\"n\">LSP</span><span class=\"w\"> </span><span class=\"n\">notification</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expected</span><span class=\"w\"> </span><span class=\"n\">JSON</span><span class=\"bp\">-</span><span class=\"n\">RPC</span><span class=\"w\"> </span><span class=\"n\">notification</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">{</span><span class=\"s2\">\"params\"</span><span class=\"o\">:{</span><span class=\"s2\">\"textDocument\"</span><span class=\"o\">:{</span><span class=\"s2\">\"uri\"</span><span class=\"o\">:</span><span class=\"s2\">\"file:///home/jafar/godot/CalcuLean/tests/lakeinit/Lakeinit/Basic.lean\"</span><span class=\"o\">},</span><span class=\"s2\">\"position\"</span><span class=\"o\">:{</span><span class=\"s2\">\"line\"</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"s2\">\"character\"</span><span class=\"o\">:</span><span class=\"mi\">21</span><span class=\"o\">}},</span><span class=\"s2\">\"method\"</span><span class=\"o\">:</span><span class=\"s2\">\"textDocument/hover\"</span><span class=\"o\">,</span><span class=\"s2\">\"jsonrpc\"</span><span class=\"o\">:</span><span class=\"s2\">\"2.0\"</span><span class=\"o\">,</span><span class=\"s2\">\"id\"</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">}</span><span class=\"bp\">'</span>\n</code></pre></div>\n<p>I'm not sure what could be the problem anymore, I've been hacking at this for a couple hours now so if someone could point me in the right direction that would be appreciated.</p>",
        "id": 463802848,
        "sender_full_name": "Jafar Tanoukhi",
        "timestamp": 1724184794
    },
    {
        "content": "<p>This was fixed by sending an initialized Notification right after the initialize request like so :</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">initializedNotification</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nx\">jsonrpc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"2.0\"</span><span class=\"p\">,</span>\n<span class=\"nx\">method</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"initialized\"</span>\n<span class=\"p\">}</span>\n<span class=\"nx\">sendRequest</span><span class=\"p\">(</span><span class=\"nx\">initializedNotification</span><span class=\"p\">);</span>\n</code></pre></div>",
        "id": 463891078,
        "sender_full_name": "Jafar Tanoukhi",
        "timestamp": 1724195997
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 463891139,
        "sender_full_name": "Jafar Tanoukhi",
        "timestamp": 1724196010
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"710010\">Jafar Tanoukhi</span> has marked this topic as resolved.</p>",
        "id": 463891201,
        "sender_full_name": "Notification Bot",
        "timestamp": 1724196048
    },
    {
        "content": "<p>I'm not sure what specifically you're doing, but just to be sure in case you haven't considered it, this kind of thing is what I'd hope an LSP client library should make easier on you rather than putting it all together by scratch.</p>",
        "id": 463896203,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724198506
    },
    {
        "content": "<p>You should be able to find a decent one for JS as lots of LSP tooling is written in/for JS -- not that I recall one off-hand.</p>",
        "id": 463896329,
        "sender_full_name": "Julian Berman",
        "timestamp": 1724198528
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/stream/113489-new-members/topic/.E2.9C.94.20JSON-RPC.20textDocument.2Fhover.20Request.20to.20Lean.20Not.20Working/near/463896329\">said</a>:</p>\n<blockquote>\n<p>You should be able to find a decent one for JS as lots of LSP tooling is written in/for JS -- not that I recall one off-hand.</p>\n</blockquote>\n<p>Yes, thanks I have considered this but this is just a test i wanted to do and the actual project i'm doing will not use javascript</p>",
        "id": 463899628,
        "sender_full_name": "Jafar Tanoukhi",
        "timestamp": 1724200064
    },
    {
        "content": "<p>though i'm not sure if you know about this but I found that lean has \"extra\" LSP methods like : $/lean/plainGoal but I couldn't find any documentation or anything to know anything about these methods or atleast the names of the rest of them</p>",
        "id": 463899754,
        "sender_full_name": "Jafar Tanoukhi",
        "timestamp": 1724200158
    },
    {
        "content": "<p>oh just found out where it is :<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Data/Lsp/Extra.html#Lean.Lsp.PlainGoal\">https://leanprover-community.github.io/mathlib4_docs/Lean/Data/Lsp/Extra.html#Lean.Lsp.PlainGoal</a></p>",
        "id": 463900431,
        "sender_full_name": "Jafar Tanoukhi",
        "timestamp": 1724200660
    }
]