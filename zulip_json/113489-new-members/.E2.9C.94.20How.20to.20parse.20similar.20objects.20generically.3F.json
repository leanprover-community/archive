[
    {
        "content": "<p>Following up on <a href=\"#narrow/channel/113489-new-members/topic/.E2.9C.94.20Axiomatic.20formal.20proofs.20.2F.20How.20to.20unify.20typed.20formulas.3F/near/485586000\">Axiomatic formal proofs / How to unify typed formulas?</a>, I used <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>'s code snippets to parse <a href=\"https://en.wikipedia.org/wiki/Condensed_detachment#D-notation\">D-proofs</a> for multiple systems by creating multiple variations of the original code — full working code snippet (split into two comments) posted below.<br>\nIt uses <a href=\"https://leanprover-community.github.io/mathlib4_docs//Lean/Parser/Basic.html\">Lean.Parser</a> to extend the grammar.</p>\n<p>But this code is very redundant. I would prefer a more generic approach, e.g. to use a parameter to define the axiom count, rather than having all those <code>_1</code> and <code>_3</code> definition variants, and to rather not (almost) repeat the lengthty system-specific macros for each system.</p>\n<p>It this possible? If so, how? Otherwise, can the code be made less redundant in different ways?</p>\n<p>Unfortunately, I do not understand much of what is going on with the parser, and I am new to Lean, so I don't know what it can do in which ways, and where to even begin.</p>\n<p>Below, I used only four systems, each with either one or three axiom schemas, for illustration. But a system can have any finite amount of axiom schemas in general. Ideally, the mechanism would just take a proof class (such as <code>pm_proof</code>, <code>l_proof</code>, <code>m_proof</code> or <code>w1_proof</code>) somehow, combined with (ordered) lists of (most general) axioms and rules, and do everything else based upon that.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Explode</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CD</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_atom</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_not</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_imp</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n\n<span class=\"kn\">prefix</span><span class=\"o\">:</span><span class=\"mi\">75</span><span class=\"w\"> </span><span class=\"s2\">\"~\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_not</span>\n<span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"s2\">\"→\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_imp</span><span class=\"w\">  </span><span class=\"c1\">-- non-associative, i.e. display all parentheses</span>\n\n<span class=\"c1\">-- \"pm\": Frege's calculus simplified by Łukasiewicz (CpCqp,CCpCqrCCpqCpr,CCNpNqCqp)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→~</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"n\">q</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span>\n\n<span class=\"c1\">-- \"l\": Łukasiewicz's calculus (CCpqCCqrCpr,CCNppp,CpCNpq)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">L2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">L3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"n\">q</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">l_proof</span>\n\n<span class=\"c1\">-- \"m\": Meredith's Axiom; 1-basis (CCCCCpqCNrNsrtCCtpCsp)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">(((((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"bp\">~</span><span class=\"n\">r</span><span class=\"bp\">→~</span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"n\">t</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">→</span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">m_proof</span>\n\n<span class=\"c1\">-- \"w1\": Walsh's 1st Axiom; 1-basis (CCpCCNpqrCsCCNtCrtCpt)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">w1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">t</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"bp\">→</span><span class=\"n\">t</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">t</span><span class=\"o\">))))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">→</span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`cdChunk</span>\n\n<span class=\"c1\">-----------------</span>\n<span class=\"c1\">--/ One axiom /--</span>\n<span class=\"c1\">-----------------</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isCDChar_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkFn_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">takeWhileFn</span><span class=\"w\"> </span><span class=\"n\">isCDChar_1</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">hasError</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkError</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"s2\">\"CD chunk\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Substring</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toString</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">tag</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">isCDChar_1</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkUnexpectedError</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"s2\">\"invalid character\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">mkNodeToken</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">fn</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cdChunkFn_1</span>\n<span class=\"w\">  </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkAtomicInfo</span><span class=\"w\"> </span><span class=\"s2\">\"cdChunk\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkParser_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withAntiquot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAntiquot</span><span class=\"w\"> </span><span class=\"s2\">\"cdChunk\"</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_1</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">combinator_formatter</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_1</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_1</span><span class=\"bp\">.</span><span class=\"n\">formatter</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Formatter</span><span class=\"bp\">.</span><span class=\"n\">visitAtom</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span>\n<span class=\"kd\">@[</span><span class=\"n\">combinator_parenthesizer</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_1</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkAntiquot</span><span class=\"bp\">.</span><span class=\"n\">parenthesizer</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Parenthesizer</span><span class=\"bp\">.</span><span class=\"n\">visitToken</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span>\n<span class=\"w\">  </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`CD.cdChunkParser_1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">next_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·+⟨</span><span class=\"mi\">1</span><span class=\"bp\">⟩</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">next_1</span>\n\n<span class=\"c1\">--------------------</span>\n<span class=\"c1\">--/ Three axioms /--</span>\n<span class=\"c1\">--------------------</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isCDChar_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">2</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">3</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkFn_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">takeWhileFn</span><span class=\"w\"> </span><span class=\"n\">isCDChar_3</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">hasError</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkError</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"s2\">\"CD chunk\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Substring</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toString</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">tag</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">isCDChar_3</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkUnexpectedError</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"s2\">\"invalid character\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">mkNodeToken</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">fn</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cdChunkFn_3</span>\n<span class=\"w\">  </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkAtomicInfo</span><span class=\"w\"> </span><span class=\"s2\">\"cdChunk\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkParser_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withAntiquot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAntiquot</span><span class=\"w\"> </span><span class=\"s2\">\"cdChunk\"</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_3</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">combinator_formatter</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_3</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_3</span><span class=\"bp\">.</span><span class=\"n\">formatter</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Formatter</span><span class=\"bp\">.</span><span class=\"n\">visitAtom</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span>\n<span class=\"kd\">@[</span><span class=\"n\">combinator_parenthesizer</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot_3</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkAntiquot_3</span><span class=\"bp\">.</span><span class=\"n\">parenthesizer</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Parenthesizer</span><span class=\"bp\">.</span><span class=\"n\">visitToken</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span>\n<span class=\"w\">  </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`CD.cdChunkParser_3</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">next_3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·+⟨</span><span class=\"mi\">1</span><span class=\"bp\">⟩</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">next_3</span>\n</code></pre></div>",
        "id": 486096232,
        "sender_full_name": "Samiro Discher",
        "timestamp": 1733320056
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">------------------------------</span>\n<span class=\"c1\">--/ System-specific macros /--</span>\n<span class=\"c1\">------------------------------</span>\n\n<span class=\"c1\">-- \"pm\": Frege's calculus simplified by Łukasiewicz (CpCqp,CCpCqrCCpqCpr,CCNpNqCqp)</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">buildExpr_pm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_pm</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_pm</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``pm_proof.D</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``pm_proof.A1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">2</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``pm_proof.A2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">3</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``pm_proof.A3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">copyHeadTailInfoFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[pm| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_3</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_pm</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_3</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"expected 'D', '1', '2', '3', '_'\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span>\n<span class=\"w\">  </span><span class=\"n\">finish</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- \"l\": Łukasiewicz's calculus (CCpqCCqrCpr,CCNppp,CpCNpq)</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">buildExpr_l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_l</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_l</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``l_proof.D</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``l_proof.L1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">2</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``l_proof.L2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">3</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``l_proof.L3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">copyHeadTailInfoFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[l| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_3</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_3</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_l</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_3</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"expected 'D', '1', '2', '3', '_'\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span>\n<span class=\"w\">  </span><span class=\"n\">finish</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- \"m\": Meredith's Axiom; 1-basis (CCCCCpqCNrNsrtCCtpCsp)</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">buildExpr_m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_m</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_m</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``m_proof.D</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``m_proof.m</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">copyHeadTailInfoFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[m| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_1</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_m</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_1</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"expected 'D', '1', '_'\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span>\n<span class=\"w\">  </span><span class=\"n\">finish</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- \"w1\": Walsh's 1st Axiom; 1-basis (CCpCCNpqrCsCCNtCrtCpt)</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">buildExpr_w1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_w1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_w1</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``w1_proof.D</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"ss\">``w1_proof.w1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">copyHeadTailInfoFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[w1| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_1</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State_1</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr_w1</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next_1</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"expected 'D', '1', '_'\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span>\n<span class=\"w\">  </span><span class=\"n\">finish</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"c1\">----------------------</span>\n<span class=\"c1\">--/ Cleanup helper /--</span>\n<span class=\"c1\">----------------------</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cdCleanup</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"cd_cleanup \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">cdCleanup</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabCleanup</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isMVarApp</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">tryPostpone</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isFormula</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">getType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectUnassignedMVars</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filterM</span><span class=\"w\"> </span><span class=\"n\">isFormula</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">appendIndexAfter</span><span class=\"w\"> </span><span class=\"ss\">`x</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">withLocalDeclsD</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">fvar</span>\n<span class=\"w\">        </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectUnassignedMVars</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isFormula</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula.f_atom</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">forM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">setUserName</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">appendIndexAfter</span><span class=\"w\"> </span><span class=\"ss\">`A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((),</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectUnassignedMVars</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isFormula</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula.f_atom</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"c1\">--------------------------------------</span>\n<span class=\"c1\">--/ System-specific macros (clean) /--</span>\n<span class=\"c1\">--------------------------------------</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"pm:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_3</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"l:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_3</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">l</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"m:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_1</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">m</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"w1:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser_1</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">w1</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n\n<span class=\"c1\">------------------------</span>\n<span class=\"c1\">--/ Usage (examples) /--</span>\n<span class=\"c1\">------------------------</span>\n\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_atom</span><span class=\"w\"> </span><span class=\"c1\">-- for #explode to print (unspecified) atoms as \"*\"</span>\n\n<span class=\"c1\">-- fun x_0 =&gt; pm_proof.D (pm_proof.D A2 A1) A1</span>\n<span class=\"c1\">-- : ∀ (x_0 : formula), pm_proof (x_0→x_0)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pm_id_dyn</span><span class=\"w\">                              </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pm</span><span class=\"o\">:</span><span class=\"n\">DD211</span><span class=\"w\"> </span><span class=\"c1\">-- 5 steps</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pm_id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\">                 </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pm</span><span class=\"o\">:</span><span class=\"n\">DD211</span><span class=\"w\"> </span><span class=\"c1\">-- 5 steps</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pm_L1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pm</span><span class=\"o\">:</span><span class=\"n\">DD2D1D2DD2D1211</span><span class=\"w\"> </span><span class=\"c1\">-- 15 steps</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\">   </span><span class=\"n\">pm</span><span class=\"o\">:</span><span class=\"n\">DD211</span>\n<span class=\"bp\">#</span><span class=\"n\">explode</span><span class=\"w\"> </span><span class=\"n\">pm</span><span class=\"o\">:</span><span class=\"n\">DD211</span><span class=\"w\"> </span><span class=\"c1\">-- id via pm</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\">   </span><span class=\"n\">pm</span><span class=\"o\">:</span><span class=\"n\">DD2D1D2DD2D1211</span>\n<span class=\"bp\">#</span><span class=\"n\">explode</span><span class=\"w\"> </span><span class=\"n\">pm</span><span class=\"o\">:</span><span class=\"n\">DD2D1D2DD2D1211</span><span class=\"w\"> </span><span class=\"c1\">-- L1 via pm</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">l_id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\">                     </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">DD132</span><span class=\"w\"> </span><span class=\"c1\">-- 5 steps</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">l_A1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">))</span><span class=\"w\">                 </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">DD13DD11DD11DD1D1DD13DD1D1D322DD12D13</span><span class=\"w\"> </span><span class=\"c1\">-- 37 steps</span>\n\n<span class=\"bp\">#</span><span class=\"n\">explode</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DD13DD11DD11DD1D1DD13DD1D1D322DD12D13</span><span class=\"w\"> </span><span class=\"c1\">-- A1 via l</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">m_id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\">                 </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">:</span><span class=\"n\">DDDD1D1D11D1D1D1111</span><span class=\"w\"> </span><span class=\"c1\">-- 19 steps</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">m_A1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">))</span><span class=\"w\">             </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">:</span><span class=\"n\">DDD11D1D1D111</span><span class=\"w\"> </span><span class=\"c1\">-- 13 steps</span>\n\n<span class=\"bp\">#</span><span class=\"n\">explode</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">:</span><span class=\"n\">DDDD1D1D11D1D1D1111</span><span class=\"w\"> </span><span class=\"c1\">-- id via m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">w1_id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\">                 </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">w1</span><span class=\"o\">:</span><span class=\"n\">DDD1DDDDDDD1D1D111D1D1D11111D1D1D111DDDD1D1D111D1DDDD1D1D111D1D11DDDD1D1D111D1D11DDDD1D1D111D11DDDD1D1D111D11DDD1D1D111D1D1D11DDD1D1D111D1D1D11</span><span class=\"w\"> </span><span class=\"c1\">-- 143 steps</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">w1_A1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">))</span><span class=\"w\">             </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">w1</span><span class=\"o\">:</span><span class=\"n\">DDDD1D1D111D1D1D11DDD1D1D111D1D11</span><span class=\"w\"> </span><span class=\"c1\">-- 33 steps</span>\n\n<span class=\"bp\">#</span><span class=\"n\">explode</span><span class=\"w\"> </span><span class=\"n\">w1</span><span class=\"o\">:</span><span class=\"n\">DDDD1D1D111D1D1D11DDD1D1D111D1D11</span><span class=\"w\"> </span><span class=\"c1\">-- A1 via w1</span>\n</code></pre></div>",
        "id": 486096274,
        "sender_full_name": "Samiro Discher",
        "timestamp": 1733320067
    },
    {
        "content": "<p>(<a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAGQKYEMB2AoUlZwLIowAWANsAEYB0AKigMYzB2UCiAHmCRACZIYZoUIJAGcw9JHADCAEQwQwSNIlTKACiigikUfsDTcArg2AA3SQDNoIQyRRwAXHGoBPRRgA+cCwH1CEEEdva1sUT28fNAh4IKsoGzs4QCTCYPjQ8N9sOFiQxJS4hPt83LCMMCgkC2A2BwB2AFY4ACIAPya4AF4APlTCyl8omCw0KpqANkampPbu3tD+nyy4AFpluCi0ZZQREQg6YEIzJAAaOGBKJEo4bmAxOxc4FBISOHEKtGJRUX5V5rAQJpOABiFQA5kgAOQiOB0J50WyGaEibBkKpIbhwcgPQCCgIYANbbYBIADuTAAXnAABRSMBSACOYGOUhp9KgzLAdJpUCZUgAcmBeZyGQBKYZGEzmV4gHzlCAQCw5NKJZY9NRQBThACCAEYgoAAIjgAG8wHA6QBfU7/GXq+VUsBJSl0pJgYWiryagBM+qNJrpcCgFql1rlCsplPtjqSUFdDvDSTpwod9ujrq1AGZvcbTYGrbLbWGWvaWgmHU6XW64DJsk4DVnzZbpXnQ/aE8kg03Xm3czaFXT5IplN2Qz81k0SIC4LiCciSeSoTC4QjodSaZzWVyefywIyWfyE2LjIxJSRg7anAVQitVeqwOEELqaz7Tf7AyeO2GW4mw07o0mo66KwQL1H2NV9T1DSlC2dRMXTvDMQN9MD3wjKCEwrKtM0Q043x7O142FNscJDTsUiI20+wUJQ4DIiwR2aAEnDwHR0WAYh501NhgACABuOBtWWchCWXZkRI5PkoF5ERYGZGBaTEUV9HFI9JEbXDzxKK84DVDUvECBDnygOBoRgQNVOIsMLM/B0WigJIWhEGNfxgL9KRgaCHREaDUy8DCQM1OAACFTPAqlNSSAKCJSMzbX8qKQoC/sqOi2iMF+JpiW1CcAHUnhEIh521ER4A4riQF4/jBORYSWT5Dk2REZleRgKRpLAZy4APCVJAykL1KVewVS0m9wgyzCDKMuATNOHr3zjAsrJTDzYxaNzKVs5yv3tDbvMras4Frfygum7UQspMKIrbGbcNiuAruIhLKOUO75X4FByHICpTBhbgpCIQw0DxABpRSggAZRcD4UDYXkeCQYGDEcDo4AAAzoH6/oBkdVmxnHceWVLlgAejgAB5NBJCh0q4EJ1YCbx+naYwXgFVuWRfs0HwH2kIhNDbAK5RIDBsi8CFtQhOARZkcWRZ8cXZhgKBDD4YW4B8ToegsXK+CZypvt+/68SBNBOaCDQtB0I3Ee8f6YQm7oheopB4GAK2REoSARAdkgnYmhwkZgFA8SQLKiGAb3LdZmR2agE26CMh3gAVN2eZEFgoHVQzPkwbJsk97IkBIbQziT92IGhDokZdrOHeyM3tCgUGA5gS4QDxNOM4mppZBhDG8SaB2C+0GvHfgAPQSt0HDHIIqoH0UFKFbmFKH0MBDGdozS+hDwukoGAIEb2e0FBYfE7gABCMfKCeF5I+jk3q5znO650RvCBbvEAFVyY4JAGHRdvoCd30KYJ4wAMR0B5lAegzcoD90foPZWj84CtxhrwagEAg7KDRvrAG8MMQuzjp7HWCpsG9xhpqD4wA6SGGiCbJwz9DJ+yNA7CwyhqxI1IQbI2nME4jAgFbVumo94gCYAAST4c0ThAN+5mn4MzPWvcGF0K0poeuiMHakmIBQxg1DohUkEZQ3R8AmhSL7gog2eCCKmPIYYmhMAeEYAAAIAG06ABHIPofwMcCiEBgeYgGNidF2M5gAXWuLraxEBtFUOCdqfo1hfE6HUbXCoMAYAuDVPoGBlAgQJLSToSgphbisSEQEfxQNFJONce4zxe8Y5vCUJ8ZEZIkmROiUY0J4SSHowNu0ux7tNCNKIKIYALTGEdAdmqJ26TMkfAKWbIZIyxmFOKTAdBmD+Az0PIYCocBX7NxNsSYZFQHYeyCCTNqXFlAHznpQNQZcHYQINtCJwCBbjwEpNQcGkM2Ao1kJQUxSjtSimyBA1RQQ3lFW5pofgbxGBPC6esJAbB7Fc32Ugageym5IBNgQOg6o8BUguYwCAyhKTEquViw+897nQgAOvQpTFbbgEAvY+0NK8MupwnkAxENyyB0IzRwEAAmEcBwRDGyCAQgECe7gs0UQB2Xg44OCcHQcuXRh7aA+Rys5TCPYLxQCaSkAB2gA1IAC/JtSAEvyYU/Lnn8vBUwtVQqnDos5iCnOqSdlko9tyj1XhnFhPto/b28AeV4kcKql5HDe5b39E7b16xSWIOyKfUNcAr7CLOBItg0ae4G0oFA4kziAAMYSH5IK1VSHVZcrb6CsJQcVtKAD8dreVWzVQ6rQVtc27wgJC+ALqsVv3dcPBBw9c4+0pDWvl+b21OtnWC7tTDA1wCHW64Fw9v6oqxgzPdBNibUCIBUCmnEAjQhpvjPd178bELOA1KOkCfDwUZXzAWiq4Ci2lp+j036IRpj/VLCWn7Zbq0morRBXg1azE1oXbW8jTHcJfQwy2TCLA20IerNl68mFuw9th32/tA7B1DuHZQt8n0ZkIQnEuKcAGZ2GdnHOec4AIOLhvM5FcziTUY8PBh6KF5t3ToA6EXcqzhrgaxuDw901jwnlPGetzF7MBXmvbjeHa3bz7Tco+J8FQXxQPPa+962aUZ40oCdKjzYN2xYJr+yLFB/24PRoBaAQFkHAZA6BOhJP52k0g5BeJUEYowVRUxeDuPUbvW02xtDkOqKSUww0LC2Edp6QDJDvCrACLxKUkRdBxHZZMelvuGBZHRZK0o+L1nkm3VYkQPpejKQGKCXo4rOCzHhcUlYkrgSYlxf4C4txIAPGCDqT4Hx+TDIxda/YtMYSEO9aibFub8T4iJPGZM1JMzD7ZNyetqbKzkQwDy+UvBVThuja8TKQZHxhnNNaUtxrc2FsRJK8959Az3hNNGYliZKTpkZN2/M27P3llFOO+sizGAtkMB2ZIN1GYjnMVObWpwFLSVUtubSx5saIXvKpF8iGAdfnI3+YChLMc0weqXS8xABPo6ws0PCl48jt3PrBtizFiP8D0AJUSy5mPyWC+uQrbHtaGXR1dMy1l2R00zrbXiRdAq10irFU7B2UqYAytp3V4gH7lVRqw4/Kt07OV5v1VKo1ZrLU2sV8rx1HCRDruxc+j12QvVQB9VymE/q4CruDTndN4bI0wjzeGuNnvlAbBTex9Nmayn1v4bmjtvdC0oGLWW8zTGTdTpnXWvhjanYtvtx2h3y6ka9r3gO1XrrXfU7Hf5ytefzel4XV2vNq6Xcjob4/dnaZd03qH9jA9eyXBFSQCAZYYhf6JyYMgvntbL102H6vuiTR/gThBEgcE85YQkHhCQRERkURz/RJiHE+JCSzjoBSaktIGQ8gf2yVcG5GoCiFLBMozODis91uQQwMOZzDgepPSYdZubnevXnfFCAQlagHQPSJGFlAjcMH3OgAiUVDHNAIvGAGQQlSkUVfvAiNaBNL3KkAg9XZyTeU4CEWWVMOXH2CoBUJhLXGVM5eVYeLwGPMDb5EnBeW4ZEXTR+LwXYYQdYHg4nKGSgeUAAJXQHBDgHNTQFOGUFNSxyPjuTLkEz4itU12lSIFtg4JVghCA0DwYPgBeFFQAKAPYHKBlBABk0YLV2sJIGALsP+GHmRkpAABJms8QpBRFeAPgQQykmCUZkYhx5RKAqxKRYQNgmAEUmEFYlZpdvCXhvDowP0v0wMvDfDW4AigiYAQjAgwjkYIjkpKAdQqQ4jSUEiXgkiIMAIsjf0cifC/CCjGlij40FQyjIiLBKivRYj0Baj98rZkikAmjjCANWi8j/DAjOj1QSjdZeiKjNQMwhj4jRiGiUj6DgNaC5Yego9FDeCpC3EwAXAAAJVAbgWgMOQrCALoigrwnwaXJg3QlWaDQ40g5Qc1E4tgfgnYOeXQjAKVGA5oZxf4LwdoCPBwCnazZ9AAKmaBCXaCcBgUCFmGQPMO8H0FuAMLrzfkgJ72gP53gPiBl0cPgEkCsMANcNsNAL0xHiMgCEkFQNnReLV372z0s3TTCJYP0PNz1wVQCxVm4NmD+IBMEOPhFOA1EMkGUHFMkP+NkPkMkCUJULgDUJ0xpS0MXmtUszxXVF3mPQgGJHoyEW6OaAc1/mbgxBMIhBoLFhoN/RoIAxoNll83jRgETUQXTV1SRgoPFRkMqGFBwJbRYVxLykLX+nFgVznSV1T2eT7QHQ7yti73X3HCcCnGv1JFvz30XCP2qjEnXHKE3G3B3FpD3FFG/1gF/0RRcLcJjnqPAIxRbI50NNgOcAQIpOxLZL9TVywJwLwKpEIORTm2IKOLDFFXFVDN9RAwhF2N5N1n5O1wMPYPq04KTXJgkJ+UlLnk3LlPEMVN3JVKPjVOUPEK1LFw0NpW0P1MlQFLjiML2NMI1RDR9ksMxFpMbJ8EFnfPgEMhpJsJAN/M8LaPyPmOCMWMtLKJomiOqOGLQDqLGMaIIjSLgAyL92yNmFyPaMgqKOgtKORjgvvAQs2MSP9lQqwpaJwvArmMKK6KIpIsGJqKQq2Mop2KwumNotmI6KgtCOWOIvAkoAQHWNYuQu2ImN2JlgOK9MTV+KVIBQUEuOuNuJIHuMeNFWeNeMqHeOA0+LkrIIUt3JEUBKPmBNBPVHBJIChPjJEFhMq0p0RORNRMmm7MxNlyZKqCQryk50JLbIzA7LgO7KYSxKDx9mpK/OArsL/JzjTR9kPL7NVgwKRRRQ5wrX/MtJXLYNrWfICy4OTR3L4NMqlMsxVkPIVJ6AlNPIUPVMvPUJ1Ldj1L0sfg7ONPVDNOEygAtLCKaGtKc0/SlkdIdJ/RGv/TGo9OHiON9J9n9JHMoODIsFDKbTLmbQjJ8qIGjLQFjNbzssTN5WTPeVTJXTCXKzSgYnwGYhuDYmhBKh4j4gEiEipBEnZE5F5AkikmaikFkikHkiZ1rIRXkQbPpJ8DAPRSJIOV1CCq7PJNCs8vTSSvQIHJFyHPwNHLSuBSpEnMDKdlnJ932MXMYOXKRlYLXNyo3OEK3MkGPOKoEP3MpoqqKqkJqvPI1KvOpU0KaojXvIX1XMMIppfIOMpOomcO/JBocMysAqirpJAolpzlwogoYsIsEoqJiPEvYvAx2IwvSMyOMLFhmLwqVoEp6ORgqMCA2JGIos1qkqwtA1mCOOMr4LOJUpQBuJQDuL4U0pRkpBeIIjeI/QModolJKqBP4Esv4SaGcRAFsphLhPrk5iRKaBRKCHRLAzCvTW8rxL8ogLbKhsX2CthqQM8uxMiuBtlsZPTUSrnI5PRtRW5ICyXOYJJoFPXP1xlIKu3JpqkJDqEJFJEJZKPKqsUpZsUIvNUIas5rvJapzjauIA6vNIAt1j6p/gGvtOGvdIhE9OmoIzmpxpgEWuWuL1WvWrxK2p2rnIj32qV0OqKmOqRnTIJmaAymylynymhEKmKjPTKgesqluGepqj3Hqkamalanan+pZ3rLFpAtGgJJzo3RJM7LJMQOuHhqnQvpSsHPFWHIoPZ0xpIO9LIKnMoLxtnQJo9UboERbvJrbpzg7upqHpMrpt7vKoHsqrHxPIsDkLPNHrZontvOar0L5qfIFsliFsys/LLrsIymFqlskZjmkcfgVvooWONvCOen6LVsQoko4qku1owt1r2P1p4sNpUaWJNvUcoFGgtrYqtvGMmL2Ltq+IIZ+IlOdquNdrUo0ugqeJ9p0osD0qgzAyDsUp7tBAssX3BIyhjtjQco6yBUTuTrRPcp6HTp9kzt8tgdbPgehqQZ7PCqpNFuivke1AroSoHqSprtSrroyvyayubr5tbuFL7qpqZv+NCbKtlNYdaekM4dVJ4fqu1MnoEYC1npNM6ozh6qXv6ttMGrGqdPnK3u+NYx3rRwDOnKdgPrDOPuyHSc2sVm2qNF2svqdVjRvpgDvv91OsH1XxH1WGJikG9nQEMBNGGRIEUEMmXxufpk2SVKpEEDEKdR+kebQGeYImKx8DoGBeeeaDcththYcMejgBYDsHIBhsCCYgDiqXRJ8ALjej1ihbAFewVFxfIAedUGhacCQeRbeg/S8LRghYJYwvahgxtnSTTuLqZNuDwAADVeZRVSbJoHh5VOmxC2XZguXeXurtxBX9KwNV5dlxjGSJXeYs5wMMky5ZJk1hbIqSXcmPlT5lWGMqJuC2N0l3cmS2XRV60dBXBFBlnMrbh9tChkEQFxkUH70ZBKgWA/QKCQBXWF5XXAiz4cDbWJj9F/DSUoUyiLw7BzX00/XwVRUKC3FngbSv5thkRQRyZuAeXwUzX+gw4YFCVHWSglWRBc2jWc9amLBXXoRRVwaz6qQ80S0CIAAeXSWtg1MAQldDZQNWF2MwpBbG3kIQS4Q1AcbgcRXgNgTUCwPxZGX5YAU4Xt1WOV+HKkZAdAQTKQSN+AaNkoV0U4YAU1TdALeVBAPYJ4T1yFkQKsGt8FFd+97tDyjpuIF13mfQd9rQZd117NbwWtlBjpyVf1hNqAINq+QErN/9mFGUt90Dv90VFN72BgdNyD7Nit6ESQMKmU0+K1kQJ1y8eDmpmU0DgNzQcDjN4AKD9o3d8ImNlABYfwEAc1x+VuBAIQcgbgFAIESV6EJ9zDxvIeALBt/Z8WSkZtttjt1RNbHtm2eDgdlJjl1jkDwN7gYNrVD+euEdsQykbTsd7cJQSdgwZFWd+d/yYAFjz1JZsMW1M4E9yzuD39z9xDiAVNlDwQND9EDD1jQDnD/TUDt2NxSGfQaEIj3jGU1NBUPDgjxIMLizCLnOUj0DijtD8NndtAKN5Gejxj4RSz+VyQSDVdllvtsDalqgOe00r+EQZ5nAW0v465r5r50fcGCfKfGffYKoOOcO5cSF1QAiT5xrwbxmcOv4EABwaEmJuOnQZypJ8k2i+l3rp5k0CE6OjCykbQiPdPYkYUBEkJUUEbsccbuy2JxRJytMJE2bjEnoOl7gBl8l5bmytbjb05otHbvbkEiJpoMbib55E7g2eJlO5J72hbxlqOrwXw57pM173b/bz7jKI72Oxy+E7UC7+F1okH+7/3KJp75TF7jPN76sob3GUfTTwzVk5FIQTgUQfr2mInnGfgQYQ4THJoBEmYDWEoHLspX4N9gAYgcy4F4Emn4XKCySpH+na7P24AIiY+hG2GaFZ7ohXbYB8BLTldVrtHV89DgB1AIh1EfsfEpGV9V76kKFs76KpCN6SCN9FHkStDAR8G4AhgS+d4i71TG5kBkA9G1F1F+EaAnzAE9lt+lDASCHN7jBdBd6QTd4cA969597WD9+bgD7vStFIqcDD7jBLG/H/D/BTAImj9j5kG1E98L+1Dj5WDWG1ET6QGT4wB54gV/gjWyH+Bj89+97r/59hilFb/L9+BD6KXsA8Pr+GToCb+79L5L5L7L/b7544AF8kBb4n49FL977WFIoH6lDkV1hPBD6cBojwgj8j5FKYRIFb+1DTC9F96MiT8D+358CqL39OgjDLGlyP/YWojP7TA9+9+/+L6L//6L5f9/+xfC/svyL7L9z+FfOAGmFqDX8a+RCWfpwC76n9KwgA3/ugOAHf8gBxfEAR6DAFl9ABUAqohv0Fh3pg+GIJwMlAP4EQ3+AiVvt/2AE4DGB3vKAdqAACccA5PvImlAP9kET/UsF5Ej4sF6BP/Jgd73j58QMw/vBAZ30F7u8PemA0QcwIkH98DgyCLfgqB6i79boJ0ZCNBFoFWx4eCgv/goIYE4ClB5g8QYoJ/7GDmBAAswUXwsEmDrBYg5wa4PMGmD3Bjg2wZYOsE+DHBYgxwawIAAsUgm/neh6i8D1GeESMOWCEFIwjB/gqwa4KSFOCoBaYMIfAP4CID5+Og+gS4L8EODkhQQ34MQLUHSMgAA\">Code snippet on live.lean-lang.org</a>)</p>",
        "id": 486100892,
        "sender_full_name": "Samiro Discher",
        "timestamp": 1733321292
    },
    {
        "content": "<p>You can generalize most of the macro construction into a function call:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Explode</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CD</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_atom</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_not</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_imp</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n\n<span class=\"kn\">prefix</span><span class=\"o\">:</span><span class=\"mi\">75</span><span class=\"w\"> </span><span class=\"s2\">\"~\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_not</span>\n<span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"s2\">\"→\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_imp</span><span class=\"w\">  </span><span class=\"c1\">-- non-associative, i.e. display all parentheses</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SyntaxNodeKind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`cdChunk</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isCDChar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isDigit</span><span class=\"w\"> </span><span class=\"n\">c</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkFn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">takeWhileFn</span><span class=\"w\"> </span><span class=\"n\">isCDChar</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">hasError</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkError</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"s2\">\"CD chunk\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Substring</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toString</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">tag</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">isCDChar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">ParserState</span><span class=\"bp\">.</span><span class=\"n\">mkUnexpectedError</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"s2\">\"invalid character\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">mkNodeToken</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">fn</span><span class=\"w\">   </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cdChunkFn</span>\n<span class=\"w\">  </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkAtomicInfo</span><span class=\"w\"> </span><span class=\"s2\">\"cdChunk\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkParser</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withAntiquot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAntiquot</span><span class=\"w\"> </span><span class=\"s2\">\"cdChunk\"</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">combinator_formatter</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot</span><span class=\"bp\">.</span><span class=\"n\">formatter</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Formatter</span><span class=\"bp\">.</span><span class=\"n\">visitAtom</span><span class=\"w\"> </span><span class=\"n\">cdChunkKind</span>\n<span class=\"kd\">@[</span><span class=\"n\">combinator_parenthesizer</span><span class=\"w\"> </span><span class=\"n\">cdChunkNoAntiquot</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">cdChunkAntiquot</span><span class=\"bp\">.</span><span class=\"n\">parenthesizer</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Parenthesizer</span><span class=\"bp\">.</span><span class=\"n\">visitToken</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span>\n<span class=\"w\">  </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`CD.cdChunkParser</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Char</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·+⟨</span><span class=\"mi\">1</span><span class=\"bp\">⟩</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunk</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">next</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkCDMacro</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntaxArray</span><span class=\"w\"> </span><span class=\"ss\">``cdChunkParser</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">d_name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">axs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">      </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"over-application\"</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span>\n<span class=\"w\">  </span><span class=\"n\">finish</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chars</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">buildExpr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getDM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">ofRange</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">d_name</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">copyHeadTailInfoFrom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">isDigit</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">missing</span><span class=\"bp\">⟩</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">0</span><span class=\"bp\">'.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">axs</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"invalid axiom number\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)))</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cdCleanup</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"cd_cleanup \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">cdCleanup</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabCleanup</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isMVarApp</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">tryPostpone</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isFormula</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">getType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectUnassignedMVars</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">filterM</span><span class=\"w\"> </span><span class=\"n\">isFormula</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isMVar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">appendIndexAfter</span><span class=\"w\"> </span><span class=\"ss\">`x</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">withLocalDeclsD</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"n\">fvar</span>\n<span class=\"w\">        </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectUnassignedMVars</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isFormula</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula.f_atom</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">mkLambdaFVars</span><span class=\"w\"> </span><span class=\"n\">fvars</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">StateT</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">forM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">setUserName</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">appendIndexAfter</span><span class=\"w\"> </span><span class=\"ss\">`A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">((),</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">collectUnassignedMVars</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isFormula</span><span class=\"w\"> </span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"n\">mvar</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"bp\">.</span><span class=\"n\">assign</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``formula.f_atom</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">throwUnsupportedSyntax</span>\n</code></pre></div>",
        "id": 486102053,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1733321610
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- \"pm\": Frege's calculus simplified by Łukasiewicz (CpCqp,CCpCqrCCpqCpr,CCNpNqCqp)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">A3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→~</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"n\">q</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[pm| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkCDMacro</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"ss\">``D</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``A1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``A2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``A3</span><span class=\"o\">]</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"pm:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">pm</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span>\n\n<span class=\"c1\">-- \"l\": Łukasiewicz's calculus (CCpqCCqrCpr,CCNppp,CpCNpq)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"n\">q</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">L2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">L3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l_proof</span><span class=\"w\"> </span><span class=\"n\">q</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">l_proof</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[l| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkCDMacro</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"ss\">``D</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``L1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``L2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``L3</span><span class=\"o\">]</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"l:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">l</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">l_proof</span>\n\n<span class=\"c1\">-- \"m\": Meredith's Axiom; 1-basis (CCCCCpqCNrNsrtCCtpCsp)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">(((((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"bp\">~</span><span class=\"n\">r</span><span class=\"bp\">→~</span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"n\">t</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">→</span><span class=\"n\">p</span><span class=\"o\">)))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">→</span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m_proof</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">m_proof</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[m| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkCDMacro</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"ss\">``D</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``m</span><span class=\"o\">]</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"m:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">m</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">m_proof</span>\n\n<span class=\"c1\">-- \"w1\": Walsh's 1st Axiom; 1-basis (CCpCCNpqrCsCCNtCrtCpt)</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">w1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"bp\">→</span><span class=\"n\">r</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">→</span><span class=\"o\">((</span><span class=\"bp\">~</span><span class=\"n\">t</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"bp\">→</span><span class=\"n\">t</span><span class=\"o\">))</span><span class=\"bp\">→</span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">→</span><span class=\"n\">t</span><span class=\"o\">))))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"bp\">→</span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[w1| \"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkCDMacro</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"ss\">``D</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``w1</span><span class=\"o\">]</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"w1:\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">cd_cleanup</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">w1</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"o\">)</span><span class=\"bp\">*</span><span class=\"o\">])</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">w1_proof</span>\n</code></pre></div>",
        "id": 486102055,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1733321611
    },
    {
        "content": "<p>Ok, this <code>mkCDMacro</code> is really neat! Thank you once again.</p>",
        "id": 486104655,
        "sender_full_name": "Samiro Discher",
        "timestamp": 1733322339
    },
    {
        "content": "<p>Can I overload <code>mkCDMacro</code> for optional additional rules to 'D', like generalization 'G' (ψ ↦ ∀ψ) or necessitation 'N' (ψ ↦ ◻ψ)?</p>\n<p>Say, I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_atom</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_not</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_nece</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">f_imp</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">formula</span>\n\n<span class=\"kn\">prefix</span><span class=\"o\">:</span><span class=\"mi\">75</span><span class=\"w\"> </span><span class=\"s2\">\"~\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_not</span>\n<span class=\"kn\">prefix</span><span class=\"o\">:</span><span class=\"mi\">75</span><span class=\"w\"> </span><span class=\"s2\">\"◻\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_nece</span>\n<span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"s2\">\"→\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">formula</span><span class=\"bp\">.</span><span class=\"n\">f_imp</span><span class=\"w\">  </span><span class=\"c1\">-- non-associative, i.e. display all parentheses</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isCDChar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">D'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">N'</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'_'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"bp\">.</span><span class=\"n\">isDigit</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>\n<p>and added</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">d_name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n_name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">axs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MacroM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">N'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">d_name</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>to <code>buildExpr</code>, and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">pm_proof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">◻</span><span class=\"n\">p</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>to <code>pm_proof</code>.</p>\n<p>To successfully parse <code>pm:NDD211</code> to <code>pm_proof (◻(p→p))</code>, I can now use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"[pm|\"</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"o\">:</span><span class=\"n\">cdChunkParser</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkCDMacro</span><span class=\"w\"> </span><span class=\"n\">chunks</span><span class=\"w\"> </span><span class=\"ss\">``D</span><span class=\"w\"> </span><span class=\"ss\">``N</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">``A1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``A2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``A3</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>but then calls without ``N do not work anymore.</p>\n<p>Is there an easy way to make the parameter optional,and throw an error when 'N' is used without having been defined?</p>",
        "id": 486129497,
        "sender_full_name": "Samiro Discher",
        "timestamp": 1733328787
    },
    {
        "content": "<p>just pass an <code>Option Name</code> there</p>",
        "id": 486129598,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1733328820
    },
    {
        "content": "<p>and then when it is <code>none</code> you can do the same thing as in the number parsing part (match on it and if <code>none</code> report an error)</p>",
        "id": 486129735,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1733328850
    },
    {
        "content": "<p>Hmm, there is nothing here: <a href=\"https://lean-lang.org/lean4/doc/option.html\">https://lean-lang.org/lean4/doc/option.html</a><br>\nHow to extract the Name?</p>\n<p>I tried</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">N'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n_name</span><span class=\"bp\">.</span><span class=\"n\">isNone</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"invalid rule 'N'\"</span>\n<span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">n_name</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>and it says</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">n_name</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"n\">argument</span>\n<span class=\"w\">  </span><span class=\"n\">n_name</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">n_name</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 486132665,
        "sender_full_name": "Samiro Discher",
        "timestamp": 1733329642
    },
    {
        "content": "<p>Found it,<code>.get!</code> instead of <code>.get</code> works!</p>",
        "id": 486134541,
        "sender_full_name": "Samiro Discher",
        "timestamp": 1733330104
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"784629\">Samiro Discher</span> has marked this topic as resolved.</p>",
        "id": 486135348,
        "sender_full_name": "Notification Bot",
        "timestamp": 1733330353
    },
    {
        "content": "<p>ah, instead of using <code>.get</code> and <code>isNone</code> you should use pattern matching, like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">N'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n_name</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"bp\">.</span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"s2\">\"invalid rule 'N'\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkCIdentFrom</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">canonical</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">buildExpr</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 486279022,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1733396872
    }
]