[
    {
        "content": "<p>Lean does not do magic, but I can't figure out how it's doing this. In <code>Mathlib.Algebra.Module.Submodule.Lattice</code> we have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Submodule.completeLattice#doc\">docs#Submodule.completeLattice</a> which defines a complete lattice structure on the submodules of a module over a (semi)ring. I was asked at Xena where the <code>sSup</code> field is coming from. I cannot figure it out and all the smart people already left for dinner :-/ The declaration in the mathlib file is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">completeLattice</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CompleteLattice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OrderTop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)),</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OrderBot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"n\">sup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">sInf</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àß</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"n\">le_sup_left</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_sInf'</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_‚ü©</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">le_sup_right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_sInf'</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚ü®_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">sup_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">sInf_le'</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">h‚ÇÅ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">    </span><span class=\"n\">inf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"bp\">‚äì</span><span class=\"w\"> </span><span class=\"bp\">¬∑</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">le_inf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">subset_inter</span>\n<span class=\"w\">    </span><span class=\"n\">inf_le_left</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">inter_subset_left</span>\n<span class=\"w\">    </span><span class=\"n\">inf_le_right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">inter_subset_right</span>\n<span class=\"w\">    </span><span class=\"n\">le_sSup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_sInf'</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hq</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">hq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hs</span>\n<span class=\"w\">    </span><span class=\"n\">sSup_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">sInf_le'</span><span class=\"w\"> </span><span class=\"n\">hs</span>\n<span class=\"w\">    </span><span class=\"n\">le_sInf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_sInf'</span>\n<span class=\"w\">    </span><span class=\"n\">sInf_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">sInf_le'</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>Before this instance, <code>sSup</code> doesn't work on sets of submodules. Afterwards, it does. But neither OrderTop nor OrderBot supply it and it's not in the list of explicit fields either. I know the trick mathematically -- I can even see it in <code>#print completeLattice</code> -- there is a <code>sInf</code> defined by this point on submodules (before the completeLattice instance), and the <code>sSup</code> of <code>S</code> is just the <code>sInf</code> of all the submodules which contain every element of <code>S</code>. But where in mathlib is this code and why is it running?</p>",
        "id": 499578795,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739479025
    },
    {
        "content": "<p>i think this might be unification at work?</p>",
        "id": 499582513,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739480396
    },
    {
        "content": "<p>There is <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Module/Submodule/Lattice.html#Submodule.instInfSet\">Submodule.instInfSet</a> that seems relevant</p>",
        "id": 499582517,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739480398
    },
    {
        "content": "<p>commenting out  the last four fields and replacing them with <code>sorry</code> seems to make it complain it doesn't know what <code>sSup</code> is</p>",
        "id": 499582667,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739480442
    },
    {
        "content": "<p>specifically, it looks like the value of the <code>sSup_le</code> field is what allows it to infer the value of <code>sSup</code>?</p>",
        "id": 499583021,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739480570
    },
    {
        "content": "<p>i do agree, this behaviour seems quite magical</p>",
        "id": 499583263,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739480658
    },
    {
        "content": "<p>I agree with Edward, <code>sSup_le</code> (and <code>le_sSup</code> also works) allow to infer the definition of <code>sSup</code>. This seems to rely on the <code>Set _</code> vs <code>_ ‚Üí Prop</code> definitional equality so that the hypothesis <code>hs</code> is interpreted as <code>a</code> belonging to the set of submodules containing all elements of <code>s</code> without making this set explicit, via <code>sInf_le'</code>.</p>",
        "id": 499584130,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1739480991
    },
    {
        "content": "<p>actually, replacing <code>sSup_le</code> with <code>sorry</code> makes the <code>le_sSup</code> field error, so i'm not sure that it also works?</p>",
        "id": 499584449,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739481093
    },
    {
        "content": "<p>it will complain that it doesn't know <code>hq : x‚úù ‚àà ?m.39162 x‚úù¬≤</code> is a function. It is after lean is able to fill in the metavariable (because membership of an intersection is defeq to a forall statement), but not <em>before</em>.</p>",
        "id": 499584966,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739481273
    },
    {
        "content": "<p>You‚Äôre right my bad</p>",
        "id": 499585024,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1739481297
    },
    {
        "content": "<p>Indeed one can do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">completeLattice</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CompleteLattice</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OrderTop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)),</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OrderBot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"n\">sup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">sInf</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">‚àß</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"n\">le_sup_left</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_sInf'</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">h</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_‚ü©</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">le_sup_right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_sInf'</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚ü®_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">    </span><span class=\"n\">sup_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">sInf_le'</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">h‚ÇÅ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">    </span><span class=\"n\">inf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"bp\">‚äì</span><span class=\"w\"> </span><span class=\"bp\">¬∑</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">le_inf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">subset_inter</span>\n<span class=\"w\">    </span><span class=\"n\">inf_le_left</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">inter_subset_left</span>\n<span class=\"w\">    </span><span class=\"n\">inf_le_right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">inter_subset_right</span>\n<span class=\"w\">    </span><span class=\"n\">le_sSup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_top</span><span class=\"w\"> </span><span class=\"c1\">--note the new proof</span>\n<span class=\"w\">    </span><span class=\"n\">sSup_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">    </span><span class=\"n\">le_sInf</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">le_sInf'</span>\n<span class=\"w\">    </span><span class=\"n\">sInf_le</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">sInf_le'</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">sSup</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚ä§</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 499586251,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739481712
    },
    {
        "content": "<p>right, so it does <em>try</em> to unify at <code>le_sSup</code>, but the \"correct\" value only allows unification after <code>sSup_le</code> is unified</p>",
        "id": 499586717,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739481893
    },
    {
        "content": "<p>In any case, I think we would be very happy with a PR actually adding the definition...</p>",
        "id": 499587145,
        "sender_full_name": "Anatole Dedecker",
        "timestamp": 1739482039
    },
    {
        "content": "<p>Yes, I even think a linter saying something would be a good thing. Maybe forcing to write at least <code>sSup := _</code> (that works just fine), to flag that this is find by unification (maybe the actual definition is very long and it can be useful to not write it explicitly). Not writing anything just seems confusing.</p>",
        "id": 499587478,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739482167
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21850\">#21850</a> adds an explicit value to the field</p>",
        "id": 499589616,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739482902
    },
    {
        "content": "<p>Wait so what is going on here? Can I not define <code>le</code> when making a partial order as long as one of the proofs makes it clear what it must be? Is this a general phenomenon? I had no idea that you could just randomly skip fields and that unification would attempt to fill them in</p>",
        "id": 499681271,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739524507
    },
    {
        "content": "<p>The <code>{ ..., sup := ... }</code> is probably just a syntax sugar for an application of the function <code>CompleteLattice.mk</code>, so you can omit some fields just like you can use underscores for some arguments if they can be inferred.</p>",
        "id": 499683564,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1739525136
    },
    {
        "content": "<p>Yes but IIRC <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CompleteLattice.mk#doc\">docs#CompleteLattice.mk</a> asks for SupSet to be found via typeclass inference which was what confused me (edit: I'm not at Lean right now and the docs won't let me check this)</p>",
        "id": 499686317,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739525825
    },
    {
        "content": "<p>What I find confusing in this example is that Lean infers <em>data from a proof</em>. I understand why this works, but it goes against the slogan \"proofs don't matter\", and it looks to me code smell.</p>",
        "id": 499686410,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739525845
    },
    {
        "content": "<p>Looks like it's fixed now though :-)</p>",
        "id": 499686704,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739525917
    },
    {
        "content": "<p>I would say I still don't understand why it works. I am amazed that unification is allowed at all in this setting</p>",
        "id": 499687142,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739526029
    },
    {
        "content": "<p>It's like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_zero</span><span class=\"w\"> </span><span class=\"mi\">55</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 499688144,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739526302
    },
    {
        "content": "<p>Since <code>Nat.add_zero 55</code> proves <code>55+0=55</code> Lean understands that the <code>have</code> is <code>55 = 37</code>.</p>",
        "id": 499688245,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739526327
    },
    {
        "content": "<p>But where is the underscore in the sSup example? For me it's the underscore which means \"use unification\". All I could find was \"use typeclass inference\". If you leave out the definition of a field of a structure lean doesn't use unification to fill it in AFAIK, it gives an error (is this where I'm wrong?)</p>",
        "id": 499689588,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739526673
    },
    {
        "content": "<p>Ah yes, that is some magic in the <code>where</code> syntax. My proposal is indeed to at least force people to write <code>sSup := _</code> to make it clear that it is found by unification</p>",
        "id": 499690325,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739526851
    },
    {
        "content": "<p>I'm not sure what you're proposing to change here: Just to be clear, master now has the field filled in. </p>\n<p>The experiment I want to do: make a structure with two fields: a nat and a proof it's 37. Then instantiate the structure by giving the proof as rfl but not giving the nat at all. Does this work?</p>",
        "id": 499691048,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739527020
    },
    {
        "content": "<p>Yes, this specific example is fixed. I would like the previous syntax to give an error</p>",
        "id": 499691417,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739527112
    },
    {
        "content": "<p>Going to teach now</p>",
        "id": 499691453,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739527121
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113489-new-members/topic/Where.20is.20sSup.20defined.20on.20submodules.3F/near/499691048\">said</a>:</p>\n<blockquote>\n<p>The experiment I want to do: make a structure with two fields: a nat and a proof it's 37. Then instantiate the structure by giving the proof as rfl but not giving the nat at all. Does this work?</p>\n</blockquote>\n<p>Yes it does. I use this trick all the time to fill in the default arguments to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BooleanAlgebra#doc\">docs#BooleanAlgebra</a> and similar</p>",
        "id": 499692533,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1739527407
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">  </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 499693175,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739527565
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/channel/113489-new-members/topic/Where.20is.20sSup.20defined.20on.20submodules.3F/near/499690325\">said</a>:</p>\n<blockquote>\n<p>Ah yes, that is some magic in the <code>where</code> syntax. My proposal is indeed to at least force people to write <code>sSup := _</code> to make it clear that it is found by unification</p>\n</blockquote>\n<p>it's not just <code>where</code>, it evidently also works with the <code>{foo := _}</code> notation</p>",
        "id": 499737318,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739538721
    },
    {
        "content": "<p>(<code>where</code> is a macro for <code>{...}</code> notation)</p>",
        "id": 499957220,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739660089
    },
    {
        "content": "<p>I'm working on some improvements to <code>{...}</code> notation, so some changes here could be possible. (Yes, this so-called 'structure instance notation' is sort of sugar for the structure's constructor <span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span>, though it's a bit more complicated because it knows about default values and overriding default values, and, soon, filling in default values using all parent instances. Also, it doesn't expand as a macro to the structure constructor. It processes the fields and constructs the constructor application expression itself.)</p>\n<p>While it's surprising that <code>sup</code> was filled in using the type of a proof, I'm not sure exactly what could be done here to get <code>{...}</code> to detect that this happened... I could imagine perhaps detecting which fields are Prop-valued and elaborating those last. Or perhaps we disallow filling in fields by pure unification ‚Äî i.e., we throw a warning when a field isn't given and there is no default value for it. You'd have to write <code>sup := _</code> if you wanted to opt-in to the current behavior.</p>",
        "id": 499957777,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739660650
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/channel/113489-new-members/topic/Where.20is.20sSup.20defined.20on.20submodules.3F/near/499686410\">said</a>:</p>\n<blockquote>\n<p>What I find confusing in this example is that Lean infers <em>data from a proof</em>. I understand why this works, but it goes against the slogan \"proofs don't matter\", and it looks to me code smell.</p>\n</blockquote>\n<p>I think it infers the data from the <em>type</em> of the proof. It's dependent type at work :)</p>",
        "id": 499967640,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1739669981
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Where.20is.20sSup.20defined.20on.20submodules.3F/near/499957220\">said</a>:</p>\n<blockquote>\n<p>(<code>where</code> is a macro for <code>{...}</code> notation)</p>\n</blockquote>\n<p>yes, so it's the <code>where</code> <em>semantics</em> that is magic, not the <code>where</code> <em>syntax</em>.<br>\nclearly <code>{...}</code> is different syntax.</p>",
        "id": 499995342,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739698043
    },
    {
        "content": "<p>I'm not sure what you're pointing out. Earlier you mentioned that it works with <code>{...}</code> notation too, but that's what I'd expect since <code>where</code> is a macro for it.</p>",
        "id": 499996216,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739698955
    },
    {
        "content": "<p>i'm pointing out that <del>you</del> <span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span>  said it's the <code>where</code> <em>syntax</em> that is magic (emphasis mine). if that were the case, it wouldn't work with <code>{...}</code> since it's different syntax with the same semantics.</p>",
        "id": 499996658,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739699415
    },
    {
        "content": "<p>I'm confused, I haven't said anything was magic. Are you confusing me with Riccardo?</p>",
        "id": 499996936,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739699708
    },
    {
        "content": "<p>Oops <span aria-label=\"grimacing\" class=\"emoji emoji-1f62c\" role=\"img\" title=\"grimacing\">:grimacing:</span> my mistake <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 499998822,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1739701490
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/113489-new-members/topic/Where.20is.20sSup.20defined.20on.20submodules.3F/near/499957777\">said</a>:</p>\n<blockquote>\n<p>You'd have to write <code>sup := _</code> if you wanted to opt-in to the current behavior.</p>\n</blockquote>\n<p>This is what I proposed.</p>",
        "id": 499999358,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739702004
    },
    {
        "content": "<p>I understand it's not magic, and that it works because Lean sees the type of the proof so it guesses the <code>Prop</code>. But the fact the this was not immediately clear to expert users suggests it is a confusing behavior. (but maybe it's just our fault <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> )</p>",
        "id": 499999564,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1739702180
    },
    {
        "content": "<blockquote>\n<p>This is what I proposed.</p>\n</blockquote>\n<p>Thanks for the confirmation, I wasn't completely sure what the proposal was, but I see it now in <a class=\"message-link\" href=\"/#narrow/channel/113489-new-members/topic/Where.20is.20sSup.20defined.20on.20submodules.3F/near/499587478\">#new members &gt; Where is sSup defined on submodules? @ üí¨</a>.</p>\n<p>I think this will happen within the next couple releases.</p>",
        "id": 500000242,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739702839
    },
    {
        "content": "<p>Concretely, explicit fields will be required (unless they have a default value), implicit fields will be optional.</p>",
        "id": 500001287,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1739703779
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113489-new-members/topic/Where.20is.20sSup.20defined.20on.20submodules.3F/near/499693175\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">  </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This is what this example now reports post <a href=\"https://github.com/leanprover/lean4/pull/7717\">lean4#7717</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>fields missing: 'a'\n\nfield 'a' must be explicitly provided, its synthesized value is\n  37\n</code></pre></div>\n<p>If you instead define</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n</code></pre></div>\n<p>then it does not complain about the missing field.</p>",
        "id": 509068050,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743371644
    },
    {
        "content": "<p>can you do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>?</p>",
        "id": 509069382,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1743372771
    },
    {
        "content": "<p>Yeah, that's allowed</p>",
        "id": 509070819,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743374062
    },
    {
        "content": "<p>i'm curious, were there other definitions in mathlib which had to be changed because of this?</p>",
        "id": 509177290,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743421909
    },
    {
        "content": "<p>(find out at <a href=\"https://github.com/leanprover-community/mathlib4/compare/master...lean-pr-testing-7717\">this diff</a>)</p>",
        "id": 509177934,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743422089
    },
    {
        "content": "<p>I think that diff is everything so in 4.19.0, not just the effects of the relevant PR</p>",
        "id": 509179347,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743422436
    },
    {
        "content": "<p><span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 509179885,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743422562
    },
    {
        "content": "<p>I think <a href=\"https://github.com/leanprover-community/mathlib4/compare/dfa8eeacfe73d980cb805f78f355186d9b850ac8...lean-pr-testing-7717\">this diff</a> is the one you want</p>",
        "id": 509180212,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743422645
    },
    {
        "content": "<p>Oh this looks like a really happy ending to this story!</p>",
        "id": 509226886,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743433305
    }
]