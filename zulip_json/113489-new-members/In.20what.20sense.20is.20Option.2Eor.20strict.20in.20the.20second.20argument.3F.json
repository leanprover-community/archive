[
    {
        "content": "<p>From the documentation:</p>\n<blockquote>\n<p><code> def Option.or {α : Type u_1} : Option α → Option α → Option α\n</code><br>\nIf the first argument is <code>some a</code>, returns <code>some a</code>, otherwise returns the second <br>\nargument. This is similar to <code>&lt;|&gt;/orElse</code>, but it is strict in the second argument.<br>\nIn what sense is it \"strict\" in the second argument? When I ran the following, both lines at the end printed only \"left\":</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dbgTrace</span><span class=\"w\"> </span><span class=\"s2\">\"left\"</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dbgTrace</span><span class=\"w\"> </span><span class=\"s2\">\"right\"</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"c1\">-- why isn't right evaluated?</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">right</span>\n</code></pre></div>\n<p>Any help is greatly appreciated.</p>",
        "id": 479286557,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1730125019
    },
    {
        "content": "<p>The behavior you're seeing is due to the compiler inlining <code>Option.or</code>. You can observe the difference if you hide <code>or</code> and <code>orElse</code> behind definitions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dbgTrace</span><span class=\"w\"> </span><span class=\"s2\">\"left\"</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dbgTrace</span><span class=\"w\"> </span><span class=\"s2\">\"right\"</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Option.or</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">right</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">left.orElse</span><span class=\"w\"> </span><span class=\"n\">right</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"n\">right</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 479290710,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1730126235
    },
    {
        "content": "<p>Thank you. Is there a way to just turn off inlining?</p>",
        "id": 479290926,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1730126290
    },
    {
        "content": "<p>In general, inlining is crucial to the performance of Lean code because often the compiler needs to \"see\" how a definition uses its input in order to perform destructive updates. I'm not aware of a way to turn off inlining for imported functions that are marked to be inlined. If you care about \"observable effects\" of the code like your <code>dbgTrace</code>, then working in a monad like <code>IO</code> is likely a better option.</p>",
        "id": 479294811,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1730127339
    },
    {
        "content": "<p>I see. Thank you.</p>",
        "id": 479295625,
        "sender_full_name": "Kevin Cheung",
        "timestamp": 1730127548
    }
]