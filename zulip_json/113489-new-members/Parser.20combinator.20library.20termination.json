[
    {
        "content": "<p>I'm trying to use the <a href=\"https://github.com/fgdorais/lean4-parser\">parser combinator library</a>  and got very stuck.  I want to parse a string that may use \" or ' as delimiters, ignoring  escaped quotes. In the library code, it uses a recursive function for similar functionality:  <a href=\"https://github.com/fgdorais/lean4-parser/blob/a64da3842f409ff01c101d56c4e7b7b789864921/Parser/RegEx/Compile.lean#L119\">https://github.com/fgdorais/lean4-parser/blob/a64da3842f409ff01c101d56c4e7b7b789864921/Parser/RegEx/Compile.lean#L119</a>. I tried this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">MyParser</span>\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SimpleParser</span><span class=\"w\"> </span><span class=\"n\">Substring</span><span class=\"w\"> </span><span class=\"n\">Char</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">strLoop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">delimit</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyParser</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Char</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">anyToken</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">delimit</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">acc</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">strLoop</span><span class=\"w\"> </span><span class=\"n\">delimit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">next</span><span class=\"o\">])</span>\n</code></pre></div>\n<p>This gives me an error about termination not being found and suggests I prove<br>\n<code>⊢ sizeOf (acc ++ #[next]) &lt; sizeOf acc</code><br>\nWhy doesn't Dorais' code have the same problem with with the <code>filter</code> argument and what should I do here?</p>",
        "id": 448948522,
        "sender_full_name": "Alex",
        "timestamp": 1720040445
    },
    {
        "content": "<p>It sounds like lean is trying to derive a termination proof based on the idea that you're recursing over acc and it gets smaller at each step, but of course that's not what you're doing, and acc actually grows.</p>\n<p>Your code here doesn't look very much like the example code for this library. In the JSON example, there's a demonstration of switching based on the initial character (<code>lookAhead anytoken</code>):</p>\n<p><a href=\"https://github.com/fgdorais/lean4-parser/blob/a64da3842f409ff01c101d56c4e7b7b789864921/examples/JSON.lean#L85\">https://github.com/fgdorais/lean4-parser/blob/a64da3842f409ff01c101d56c4e7b7b789864921/examples/JSON.lean#L85</a></p>\n<p>You could probably do the same thing to dispatch on <code>\"</code> vs <code>'</code> and then have two different string-parsing rules.</p>",
        "id": 448953518,
        "sender_full_name": "Michal Wallace (tangentstorm)",
        "timestamp": 1720042412
    },
    {
        "content": "<p>The function is marked as <code>partial</code> and thus allowed to ignore the termination checker. In general I would suggest to just use it if you don't need to do verification</p>",
        "id": 448953637,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720042450
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"423842\">@Michal Wallace (tangentstorm)</span> I meant I used that code for reference with the  recursive part rather than looking ahead.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> Thank you. I see stream code  is partial because they can be infinite.</p>",
        "id": 448961254,
        "sender_full_name": "Alex",
        "timestamp": 1720045737
    },
    {
        "content": "<p>They cannot be infinite, lean does not habe support for co inductives</p>",
        "id": 449017293,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1720076919
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> Yes, I was confused because IO.FS.Stream and Data.Stream have similar names. The documentation for the FS one actually has the same problem: the mid-text link is to the Data one <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.FS.Stream\">https://leanprover-community.github.io/mathlib4_docs/Init/System/IO.html#IO.FS.Stream</a></p>",
        "id": 449072683,
        "sender_full_name": "Alex",
        "timestamp": 1720094992
    }
]