[
    {
        "content": "<p>I encountered an interesting case where <code>simp</code> behaves unexpectedly. A single <code>simp</code> fails to close the goal, but if I specify a subset of simp theorems it closes the goal. What is going on here?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">stuff</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">∏</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">prod_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">card_range</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">--simp -- doesn't work</span>\n<span class=\"w\">  </span><span class=\"c1\">--simp? -- doesn't work, and suggests below</span>\n<span class=\"w\">  </span><span class=\"c1\">--simp only [Finset.prod_div_distrib, Finset.prod_const, Finset.card_range] -- doesn't work</span>\n</code></pre></div>",
        "id": 514467227,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1745617841
    },
    {
        "content": "<p>What's going on is in technical terms a lack of \"confluence\". Probably <code>Finset.prod_div_distrib</code> should not be tagged as a <code>simp</code> lemma</p>",
        "id": 514468006,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745618315
    },
    {
        "content": "<p>Seemingly added by <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> in <a href=\"https://github.com/leanprover-community/mathlib/pull/14189\">!3#14189</a></p>",
        "id": 514468423,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745618535
    },
    {
        "content": "<p>Oh! I have seen that word in some doc but never understood what it meant</p>",
        "id": 514468445,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1745618547
    },
    {
        "content": "<p>Basically, it means that if <code>simp</code> can go from state A → B → C and also A → D, then it should also go D → C</p>",
        "id": 514468590,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745618629
    },
    {
        "content": "<p>That it, it shouldn't matter which simp lemma you apply first</p>",
        "id": 514468650,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745618646
    },
    {
        "content": "<p>Yep, looks like a bad simp lemma, but for an unrelated reason (it's not affine)</p>",
        "id": 514468687,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745618667
    },
    {
        "content": "<p>Thanks for the explanation. btw, what it does affine mean in this context?</p>",
        "id": 514469121,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1745618907
    },
    {
        "content": "<p>As I understand it, <code>s</code> occurs once on the left hand side and twice on the right hand side, which is not optimal especially when <code>s</code> is a big expression</p>",
        "id": 514469348,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745619037
    },
    {
        "content": "<p>So the same applies to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sum_sub_distrib#doc\">docs#Finset.sum_sub_distrib</a> ? That looks like a fine simp lemma to me...(oh that will just be the additivised version)</p>",
        "id": 514472982,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745621417
    },
    {
        "content": "<p>Why not just make the simp set confluent again? <span class=\"user-mention\" data-user-id=\"873350\">@Weiyi Wang</span> can you figure out which simp lemmas to add to make it confluent again?</p>",
        "id": 514473050,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745621475
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Group/Basic.html#div_pow\">https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Group/Basic.html#div_pow</a> is the missing one it seems, but for this lemma on its own, I can't tell which side is more \"simplified\"</p>",
        "id": 514473402,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1745621754
    },
    {
        "content": "<p>So maybe either <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=div_pow#doc\">docs#div_pow</a> should be a simp lemma, or <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.prod_div_distrib#doc\">docs#Finset.prod_div_distrib</a> should not be, and then this part of the simpset will be confluent again.</p>",
        "id": 514474169,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745622274
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113489-new-members/topic/simp.20doesn't.20work.20until.20I.20remove.20certain.20theorem/near/514472982\">said</a>:</p>\n<blockquote>\n<p>So the same applies to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sum_sub_distrib#doc\">docs#Finset.sum_sub_distrib</a> ? That looks like a fine simp lemma to me...(oh that will just be the additivised version)</p>\n</blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sum_sub_distrib#doc\">docs#Finset.sum_sub_distrib</a> seems bad to me, what if I have <code>h = f - g</code> in my context?</p>",
        "id": 514477933,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1745624862
    },
    {
        "content": "<p>a bit tangential to the thread, but I have faced such issues of simp not closing due to a simp lemma \"taking the goal to a unwanted state\" lots of times. I thought that was just part of life and I had to use <code>simp?</code> followed by removing the problematic lemmas when applying simp. But reading the thread, it seems like those are unintended. For example consider following example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">({(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">ncard</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- simp     -- changes target to {0, (0, 1)}.ncard = 2 and fails to close</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk_zero_zero</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>should I report such cases in zulip somewhere?</p>",
        "id": 514566036,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1745693449
    },
    {
        "content": "<p>I have definitely seen this as well! I thought it was because (a, b) syntax has ambiguity and didn't think too much in how simp worked back then</p>",
        "id": 514566283,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1745693584
    },
    {
        "content": "<p>I think that basically people strive to make simp confluent, but it's hard. It might be interesting to write a program which checks for nonconfluence somehow! One reason you want simp confluence is that it implies that if simp solves a goal, it will never stop solving it later if someone adds something to the simp set. Mathlib allows terminal simps to solve goals and if simp randomly starts breaking then it's kind of annoying to fix -- you have to go back to previous mathlib, squeeze it and then replace the new call with a simp only and then ideally start trying to figure out why it broke. Maybe there should be a thread in <a class=\"stream\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4\">#mathlib4</a> where people can report non-confluence issues (of which I'm sure there are plenty, but it can be fun to fix them!)</p>",
        "id": 514568053,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745695015
    },
    {
        "content": "<p>The example can be minimised a bit more:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">):=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk_zero_zero</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I think there is an argument for <code>Prod.mk_zero_zero</code> to not be a simp lemma. One possible use for it to be <code>simp</code> would be to prove <code>(0,0)+(x,y)=(x,y)</code> (with the logic being that once (0,0) is simplified to 0 you can use the simp lemma <code>zero_add</code>) but in fact</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">y</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk_zero_zero</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>works anyway, because simp simplifes the goal to <code>0 + x = x \\and 0 + y = y</code>. </p>\n<p>You could try a PR to mathlib removing <code>@[simp]</code> from <code>Prod.mk_zero_zero</code> and see what happens: see if mathlib breaks, gets slower, gets quicker etc. If it doesn't break and stays the same this is evidence that it's not being used as a simp lemma which could make a case from untagging it.</p>",
        "id": 514568780,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745695570
    },
    {
        "content": "<p><code>Prod.mk_zero_zero</code> is one of the cases I remember distinctively, as this was the first time I faced this. There were lots other examples, I'll have to search my codes to find them. Another similar thing happened with simp converting <code>1/x</code> to <code>x^{-1}</code> and then like previous example cardinality proof failed.</p>",
        "id": 514569154,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1745695862
    },
    {
        "content": "<p>This one is more difficult because you would presumably agree that -x is simpler than 0 - x!</p>",
        "id": 514569527,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745696185
    },
    {
        "content": "<p>In 2017 core Lean 3 had <code>a - b = a + (-b)</code> as a simp lemma and it drove everyone nuts. I think it was one of the first things that was changed when we forked.</p>",
        "id": 514569579,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745696228
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/lean/pull/117\">https://github.com/leanprover-community/lean/pull/117</a></p>",
        "id": 514569831,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745696418
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/113489-new-members/topic/simp.20doesn't.20work.20until.20I.20remove.20certain.20theorem/near/514568053\">said</a>:</p>\n<blockquote>\n<p>I think that basically people strive to make simp confluent, but it's hard. It might be interesting to write a program which checks for nonconfluence somehow!</p>\n</blockquote>\n<p>I think Kim was working on something like that for core, at least</p>",
        "id": 514573035,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745698832
    },
    {
        "content": "<p>We have such a tool on a branch, and Kim has been using it heavily while improving the simpset around basic types: <br>\n<a href=\"https://github.com/leanprover/lean4/pull/5717\">https://github.com/leanprover/lean4/pull/5717</a></p>",
        "id": 514651414,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1745764262
    },
    {
        "content": "<p>I opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/24414\">#24414</a> for de-simp mk_zero_zero</p>",
        "id": 514663245,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1745772540
    },
    {
        "content": "<p>My proof of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mo>−</mo><mn>1</mn><msup><mo stretchy=\"false\">)</mo><mrow><mn>1</mn><mi mathvariant=\"normal\">/</mi><mn>3</mn></mrow></msup><mo>=</mo><mn>1</mn><mi mathvariant=\"normal\">/</mi><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">(-1)^{1/3}=1/2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.138em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">−</span><span class=\"mord\">1</span><span class=\"mclose\"><span class=\"mclose\">)</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.888em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1/3</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1/2</span></span></span></span> <a href=\"#narrow/channel/270676-lean4/topic/.E2.9C.94.20Weird.20.60ring.60performance.20and.20how.20to.20simplify.20.60.28x.5E3.29.5E.281.2F3.29.60/near/503549807\">here</a> showed up some other simp confluence issues.</p>\n<p>By a weird coincidence though, Kim is in my office right now, and I just asked them if simp should be confluent and they replied that this is asking too much in practice.</p>",
        "id": 514762740,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745831950
    },
    {
        "content": "<p>We can still strive!</p>",
        "id": 514847685,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745855112
    }
]