[
    {
        "content": "<p>I just found out that IO contains a RealWorld internally. And I wrote a program to experiment.</p>\n<p>In this example, if I let Lean run main1 (rename <code>main1</code> to <code>main</code> and then lean --run realworld.lean), Lean will only ask me to enter 1&gt;&gt;&gt; and then print 1. If I run main2, Lean will ask 1&gt;&gt;&gt; and 2&gt;&gt;&gt;, and then print 1 and 2.</p>\n<p>What I want to confirm is whether this behavior is due to some kind of automatic pruning optimization of Lean? In other words, in main1, Lean detects that I don't use msg2, s2 and s4 (these three variables are not needed to calculate the return value), so it removes the second and fourth lines in the actual generated code?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span>\n<span class=\"cm\">IO α is basically a state machine:</span>\n<span class=\"cm\">RealWorld → (α × RealWorld)</span>\n\n<span class=\"cm\">It takes the state of RealWorld and reads it,</span>\n<span class=\"cm\">does operations,</span>\n<span class=\"cm\">and returns the new modified RealWorld together with a result α.</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">IO</span>\n<span class=\"c1\">-- @[reducible] def IO : Type → Type := EIO IO.Error</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">EIO</span>\n<span class=\"c1\">-- def EIO : Type → Type → Type := fun ε ↦ EStateM ε IO.RealWorld</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span>\n<span class=\"c1\">-- def IO.RealWorld : Type := Unit</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">EStateM</span>\n<span class=\"c1\">-- def EStateM.{u} := fun ε σ α ↦ σ → EStateM.Result ε σ α</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span>\n<span class=\"c1\">-- EStateM.Result.ok : {ε σ α : Type u} → α → σ → EStateM.Result ε σ α</span>\n<span class=\"c1\">-- EStateM.Result.error : {ε σ α : Type u} → ε → σ → EStateM.Result ε σ α</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">IO</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">EIO</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">EStateM</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"c1\">-- change the goal back to the original one</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n\n<span class=\"sd\">/-- turn the error case into ok case, by making a fake result with a default value. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Inhabited</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">default</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getLine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prompt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">prompt</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getLine</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trim</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"For prompt '{prompt.trim}', you entered: '{line}'\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">getLine</span><span class=\"w\"> </span><span class=\"s2\">\"1&gt;&gt;&gt; \"</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">getLine</span><span class=\"w\"> </span><span class=\"s2\">\"2&gt;&gt;&gt; \"</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">((),</span><span class=\"w\"> </span><span class=\"n\">s3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">msg1</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">((),</span><span class=\"w\"> </span><span class=\"n\">s4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">msg2</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"n\">s3</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">lean --run realworld.lean</span>\n\n<span class=\"cm\">1&gt;&gt;&gt; 1</span>\n<span class=\"cm\">For prompt '1&gt;&gt;&gt;', you entered: '1'</span>\n\n<span class=\"cm\">Here I calculated msg2, but I did not use it, so Lean did not ask user for \"&gt;&gt;&gt;2 \"</span>\n<span class=\"cm\">-/</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">getLine</span><span class=\"w\"> </span><span class=\"s2\">\"1&gt;&gt;&gt; \"</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">getLine</span><span class=\"w\"> </span><span class=\"s2\">\"2&gt;&gt;&gt; \"</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">((),</span><span class=\"w\"> </span><span class=\"n\">s3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msg1</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">msg2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">((),</span><span class=\"w\"> </span><span class=\"n\">s4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">msg2</span><span class=\"w\"> </span><span class=\"n\">s0</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"n\">s3</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">lean --run realworld.lean</span>\n\n<span class=\"cm\">1&gt;&gt;&gt; 1</span>\n<span class=\"cm\">2&gt;&gt;&gt; 2</span>\n<span class=\"cm\">For prompt '1&gt;&gt;&gt;', you entered: '1'</span>\n<span class=\"cm\">For prompt '2&gt;&gt;&gt;', you entered: '2'</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 464480462,
        "sender_full_name": "Deming Xu",
        "timestamp": 1724360494
    },
    {
        "content": "<p>Yeah it's just doing dead code analysis, the point of the <code>RealWorld</code> value is to prevent dead code analysis and reorderings from happening to code like IO that relies on a certain execution order.</p>",
        "id": 464480954,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1724360705
    },
    {
        "content": "<p>I searched for RealWorld on zulip, and it turns out that RealWorld should be treated as a value that can only be used once. Similar to Rust, you can't implicitly copy a value by mentioning it twice.</p>\n<p>I feel that after watching RealWorld, my doubts about the IO Monad have finally been resolved. When I learned Haskell's Monad a year ago, I felt that Monad itself was understandable, but the problem was that IO as an instance of Monad was opaque and it was not an inductive type, so you can't really grasp what <code>println</code> <code>getline</code> etc are doing behind the scenes.</p>\n<p>After reading this RealWorld example code, and considering the rule that every RealWorld can only be used once, I think I can finally imagine how these Monad codes are converted into ordinary C++, while the RealWorld ensures that the code is not affected by the radical optimization in functional languages, and that these functions are still pure. Then the <code>pure</code> and <code>bind</code> API in the IO Monad is just one way of ensuring that you're using each RealWorld exactly once.</p>\n<p>It would be great if those web articles explaining Monad could mention RealWorld.</p>",
        "id": 464482796,
        "sender_full_name": "Deming Xu",
        "timestamp": 1724361567
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"740877\">Deming Xu</span> <a href=\"#narrow/stream/113489-new-members/topic/RealWorld.20in.20the.20IO.20Monad/near/464482796\">said</a>:</p>\n<blockquote>\n<p>It would be great if those web articles explaining Monad could mention RealWorld.</p>\n</blockquote>\n<p>I'd say the key is to pick the source material judiciously. For example, both <a href=\"https://leanprover.github.io/functional_programming_in_lean/\">#fpil</a> and <a href=\"https://www.microsoft.com/en-us/research/wp-content/uploads/2016/07/mark.pdf\">Peyton-Jones' \"Tackling the Awkward Squad\"</a> mention the RealWorld model, and the latter even explains the advantages of disadvantages of such a model.</p>",
        "id": 464594421,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1724404770
    }
]