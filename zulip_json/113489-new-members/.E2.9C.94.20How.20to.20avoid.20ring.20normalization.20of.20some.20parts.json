[
    {
        "content": "<p>Suppose I have a big expression which I'll apply ring_nf on. If I want certain parts of the equation to not be normalized (because after normalization, those parts will be used in another fact) how to do that, here's a short albeit too basic example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I want to be able to use <code>h</code> to cancel out square roots, but can't as ring_nf has converted the <code>x+1</code> to <code>1+x</code>. I know that this particualr example can be solved by other ways, but how'd I make ring_nf avoid normalizing the <code>x+1</code> part?</p>\n<p>I had guessed, using set would solve this as that'd hide <code>x+1</code>, but that doesn't work</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>any help is appreciated!</p>",
        "id": 506706148,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742385235
    },
    {
        "content": "<p>Instead of not normalizing x+1, why not normalize h with <code>ring_nf at h</code>, or alternatively just make the input match the form you need</p>",
        "id": 506728499,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742390835
    },
    {
        "content": "<p>I'm not sure how the <code>set</code> example doesn't do what you say you want it to, with a <code>dsimp [a]</code> at the end?</p>",
        "id": 506729031,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742390972
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/113489-new-members/topic/How.20to.20avoid.20ring.20normalization.20of.20some.20parts/near/506729031\">said</a>:</p>\n<blockquote>\n<p>I'm not sure how the <code>set</code> example doesn't do what you say you want it to, with a <code>dsimp [a]</code> at the end?</p>\n</blockquote>\n<p>the set is not doing anything different from example with set, both normalize to same expression (unfolding a)</p>",
        "id": 506744591,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742394478
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"761203\">Vlad Tsyrklevich</span> <a href=\"#narrow/channel/113489-new-members/topic/How.20to.20avoid.20ring.20normalization.20of.20some.20parts/near/506728499\">said</a>:</p>\n<blockquote>\n<p>Instead of not normalizing x+1, why not normalize h with <code>ring_nf at h</code>, or alternatively just make the input match the form you need</p>\n</blockquote>\n<p>yes normalizing at the hypothesis is an option, but I was thinking of a situation where the normalized term is big/complex (not just <code>x+1</code>) while the un-normalized expression has some form of symmetry or some easy strucure for the problem. normalizing forces me to  get rid of that \"easy\" structure</p>",
        "id": 506745208,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742394602
    },
    {
        "content": "<p>if there is some form of symmetry or structure to your problem, that sounds like a decent opportunity for abstracting the proof, which i think typically also solves your normaliation problem</p>",
        "id": 506748069,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1742395210
    },
    {
        "content": "<p>btw, i don't get what issues either of you have with using <code>set</code>... the following works on the web-editor:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- generalize x + 1 = a at h ⊢ -- another way of writing the \"set\" thing</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf</span>\n<span class=\"w\">  </span><span class=\"n\">congr</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">sq_sqrt</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 506749845,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1742395621
    },
    {
        "content": "<p>at no point is <code>a</code> being unfolded</p>",
        "id": 506750270,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1742395726
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>also works here.</p>",
        "id": 506753828,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1742396549
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/113489-new-members/topic/How.20to.20avoid.20ring.20normalization.20of.20some.20parts/near/506749845\">said</a>:</p>\n<blockquote>\n<p>btw, i don't get what issues either of you have with using <code>set</code>... the following works on the web-editor:</p>\n</blockquote>\n<p>Sorry, I should've been clear I was expecting the goals to keep <code>a</code>, I've tried to explain in following snippet</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*√</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"c1\">-- goal is now (√a + 1) ^ 2 = a + 2 * √a + 1</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf</span>\n<span class=\"w\">  </span><span class=\"c1\">-- goal is now  1 + √(1 + x) * 2 + √(1 + x) ^ 2 = 2 + x + √(1 + x) * 2</span>\n<span class=\"w\">  </span><span class=\"c1\">-- but I was hoping for 1 + √a * 2 + (√a)^2 = 2 + x + √a * 2</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 507016382,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742486976
    },
    {
        "content": "<p>perhaps what I am really after is trying to understand how to make ring_nf not convert the <code>a</code> to <code>x+1</code></p>",
        "id": 507016611,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742487021
    },
    {
        "content": "<p>click the button on the upper right corner of the code view to go to the lean live server, it doesn't unfold like you say it does there, so perhaps its something about your environment?</p>",
        "id": 507017220,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742487174
    },
    {
        "content": "<p>perhaps something in lean/mathlib has changed?</p>",
        "id": 507017303,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742487194
    },
    {
        "content": "<p>That could be. I rarely use the web editor, so didn't notice it. Apologies for that.</p>",
        "id": 507017694,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742487270
    },
    {
        "content": "<p>In the web editor, mathlib latest is not unfolding a, but mathlib stable is, I am also using stable (4.17.0) in my local ide. So it seems the behaviour really is different in 4.17.0 and latest</p>",
        "id": 507018312,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742487415
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21194\">#21194</a></p>",
        "id": 507019071,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1742487584
    },
    {
        "content": "<p>Thanks, this answers all my confusion</p>",
        "id": 507019354,
        "sender_full_name": "Sabbir Rahman",
        "timestamp": 1742487645
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"484770\">Sabbir Rahman</span> has marked this topic as resolved.</p>",
        "id": 507019376,
        "sender_full_name": "Notification Bot",
        "timestamp": 1742487651
    },
    {
        "content": "<p>Yes, the default behavior of <code>ring</code> has changed to not zeta- or delta-reduce expressions.</p>",
        "id": 507019805,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1742487745
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21194\">#21194</a></p>",
        "id": 507019975,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1742487788
    }
]