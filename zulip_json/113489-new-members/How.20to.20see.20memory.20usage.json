[
    {
        "content": "<p>This is a code which causes stack overflow error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- non tail recursive function -/</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">naivePower</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">naivePower</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"c1\">-- stack overflow !!</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">naivePower</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n</code></pre></div>\n<p>Each recursive call increases memory usage, which leads to a stack overflow.</p>\n<h3>My Question:</h3>\n<p>Can the Lean code find out how much memory is being used by the execution of a particular function in Lean?</p>",
        "id": 469061551,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725966798
    },
    {
        "content": "<p>That's not possible.</p>",
        "id": 469061722,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725966859
    },
    {
        "content": "<p><del>Impossible in any programming language?</del></p>",
        "id": 469061788,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725966891
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span>  Thank you.</p>\n<p>Can't we even check with the code without making an error that memory usage is increasing with each recursion?</p>",
        "id": 469062410,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725967122
    },
    {
        "content": "<p>There are so many open questions here. For one what do you mean by \"find out how much memory is being used\". Do you want this to happen at compile time? Then it's an undecidable problem in general but may be approximated for certain functions. If you want to decide it at runtime it depends on which kind of memory you are interested in. In this situation we would care about stack memory. We can figure that out by looking at the value of the stack pointer at different times while executing the program and thus figure out how much additional stack memory was allocated since then. This would require a bit of assembly code (maybe there is also some C libraries that already have the assembly code underneath). For heap memory you'd need to check the statistics of <code>malloc</code> but in multi threaded code you need to be careful about not counting memory that is consumed by other threads as well.</p>",
        "id": 469062441,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725967133
    },
    {
        "content": "<p>Thank you. </p>\n<blockquote>\n<p>Do you want this to happen at compile time?</p>\n</blockquote>\n<p>It would be nice to be able to check with <code>#eval</code> without compiling.</p>",
        "id": 469062908,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725967293
    },
    {
        "content": "<p>But #eval is already compiling and evaluating code?</p>",
        "id": 469062957,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725967315
    },
    {
        "content": "<blockquote>\n<p>But #eval is already compiling and evaluating code?</p>\n</blockquote>\n<p>Oh, I seem to have misunderstood the behaviour of #eval.</p>\n<p>I thought #eval was just running in the interpreter.</p>",
        "id": 469063262,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725967419
    },
    {
        "content": "<p>Yes but in order to run the interpreter the code needs to be compiled into bytecode already.</p>",
        "id": 469063416,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725967462
    },
    {
        "content": "<p>And I still don't really see what you are asking for. Do you want a static analysis that can tell you whether a function will fill up stack space or do you want something dynamic that checks at runtime how much stack space is currently in use?</p>",
        "id": 469063613,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725967532
    },
    {
        "content": "<blockquote>\n<p>do you want something dynamic that checks at runtime how much stack space is currently in use?</p>\n</blockquote>\n<p>My motivation is to see how memory is wasted by not being tail-recursive. So I want to see something dynamic.</p>",
        "id": 469063834,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725967616
    },
    {
        "content": "<p>Do you know the difference between a static and a dynamic analysis?</p>",
        "id": 469063954,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725967662
    },
    {
        "content": "<blockquote>\n<p>Do you know the difference between a static and a dynamic analysis?</p>\n</blockquote>\n<p>I honestly don't understand it.</p>",
        "id": 469064065,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725967693
    },
    {
        "content": "<p>An analysis is called static if it gives a result by just looking at the code itself while a dynamic analysis gives a result by executing the code.</p>",
        "id": 469066991,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725968610
    },
    {
        "content": "<blockquote>\n<p>An analysis is called static if it gives a result by just looking at the code itself while a dynamic analysis gives a result by executing the code.</p>\n</blockquote>\n<p>It matches the image I had somewhat in mind.</p>",
        "id": 469068166,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725969017
    },
    {
        "content": "<p>Which one?</p>",
        "id": 469068228,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725969032
    },
    {
        "content": "<blockquote>\n<p>Which one?</p>\n</blockquote>\n<p>both. My previous understanding of static and dynamic analysis seems to have been generally correct.</p>",
        "id": 469068777,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725969200
    },
    {
        "content": "<p>Yes but which one do you want for your use case here?</p>",
        "id": 469069001,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725969269
    },
    {
        "content": "<p>dynamic...?</p>\n<p>Is it possible to find out how much memory is being used statically, i.e. without executing any code?</p>",
        "id": 469069162,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725969327
    },
    {
        "content": "<blockquote>\n<p>Is it possible to find out how much memory is being used statically, i.e. without executing any code?</p>\n</blockquote>\n<p>Generally that is undecidable but we can decide for lots of functions (such as the one above) how much will be used at most with some effort.</p>\n<blockquote>\n<p>dynamic...?</p>\n</blockquote>\n<p>Okay so you wish to run something along the lines of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">resources</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"n\">arg1</span><span class=\"w\"> </span><span class=\"n\">arg2</span><span class=\"w\"> </span><span class=\"n\">arg3</span>\n</code></pre></div>\n<p>and be told how much stack and heap memory it uses?</p>",
        "id": 469069464,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725969420
    },
    {
        "content": "<blockquote>\n<p>but we can decide for lots of functions (such as the one above) how much will be used at most with some effort.</p>\n</blockquote>\n<p>wao!!</p>\n<blockquote>\n<p>and be told how much stack and heap memory it uses?</p>\n</blockquote>\n<p>Yes.</p>",
        "id": 469069608,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725969473
    },
    {
        "content": "<p>Okay, for heap memory C provides the necessary APIs and we could lift them into surface level Lean in theory. For stack memory figuring out the maximum amount of stack memory used without touching the function that you want to look at is not nicely doable. If you want to touch it on the other hand it would be doable with some C as well.</p>",
        "id": 469070146,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725969604
    }
]