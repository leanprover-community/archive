[
    {
        "content": "<p>Hi all,</p>\n<p>I've been using Lean for almost a year now and I'm still stumbling over the basics. I'm trying to formalize STLC (with booleans) (see <a href=\"https://softwarefoundations.cis.upenn.edu/plf-current/Stlc.html\">https://softwarefoundations.cis.upenn.edu/plf-current/Stlc.html</a>) and came across an interesting termination problem.</p>\n<p>The core of the issue is that I have a <code>map</code> function for working with <code>Term</code>s to make it easier to write the <code>subst</code>itution function, but using it causes Lean to not immediately figure out its termination, which is natural as the decreasing argument is being mapped over.</p>\n<p>I need help with proving termination when I know the subterms that are mapped are smaller than the original term. Here is my code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Boolean</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Arrow</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fro</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"o\">)</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">False</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Ite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">if_true</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">if_false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Abs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ty</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">App</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tâ‚</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tâ‚‚</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Var</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Ty</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Var</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">self</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Ite</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"w\"> </span><span class=\"n\">if_true</span><span class=\"w\"> </span><span class=\"n\">if_false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Ite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">cond</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">if_true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">if_false</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Abs</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Abs</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">App</span><span class=\"w\"> </span><span class=\"n\">tâ‚</span><span class=\"w\"> </span><span class=\"n\">tâ‚‚</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">App</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">tâ‚</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">tâ‚‚</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Var</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Abs</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">tâ‚</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">tâ‚</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">Abs</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">tâ‚</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"c1\">-- how do I express that map passess terms that are smaller than t to subst x s?</span>\n<span class=\"w\">    </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"c1\">-- HERE: fail to show termination</span>\n\n<span class=\"c1\">-- Lean figures out the termination of the following as expected</span>\n<span class=\"c1\">-- def subst (x : String) (s : Term) (t : Term) : Term := match t with</span>\n<span class=\"c1\">--   | Var y =&gt; if x = y then s else t</span>\n<span class=\"c1\">--   | Abs y T tâ‚ =&gt; if x = y then tâ‚ else Abs y T (subst x s tâ‚)</span>\n<span class=\"c1\">--   | True | False =&gt; t</span>\n<span class=\"c1\">--   | Ite cond if_true if_false =&gt; Ite (subst x s cond) (subst x s if_true) (subst x s if_false)</span>\n<span class=\"c1\">--   | App tâ‚ tâ‚‚ =&gt; App (subst x s tâ‚) (subst x s tâ‚‚)</span>\n</code></pre></div>\n<p>Another odd thing is that Lean asks me to prove <strong>âŠ¢</strong> sizeOf t &lt; sizeOf xâœ where <code>t</code> doesn't refer to the original <code>t</code> but I think it's the <code>t</code> \"missing\" in <code>subst x s</code> passed to <code>map</code>. I noticed this because I tried to prove this claim using a sorry but that gets renamed to <code>tâœ</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">sizeOf</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">    </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span>\n</code></pre></div>\n<p>Any help and/or explanations are greatly appreciated <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 490899489,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1735234162
    },
    {
        "content": "<p>I suppose that it is difficult to prove termination because it is wrong: Let <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span> be <code>True</code>. Then <code>subst x s True = map (subst x s) True</code>. By the definition of map <code>map (subst x s) True = subst x s True</code>, which is exactly what we started with.<br>\nmap does not pass terms that are smaller than <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span> because nothing is smaller than <code>True</code> or <code>False</code> to <code>sizeOf</code>.</p>",
        "id": 495452420,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1737622425
    },
    {
        "content": "<p>You can see that this does not occur in your modified version, because there True/False are directly returned.</p>",
        "id": 495452565,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1737622467
    },
    {
        "content": "<p>Very good point <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> thanks for pointing that out!</p>",
        "id": 495458167,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1737624206
    },
    {
        "content": "<p>Okay I edited my code to handle the base cases, but now my question still holds: how to prove termination of <code>map (subst x s)</code>? It seems like there's no way to do it with <code>have</code> so what other approaches could be used?</p>",
        "id": 495459788,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1737624842
    },
    {
        "content": "<p>I think that Lean does not understand that <code>_</code> corresponds to <code>Ite</code>. I think you should only use <code>_</code> as I don't care what is there, which is not the case here as we need that this is not True/False</p>",
        "id": 495461044,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1737625218
    },
    {
        "content": "<p>It's Ite or App. I'm working on a minimal version of the problem</p>",
        "id": 495462728,
        "sender_full_name": "Niklas Halonen",
        "timestamp": 1737626265
    },
    {
        "content": "<p>I think the same applies here. Lean does not know that it is either Ite or App so you have to state it more explicitly. Alternatively, write functions like <code>BaseCase</code>=(True or False), <code>isVar</code> and <code>isAbs</code> and combine them to an if-else.</p>",
        "id": 495463900,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1737626520
    },
    {
        "content": "<p>Though you have have to write the ifs as <code>h:isVar t</code> inorder to use this in the termination proof</p>",
        "id": 495464181,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1737626582
    },
    {
        "content": "<p>For the termination check to pass, you need something in the local context at each check site that implies that the new input is smaller than what you started with. You don't get this from <code>map</code> because <code>f : Î± â†’ Î²</code> just gets <em>some</em> value of type <code>Î±</code>, not necessarily a smaller one. You can use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.pmap#doc\">docs#List.pmap</a> to also get a proof that <code>a âˆˆ l</code>, which can be used to show that <code>sizeOf</code> decreases (in my experience Lean can often do this automatically once <code>a âˆˆ l</code> is in the local context).</p>",
        "id": 495574405,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737661630
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"128280\">Wojciech Nawrocki</span> <a href=\"#narrow/channel/113489-new-members/topic/Termination.20of.20substitution.20in.20STLC/near/495574405\">schrieb</a>:</p>\n<blockquote>\n<p>For the termination check to pass, you need something in the local context at each check site that implies that the new input is smaller than what you started with. You don't get this from <code>map</code> because <code>f : Î± â†’ Î²</code> just gets <em>some</em> value of type <code>Î±</code>, not necessarily a smaller one. You can use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.pmap#doc\">docs#List.pmap</a> to also get a proof that <code>a âˆˆ l</code>, which can be used to show that <code>sizeOf</code> decreases (in my experience Lean can often do this automatically once <code>a âˆˆ l</code> is in the local context).</p>\n</blockquote>\n<p>I don't see why that would help here as map here is a user defined function for terms and not the function for lists</p>",
        "id": 495659252,
        "sender_full_name": "Johannes Tantow",
        "timestamp": 1737707545
    },
    {
        "content": "<p>Oh, you're right; but you can apply the <code>List.map -&gt; List.pmap</code> transformation to <code>Term.map</code> by adding an argument to the effect of <code>t âˆˆ self</code> (or just <code>sizeOf t &lt; sizeOf self</code>) to <code>f</code>. (And yeah, it doesn't hold for the base cases; those would have to be accounted for somehow.)</p>",
        "id": 495750672,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737735983
    },
    {
        "content": "<p>Also, independently of that, the <code>subst</code> case for <code>Abs</code> looks wrong to me: you have <code>(Î»(y:T). tâ‚)[t/x] = tâ‚</code> when <code>x = y</code>. Should it rather be <code>Î»(y:T). tâ‚</code>?</p>",
        "id": 495751767,
        "sender_full_name": "ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’",
        "timestamp": 1737736336
    }
]