[
    {
        "content": "<p>Hello!<br>\nAs a first project in meta-programming I'm trying to write a tactic that handles expressions in First-Order-Logic, like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">handle_logic</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">handle_logic</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(((</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x4</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">))))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">handle_logic</span>\n</code></pre></div>\n<p>If a proof exists, it should output the used tactics, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x5</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\">  </span><span class=\"n\">handle_logic</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Exists</span><span class=\"bp\">.</span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>\n<p>Some operators are working (like Or, And, Implication, ...), but I did not get the \"handleForall\" completed.</p>\n<p>What I want to do is: if a \"∀ (&lt;var_name&gt; : &lt;var_type&gt;), &lt;body&gt;\" is found, I want to add a \"have : ∃ (&lt;var_name&gt; : &lt;var_type&gt;), &lt;body&gt;\" tactic. The idea is then to check for True and False and if one resolves into False, the \"∀\" is False if not it's True. (I know that I'm mixing different levels of True/False but I hope it is understandable.)</p>\n<p>I did not manage to get all the needed information in the correct form (types) and put them together and execute the tactic.</p>\n<p>Here are the first some lines of my function that handles the Forall case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">handleForall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)):</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">NodeState</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"handleForall: expression [{expr}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">bindingBody!</span><span class=\"w\"> </span><span class=\"c1\">-- Get the body of the forall</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"handleForall: body [{body}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">varType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">bindingDomain!</span><span class=\"w\"> </span><span class=\"c1\">-- Get the type of the bound variable</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"handleForall: varType [{varType}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">localTB</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"o\">([]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Extract the variable and body of the forall expression</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">varName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">bindingName!</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"handleForall: Bound variable [{varName}]\"</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Convert varName, varType, and body to TSyntax format for use in tactics</span>\n<span class=\"w\">  </span><span class=\"c1\">--  let varNameSyntax := mkIdent varName</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">varNameSyntax</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`ident</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">varName</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"handleForall: varNameSyntax [{varNameSyntax}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">varTypeSyntax</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">toSyntax</span><span class=\"w\"> </span><span class=\"n\">varType</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"handleForall: varTypeSyntax [{varTypeSyntax}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">bodySyntax</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">toSyntax</span><span class=\"w\"> </span><span class=\"n\">body</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"handleForall: bodySyntax [{bodySyntax}]\"</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Try substituting the bound variable with False</span>\n<span class=\"w\">  </span><span class=\"n\">logB</span><span class=\"w\"> </span><span class=\"n\">lB</span><span class=\"w\"> </span><span class=\"s2\">\"handleForall: Trying exists False\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">localFalseTB</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"o\">([]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- XXX Test for \"(∀ (x1 : Prop), x1)\" as I have no idea how to</span>\n<span class=\"w\">  </span><span class=\"c1\">--     extract and use the variable and the term.</span>\n<span class=\"w\">  </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h_false</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">varTypeSyntax</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">bodySyntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"n\">exists</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"c1\">-- XXX \"varNameSyntax\" has type TSyntax `ident : Type but is expected to have type TSyntax `Lean.binderIdent : Type</span>\n<span class=\"w\">  </span><span class=\"c1\">-- XXX \"varName\" has type Name : Type but is expected to have type TSyntax `Lean.binderIdent : Type</span>\n<span class=\"w\">  </span><span class=\"c1\">-- evalTactic (← `(tactic| have h_false : ∃ ($varName : $varTypeSyntax), $bodySyntax := by exists False))</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- XXX What is the state of the goal? Is this now an \"∃\" statement?</span>\n</code></pre></div>\n<p>And logs from a simple test:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">handleForall</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">expression</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"k\">forall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">x1</span><span class=\"o\">]</span>\n<span class=\"n\">handleForall</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"n\">handleForall</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">varType</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kt\">Prop</span><span class=\"o\">]</span>\n<span class=\"n\">handleForall</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bound</span><span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">x1</span><span class=\"o\">]</span>\n<span class=\"n\">handleForall</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">varNameSyntax</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">`x1</span><span class=\"o\">]</span>\n<span class=\"n\">handleForall</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">varTypeSyntax</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">syntheticHole</span><span class=\"w\"> </span><span class=\"s2\">\"?\"</span><span class=\"w\"> </span><span class=\"ss\">`a._</span><span class=\"bp\">@.</span><span class=\"n\">miniF2F</span><span class=\"bp\">-</span><span class=\"n\">Lean4</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">.</span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">test</span><span class=\"bp\">.</span><span class=\"n\">ap039</span><span class=\"bp\">._</span><span class=\"n\">hyg</span><span class=\"bp\">.</span><span class=\"m\">8059</span><span class=\"o\">)]</span>\n</code></pre></div>\n<p>My questions:</p>\n<ol>\n<li>How to correctly construct the \"have\" tactic?</li>\n<li>How to get the correct goal (i.e. the <code>∃ (&lt;var_name&gt; : &lt;var_type&gt;), &lt;body&gt;</code>?</li>\n</ol>\n<p>Any hint is welcome!</p>",
        "id": 469630873,
        "sender_full_name": "florath",
        "timestamp": 1726137422
    }
]