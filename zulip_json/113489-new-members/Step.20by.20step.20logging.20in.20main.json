[
    {
        "content": "<p>Hey there,</p>\n<p>I would like to have a main function that does:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Before a\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fa</span><span class=\"w\"> </span><span class=\"n\">args</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"After a\"</span>\n</code></pre></div>\n<p>When I do that in lean (assume we wait a few seconds in <code>fa args</code>), the text is all printed at once at the very end of the execution.</p>\n<p>Do I have a way to \"force\" the execution to be step-by-step ?</p>",
        "id": 456798941,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722933570
    },
    {
        "content": "<p>That's not the case, if you run the binary that is generated from this code the IO will happen \"step by step\" and not at once in the end</p>",
        "id": 456799118,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722933620
    },
    {
        "content": "<p>Oh I guess I was not clear.<br>\nMy problem is that (looking at the binary), lean computes <code>fa args</code> during initialization of the binary, and then executes the body on the function.</p>\n<p>I'd like to force <code>fa args</code> being computed in order, instead of at initialization</p>",
        "id": 456799490,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722933710
    },
    {
        "content": "<p>you can disable closed term extraction with <code>set_option compiler.extract_closed false</code></p>",
        "id": 456799774,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722933809
    },
    {
        "content": "<p>That worked, thank you very much !</p>",
        "id": 456799925,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722933853
    },
    {
        "content": "<p>One last question while we're at it.<br>\nI have a monad to which I want to add an IO effect, is there an easy way to do so ?</p>",
        "id": 456804121,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722935257
    },
    {
        "content": "<p>Basically I have a monad that I use to make a computation and I'd like to have a step where I print stuff to the screen in between computations</p>",
        "id": 456805130,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722935593
    },
    {
        "content": "<p>Do you know about monad transformers?</p>",
        "id": 456807008,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722936181
    },
    {
        "content": "<p>Kind of, I'm reading the \"Functionnal programming in Lean\" about that ;-)</p>",
        "id": 456807070,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722936205
    },
    {
        "content": "<p>But I can't find an IO transformer</p>",
        "id": 456807106,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722936218
    },
    {
        "content": "<p>That's what you want to use^^</p>",
        "id": 456807108,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722936218
    },
    {
        "content": "<p>Right</p>",
        "id": 456807118,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722936222
    },
    {
        "content": "<p>IO does not have a transformer, you would usually write your monad like <code>ReaderT SomeContext &lt;| StateT SomeState IO</code> so <code>IO</code> would always be at the bottom of your monad stack.</p>",
        "id": 456807263,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1722936254
    },
    {
        "content": "<p>If working over a general monad, you can use <code>[MonadLiftT IO m]</code>, right?</p>",
        "id": 456823201,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722941795
    },
    {
        "content": "<p>Actually let me add a little more context.<br>\nMy goal is to prove of disprove that each turing machine in a set terminates.<br>\nMy way into that is to have \"deciders\" which are algorithms which try to prove that the machine halts (or loops forever).</p>\n<p>My idea was to have a monad like that, in order to chain deciders:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">HaltM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Machine</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">HaltM</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">halts_prf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">halts</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">HaltM</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">loops_prf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">halts</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">HaltM</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>\n<p>Then if my decider has the type <code>Unit -&gt; HaltM M Unit</code> I can chain them to have a bigger decider that tries them all, right ?</p>",
        "id": 456837724,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722945631
    },
    {
        "content": "<p>Conveniently, stepping a machine can also give me an instance of this monad, that gives me either the next state in <code>.unknown</code> or the proof that the machine halts (we reached a halting state)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Machine</span><span class=\"bp\">.</span><span class=\"n\">step</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Machine</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">HaltM</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 456838619,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722945781
    },
    {
        "content": "<p>Now let's say I want to extend my deciders to allow them to print stuff on the screen, what would their return type be ?</p>\n<p>I can't see if it is <code>IO (HaltM ...)</code> or some kind of other thing</p>",
        "id": 456838958,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722945866
    },
    {
        "content": "<p>In particular, I have a decider that looks somewhat like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">looperDec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Machine</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HaltM</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M.step</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">M.step</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">M.step</span><span class=\"w\"> </span><span class=\"n\">init</span>\n<span class=\"w\">      </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>But I get the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">step</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;=</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"bp\">.</span><span class=\"n\">step</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">HaltM</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">Config</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>",
        "id": 456842582,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722946832
    }
]