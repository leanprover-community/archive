[
    {
        "content": "<p>I was thinking that <code>a+b</code> is just a macro/notation which maps to <code>HAdd.hAdd a b</code> <br>\nbut I see that these two terms have different behavior. lean4 is not able to synthesize class for first one, but is able for second one.<br>\nI am expecting same behavior because I just unwrapped <code>+</code> macro </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HMul</span><span class=\"bp\">.</span><span class=\"n\">hMul</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HPow</span><span class=\"bp\">.</span><span class=\"n\">hPow</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Neg</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HMul</span><span class=\"bp\">.</span><span class=\"n\">hMul</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HPow</span><span class=\"bp\">.</span><span class=\"n\">hPow</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Neg</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 548157279,
        "sender_full_name": "nnarek",
        "timestamp": 1761917373
    },
    {
        "content": "<p>It is very very close to \"just\" a macro/notation, but it has to do with the order that implicit arguments are inferred, and casts inserted. The issue that you'll see in that example is that you're getting</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>in the second example, so two coercions being inserted. It found an <code>Add</code> instance of <code>Int</code> (using the last term as a guide) and then inferred the other ones based on that, adding coercions. But in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HMul</span><span class=\"bp\">.</span><span class=\"n\">hMul</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HPow</span><span class=\"bp\">.</span><span class=\"n\">hPow</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Neg</span><span class=\"bp\">.</span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>it first finds that the first argument is a Nat, and the second argument is an Int, and so it gets stuck looking for <code>HAdd ℕ ℤ ?.</code>.</p>",
        "id": 548158023,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1761917596
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"933728\">@nnarek</span> you have too much other stuff getting in the way of simply checking whether they're the same, if you make the situation as simple as possible then you can clearly see that they are the same thing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- set_option pp.all true</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"c1\">-- 3 + 4</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"c1\">-- 3 + 4</span>\n</code></pre></div>",
        "id": 548161633,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761918590
    },
    {
        "content": "<p>Thank you, so I need to insert coerection manually </p>\n<p><code>#check ∀ (a: Nat -&gt; Nat) (n : Nat), a n = HAdd.hAdd ↑(HMul.hMul 3 n) (HPow.hPow (Neg.neg (1 : Int)) n)</code></p>",
        "id": 548165321,
        "sender_full_name": "nnarek",
        "timestamp": 1761919578
    },
    {
        "content": "<p><code>a + b</code> elaborates to <code>binop% HAdd.hAdd a b</code> which is similar to <code>HAdd.hAdd a b</code> but has different handling of coercions</p>",
        "id": 548214276,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1761932548
    }
]