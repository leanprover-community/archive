[
    {
        "content": "<p>Hi all, I'm a software engineer with an interest in formal verification. I'm messing around with some silly types-containing-types stuff and I've run into a coercion problem, here's a restricted test case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">Fork</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">Node_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">Fork</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- can't find this equality if I define Node with :=</span>\n<span class=\"w\">  </span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fork</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"w\">  </span><span class=\"n\">fork_left_unique</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fork</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∃!</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Node</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ...</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBaseMorph</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Nil_map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">Nil</span>\n<span class=\"w\">  </span><span class=\"n\">Fork_map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Fork</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">Fork</span>\n<span class=\"w\">  </span><span class=\"n\">Node_map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Node_def</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">Node_def</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Nil_map</span><span class=\"w\"> </span><span class=\"n\">Fork_map</span>\n<span class=\"w\">  </span><span class=\"n\">preserves_fork_left</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Fork</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Node</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fork_map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Node_map</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ...</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">proofs</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">id_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBaseMorph</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">Node_def</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span>\n<span class=\"w\">      </span><span class=\"c\">/-</span>\n<span class=\"cm\">        t : ModelBTreeBase</span>\n<span class=\"cm\">        f : t.Fork</span>\n<span class=\"cm\">        c : t.Node</span>\n<span class=\"cm\">        h : t.fork_left f c</span>\n<span class=\"cm\">        ⊢ t.fork_left f (Eq.rec (motive := fun x h ↦ x → x) id (Eq.symm t.Node_def) c)</span>\n<span class=\"cm\">      -/</span>\n<span class=\"w\">  </span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>It seems to me that that recursor application should be equal to c but it doesn't seem to be definitionally equal. I'm wondering if there's some magic I can invoke to fix this. Looking forward to chatting with you all :)</p>",
        "id": 554248964,
        "sender_full_name": "James G",
        "timestamp": 1762498446
    },
    {
        "content": "<p>Type equality is almost always bad to deal with. Even if it's a bit more annoying, you'd be probably better off with inlining <code>Node</code> in the structure and making it a definition:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">Fork</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"w\">  </span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fork</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">Fork</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"w\">  </span><span class=\"n\">fork_left_unique</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fork</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∃!</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">Fork</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ...</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"bp\">.</span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">Fork</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBaseMorph</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Nil_map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Nil</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">Nil</span>\n<span class=\"w\">  </span><span class=\"n\">Fork_map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Fork</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">Fork</span>\n<span class=\"w\">  </span><span class=\"n\">Node_map</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">Node</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Nil_map</span><span class=\"w\"> </span><span class=\"n\">Fork_map</span>\n<span class=\"w\">  </span><span class=\"n\">preserves_fork_left</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Fork</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">Node</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">b1</span><span class=\"bp\">.</span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">b2</span><span class=\"bp\">.</span><span class=\"n\">fork_left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fork_map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Node_map</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ...</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">id_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBase</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModelBTreeBaseMorph</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">intros</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simpa</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 554251994,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1762499287
    },
    {
        "content": "<p>Yeah, I was wondering if that was gonna be the solution. Alright, thanks</p>",
        "id": 554252604,
        "sender_full_name": "James G",
        "timestamp": 1762499607
    },
    {
        "content": "<p>Is <code>abbrev</code> different from <code>def</code> there?</p>",
        "id": 554252989,
        "sender_full_name": "James G",
        "timestamp": 1762499858
    },
    {
        "content": "<p>The difference between <code>abbrev</code> and <code>def</code> is mostly when a declaration can be unfolded. For example, <code>simp</code> can't see through regular <code>def</code>s which might lead to problems since we've used <code>Nil ⊕ Fork</code> before which then, to <code>simp</code> and others, seem like two distinct things. <code>abbrev</code>s on the other hand, can always be unfolded and are also always eagerly unfolded in definitional equality problems.</p>",
        "id": 554253762,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1762500285
    }
]