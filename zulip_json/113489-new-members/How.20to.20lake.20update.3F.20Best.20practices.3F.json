[
    {
        "content": "<p>Each time a new lean version comes out or when I want something that was only added to mathlib recently, I need to update the dependencies of my project. I figured this out more or less by trial and error and basically do this:</p>\n<ol>\n<li>Change <code>lean-toolchain</code> manually.</li>\n<li>In <code>lakefile.lean</code> update my pinning of mathlib.</li>\n<li><code>rm -rf lake-manifest.json .lake</code> <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span> </li>\n<li><code>lake update -R</code> (which regenerates the manifest and downloads the mathlib cache)</li>\n<li><code>lake build</code> (to actually check if my stuff builds with the new versions)</li>\n</ol>\n<p>Is this a reasonable way to do it? Or unnecessarily manual? Or dangerous?</p>\n<p>For my future self and someone who asked about this me today, I just now wrote down more details in a <a href=\"https://malv.in/posts/2024-12-09-howto-update-lean-dependencies.html\">blog post here</a> and I'd be happy to hear more what is the \"official right way\" to do this. Here on zulip there are multiple threads of the form \"I ran <code>lake update</code> and it broke ...\" so some general advice on it might be good. Is there something in the Lean manual or elsewhere?</p>",
        "id": 487099267,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1733778497
    },
    {
        "content": "<p>You <em>should</em> be able to drop step 3, otherwise this is reasonable enough</p>",
        "id": 487108803,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733781926
    },
    {
        "content": "<p>Though I'm not sure why you're pinning mathlib in your <code>lakefile.lean</code></p>",
        "id": 487108945,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733781969
    },
    {
        "content": "<p>On the leanprover community website, the updating process is described as follows:</p>\n<ol>\n<li>Update <code>lean-toolchain</code>by running <code>curl -L https://raw.githubusercontent.com/leanprover-community/mathlib4/master/lean-toolchain -o lean-toolchain</code> in the directory of your repository.</li>\n<li>Run <code>lake update</code>.</li>\n<li>(optional) Build files with <code>lake exe mk_all &amp;&amp; lake build</code>.<br>\nFor me this has worked so far, and I've always understood it to be the \"official way\". However I don't understand enough of the process to judge how this differs from <span class=\"user-mention\" data-user-id=\"422703\">@Malvin Gattinger</span>'s approach. Can anyone explain this?</li>\n</ol>",
        "id": 487134040,
        "sender_full_name": "Paul Schwahn",
        "timestamp": 1733793209
    },
    {
        "content": "<p>There's two main ways you might depend on mathlib in your lakefile: either depend on master or on a specific v4.X.0 tag. I guess Malvin is using the latter and you are using the former</p>",
        "id": 487174610,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733813910
    },
    {
        "content": "<p>In the tag case, you also need to update the lakefile before you can update mathlib</p>",
        "id": 487174658,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733813940
    },
    {
        "content": "<blockquote>\n<ul>\n<li>Update <code>lean-toolchain</code>by running <code>curl -L https://raw.githubusercontent.com/leanprover-community/mathlib4/master/lean-toolchain -o lean-toolchain</code> in the directory of your repository.</li>\n</ul>\n</blockquote>\n<p>This step should be obsolete starting with Lean 4.15.0, <a href=\"https://github.com/leanprover/lean4/pull/5684\">lean#5684</a>. Obviously we shouldn't delete that text yet but maybe make it conditional?</p>",
        "id": 487210391,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1733826052
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/113489-new-members/topic/How.20to.20lake.20update.3F.20Best.20practices.3F/near/487174610\">said</a>:</p>\n<blockquote>\n<p>There's two main ways you might depend on mathlib in your lakefile: either depend on master or on a specific v4.X.0 tag. I guess Malvin is using the latter and you are using the former</p>\n</blockquote>\n<p>This discrepancy can be avoided by pinning the <code>stable</code> branch instead of a fixed tag in the lakefile. Perhaps this should even be advertised as the default way of depending on Mathlib for anyone not interested in the bleeding edge?</p>",
        "id": 487210988,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1733826213
    },
    {
        "content": "<p>IOW: Use <code>master</code> or <code>stable</code>, then <code>lake update</code> should be the only command necessary going forward.</p>",
        "id": 487211215,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1733826262
    },
    {
        "content": "<p>Huh, I didn't know mathlib had a stable branch</p>",
        "id": 487211460,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733826323
    },
    {
        "content": "<p>Concretely, what should the configuration files in a Lean project (say, using Mathlib) look like, and which files are these? I have no real project underway, and what little I created was copy/paste from tutorial webpages, but <code>lake update</code> fails with a <code>invalid toolchain name: 400: Invalid request</code> error.</p>\n<p>At the moment it's no big deal because I can easily create a new project from scratch and copy the one or two Lean files over, but I'd like to do things semi-right in the future (and, hopefully, will end up having more content to copy over).</p>",
        "id": 487255041,
        "sender_full_name": "Philippe Duchon",
        "timestamp": 1733838795
    },
    {
        "content": "<p>I assume for making new projects the recommendation is to run <code>lake init myProject math</code>. That creates a <code>lean-toolchain</code> and <code>lakefile.toml</code> (even though <code>lake init --help</code> says \"the default is Lean\" <span aria-label=\"ladybug\" class=\"emoji emoji-1f41e\" role=\"img\" title=\"ladybug\">:ladybug:</span> ?). Notable the lakefile does not specify a tag or version of mathlib, but the first <code>lake build</code> then creates a manifest.</p>",
        "id": 487270869,
        "sender_full_name": "Malvin Gattinger",
        "timestamp": 1733843008
    },
    {
        "content": "<p>To me, use <code>lake new ProjectName math.lean</code> works just fine. But the initial toolchain will be the latest Mathlib and the lakefile doesn't specify a tag. I will choose to modify the <code>lean-toolchain</code> to a stable version like <code>v4.14.0</code> and specify the tag in lakefile.</p>\n<p>In <code>lakefile.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"s2\">\"git#v4.14.0\"</span>\n</code></pre></div>\n<p>In <code>lakefile.toml</code>:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[[require]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib\"</span>\n<span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"leanprover-community\"</span>\n<span class=\"n\">rev</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"v4.14.0\"</span>\n</code></pre></div>\n<p>Then run <code>lake update</code> and generate a manifest. These steps will ensure running <code>lake update</code> won't change the current manifest. Everything is stable now.</p>",
        "id": 487285070,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1733846015
    },
    {
        "content": "<p>Why?</p>",
        "id": 487295271,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733848641
    },
    {
        "content": "<p>Oh, I was talking about non-mathlib development. I prefer working in a 100% stable environment. If keep up with the latest mathlib is necessary, then of course you need to change the tag to master and then lake update.</p>",
        "id": 487297526,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1733849235
    },
    {
        "content": "<p>In my own project, I will only update when mathlib release a new tag.</p>",
        "id": 487297781,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1733849293
    },
    {
        "content": "<p>No, my point is - it's very easy to have a fully stable environment: never run <code>lake update</code>. I don't see why you'd want a setup where you do run <code>lake update</code> but don't want it to do anything</p>",
        "id": 487310692,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1733853410
    },
    {
        "content": "<p>Partly because I often work with people who are new to Lean and know little about how these things work. I need to make sure they won't mess up the environment by running command they don't really know.</p>",
        "id": 487995027,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1733879772
    }
]