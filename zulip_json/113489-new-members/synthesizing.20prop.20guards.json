[
    {
        "content": "<p>Hi folks! I'm new to Lean, and was curious to cut my teeth on modeling <a href=\"https://numpy.org/doc/stable/user/basics.broadcasting.html\">NumPy-style broadcasting</a> in Lean at the type level. Array shapes are represented as <code>List Nat</code> and I have taken the approach of using a Prop to encode that two shapes are <code>Broadcastable s1 s2</code>. However, I'm running into two issues:</p>\n<ol>\n<li>I'm finding that a <code>Broadcastable s1 s2</code> implicit parameter  is not being synthesized as I would expect in <code>HAdd</code>, and</li>\n<li>No matter what I do, I can't get lean to synthesize the <code>Broadcastable s1 s2</code> argument in the application of <code>HAdd.add</code></li>\n</ol>\n<p>I'm curious: Why aren't these arguments being synthesized by Lean? I have found that sometimes arguments are synthesized correctly, but sometimes not. (more details in code) More broadly, is this an appropriate design for this problem? </p>\n<p>Ideally, I would like an approach that used maximum automation to fill in these instances. They are tedious and ought to be easy work for something like <code>grind</code>. I have heard of <code>Decidable</code>, but I'm not sure how that works or if it would be applicable here?</p>\n<p><a href=\"https://live.lean-lang.org/#codez=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\">MWE code</a></p>",
        "id": 542278974,
        "sender_full_name": "samuela",
        "timestamp": 1759239536
    },
    {
        "content": "<p>You need to make it a typeclass</p>",
        "id": 542282018,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759240290
    },
    {
        "content": "<p>That's the square bracket system</p>",
        "id": 542282053,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759240300
    },
    {
        "content": "<p>There are basically two types of synthesization: one for type classes and one for regular holes/implicits. Type class synthesization happens when you use a function with an instance implicit parameter (<code>[MyClass ...]</code>) and uses variables of the form <code>MyClass ...</code> from the local context and any <code>instance</code> declarations. The other kind of synthesization is inferring values from typing rules. For example when you have <code>l : List Nat</code> and do <code>List.length l</code>, then it can infer the implicit parameter <code>α</code> from context because it expects <code>l : List ?α</code> and gets <code>l : List Nat</code>. On the other hand, this won't take in variables from the local context. For example you wouldn't want this to randomly assign using the <code>Nat</code> from the context:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkVector</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: don't know how to synthesize implicit argument `n`</span>\n<span class=\"sd\">  @mkVector (?m.5 n)</span>\n<span class=\"sd\">context:</span>\n<span class=\"sd\">n : Nat</span>\n<span class=\"sd\">⊢ Nat</span>\n<span class=\"sd\">---</span>\n<span class=\"sd\">error: Failed to infer type of definition `test`</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkVector</span>\n</code></pre></div>\n<p>For example, you could've also meant <code>@mkVector 10</code> or <code>@mkVector (n + 1)</code> etc. so instead of using the <code>n</code> from the local context, it instead simply tells you that it doesn't have enough information to infer the parameter <code>n</code>.</p>",
        "id": 542287011,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759241372
    },
    {
        "content": "<p>Ok, thank you! So IIUC typeclass synthesis, aka <code>[Foo]</code> notation,  will do the whole rigmarole of synthesis to chain any number of type classes together to get any instance that satisfactorily fills a type class hole (a la haskell, etc) and implicit  arguments, aka {_ : Foo} notation, will only synthesize from other variables in a function definition as in the List Nat example? So {}-synthesis will not utilize things in context at site of the function application</p>",
        "id": 542311621,
        "sender_full_name": "samuela",
        "timestamp": 1759247304
    },
    {
        "content": "<p>To be perfectly precise, <code>{_ : Foo}</code> arguments might also be filled in through other means, especially the expected type but that's the gist. Also worth noting is that the behavior of implicit arguments is equivalent to the behavior of the <code>_</code>/<code>(_)</code> term</p>",
        "id": 542318744,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759249233
    },
    {
        "content": "<p>ok i'm trying out a type class approach: <a href=\"https://live.lean-lang.org/#codez=HYQwtgpgzgDiDGEAEAZArmGBPAUDg9ALSFICCSALhMFAPYBOSARFABYgwRNICWUSIJABs+FJLQBmSUBTT0QQpABMekGj1o0ANEggA6AOZ6kAAwDaAJh0BmALomkEhgKQWAHtaRgQFejzfGhPg4IABGofQQAG5IAMrsnEgAXAC8qKJIAHI+eEQkAMK0mGhUlKzImRgACliEUBRYQsgRtCBK8CD1EEpIbBzIABQKPAbAPMAGjvRFZch+BqwUAJSBwTB+UT7IShBSLW0d9QBK0clxCciASYTn/UjX8f04SEgAPkhmtjpY/CkAfEjfJ6vJBuKA6D5IP4gqBAt5uZJJaFfBEAn7/bIUPTeeHwrAo/btToUE4xUGo3LEJAAIWmByJSEiUDQQjEfUSTkYFAA7rRehcwQIRKNxpMJNMwLMGSNFqscDs9rTCfUkAMoIBAgl6gCCCM4PThLHUXZIpIEDAmHYmndV6SJRCD0KDIKCa63RO0OlY2t0QCmEHAAFSwiXgQk6/Go8FoKgmZR8lB5fP6/BAkSy1VqZqJYSaehwNNaSooIsFIxoylU1CgGlLYpmFHKUoWYgGIgA1hU0ys8H7eQhWDxXQ3FoRhqM1BQdFzkDz6C2kFyeHWGa77d0E5woDmgjhg6HqYrzVnBuqtQb+vrEVVpjA5+VInhKTuoPw83T6oeAKIARzQCiOIGAs6qhqTqnnqZyXrQ15cre3o4JSACSNAUP+iD8Bye75geoRNCSKrTrOmhLraK49CI9RQEsODjG+wCILwSEvgWh6FGAEpmIxWFNL0wGarYZwcZm2GOtqx7QXasHUchtHIJJAlvkJfryKW7H7oJXHHk6fEqZhanCb0gDBBHxiJychQncQZN7iTgQA\">code</a> but i'm getting an error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">synthesization</span><span class=\"w\"> </span><span class=\"n\">order</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">instBroadcastableTrans</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"n\">s₃</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"n\">s₃</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₃</span>\n<span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">remaining</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">metavariables</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">s₂</span>\n<span class=\"w\">  </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"n\">s₃</span>\n</code></pre></div>\n<p>on what feels like an inoffensive instance. am i missing something? should type class resolution be able to handle this?</p>",
        "id": 542319698,
        "sender_full_name": "samuela",
        "timestamp": 1759249517
    },
    {
        "content": "<p>The problem is that Lean cannot guess <code>s₂</code> only looking at the goal.</p>",
        "id": 542320035,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1759249623
    },
    {
        "content": "<p>So this cannot be an instance: otherwise anytime Lean sees a goal of type <code>Broadcastable foo bar</code> it has to try <code>Broadcastable foo X</code> and <code>Broadcastable X bar</code> for all possible <code>X</code>, and it gets crazy.</p>",
        "id": 542320299,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1759249711
    },
    {
        "content": "<p>no dice with <a href=\"https://live.lean-lang.org/#codez=LQAggiAuCmB2DOB7ATiARPAFgQwA7TRAEt4RsQAbEyERAMxFm0gFdlsKQATIgWznhFECADQhoAOgDmEkAAMA2gCYxAZgC6ckHRRkQSgB6qQvZsiIHZwAPQAobACMHyaADcQAZRz4QALgC8IAAy1CAAcsy2ttbAoADCiLy4LDBQmNDhLLwACgCewPCQuRQZzojYXADG2IXQXCBYeBkAFBxEUrBEsFLayIlpGeZSmJAAlFZ2uOauzBlc0AxlFdWFAEpufp7eGYBJhFtNIHteTbYgIAA+IArqYrmk/gB8IHenFyAG8GLXII/v8K+XAx+Xx/W7A573J4RSASUxAoG5cFLKo1SDrdwfCFRGKgABCfWWqJALngLAoNEaPh0qEgAHdEA1tp8yFQOl0enQ+rwBsT2iMJrZ5osCSjCiBmvBAIEEDUAQQSbY74Uby7Z+fyvZrIlZojZSiQuVzQZDwDLwGV6tyG43jfWW6DY2K2AAquR8lQoNVIcEqiB43TSzCg9MZTVI2BcmRy+U1qMcJQktnx5VFkHZLPaCG4fAEQgznP6kHSvOGNGaVAA1hkwlk8uNbDZbG6PSBE4TCrHoABRACOLA4q2wsDL4qlsuVTSVIOyfVwIFp6Rcti6bdglQyS8gLeT7e7vYo/cHYSInBBm61257fYHQ++3znhrt64Hq+ICA3IrPDhKO8vg4SGeaQIgtCSoKKeMafp2F57lefwQuomxgW2EHftBg7ioBIIfEqAHgncSp3guj4rmur6IZA567vuZZ/vAQQLJAACM6GbMBVxkRRP5DpidzwSe77gV+UFUeKTG+Jh8DYRhEL4fOD6vk+JGFOxyFCVeNGrHyjHMUBzAgcpgmUTB3HwLxzb8UhBmcdp4nYaJIJ4bOslRI28CkAqnYGDAsBcKQErSqaY6KpsU6IDOBFycuz7ru5HaeXAPkAKqdEUgUeV5PkNJl4WLvJxEvoUMVxd58CxelqWlfFpC+XZDQyfeznuq5ZlJh+JTDv5cogu5E4gCFYVOURUWkeZ5EQYV6W+SOAVddsoyvAo42VQ00rQJK8ELdsFXFaO0Ayut+mQYZaGreIe1+K8B3LaO2VAA\">this route</a> either</p>",
        "id": 542321076,
        "sender_full_name": "samuela",
        "timestamp": 1759249946
    },
    {
        "content": "<p>mm i see, ok that makes sense</p>",
        "id": 542321138,
        "sender_full_name": "samuela",
        "timestamp": 1759249966
    },
    {
        "content": "<p>Note that it can be a <code>def</code> without any problem.</p>",
        "id": 542321264,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1759250006
    },
    {
        "content": "<p>hmm how would the def look? would that be compatible with getting broadcast type checking on the shapes when doing eg <code>x + y</code>?</p>",
        "id": 542321423,
        "sender_full_name": "samuela",
        "timestamp": 1759250057
    },
    {
        "content": "<p>Just write <code>def</code> instead of <code>instance</code>.</p>",
        "id": 542321520,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1759250093
    },
    {
        "content": "<p>Note that I am not really reading the code, just explaining the general error.</p>",
        "id": 542321581,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1759250110
    },
    {
        "content": "<p>Here's a basic version based on the original MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"sd\">/-- A tensor \"shape\" is a list of natural dimensions, e.g. `[2, 3]` for a 2x3 matrix. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"sd\">/-- Compute the NumPy-style broadcasted shape, assuming as a precondition that the inputs are safe to broadcast (aligning from the right). -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">broadcastRev</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shape</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">ys</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">broadcastRev</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span>\n\n<span class=\"sd\">/-- Broadcast result shape for two shapes, aligning from the right. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">broadcast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">broadcastRev</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"bp\">.</span><span class=\"n\">reverse</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">reverse</span>\n\n<span class=\"c1\">-- l₁.reverse ++ l₂</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">revAuxReducible</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l₁</span><span class=\"w\"> </span><span class=\"n\">l₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">l₁</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">l₂</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">revAuxReducible</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">l₂</span><span class=\"o\">)</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">revReducible</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">revAuxReducible</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">checkBinderAnnotations</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil_left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">ys</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">step_equal</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">      </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">step_left1</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">      </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">step_right1</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"o\">[</span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">      </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">nil_left</span><span class=\"w\"> </span><span class=\"n\">nil_right</span><span class=\"w\"> </span><span class=\"n\">step_equal</span><span class=\"w\"> </span><span class=\"n\">step_left1</span><span class=\"w\"> </span><span class=\"n\">step_right1</span>\n\n<span class=\"sd\">/-- Right-aligned broadcastability on the original (non-reversed) shapes. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">BroadcastableRev</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">revReducible</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">revReducible</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">An array carrying only its element type `α` and its static shape `shape`. We do</span>\n<span class=\"sd\">not model any runtime storage for now.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Dummy payload for now. Just playing around with types. -/</span>\n<span class=\"w\">  </span><span class=\"n\">tracer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Elementwise addition with NumPy-style broadcasting at the type level.</span>\n\n<span class=\"sd\">Requires a proof that the two shapes are broadcastable; the result shape</span>\n<span class=\"sd\">is the computed `broadcast s₁ s₂`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addBroadcast</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">broadcast</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">()</span><span class=\"bp\">⟩</span>\n\n<span class=\"sd\">/-- Support the generalized `+` notation via `HAdd`. -/</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">broadcast</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">addBroadcast</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">()</span><span class=\"bp\">⟩</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">()</span><span class=\"bp\">⟩</span>\n<span class=\"w\">        </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>(you can open it in Lean 4 Web using the button in the top-right corner of the code block)</p>",
        "id": 542323618,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759250749
    },
    {
        "content": "<p>woah very cool! checking it out now</p>",
        "id": 542346198,
        "sender_full_name": "samuela",
        "timestamp": 1759258119
    },
    {
        "content": "<p>ok, out of curiosity i tried making all of <code>broadcast</code> be abbrev, so that it would expand those things in the output types, but it doesn't seem to make a difference, eg Lean still reports the types of things as <code>Array Nat (broadcast [2, 3] [1, 1, 3])</code> instead of <code>Array Nat [1, 2, 3]</code> as I would expect. I'm curious why that is? is there a way to get it to elaborate those things? (<a href=\"https://live.lean-lang.org/#codez=HYQwtgpgzgDiDGEAEAxA9mgUJg9AWjyQEEkAXCYKNAJyQCIoALEGCOpASyiRCQBsupJGgBmSUKQCu1EHyQATDpEoc0lADRIIAOgDm2pAAMA2gCZNAZgC6hpCJo8kpgB4WkYEKWodnBvDkwQACMg6ggANyQAZWZWJAAuAF4kABlBJAA5T2x8QgBhNDAYSXIyRmQMyTAABQBPPChSWr5kULQQeXgQRoh5JCYWCE1uqCqOYF0ebl4YMPg1RVJVYDLPMuRx4tJpsP6QEWRSNCQ2jq7GpAAKWQ5dYHHJkWpC9aRvXUZSAEo/AODQiInZ5nbqkABKgPi0ViyEASYTQwZIeExQaYJBIAA+SGMVk0tW4iQAfEh8WjMUhnFBNDikESKVAyVjnAkoZS8SySQTiVlSNoPMzmbUOadOqCIZFKZzsAR+IBAgm0YXCEGoUGQAGo1fxAEEEgRCireESIkmcEPkkngHCCLSufFl2oSqXSgEbgL4OtIXJ0JRJkjykeCMOVIADuHFIjEZ2KstOJfB16KxvHiULkdMVRpNvXNlutcmuHNjX2w/31itNWatyEucih7qELrdzq9BvC6bLFor/EjORlACFgaKLmFRnwhAM4vZaKQg8cx9BhgI7g87M8wK93p9frqAZERechJcoHaoFqHSjWK6oWfkEkyaXM+3rZdd2LAZc72aH8hD663xE29mvy1L5C0wVVSAAfTQGAljUJB/QgeAAGse3GeRlSIYBgDQUhPGWbgRFkVVOGATB4D4EZiI/JYlSQPt2gHHCK3FU8YSRBE4nhapnhgYNyjCCN7j4cCWhEfd8QvWj+z3YIWmYmlSXjcQOCE9d90pCS6JBRoZIgZjJRxCMehgcCIAAR0kWQkAAbwFbh8QAXzJdF0WMTSGJ0vS7KgKN4ic5y3OkpjX2ZJN6R/EKoXEwzyGMkTSAARmsyV8RJRznOc1ypNBDzAWS7yEj89EAuyoLIkuRLQvUq4hVCqLFKM8DVMSmyvIpNL0uxYrtNK+lOR8wrJPowLZOCjkqvKjkoswKCKEGrTGJGyJxkCUgvEtEpkGMcZtOARAo0E4SIFEpSVNuT5+hikzzMshq4sShqmu7QgwTO0g8BuO5eiBIaSuU0MhVgsNkBoW5xksy4sOAPBFWVVV5FdWcoE3YtAS6hbK0PfoT0vGEJK4qCvTJNGcrK99y2tb8rjJz8sZA3JMAwnhqBkIUumZ2olzUPghVDbgIBaZQhCaOJDCdWwQGAPpeYu3D4H6VjDFnQwDAAdWQeQsCwoQwDQNC5AloVqEkYAlkgC6aBAXRkAncQ0CDbRMH8UCvHNKRdiIZmQCFS5PShAAVWpzyuWcWMGCSA7iIM+IgJ7MAAUQFigpy4ZAOkWZZg1DANKhqepGmaVossaJc1iBshA+QFolT4B3MAhcyOCHRxZgwMQw1L8oyGneXBh2Qufu6loAG412gSQRx71hMC4V55iKDa+kMZ8Lkx49lcdgI0LENO0es32kAjiB7Os1fsfYo/OqL9H+iPLV+vRD2WaQT1MfhR+vefrG2PfoVPSfK+b600JuiEQxskDgXAdGJAgAL8kAJfkT1oiSBgDAGgQtO5W2AMqG4AAvL6hg1S2C1rhWC4QOC8EMAACSIPIeQyskBO22jhXayArL70PsfKyp9Q6sGPplAe19T732clQmhVwf6f0ppccRL8gJiM9r/K4y9Ry32ArxZUMd0SMGoX0JIPAaFo2wAAYngkhG0EAhAhWIPIzIawzCWB8skOBA10QtCEDVKxT8eTYnMEgawTYnEdWcq4yBujmSalqCPS4wEjEmMQmYixDpxFeOMBYex/j4GBJceYkkiTrHJPipoApviHEwIyZk4JEDQlIHCZE6JQA\">code</a>)</p>",
        "id": 542350457,
        "sender_full_name": "samuela",
        "timestamp": 1759259768
    },
    {
        "content": "<p><code>abbrev</code> does not literally mean \"abbreviation\" in the sense of macros. It just means that in the majority of cases, tactics and term elaborators can look through the abbreviation as if it wasn't there (even if it is there!). You can achieve your idea by instead \"encoding\" <code>broadcast</code> in <code>Broadcastable</code>. The way to do is so called <code>outParam</code>s which get filled in during instance synthesis:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">checkBinderAnnotations</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">xs</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">step_equal</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">step_left1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">step_right1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">checkBinderAnnotations</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">BroadcastableLeft</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">of_same_size</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableLeft</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">skip_left</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableLeft</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableLeft</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">checkBinderAnnotations</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRight</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">of_same_size</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRight</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">skip_right</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableRight</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRight</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">checkBinderAnnotations</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">of_same_size</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">skip_left</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableLeft</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">skip_right</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BroadcastableRight</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">ys</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">zs</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"n\">of_same_size</span><span class=\"w\"> </span><span class=\"n\">BroadcastableLeft</span><span class=\"bp\">.</span><span class=\"n\">of_same_size</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRight</span><span class=\"bp\">.</span><span class=\"n\">of_same_size</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">BroadcastableSameSize</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">step_equal</span><span class=\"w\"> </span><span class=\"n\">step_left1</span><span class=\"w\"> </span><span class=\"n\">step_right1</span><span class=\"w\"> </span><span class=\"n\">skip_left</span><span class=\"w\"> </span><span class=\"n\">skip_right</span><span class=\"w\"> </span><span class=\"n\">BroadcastableLeft</span><span class=\"bp\">.</span><span class=\"n\">skip_left</span><span class=\"w\"> </span><span class=\"n\">BroadcastableRight</span><span class=\"bp\">.</span><span class=\"n\">skip_right</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">shape</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">tracer</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">addBroadcast</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"n\">s₃</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Shape</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"n\">s₃</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₃</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">()</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Broadcastable</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"n\">s₃</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">s₃</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">addBroadcast</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">()</span><span class=\"bp\">⟩</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">()</span><span class=\"bp\">⟩</span>\n<span class=\"w\">        </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 542355936,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759261814
    },
    {
        "content": "<p>(there's probably a better way to express the condition that doesn't require 4 typeclasses...)</p>",
        "id": 542356029,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759261859
    },
    {
        "content": "<p>ooh nice! ok i was not aware of outParam. i will check it out</p>",
        "id": 542657594,
        "sender_full_name": "samuela",
        "timestamp": 1759383519
    }
]