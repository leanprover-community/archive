[
    {
        "content": "<p>Hi all,</p>\n<p>I’m using Lean to model parts of a software system. I have stateful components with specifications that describe how they relate to each other, and each component has state-transforming actions with pre- and postconditions to describe their intended behavior - though these pre/postconditions won’t necessarily be proven within Lean itself.</p>\n<p>What I’d like to do is serialize these specifications (including the Prop-valued pre/post conditions) so that they can be exported - for example, as JSON - and potentially used in an external tool or even as input to an LLM for refinement.</p>\n<p>Here’s a simplified version and example of what one of what these definitions looks like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Action</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\">           </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"n\">argTypes</span><span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span>\n<span class=\"w\">  </span><span class=\"n\">retTipe</span><span class=\"w\">        </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tipe</span>\n<span class=\"w\">  </span><span class=\"n\">stateTypes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Signature</span>\n<span class=\"w\">  </span><span class=\"n\">pre</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"w\"> </span><span class=\"n\">argTypes</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"w\"> </span><span class=\"n\">stateTypes</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n<span class=\"w\">  </span><span class=\"n\">post</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"n\">st'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"w\"> </span><span class=\"n\">stateTypes</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"w\"> </span><span class=\"n\">argTypes</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">interpTipe</span><span class=\"w\"> </span><span class=\"n\">retTipe</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">turnOn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Action</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"turnOn\"</span>\n<span class=\"w\">  </span><span class=\"n\">argTypes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Signature</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">  </span><span class=\"n\">retTipe</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Tipe</span><span class=\"bp\">.</span><span class=\"n\">unit</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Assume the action’s state includes two boolean fields:</span>\n<span class=\"w\">  </span><span class=\"c1\">--   isOn      : Tipe.bool</span>\n<span class=\"w\">  </span><span class=\"c1\">--   isPowered : Tipe.bool</span>\n<span class=\"w\">  </span><span class=\"n\">stateTypes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stateSpace</span>\n<span class=\"w\">  </span><span class=\"n\">pre</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"c1\">-- st is the input state, st' is the output state</span>\n<span class=\"w\">  </span><span class=\"n\">post</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"n\">st'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">st'</span><span class=\"w\"> </span><span class=\"n\">stateSpace</span><span class=\"bp\">.</span><span class=\"n\">isOn</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">∧</span>\n<span class=\"w\">    </span><span class=\"n\">st'</span><span class=\"w\"> </span><span class=\"n\">stateSpace</span><span class=\"bp\">.</span><span class=\"n\">isPowered</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">st</span><span class=\"w\"> </span><span class=\"n\">stateSpace</span><span class=\"bp\">.</span><span class=\"n\">isPowered</span>\n<span class=\"o\">}</span>\n</code></pre></div>\n<p>As far as I understand, types and proofs don’t have runtime representations, so I’d probably need to use meta-programming to extract these Prop fields.</p>\n<p>Has anyone done something similar or can suggest how/if we can serialize <code>Prop</code> fields like this?</p>\n<p>Thanks!<br>\nNick</p>",
        "id": 543356559,
        "sender_full_name": "Nicholas Phair",
        "timestamp": 1759766149
    },
    {
        "content": "<p>Why do these conditions need to be <code>Prop</code></p>",
        "id": 543366899,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759769498
    },
    {
        "content": "<p>In this example they may not need to be. We have a version that avoids them. But in the general case I think it would be useful to be able to dump some representation of a <code>Prop</code>. It would be good context to a human, or llm, who may want to generate code for this.</p>",
        "id": 543368488,
        "sender_full_name": "Nicholas Phair",
        "timestamp": 1759770082
    },
    {
        "content": "<p>then you can't do it at runtime since they have no runtime representation</p>",
        "id": 543368715,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759770168
    },
    {
        "content": "<p>and <code>Prop</code>s don't really have a \"normal form\" either so if I give you a <code>Prop</code> how do you decide how to print it</p>",
        "id": 543369440,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759770354
    },
    {
        "content": "<p>I see, I thought that might be the case, thank you. </p>\n<p>I suppose you might you be able to get something printable using <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/PrettyPrinter.html#Lean.PrettyPrinter.ppExpr\">Lean.PrettyPrinter.ppExpr</a>. There would be constraints here (e.g., the expression would have to be constant).</p>",
        "id": 543372406,
        "sender_full_name": "Nicholas Phair",
        "timestamp": 1759771463
    },
    {
        "content": "<p>And without a clear \"normal form\" the output would vary a lot.</p>",
        "id": 543372612,
        "sender_full_name": "Nicholas Phair",
        "timestamp": 1759771529
    }
]