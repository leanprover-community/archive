[
    {
        "content": "<p>If in the following i replace <code>abbrev</code> by <code>def</code> the rule <code>Sym2.eq</code> doesn't apply any more<br>\n (leaving constructors <code>s( , )</code>), although it looks to me, as if the types exactly check out? rw works</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Sym</span><span class=\"bp\">.</span><span class=\"n\">Sym2</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"bp\">.</span><span class=\"n\">subst</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">(</span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Sym2</span><span class=\"bp\">.</span><span class=\"n\">rel_iff'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"bp\">.</span><span class=\"n\">eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"bp\">.</span><span class=\"n\">injEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">swap_prod_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"k\">forall</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">--generated by simp_all</span>\n<span class=\"w\">    </span><span class=\"n\">grind</span>\n<span class=\"w\">  </span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 563498502,
        "sender_full_name": "Moritz R",
        "timestamp": 1765552688
    },
    {
        "content": "<p><code>simp</code> only looks through <code>abbrev</code>s and not <code>def</code>s so when it finds an <code>(a : Atom) = b</code> (<code>@Eq Atom a b</code>) it doesn't match <code>(_ : Sym2 _) = _</code> (<code>@Eq (Sym2 _) _ _</code>) and doesn't try to apply the <code>Sym2.eq</code> theorem (which matches on the type to be <code>Sym2 _</code>).</p>",
        "id": 563515289,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1765556925
    },
    {
        "content": "<p>Yes, but the hover info in the infoview on the <code>s( , )</code> shows me that it's seen as a <a href=\"http://Sym2.mk\">Sym2.mk</a>, so it should apply?</p>",
        "id": 563515747,
        "sender_full_name": "Moritz R",
        "timestamp": 1765557036
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/VpQGWq_c39lTe-kRPDtFvnMV/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/VpQGWq_c39lTe-kRPDtFvnMV/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1160x886\" src=\"/user_uploads/thumbnail/3121/VpQGWq_c39lTe-kRPDtFvnMV/image.png/840x560.webp\"></a></div>",
        "id": 563515971,
        "sender_full_name": "Moritz R",
        "timestamp": 1765557091
    },
    {
        "content": "<p>Well, if you hover over the equality though you'll see:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">Eq</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">(</span><span class=\"n\">a_1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b_1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n</code></pre></div>\n<p>so the type <code>Atom</code> doesn't match <code>Sym2 _</code> which <code>simp</code> expects.</p>",
        "id": 563516153,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1765557137
    },
    {
        "content": "<p>uffff</p>",
        "id": 563516462,
        "sender_full_name": "Moritz R",
        "timestamp": 1765557217
    },
    {
        "content": "<p>thank you!</p>",
        "id": 563516478,
        "sender_full_name": "Moritz R",
        "timestamp": 1765557221
    },
    {
        "content": "<p>But i still don't get, how do i need to formulate my replacement lemma?<br>\nThis doesn't work.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Sym2</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Sym2</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">p'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"bp\">.</span><span class=\"n\">Rel</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">p'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>",
        "id": 563518353,
        "sender_full_name": "Moritz R",
        "timestamp": 1765557818
    },
    {
        "content": "<p>In general, don't use operations through a <code>def</code>, that's called defeq abuse and it will give you a ton of trouble. There are two options to solve this though:</p>\n<ol>\n<li>one-field structure: instead of using <code>def</code>, wrap the type in a structure with one field:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Sym</span><span class=\"bp\">.</span><span class=\"n\">Sym2</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toSym2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"bp\">.</span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">s</span><span class=\"o\">(</span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">)</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">toSym2</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>add API: write two functions to convert between both types:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Sym</span><span class=\"bp\">.</span><span class=\"n\">Sym2</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"bp\">.</span><span class=\"n\">ofSym2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"bp\">.</span><span class=\"n\">toSym2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"bp\">.</span><span class=\"n\">ofSym2</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"bp\">.</span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Atom</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofSym2</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">(</span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">toSym2</span>\n</code></pre></div>",
        "id": 563518420,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1765557842
    }
]