[
    {
        "content": "<p>So apparently I have simp recursion somewhere.</p>\n<p><a href=\"/user_uploads/3121/W1K15H2YPT4crqhvUI83XyEw/Screenshot-2025-08-06-at-15.40.35.png\">Screenshot 2025-08-06 at 15.40.35.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/W1K15H2YPT4crqhvUI83XyEw/Screenshot-2025-08-06-at-15.40.35.png\" title=\"Screenshot 2025-08-06 at 15.40.35.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1762x710\" src=\"/user_uploads/thumbnail/3121/W1K15H2YPT4crqhvUI83XyEw/Screenshot-2025-08-06-at-15.40.35.png/840x560.webp\"></a></div><p>Lean suggests two things:</p>\n<ul>\n<li>use <code>set_option maxRecDepth &lt;num&gt;</code> to increase limit</li>\n<li>use <code>set_option diagnostics true</code> to get diagnostic information</li>\n</ul>\n<p>Both of these suggestions appear to be completely useless.</p>\n<p>The first one is useless because I actually have an infinite recursion (and so increasing the limit actually crashes the server).</p>\n<p>The second one seems to be useless because the information it output doesn't seem to shed light on the recursion cause:</p>\n<p><a href=\"/user_uploads/3121/8cDJJz1UNBfD-MbTiMZDp6TI/Screenshot-2025-08-06-at-15.43.01.png\">Screenshot 2025-08-06 at 15.43.01.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/8cDJJz1UNBfD-MbTiMZDp6TI/Screenshot-2025-08-06-at-15.43.01.png\" title=\"Screenshot 2025-08-06 at 15.43.01.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1812x768\" src=\"/user_uploads/thumbnail/3121/8cDJJz1UNBfD-MbTiMZDp6TI/Screenshot-2025-08-06-at-15.43.01.png/840x560.webp\"></a></div><p>Of course I have no idea what <code>_uniq.121567 ↦ 54</code> means.</p>\n<p>As a result, I have two questions:</p>\n<ul>\n<li>How to debug this properly?</li>\n<li>Why isn't the debug pragma suggested by Lean actually useful in this case?</li>\n</ul>\n<p>What I would have <em>expected</em> to see if some kind of runaway recursive stack which would tell me which <code>@[simp]</code> lemmas are going in circles.</p>",
        "id": 533119132,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754491482
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418569\">@Dan Abramov</span> in the second screenshot, hover over <code>_uniq.121567</code> and take another screenshot</p>",
        "id": 533119411,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754491566
    },
    {
        "content": "<p>Alas, nothing happens on hover..</p>",
        "id": 533119448,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754491582
    },
    {
        "content": "<p>can you move the <code>set_option</code> before the theorem</p>",
        "id": 533119574,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754491626
    },
    {
        "content": "<p>also, click instead of hover</p>",
        "id": 533119666,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754491650
    },
    {
        "content": "<p>Same, neither clicking nor hover works.</p>\n<p><a href=\"/user_uploads/3121/y-H_iLlunOOVAAlKxbWljDkv/Screenshot-2025-08-06-at-15.47.29.png\">Screenshot 2025-08-06 at 15.47.29.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/y-H_iLlunOOVAAlKxbWljDkv/Screenshot-2025-08-06-at-15.47.29.png\" title=\"Screenshot 2025-08-06 at 15.47.29.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1714x804\" src=\"/user_uploads/thumbnail/3121/y-H_iLlunOOVAAlKxbWljDkv/Screenshot-2025-08-06-at-15.47.29.png/840x560.webp\"></a></div>",
        "id": 533119729,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754491670
    },
    {
        "content": "<p>what does it say when you hover on <code>ht</code></p>",
        "id": 533120306,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754491847
    },
    {
        "content": "<p>Definition:</p>\n<p><a href=\"/user_uploads/3121/gXnsskDBtmvlQPKeiMso36FP/Screenshot-2025-08-06-at-15.51.12.png\">Screenshot 2025-08-06 at 15.51.12.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/gXnsskDBtmvlQPKeiMso36FP/Screenshot-2025-08-06-at-15.51.12.png\" title=\"Screenshot 2025-08-06 at 15.51.12.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"816x274\" src=\"/user_uploads/thumbnail/3121/gXnsskDBtmvlQPKeiMso36FP/Screenshot-2025-08-06-at-15.51.12.png/840x560.webp\"></a></div><p>Usage:</p>\n<p><a href=\"/user_uploads/3121/odJKYxPlRn9VrF2JFFhvBbYy/Screenshot-2025-08-06-at-15.51.04.png\">Screenshot 2025-08-06 at 15.51.04.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/odJKYxPlRn9VrF2JFFhvBbYy/Screenshot-2025-08-06-at-15.51.04.png\" title=\"Screenshot 2025-08-06 at 15.51.04.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1654x656\" src=\"/user_uploads/thumbnail/3121/odJKYxPlRn9VrF2JFFhvBbYy/Screenshot-2025-08-06-at-15.51.04.png/840x560.webp\"></a></div>",
        "id": 533120457,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754491893
    },
    {
        "content": "<p>FWIW I did end up solving the actual exercise, seems like plain <code>rw [ht]</code> started working after I got rid of <code>dsimp</code>s</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">left_inv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mem_iProd</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">property</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose_spec</span>\n<span class=\"w\">    </span><span class=\"n\">ext</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ht</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Still not sure why <code>simp_rw [ht]</code> recurses though.</p>",
        "id": 533120684,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754491955
    },
    {
        "content": "<p>Ohhh is <code>54</code> here the recursion limit?</p>",
        "id": 533123735,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754492904
    },
    {
        "content": "<p>Like, \"how many times it got unfolded?\"?</p>",
        "id": 533123781,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754492918
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418569\">@Dan Abramov</span> <code>simp_rw</code> does not call other lemmas, so <code>simp_rw [ht]</code> just means <code>rw [ht]</code> for as many times as possible, so try <code>rw [ht, ht]</code> and see what happens</p>",
        "id": 533125153,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754493310
    },
    {
        "content": "<p>it's actually <code>simp only; simp only [ht]</code></p>",
        "id": 533125305,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754493371
    },
    {
        "content": "<p>Hmm, if I repeat the rewrite, it fails pretty early:</p>\n<p><a href=\"/user_uploads/3121/2yRfRjYF84eERkk68Quchw2R/Screenshot-2025-08-06-at-16.16.53.png\">Screenshot 2025-08-06 at 16.16.53.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/2yRfRjYF84eERkk68Quchw2R/Screenshot-2025-08-06-at-16.16.53.png\" title=\"Screenshot 2025-08-06 at 16.16.53.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2302x704\" src=\"/user_uploads/thumbnail/3121/2yRfRjYF84eERkk68Quchw2R/Screenshot-2025-08-06-at-16.16.53.png/840x560.webp\"></a></div><p>However, <code>simp_rw [ht]</code> in the same spot recurses.</p>",
        "id": 533125519,
        "sender_full_name": "Dan Abramov",
        "timestamp": 1754493448
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"418569\">@Dan Abramov</span> right, it fails because of \"motive is not type correct\", which means that theoretically it can still rewrite</p>",
        "id": 533125703,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754493509
    },
    {
        "content": "<p>note that as usual <code>rw</code> fails under the binder, and <code>simp_rw</code> can rewrite under the binder</p>",
        "id": 533125744,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754493525
    },
    {
        "content": "<p>so <code>simp_rw</code> is slightly stronger than <code>rw</code></p>",
        "id": 533125760,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754493529
    },
    {
        "content": "<p>my guess is that it’s because t appears in h</p>",
        "id": 533167715,
        "sender_full_name": "Lawrence Wu (llllvvuu)",
        "timestamp": 1754508760
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">rewrite</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ht</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 533168348,
        "sender_full_name": "Lawrence Wu (llllvvuu)",
        "timestamp": 1754509026
    },
    {
        "content": "<p>My guess is that to improve this error message would involve catching it in <code>simp</code> and re-throwing a <code>simp</code>-specific error message. The current error is probably a generic stack overflow error that bubbles up.</p>",
        "id": 533168577,
        "sender_full_name": "Lawrence Wu (llllvvuu)",
        "timestamp": 1754509125
    },
    {
        "content": "<p>You can debug using <code>+singlePass</code> which should prevent repeated application. You'll see:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">singlePass</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ht</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ (⋯ : ∃ a, h.choose = a).choose = h.choose</span>\n</code></pre></div>\n<p>so yeah it rewrites <code>t</code> in <code>h</code>.</p>",
        "id": 533169329,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754509466
    },
    {
        "content": "<p>I also found <a href=\"https://github.com/leanprover/lean4/pull/8865\">lean4#8865</a> but it doesn't seem to work here</p>",
        "id": 533169525,
        "sender_full_name": "Lawrence Wu (llllvvuu)",
        "timestamp": 1754509556
    },
    {
        "content": "<p>Yeah it should activate automatically but maybe it doesn't detect rewrites using local hypotheses?</p>",
        "id": 533170166,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754509821
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> I think in the ideal case I would be able to pass in the number 10 to simp and it will simplify ht exactly 10 times, and then it will be clear to anyone what is going on</p>",
        "id": 533174910,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754512195
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ht</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">iterate</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">singlePass</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ht</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I guess</p>",
        "id": 533175123,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754512276
    },
    {
        "content": "<p>Although that won't say \"simplify using <code>ht</code> exactly 10 times\" but rather \"simplify using <code>ht</code> only 10 times <em>recursively</em>\"</p>",
        "id": 533175376,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754512379
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> but do you think that would be a useful feature to add?</p>",
        "id": 533177947,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754513662
    },
    {
        "content": "<p>I'm not sure; I'd think <code>singlePass</code> already covers most of the cases</p>",
        "id": 533178035,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754513718
    }
]