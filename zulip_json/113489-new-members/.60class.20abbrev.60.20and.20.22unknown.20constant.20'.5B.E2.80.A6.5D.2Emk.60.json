[
    {
        "content": "<p>The following fails with \"unknown constant 'IntegrallyClosedDomain\\.mk'\".</p>\n<p>What am I doing wrong, and how can I fix it?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegrallyClosed</span><span class=\"w\"> </span><span class=\"n\">P</span>\n</code></pre></div>\n<p>Note that <code>class abbrev IntegralDomain (P : Type*) := CommRing P, IsDomain P</code> works as expected without any issues.</p>\n<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegralDomain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntegralDomain</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegrallyClosed</span><span class=\"w\"> </span><span class=\"n\">P</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n</code></pre></div>",
        "id": 471546034,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1726772023
    },
    {
        "content": "<p>Read the other error message, which is comprehensible and the cause of the obscure one :-)</p>",
        "id": 471547756,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726772822
    },
    {
        "content": "<p>Wait what -- that error message is also weird. Maybe the syntax is not supported for two commas?</p>",
        "id": 471547957,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726772908
    },
    {
        "content": "<p>Oh, it's because of the <code>abbrev</code>s I think. Hang on.</p>",
        "id": 471548133,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726772998
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsDomain</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FractionRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntegrallyClosedDomain</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>Yeah, the <code>class abbrev</code> set-up was not seeing through other <code>abbrev</code>s -- the error said \"you're not a structure\" but if you keep unfolding the definitions you find that it's an abbrev of a structure so you just replace it with the full name.</p>",
        "id": 471548539,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726773170
    },
    {
        "content": "<p>Aah, and that explains the first message: if X is a structure then <code>X.mk</code> is expected to exist and be the constructor for that structure. But the abbrev didn't have a .mk method (and annoyingly, <code>def IsIntegrallyClosed.mk (R : Type*) [CommRing R] := IsIntegralClosure.mk (A := R) (R := R) (B := FractionRing R)</code> didn't fix it :-) )</p>",
        "id": 471549655,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726773681
    },
    {
        "content": "<p>Thanks! I think I understand now. So the reason I'm getting this error message is because <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/RingTheory/IntegralClosure/IntegrallyClosed.lean#L59-L69\">the referenced <code>IsIntegralClosure</code></a> is implemented as an <code>abbrev</code>?</p>\n<p>Is this intentional and the expected behavior, or is it something that could be adjusted? As a beginner, I would have assumed that I could interact with <code>IsIntegralClosure</code> in the same way I would with something like <code>IsDomain</code>, without needing to worry about the underlying implementation details. But I might be overlooking something more nuanced here.</p>",
        "id": 471551623,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1726774490
    },
    {
        "content": "<p>Would the solution be to provide an <code>IsIntegrallyClosed.mk</code> specifically for this case, or could it be addressed globally by \"automatically\" generating a <code>[…].mk</code> for simple <code>abbrev</code> cases like this? I wonder if there might be potential issues with taking such a broad approach?</p>",
        "id": 471552085,
        "sender_full_name": "Isak Colboubrani",
        "timestamp": 1726774697
    },
    {
        "content": "<p>2 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/stream/113489-new-members/topic/.22could.20not.20create.20link.22.20error.20installing.20on.20window\">#new members &gt; \"could not create link\" error installing on window</a> by <span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span>.</p>",
        "id": 471557770,
        "sender_full_name": "Notification Bot",
        "timestamp": 1726777351
    },
    {
        "content": "<p>I tried defining the .mk but it wasn't enough to fix it. I guess you could ask in <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/stream/270676-lean4\">#lean4</a> about this.</p>",
        "id": 471673652,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726824167
    }
]