[
    {
        "content": "<p>I'm defining a class <code>PositionRecorder</code> representing a type with a distinguished element (<code>empty</code>) and an operation to update a value (<code>record</code>). My first attempt resulted in <code>empty</code> inheriting an explicit argument of the class, which I'd like to avoid. However, on the second attempt, <code>PositionRecorder.empty</code> is in a weird state where it exists and doesn't exist at the same time.<br>\nDoes anyone have any idea what's going on (and how to properly define it)?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Pos</span><span class=\"o\">)</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">One</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PositionRecorder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"c1\">-- For some reason, empty requires (s : String)</span>\n<span class=\"c1\">-- one.PositionRecorder.empty (s : String) {α : Type} [self : PositionRecorder s α] : α</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">PositionRecorder</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">One</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Two</span>\n\n<span class=\"c1\">-- For some reason, putting `empty` in `PositionRecorder` makes `empty` require `s` as an argument.</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">WithEmpty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PositionRecorder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">WithEmpty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"c1\">-- empty doesn't exist: \"Unknown constant `two.PositionRecorder.empty`\"</span>\n<span class=\"c1\">-- #check PositionRecorder.empty</span>\n\n<span class=\"c1\">-- Yet we cannot define it: \"invalid declaration name `two.PositionRecorder.empty`, structure `two.PositionRecorder` has field `empty`\"</span>\n<span class=\"c1\">-- def PositionRecorder.empty {s : String} {α : Type} [inst : PositionRecorder s α] := inst.empty</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Two</span>\n\n<span class=\"c1\">-- Example implementations</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">historyAccumulatorInst</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">One</span><span class=\"bp\">.</span><span class=\"n\">PositionRecorder</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">idx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">overwriteInst</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">One</span><span class=\"bp\">.</span><span class=\"n\">PositionRecorder</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"bp\">.</span><span class=\"n\">replicate</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ps</span><span class=\"bp\">.</span><span class=\"n\">setIfInBounds</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>",
        "id": 564052991,
        "sender_full_name": "pandaman",
        "timestamp": 1765894776
    },
    {
        "content": "<p>Wrt to getting <code>WithEmpty</code> in <code>Two</code>, you can access it via <code>#check PositionRecorder.toWithEmpty</code>.  Adding <code>to</code> is what tends to happen.</p>",
        "id": 564054097,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1765895075
    },
    {
        "content": "<p>Yes, we can access <code>WithEmpty</code>, but I'm more interested in accessing <code>empty</code> directly. In other words, my question is about the differences between these two:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Two</span>\n\n<span class=\"c1\">-- For some reason, putting `empty` in `PositionRecorder` makes `empty` require `s` as an argument.</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">WithEmpty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PositionRecorder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">WithEmpty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"c1\">-- empty doesn't exist: \"Unknown constant `two.PositionRecorder.empty`\"</span>\n<span class=\"c1\">-- #check PositionRecorder.empty</span>\n\n<span class=\"c1\">-- Yet we cannot define it: \"invalid declaration name `two.PositionRecorder.empty`, structure `two.PositionRecorder` has field `empty`\"</span>\n<span class=\"c1\">-- def PositionRecorder.empty {s : String} {α : Type} [inst : PositionRecorder s α] := inst.empty</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Two</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Three</span>\n\n<span class=\"c1\">-- No dependency on (s : String)</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PositionRecorder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"c1\">-- PositionRecorder.empty exists as expected</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">PositionRecorder</span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Three</span>\n</code></pre></div>",
        "id": 564055446,
        "sender_full_name": "pandaman",
        "timestamp": 1765895431
    },
    {
        "content": "<p>you can access it through <code>WithEmpty.empty</code></p>",
        "id": 564123801,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765915453
    }
]