[
    {
        "content": "<p>I would like to use a newline as a delimiter in a syntax / macro_rule pair, but am having trouble figuring out to enter newline into the syntax rules.</p>\n<p>Here's a very artificial MWE.</p>\n<ol>\n<li>Without any delimiter between $t1 and \"{\", the parser can't detect the end of $t1.</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"c1\">--                               ^ unexpected token ')'; expected '{'</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>Using \";\" as a delimiter is successful:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"foo2\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\";\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">foo2</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"o\">)</span>\n<span class=\"c1\">-- this works, but I'd prefer a newline rather than \";\"</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>Some attempts to use a newline instead of \";\"</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"foo3\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"c1\">-- invalid parser '«termFoo3_{_}»', invalid empty symbol</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"foo4\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">'\\</span><span class=\"n\">n'</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"c1\">--            ^ unexpected token; expected ':'</span>\n<span class=\"w\"> </span><span class=\"bp\">```</span>\n\n<span class=\"bp\">-</span><span class=\"n\">mark</span>\n</code></pre></div>",
        "id": 475035567,
        "sender_full_name": "Mark Aagaard",
        "timestamp": 1728175782
    },
    {
        "content": "<p>the problem with (1) is that <code>t1 {t2}</code> is already syntax for a <code>term</code>, namely <code>t1</code> is a function and it is being applied to <code>{t2}</code> which is a set with one element <code>t2</code></p>",
        "id": 475064880,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728196822
    },
    {
        "content": "<p>so lean parses the whole thing as a <code>term</code> and then says it's still waiting to see a <code>{</code></p>",
        "id": 475064889,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728196850
    },
    {
        "content": "<p>if you want to block this parse you have to raise the precedence of the first term higher than application</p>",
        "id": 475064908,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728196881
    },
    {
        "content": "<p>e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"foo\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>",
        "id": 475064913,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728196890
    },
    {
        "content": "<p>You can't use <code>\"\\n\"</code> directly as a token because it's whitespace, but there is a <code>linebreak</code> parser you can use there instead</p>",
        "id": 475065066,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728197055
    },
    {
        "content": "<p>it has a similar issue with precedence though. Here's a working version combining both things:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"foo4\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"n\">linebreak</span><span class=\"w\"> </span><span class=\"s2\">\"{\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"}\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"n\">foo4</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"o\">:</span><span class=\"n\">term</span>\n<span class=\"w\">            </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 475065151,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1728197163
    },
    {
        "content": "<p>Thanks, Mario.  Your answer makes sense.  I'm working on getting your solutions to work in my actual code.  My MWE might have been too minimal.<br>\n-mark</p>",
        "id": 475102261,
        "sender_full_name": "Mark Aagaard",
        "timestamp": 1728223416
    },
    {
        "content": "<p>Mario,</p>\n<p>Thanks for the info.  I was able to use your suggestion and found the right place to insert :max to get the effect I want.</p>\n<p>-mark</p>",
        "id": 475660555,
        "sender_full_name": "Mark Aagaard",
        "timestamp": 1728418027
    }
]