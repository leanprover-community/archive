[
    {
        "content": "<p>I'm trying to prove a <code>LawfulBEq</code> instance for <code>Std.HashSet</code> using the <code>BEq</code> instance defined in <code>Batteries.Lean.HashSet</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HashSet</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">beq</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s.all</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t.contains</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">t.all</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s.contains</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This checks element-wise equality. For <code>LawfulBEq</code>, I need to prove reflexivity and soundness. I've managed to prove reflexivity:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span><span class=\"w\"> </span><span class=\"n\">LocSet.beq_refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocSet</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BEq.beq</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>However, I'm stuck on soundness:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">theorem</span><span class=\"w\"> </span><span class=\"n\">sound</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std.HashSet</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>The <code>BEq</code> definition establishes that <code>a</code> and <code>b</code> contain the same elements, but I cannot find a lemma in <code>Std.Data.HashSet.Lemmas</code> that would let me conclude propositional equality from this.</p>\n<p>I need a set of natural numbers that I can use both in executable code and in proofs. I tried <code>Finset</code> but its noncomputability was propagating up to <code>main</code>, making it difficult to prove things about executable code in the IO monad. I also tried <code>Std.ExtHashSet</code> but it is missing operations I need (e.g., <code>fold</code>, <code>toList</code>).</p>\n<p><strong>Questions:</strong></p>\n<ol>\n<li>Is this provable at all? I suspect two HashSets with the same elements might have different internal representations (e.g., different bucket structures), which propositional equality would distinguish.</li>\n<li>If not, is the Batteries <code>BEq</code> instance intended to be used with <code>LawfulBEq</code>, or should I define a different <code>BEq</code> based on structural equality?</li>\n<li>Is there another set implementation I could use that supports both executable operations (<code>fold</code>, <code>toList</code>, etc.) and has <code>LawfulBEq</code>/<code>DecidableEq</code>?</li>\n</ol>\n<p>I'm using Lean 4.25.2.</p>",
        "id": 563316577,
        "sender_full_name": "Vadim Zaliva",
        "timestamp": 1765508236
    },
    {
        "content": "<p>I don't think it is lawfulbeq</p>",
        "id": 563316616,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508282
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> \"hashset\", \"equiv\"</p>",
        "id": 563316628,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508302
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Std/Data/HashSet/Basic.html#Std.HashSet.Equiv\">Std.HashSet.Equiv</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Std/Data/HashSet/Basic.html#Std.HashSet.Equiv.inner\">Std.HashSet.Equiv.inner</a>, and <a href=\"https://loogle.lean-lang.org/?q=%22hashset%22%2C%20%22equiv%22\">73 more</a></p>",
        "id": 563316629,
        "sender_full_name": "loogle",
        "timestamp": 1765508303
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"936172\">Vadim Zaliva</span> <a href=\"#narrow/channel/113489-new-members/topic/Proving.20.60LawfulBEq.60.20for.20.60Std.2EHashSet.60.20with.20Batter/near/563316577\">said</a>:</p>\n<blockquote>\n<p>I also tried <code>Std.ExtHashSet</code> but it is missing operations I need (e.g., <code>fold</code>, <code>toList</code>).</p>\n</blockquote>\n<p>How do you expect to get a list out if the elements inside are unordered</p>",
        "id": 563316781,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765508438
    },
    {
        "content": "<p>Regarding your questions:</p>\n<ol>\n<li>It's not provable, for the reasons you suspect.</li>\n<li>Ideally you should wait until Lean 4.27.0-rc1 is released early next week. In this version, core itself adds a <code>BEq</code> instance for hash sets and tree sets which is more efficient than the one in batteries (it only iterates once instead of twice) and comes with <code>LawfulBEq (ExtHashSet _)</code> and <code>LawfulBEq (ExtTreeSet _)</code> out of the box.</li>\n<li>Yes, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.ExtTreeSet#doc\">docs#Std.ExtTreeSet</a> sounds like what you want. It has <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.ExtTreeSet.foldl#doc\">docs#Std.ExtTreeSet.foldl</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.ExtTreeSet.toList#doc\">docs#Std.ExtTreeSet.toList</a>. If you really prefer to use a hash set, then your best shot would be to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.HashSet#doc\">docs#Std.HashSet</a> and reason about <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.HashSet.Equiv#doc\">docs#Std.HashSet.Equiv</a> instead of propositional equality.</li>\n</ol>",
        "id": 563331234,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1765520690
    }
]