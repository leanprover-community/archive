[
    {
        "content": "<p>Hi everyone!</p>\n<p>I was pretty sure that Lean would blame me for not flagging the following function as <code>partial</code> but it doesn't.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>Is there a simple explanation of why Lean \"fails\" to detect the absence of termination here?</p>\n<p>Cheers!</p>\n<p>Sébastien</p>",
        "id": 532936729,
        "sender_full_name": "Sébastien Boisgérault",
        "timestamp": 1754406504
    },
    {
        "content": "<p>You can include <code>partial</code> function inside other functions without having to mark the enclosing function as <code>partial</code></p>",
        "id": 532937669,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754406817
    },
    {
        "content": "<p>Ah, interesting! Is there a way to detect all functions using partial functions then?</p>",
        "id": 532939555,
        "sender_full_name": "Sébastien Boisgérault",
        "timestamp": 1754407475
    },
    {
        "content": "<p>To elaborate on what Aaron said, <code>while</code> is always partial</p>",
        "id": 532940222,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754407687
    },
    {
        "content": "<p><code>#print opaques &lt;your definition name&gt;</code> (<code>import Batteries.Tactic.PrintOpaques</code>) gives you a list of all opaque and partial definitions that a function depends on. Some of these might not be a opaque due to <code>partial</code> though (in particular e.g. <code>IO</code> operations) so if you want to know which of these are <code>partial</code>s you can check whether <code>&lt;name&gt;._unsafe_rec</code> exists. Example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">PrintOpaques</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testMe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"hi\"</span>\n\n<span class=\"sd\">/-- info: 'loop' depends on opaque or partial definitions: [Lean.Loop.forIn.loop] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">opaques</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Loop</span><span class=\"bp\">.</span><span class=\"n\">forIn</span><span class=\"bp\">.</span><span class=\"n\">loop</span><span class=\"bp\">._</span><span class=\"n\">unsafe_rec</span><span class=\"w\"> </span><span class=\"c1\">-- exists =&gt; is defined using `partial`</span>\n\n<span class=\"sd\">/-- info: 'testMe' depends on opaque or partial definitions: [IO.getStdout] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">opaques</span><span class=\"w\"> </span><span class=\"n\">testMe</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdout</span><span class=\"bp\">._</span><span class=\"n\">unsafe_rec</span><span class=\"w\"> </span><span class=\"c1\">-- doesn't exist =&gt; is opaque for other reasons</span>\n</code></pre></div>",
        "id": 532949503,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1754410920
    },
    {
        "content": "<p>There's a tension between Lean as a system for mathematical reasoning and Lean as a programming language.</p>\n<p>Currently <code>while</code> loops are mathematically opaque, but, when making executable code, the compiler will translate them into C that does the looping.</p>\n<p><code>partial</code> is a convenient way to create mathematically opaque definitions with a particular runtime specification. It doesn't really track whether functions terminate or not unfortunately.</p>\n<p>Infinite loops in pure code are sort of an undefined behavior; the compiler is free to assume pure functions terminate, so for example the following <code>#eval</code> returns with <code>0</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">useloop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">useloop</span>\n<span class=\"c1\">-- 0</span>\n</code></pre></div>\n<p>Interestingly, sometimes it's even possible to mathematically evaluate functions with <code>while</code>, provided they're sufficiently trivial:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">loop</span>\n<span class=\"c1\">-- 0</span>\n</code></pre></div>\n<p>(The trick is that even though it looks like there's a data dependency, <code>n * 0</code> is definitionally equal to <code>0</code>, and then the whole thing can reduce to <code>0</code>.)</p>",
        "id": 532954439,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754412767
    },
    {
        "content": "<p>Thanks all of you for your answers, that was very educational! <span aria-label=\"folded hands\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"folded hands\">:folded_hands:</span></p>",
        "id": 532957838,
        "sender_full_name": "Sébastien Boisgérault",
        "timestamp": 1754414269
    }
]