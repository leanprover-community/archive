[
    {
        "content": "<p>I am playing around within the continuous world and filters and I believe I have encountered my first diamond <span aria-label=\"diamonds\" class=\"emoji emoji-2666\" role=\"img\" title=\"diamonds\">:diamonds:</span> (edit: not a diamond)</p>\n<p>I have a continuous function <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mo>:</mo><mi mathvariant=\"double-struck\">R</mi><mo>→</mo><mi mathvariant=\"double-struck\">R</mi></mrow><annotation encoding=\"application/x-tex\">f : \\mathbb{R} \\rightarrow \\mathbb{R}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">R</span></span></span></span>  that when restricted to the rationals equals <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>g</mi><mo>:</mo><mi mathvariant=\"double-struck\">Q</mi><mo>→</mo><mi mathvariant=\"double-struck\">R</mi></mrow><annotation encoding=\"application/x-tex\">g : \\mathbb{Q} \\rightarrow \\mathbb{R}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8556em;vertical-align:-0.1667em;\"></span><span class=\"mord mathbb\">Q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">→</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">R</span></span></span></span>. </p>\n<p>The concrete case I am working on is the following : </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f_cont</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">P_cont</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">continuous_eval₂</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AbstractCompletion</span><span class=\"bp\">.</span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"n\">rationalCauSeqPkg</span><span class=\"w\"> </span><span class=\"n\">f_cont</span><span class=\"w\"> </span><span class=\"n\">P_cont</span><span class=\"w\"> </span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"c1\">-- unhappy here</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Question 1: How does one deal with or avoid diamonds? </p>\n<p>Question 2: How does one prove this statement in an idiomatic style for the more general setting of say extending a function from a metric space to another? (In fairness, I expect this might be easier since <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">R</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{R}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">R</span></span></span></span> is already a very intricate construction). I wonder the same in the case where it is a function from a topological space to another? But this is where I begin to have not thought too hard about this. </p>\n<p>The informal way I am thinking is extract a representative cauchy sequence for an arbitrary real number, show that continuity allows to show that the equality <code>hf</code> is \"preserved in the limit\". But this seems like a lot of work (fun to do once) to do in Lean for something not very exciting.</p>\n<p>In general, I am curious about what is the workflow or style of argument for this kind of problem in mathlib and people more familiar with this part of the library? I read the topology section of MIL (which is very nice) and did not find anything which seemed relevant.</p>\n<p>Apologies for the rambling, I just find this quite interesting and I am trying to get a good sense for what is going on.</p>\n<p>Thanks</p>",
        "id": 521178957,
        "sender_full_name": "Alex Brodbelt",
        "timestamp": 1748556598
    },
    {
        "content": "<p>Can you post a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> ? <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 521179467,
        "sender_full_name": "Bjørn Kjos-Hanssen",
        "timestamp": 1748556853
    },
    {
        "content": "<p>I think <code>rationalCauSeqPkg</code> is an implementation detail that isn't meant to be used directly.</p>",
        "id": 521180000,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1748557155
    },
    {
        "content": "<p>Or, <code>Rat.uniformSpace_eq</code> can help, checking how.</p>",
        "id": 521180264,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1748557286
    },
    {
        "content": "<p>IIUC, the idiomatic way is via <code>Dense.extend</code></p>",
        "id": 521180853,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1748557600
    },
    {
        "content": "<p>The issue is that <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/UniformSpace/CompareReals.html#rationalCauSeqPkg\">rationalCauSeqPkg</a> comes with a certain uniform space structure on <code>Rat</code> which is not definitionally equal to the one inferred by typeclass inference, i.e. the one declared as an instance in Mathlib (which is <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/MetricSpace/Pseudo/Defs.html#PseudoMetricSpace.toUniformSpace\">PseudoMetricSpace.toUniformSpace</a>). Although they are propositionally equal as shown by <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/UniformSpace/CompareReals.html#Rat.uniformSpace_eq\">Rat.uniformSpace_eq</a>, as pointed by Yakov.</p>",
        "id": 521181052,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1748557715
    },
    {
        "content": "<p>I would point out that I can't tell what your <code>g : Rat -&gt; Rat</code> is, since your polynomial in the example has real coefficients, not rational ones.</p>",
        "id": 521181155,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1748557791
    },
    {
        "content": "<p>You could use <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/DenseEmbedding.html#DenseRange.equalizer\">DenseRange.equalizer</a> along with <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/Algebra/Order/Archimedean.html#Rat.denseRange_cast\">Rat.denseRange_cast</a>.</p>",
        "id": 521181476,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1748557984
    },
    {
        "content": "<p>Also even if we answered quickly here, please note the remark of Bjørn: your code lacks imports and namespaces so it does not compile when pasted in an editor. In this case the fix was ok but in general you are unlikely to get answers here if you don't provide a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> because people do not want to lose time trying to fix the example.</p>",
        "id": 521182125,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1748558306
    },
    {
        "content": "<p>Thanks Etienne, that's a great pointer:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f_cont</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">aeval</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">aeval</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">denseRange_cast</span><span class=\"bp\">.</span><span class=\"n\">equalizer</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">assumption</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">continuous_aeval</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">funext</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hf</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 521183237,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1748559042
    },
    {
        "content": "<p>Ah apologies for not checking if it was an <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> and the typos.... (should not have posted late at night). Many thanks <span class=\"user-mention silent\" data-user-id=\"308899\">Yakov Pechersky</span>  and <span class=\"user-mention silent\" data-user-id=\"703970\">Etienne Marion</span> !</p>\n<p>I guess in hindsight I should have thought about searching for a theorem involving denseness... </p>\n<p>Regarding what <span class=\"user-mention silent\" data-user-id=\"703970\">Etienne Marion</span>  said, how would you use <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/UniformSpace/CompareReals.html#Rat.uniformSpace_eq\">Rat.uniformSpace_eq</a> to resolve the typeclass inference issue? Do you feed in the theorem to some simplifier? Or has this got to do more with the elaborator? What is the name for this kind of problem (diamond?) ? Is there somewhere I can read about this?</p>",
        "id": 521259656,
        "sender_full_name": "Alex Brodbelt",
        "timestamp": 1748598644
    },
    {
        "content": "<p>What you could do for instance would be to write <code>(Rat.uniformSpace_eq ▸ rationalCauSeqPkg)</code> to rewrite the instance inside <code>rationalCauSeqPkg</code>. However this will not solve other problems, starting with the fact that <code>AbstractCompletion.funext</code> takes in arguments functions whose codomain is an <code>AbstractCompletion Rat</code> while your functions codomain is <code>Real</code>, which is different (although isomorphic). This is all explained in the file <code>Mathlib.Topology.UniformSpace.CompareReals</code>, which provides a different way of building real numbers and checks that it gives something isomorphic, but is only here as an illustration and is not meant to be used.</p>\n<p>I am not sure if this can really be called a diamond. I think (not sure though) a diamond is rather something that appears when two non definitionally equal instances can be synthesized for the same type. What is happening here is different: the instance used in <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/UniformSpace/CompareReals.html#rationalCauSeqPkg\">rationalCauSeqPkg</a> is not synthesized by typeclass inference, it is simply different from the one which is synthesized. I don't know the name of this or if it is documented somewhere, but in practice it should not happen if you are careful with the instances you use because instances are supposed to be unique. However there is one case in which this problem appears: it is common in probability theory to restrict a measure to a smaller sigma-algebra, and thus we get two different <code>MeasurableSpace</code> structure for the same type, which causes the same issue. This is why it is now asked that if a lemma refers to a measure, the <code>MeasurableSpace</code> argument must not be a typeclass argument (i.e. it should not be synthesized but rather inferred from the one used by the measure).</p>",
        "id": 521274961,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1748603940
    }
]