[
    {
        "content": "<p>Hi all!</p>\n<p>I'm playing around with Lean and working on my first semi-real-world thing with it, and I'm kind of at a loss for how to proceed.</p>\n<p>For some context, I'm modeling the semantics of a simple blockchain. You've got a set of unspent transaction outputs, and a quantity of collected fees; and you've got a transition function that can apply some transaction to move funds around and collect a fee.</p>\n<p>The code for this is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TxId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Ix</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Slot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Coin</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Address</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TxRef</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TxId</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Ix</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">TxOut</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">address</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Address</span>\n<span class=\"w\">  </span><span class=\"n\">value</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coin</span>\n\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">UTxO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">U</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">map</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">TxRef</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">TxOut</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">TxRef</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">TxOut</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TxRef</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">TxOut</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">U</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">TxRef</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">U</span>\n\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">between</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">lower</span><span class=\"o\">:</span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"s2\">\" ≤ \"</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"o\">:</span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"s2\">\" ≤ \"</span><span class=\"w\"> </span><span class=\"n\">upper</span><span class=\"o\">:</span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lower</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">mid</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mid</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">upper</span><span class=\"o\">)</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">slot</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Slot</span>\n\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">U</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">UTxO</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">utxo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">U</span>\n<span class=\"w\">  </span><span class=\"n\">fees</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coin</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">txId</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TxId</span>\n<span class=\"w\">  </span><span class=\"n\">inputs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">TxRef</span>\n<span class=\"w\">  </span><span class=\"n\">outputs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">TxOut</span>\n<span class=\"w\">  </span><span class=\"n\">valid_range</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Slot</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Slot</span>\n<span class=\"w\">  </span><span class=\"n\">fee</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coin</span>\n\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">U</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">UTxO</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ToString</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"o\">]</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">transaction_valid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valid_start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">valid_end</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">valid_range</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">current_slot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">slot</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">resolved_inputs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consumed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">resolved_inputs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">produced</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">fee</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">outputs</span><span class=\"o\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"n\">valid_start</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">current_slot</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">valid_end</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">fee</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">resolved_inputs</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">consumed</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">produced</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">utxo_transition</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">transaction_valid</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">outputs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">outputs</span><span class=\"bp\">.</span><span class=\"n\">mapIdx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">txId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">utxo'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">utxo''</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">utxo'</span><span class=\"w\"> </span><span class=\"n\">outputs</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">utxo''</span>\n<span class=\"w\">        </span><span class=\"n\">fees</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">fees</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">fee</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">state</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">total_value</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">utxo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Coin</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span>\n\n<span class=\"kn\">end</span>\n\n\n<span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TxRef</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">TxOut</span><span class=\"o\">)</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTxO</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">r'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">snd</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">new</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">refs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">refs</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceVal</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">slot</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">utxo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"s2\">\"a\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"addr1\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">}),</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"s2\">\"b\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"addr2\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">})</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceVal</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">utxo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fees</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dbgTraceVal</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">txId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">inputs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"s2\">\"a\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)],</span>\n<span class=\"w\">    </span><span class=\"n\">outputs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[{</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"addr3\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">}],</span>\n<span class=\"w\">    </span><span class=\"n\">valid_range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"n\">fee</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">utxo_transition</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">tx</span>\n</code></pre></div>\n<p>Now I'd like to prove something like: the total value in the system is always preserved by this rule.</p>\n<p>I think I would write the premise like so:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">total_value_unchanged</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">new_state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">utxo_transition</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">transaction</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consumed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">total_value</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">produced</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">total_value</span><span class=\"w\"> </span><span class=\"n\">new_state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span>\n<span class=\"w\">  </span><span class=\"n\">consumed</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">produced</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I've played around with trying to understand what happens when I <code>intros</code> or <code>simp</code> but I'm not getting terribly far on my own.</p>\n<p>I'm not necessarily looking for the full answer, but any tips on what I should be looking at to tell if I'm making useful progress, and some of the tools that might be helpful in something like this, would be helpful! Thanks in advance!</p>",
        "id": 497767190,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738707507
    },
    {
        "content": "<p>or maybe I can only prove this for a specific U, like UTxOList?</p>",
        "id": 497767989,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738707861
    },
    {
        "content": "<p>Right now, your code does not work for me <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span>, so it is hard to me to help you right now.<br>\nIt is generally bad to have <code>let</code>s in the theorem statement, so I would suggest zeta-reducing those.</p>",
        "id": 497769676,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738708544
    },
    {
        "content": "<p>oh, maybe because I stripped out the ToString implementations; let me give you a <code>gist</code> with what I have so far, h/o</p>",
        "id": 497770862,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738709054
    },
    {
        "content": "<p><a href=\"https://gist.github.com/Quantumplation/d0d2ce0ba73d9b2e3fd09837dcf4b986\">https://gist.github.com/Quantumplation/d0d2ce0ba73d9b2e3fd09837dcf4b986</a></p>\n<p>Also hosted here: <a href=\"https://github.com/Quantumplation/cardano-lean-specification\">https://github.com/Quantumplation/cardano-lean-specification</a></p>",
        "id": 497771062,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738709135
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466744\">Pi Lanningham</span> <a href=\"#narrow/channel/270676-lean4/topic/Help.20with.20First.20Proof/near/497767190\">said</a>:</p>\n<blockquote>\n<p>I'm playing around with Lean and working on my first semi-real-world thing with it, and I'm kind of at a loss for how to proceed.</p>\n</blockquote>\n<p>What are you stuck on exactly? When I am stuck, usually, it is because I don't have a good idea of how to prove my claim. Do you have an informal proof that the value should remain unchanged?</p>",
        "id": 497772249,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738709687
    },
    {
        "content": "<p>(sorry I just moved to mobile so the above is a little sloppy hehe)</p>",
        "id": 497775441,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738711213
    },
    {
        "content": "<p>I know how to do the split and how to expand some definitions, but only through <code>simp</code> so I don't know how to get things in exactly the form I would need to progress.</p>",
        "id": 497775444,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738711215
    },
    {
        "content": "<p>If I was proving this on paper, I'd likely:</p>\n<p>Write down the definition of total_value;</p>\n<p>Point out that <code>consumed == produced</code> is equivalent to showing <code>consumed - produced == 0</code></p>\n<p>Expand the definitions to <code>(state.fees + sum state.utxo.value) - (new_state.fees + sum new_state.utxo.value) == 0</code></p>\n<p>Expand <code>new_state.fees</code> to <code>state.fees + transaction.fees</code></p>\n<p>Eliminate state.fees, so <code>(sum state.utxo.value) - (transaction.fees + sum new_state.utxos.value) == 0</code></p>\n<p>Show that new_state.utxos is state.utxos - transaction.inputs + transaction.ouputs</p>\n<p>Show that sum distributes here, so we can eliminate sum utxo.state.value, so we have <code>-(transaction.fee - sum transaction.inputs + sum transaction.outputs) = 0</code></p>\n<p>Rewrite this to sum transaction.inputs == transaction.fee + sum transaction.outputs</p>\n<p>Show that transaction_valid being true implies this</p>\n<p>Show that transaction_valid being false implies new_state == state, so total_value is equal too</p>",
        "id": 497775466,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738711228
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466744\">Pi Lanningham</span> <a href=\"#narrow/channel/270676-lean4/topic/Help.20with.20First.20Proof/near/497775444\">said</a>:</p>\n<blockquote>\n<p>I know how to do the split and how to expand some definitions, but only through <code>simp</code> so I don't know how to get things in exactly the form I would need to progress.</p>\n</blockquote>\n<p>Some ways to do this (in order of my personal preference): <code>rw</code>, <code>unfold</code>, <code>delta</code>.<br>\nUsually it is better to separate rewriting the definition into another theorem, and then <code>rw [unfolding_theorem]</code>.</p>",
        "id": 497775822,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738711431
    },
    {
        "content": "<p>Ok I'll play around with that later tonight, thank you! I just needed more tools I think</p>",
        "id": 497777074,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738712078
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Help.20with.20First.20Proof\">#lean4 &gt; Help with First Proof</a> by <span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span>.</p>",
        "id": 497777891,
        "sender_full_name": "Notification Bot",
        "timestamp": 1738712494
    },
    {
        "content": "<blockquote>\n<p>If I was proving this on paper, I'd likely:</p>\n</blockquote>\n<p>I think you should do many of the same thing when proving in Lean too.</p>\n<blockquote>\n<p>Write down the definition of total_value;</p>\n</blockquote>\n<p>You seem to have done this already.</p>\n<blockquote>\n<p>Point out that <code>consumed == produced</code> is equivalent to showing <code>consumed - produced == 0</code></p>\n</blockquote>\n<p>In mathlib this is called <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=sub_eq_zero#doc\">docs#sub_eq_zero</a>.<br>\nNote that subtraction on <code>Nat</code> is badly behaved, so you might want to switch to <code>Int</code> here.</p>\n<blockquote>\n<p>Expand the definitions to <code>(state.fees + sum state.utxo.value) - (new_state.fees + sum new_state.utxo.value) == 0</code></p>\n<p>Expand <code>new_state.fees</code> to <code>state.fees + transaction.fees</code></p>\n</blockquote>\n<p>Use <code>rw</code> or <code>unfold</code> or some other tactic to do this.</p>\n<blockquote>\n<p>Eliminate state.fees, so <code>(sum state.utxo.value) - (transaction.fees + sum new_state.utxos.value) == 0</code></p>\n</blockquote>\n<p>I think the lemmas in <a href=\"https://tqft.net/mathlib4files/Algebra/Group/Basic\">file#Algebra/Group/Basic</a> will be helpful. If you don't want to import mathlib, then see <code>Init.Data.Int.Lemmas</code>.</p>\n<blockquote>\n<p>Show that new_state.utxos is state.utxos - transaction.inputs + transaction.ouputs</p>\n</blockquote>\n<p>You will need to show this.</p>\n<blockquote>\n<p>Show that sum distributes here, so we can eliminate sum utxo.state.value, so we have <code>-(transaction.fee - sum transaction.inputs + sum transaction.outputs) = 0</code></p>\n</blockquote>\n<p>I couldn't find anything that says the sum distributes, so you might have to prove that yourself.</p>\n<blockquote>\n<p>Rewrite this to sum transaction.inputs == transaction.fee + sum transaction.outputs</p>\n</blockquote>\n<p>This is more group lemmas.</p>\n<blockquote>\n<p>Show that transaction_valid being true implies this</p>\n</blockquote>\n<p>You will have to show this.</p>\n<blockquote>\n<p>Show that transaction_valid being false implies new_state == state, so total_value is equal too</p>\n</blockquote>\n<p>This falls directly out of how you defined <code>transaction_valid</code>, so this should be easy.</p>",
        "id": 497779224,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738713173
    },
    {
        "content": "<p>How do I actually \"apply\" sub_eq_zero? I see that it's defined as <code>a - b = 0 &lt;=&gt; a = b</code>, but if I do <code>rw [Int.sub_eq_zero]</code> just says no instances of the pattern are found, but like... that's exactly what my goal is <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 497807684,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738730397
    },
    {
        "content": "<p>ah, ok, I can use the left arrow to go in reverse!</p>",
        "id": 497807729,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738730408
    },
    {
        "content": "<p>Ok, I've gotten pretty far!</p>\n<p>Here's what I have so far:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">total_value_unchanged</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let new_state := utxo_transition env state transaction</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let consumed := total_value state.utxo</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let produced := total_value new_state.utxo</span>\n<span class=\"w\">  </span><span class=\"n\">total_value</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">total_value</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">utxo_transition</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">utxo_transition</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">split</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rewrite</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">sub_eq_zero</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">total_value</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">total_value</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span>\n<span class=\"w\">      </span><span class=\"c1\">-- rw [Int.add_comm]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">sub_sub</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">sub_sub</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span>\n<span class=\"w\">      </span><span class=\"gr\">sorry</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>up to the sorry, here's my goal:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span>\n<span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span>\n<span class=\"n\">transaction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span>\n<span class=\"n\">h</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">transaction_valid</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">fee</span><span class=\"w\"> </span><span class=\"bp\">-</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">mapIdx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">txId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">outputs</span><span class=\"o\">))</span>\n<span class=\"w\">        </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>I want to simplify the <code>mapIdx</code> and the <code>fun x =&gt; x.snd.value</code>, since essentially they should cancel out...</p>\n<p>So, I'm trying to prove that's the case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mapIdx_2nd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">mapIdx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">mapIdx_cons</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map_cons</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>But this leaves me with an <code>i+1</code> in the <code>mapIdx</code>... I can see intuitively that this doesn't matter, because 2nd is ignoring the first argument, but it doesn't let me satisfy the induction. <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 497821714,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738739164
    },
    {
        "content": "<p>If it doesn't depend on the first argument, you should put that in the theorem too!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- `d` represents all the ways it could depend</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mapIdx_2nd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- do you know about `List.zip`?</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">mapIdx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">generalizing</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"c\">/-</span><span class=\"cm\"> we can pick what `d` to pass to the `ih` now,</span>\n<span class=\"cm\">    because in the previous inductive step we proved it for all `d` -/</span>\n<span class=\"w\">    </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_assoc</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 497879379,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738757856
    },
    {
        "content": "<p>Thanks so much for your help <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> ! That made some things click for me. I'm still really unclear on the machinery under the hood that is making it happen (I can't visualize, meaning i'm kind of at a guess and check situation, but at least I can make progress!)</p>\n<p>And yes, I'm familiar with zip; I'm not 100% sure how it applies here, since i'm not zipping two lists together (unless maybe i'm zipping [0..] with the transaction outputs).</p>\n<p>Ultimately I also needed to generalize <code>f</code>, and add a <code>g</code> because i'm also accessing .value inside the lambda, but I got it proved and it actually helped make progress on the original proof.</p>\n<p>I'll keep picking away at it, but if you're curious, here's how far I've gotten now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mapIdx_2nd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">mapIdx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"n\">generalizing</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">simpa</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_assoc</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">total_value_unchanged</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let new_state := utxo_transition env state transaction</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let consumed := total_value state.utxo</span>\n<span class=\"w\">  </span><span class=\"c1\">-- let produced := total_value new_state.utxo</span>\n<span class=\"w\">  </span><span class=\"c1\">-- consumed = produced := by</span>\n<span class=\"w\">  </span><span class=\"n\">total_value</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">total_value</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">utxo_transition</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">utxo_transition</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">split</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rewrite</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">sub_eq_zero</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">total_value</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">total_value</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span>\n<span class=\"w\">      </span><span class=\"c1\">-- rw [Int.add_comm]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">sub_sub</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">sub_sub</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">remove</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mapIdx_2nd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">txId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TxOut</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)]</span>\n<span class=\"w\">      </span><span class=\"gr\">sorry</span>\n<span class=\"w\">    </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 497972026,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738785230
    },
    {
        "content": "<p>If I have <code>a ^ b ^ c</code> as a premise, how can I show that just <code>b</code> is true? i've been looking through the Bool.and_* rules and i'm not sure which one would be helpful</p>",
        "id": 498002545,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738798495
    },
    {
        "content": "<p>are you dealing with a Prop <code>∧</code> or a Boolean <code>&amp;&amp;</code>?</p>",
        "id": 498002959,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1738798702
    },
    {
        "content": "<p>uhh.. not sure; Here's what's in my goal, it just says \"And\" and i'm trying to pluck out the middle condition:</p>\n<p><a href=\"/user_uploads/3121/LGCk6lvVjzI4qgb_PZvZQJFI/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/LGCk6lvVjzI4qgb_PZvZQJFI/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1422x800\" src=\"/user_uploads/thumbnail/3121/LGCk6lvVjzI4qgb_PZvZQJFI/image.png/840x560.webp\"></a></div><p>I wasn't aware Prop was different.</p>",
        "id": 498003111,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738798773
    },
    {
        "content": "<p>lemme go look at the prop docs</p>",
        "id": 498003135,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738798783
    },
    {
        "content": "<p>yeah, there's a difference between <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=And#doc\">docs#And</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Bool.and#doc\">docs#Bool.and</a>... if it's the Prop version, the accessors are <code>.left</code> and <code>.right</code> (or <code>.1</code> and <code>.2</code>)</p>",
        "id": 498003579,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1738799002
    },
    {
        "content": "<p>and then I would use a <code>let</code> clause to make it into something I can use in the rest of the proof?</p>",
        "id": 498003804,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738799083
    },
    {
        "content": "<p>sure, though if you're working with <code>Prop</code> it's better to use <code>have</code>, as the actual proof term is irrelevant</p>",
        "id": 498003862,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1738799111
    },
    {
        "content": "<p>if you have <code>h : a ∧ b ∧ c</code>, that's going to be parsed as <code>a ∧ (b ∧ c)</code> so you'd want to do <code>have h' := h.right.left</code> to get a proof of <code>b</code></p>",
        "id": 498003910,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1738799137
    },
    {
        "content": "<p>ok ty!!</p>",
        "id": 498003990,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738799167
    },
    {
        "content": "<p>sure, no problem</p>",
        "id": 498004026,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1738799189
    },
    {
        "content": "<p>also keep in mind that you can do <code>rcases h with ⟨ha, hb, hc⟩</code> to deconstruct the <code>And</code> into its 3 components at once</p>",
        "id": 498004315,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1738799318
    },
    {
        "content": "<p>Here are some examples of other ways you get extract one of the terms from an <code>And</code>, just for fun as they can all be done by things <span class=\"user-mention\" data-user-id=\"380294\">@Matt Diamond</span> has already said</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">tauto</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">hp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>The first example gets a proof of <code>s</code> using <code>tauto</code>. The second example extracts a proof of each term in the <code>And</code>.</p>",
        "id": 498004463,
        "sender_full_name": "Eric Paul",
        "timestamp": 1738799395
    },
    {
        "content": "<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>\n<p>So, I have <code>a \\elem B</code> and <code>\\forall x, x \\elem B -&gt; C a</code>, and i'm trying to show <code>C a</code> as my goal, how do I \"combine\" these?</p>\n<p>more concretely, I have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_implies_inputs_exist</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">transaction_valid</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"n\">tx_ref</span><span class=\"w\"> </span><span class=\"n\">is_input</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">transaction_valid</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">valid</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">all_inputs_exist</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">valid</span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"bp\">.</span><span class=\"n\">left</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>which leads to this proof state:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span>\n<span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span>\n<span class=\"n\">transaction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span>\n<span class=\"n\">tx_ref</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TxRef</span>\n<span class=\"n\">is_input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tx_ref</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span>\n<span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">snipped</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">space</span><span class=\"o\">}</span>\n<span class=\"n\">all_inputs_exist</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TxId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ix</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"n\">tx_ref</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>I tried applying all_inputs_exist as a rewrite rule, or passing tx_ref or is_input to all_inputs_exist, but it's not clicking for me, and because the machinery of the proof checker is such a black box to me, often I feel like I'm just guessing at how to express what I'm trying to say.</p>\n<p>I also tried destructuring tx_ref into a pair by the definition of TxRef (<code>@[reducible] def TxRef := TxId × Ix</code>) since i thought maybe that was interfering with it finding the relationship, but that didn't work either.</p>\n<p>(also, thank you to everyone whose been helping, I'm trying to put in the work and understand and not just get the answer from y'all <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> but it's very mind bending stuff)</p>",
        "id": 498013229,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738803933
    },
    {
        "content": "<p>Try <code>specialize all_inputs_exist tx_ref.fst tx_ref.snd is_input</code>.<br>\nIf you want to keep <code>all_inputs_exist</code> as a hypothesis, then you can do <code>have lookup_tx_ref := all_inputs_exist tx_ref.fst tx_ref.snd is_input</code>.</p>",
        "id": 498013531,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738804097
    },
    {
        "content": "<p>ahh, specialize was the tactic I was missing I think, lemme play around with that</p>",
        "id": 498013588,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738804136
    },
    {
        "content": "<p>Huzzah, I think this did it!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">valid_implies_inputs_exist</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">transaction_valid</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"n\">tx_ref</span><span class=\"w\"> </span><span class=\"n\">is_input</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">transaction_valid</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">valid</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">all_inputs_exist</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">valid</span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"bp\">.</span><span class=\"n\">right</span><span class=\"bp\">.</span><span class=\"n\">left</span>\n<span class=\"w\">    </span><span class=\"n\">clear</span><span class=\"w\"> </span><span class=\"n\">valid</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tx_id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ix</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tx_ref</span>\n<span class=\"w\">    </span><span class=\"n\">specialize</span><span class=\"w\"> </span><span class=\"n\">all_inputs_exist</span><span class=\"w\"> </span><span class=\"n\">tx_id</span><span class=\"w\"> </span><span class=\"n\">ix</span><span class=\"w\"> </span><span class=\"n\">is_input</span>\n<span class=\"w\">    </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 498014364,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738804546
    },
    {
        "content": "<p>You can find a lot of useful stuff <a href=\"https://seasawher.github.io/mathlib4-help/\">here</a>. Most of it is for mathlib, but I think it should still be useful.</p>",
        "id": 498016430,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738805722
    },
    {
        "content": "<p>is there a way to give names to an expression in the goal, to make it more readable? for example, my goal currently starts <code>(List.map (fun x =&gt; x.2.value) state.utxo).sum - </code> and it's very visually noisy, so I'd like to replace that with <code>old_value</code>, but playing around with replace, substitute, and let bindings didn't get me anywhere</p>",
        "id": 498021838,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738808768
    },
    {
        "content": "<p>I usually don't worry about goal readability, but you can do <code>let old_value := ...; rw [show old_value = ... from rfl] at *</code>.<br>\nMathlib has a tactic called <code>set</code> that does all of this automatically, so it would be <code>set old_value := ... with h</code>.</p>",
        "id": 498026154,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738811315
    },
    {
        "content": "<p>oo ok; i finally figured out how to import Mathlib <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> </p>\n<p>regarding goal readability, i'm mostly doing it to organize my own thoughts as I try to figure out how to get to the proof hehe</p>",
        "id": 498029959,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738813872
    },
    {
        "content": "<p>Hmm; if I have <code>f x + ... = f x + ...</code> how do I cancel out <code>f x</code> on both sides? I found <code>Int.add_left_cancel</code> which seems to be the rule I want, but it won't let me use it as a <code>rw</code> rule.</p>",
        "id": 498040897,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738820653
    },
    {
        "content": "<p>Does <code>congr</code> work? For <code>Int.add_left_cancel</code>, the goal/hypothesis is (probably) reversed, you would want to <code>apply</code> <code>Int.add_left_inj</code> instead. (Having an <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> would make this easier to reason about/demonstrate, as this depends on whether you're talking about a hypothesis or a goal.)</p>",
        "id": 498062912,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1738830724
    },
    {
        "content": "<p>Addition associates to the left, so <code>a + b + c</code> is actually <code>(a + b) + c</code>. You can force it to the right by using <code>simp only [Int.add_assoc] at hyp_name</code>.</p>",
        "id": 498117269,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738847442
    },
    {
        "content": "<p>Thanks, those answers were both very helpful! I had tried the add_assoc, but I had a <code>Nat</code> in my theorem declaration instead of an <code>Int</code> that was tripping it up <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 498243220,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738892244
    },
    {
        "content": "<p>I'm still not super clear on the difference between <code>rw</code> and <code>simp</code></p>",
        "id": 498243522,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738892442
    },
    {
        "content": "<p><code>rw</code> is \"a lemma says that A and B are the same, so change A to B\". <code>simp</code> is quite a bit more involved, it's \"try a whole lot of lemmas (which have been tagged \"use me simp\") and all of which in theory simplify the goal in various ways -- and hopefully at the end the goal ends up trivial\"</p>",
        "id": 498243676,
        "sender_full_name": "Julian Berman",
        "timestamp": 1738892555
    },
    {
        "content": "<p>Huzzah!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ih</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">split</span>\n<span class=\"w\">      </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rename_i</span><span class=\"w\"> </span><span class=\"n\">g_true</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span>\n<span class=\"w\">        </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"bp\">.</span><span class=\"n\">not_eq_false_eq_eq_true</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">g_true</span>\n<span class=\"w\">        </span><span class=\"n\">rename</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">not_g_false</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">not_g_false</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">fx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">        </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">xs_sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n<span class=\"w\">        </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">filter_sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n<span class=\"w\">        </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">not_filter_sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n<span class=\"w\">        </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">add_sub_assoc</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">remainder</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs_sum</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">not_filter_sum</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">add_left_cancel</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ih</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">rename_i</span><span class=\"w\"> </span><span class=\"n\">g_false</span>\n<span class=\"w\">        </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">g_false</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">assumption</span>\n</code></pre></div>",
        "id": 498248401,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1738895512
    },
    {
        "content": "<p>Ok, I'm pretty stuck again;</p>\n<p>Here's my proof so far:</p>\n<p><a href=\"https://gist.github.com/Quantumplation/cbfbe910a75f5f03c21be9820a55ab3a\">https://gist.github.com/Quantumplation/cbfbe910a75f5f03c21be9820a55ab3a</a></p>\n<p>At the <code>sorry</code>, my goal is this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">      </span><span class=\"o\">((</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span>\n<span class=\"w\">        </span><span class=\"n\">instUTxOUTXOList</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n</code></pre></div>\n<p>Cleaning up some notation, it's basically saying I need to prove that \"The sum of the unspent transaction outputs filtered to the list of transaction inputs is equal to the sum of each transaction inputs looked up in the UTxO\", which seems intuitively true to me, but I'm not sure how to convince lean4 of that fact.</p>\n<p>(or to remove some of the domain specific language, if <code>all</code> behaves like a Dictionary, <code>sum (filter (λ x -&gt; x \\in subset) all) = sum (map (λ x -&gt; lookup x in all) subset)</code>)</p>\n<p>I <em>think</em> my next steps probably involve simplifying out the function composition, so it looks something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n</code></pre></div>\n<p>Then using <code>valid_implies_inputs_exist</code> to show that the <code>match</code> can be simplified out:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span>\n</code></pre></div>\n<p>and then showing these are equivalent...</p>\n<p>I might also try removing the abstraction around UTxO, and just making it always a list, and see if that helps simplify the proofs.</p>\n<p>Does anyone else have other advice? Super appreciative of everyone whose been taking time to help me learn! :)</p>",
        "id": 499349248,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1739403632
    },
    {
        "content": "<p>A potential problem with that approach is that since <code>UTxO.lookup</code> returns an <code>Option</code>, not a bare value, the last goal is not well-typed</p>",
        "id": 499353378,
        "sender_full_name": "Chris Wong",
        "timestamp": 1739406006
    },
    {
        "content": "<p>You might be interested in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.filterMap#doc\">docs#List.filterMap</a>, which fuses the map and filter steps, so might be easier to work with</p>",
        "id": 499353445,
        "sender_full_name": "Chris Wong",
        "timestamp": 1739406063
    },
    {
        "content": "<p>Sorry, but your goal is false, I think?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- output of `extract_goal`, negated</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">extracted_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UTXOState</span><span class=\"w\"> </span><span class=\"n\">UTXOList</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Transaction</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">is_valid</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">slot</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">slot</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∧</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">fee</span><span class=\"w\"> </span><span class=\"bp\">∧</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TxId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ix</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">isSome</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∧</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">                </span><span class=\"o\">((</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">                    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">                    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span>\n<span class=\"w\">                    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span>\n<span class=\"w\">                  </span><span class=\"n\">UTxO</span><span class=\"bp\">.</span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">)</span>\n<span class=\"w\">                </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">            </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">fee</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">outputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">balanced</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">          </span><span class=\"o\">((</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">              </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">              </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span>\n<span class=\"w\">              </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span>\n<span class=\"w\">            </span><span class=\"n\">instUTxOUTXOList</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">      </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">fee</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">outputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">map</span>\n<span class=\"w\">        </span><span class=\"o\">((</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">value</span>\n<span class=\"w\">            </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span>\n<span class=\"w\">          </span><span class=\"n\">instUTxOUTXOList</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">utxo</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">transaction</span><span class=\"bp\">.</span><span class=\"n\">inputs</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">specialize</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">[</span><span class=\"bp\">⟨⟨</span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩⟩</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">⟨</span><span class=\"s2\">\"\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 499355386,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1739407260
    },
    {
        "content": "<p>Hmm; Ok, good call out. I think that's an artifact of you having duplicate TxRef's in your example, so I'd need the UTxO type to encode the fact that transaction outputs are unique as well <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 499355771,
        "sender_full_name": "Pi Lanningham",
        "timestamp": 1739407528
    },
    {
        "content": "<p>Hi everyone! I'm Saurish Sharma, a 14-year-old student deeply interested in mathematics and formalization. I've written a formally verified proof of the Collatz Conjecture using Lean.</p>\n<p>The proof is structured and verified in Lean 4, and I’ve also included the code in a LaTeX file, which provides the formal steps and logic of the proof. I plan to upload the Lean code to GitHub soon, but in the meantime, I'd really appreciate any feedback or suggestions on the approach and logic.</p>\n<p>Thanks — I'm excited to learn from this community!<br>\n<a href=\"/user_uploads/3121/fpwofyzBh4_04S8dO1LLST6E/collatz_proof_saurish.tex\">collatz_proof_saurish.tex</a></p>",
        "id": 511970487,
        "sender_full_name": "Saurish Sharma",
        "timestamp": 1744599315
    },
    {
        "content": "<p>Could someone move this post to a new thread?</p>\n<p>Also, I'm a bit hesitant to download a random file... would it be possible to share your code here using <a href=\"https://github.com/leanprover-community/mathlib/wiki/Code-in-backticks\">#backticks</a>?</p>",
        "id": 511971243,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1744599809
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"898949\">@Saurish Sharma</span> Here's your code as far as I can tell. But it doesn't compile (try clicking the button in the upper right corner to view in the lean 4 playground) and seems to be using some notation from Lean 3. Did an LLM help write this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">collatz_step</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">find_greatest</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">^</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">prime_set</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">prime_set</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">factorization</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">v2_odd_increase</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h_odd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">begin</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h_v2_n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">find_greatest_eq_zero</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">dvd_zero</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">},</span>\n<span class=\"w\">    </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"o\">,</span>\n<span class=\"w\">      </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">absurd</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">not_lt_of_ge</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">le_of_dvd</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"o\">)),</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h_v2_3n1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">find_greatest_ge</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"n\">pow_one</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">dvd_trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dvd_add_right</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dvd_mul_left</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dvd_refl</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">succ_le_succ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_succ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"n\">h_v2_n</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">lt_of_lt_of_le</span><span class=\"w\"> </span><span class=\"n\">zero_lt_one</span><span class=\"w\"> </span><span class=\"n\">h_v2_3n1</span><span class=\"o\">,</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">lex</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">lex_lt_of_v2_increase</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h_odd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_step</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">begin</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">collatz_step</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h_odd</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">lex</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">v2_odd_increase</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">h_odd</span><span class=\"o\">,</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">prime_factor_decreases</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_step</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">begin</span>\n<span class=\"w\">  </span><span class=\"n\">by_cases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">collatz_step</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"bp\">.</span><span class=\"n\">lex</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- Detailed proof for even case omitted, but assumed correct</span>\n<span class=\"w\">  </span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">lex_lt_of_v2_increase</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">collatz_iterate</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\">        </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">collatz_step</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_iterate</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">no_collatz_cycles</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">collatz_iterate</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">begin</span>\n<span class=\"w\">  </span><span class=\"n\">rintro</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hk_pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">step_dec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_step</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prime_factor_decreases</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">iterate_dec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_iterate</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_iterate</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">hj</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">collatz_iterate</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">step_dec</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">},</span>\n<span class=\"w\">    </span><span class=\"o\">{</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">collatz_iterate</span><span class=\"o\">],</span>\n<span class=\"w\">      </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">lt_trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">step_dec</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">lt_of_succ_lt</span><span class=\"w\"> </span><span class=\"n\">hk_pos</span><span class=\"o\">)),</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_iterate</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">iterate_dec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nat</span><span class=\"bp\">.</span><span class=\"n\">pred_lt</span><span class=\"w\"> </span><span class=\"n\">hk_pos</span><span class=\"bp\">.</span><span class=\"n\">ne'</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">lt_irrefl</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">,</span>\n<span class=\"kn\">end</span>\n</code></pre></div>",
        "id": 511972759,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1744600764
    },
    {
        "content": "<p>The file is just plaintext TeX, here it is in a codeblock:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>long text</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>\\documentclass[12pt]{article}<br>\n\\usepackage{amsmath, amssymb, amsthm}<br>\n\\usepackage{listings}<br>\n\\usepackage{xcolor}<br>\n\\usepackage{geometry}<br>\n\\geometry{margin=1in}<br>\n\\usepackage{hyperref}<br>\n\\hypersetup{<br>\n    colorlinks=true,<br>\n    linkcolor=blue,<br>\n    urlcolor=blue,<br>\n    pdftitle={Collatz Conjecture - Formal Proof in Lean},<br>\n    pdfauthor={Saurish Sharma}<br>\n}</p>\n<p>\\title{A Formally Verified Proof of the Collatz Conjecture}<br>\n\\author{Saurish Sharma}<br>\n\\date{April 2025}</p>\n<p>\\definecolor{codegray}{gray}{0.95}<br>\n\\lstset{<br>\n  backgroundcolor=\\color{codegray},<br>\n  basicstyle=\\ttfamily\\small,<br>\n  breaklines=true,<br>\n  frame=single,<br>\n  language=Lean,<br>\n  captionpos=b<br>\n}</p>\n<p>\\begin{document}</p>\n<p>\\maketitle</p>\n<p>\\section*{Abstract}<br>\nWe present a formally verified proof of the Collatz Conjecture using a lexicographic descent function on prime factor exponents. The proof is implemented in the Lean theorem prover and shows that all natural numbers eventually reach 1 under the Collatz process. We also prove that no non-trivial cycles can exist.</p>\n<p>\\section{Definitions and Preliminaries}</p>\n<p>\\subsection*{Collatz Step Function}<br>\n\\begin{lstlisting}<br>\ndef collatz_step (n : ℕ) : ℕ :=<br>\nif n % 2 = 0 then n / 2 else 3 * n + 1<br>\n\\end{lstlisting}</p>\n<p>\\subsection*{2-adic Valuation (v₂)}<br>\n\\begin{lstlisting}<br>\ndef v2 (n : ℕ) : ℕ :=<br>\nnat.find_greatest (λ k, 2^k ∣ n) (n + 1)<br>\n\\end{lstlisting}</p>\n<p>This function returns the largest exponent $k$ such that $2^k$ divides $n$.</p>\n<p>\\subsection*{Prime Factor Exponent Vector}<br>\n\\begin{lstlisting}<br>\ndef prime_set : list ℕ := [2, 3, 5, 7, 11, 13, 17, 19]</p>\n<p>def prime_factor_exponents (n : ℕ) : list ℕ :=<br>\n<a href=\"http://prime_set.map\">prime_set.map</a> (λ p, nat.factorization n p)<br>\n\\end{lstlisting}</p>\n<p>\\section{Main Results}</p>\n<p>\\subsection*{Theorem 1: v₂ increases when n is odd}<br>\n\\begin{lstlisting}<br>\nlemma v2_odd_increase (n : ℕ) (h_odd : n % 2 = 1) : v2 (3 * n + 1) &gt; v2 n :=<br>\nbegin<br>\n  have h_v2_n : v2 n = 0,<br>\n  {<br>\n    unfold v2,<br>\n    rw nat.find_greatest_eq_zero,<br>\n    intros k hk,<br>\n    cases k,<br>\n    { exact dvd_zero 1 },<br>\n    {<br>\n      have : 2 ^ k &gt; n := by linarith,<br>\n      exact absurd hk (not_lt_of_ge (nat.le_of_dvd (by linarith) hk)),<br>\n    }<br>\n  },<br>\n  have h_v2_3n1 : v2 (3 * n + 1) ≥ 1,<br>\n  {<br>\n    unfold v2,<br>\n    apply nat.find_greatest_ge,<br>\n    use 1,<br>\n    rw pow_one,<br>\n    exact dvd_trans (dvd_add_right (dvd_mul_left 3 n)) (dvd_refl _),<br>\n    exact nat.succ_le_succ (nat.zero_lt_succ _),<br>\n  },<br>\n  rw h_v2_n,<br>\n  exact lt_of_lt_of_le zero_lt_one h_v2_3n1,<br>\nend<br>\n\\end{lstlisting}</p>\n<p>\\subsection*{Theorem 2: Exponent Vector Decreases Lexicographically}<br>\n\\begin{lstlisting}<br>\nopen list.lex</p>\n<p>lemma lex_lt_of_v2_increase (n : ℕ) (h_odd : n % 2 = 1) :<br>\n  prime_factor_exponents (collatz_step n) &lt; prime_factor_exponents n :=<br>\nbegin<br>\n  simp [collatz_step, h_odd],<br>\n  unfold prime_factor_exponents,<br>\n  apply list.lex.cons,<br>\n  apply v2_odd_increase n h_odd,<br>\nend</p>\n<p>lemma prime_factor_decreases (n : ℕ) :<br>\n  prime_factor_exponents (collatz_step n) &lt; prime_factor_exponents n :=<br>\nbegin<br>\n  by_cases h : n % 2 = 0,<br>\n  {<br>\n    simp [collatz_step, h],<br>\n    unfold prime_factor_exponents,<br>\n    apply list.lex.cons,<br>\n    sorry -- Detailed proof for even case omitted, but assumed correct<br>\n  },<br>\n  {<br>\n    exact lex_lt_of_v2_increase n h,<br>\n  }<br>\nend<br>\n\\end{lstlisting}</p>\n<p>\\subsection*{Theorem 3: No Non-Trivial Cycles Exist}<br>\n\\begin{lstlisting}<br>\ndef collatz_iterate : ℕ → ℕ → ℕ<br>\n| 0        n := n<br>\n| (k + 1)  n := collatz_step (collatz_iterate k n)</p>\n<p>theorem no_collatz_cycles : ¬ ∃ n k, k &gt; 0 ∧ collatz_iterate k n = n :=<br>\nbegin<br>\n  rintro ⟨n, k, hk_pos, hk⟩,<br>\n  let f := λ m, prime_factor_exponents m,<br>\n  have step_dec : ∀ m, f (collatz_step m) &lt; f m := prime_factor_decreases,<br>\n  have iterate_dec : ∀ j &lt; k, f (collatz_iterate (j + 1) n) &lt; f (collatz_iterate j n),<br>\n  {<br>\n    intros j hj,<br>\n    induction j with j ih,<br>\n    { simp [collatz_iterate], exact step_dec n },<br>\n    {<br>\n      simp [collatz_iterate],<br>\n      exact lt_trans (step_dec _) (ih (nat.lt_of_succ_lt hk_pos)),<br>\n    }<br>\n  },<br>\n  have : f (collatz_iterate k n) &lt; f n := iterate_dec (k - 1) (nat.pred_lt <a href=\"http://hk_pos.ne\">hk_pos.ne</a>'),<br>\n  rw hk at this,<br>\n  exact lt_irrefl _ this,<br>\nend<br>\n\\end{lstlisting}</p>\n<p>\\section{Conclusion}</p>\n<p>We have defined a lexicographic descent function using a fixed prime exponent vector to show that every number eventually decreases under the Collatz map. Our formalization in Lean ensures logical soundness and rules out the existence of non-trivial cycles. This provides a formally verified structure for understanding the dynamics of the Collatz sequence.</p>\n<p>\\end{document}</p>\n</div></div>",
        "id": 511972850,
        "sender_full_name": "Shelvacu",
        "timestamp": 1744600813
    },
    {
        "content": "<p>@Thomas Browning Yes, I used ChatGPT to assist me with parts of the Lean code. I'm still learning Lean and formal proof writing, so I used it mainly to help understand the structure and syntax — but I’ve tried to carefully review and verify everything myself.</p>\n<p>Some parts might mix Lean 3 and Lean 4 syntax because of that, and I’d really appreciate help in cleaning it up and making sure everything is written properly in Lean 4.</p>\n<p>If anyone has time to look over the code or guide me on how to organize it better, I’d be very grateful. I’m here to learn and improve, and I’d love any suggestions from more experienced formalizers.</p>\n<p>Thanks a lot in advance!</p>",
        "id": 511973924,
        "sender_full_name": "Saurish Sharma",
        "timestamp": 1744601627
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"898949\">Saurish Sharma</span> <a href=\"#narrow/channel/113489-new-members/topic/Help.20with.20First.20Proof/near/511973924\">said</a>:</p>\n<blockquote>\n<p>I’ve tried to carefully review and verify everything myself.</p>\n</blockquote>\n<p>The lovely thing about lean is that you don't have to verify everything yourself. The computer verifies it for you. So if you take the lean code I pasted and click the \"view in lean 4 playground\" button, then lean itself will tell you the issues that your code has.</p>",
        "id": 511974262,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1744601880
    },
    {
        "content": "<p>The code itself isn't proof of anything. It's only if it compiles and is declared correct and free of errors by lean that it actually means anything.</p>",
        "id": 511974407,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1744601987
    },
    {
        "content": "<p>Sir,I tried to correct it by using lean 4 web editor but it didn't work out. Can you help me in correcting it.</p>",
        "id": 511975805,
        "sender_full_name": "Saurish Sharma",
        "timestamp": 1744602915
    },
    {
        "content": "<p>Well, the code is much closer to lean 3 than lean 4. But even using the lean 3 web editor, there is an issue. Your lemma <code>prime_factor_decreases</code> is false as stated. Here's a proof of the negation in lean 3:<a href=\"https://leanprover-community.github.io/lean-web-editor/#code=import%20data.nat.factorization.basic%0Aimport%20data.nat.prime_norm_num%0A%0Adef%20collatz_step%20%28n%20%3A%20%E2%84%95%29%20%3A%20%E2%84%95%20%3A%3D%0Aif%20n%20%25%202%20%3D%200%20then%20n%20%2F%202%20else%203%20*%20n%20%2B%201%0A%0Adef%20prime_set%20%3A%20list%20%E2%84%95%20%3A%3D%20%5B2%2C%203%2C%205%2C%207%2C%2011%2C%2013%2C%2017%2C%2019%5D%0A%0Adef%20prime_factor_exponents%20%28n%20%3A%20%E2%84%95%29%20%3A%20list%20%E2%84%95%20%3A%3D%0Aprime_set.map%20%28%CE%BB%20p%2C%20nat.factorization%20n%20p%29%0A%0Aopen%20list.lex%0A%0Alemma%20not_prime_factor_decreases%20%3A%0A%20%20%C2%AC%20%E2%88%80%20n%20%3A%20%E2%84%95%2C%20prime_factor_exponents%20%28collatz_step%20n%29%20%3C%20prime_factor_exponents%20n%20%3A%3D%0Abegin%0A%20%20rw%20%5Bnot_forall%5D%2C%0A%20%20use%203%2C%0A%20%20rw%20%5Bnot_lt%5D%2C%0A%20%20change%20prime_factor_exponents%203%20%E2%89%A4%20prime_factor_exponents%20%282%20*%205%29%2C%0A%20%20rw%20%5Bprime_factor_exponents%2C%20prime_factor_exponents%2C%20nat.factorization_mul%2C%20nat.prime.factorization%2C%0A%20%20%20%20nat.prime.factorization%2C%20nat.prime.factorization%5D%2C%0A%20%20simp%20%5Bprime_set%5D%2C%0A%20%20apply%20le_of_lt%2C%0A%20%20apply%20list.lex.rel%2C%0A%20%20all_goals%20%7B%20norm_num%20%7D%2C%0Aend\">https://leanprover-community.github.io/lean-web-editor/#code=import%20data.nat.factorization.basic%0Aimport%20data.nat.prime_norm_num%0A%0Adef%20collatz_step%20%28n%20%3A%20%E2%84%95%29%20%3A%20%E2%84%95%20%3A%3D%0Aif%20n%20%25%202%20%3D%200%20then%20n%20%2F%202%20else%203%20*%20n%20%2B%201%0A%0Adef%20prime_set%20%3A%20list%20%E2%84%95%20%3A%3D%20%5B2%2C%203%2C%205%2C%207%2C%2011%2C%2013%2C%2017%2C%2019%5D%0A%0Adef%20prime_factor_exponents%20%28n%20%3A%20%E2%84%95%29%20%3A%20list%20%E2%84%95%20%3A%3D%0Aprime_set.map%20%28%CE%BB%20p%2C%20nat.factorization%20n%20p%29%0A%0Aopen%20list.lex%0A%0Alemma%20not_prime_factor_decreases%20%3A%0A%20%20%C2%AC%20%E2%88%80%20n%20%3A%20%E2%84%95%2C%20prime_factor_exponents%20%28collatz_step%20n%29%20%3C%20prime_factor_exponents%20n%20%3A%3D%0Abegin%0A%20%20rw%20%5Bnot_forall%5D%2C%0A%20%20use%203%2C%0A%20%20rw%20%5Bnot_lt%5D%2C%0A%20%20change%20prime_factor_exponents%203%20%E2%89%A4%20prime_factor_exponents%20%282%20*%205%29%2C%0A%20%20rw%20%5Bprime_factor_exponents%2C%20prime_factor_exponents%2C%20nat.factorization_mul%2C%20nat.prime.factorization%2C%0A%20%20%20%20nat.prime.factorization%2C%20nat.prime.factorization%5D%2C%0A%20%20simp%20%5Bprime_set%5D%2C%0A%20%20apply%20le_of_lt%2C%0A%20%20apply%20list.lex.rel%2C%0A%20%20all_goals%20%7B%20norm_num%20%7D%2C%0Aend</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">data.nat.factorization.basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">data.nat.prime_norm_num</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">collatz_step</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">prime_set</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">]</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">prime_set.map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nat.factorization</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">list.lex</span>\n\n<span class=\"kd\">lemma</span><span class=\"w\"> </span><span class=\"n\">not_prime_factor_decreases</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">collatz_step</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"kd\">begin</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">not_forall</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">not_lt</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">),</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">prime_factor_exponents</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prime_factor_exponents</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nat.factorization_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nat.prime.factorization</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nat.prime.factorization</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nat.prime.factorization</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">prime_set</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">le_of_lt</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">list.lex.rel</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">norm_num</span><span class=\"w\"> </span><span class=\"o\">},</span>\n<span class=\"kd\">end</span>\n</code></pre></div>",
        "id": 511977857,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1744604313
    },
    {
        "content": "<p>Thanks so much for pointing that out! You're right — I see now that my lemma <code>prime_factor_decreases</code> doesn’t hold for all <code>n</code>. I really appreciate the counterexample and the Lean proof.</p>\n<p>I’ll rethink the strategy and explore a different kind of invariant or measure that might help with the proof.</p>\n<p>Thanks again — this really helps me learn!</p>",
        "id": 511979308,
        "sender_full_name": "Saurish Sharma",
        "timestamp": 1744605304
    }
]