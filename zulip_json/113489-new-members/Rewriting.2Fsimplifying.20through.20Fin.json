[
    {
        "content": "<p>Hi! I'm trying to better architect intermediate data and proofs that appear in my proofs by grouping them in a struct and proving theorems about them (inspired by <a href=\"#narrow/channel/113488-general/topic/parameters/near/462827468\">this ProofData technique</a>). However, I got stuck when rewriting <code>Fin</code> due to a \"motive is not type correct\" error. Usually <code>simp</code> can resolve the issue, but it didn't work either. The following snippet is a minimized example of the issue. Can someone help unstuck the last sorry? Or any advice about structuring proof-related data is welcome. Thanks!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Node</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NFA</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">nodes</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Node</span>\n<span class=\"w\">  </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">append</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nfa</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NFA</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">nfa'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NFA</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">nfa'</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nfa'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">nodes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Node</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Node</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Node</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"o\">],</span>\n<span class=\"w\">    </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">nfa</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"n\">nfa'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nfa'</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">ProofData</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nfa</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NFA</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">nfa'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NFA</span>\n<span class=\"w\">  </span><span class=\"n\">nfa'_property</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">nfa'</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span>\n<span class=\"w\">  </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">nfa'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">append</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">append</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProofData</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">nfa'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nfa'_property</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"bp\">.</span><span class=\"n\">property</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">eq</span><span class=\"o\">],</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">ProofData</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProofData</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">nfa'</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">nfa</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">append</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ProofData</span><span class=\"bp\">.</span><span class=\"n\">start_eq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ProofData</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">nfa'</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Q1. How can I make this simp progress?</span>\n<span class=\"w\">  </span><span class=\"c1\">-- simp [self.eq]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Q2. Or, how can I work around the \"motive is not type correct\" error?</span>\n<span class=\"w\">  </span><span class=\"c1\">--   I guess the type error comes from different arguments to `Fin`.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- rw [self.eq]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 484124920,
        "sender_full_name": "pandaman",
        "timestamp": 1732426865
    },
    {
        "content": "<p>One suggestion I would make is to add <code>set_option autoImplicit false</code> at the top, as it's possible that you're relying on <code>autoImplicit</code> accidentally</p>",
        "id": 484125709,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1732427740
    },
    {
        "content": "<p>actually, on second glance that might be irrelevant</p>",
        "id": 484126002,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1732428041
    },
    {
        "content": "<p>Yes, I omitted in this example, but I disable <code>autoImplicit</code> in my code.</p>",
        "id": 484126219,
        "sender_full_name": "pandaman",
        "timestamp": 1732428223
    },
    {
        "content": "<p>I got this to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">ext</span>\n<span class=\"n\">change</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">nfa</span><span class=\"bp\">.</span><span class=\"n\">nodes</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">self</span><span class=\"bp\">.</span><span class=\"n\">eq</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 484126839,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1732428905
    },
    {
        "content": "<p>I think the key is using <code>Fin.ext</code> to get out of the Fin context</p>",
        "id": 484126881,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1732428952
    },
    {
        "content": "<p>Thanks! <code>rw [self.eq]</code> still fails right after <code>Fin.ext</code> though. Why could <code>change</code> replace the <code>self.start.val</code> to <code>nfa.nodes.size + 1</code> (which is less dependent on <code>self</code> I guess)?</p>",
        "id": 484126996,
        "sender_full_name": "pandaman",
        "timestamp": 1732429077
    },
    {
        "content": "<p>honestly not sure... I was kind of surprised, as I was trying to rewrite it using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.val_mk#doc\">docs#Fin.val_mk</a> and it didn't seem to work, which is why I resorted to <code>change</code></p>",
        "id": 484127098,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1732429172
    },
    {
        "content": "<p>(btw, <code>simp [append]</code> closes the goal after those 3 lines)</p>",
        "id": 484127115,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1732429199
    },
    {
        "content": "<p>also weird: if you replace <code>rw [self.eq]</code> with <code>simp [self.eq]</code>, simp still makes no progress</p>",
        "id": 484127202,
        "sender_full_name": "Matt Diamond",
        "timestamp": 1732429271
    },
    {
        "content": "<p>Yeah, <code>simp</code> often work better with <code>Fin</code>, but it's not the case here :(. I wonder if I can add some simp lemmas to make it go smoothly...</p>",
        "id": 484127404,
        "sender_full_name": "pandaman",
        "timestamp": 1732429545
    },
    {
        "content": "<p>I ended up not using <code>Fin</code>, carrying proofs around when necessary.</p>",
        "id": 484459459,
        "sender_full_name": "pandaman",
        "timestamp": 1732610564
    }
]