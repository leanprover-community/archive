[
    {
        "content": "<p>I made <code>calc</code> work for transitions in LTSs by defining</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">Tr</span><span class=\"bp\">.</span><span class=\"n\">toRelation</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">s2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"bp\">.</span><span class=\"n\">Tr</span><span class=\"w\"> </span><span class=\"n\">s1</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"n\">s2</span>\n</code></pre></div>\n<p>and then appropriate <code>Trans</code> instances like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Transitions can be chained with multi-step transitions. -/</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lts</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"w\"> </span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"n\">Label</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">Tr</span><span class=\"bp\">.</span><span class=\"n\">toRelation</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">MTr</span><span class=\"bp\">.</span><span class=\"n\">toRelation</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"w\"> </span><span class=\"n\">μs</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">MTr</span><span class=\"bp\">.</span><span class=\"n\">toRelation</span><span class=\"w\"> </span><span class=\"n\">lts</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">μs</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n</code></pre></div>\n<p>But to use <code>calc</code> with our notation, I had to change the definition of the notation to invoke LTS.Tr.toRelation instead of just LTS.Tr, which is a bit weird in proofs (no complication whatsoever, but I think people will be surprised by the goal).</p>\n<p>So now we can write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">τ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]]</span><span class=\"bp\">↠ₙ</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">τ</span><span class=\"o\">]</span><span class=\"bp\">⭢ₙ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pre</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">⭢ₙ</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">constructor</span>\n</code></pre></div>\n<p>but in that <code>[...]</code> I get the goal</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">LTS</span><span class=\"bp\">.</span><span class=\"n\">Tr</span><span class=\"bp\">.</span><span class=\"n\">toRelation</span><span class=\"w\"> </span><span class=\"n\">ltsNat</span><span class=\"w\"> </span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pre</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>instead of what I'd like (the simplest):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">ltsNat</span><span class=\"bp\">.</span><span class=\"n\">Tr</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">τ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pre</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Act</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>So in order to enable <code>calc</code>, I made the notation surprising (because it goes through <code>toRelation</code> instead of invoking <code>Tr</code> directly).</p>\n<p>Any ideas on how to get the cake and eat it?  :-)</p>",
        "id": 530428861,
        "sender_full_name": "Fabrizio Montesi",
        "timestamp": 1753303004
    }
]