[
    {
        "content": "<p>What ways are there to call the lean REPL from within python? I initially thought that sending commands and receiving output from the REPL with <code>subprocess</code> would be a simple task, but after spending several hours unsuccessfully debugging issues related to flushing, buffering, and pipes, I realized it wasn't as simple as I hoped. I'm curious if there are any packages that either make managing external processes easier, or directly wrap the Lean REPL.</p>\n<p>I am on Lean 4.7.0 (which isn't ideal), but answers that work for newer versions of Lean would be helpful to me as well.</p>",
        "id": 513253978,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745138776
    },
    {
        "content": "<p>It is indeed not very straightforward. I have a working implementation using threading to send requests and get the output <a href=\"https://github.com/augustepoiroux/LeanInteract/blob/7b0ed74c2e29fa0ae6bc9d437dc77ab9aa9a4421/src/lean_interact/server.py#L108-L139\">here</a>. And you can find the initialization of the subprocess <a href=\"https://github.com/augustepoiroux/LeanInteract/blob/7b0ed74c2e29fa0ae6bc9d437dc77ab9aa9a4421/src/lean_interact/server.py#L64-L77\">here</a>.</p>",
        "id": 513258803,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745142963
    },
    {
        "content": "<p>Ah, thanks, I'll try that code out. Although, based on the description of Lean Interact, maybe at this point it just makes more sense for me to use Lean Interact itself instead of trying to fiddle with subprocess. I'm getting a <code>No module named 'resource'</code> error when running <code>import lean_interact</code> on Windows though.</p>",
        "id": 513259103,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745143224
    },
    {
        "content": "<p>Yes indeed, I am currently trying to make LeanInteract cross-platform with this <a href=\"https://github.com/augustepoiroux/LeanInteract/pull/4\">pull-request</a>. The <code>resource</code> error should be resolved on Windows now, but I still have issues regarding access to the <code>lake</code> command.</p>",
        "id": 513259287,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745143372
    },
    {
        "content": "<p>It's funny, I was having issues installing the REPL on windows as well, but somehow I managed to fix it? I can't remember what the issue was (I think maybe I was using lowercase <code>require repl from git ...</code> instead of <code>require REPL from git ...</code>, which actually worked)</p>",
        "id": 513259894,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745143836
    },
    {
        "content": "<p>I just <code>git clone</code>'d the LeanInteract repository on Windows, did <code>git checkout cross_platform</code> and then uninstalled the version of lean interact on PyPI and then ran <code>pip install .</code> from within the LeanInteract directory. Now, everything seems to work fine for me, and Lean Interact seems to be capable of running on windows. So at the very least, your changes work for me on windows.</p>\n<p>What issues with windows support did you still have?</p>",
        "id": 513262279,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745145853
    },
    {
        "content": "<p>Amazing! Indeed, it seems that it works for recent Lean versions, but there are issues with building the REPL with Lean v4.7.0. I am trying to fix that.</p>",
        "id": 513264102,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745147291
    },
    {
        "content": "<p>Thanks for testing it on Windows :) If you find bugs, please tell me</p>",
        "id": 513264170,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745147366
    },
    {
        "content": "<p>This was on 4.7.0. I think maybe I did something earlier that fixed it (maybe adding the REPL to the <code>lakefile.lean</code> and building it beforehand)? It's super late for me so I need to get to sleep but I can help you debug at some point in the future.</p>",
        "id": 513264401,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745147584
    },
    {
        "content": "<p>Oh thanks, that would be amazing!<br>\nIt seems that the issue I am facing (<code>ld.lld: error: too many exported symbols (got 65611, max 65535)</code>) was fixed with Lean v4.8.0-rc1: <a href=\"https://github.com/leanprover/lean4/issues/2346\">github issue</a>, <a href=\"#narrow/channel/113488-general/topic/Update.20Lean.20to.20leanprover.2Flean4.3Av4.2E7.2E0-rc2.20with.20error.3A.20.60too\">thread1</a>, <a href=\"#narrow/stream/287929-mathlib4/topic/error.20building.20windows.20exe.20.20proj\">thread2</a>, <a href=\"#narrow/channel/287929-mathlib4/topic/error.20building.20windows.20exe.20.20proj\">thread3</a>.<br>\nI might drop support for Lean v4.7.0 on Windows platform then. Looking forward to see your fix <span class=\"user-mention\" data-user-id=\"521331\">@Niels Voss</span></p>",
        "id": 513265679,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745148669
    },
    {
        "content": "<p>Another issue with Windows: file paths are limited to 260 characters by default. Paths used for LeanInteract cache are sometimes longer than that. Here is the <a href=\"https://learn.microsoft.com/en-us/windows/win32/fileio/maximum-file-path-limitation?tabs=registry\">Microsoft doc</a> about this and the command to fix it:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"w\"> </span>New-ItemProperty<span class=\"w\"> </span>-Path<span class=\"w\"> </span><span class=\"s2\">\"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem\"</span><span class=\"w\"> </span>-Name<span class=\"w\"> </span>LongPathsEnabled<span class=\"w\"> </span>-Value<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>-PropertyType<span class=\"w\"> </span>DWord<span class=\"w\"> </span>-Force\n<span class=\"w\"> </span>git<span class=\"w\"> </span>config<span class=\"w\"> </span>--system<span class=\"w\"> </span>core.longpaths<span class=\"w\"> </span><span class=\"nb\">true</span>\n</code></pre></div>",
        "id": 513280811,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745160631
    },
    {
        "content": "<p>Please checkout:<br>\n<a href=\"https://github.com/trishullab/itp-interface\">https://github.com/trishullab/itp-interface</a><br>\nIt does what you are trying to do and can run a scale across multiple ray cluster nodes (and on multiple Lean versions). One can also perform scalable proof search using our other framework:<br>\n<a href=\"https://github.com/trishullab/proof-wala\">https://github.com/trishullab/proof-wala</a></p>",
        "id": 513282496,
        "sender_full_name": "Amitayush Thakur",
        "timestamp": 1745162100
    },
    {
        "content": "<p>The whole interaction you want to build with REPL JRPC has been already baked in <code>itp-interface</code> . You just need to <code>pip install</code> the package</p>",
        "id": 513282630,
        "sender_full_name": "Amitayush Thakur",
        "timestamp": 1745162200
    },
    {
        "content": "<p>Just three steps:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">pip</span><span class=\"w\"> </span><span class=\"n\">install</span><span class=\"w\"> </span><span class=\"n\">itp</span><span class=\"bp\">-</span><span class=\"n\">interface</span>\n<span class=\"kn\">export</span><span class=\"w\"> </span><span class=\"n\">LEAN_VERSION</span><span class=\"bp\">=</span><span class=\"mf\">4.7</span><span class=\"bp\">.</span><span class=\"m\">0</span>\n<span class=\"n\">install</span><span class=\"bp\">-</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">repl</span>\n<span class=\"n\">install</span><span class=\"bp\">-</span><span class=\"n\">itp</span><span class=\"bp\">-</span><span class=\"n\">interface</span>\n</code></pre></div>\n<p>^just these steps and you are ready to use the package. No need to explicitly install Lean or anything.</p>",
        "id": 513282827,
        "sender_full_name": "Amitayush Thakur",
        "timestamp": 1745162361
    },
    {
        "content": "<blockquote>\n<p>Oh thanks, that would be amazing!<br>\nIt seems that the issue I am facing (<code>ld.lld: error: too many exported symbols (got 65611, max 65535)</code>) was fixed with Lean v4.8.0-rc1: <a href=\"https://github.com/leanprover/lean4/issues/2346\">github issue</a>, <a href=\"#narrow/channel/113488-general/topic/Update.20Lean.20to.20leanprover.2Flean4.3Av4.2E7.2E0-rc2.20with.20error.3A.20.60too\">thread1</a>, <a href=\"#narrow/stream/287929-mathlib4/topic/error.20building.20windows.20exe.20.20proj\">thread2</a>, <a href=\"#narrow/channel/287929-mathlib4/topic/error.20building.20windows.20exe.20.20proj\">thread3</a>.<br>\nI might drop support for Lean v4.7.0 on Windows platform then. Looking forward to see your fix <span class=\"user-mention silent\" data-user-id=\"521331\">Niels Voss</span></p>\n</blockquote>\n<p>Oh, I think maybe I wasn't using 4.7.0 after all. I think I just assumed that if I ran LeanInteract in my project directory, it would use that project, but it didn't and it used 4.19.0. I think it's still broken on 4.7.0 :/</p>",
        "id": 513301076,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745178215
    },
    {
        "content": "<p>Since I've already gotten <code>repl</code> installed successfully as an executable in my lean 4.7.0 project (in the sense that <code>lake exe repl</code> runs properly), is there a way for me to make Lean Interact or something just use the existing <code>repl</code> instead of trying to manage its own version of the <code>repl</code>?</p>",
        "id": 513301656,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745178683
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"657996\">Amitayush Thakur</span> <a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/How.20to.20use.20the.20REPL.20from.20within.20python.3F/near/513282496\">said</a>:</p>\n<blockquote>\n<p>Please checkout:<br>\n<a href=\"https://github.com/trishullab/itp-interface\">https://github.com/trishullab/itp-interface</a><br>\nIt does what you are trying to do and can run a scale across multiple ray cluster nodes (and on multiple Lean versions). One can also perform scalable proof search using our other framework:<br>\n<a href=\"https://github.com/trishullab/proof-wala\">https://github.com/trishullab/proof-wala</a></p>\n</blockquote>\n<p>Does <code>itp-interface</code> work on windows? I'm getting a \"No module named 'termios'\" error when trying to run it, and I think termios is not available on windows.</p>",
        "id": 513302128,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745179140
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"521331\">Niels Voss</span> <a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/How.20to.20use.20the.20REPL.20from.20within.20python.3F/near/513301656\">said</a>:</p>\n<blockquote>\n<p>Since I've already gotten <code>repl</code> installed successfully as an executable in my lean 4.7.0 project (in the sense that <code>lake exe repl</code> runs properly), is there a way for me to make Lean Interact or something just use the existing <code>repl</code> instead of trying to manage its own version of the <code>repl</code>?</p>\n</blockquote>\n<p>If you have a working project, then you can try to do the following with LeanInteract:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">lean_interact</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">LocalProject</span><span class=\"p\">,</span> <span class=\"n\">LeanREPLConfig</span><span class=\"p\">,</span> <span class=\"n\">LeanServer</span>\n<span class=\"n\">config</span> <span class=\"o\">=</span> <span class=\"n\">LeanREPLConfig</span><span class=\"p\">(</span><span class=\"n\">project</span><span class=\"o\">=</span><span class=\"n\">LocalProject</span><span class=\"p\">(</span><span class=\"s2\">\"path/to/your/project\"</span><span class=\"p\">),</span> <span class=\"n\">verbose</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">server</span> <span class=\"o\">=</span> <span class=\"n\">LeanServer</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>The issue I have with v4.7.0 on Windows happens when I try to create a temporary project with Mathlib as dependency.</p>",
        "id": 513308636,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745184581
    },
    {
        "content": "<p>I get the following error:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Header</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>PS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; python\nPython 3.13.2 (tags/v3.13.2:4f8bb39, Feb  4 2025, 15:23:48) [MSC v.1942 64 bit (AMD64)] on win32\nType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.\n&gt;&gt;&gt; from lean_interact import LocalProject, LeanREPLConfig, LeanServer\n&gt;&gt;&gt; config = LeanREPLConfig(project=LocalProject(&quot;.&quot;), verbose=True)\n[20/20] Linking repl.exe\nerror: &gt; c:\\Users\\niels\\.elan\\toolchains\\leanprover--lean4---v4.7.0\\bin\\leanc.exe -o .\\.lake\\build\\bin\\repl.exe .\\.lake\\build\\ir\\REPL\\Main.c.o .\\.lake\\build\\ir\\REPL\\JSON.c.o .\\.lake\\build\\ir\\REPL\\Frontend.c.o .\\.lake\\build\\ir\\REPL\\Util\\Path.c.o .\\.lake\\build\\ir\\REPL\\Lean\\ContextInfo.c.o .\\.lake\\build\\ir\\REPL\\Util\\Pickle.c.o .\\.lake\\build\\ir\\REPL\\Lean\\Environment.c.o .\\.lake\\build\\ir\\REPL\\Lean\\InfoTree.c.o .\\.lake\\build\\ir\\REPL\\Lean\\InfoTree\\ToJson.c.o .\\.lake\\build\\ir\\REPL\\Snapshots.c.o\nerror: stderr:\nld.lld: error: too many exported symbols (got 65611, max 65535)\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\nerror: external command `c:\\Users\\niels\\.elan\\toolchains\\leanprover--lean4---v4.7.0\\bin\\leanc.exe` exited with code 1\n[14:33:22] ERROR    Failed to build the REPL: Command &#39;[&#39;lake&#39;, &#39;build&#39;]&#39; returned non-zero exit status 1.                                     config.py:374\nTraceback (most recent call last):\n  File &quot;&lt;python-input-1&gt;&quot;, line 1, in &lt;module&gt;\n    config = LeanREPLConfig(project=LocalProject(&quot;.&quot;), verbose=True)\n  File &quot;C:\\Users\\niels\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\lean_interact\\config.py&quot;, line 299, in __init__\n    self._setup_repl()\n    ~~~~~~~~~~~~~~~~^^\n  File &quot;C:\\Users\\niels\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\lean_interact\\config.py&quot;, line 370, in _setup_repl\n    subprocess.run(\n    ~~~~~~~~~~~~~~^\n        [&quot;lake&quot;, &quot;build&quot;], cwd=self._cache_repl_dir, check=True, stdout=self._stdout, stderr=self._stderr\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File &quot;C:\\Users\\niels\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\subprocess.py&quot;, line 579, in run\n    raise CalledProcessError(retcode, process.args,\n                             output=stdout, stderr=stderr)\nsubprocess.CalledProcessError: Command &#39;[&#39;lake&#39;, &#39;build&#39;]&#39; returned non-zero exit status 1.\n&gt;&gt;&gt;\n</code></pre></div>\n</div></div>",
        "id": 513308982,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745184850
    },
    {
        "content": "<p>This is strange because <code>lake build</code>, <code>lake exe repl</code>, and <code>.\\.lake\\packages\\REPL\\.lake\\build\\bin\\repl.exe</code> all run correctly from my current directory</p>",
        "id": 513309130,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745184989
    },
    {
        "content": "<p>Interesting, so here the REPL fetched by LeanInteract fails to build. It is not the same REPL as the one you execute with <code>lake exe repl</code>. The REPL used by LeanInteract is slightly different from the one tagged by <code>v4.7.0</code> in the official REPL repo. In fact, it is coming from <a href=\"https://github.com/augustepoiroux/repl/tree/v1.0.6\">https://github.com/augustepoiroux/repl/tree/v1.0.6</a>, which backports the new features to previous Lean versions. So the issue is probably that the backport for v4.7.0 does not compile on Windows (the CI only tests for Ubuntu on this repo) ^^'</p>",
        "id": 513311074,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745186349
    },
    {
        "content": "<p>Yeah, now I'm getting the same error as you. After modifying my <code>lakefile.lean</code> with the following change:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">-</span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">REPL</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/leanprover-community/repl.git\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"n\">leanVersion</span>\n<span class=\"bp\">+</span><span class=\"n\">require</span><span class=\"w\"> </span><span class=\"n\">REPL</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/augustepoiroux/repl.git\"</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"w\"> </span><span class=\"s2\">\"v1.0.6\"</span>\n</code></pre></div>\n<p>I tried to build it and got the following:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Lake</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>PS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; lake update REPL\nREPL: cloning https://github.com/augustepoiroux/repl.git to &#39;.\\.lake\\packages\\REPL&#39;\nwarning: Qq: ignoring missing dependency manifest &#39;.\\.lake\\packages\\Qq\\lake-manifest.json&#39;\nwarning: Cli: ignoring missing dependency manifest &#39;.\\.lake\\packages\\Cli\\lake-manifest.json&#39;\nmathlib: running post-update hooks\nNo files to download\nDecompressing 4359 file(s)\nunpacked in 639 ms\nPS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; lake build\nPS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; lake exe repl\ninfo: [0/20] Building REPL.Util.Path\ninfo: [0/20] Building REPL.Frontend\ninfo: [0/20] Building REPL.Lean.InfoTree\ninfo: [0/20] Building REPL.Util.Pickle\ninfo: [0/20] Building REPL.Lean.ContextInfo\ninfo: [0/20] Building REPL.JSON\ninfo: [5/20] Compiling REPL.Lean.ContextInfo\ninfo: [5/20] Building REPL.Lean.Environment\ninfo: [5/20] Building REPL.Snapshots\ninfo: [5/20] Compiling REPL.Util.Path\ninfo: [5/20] Compiling REPL.Util.Pickle\ninfo: [5/20] Compiling REPL.Frontend\ninfo: [5/20] Compiling REPL.JSON\ninfo: [6/20] Building REPL.Lean.InfoTree.ToJson\ninfo: [6/20] Compiling REPL.Lean.InfoTree\ninfo: [12/20] Compiling REPL.Lean.Environment\ninfo: [14/20] Compiling REPL.Snapshots\ninfo: [16/20] Building REPL.Main\ninfo: [16/20] Compiling REPL.Lean.InfoTree.ToJson\ninfo: [19/20] Compiling REPL.Main\ninfo: [20/20] Linking repl.exe\nerror: &gt; c:\\Users\\niels\\.elan\\toolchains\\leanprover--lean4---v4.7.0\\bin\\leanc.exe -o .\\.lake/packages\\REPL\\.lake\\build\\bin\\repl.exe .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Main.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\JSON.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Frontend.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Util\\Path.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Lean\\ContextInfo.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Util\\Pickle.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Lean\\Environment.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Lean\\InfoTree.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Lean\\InfoTree\\ToJson.c.o .\\.lake/packages\\REPL\\.lake\\build\\ir\\REPL\\Snapshots.c.o\nerror: stderr:\nld.lld: error: too many exported symbols (got 65611, max 65535)\nclang: error: linker command failed with exit code 1 (use -v to see invocation)\nerror: external command `c:\\Users\\niels\\.elan\\toolchains\\leanprover--lean4---v4.7.0\\bin\\leanc.exe` exited with code 1\n</code></pre></div>\n</div></div>",
        "id": 513311601,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745186822
    },
    {
        "content": "<p>Actually, looking at the number of exported symbols, it says that we have 65611 symbols which exceeds the max of 65535. Could it maybe be that by backporting the new features, you added just enough code to push the symbol limit over the top?</p>",
        "id": 513311698,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745186892
    },
    {
        "content": "<p>It looks very plausible. I am not sure how to contain that though as new features get added to the REPL.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"521331\">Niels Voss</span> <a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/How.20to.20use.20the.20REPL.20from.20within.20python.3F/near/513301656\">said</a>:</p>\n<blockquote>\n<p>Since I've already gotten <code>repl</code> installed successfully as an executable in my lean 4.7.0 project (in the sense that <code>lake exe repl</code> runs properly), is there a way for me to make Lean Interact or something just use the existing <code>repl</code> instead of trying to manage its own version of the <code>repl</code>?</p>\n</blockquote>\n<p>Regarding using a custom REPL, there is no easy way yet to do so because of the automated management of Lean versions.<br>\nHowever, there is a hack: you can try to inherit from <code>LeanREPLConfig</code> and override the <code>__init__</code> and <code>_setup_repl</code> methods (and don't use <code>super().__init__</code> or <code>super()._setup_repl</code> as they do the versioning management). You might face bugs as the REPL interface has probably changed in the meantime, which might not be completely compatible with what LeanInteract expects.</p>",
        "id": 513311835,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745187055
    },
    {
        "content": "<p>I'll give this a shot, although I'm starting to suspect that maybe updating to Lean v4.8.0 or later on windows is the path of least resistance. If the old repl is indeed just short of the 65535 symbol limit, continuing to use that repl and hoping that we don't go over the top with symbols is a fragile solution at best.</p>",
        "id": 513312058,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745187272
    },
    {
        "content": "<p>Sounds like a good idea. Hopefully, it will work with Lean v4.8.0 <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>",
        "id": 513312124,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745187357
    },
    {
        "content": "<p>Earlier I copied parts of LeanInteract to write this:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Python</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">os</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">subprocess</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">shutil</span>\n<span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">pathlib</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">Path</span>\n<span class=\"kn\">from</span><span class=\"w\"> </span><span class=\"nn\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span> <span class=\"n\">NewType</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">time</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">platform</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">threading</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">logging</span>\n<span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># If I understand correctly, this code does not work on windows because resource is not available.</span>\n<span class=\"c1\"># So, code should check to make sure it isn't running on Windows before calling this.</span>\n<span class=\"c1\"># https://github.com/augustepoiroux/LeanInteract/blob/7b0ed74c2e29fa0ae6bc9d437dc77ab9aa9a4421/src/lean_interact/utils.py#L39</span>\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">_limit_memory</span><span class=\"p\">(</span><span class=\"n\">max_mb</span><span class=\"p\">:</span> <span class=\"nb\">int</span> <span class=\"o\">|</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">\"\"\"Limit the memory usage of the current process.\"\"\"</span>\n    <span class=\"k\">if</span> <span class=\"n\">max_mb</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">resource</span>\n\n        <span class=\"n\">resource</span><span class=\"o\">.</span><span class=\"n\">setrlimit</span><span class=\"p\">(</span><span class=\"n\">resource</span><span class=\"o\">.</span><span class=\"n\">RLIMIT_AS</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">max_mb</span> <span class=\"o\">*</span> <span class=\"mi\">1024</span> <span class=\"o\">*</span> <span class=\"mi\">1024</span><span class=\"p\">,</span> <span class=\"n\">max_mb</span> <span class=\"o\">*</span> <span class=\"mi\">1024</span> <span class=\"o\">*</span> <span class=\"mi\">1024</span><span class=\"p\">))</span>\n        <span class=\"c1\"># logger.info(\"Memory usage limited to %d MB\", max_mb)</span>\n    <span class=\"k\">except</span> <span class=\"ne\">ValueError</span><span class=\"p\">:</span>\n        <span class=\"c1\"># logger.warning(\"Failed to set memory limit to %d MB.\", max_mb)</span>\n        <span class=\"k\">pass</span>\n    <span class=\"k\">except</span> <span class=\"ne\">ImportError</span><span class=\"p\">:</span>\n        <span class=\"c1\"># logger.warning(\"Memory limits not supported on this platform.\")</span>\n        <span class=\"k\">pass</span>\n    <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n        <span class=\"c1\"># logger.warning(\"Error while setting memory limit: %s\", e)</span>\n        <span class=\"k\">pass</span>\n\n<span class=\"c1\"># Currently unused</span>\n<span class=\"n\">LeanEnvironmentId</span> <span class=\"o\">=</span> <span class=\"n\">NewType</span><span class=\"p\">(</span><span class=\"s2\">\"LeanEnvironmentId\"</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">)</span>\n<span class=\"sd\">\"\"\"</span>\n<span class=\"sd\">When the Lean REPL finishes executing a command, it stores the resulting environment and returns</span>\n<span class=\"sd\">its index.</span>\n<span class=\"sd\">Then, when you run another command with the REPL, you can provide that index and reuse the same</span>\n<span class=\"sd\">environment.</span>\n<span class=\"sd\">\"\"\"</span>\n\n<span class=\"k\">class</span><span class=\"w\"> </span><span class=\"nc\">LeanREPL</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">project_directory</span><span class=\"p\">:</span> <span class=\"n\">Path</span><span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">\"\"\"</span>\n<span class=\"sd\">        Opens a repl in project at the current directory. This runs `lake exe repl`, so it requires</span>\n<span class=\"sd\">        REPL to be installed as a lake dependency for that project.</span>\n<span class=\"sd\">        \"\"\"</span>\n\n<span class=\"w\">        </span><span class=\"sd\">'''</span>\n<span class=\"sd\">        path_to_lake: str = shutil.which(\"lake\")</span>\n<span class=\"sd\">        print(f\"Using lake at {path_to_lake}\")</span>\n<span class=\"sd\">        print(f\"Opening REPL at {project_directory}\")</span>\n<span class=\"sd\">        self.repl_subprocess: subprocess.Popen[str] = \\</span>\n<span class=\"sd\">            subprocess.Popen([path_to_lake, \"exe\", \"repl\"], cwd=project_directory, text=True,</span>\n<span class=\"sd\">                            stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE,</span>\n<span class=\"sd\">                            bufsize=1)</span>\n<span class=\"sd\">        self.repl_subprocess.stdin.write('{ \"cmd\": \"def f := 2\" }\\n\\n')</span>\n<span class=\"sd\">        self.repl_subprocess.stdin.flush()</span>\n<span class=\"sd\">        '''</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_lock</span> <span class=\"o\">=</span> <span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Lock</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># https://github.com/augustepoiroux/LeanInteract/blob/7b0ed74c2e29fa0ae6bc9d437dc77ab9aa9a4421/src/lean_interact/server.py#L64-L77</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span> <span class=\"o\">=</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span><span class=\"p\">(</span>\n            <span class=\"c1\">#[\"lake\", \"env\", os.path.join(self.config._cache_repl_dir, \".lake\", \"build\", \"bin\", \"repl\")],</span>\n            <span class=\"p\">[</span><span class=\"s2\">\"lake\"</span><span class=\"p\">,</span> <span class=\"s2\">\"exe\"</span><span class=\"p\">,</span> <span class=\"s2\">\"repl\"</span><span class=\"p\">],</span>\n            <span class=\"n\">cwd</span><span class=\"o\">=</span><span class=\"n\">project_directory</span><span class=\"p\">,</span>\n            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">,</span>\n            <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">,</span>\n            <span class=\"n\">stderr</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">,</span>\n            <span class=\"n\">encoding</span><span class=\"o\">=</span><span class=\"s2\">\"utf-8\"</span><span class=\"p\">,</span>\n            <span class=\"n\">text</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"n\">bufsize</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n            <span class=\"n\">preexec_fn</span><span class=\"o\">=</span><span class=\"kc\">None</span>\n            <span class=\"k\">if</span> <span class=\"n\">platform</span><span class=\"o\">.</span><span class=\"n\">system</span><span class=\"p\">()</span> <span class=\"o\">==</span> <span class=\"s2\">\"Windows\"</span>\n            <span class=\"k\">else</span> <span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"n\">_limit_memory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">memory_hard_limit_mb</span><span class=\"p\">),</span> <span class=\"c1\"># TOOD: Config</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"c1\"># https://github.com/augustepoiroux/LeanInteract/blob/7b0ed74c2e29fa0ae6bc9d437dc77ab9aa9a4421/src/lean_interact/server.py#L108-L139</span>\n    <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">_execute_cmd_in_repl</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">json_query</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">verbose</span><span class=\"p\">:</span> <span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">timeout</span><span class=\"p\">:</span> <span class=\"nb\">float</span> <span class=\"o\">|</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">str</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"sd\">\"\"\"Send JSON queries to the Lean REPL and wait for the standard delimiter.\"\"\"</span>\n        <span class=\"k\">assert</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span><span class=\"o\">.</span><span class=\"n\">stdin</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span><span class=\"o\">.</span><span class=\"n\">stdout</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_lock</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">verbose</span><span class=\"p\">:</span>\n                <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">\"Sending query: </span><span class=\"si\">%s</span><span class=\"s2\">\"</span><span class=\"p\">,</span> <span class=\"n\">json_query</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span><span class=\"o\">.</span><span class=\"n\">stdin</span><span class=\"o\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">json_query</span> <span class=\"o\">+</span> <span class=\"s2\">\"</span><span class=\"se\">\\n\\n</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span><span class=\"o\">.</span><span class=\"n\">stdin</span><span class=\"o\">.</span><span class=\"n\">flush</span><span class=\"p\">()</span>\n\n            <span class=\"n\">output</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">=</span> <span class=\"s2\">\"\"</span>\n\n            <span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">reader</span><span class=\"p\">():</span>\n                <span class=\"c1\"># Read until delimiter \"\\n\\n\" or timeout</span>\n                <span class=\"k\">nonlocal</span> <span class=\"n\">output</span>\n                <span class=\"k\">assert</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span><span class=\"o\">.</span><span class=\"n\">stdout</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n                <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n                    <span class=\"n\">line</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_proc</span><span class=\"o\">.</span><span class=\"n\">stdout</span><span class=\"o\">.</span><span class=\"n\">readline</span><span class=\"p\">()</span>\n                    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">line</span><span class=\"p\">:</span>\n                        <span class=\"k\">break</span>  <span class=\"c1\"># EOF</span>\n                    <span class=\"n\">output</span> <span class=\"o\">+=</span> <span class=\"n\">line</span>\n                    <span class=\"k\">if</span> <span class=\"n\">output</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\n\\n</span><span class=\"s2\">\"</span><span class=\"p\">):</span>\n                        <span class=\"k\">break</span>\n\n            <span class=\"n\">t</span> <span class=\"o\">=</span> <span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Thread</span><span class=\"p\">(</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">reader</span><span class=\"p\">)</span>\n            <span class=\"n\">t</span><span class=\"o\">.</span><span class=\"n\">start</span><span class=\"p\">()</span>\n            <span class=\"n\">t</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">timeout</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">t</span><span class=\"o\">.</span><span class=\"n\">is_alive</span><span class=\"p\">():</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">kill</span><span class=\"p\">()</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">TimeoutError</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">\"The Lean server did not respond in time (</span><span class=\"si\">{</span><span class=\"n\">timeout</span><span class=\"si\">=}</span><span class=\"s2\">) and is now killed.\"</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">output</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">output</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">BrokenPipeError</span><span class=\"p\">(</span><span class=\"s2\">\"The Lean server returned no output.\"</span><span class=\"p\">)</span>\n</code></pre></div>\n</div></div>\n<p>and it hung forever when running <code>_execute_cmd_in_repl</code>. This was the same issue I was getting at the top of this thread when running subprocess. It could be that the Lean REPL was just broken in v4.7.0 and I need to use your modified version to get it to work</p>",
        "id": 513312207,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745187446
    },
    {
        "content": "<p>There is this <a href=\"https://github.com/leanprover-community/repl/commit/4fc1e6d1dda170e8f0a6b698dd5f7e17a9cf52b4\">commit</a> adding flushing to the repl after the v4.7.0 tag, so maybe.</p>",
        "id": 513312504,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745187735
    },
    {
        "content": "<p>At first glance, v4.8.0 seems to be working. I haven't tested it on a project yet, but here's a quick interaction with python:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>PS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; python\nPython 3.13.2 (tags/v3.13.2:4f8bb39, Feb  4 2025, 15:23:48) [MSC v.1942 64 bit (AMD64)] on win32\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; import lean_interact\n&gt;&gt;&gt; from lean_interact import LocalProject, LeanREPLConfig, LeanServer\n&gt;&gt;&gt; config = LeanREPLConfig(lean_version=\"v4.8.0\", verbose=True)\ninfo: Version 4.0.1 of elan is available! Use `elan self update` to update.\ninfo: downloading component 'lean'\n180.8 MiB / 180.8 MiB (100 %)  20.0 MiB/s ETA:   0 s\ninfo: installing component 'lean'\nBuild completed successfully.\n&gt;&gt;&gt; server = LeanServer(config)\n&gt;&gt;&gt; from lean_interact import Command\n&gt;&gt;&gt; server.run(Command(cmd=\"def f := 2\"))\nCommandResponse(env=0)\n&gt;&gt;&gt; server.run(Command(cmd=\"def f := 2\"))\nCommandResponse(env=1)\n&gt;&gt;&gt;\n</code></pre></div>",
        "id": 513312539,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745187775
    },
    {
        "content": "<p>Nice, let's see how it goes. I am also thinking that using WSL (Windows Subsystem for Linux) might be an option as well if you need v4.7.0</p>",
        "id": 513312593,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745187841
    },
    {
        "content": "<p>Hopefully Lean 4.7.0 is not strictly necessary, but I can check out WSL if it is. The main reason we're on such an outdated version of Lean is because we were doing stuff with proofs from the Natural Number Game, which is still on v4.7.0, and my team doesn't want to update unless strictly necessary because they're worried it might break stuff. But it seems it is strictly necessary to update, so that'll probably be what we try next.</p>",
        "id": 513312745,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745187982
    },
    {
        "content": "<p>I should think that bumping NNG would be easy unless it also needs a bump of Lean4game in which case I have no idea how easy it will be</p>",
        "id": 513313154,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745188416
    },
    {
        "content": "<p>I can maybe give that a shot tomorrow. Lean4Game is still on 4.7.0, so it looks like it might not be that easy to port. We only need the proofs from NNG4, not the actual game server, so updating is probably not that big of a deal. (Although in the long run, updating NNG4 is probably the right thing to do)</p>",
        "id": 513313340,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745188564
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"521331\">Niels Voss</span> <a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/How.20to.20use.20the.20REPL.20from.20within.20python.3F/near/513302128\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"657996\">Amitayush Thakur</span> <a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/How.20to.20use.20the.20REPL.20from.20within.20python.3F/near/513282496\">said</a>:</p>\n<blockquote>\n<p>Please checkout:<br>\n<a href=\"https://github.com/trishullab/itp-interface\">https://github.com/trishullab/itp-interface</a><br>\nIt does what you are trying to do and can run a scale across multiple ray cluster nodes (and on multiple Lean versions). One can also perform scalable proof search using our other framework:<br>\n<a href=\"https://github.com/trishullab/proof-wala\">https://github.com/trishullab/proof-wala</a></p>\n</blockquote>\n<p>Does <code>itp-interface</code> work on windows? I'm getting a \"No module named 'termios'\" error when trying to run it, and I think termios is not available on windows.</p>\n</blockquote>\n<p>Right now it doesn't work on Windows natively, but you can always use WSL.</p>",
        "id": 513314275,
        "sender_full_name": "Amitayush Thakur",
        "timestamp": 1745189531
    },
    {
        "content": "<p>Thank you, that's helpful to know. I think right now I'm going to try to get Lean Interact working because it's closer to a one-to-one correspondence with the REPL, which is what I need, but I'll probably check out itp-interface in the future.</p>",
        "id": 513314322,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745189617
    },
    {
        "content": "<p>So far, after updating the project to Lean 4.8.0, Lean Interact seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>PS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; python\nPython 3.13.2 (tags/v3.13.2:4f8bb39, Feb  4 2025, 15:23:48) [MSC v.1942 64 bit (AMD64)] on win32\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; from lean_interact import LocalProject, LeanREPLConfig, LeanServer, Command\n&gt;&gt;&gt; config = LeanREPLConfig(project=LocalProject(\".\"), verbose=True)\nBuild completed successfully.\nBuild completed successfully.\n&gt;&gt;&gt; server = LeanServer(config)\n&gt;&gt;&gt; server.run(Command(cmd=\"def f := 2\"))\nCommandResponse(env=0)\n&gt;&gt;&gt; server.run(Command(cmd=\"import Game\"))\nCommandResponse(env=1)\n&gt;&gt;&gt; server.run(Command(cmd=\"import Game\"))\nCommandResponse(env=2)\n&gt;&gt;&gt;\n</code></pre></div>\n<p>I think the Lean 4.7.0 -&gt; 4.8.0 transition was not too bad, with the only major change being that <code>Std</code> (which was a separate repository at the time, and is unrelated to the current <code>Std</code>) was renamed to <code>Batteries</code>. But just changing a few imports fixes this.</p>",
        "id": 513314519,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745189852
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321854\">@Auguste Poiroux</span> Thank you for all the help, and I really appreciate the time you spent writing Lean Interact!</p>",
        "id": 513314618,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745189942
    },
    {
        "content": "<p>Thank you! I hope your project goes well from here :) Looking forward to reading your work using NNG</p>",
        "id": 513315036,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745190336
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"521331\">Niels Voss</span> <a href=\"#narrow/channel/219941-Machine-Learning-for-Theorem-Proving/topic/How.20to.20use.20the.20REPL.20from.20within.20python.3F/near/513314519\">said</a>:</p>\n<blockquote>\n<p>So far, after updating the project to Lean 4.8.0, Lean Interact seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>PS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; python\nPython 3.13.2 (tags/v3.13.2:4f8bb39, Feb  4 2025, 15:23:48) [MSC v.1942 64 bit (AMD64)] on win32\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; from lean_interact import LocalProject, LeanREPLConfig, LeanServer, Command\n&gt;&gt;&gt; config = LeanREPLConfig(project=LocalProject(\".\"), verbose=True)\nBuild completed successfully.\nBuild completed successfully.\n&gt;&gt;&gt; server = LeanServer(config)\n&gt;&gt;&gt; server.run(Command(cmd=\"def f := 2\"))\nCommandResponse(env=0)\n&gt;&gt;&gt; server.run(Command(cmd=\"import Game\"))\nCommandResponse(env=1)\n&gt;&gt;&gt; server.run(Command(cmd=\"import Game\"))\nCommandResponse(env=2)\n&gt;&gt;&gt;\n</code></pre></div>\n<p>I think the Lean 4.7.0 -&gt; 4.8.0 transition was not too bad, with the only major change being that <code>Std</code> (which was a separate repository at the time, and is unrelated to the current <code>Std</code>) was renamed to <code>Batteries</code>. But just changing a few imports fixes this.</p>\n</blockquote>\n<p>Oh one last thing (hopefully): imports in commands never crash (see this <a href=\"https://github.com/leanprover-community/repl/pull/73\">PR</a>), so your test doesn't really check if it's working yet...</p>",
        "id": 513315211,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745190499
    },
    {
        "content": "<p>I ran <code>#check</code> on a symbol that was imported so hopefully this is a sign that it works fine.</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>PS C:\\Users\\niels\\Documents\\Projects\\LeanTutor\\NNG4&gt; python\nPython 3.13.2 (tags/v3.13.2:4f8bb39, Feb  4 2025, 15:23:48) [MSC v.1942 64 bit (AMD64)] on win32\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n&gt;&gt;&gt; from lean_interact import LocalProject, LeanREPLConfig, LeanServer, Command\n&gt;&gt;&gt; config = LeanREPLConfig(project=LocalProject(\".\"), verbose=True)\nBuild completed successfully.\nBuild completed successfully.\n&gt;&gt;&gt; server = LeanServer(config)\n&gt;&gt;&gt; server.run(Command(cmd=\"import Game\"))\nCommandResponse(env=0)\n&gt;&gt;&gt; server.run(Command(cmd=\"#check MyNat\",env=0))\nCommandResponse(env=1, messages=[Message(data='MyNat : Type', severity='info', start_pos=Pos(line=1, column=0), end_pos=Pos(line=1, column=6))])\n&gt;&gt;&gt; server.run(Command(cmd=\"#check MyNat\")) # no env, so this should hopefully fail\nCommandResponse(env=2, messages=[Message(data=\"unknown identifier 'MyNat'\", severity='error', start_pos=Pos(line=1, column=7), end_pos=Pos(line=1, column=12))])\n&gt;&gt;&gt;\n</code></pre></div>",
        "id": 513315329,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745190659
    },
    {
        "content": "<p>Oh yeah, since I just remembered that I'm using the unreleased version of LeanInteract, and not the version on PyPI, do you know when the PR you opened yesterday might be merged? (No worries if it's not anytime soon, I'm perfectly fine using a version not on PyPI)</p>",
        "id": 513315647,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745191056
    },
    {
        "content": "<p>Hopefully this will be merged during the week. I am trying to have a working CI for windows to avoid regressions <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 513315993,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745191438
    },
    {
        "content": "<p>Another use-case that might be interesting is library building (i.e. LegoProver). <br>\nUse tactic mode to find proofs, and them manifest these proofs in the environment somehow.<br>\nThe only way I know of to accomplish this is to manually track tactic strings and indent them correctly before sending a command to the REPL containing the theorem with proof.</p>\n<p>For large-scale projects, it would also be nice to have a way to share environments with various REPL instances. Pickling works, but shares the whole environment. If one had two REPL instances that already have the same environment, it would be nice to only share the delta. For now, one simply needs to manifest the same theorem in each REPL instance.</p>",
        "id": 513377694,
        "sender_full_name": "Simon Sorg",
        "timestamp": 1745230866
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"521331\">@Niels Voss</span> <a href=\"https://pypi.org/project/lean-interact/\">v0.5.0</a> of LeanInteract with Windows compatibility is released on PyPI ;)</p>",
        "id": 513453795,
        "sender_full_name": "Auguste Poiroux",
        "timestamp": 1745262051
    },
    {
        "content": "<p>Thank you so much! You're the best</p>",
        "id": 513463332,
        "sender_full_name": "Niels Voss",
        "timestamp": 1745266338
    }
]