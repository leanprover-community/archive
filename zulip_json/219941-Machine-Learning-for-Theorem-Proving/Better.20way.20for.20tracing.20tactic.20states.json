[
    {
        "content": "<p>I remember earlier last year (2024) having a conversation with <span class=\"user-mention\" data-user-id=\"115715\">@Jason Rute</span>  about how to break down <code>induction n with | zero =&gt; ... | succ n =&gt; ...</code> type blocks when generating pretraining data for LeanCopilote and other tactic based HyperTree search systems.  Apparently there had been attempts to replace each subgoal with <code>?_</code> but they always turned out a bit hacky. However it seems with the new <code>allTactics</code> flag for LeanRepl it is quite easy to find all of the atomic tactics in a proof. We can then look for the infotree nodes of each atomic tactic and make sure that the syntax position of all of its children is replaced with <code>?_</code>. Here is the python code for my example: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">subprocess</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">json</span>\n\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Tuple</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">apply_replacements</span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">,</span>\n<span class=\"w\">                       </span><span class=\"n\">replacements</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">[</span><span class=\"n\">Tuple</span><span class=\"o\">[</span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">]])</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">    replacements: List of (start_line, start_col, end_line, end_col, replacement_string)</span>\n<span class=\"s2\">    Lines are 1-indexed, columns are 0-indexed.</span>\n<span class=\"s2\">    \"\"\"</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Split</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">endings</span><span class=\"w\"> </span><span class=\"n\">preserved</span>\n<span class=\"w\">    </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">splitlines</span><span class=\"o\">(</span><span class=\"n\">keepends</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Compute</span><span class=\"w\"> </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"n\">offsets</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"bp\">/</span><span class=\"n\">column</span><span class=\"w\"> </span><span class=\"n\">positions</span>\n<span class=\"w\">    </span><span class=\"n\">line_offsets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">line_offsets</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">))</span>\n\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">col</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Convert</span><span class=\"w\"> </span><span class=\"n\">replacements</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">absolute</span><span class=\"w\"> </span><span class=\"n\">offsets</span>\n<span class=\"w\">    </span><span class=\"n\">abs_replacements</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">sl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">el</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">el</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">replacements</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">descending</span>\n<span class=\"w\">    </span><span class=\"n\">abs_replacements</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"o\">(</span><span class=\"n\">reverse</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"bp\">=</span><span class=\"n\">lambda</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Apply</span><span class=\"w\"> </span><span class=\"n\">replacements</span>\n<span class=\"w\">    </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">end</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">abs_replacements</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">[:</span><span class=\"n\">start</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">[</span><span class=\"kn\">end</span><span class=\"o\">:]</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">,</span>\n<span class=\"w\">                       </span><span class=\"n\">row</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">    Given a string and a (1-indexed) line number and (0-indexed) column number,</span>\n<span class=\"s2\">    return the absolute character offset in the string.</span>\n<span class=\"s2\">    \"\"\"</span>\n<span class=\"w\">    </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">splitlines</span><span class=\"o\">(</span><span class=\"n\">keepends</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Precompute</span><span class=\"w\"> </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"n\">offsets</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">line_offsets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">line_offsets</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">))</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">lines</span><span class=\"o\">):</span>\n<span class=\"w\">        </span><span class=\"n\">raise</span><span class=\"w\"> </span><span class=\"n\">ValueError</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Row {row} out of range (1..{len(lines)})\"</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">col</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">pos1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">pos1</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">]:</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">pos1</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"o\">[</span><span class=\"s2\">\"children\"</span><span class=\"o\">]:</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;failed to pretty print&gt;\"</span><span class=\"o\">:</span>\n<span class=\"w\">          </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"?_\"</span><span class=\"o\">,)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">],)</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">temp</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">else</span><span class=\"o\">:</span>\n<span class=\"w\">          </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">+=</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">out</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">infotree</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">try</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">stxRange</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">]</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">isinstance</span><span class=\"o\">(</span><span class=\"n\">stxRange</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dict</span><span class=\"o\">):</span>\n<span class=\"w\">                </span><span class=\"n\">continue</span>\n<span class=\"w\">        </span><span class=\"n\">except</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">KeyError</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">TypeError</span><span class=\"o\">):</span>\n<span class=\"w\">            </span><span class=\"n\">continue</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">tree</span>\n\n<span class=\"w\">        </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">(</span><span class=\"s2\">\"children\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[]),</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">temp</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">None</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">name__</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"__main__\"</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">source_code</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"s2\">\"theorem womp (n : Nat): 2 + 2 = 5 := by</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" rw [Nat.add_comm]; rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" induction n with</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" | zero =&gt; sorry</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" | succ n =&gt; sorry\"</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">Popen</span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"o\">[</span><span class=\"s2\">\"lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"exe\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"repl\"</span><span class=\"o\">],</span>\n<span class=\"w\">        </span><span class=\"n\">stdin</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">stdout</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">stderr</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">text</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">encoding</span><span class=\"bp\">=</span><span class=\"s2\">\"utf-8\"</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">payload</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"s2\">\"cmd\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">source_code</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"infotree\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"original\"</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"allTactics\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">communicate</span><span class=\"o\">(</span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">dumps</span><span class=\"o\">(</span><span class=\"n\">payload</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">feedback</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">loads</span><span class=\"o\">(</span><span class=\"n\">stdout</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Feedback loaded\"</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">feedback</span><span class=\"o\">[</span><span class=\"s2\">\"infotree\"</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">tactics_info</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">feedback</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">(</span><span class=\"s2\">\"tactics\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tactics_info</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">pp_name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"o\">[</span><span class=\"s2\">\"tactic\"</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">tactic_node</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pp_name</span><span class=\"o\">)</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">None</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Could not find node for tactic: {pp_name}\"</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"n\">continue</span>\n\n<span class=\"w\">        </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">]</span>\n\n<span class=\"w\">        </span><span class=\"n\">sub_ranges</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">tactic_node</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">modified_src</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">apply_replacements</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sub_ranges</span><span class=\"o\">)</span>\n\n<span class=\"w\">        </span><span class=\"n\">start_offset</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"n\">end_offset</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n\n<span class=\"w\">        </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Extract</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">final</span><span class=\"w\"> </span><span class=\"n\">cleaned</span><span class=\"bp\">-</span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">string</span>\n<span class=\"w\">        </span><span class=\"n\">cleaned_tactic</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">modified_src</span><span class=\"o\">[</span><span class=\"n\">start_offset</span><span class=\"o\">:</span><span class=\"n\">end_offset</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">cleaned_tactic</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"--\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Note that this sort of thing should also handle have statements by basically turning them into suffices. If any one has any examples that break this or general feedback that would be great.</p>",
        "id": 525809569,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1750900170
    },
    {
        "content": "<p>Also if anyone has done something similar pls share your code</p>",
        "id": 525809679,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1750900298
    },
    {
        "content": "<p>I found a slight cropping bug which i fixed in the below version: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">subprocess</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">json</span>\n\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Tuple</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">apply_replacements</span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">,</span>\n<span class=\"w\">                       </span><span class=\"n\">replacements</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">[</span><span class=\"n\">Tuple</span><span class=\"o\">[</span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">]])</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">    replacements: List of (start_line, start_col, end_line, end_col, replacement_string)</span>\n<span class=\"s2\">    Lines are 1-indexed, columns are 0-indexed.</span>\n<span class=\"s2\">    \"\"\"</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Split</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">endings</span><span class=\"w\"> </span><span class=\"n\">preserved</span>\n<span class=\"w\">    </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">splitlines</span><span class=\"o\">(</span><span class=\"n\">keepends</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Compute</span><span class=\"w\"> </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"n\">offsets</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"bp\">/</span><span class=\"n\">column</span><span class=\"w\"> </span><span class=\"n\">positions</span>\n<span class=\"w\">    </span><span class=\"n\">line_offsets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">line_offsets</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">))</span>\n\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">col</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Convert</span><span class=\"w\"> </span><span class=\"n\">replacements</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">absolute</span><span class=\"w\"> </span><span class=\"n\">offsets</span>\n<span class=\"w\">    </span><span class=\"n\">abs_replacements</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">sl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">el</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">el</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">replacements</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">descending</span>\n<span class=\"w\">    </span><span class=\"n\">abs_replacements</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"o\">(</span><span class=\"n\">reverse</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"bp\">=</span><span class=\"n\">lambda</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Apply</span><span class=\"w\"> </span><span class=\"n\">replacements</span>\n<span class=\"w\">    </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">end</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">abs_replacements</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">[:</span><span class=\"n\">start</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">[</span><span class=\"kn\">end</span><span class=\"o\">:]</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">,</span>\n<span class=\"w\">                       </span><span class=\"n\">row</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">    Given a string and a (1-indexed) line number and (0-indexed) column number,</span>\n<span class=\"s2\">    return the absolute character offset in the string.</span>\n<span class=\"s2\">    \"\"\"</span>\n<span class=\"w\">    </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">splitlines</span><span class=\"o\">(</span><span class=\"n\">keepends</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Precompute</span><span class=\"w\"> </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"n\">offsets</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">line_offsets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">line_offsets</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">))</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">lines</span><span class=\"o\">):</span>\n<span class=\"w\">        </span><span class=\"n\">raise</span><span class=\"w\"> </span><span class=\"n\">ValueError</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Row {row} out of range (1..{len(lines)})\"</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">col</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">pos1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">pos1</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">]:</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">pos1</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"o\">[</span><span class=\"s2\">\"children\"</span><span class=\"o\">]:</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;failed to pretty print&gt;\"</span><span class=\"o\">:</span>\n<span class=\"w\">          </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"?_\"</span><span class=\"o\">,)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">],)</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">temp</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">else</span><span class=\"o\">:</span>\n<span class=\"w\">          </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">+=</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">out</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">infotree</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">try</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">stxRange</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">]</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">isinstance</span><span class=\"o\">(</span><span class=\"n\">stxRange</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dict</span><span class=\"o\">):</span>\n<span class=\"w\">                </span><span class=\"n\">continue</span>\n<span class=\"w\">        </span><span class=\"n\">except</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">KeyError</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">TypeError</span><span class=\"o\">):</span>\n<span class=\"w\">            </span><span class=\"n\">continue</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">tree</span>\n\n<span class=\"w\">        </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">(</span><span class=\"s2\">\"children\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[]),</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">temp</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">None</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">name__</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"__main__\"</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">source_code</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"s2\">\"theorem womp (n : Nat): 2 + 2 = 5 := by</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" rw [Nat.add_comm]; rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" induction n with</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" | zero =&gt; sorry</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" | succ n =&gt; sorry\"</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">Popen</span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"o\">[</span><span class=\"s2\">\"lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"exe\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"repl\"</span><span class=\"o\">],</span>\n<span class=\"w\">        </span><span class=\"n\">stdin</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">stdout</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">stderr</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">text</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">encoding</span><span class=\"bp\">=</span><span class=\"s2\">\"utf-8\"</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">payload</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"s2\">\"cmd\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">source_code</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"infotree\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"original\"</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"allTactics\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">communicate</span><span class=\"o\">(</span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">dumps</span><span class=\"o\">(</span><span class=\"n\">payload</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">feedback</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">loads</span><span class=\"o\">(</span><span class=\"n\">stdout</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Feedback loaded\"</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">feedback</span><span class=\"o\">[</span><span class=\"s2\">\"infotree\"</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">tactics_info</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">feedback</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">(</span><span class=\"s2\">\"tactics\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tactics_info</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">pp_name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"o\">[</span><span class=\"s2\">\"tactic\"</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">tactic_node</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pp_name</span><span class=\"o\">)</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">None</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Could not find node for tactic: {pp_name}\"</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"n\">continue</span>\n\n<span class=\"w\">        </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">]</span>\n\n<span class=\"w\">        </span><span class=\"n\">sub_ranges</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">tactic_node</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">modified_src</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">apply_replacements</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sub_ranges</span><span class=\"o\">)</span>\n\n<span class=\"w\">        </span><span class=\"n\">start_offset</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"n\">end_offset</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n\n<span class=\"w\">        </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Extract</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">final</span><span class=\"w\"> </span><span class=\"n\">cleaned</span><span class=\"bp\">-</span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">string</span>\n<span class=\"w\">        </span><span class=\"n\">cleaned_tactic</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">modified_src</span><span class=\"o\">[</span><span class=\"n\">start_offset</span><span class=\"o\">:</span><span class=\"n\">end_offset</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">modified_src</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">))]</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">cleaned_tactic</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"--\"</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 525810192,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1750900792
    },
    {
        "content": "<p>i fixed another bug with the slicing</p>",
        "id": 526209735,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1751123532
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">subprocess</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">json</span>\n\n<span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">typing</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Tuple</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">apply_replacements</span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">,</span>\n<span class=\"w\">                       </span><span class=\"n\">replacements</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"o\">[</span><span class=\"n\">Tuple</span><span class=\"o\">[</span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">]])</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">    replacements: List of (start_line, start_col, end_line, end_col, replacement_string)</span>\n<span class=\"s2\">    Lines are 1-indexed, columns are 0-indexed.</span>\n<span class=\"s2\">    \"\"\"</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Split</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">endings</span><span class=\"w\"> </span><span class=\"n\">preserved</span>\n<span class=\"w\">    </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">splitlines</span><span class=\"o\">(</span><span class=\"n\">keepends</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Compute</span><span class=\"w\"> </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"n\">offsets</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"bp\">/</span><span class=\"n\">column</span><span class=\"w\"> </span><span class=\"n\">positions</span>\n<span class=\"w\">    </span><span class=\"n\">line_offsets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">line_offsets</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">))</span>\n\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">col</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Convert</span><span class=\"w\"> </span><span class=\"n\">replacements</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">absolute</span><span class=\"w\"> </span><span class=\"n\">offsets</span>\n<span class=\"w\">    </span><span class=\"n\">abs_replacements</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">sl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">to_offset</span><span class=\"o\">(</span><span class=\"n\">el</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sl</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sc</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">el</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ec</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">replacements</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">descending</span>\n<span class=\"w\">    </span><span class=\"n\">abs_replacements</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"o\">(</span><span class=\"n\">reverse</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"bp\">=</span><span class=\"n\">lambda</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Step</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Apply</span><span class=\"w\"> </span><span class=\"n\">replacements</span>\n<span class=\"w\">    </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">end</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">abs_replacements</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">[:</span><span class=\"n\">start</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">rep</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">[</span><span class=\"kn\">end</span><span class=\"o\">:]</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">,</span>\n<span class=\"w\">                       </span><span class=\"n\">row</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"s2\">\"\"\"</span>\n<span class=\"s2\">    Given a string and a (1-indexed) line number and (0-indexed) column number,</span>\n<span class=\"s2\">    return the absolute character offset in the string.</span>\n<span class=\"s2\">    \"\"\"</span>\n<span class=\"w\">    </span><span class=\"n\">lines</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">splitlines</span><span class=\"o\">(</span><span class=\"n\">keepends</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Precompute</span><span class=\"w\"> </span><span class=\"n\">character</span><span class=\"w\"> </span><span class=\"n\">offsets</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">each</span><span class=\"w\"> </span><span class=\"n\">line</span>\n<span class=\"w\">    </span><span class=\"n\">line_offsets</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lines</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">line_offsets</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">line</span><span class=\"o\">))</span>\n\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">lines</span><span class=\"o\">):</span>\n<span class=\"w\">        </span><span class=\"n\">raise</span><span class=\"w\"> </span><span class=\"n\">ValueError</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Row {row} out of range (1..{len(lines)})\"</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">line_offsets</span><span class=\"o\">[</span><span class=\"n\">row</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">col</span>\n\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pos</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">pos1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">):</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">pos1</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">]:</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">pos1</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">pos2</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"o\">[</span><span class=\"s2\">\"children\"</span><span class=\"o\">]:</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">posLt</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;failed to pretty print&gt;\"</span><span class=\"o\">:</span>\n<span class=\"w\">          </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">posToTup</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"?_\"</span><span class=\"o\">,)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">],)</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">out</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"o\">(</span><span class=\"n\">temp</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">else</span><span class=\"o\">:</span>\n<span class=\"w\">          </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"bp\">+=</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">out</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">):</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">infotree</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">try</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">stxRange</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">]</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">isinstance</span><span class=\"o\">(</span><span class=\"n\">stxRange</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dict</span><span class=\"o\">):</span>\n<span class=\"w\">                </span><span class=\"n\">continue</span>\n<span class=\"w\">        </span><span class=\"n\">except</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">KeyError</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">TypeError</span><span class=\"o\">):</span>\n<span class=\"w\">            </span><span class=\"n\">continue</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">tree</span>\n\n<span class=\"w\">        </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">(</span><span class=\"s2\">\"children\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[]),</span><span class=\"w\"> </span><span class=\"n\">ppName</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">temp</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">None</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">name__</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"s2\">\"__main__\"</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">source_code</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"s2\">\"theorem womp (n : Nat): 2 + 2 = 5 := by</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" have womp : 2 + 2 = 4 := by</span><span class=\"se\">\\n</span><span class=\"s2\">  rw [Nat.add_comm, Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">  rfl</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" rw [Nat.add_comm]; rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" induction n with</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" | zero =&gt; sorry</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">        </span><span class=\"s2\">\" | succ n =&gt; sorry\"</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">Popen</span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"o\">[</span><span class=\"s2\">\"lake\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"exe\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"repl\"</span><span class=\"o\">],</span>\n<span class=\"w\">        </span><span class=\"n\">stdin</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">stdout</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">stderr</span><span class=\"bp\">=</span><span class=\"n\">subprocess</span><span class=\"bp\">.</span><span class=\"n\">PIPE</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">text</span><span class=\"bp\">=</span><span class=\"n\">True</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"n\">encoding</span><span class=\"bp\">=</span><span class=\"s2\">\"utf-8\"</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">payload</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"s2\">\"cmd\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">source_code</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"infotree\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"original\"</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"allTactics\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"bp\">.</span><span class=\"n\">communicate</span><span class=\"o\">(</span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">dumps</span><span class=\"o\">(</span><span class=\"n\">payload</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">feedback</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">json</span><span class=\"bp\">.</span><span class=\"n\">loads</span><span class=\"o\">(</span><span class=\"n\">stdout</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"Feedback loaded\"</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">feedback</span><span class=\"o\">[</span><span class=\"s2\">\"infotree\"</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">tactics_info</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">feedback</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">(</span><span class=\"s2\">\"tactics\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"---\"</span><span class=\"o\">)</span>\n\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">tactics_info</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"n\">pp_name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"o\">[</span><span class=\"s2\">\"tactic\"</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">tactic_node</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getTacticNode</span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pp_name</span><span class=\"o\">)</span>\n\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">None</span><span class=\"o\">:</span>\n<span class=\"w\">            </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"s2\">\"Could not find node for tactic: {pp_name}\"</span><span class=\"o\">)</span>\n<span class=\"w\">            </span><span class=\"n\">continue</span>\n\n<span class=\"w\">        </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">tactic_node</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"pp\"</span><span class=\"o\">])</span>\n\n<span class=\"w\">        </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"start\"</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">finish</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">tactic_node</span><span class=\"o\">[</span><span class=\"s2\">\"node\"</span><span class=\"o\">][</span><span class=\"s2\">\"stx\"</span><span class=\"o\">][</span><span class=\"s2\">\"range\"</span><span class=\"o\">][</span><span class=\"s2\">\"finish\"</span><span class=\"o\">]</span>\n\n<span class=\"w\">        </span><span class=\"n\">sub_ranges</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">getSubNodes</span><span class=\"o\">(</span><span class=\"n\">tactic_node</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">modified_src</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">apply_replacements</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">sub_ranges</span><span class=\"o\">)</span>\n\n<span class=\"w\">        </span><span class=\"n\">start_offset</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"n\">end_offset</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">position_to_offset</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">[</span><span class=\"s2\">\"line\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">finish</span><span class=\"o\">[</span><span class=\"s2\">\"column\"</span><span class=\"o\">])</span>\n\n<span class=\"w\">        </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">Extract</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">final</span><span class=\"w\"> </span><span class=\"n\">cleaned</span><span class=\"bp\">-</span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">string</span>\n<span class=\"w\">        </span><span class=\"n\">cleaned_tactic</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">modified_src</span><span class=\"o\">[</span><span class=\"n\">start_offset</span><span class=\"o\">:</span><span class=\"n\">end_offset</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">source_code</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"o\">(</span><span class=\"n\">modified_src</span><span class=\"o\">))]</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"n\">cleaned_tactic</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"n\">print</span><span class=\"o\">(</span><span class=\"s2\">\"--\"</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 526209740,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1751123539
    },
    {
        "content": "<p>here is sample output </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Feedback</span><span class=\"w\"> </span><span class=\"n\">loaded</span>\n<span class=\"c1\">---</span>\n<span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">womp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"bp\">?_</span>\n<span class=\"w\">  </span><span class=\"bp\">?_</span>\n<span class=\"c1\">--</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"c1\">--</span>\n<span class=\"n\">rfl</span>\n<span class=\"c1\">--</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"c1\">--</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"c1\">--</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n<span class=\"c1\">--</span>\n<span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"c1\">--</span>\n<span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"c1\">--</span>\n<span class=\"gr\">sorry</span>\n<span class=\"c1\">--</span>\n<span class=\"gr\">sorry</span>\n<span class=\"c1\">--</span>\n</code></pre></div>",
        "id": 526209809,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1751123623
    },
    {
        "content": "<p>seems like have statements are still handled incorrectly</p>",
        "id": 526209894,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1751123721
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">REPL</span><span class=\"bp\">.</span><span class=\"n\">Frontend</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">REPL</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">InfoTree</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">REPL</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">applyReplacements</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">replacements</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">replacementStr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Step 1: Sort by start position descending so earlier edits don't shift later ones</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sorted</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">replacements</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">qsort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toList</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Step 2: Apply the replacements</span>\n<span class=\"w\">  </span><span class=\"n\">sorted</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">startPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">replacementStr</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"n\">acc</span><span class=\"bp\">.</span><span class=\"n\">endPos</span>\n<span class=\"w\">  </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">src</span>\n\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Json</span><span class=\"bp\">.</span><span class=\"n\">getObjValD</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">findAllInfoTree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Info</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">findAllInfoTree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">mergeIntoOuter?</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\">  </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rest</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">flatMap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">findAllInfoTree</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">rest</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">findTacticInfoTrees</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TacticInfo</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">findAllInfoTree</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofTacticInfo</span><span class=\"w\"> </span><span class=\"n\">i'</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">isOriginal</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">i'</span><span class=\"bp\">.</span><span class=\"n\">isSubstantive</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">  </span><span class=\"n\">infos</span><span class=\"bp\">.</span><span class=\"n\">filterMapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofTacticInfo</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">runMetaM</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">ppTactic</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\"></span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getSubNodePositions</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">getSubNodePositions</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">mergeIntoOuter?</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">flag</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">runMetaM</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"n\">try</span>\n<span class=\"w\">          </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">ppTactic</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\"></span>\n<span class=\"w\">          </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofTacticInfo</span><span class=\"w\">  </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\">                   </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">        </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">flag</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"o\">)]</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">children</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getSubNodePositions</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">startPos</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">join</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">hole</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">  add holes of form ?_ to all subnodes of compound tactic combinator `infotree`</span>\n<span class=\"cm\">-/</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">add_subnode_holes</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">ContextInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">add_subnode_holes</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">mergeIntoOuter?</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">children</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">ctx?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getRange?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">subPos</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">getSubNodePositions</span><span class=\"w\"> </span><span class=\"n\">infotree</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"n\">ctx</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">applyReplacements</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"n\">subPos</span><span class=\"w\"> </span><span class=\"s2\">\"?_\"</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"bp\">.</span><span class=\"n\">extract</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"n\">stop</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">temp</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"bp\"></span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">hole</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">join</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"theorem womp (n : Nat): 2 + 2 = 5 := by</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\" have womp : 2 + 2 = 4 := by</span><span class=\"se\">\\n</span><span class=\"s2\">  rw [Nat.add_comm, Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">  rfl</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\" rw [Nat.add_comm]; rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\" rw [Nat.add_comm]</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\" induction n with</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\" | zero =&gt; sorry</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"s2\">\" | succ n =&gt; sorry\"</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">lol</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">processInput</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">flatMap</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">retainTacticInfo</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">flatMap</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">retainOriginal</span><span class=\"o\">)[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">findTacticInfoTrees</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span>\n<span class=\"w\">    </span><span class=\"c1\">-- IO.println z</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"----\"</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">add_subnode_holes</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"----\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">lol</span>\n\n<span class=\"c1\">-- #eval do return applyReplacements test ( InfoTree.getSubNodePositions ( InfoTree.findTacticInfoTrees (( IO.processInput test none).2.2.flatMap InfoTree.retainOriginal)[0]!)[6]!) \"?_\"</span>\n</code></pre></div>",
        "id": 526299086,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1751236444
    },
    {
        "content": "<p>my end goal is that given a lean proof you can generate this a <code>HashMap GoalState String</code> that can be used as a tacgen heuristic that will allow <code>aesop</code> to immediately prove the end goal. This basically generates a proof search tree that only contains the input proof. Then, we can randomly remove nodes (or edges) from this search graph to generate synthetic RL curriculumn for problems that are hard for current tactic state based models to prove. Obviously this would need to be along side some sort of RL mechanism within aesop</p>",
        "id": 526299315,
        "sender_full_name": "Frederick Pu",
        "timestamp": 1751236815
    }
]