[
    {
        "content": "<p>Moving the discussion here to avoid cluttering the other thread: is it known that docPrime will flood <code>lake build</code> output for downstream project if there is nothing to build? I mean nothing in Mathlib and nothing in the downstream project.</p>",
        "id": 492360780,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736273354
    },
    {
        "content": "<p>Note that this happens in a situation where I don’t have oleans for all files in Mathlib, only for the files that are imported in my project.</p>",
        "id": 492360853,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736273389
    },
    {
        "content": "<p>Maybe I could un-xy this to: could we simply turn this linter off until it behaves properly?</p>",
        "id": 492360956,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736273422
    },
    {
        "content": "<p>If you are building Mathlib from scratch, can you not just update the lakefile to disable the linter?</p>",
        "id": 492361057,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736273468
    },
    {
        "content": "<p>oh nevermind, you're getting a partial cache, not building from scratch.</p>",
        "id": 492361106,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736273493
    },
    {
        "content": "<p>You mean the Mathlib lakefile?</p>",
        "id": 492361122,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736273502
    },
    {
        "content": "<p>To be honest the partial cache thing seems randomly half-broken so I’m actually half building from scratch.</p>",
        "id": 492361223,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736273531
    },
    {
        "content": "<p>\"nothing to build\" happens here because you flooded the build logs when you built it the first time, and lake now regurgitates these on a noop build.</p>",
        "id": 492365409,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736275178
    },
    {
        "content": "<p>And why does it feel the need to do that? It takes forever too.</p>",
        "id": 492365574,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736275235
    },
    {
        "content": "<p>The initial flooding is a linter bug</p>",
        "id": 492365738,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736275314
    },
    {
        "content": "<p>I feel closer and closer to simply switching back to Lean 3 and hope things will get usable next year.</p>",
        "id": 492365740,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736275314
    },
    {
        "content": "<p>The regurgitation of all messages is a feature, because it means you don't miss the previous warnings</p>",
        "id": 492365846,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736275336
    },
    {
        "content": "<p>Is there any way to switch off this “feature”?</p>",
        "id": 492365913,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736275363
    },
    {
        "content": "<p>That's a question for <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> I think</p>",
        "id": 492365965,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736275385
    },
    {
        "content": "<p>It seems the VSCode extension is less paralyzed than lean.nvim by this behavior, so there is some hope for my students.</p>",
        "id": 492366143,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736275447
    },
    {
        "content": "<p>Yes I'm aware that <code>docPrime</code> basically makes <code>lean.nvim</code> fall over.</p>",
        "id": 492366217,
        "sender_full_name": "Julian Berman",
        "timestamp": 1736275481
    },
    {
        "content": "<p>(The fix is we need to restore the backoff behavior we used to have -- because what happens now is basically the LSP spams us with responses as it goes through the compilation.)</p>",
        "id": 492366283,
        "sender_full_name": "Julian Berman",
        "timestamp": 1736275509
    },
    {
        "content": "<p>This came up already several times.  I think that one of the reasons the linter complains is that it looks for allowed exceptions in the path where the exceptions file exists in mathlib.  However, if you have mathlib as a dependency, that path is incorrect.  I thought that there were plans to make the searchpath for dependencies be aware of this.</p>",
        "id": 492391924,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736285943
    },
    {
        "content": "<p>If that is not the case, then I can try to see if I can tease out of lake what the correct path for the exceptions file it: the file will be in <code>rootDir/.lake</code> somewhere, rather than in <code>rootDir/scripts</code>.  The main issue is to get the right pathseparators/special names for everything right.</p>",
        "id": 492392146,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736286032
    },
    {
        "content": "<p>Can I insist that we simply deactivate this linter until the issue is fixed?</p>",
        "id": 492392178,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736286041
    },
    {
        "content": "<p>I don’t see this linter as being so much mission-critical that it warrants inflicting this pain on any downstream project.</p>",
        "id": 492392288,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736286080
    },
    {
        "content": "<p>Personally, I am not too attached to the linter: I like the idea of documenting mathlib, but it is unclear whether this linter is achieving it in a reasonable way.</p>",
        "id": 492392343,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736286108
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20559\">#20559</a>, in case anyone feels strongly enough about this to merge the PR!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 492392835,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736286321
    },
    {
        "content": "<p>Thanks Damiano. I’ll wait a couple of minutes to see if someone complains before borsing this.</p>",
        "id": 492393044,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736286397
    },
    {
        "content": "<p>Note this won’t help me because I’m stuck with Lean 4.14.0 anyway…</p>",
        "id": 492393086,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736286415
    },
    {
        "content": "<p>I delegated modulo opening a tracking issue for actually fixing it</p>",
        "id": 492393595,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736286625
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20560\">#20560</a> is the tracking issue.</p>",
        "id": 492395906,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736287541
    },
    {
        "content": "<p>I'll wait for CI to go green on the PR and merge it.</p>",
        "id": 492395936,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736287557
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span>, we can backport <a href=\"https://github.com/leanprover-community/mathlib4/pull/20559\">#20559</a> to a version of Mathlib that still uses v4.14.0</p>",
        "id": 492396413,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736287764
    },
    {
        "content": "<p>e.g. as well as simply having the <code>v4.14.0</code> tag of Mathlib, we make a <code>releases/v4.14.0</code> branch of Mathlib (initially starting at that tag), and we can backport critical fixes to that branch.</p>",
        "id": 492396516,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736287808
    },
    {
        "content": "<p>And them make a <code>v4.14.0-mathlib1</code> tag on that branch?</p>",
        "id": 492396649,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736287872
    },
    {
        "content": "<p>Or just tell people to put <code>releases/v4.14.0</code> in the lakefile if they want \"almost v4.14.0 but with future fixes\"?</p>",
        "id": 492396700,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736287901
    },
    {
        "content": "<p>Having this fix and the cc bug fix on a 4.14 Lean would definitely help me.</p>",
        "id": 492396905,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736287990
    },
    {
        "content": "<p>Or maybe I should forget about using a released Lean, push to remove the <code>on</code> notation from Mathlib master and try to upgrade to 4.16.</p>",
        "id": 492397235,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736288157
    },
    {
        "content": "<p>I don’t know. I must confess I’m kind of panicking here. My course starts in one week and a half and my two colleagues teaching with me still haven’t tried Lean 4 at all, they are waiting for me to give them instructions about installing Lean 4. During lunch I told one them I had installation size issues and he jokingly answered by asking me how many <em>Gigabytes</em> they needed to allocate. I had to answer that it would indeed be measured in Gigabytes…</p>",
        "id": 492397554,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736288337
    },
    {
        "content": "<p>Of course for my colleagues the big install is not a real issue, but he simply couldn’t imagine the multiplicative factor from Lean 3 size to Lean 4 size would be 50.</p>",
        "id": 492397816,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736288476
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/docPrime.20hell/near/492397235\">said</a>:</p>\n<blockquote>\n<p>Or maybe I should forget about using a released Lean, push to remove the <code>on</code> notation from Mathlib master and try to upgrade to 4.16.</p>\n</blockquote>\n<p>Another option is for you to just create a branch of mathlib with whatever quick fixes you need, and run your course from that.</p>",
        "id": 492402177,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736290376
    },
    {
        "content": "<p>(by pointing to the branch instead of <code>master</code> in the lakefile)</p>",
        "id": 492402219,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736290399
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span>, I've just pushed a tag <code>v4.14.0-patch1</code>, which contains</p>\n<ul>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/20559\">#20559</a> (disabling docPrime linter)</li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/20422\">#20422</a> (cc panic issue)</li>\n</ul>\n<p>This tag is on the <code>releases/v4.14.0</code> branch, and we can backport further fixes to that if needed.</p>",
        "id": 492413810,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736296770
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> there's also now <code>v4.15.0-patch1</code>, which contains</p>\n<ul>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/20559\">#20559</a> (disabling docPrime linter)</li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/20562\">#20562</a> (scoping <code>on</code> notation)</li>\n</ul>",
        "id": 492426649,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736305737
    },
    {
        "content": "<p>Thanks, this is really great. All this boring work with the <code>on</code> notation is really appreciated. I think removing the notation entirely is probably a better idea, but the current patch is enough for me.</p>",
        "id": 492458866,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736326402
    },
    {
        "content": "<p>How about declaring <code>docPrime</code> as an <code>env_linter</code>?<br>\n<code>env_linter</code>s are similar to the <code>docBlame</code> linter: they are used only in CI, and we could unify <code>nolints_prime_decls.txt</code> with <code>nolints.json</code>.</p>",
        "id": 536643772,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1756398223
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span></p>",
        "id": 536719104,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1756444019
    },
    {
        "content": "<p>I need to think a bit about this.  I liked that the docPrime linter would tell you right away that something was wrong: the linter is already annoying and pedantic.  If you also do not get a warning before pushing through CI, then I think that it only makes matters worse!</p>",
        "id": 536774305,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756469254
    },
    {
        "content": "<p>I do not remember the details, but I think that there was a discussion about downstream options taking priority over upstream options.  This would have probably solved some of the issues of the linter, but I need to investigate again what the issue was and if it has been resolved in core in the meantime.</p>",
        "id": 536774492,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756469327
    },
    {
        "content": "<p>Got it, thank you!</p>",
        "id": 537022469,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1756691646
    }
]