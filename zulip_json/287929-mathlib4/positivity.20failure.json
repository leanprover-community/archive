[
    {
        "content": "<p>I noticed something weird with positivity:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">--works :)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">--works :)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">--Doesn't work!</span>\n</code></pre></div>\n<p>I don't understand why the first two work but the third doesn't. My current understanding, which (checking the source) is also what it looks like it tries to do and what the docs describe it as, is to classify each subexpression as \"positive\" or \"zero\" or \"negative\" (or some combination of them), and then propagate these structurally. I would expect that, in the third case, <code>-x</code> is structurally negative, and <code>5</code> is structurally positive, so that <code>5 - (-x)</code> is a positive minus a negative and so is positive.</p>",
        "id": 485012079,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1732848887
    },
    {
        "content": "<p>In this case <code>rw [sub_neg_eq_add]; positivity</code> works, but I would like to understand the general case (where it might not be so obvious)</p>",
        "id": 485012128,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1732848933
    },
    {
        "content": "<p>It seems like the lemma <code>0 &lt; x -&gt; y &lt; 0 -&gt; 0 &lt; x - y</code> is simply missing</p>",
        "id": 485016300,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1732851854
    },
    {
        "content": "<p>That might not be a lemma in mathlib because the hypotheses are too strong (either could be weakened to &lt;=)</p>",
        "id": 485026313,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1732859323
    },
    {
        "content": "<blockquote>\n<p>classify each subexpression as \"positive\" or \"zero\" or \"negative\"</p>\n</blockquote>\n<p>No, the three categories are <code>positive</code>, <code>nonnegative</code> and <code>nonzero</code>: <a href=\"https://github.com/leanprover-community/mathlib4/blob/496527772ac807ef3d1ddd4868f2048f9ea478e1/Mathlib/Tactic/Positivity/Core.lean#L35-L40\">https://github.com/leanprover-community/mathlib4/blob/496527772ac807ef3d1ddd4868f2048f9ea478e1/Mathlib/Tactic/Positivity/Core.lean#L35-L40</a></p>",
        "id": 485097790,
        "sender_full_name": "David Renshaw",
        "timestamp": 1732886429
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">--works :)</span>\n</code></pre></div>\n<p>This example works because <code>positivity</code> <a href=\"https://github.com/leanprover-community/mathlib4/blob/496527772ac807ef3d1ddd4868f2048f9ea478e1/Mathlib/Tactic/Positivity/Core.lean#L326\">invokes some <code>NormNum</code> logic</a>, which here successfully evaluates the right hand side to a natural number.</p>",
        "id": 485099172,
        "sender_full_name": "David Renshaw",
        "timestamp": 1732886913
    },
    {
        "content": "<p>Adding <code>nonnegative</code> and <code>negative</code> variants to <code>Positivity.Strictness</code> seems to me like it could work, but I think it would require updating many positivity extensions.</p>",
        "id": 485099977,
        "sender_full_name": "David Renshaw",
        "timestamp": 1732887139
    },
    {
        "content": "<p>I believe this is a deliberate design decision, <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> can probably explain it better. The short version of it is that <code>positivity</code> is intended for solving positivity goals which are positive for \"obvious reasons\", and expects you to preprocess the goal until it is obvious.</p>",
        "id": 485104019,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732888464
    },
    {
        "content": "<p>it's supposed to correspond to the lines of a calc proof on paper which can be discharged with no further justification. In a case like this I think you would rewrite the <code>a - (-b)</code> to <code>a + b</code> first</p>",
        "id": 485104213,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1732888549
    },
    {
        "content": "<p>To piggyback on this thread: can <code>positivity</code> be made to accept additional hypotheses (like, e.g., <code>linarith</code> does) as in the following?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">-- fails as expected</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">-- works as expected</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- syntax error, but would be nice to have</span>\n</code></pre></div>",
        "id": 485104662,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1732888691
    },
    {
        "content": "<p>I wonder if we could have some <code>with [term1, term2] &lt;tactic&gt;</code> which adds the terms as temporary local variables for the tactic (perhaps also with some syntax to give them names)</p>",
        "id": 485112103,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1732891037
    },
    {
        "content": "<p>And that would effectively act as <code>have := term1; have := term2; tactic &lt;;&gt; (clear this; clear this)</code> or so?</p>",
        "id": 485135354,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1732899586
    },
    {
        "content": "<p>Yes</p>",
        "id": 485135458,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1732899615
    },
    {
        "content": "<p><code>positivity</code> is used a <em>lot</em>, including silently as a side-goal discharger in <code>field_simp</code>, <code>gcongr</code>, etc.  One proof of mine which I was profiling recently used <code>positivity</code> 100 times.  It's supposed to be \"stupid\" but fast and predictable.</p>",
        "id": 485139827,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732901770
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/positivity.20failure/near/485104662\">said</a>:</p>\n<blockquote>\n<p>To piggyback on this thread: can <code>positivity</code> be made to accept additional hypotheses </p>\n</blockquote>\n<p>This seems reasonable enough (but it wouldn't be relevant in the major use case, which is when <code>positivity</code> is used silently).</p>",
        "id": 485140052,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732901895
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/stream/287929-mathlib4/topic/positivity.20failure/near/485112103\">said</a>:</p>\n<blockquote>\n<p>I wonder if we could have some <code>with [term1, term2] &lt;tactic&gt;</code> which adds the terms as temporary local variables for the tactic (perhaps also with some syntax to give them names)</p>\n</blockquote>\n<p>Maybe there could also be <code>with only</code> which hides everything else from the tactic</p>",
        "id": 485140213,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1732902002
    }
]