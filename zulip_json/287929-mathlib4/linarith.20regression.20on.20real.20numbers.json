[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">Bounds</span>\n<span class=\"c1\">-- set_option trace.linarith true</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">pi_gt_3141592</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>doesn't work in Lean 4, but </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"bp\">.</span><span class=\"n\">real</span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"bp\">.</span><span class=\"n\">bounds</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">real</span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">real</span><span class=\"bp\">.</span><span class=\"n\">pi_gt_3141592</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>worked in Lean 3.</p>",
        "id": 440811750,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1716801416
    },
    {
        "content": "<p><a href=\"#narrow/stream/287929-mathlib4/topic/linarith.20regression.20on.20real.20numbers/near/440811750\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/linarith.20regression\">#mathlib4 &gt; linarith regression</a> by <span class=\"user-mention silent\" data-user-id=\"325367\">Mauricio Collares</span>.</p>",
        "id": 440811808,
        "sender_full_name": "Notification Bot",
        "timestamp": 1716801436
    },
    {
        "content": "<p>Note that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">Bounds</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">49</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">3.141592</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">pi_gt_3141592</span>\n<span class=\"w\">  </span><span class=\"n\">norm_num</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">  </span><span class=\"n\">linarith</span>\n</code></pre></div>\n<p>works, but fails without the <code>norm_num</code> line, so it's a <code>OfScientific</code> issue.</p>",
        "id": 440813421,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1716801966
    },
    {
        "content": "<p>More minimal example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">Bounds</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">norm_num</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n<span class=\"w\">  </span><span class=\"n\">linarith</span>\n</code></pre></div>\n<p>fails without the <code>norm_num</code>.</p>",
        "id": 440813614,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1716802030
    },
    {
        "content": "<p>Interestingly, <code>set_option trace.linarith</code> suggests that it does almost succeed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">following</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span><span class=\"o\">:</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"n\">conjunctions</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">terms</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">proofs</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">comparisons</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"n\">negations</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">comparisons</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">move</span><span class=\"w\"> </span><span class=\"n\">nats</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">ints</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">strengthen</span><span class=\"w\"> </span><span class=\"n\">strict</span><span class=\"w\"> </span><span class=\"n\">inequalities</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">int</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">comparisons</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">denominators</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">preprocessing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">facts</span><span class=\"o\">:</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span><span class=\"w\"> </span><span class=\"n\">appear</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">types</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">contradiction</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">expression</span>\n<span class=\"w\">      </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">both</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">negative</span>\n</code></pre></div>",
        "id": 440828962,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1716807295
    },
    {
        "content": "<p>Ah nevermind, that's because the simplex algorithm oracle returns an empty proof when it fails.</p>",
        "id": 440830174,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1716807793
    },
    {
        "content": "<p><code>linarith (config := { oracle := Linarith.CertificateOracle.fourierMotzkin })</code> will fail rather than returning an empty proof.</p>",
        "id": 440830216,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1716807818
    },
    {
        "content": "<p>Okay, I don't know enough about the implementation of linarith to diagnose what's going wrong beyond that point.</p>",
        "id": 440834535,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1716809436
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/stream/287929-mathlib4/topic/linarith.20regression.20on.20real.20numbers/near/440830174\">said</a>:</p>\n<blockquote>\n<p>Ah nevermind, that's because the simplex algorithm oracle returns an empty proof when it fails.</p>\n</blockquote>\n<p>This sounds like a bug</p>",
        "id": 440837438,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1716810504
    },
    {
        "content": "<p>Has there been any progress on this regression?</p>",
        "id": 480429837,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1730722172
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"552388\">@Vasily Nesterov</span>, perhaps? I'm not sure who \"last touched\" <code>linarith</code>.</p>",
        "id": 480553896,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730767973
    },
    {
        "content": "<p>I have a workaround following Sébastien's idea - applying norm_num everywhere makes the linariths succeed. But it's weird that this is necessary at all!</p>",
        "id": 480556907,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1730769996
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/linarith.20regression.20on.20real.20numbers/near/440830174\">писал/а</a>:</p>\n<blockquote>\n<p>Ah nevermind, that's because the simplex algorithm oracle returns an empty proof when it fails.</p>\n</blockquote>\n<p>Hi, is this what happens in this particular example?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">Bounds</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linarith</span>\n</code></pre></div>\n<p>For me it prints</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">following</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span><span class=\"o\">:</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">split</span><span class=\"w\"> </span><span class=\"n\">conjunctions</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"n\">terms</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">proofs</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">comparisons</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"n\">negations</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">comparisons</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">move</span><span class=\"w\"> </span><span class=\"n\">nats</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">ints</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">strengthen</span><span class=\"w\"> </span><span class=\"n\">strict</span><span class=\"w\"> </span><span class=\"n\">inequalities</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">int</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">comparisons</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">zero</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Preprocessing</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cancel</span><span class=\"w\"> </span><span class=\"n\">denominators</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">preprocessing</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">linarith</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">facts</span><span class=\"o\">:</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span><span class=\"w\"> </span><span class=\"n\">appear</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">different</span><span class=\"w\"> </span><span class=\"n\">types</span>\n\n<span class=\"o\">[</span><span class=\"n\">linarith</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Simplex</span><span class=\"w\"> </span><span class=\"n\">Algorithm</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>\n<p>as expected. It used to return empty proof, but I thought I fixed it quite a while ago.</p>",
        "id": 480711904,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1730810503
    },
    {
        "content": "<p>Ah, I see that the topic is also quite old :)</p>\n<p>Anyway, it's fixed now.</p>",
        "id": 480712616,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1730810740
    },
    {
        "content": "<p>Pedantically clarifying the status of this thread: The empty proof is indeed fixed (thanks a lot!), but the Lean 3 regression (i.e., the fact that the simplex algorithm fails if <code>norm_num</code> is not applied to the hypothesis, possibly due to linarith lacking appropriate support for <code>OfScientific</code>) still persists.</p>",
        "id": 480744846,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1730819906
    },
    {
        "content": "<p>I looked into this bug with decimals in <code>linarith</code>.  There are two issues:</p>\n<ol>\n<li>The <code>cancel_denoms</code> preprocessor ought to be triggered by a decimal (because a decimal is implicitly a rational number), but it's not -- currently the preprocessor is only run on expressions literally containing a <code>/</code>.</li>\n<li>The <code>cancel_denoms</code> preprocessor doesn't currently know how to realise a decimal as a fraction (i.e. to turn 1.423 into 1423/1000), which is a necessary prep step before actually cancelling denominators.</li>\n</ol>\n<p>A proposed fix is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/19174\">#19174</a>.  I could have just taught <code>cancel_denoms</code> to handle decimals (which is what was done in mathlib3), but it seems more natural to me to actually let <code>cancel_denoms</code> preprocess <em>all</em> numbers using <code>norm_num1</code>. So now the following would also be handled (which were <a href=\"https://leanprover-community.github.io/lean-web-editor/#code=import%20tactic.linarith%0Aimport%20data.real.basic%0A%0Aexample%20%28a%20%3A%20%E2%84%9D%29%20%28ha%20%3A%2010%20%2F%20%288%20%2B%202%29%20%E2%89%A4%20a%29%20%3A%201%20%E2%89%A4%20a%20%3A%3D%20by%20linarith%0A%0Aexample%20%28a%20%3A%20%E2%84%9D%29%20%28ha%20%3A%2010%20%2F%2010%20%5E%201%20%E2%89%A4%20a%29%20%3A%201%20%E2%89%A4%20a%20%3A%3D%20by%20linarith%0A%0Aexample%20%28a%20%3A%20%E2%84%9D%29%20%28ha%20%3A%2010%E2%81%BB%C2%B9%20*%2010%20%E2%89%A4%20a%29%20%3A%201%20%E2%89%A4%20a%20%3A%3D%20by%20linarith%0A%0Aexample%20%28a%20%3A%20%E2%84%9D%29%20%28ha%20%3A%201.0%20%E2%89%A4%20a%29%20%3A%201%20%E2%89%A4%20a%20%3A%3D%20by%20linarith\">not handled</a> in mathlib3): </p>\n<ul>\n<li><code>10 / (8 + 2)</code></li>\n<li><code>10 / 10 ^ 1</code></li>\n<li><code>10⁻¹ * 10</code></li>\n</ul>\n<p>Not sure what the performance impact will be -- benchmarking it now.</p>",
        "id": 482902192,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731882853
    },
    {
        "content": "<p>Since <code>norm_num1</code> will anyway have to handle any other arithmetic-expressions-on-numbers later (during the <code>ring</code> run in the discharger step), it seems plausible that no serious performance impact would result from instead handling them earlier (in the cancel-denoms preprocessor step) ... but we'll see!</p>",
        "id": 482902592,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1731883295
    }
]