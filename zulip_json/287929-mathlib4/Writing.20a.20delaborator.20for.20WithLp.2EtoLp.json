[
    {
        "content": "<p>Hi! In <a href=\"https://github.com/leanprover-community/mathlib4/pull/27270\">#27270</a> I turn <code>WithLp</code> into a one field structure with two constructors, one of which being <code>WithLp.toLp</code>. The issue is that when writing <code>WithLp.toLp p x</code> in the code, it gets printed as <code>{ ofLp := x }</code> which is not great for readability (and causes the build error in the PR in some testing file). Jireh suggested that we would just need a delaborator to fix the issue. Here comes the tricky part: I have absolutely no idea how meta programming works and find the syntax very obscure. Taking inspiration on the delaborator for the <code>!₂[x, y, ...]</code> notation in <code>Analysis.InnerProductSpace.PiL2</code> I wrote the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">toLp</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">whenNotPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPExplicit</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withOverApp</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"c1\">-- check that the `WithLp.toLp _` is present</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">toLp</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">toLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- toLp✝ p 0 : WithLp p ℝ</span>\n</code></pre></div>\n<p>which kinda works but prints out <code>toLp✝</code> instead of just <code>toLp</code>. I don't know where to find instructions so I have no idea what to do to solve the issue or if what I wrote is the right way to do it. It looks like the issue comes from the fact that I want to print an existing function. Any help would be greatly appreciated!</p>",
        "id": 545807137,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1760854949
    },
    {
        "content": "<p>You should use <code>withNaryFun delab</code> to get the toLp part</p>",
        "id": 545816213,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760864903
    },
    {
        "content": "<p>Though I think there might be a pp setting to disable constructor notation that could help here</p>",
        "id": 545816227,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760864936
    },
    {
        "content": "<p>(and we should probably build this for <code>ULift.up</code> too)</p>",
        "id": 545816247,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760864960
    },
    {
        "content": "<p>It looks like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">structureInstances</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>solves it, but I don't think we want this across all mathlib. Can it be activated only for <code>toLp</code>?</p>",
        "id": 545830630,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1760881053
    },
    {
        "content": "<p>Ok this seems to work!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Macro</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">toLp</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">whenNotPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPExplicit</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">getPPNotation</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withOverApp</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">toLp</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryFn</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withNaryArg</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">toLp</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">x</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">toLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- WithLp.toLp p 0 : WithLp p ℝ</span>\n</code></pre></div>",
        "id": 545830788,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1760881233
    },
    {
        "content": "<p>Yes the error in the testing file is fixed, thanks Eric!</p>",
        "id": 545831067,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1760881527
    },
    {
        "content": "<p>This also works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">toLp</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">delabApp</span>\n</code></pre></div>",
        "id": 545831562,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760882132
    },
    {
        "content": "<p>lol, well that was easy</p>",
        "id": 545831767,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1760882394
    },
    {
        "content": "<p>I was going to suggest that you can set the <code>pp.structureInstances</code> option locally in the elaborator then fall back to the default delaborator, then realized that the default delaborator already does the right thing.</p>",
        "id": 545831914,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760882560
    },
    {
        "content": "<p>(If you just call <code>delab</code> then Lean goes into a loop and prints an ellipsis)</p>",
        "id": 545831935,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760882588
    },
    {
        "content": "<p>So <code>delabApp</code> is the \"Default delaborator for applications\" (according to the docstring), but here because <code>toLp</code> is a constructor there is a kind of conflict and it's another delaborator which is used?</p>",
        "id": 545832116,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1760882799
    },
    {
        "content": "<p>Yes, as there are multiple things registered with <code>@[delab app]</code>, and they are tried in order</p>",
        "id": 545832180,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760882860
    },
    {
        "content": "<p>I guess this is the other way to write it without referring to a handler by name:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">toLp</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">whenPPOption</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">structureInstances</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">withOptions</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">structureInstances</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">delab</span>\n</code></pre></div>\n<p>though this isn't quite correct as it disables the option for <code>x</code> too.</p>",
        "id": 545832316,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760883016
    }
]