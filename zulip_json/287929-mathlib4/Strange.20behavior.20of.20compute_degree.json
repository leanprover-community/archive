[
    {
        "content": "<p>While tinkering with Gelfand-Mazur, I came across the following.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">ComputeDegree</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">noncomputable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nontrivial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">xxx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">compute_degree</span>\n<span class=\"w\">  </span><span class=\"c1\">-- 2 goals: `¬¨(p R).coeff 2 ‚â† 0` *and* `(p R).natDegree = 2`</span>\n<span class=\"w\">  </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I would expect <code>compute_degree</code> to <em>clear</em> the original goal and only leave the side goals necessary for proving it. <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> ?</p>",
        "id": 524126273,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749988715
    },
    {
        "content": "<p>There is another strange error when I replace <code>p</code> by its definition.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">ComputeDegree</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">yyy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"c\">/-</span><span class=\"cm\">  tactic 'apply' failed, could not unify the conclusion of</span>\n<span class=\"cm\">      'Mathlib.Tactic.ComputeDegree.natDegree_smul_le_of_le'</span>\n<span class=\"cm\">        (HSMul.hSMul.{?u.3352, ?u.3352, ?u.3352} ?a ?f).natDegree ‚â§ ?n</span>\n<span class=\"cm\">    with the goal</span>\n<span class=\"cm\">      (HSMul.hSMul.{0, u_1, u_1} 2 X).natDegree ‚â§ ?h_natDeg_le.hp.n</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">compute_degree</span>\n</code></pre></div>\n<p>This could be related to <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/.22.40instHAdd.20.E2.84.95.20instAddNat.20.3A.20HAdd.20.E2.84.95.20.E2.84.95.20.E2.84.95.22.20out.20of.20thin.20air/near/523628000\">#lean4 &gt; \"@instHAdd ‚Ñï instAddNat : HAdd ‚Ñï ‚Ñï ‚Ñï\" out of thin air @ üí¨</a>: some strange things seem to be going on when elaborating statements containing polynomials, but I am not sure how closely related it might be.</p>",
        "id": 524126441,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749988918
    },
    {
        "content": "<p>I'm not at a computer, but here is what I suspect.</p>\n<p>First, <code>compute_degree</code> should not see through  <code>def</code>s, so the first behaviour is \"almost\" what I would expect.  I thought it would have left a <code>p.natDegree ‚â§ 2</code> goal, though.</p>\n<p>Second, I don't think that<code>compute_degree</code> is aware of  <code>‚Ä¢</code>.  It would be really easy to add this feature, but I don't think that I was thinking about that possibility when writing the tactic.</p>",
        "id": 524139184,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750002048
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Strange.20behavior.20of.20compute_degree/near/524139184\">said</a>:</p>\n<blockquote>\n<p>I thought it would have left a <code>p.natDegree ‚â§ 2</code> goal, though.</p>\n</blockquote>\n<p>Exactly.</p>",
        "id": 524139405,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750002242
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Strange.20behavior.20of.20compute_degree/near/524139184\">said</a>:</p>\n<blockquote>\n<p>Second, I don't think that<code>compute_degree</code> is aware of <code>‚Ä¢</code>. It would be really easy to add this feature, but I don't think that I was thinking about that possibility when writing the tactic.</p>\n</blockquote>\n<p>I've been trying to manipulate polynomials a fair bit in the last few hours, and I got the impression that <code>simp</code> does not do a good job on them (meaning, so that after <code>simp</code> I can use <code>ring</code> to close equality goals, for example). Probably some thought should go into what a good <code>simp</code> normal form for polynomials may look like. For example, it currently uses <code>map_pow</code> etc., which changes <code>C (a ^2)</code> to <code>(C a) ^ 2</code>, and on this the lemma that says that the <code>n</code>th coefficient of <code>C a</code> is zero (if <code>n</code> is nonzero) doesn't fire.<br>\nI assume that you <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> have thought about this while writing the tactics like <code>compute_degree</code>. Maybe one can extract a <code>normalize_poly</code> tactic from this?</p>",
        "id": 524139755,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750002545
    },
    {
        "content": "<p>I wrote the tactic in Lean3, then ported it to Lean4.  The reason this is relevant is that coercions changed quite a bit and in Lean3, basically the only way to multiply constants and polynomials was via <code>C</code>.  I think that very little thought has gone into <code>simp</code>-confluence for polynomials in Lean4 and your experiments are probably showing that such a cleanup is overdue.</p>",
        "id": 524140129,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750002902
    },
    {
        "content": "<p>Maybe an easy solution would be to have a custom <code>simp</code> set that converts polynomials to something where <code>compute_degree</code> has a chance of working, although going from<code>2 * X</code> to <code>C 2 * X</code> may be tricky with <code>simp</code>.</p>",
        "id": 524140275,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750003048
    },
    {
        "content": "<p>I have a set of simprocs in the works</p>",
        "id": 524140286,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1750003067
    },
    {
        "content": "<p>Ok, great!  Then at least agreeing with an expected <code>simp</code>-normal form for polynomials would help making <code>compute_degree</code> more reliable.</p>",
        "id": 524140326,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750003123
    },
    {
        "content": "<p>It's not just <code>compute_degree</code>, one of my problems is that what <code>simp</code> produces is not good for <code>ring</code>. So hopefully Ya√´l's simprocs will produce a form that is <code>ring</code>-friendly.</p>",
        "id": 524140355,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750003156
    },
    {
        "content": "<p>(I need to cook dinner now...)</p>",
        "id": 524140376,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750003178
    },
    {
        "content": "<p>How reasonable/feasible would it be to try to ban completely <code>C</code> and only allowing <code>*</code> and <code>‚Ä¢</code>?</p>",
        "id": 524140452,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750003240
    },
    {
        "content": "<p>Why not just make <code>C</code> a plain function?</p>",
        "id": 524140486,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1750003266
    },
    {
        "content": "<p>(I mean as <code>simp</code>-normal form.)</p>",
        "id": 524140492,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750003269
    },
    {
        "content": "<p>A plain function as in refactoring <code>polynomial</code>?</p>",
        "id": 524140539,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750003295
    },
    {
        "content": "<p>I personally don't have it in me to embark in such a refactor.</p>",
        "id": 524140598,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750003331
    },
    {
        "content": "<p>Also, \"fixing\" <code>compute_degree</code> to allow <code>‚Ä¢</code> would not be especially hard: likely it is just a matter of adding a lemma about the degree of a smul (which may even already be there) and then making <code>compute_degree</code> use it.</p>",
        "id": 524140678,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750003426
    },
    {
        "content": "<p>One problem with <code>‚Ä¢</code> is that <code>ring</code> does not work well with it. To get my goals closed by <code>ring</code>, it seems best to write everything in terms of <code>C</code>.</p>\n<p>And regarding <code>compute_degree</code>, the following works in my code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">compute_degree</span>\n</code></pre></div>",
        "id": 524145050,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750007881
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Strange.20behavior.20of.20compute_degree/near/524145050\">said</a>:</p>\n<blockquote>\n<p>One problem with <code>‚Ä¢</code> is that <code>ring</code> does not work well with it.</p>\n</blockquote>\n<p>Sounds like you want to hear about the <code>module</code> tactic <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 524145314,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1750008205
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">--ring -- works</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  ring failed, ring expressions not equal</span>\n<span class=\"cm\">  R : Type u_1</span>\n<span class=\"cm\">  inst‚úù : CommRing R</span>\n<span class=\"cm\">  ‚ä¢ 1 = 0</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">module</span>\n</code></pre></div>",
        "id": 524145522,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750008474
    },
    {
        "content": "<p>The idiom is <code>ring_nf; module</code> (but here <code>ring_nf</code> already closes the goal)</p>",
        "id": 524146444,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1750009833
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ring_nf</span>\n<span class=\"w\">  </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"c1\">-- ring failed, ring expressions not equal</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>This is one of my use cases.</p>",
        "id": 524146588,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750010042
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/25944\">#25944</a></p>",
        "id": 524169027,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750039193
    },
    {
        "content": "<p>It turns out that <code>compute_degree</code> already supported smul, but only by the coefficients of the polynomial ring.  In your case, the smul  was coming from a natural number, so technically not from the coefficients.  The PR above fixes this issue.</p>",
        "id": 524169039,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750039202
    },
    {
        "content": "<p>The PR also contains this test</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nontrivial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">compute_degree!</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">.</span><span class=\"n\">coeff</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">coeff_X</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>where ideally <code>compute_degree!</code> should close the goal, not leave a side-goal.  However, I have not worked out why <code>X.coeff 2</code> does not get replaced by <code>0</code>.</p>",
        "id": 524169060,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750039211
    },
    {
        "content": "<p>It seems that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.coeff_X_of_ne_one#doc\">docs#Polynomial.coeff_X_of_ne_one</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.coeff_X#doc\">docs#Polynomial.coeff_X</a> are not <code>simp</code> lemmas (and when I just give the first lemma to <code>simp</code>, then <code>simp</code>does not discharge the side goal <code>2 ‚â† 1</code> by itself). I don't know if this is relevant to how <code>compute_degree!</code> works, though.</p>",
        "id": 524263243,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750082147
    },
    {
        "content": "<p>Yes, I think that this is indeed relevant: <code>compute_degree!</code> tries to discharge the left-over goals using <code>norm_num &lt;;&gt; assumption</code>.  Thus, <code>simp</code> bringing a goal to <code>2 ‚â† 1</code> should make <code>norm_num</code> close the goal.</p>",
        "id": 524289078,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750090167
    },
    {
        "content": "<p>I just checked: adding the <code>simp</code> attribute to <code>coeff_X</code> does indeed simplify the proof:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nontrivial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">compute_degree!</span><span class=\"w\">  </span><span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 524299607,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750093959
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Strange.20behavior.20of.20compute_degree/near/524289078\">said</a>:</p>\n<blockquote>\n<p>Thus, <code>simp</code> bringing a goal to <code>2 ‚â† 1</code> should make <code>norm_num</code> close the goal.</p>\n</blockquote>\n<p>As far as I understand, <code>simp</code> does not fire when it cannot discharge the side goals.</p>",
        "id": 524300239,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750094160
    },
    {
        "content": "<p>It seems that inside <code>norm_num</code>, that is ok.</p>",
        "id": 524300335,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750094192
    },
    {
        "content": "<p>By the way, this also works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">coeff_X</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nontrivial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">.</span><span class=\"n\">coeff</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>So, it seems that <code>simp</code> is already able to close the goal.</p>",
        "id": 524301734,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750094604
    },
    {
        "content": "<p>It uses <code>‚ÜìreduceIte</code> and  <code>one_ne_zero</code>, so I would assume it's due to simprocs.</p>",
        "id": 524301990,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750094680
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> Currently this fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">'compute_degree' inapplicable. The goal</span>\n<span class=\"cm\">  (C 1).natDegree &lt; 1</span>\n<span class=\"cm\">is expected to be '‚â§' or '='.</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">compute_degree</span>\n</code></pre></div>\n<p>Would it be possible to extend <code>compute_degree</code>/<code>compute_degree!</code> to also deal with strict inequalities?</p>",
        "id": 524831602,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750318850
    },
    {
        "content": "<p>Fixed a bug, found a bug.</p>",
        "id": 524831689,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750318888
    },
    {
        "content": "<p>Given that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">lt_of_le_of_lt</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">compute_degree</span>\n<span class=\"w\">  </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">norm_num</span>\n</code></pre></div>\n<p>works, it is probably easy to get something working, at least leaving out of scope the inequality <code>&lt;actual_degree&gt; &lt; given bound</code>, so <code>0 &lt; 1</code> in your case.</p>",
        "id": 524832011,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750319041
    },
    {
        "content": "<p>I remember thinking about strict inequalities and deciding against doing them in the first place, since the algorithm for <code>‚â§</code> is somewhat easier.</p>",
        "id": 524832220,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750319137
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26145\">#26145</a>, where your example is solved by <code>compute_degree!</code>.</p>",
        "id": 524856913,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750329037
    },
    {
        "content": "<p>Note that the <code>+37-16</code> change that github reports consists of</p>\n<ul>\n<li>2 added lines of code;</li>\n<li>documentation and examples!</li>\n</ul>",
        "id": 524857506,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750329294
    },
    {
        "content": "<p>I noticed that (just had a look), but I don't feel competent enough with meta code to maintainer merge.</p>",
        "id": 524857605,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1750329343
    },
    {
        "content": "<p>Sure, no worries!  If it helps anyone, the strategy is to detect if the goal looks like <code>f.natDegree &lt; d</code> and, if so, start the proof with <code>apply lt_of_le_of_lt</code> and then fall back on the earlier behaviour.</p>",
        "id": 524857767,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750329423
    },
    {
        "content": "<p>In fact, <code>compute_degree</code> does not \"know\" what the degree is at the start: it replaces the degree with a metavariable, imposes conditions on the metavariable by traversing the polynomial and then checks whether the constraints are compatible.</p>",
        "id": 524857937,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750329493
    },
    {
        "content": "<p>So, the first step of replacing the degree with a metavariable is what it would have done in the weak inequality as well.</p>",
        "id": 524857982,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750329513
    },
    {
        "content": "<p>Michael, strict inequalities are now handled by <code>compute_degree</code> also in the online server.  Your example above is closed by <code>compute_degree!</code> (while <code>compute_degree</code> leaves a <code>0 &lt; 1</code> goal).</p>",
        "id": 524931414,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750357184
    }
]