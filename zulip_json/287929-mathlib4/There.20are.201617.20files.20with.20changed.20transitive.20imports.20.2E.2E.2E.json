[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, when your import diff script decides there are too many difference to display, could we provide a command line tool to get this information? (Or just post it anyway? It's folded away...) I often find myself wanting to know, despite it being many lines.</p>",
        "id": 457012508,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723007572
    },
    {
        "content": "<p>I'm not at a computer now, but I will look at this.  The reason I introduced the cut-off is that the very first test that I made had so many changes that the whole comment got corrupted.</p>",
        "id": 457015843,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723009309
    },
    {
        "content": "<p>However, I think that I have been too conservative with the length and much longer reports can still be displayed.</p>",
        "id": 457015853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723009316
    },
    {
        "content": "<p>And a command-line version should not have this limitation either.</p>",
        "id": 457015905,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723009334
    },
    {
        "content": "<p>(Btw, to give credit where it is due, Johan wrote the import script, I wrote the declaration diff.)</p>",
        "id": 457015955,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723009379
    },
    {
        "content": "<p>Kim, can you tell me on which PR this happened, so that I can test?</p>",
        "id": 457033008,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723015630
    },
    {
        "content": "<p>To test this, I removed every import line that contained the substring <code>red</code> and ran the script to make sure that it would say that it was too many changes (and it did complain).</p>\n<p>I then ran the modified script that has a flag to show all import changes, no matter what and pasted the output in <a href=\"https://github.com/leanprover-community/mathlib4/pull/14675\">#14675</a> (a PR that has nothing to do with the script!).  Git happily accepted the resulting comment as you can see.</p>",
        "id": 457033884,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723015835
    },
    {
        "content": "<p>I think that a better approach would be to limit the <em>combined</em> size of the import diff and the decl diff scripts, since they get written out to the same message.</p>",
        "id": 457034044,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723015871
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15579\">#15579</a></p>",
        "id": 457034124,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723015895
    },
    {
        "content": "<p>(Although arguably, if you are making a lot of import changes, you should not be touching declarations and conversely.)</p>",
        "id": 457034153,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723015904
    },
    {
        "content": "<p>I just commented on the PR!</p>",
        "id": 457035067,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723016083
    },
    {
        "content": "<p>I'll try to find out what are the limits for GitHub messages and will use half of that as a cutoff.  Besides that, I will also add the flag to print all the diffs anyway.</p>",
        "id": 457035532,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723016177
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15583\">#15583</a> adds the <code>all</code> flag to see all imports.</p>",
        "id": 457036740,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723016481
    },
    {
        "content": "<p>For increasing the limit size of what the import diff reports, I need to investigate further!</p>",
        "id": 457036822,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723016506
    },
    {
        "content": "<p>Looking further into this specific commit, here is a wc for the output of the <code>all</code> script:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>./scripts/import_trans_difference.sh<span class=\"w\"> </span>all<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>wc\n<span class=\"o\">[</span>fluff<span class=\"o\">]</span>\n<span class=\"w\">     </span><span class=\"m\">20</span><span class=\"w\">    </span><span class=\"m\">1679</span><span class=\"w\">   </span><span class=\"m\">71479</span>\n</code></pre></div>\n<p>and according to \"the internet\", GitHub comment size limit is just one less than the largest known Fermat prime.  This means that GitHub could likely take a message that is roughly an order of magnitude bigger than what the script currently rejects.</p>",
        "id": 457040140,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723017528
    },
    {
        "content": "<p>Question is more whether it's useful for humans at that scale, I think</p>",
        "id": 457046061,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1723019149
    },
    {
        "content": "<p>I agree, but if you look at the output for the PR, with the collapsible tabs it is very informative.</p>",
        "id": 457046260,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723019181
    },
    {
        "content": "<p>The script bases its decision on whether to post the full output or not based on the <em>number of files</em> that have import changes.</p>\n<p>GitHub's limit is on the <em>size</em> of the message, not on the number of lines (although of course there are implications between the two!).</p>\n<p>I wonder whether the \"human\" metric should take into account number of <em>lines</em> of output, since the lines correspond to knowing how many files with each possible import change there are.</p>",
        "id": 457047262,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723019348
    },
    {
        "content": "<p>Hence, if there are 2000 files with 3 import changes and 500 files with 10 import changes, the script maybe should report that, even if you are then not going to open the tabs to look at the 2000 files in the first block.</p>",
        "id": 457047819,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723019455
    },
    {
        "content": "<p>After investigating this a bit, it seems that comments can be roughly 260k characters long, really (probably yet another difference between the meaning of \"character\" with the 65536 bound that GitHub claims).</p>",
        "id": 457092192,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723032387
    },
    {
        "content": "<p>If there is consensus, I can change the check for the import summary to being half the allowed comment length on github.  That would amply cover the case in question and probably most cases anyway, given how the number of characters of <em>every</em> <code>.lean</code> file in mathlib is now 206526.</p>",
        "id": 457092414,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723032468
    },
    {
        "content": "<p>You mean of every <code>.lean</code> file <em>name</em>, right?</p>",
        "id": 457233258,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723078120
    },
    {
        "content": "<p>Yes, indeed!  The script would only report file <em>names</em> and this is what I had in mind!</p>",
        "id": 457244459,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723082974
    },
    {
        "content": "<p>I also ended up using 120k characters as a limit for the message in the PR.</p>",
        "id": 457245262,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723083399
    }
]