[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/bd33e8d4d0126dfee29774249b47fbe4c4e3cff6/.github/workflows/daily.yml#L374\">The JSON configuration for the daily Nanoda check on Mathlib includes <code>Lean.trustCompiler</code>:</a></p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nt\">\"export_file_path\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"mathlib_export.txt\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">\"permitted_axioms\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<span class=\"w\">        </span><span class=\"s2\">\"propext\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"Classical.choice\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"Quot.sound\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"s2\">\"Lean.trustCompiler\"</span>\n<span class=\"w\">    </span><span class=\"p\">],</span>\n<span class=\"w\">    </span><span class=\"nt\">\"unpermitted_axiom_hard_error\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">\"nat_extension\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">\"string_extension\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nt\">\"print_success_message\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Since this doesn't include <code>Lean.ofReduceBool</code> or <code>Lean.ofReduceNat</code>, it would still catch a <code>native_decide</code> proof, but why does <code>Lean.trustCompiler</code> need to be in there?</p>",
        "id": 567197632,
        "sender_full_name": "James E Hanson",
        "timestamp": 1767980767
    },
    {
        "content": "<p>Also note that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ofReduceBool#doc\">docs#Lean.ofReduceBool</a> is a theorem under <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.trustCompiler#doc\">docs#Lean.trustCompiler</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">auxTrue</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">auxFalse</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ofReduceBool'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">reduceBool</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">reduceBool</span><span class=\"w\"> </span><span class=\"n\">auxTrue</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">reduceBool</span><span class=\"w\"> </span><span class=\"n\">auxFalse</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">auxFalse</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">auxTrue</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">  </span><span class=\"n\">subst</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">assumption</span>\n\n<span class=\"sd\">/-- info: 'Lean.ofReduceBool'' depends on axioms: [Lean.trustCompiler] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">axioms</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ofReduceBool'</span>\n</code></pre></div>",
        "id": 567198965,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767981228
    },
    {
        "content": "<p>Because Init includes <code>Lean.reduceNat</code> and <code>Lean.reduceBool</code>, which are opaque declarations that reference <code>Lean.trustCompiler</code>.</p>",
        "id": 567201285,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1767982004
    },
    {
        "content": "<p>I mean I guess Nanoda as an external checker doesn't support compiler evaluation in the first place so adding <code>Lean.trustCompiler</code> doesn't actually do much of anything</p>",
        "id": 567236956,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767982877
    },
    {
        "content": "<p>To Nanoda, <code>Lean.trustCompiler</code> is just a axiom that asserts that <code>True</code> is true</p>",
        "id": 567237187,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1767982955
    },
    {
        "content": "<p>Sure, I understand that it's not really an issue. I just want to understand on a technical level why it was necessary.</p>",
        "id": 567238011,
        "sender_full_name": "James E Hanson",
        "timestamp": 1767983225
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"228466\">Chris Bailey</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Why.20does.20the.20daily.20Nanoda.20check.20allow.20.60Lean.2EtrustCompiler.60.3F/near/567201285\">said</a>:</p>\n<blockquote>\n<p>Because Init includes <code>Lean.reduceNat</code> and <code>Lean.reduceBool</code>, which are opaque declarations that reference <code>Lean.trustCompiler</code>.</p>\n</blockquote>\n<p>Ah I see, so the difference is that nothing in Mathlib actually references <code>Lean.ofReduceNat</code> or <code>Lean.ofReduceBool</code>.</p>",
        "id": 567242543,
        "sender_full_name": "James E Hanson",
        "timestamp": 1767984831
    },
    {
        "content": "<p>Does anything in mathlib reference <code>trustCompiler</code>?</p>",
        "id": 567243510,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767985149
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Why.20does.20the.20daily.20Nanoda.20check.20allow.20.60Lean.2EtrustCompiler.60.3F/near/567198965\">said</a>:</p>\n<blockquote>\n<p>Also note that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ofReduceBool#doc\">docs#Lean.ofReduceBool</a> is a theorem under <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.trustCompiler#doc\">docs#Lean.trustCompiler</a>:</p>\n</blockquote>\n<p>Why do we even have it as an axiom then?</p>",
        "id": 567243712,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767985211
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Why.20does.20the.20daily.20Nanoda.20check.20allow.20.60Lean.2EtrustCompiler.60.3F/near/567243712\">said</a>:</p>\n<blockquote>\n<p>Why do we even have it as an axiom then?</p>\n</blockquote>\n<p>This is probably a byproduct of the way these axioms were implemented. Originally there were only <code>Lean.ofReduceNat</code> and <code>Lean.ofReduceBool</code>, <a href=\"#narrow/channel/270676-lean4/topic/soundness.20bug.3A.20native_decide.20leakage/near/395967589\">but there were still ways of proving things with <code>native_decide</code> without Lean noticing</a>.</p>",
        "id": 567244658,
        "sender_full_name": "James E Hanson",
        "timestamp": 1767985544
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Why.20does.20the.20daily.20Nanoda.20check.20allow.20.60Lean.2EtrustCompiler.60.3F/near/567243510\">said</a>:</p>\n<blockquote>\n<p>Does anything in mathlib reference <code>trustCompiler</code>?</p>\n</blockquote>\n<p>Anyway, the point is that yes, as Chris said, there are two definitions in (the imports of) Mathlib that reference <code>trustCompiler</code>, which are <code>reduceBool</code> and <code>reduceNat</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">reduceBool</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This ensures that `#print axioms` will track use of `reduceBool`.</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trustCompiler</span>\n<span class=\"w\">  </span><span class=\"n\">b</span>\n\n<span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">reduceNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This ensures that `#print axioms` will track use of `reduceNat`.</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trustCompiler</span>\n<span class=\"w\">  </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>Even though these are opaque, their definitions are still checked by typechecking.</p>",
        "id": 567247203,
        "sender_full_name": "James E Hanson",
        "timestamp": 1767986456
    }
]