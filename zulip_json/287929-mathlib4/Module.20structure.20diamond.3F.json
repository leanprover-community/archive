[
    {
        "content": "<p>I was struggling just now to get a trivial-looking lemma about polynomials to work. The culprit seems to be that we have two ways of exhibiting a <code>ℤ</code>-module structure on the p-adic integers <code>ℤ_[p]</code>, and Mathlib is unable to show that they are the same. (Is this what people here call a \"diamond\"?)</p>\n<p>Here's the best I can do for a MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toIntModule</span><span class=\"w\"> </span><span class=\"n\">ℤ_</span><span class=\"o\">[</span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">castRingHom</span><span class=\"w\"> </span><span class=\"n\">ℤ_</span><span class=\"o\">[</span><span class=\"n\">p</span><span class=\"o\">])</span><span class=\"bp\">.</span><span class=\"n\">toModule</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"c\">/-</span><span class=\"cm\"> tactic 'rfl' failed, the left-hand side</span>\n<span class=\"cm\">  AddCommGroup.toIntModule ℤ_[p]</span>\n<span class=\"cm\">is not definitionally equal to the right-hand side</span>\n<span class=\"cm\">  (Int.castRingHom ℤ_[p]).toModule -/</span>\n</code></pre></div>\n<p>I have no idea how to fix this, and I would be grateful for any insights from the community.</p>\n<p>(Tagging <span class=\"user-mention\" data-user-id=\"630477\">@Scott Carnahan</span>  since I ran into this while trying to implement a suggestion of his on my Mahler-basis PR.)</p>",
        "id": 479542885,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730227335
    },
    {
        "content": "<p>Can you click in the infoview on the <code>AddCommGroup.toIntModule</code> to see what concrete instance about <code>ℤ_[p]</code> it is coming from?</p>",
        "id": 479543297,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730227512
    },
    {
        "content": "<p>Actually, why do you have <code>(Int.castRingHom ℤ_[p]).toModule</code> in your goal?</p>",
        "id": 479543367,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730227547
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingHom.toModule#doc\">docs#RingHom.toModule</a> has a big warning docstring saying it can create diamonds when used</p>",
        "id": 479543464,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730227572
    },
    {
        "content": "<p>Nevermind, it doesn't. It really should! <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 479543552,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730227603
    },
    {
        "content": "<p>Here is my suggestion, concretely: Go through your code, find the first mention of <code>RingHom.toModule</code> and try eliminating it</p>",
        "id": 479544142,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730227839
    },
    {
        "content": "<blockquote>\n<p>Go through your code, find the first mention of <code>RingHom.toModule</code> and try eliminating it</p>\n</blockquote>\n<p>I didn't introduce it myself; it crept into my goal because I had invoked the library lemma <code>Polynomial.eval₂_eq_smeval</code>, whose statement explicitly invokes <code>RingHom.toModule</code>. The code for that lemma is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">eval₂_eq_smeval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">letI</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">toModule</span><span class=\"w\"> </span><span class=\"n\">f</span>\n<span class=\"w\">  </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">eval₂</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">smeval</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>This lemma was added in <span class=\"user-mention\" data-user-id=\"630477\">@Scott Carnahan</span> 's PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/10057\">#10057</a>.</p>",
        "id": 479545734,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730228511
    },
    {
        "content": "<p>That lemma is indeed badly stated. You should not create the <code>R</code>-module structure on <code>S</code> on the fly, but take in an arbitrary one and assume it is equal to <code>RingHom.toModule f</code></p>",
        "id": 479547640,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730229317
    },
    {
        "content": "<p>I would guess that <code>f</code> should be replaced with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingHom.smulOneHom#doc\">docs#RingHom.smulOneHom</a></p>",
        "id": 479547838,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730229396
    },
    {
        "content": "<p>Here I guess all it takes is replacing the <code>letI</code> by <code>[Module R S] (hf : ∀ r x, r • x = f r * x)</code></p>",
        "id": 479547875,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730229411
    },
    {
        "content": "<p>... or what Eric said</p>",
        "id": 479547888,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730229417
    },
    {
        "content": "<p>Either approach is reasonable</p>",
        "id": 479547939,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730229445
    },
    {
        "content": "<p>PR up at <a href=\"https://github.com/leanprover-community/mathlib4/pull/18410\">#18410</a></p>",
        "id": 479550840,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730230621
    }
]