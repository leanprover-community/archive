[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/18959\">#18959</a>, I am hitting a very weird behavior from <code>gcongr</code>. By adding the lemma <code>a ≤ b → Additive.toMul a ≤ Additive.toMul b</code> and alike as <code>gcongr</code> lemmas, <code>gcongr</code> now turns the goal <code>μ s ≤ μ t</code> into <code>inst✝².1 μ s ≤ inst✝².1 μ t</code>.</p>",
        "id": 482186693,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731508577
    },
    {
        "content": "<p>Does anyone know why that might be happening? cc <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span></p>",
        "id": 482186744,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731508591
    },
    {
        "content": "<p>See <code>MeasureTheory.OuterMeasure.Basic</code> for the precise failure</p>",
        "id": 482186804,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731508612
    },
    {
        "content": "<p>Based on your comment in the <code>OuterMeasure</code> file I'll hazard a guess that <code>gcongr</code> only looks at the head of a function application and use that as the key for the lemma. So <code>toMul_mono</code> and all other lemmas you added probably have the same key, namely <code>DFunLike.coe</code>, and one of these lemmas will be tried whenever <code>gcongr</code> sees <code>DFunLike.coe</code>.</p>",
        "id": 482241906,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1731524945
    },
    {
        "content": "<p>Hmm, that looks bad. How should I fix this?</p>",
        "id": 483231143,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1732012723
    },
    {
        "content": "<p>Probably it should be using a DiscrTree instead</p>",
        "id": 483231865,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1732012938
    },
    {
        "content": "<p>I notice <code>with_reducible gcongr</code> still works on that measure theory example, even though <code>gcongr</code> doesn't.  I wonder whether <code>gcongr</code>'s apply step should be at reducible transparency -- and how many of the current library uses it would break if we made that change.  I'll investigate at some point.</p>",
        "id": 483310918,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732035513
    },
    {
        "content": "<p>Even so, it seems a bit dangerous to be tagging gcongr lemmas with the key <code>DFunLike.coe</code> -- seems like it could lead to bad performance (since it's an obvious place where there could be multiple lemmas with the same key).  I'm not convinced that either of these two lemmas (<code>Additive.toMul_mono</code> and <code>measure_mono</code>) need a gcongr tag in their current form.  The <code>to_additive</code> stuff could be handled by hand, and the <code>measure_mono</code> (which invokes the obscure <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OuterMeasureClass#doc\">docs#OuterMeasureClass</a>) could be replaced by two lemmas for the two use cases of that class: outer measures and measures.</p>",
        "id": 483311581,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732035693
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/channel/287929-mathlib4/topic/gcongr.20unfold.20DFunLike.2Ecoe/near/483311581\">said</a>:</p>\n<blockquote>\n<p>it seems a bit dangerous to be tagging gcongr lemmas with the key <code>DFunLike.coe</code></p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/channel/287929-mathlib4/topic/gcongr.20unfold.20DFunLike.2Ecoe/near/483311581\">said</a>:</p>\n<blockquote>\n<p><code>measure_mono</code> (which invokes the obscure <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OuterMeasureClass#doc\">docs#OuterMeasureClass</a>) could be replaced by two lemmas for the two use cases of that class: outer measures and measures.</p>\n</blockquote>\n<p>But the two lemmas would still have a <code>DFunLike.coe</code> key, right?</p>",
        "id": 483311917,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1732035785
    },
    {
        "content": "<p>OK, running the <code>apply</code> in <code>gcongr</code> at a stricter reducibility</p>\n<ul>\n<li>breaks nothing in mathlib</li>\n<li>infinitesimally speeds up mathlib</li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/tree/HM-gcongr_of_add\">fixes Yael's bug</a></li>\n</ul>\n<p>I propose we merge this! <a href=\"https://github.com/leanprover-community/mathlib4/pull/19262\">#19262</a></p>",
        "id": 483348102,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732048377
    },
    {
        "content": "<p>At the same time I think it would be good to investigate how many \"gcongr\" lemmas in mathlib have the <code>DFunLike.coe</code> key. For <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.2FTactic.2FGCongr.20.239393/near/410743964\">a long time</a> I've wished we had a linter or tooling to query what <code>gcongr</code> lemmas are stored with the same key.  That would be a good place to start an investigation ... maybe one of our linter experts would be interested in collaborating with me on this?</p>",
        "id": 483348771,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732048643
    },
    {
        "content": "<p>I was not very precise in my comments about <code>measure_mono</code> -- what I think I'm trying to get at is that the pattern of the lemma seems different between <code>Additive.toMul_mono</code> (which I have a vaguely bad feeling about)</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>@DFunLike.coe\n  (Equiv (Additive α) α)\n  (Additive α)\n  (fun x ↦ α)\n  (@Equiv.instFunLike (Additive α) α)\n  (@toMul α)\n</code></pre></div>\n<p>and my proposed variant of <code>measure_mono</code> (which I have a more positive gut feeling about):</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>@DFunLike.coe\n  (@Measure X inst)\n  (Set X)\n  (fun x ↦ ENNReal)\n  (@Measure.instFunLike X inst)\n  μ\n</code></pre></div>\n<p>I don't want to speculate too far in advance of the facts, but if we were to special-case <code>DFunLike.coe</code> as a <code>gcongr</code> key, we might do something like requiring that the <code>gcongr</code> lemma's invocation of <code>DFunLike.coe</code> be with a free variable in the <code>a</code> slot ... and possibly also <em>not</em> have a free variable in the <code>F</code> slot.</p>",
        "id": 483349723,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1732049013
    },
    {
        "content": "<p>Thanks Heather! Works great</p>",
        "id": 484889097,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1732790230
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/channel/287929-mathlib4/topic/gcongr.20unfold.20DFunLike.2Ecoe/near/483349723\">said</a>:</p>\n<blockquote>\n<p>we might do something like requiring that the <code>gcongr</code> lemma's invocation of <code>DFunLike.coe</code> be with a free variable in the <code>a</code> slot ...</p>\n</blockquote>\n<p>That means we wouldn't be able to use <code>gcongr</code> on any concrete bundled hom, like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Multiset.card#doc\">docs#Multiset.card</a> and similar. Seems sad</p>",
        "id": 484889564,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1732790363
    }
]