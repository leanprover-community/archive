[
    {
        "content": "<p>Can we fix the precedence of <code>!</code> so that the following works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Factorial</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"c1\">-- function expected</span>\n<span class=\"w\">  </span><span class=\"n\">contradiction</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"c1\">-- function expected</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>now it works if we replace <code>3 !</code> by <code>3!</code> or <code>(3 !)</code> (and only the second option is available for <code>n !</code>).</p>",
        "id": 478253033,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729593001
    },
    {
        "content": "<p>what should this parse as, then?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 478253548,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729593217
    },
    {
        "content": "<p>If <code>3!</code> works then I don't think there's any problem here</p>",
        "id": 478256215,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1729594261
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478253548\">said</a>:</p>\n<blockquote>\n<p>what should this parse as, then?</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>As garbage, I would say. Can we force the user to not put a space before <code>!</code> for the factorial notation, and after for the Bool notation?</p>",
        "id": 478256853,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1729594476
    },
    {
        "content": "<p>Only if we force <code>(n)!</code> instead of <code>n !</code></p>",
        "id": 478257209,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729594611
    },
    {
        "content": "<p>But we can write <code>a*b</code> instead of <code>a * b</code>. This issue with factorial has always made me a bit sad but I don't understand the details enough. Is it something to do with the fact that <code>get!</code> is now a thing?</p>",
        "id": 478257993,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729594928
    },
    {
        "content": "<p>i think you might be able to force it if you write it as a parser?</p>",
        "id": 478258213,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729595037
    },
    {
        "content": "<p>Yes, the fact that function names are now allowed to end in <code>!</code> is exactly the problem with <code>n!</code></p>",
        "id": 478258497,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729595130
    },
    {
        "content": "<p>note that if we made the rule \"try the name <code>n!</code> then try <code>factorial n</code>\", there would be a footgun for people writing <code>x.get!</code> who didn't realize that <code>X.get!</code> doesn't exist</p>",
        "id": 478258684,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729595211
    },
    {
        "content": "<p>The current behavior combined with <code>autoImplicit</code> is pretty nasty:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n!</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span>\n</code></pre></div>",
        "id": 478259091,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729595352
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478253548\">said</a>:</p>\n<blockquote>\n<p>what should this parse as, then?</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I didn't even realize that the problem I had with <code>!</code> was because of Boolean negation. The error message is so unhelpful...</p>",
        "id": 478267539,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729598324
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478259091\">said</a>:</p>\n<blockquote>\n<p>The current behavior combined with <code>autoImplicit</code> is pretty nasty:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n!</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">  </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<blockquote>\n<p>A: there is a number <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span> that is greater than <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo stretchy=\"false\">!</mo></mrow><annotation encoding=\"application/x-tex\">n!</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">!</span></span></span></span></p>\n</blockquote>\n<blockquote>\n<p>B: oh really? how do you know?</p>\n</blockquote>\n<blockquote>\n<p>A: just define <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo>:</mo><mo>=</mo><mi>n</mi><mo stretchy=\"false\">!</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">n := n! + 1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">:=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">!</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> and you're done</p>\n</blockquote>\n<p><span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 478270756,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729599403
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478257209\">said</a>:</p>\n<blockquote>\n<p>Only if we force <code>(n)!</code> instead of <code>n !</code></p>\n</blockquote>\n<p>Actually, this notation is not too bad. I will just tell my students that parentheses are mandatory.</p>",
        "id": 478277958,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729601691
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478259091\">said</a>:</p>\n<blockquote>\n<p>The current behavior combined with <code>autoImplicit</code> is pretty nasty:</p>\n</blockquote>\n<p>Personally I'm not worried about this, since <code>autoImplicit</code> is plenty nasty by itself. I want to like it, it's just too easy to mess up.</p>",
        "id": 478278139,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729601752
    },
    {
        "content": "<p>Wait till you see what <code>autoImplicit!</code> does (-;</p>",
        "id": 478280233,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1729602321
    },
    {
        "content": "<p><code>(n)!</code> instead of <code>n!</code> will also be helpful if anyone ever wants to do stuff with double factorials</p>",
        "id": 478283279,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1729603165
    },
    {
        "content": "<p>Like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.doubleFactorial#doc\">docs#Nat.doubleFactorial</a> ?</p>",
        "id": 478285059,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1729603675
    },
    {
        "content": "<p>surprisingly, i think that would have less issues because that notation uses a different(‼) symbol.</p>",
        "id": 478285456,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729603784
    },
    {
        "content": "<p>(see what i did there) <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 478285622,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729603819
    },
    {
        "content": "<p>Are people opposed to some unicode trickery here?</p>",
        "id": 478286589,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1729604058
    },
    {
        "content": "<p>i think in general people should try and not use unicode symbols which can easily be confused for other more common ones...</p>",
        "id": 478286836,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729604129
    },
    {
        "content": "<p>notation should be readable, not just (<em>hover-to-find-out-what-it-means</em>)-able</p>",
        "id": 478287133,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729604211
    },
    {
        "content": "<p>At least we have hover, unlike math papers :)</p>",
        "id": 478288485,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1729604540
    },
    {
        "content": "<p>i know, but that should not discourage us from trying to be clear</p>",
        "id": 478288645,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1729604580
    },
    {
        "content": "<p>I remember <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> and I made a <code>n!</code> elaborator a while back. It's a <em>big</em> hack, but it does improve the experience. <strong>Edit:</strong> Found it: <a href=\"#narrow/channel/287929-mathlib4/topic/New.20.60propose.60.20tactic/near/351149815\">https://leanprover.zulipchat.com/#narrow/channel/287929-mathlib4/topic/New.20.60propose.60.20tactic/near/351149815</a></p>\n<p>The way it works is that overrides how constants are elaborated. It tries searching for <code>n!</code>. That fails, notices there's a <code>!</code> at the end, then tries searching for <code>n</code>. If that succeeds, it wraps it in <code>Nat.factorial</code>.</p>\n<p>(Yes <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>, this is because <code>get!</code> etc. are supported as names now.)</p>",
        "id": 478313941,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729611084
    },
    {
        "content": "<p>I'm not sure how serious I am about actually overriding the const elaborator here... <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/TypeStar.lean#L4\">Foolish users</a> who have created notations relying on hacks have been causing me headaches recently. <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 478314415,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729611222
    },
    {
        "content": "<p>If anyone wants to have fun with it, here's an updated version:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code for x! notation</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Data.Nat.Factorial.Basic</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Nat.Factorial</span><span class=\"bp\">!</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">scoped</span><span class=\"w\"> </span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">elabIdentFactorial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">@`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">view</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">extractMacroScopes</span><span class=\"w\"> </span><span class=\"n\">name.getId</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">view.name</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">    </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">s.endsWith</span><span class=\"w\"> </span><span class=\"s2\">\"!\"</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">normal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term.observing</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">elabIdent</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"bp\">?</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">normal</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">name'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MacroScopesView.review</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">view</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s.dropRight</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">factorial</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term.observing</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Nat.factorial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">name'</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"bp\">?</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">factorial</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term.applyResult</span><span class=\"w\"> </span><span class=\"n\">factorial</span>\n<span class=\"w\">    </span><span class=\"n\">Term.applyResult</span><span class=\"w\"> </span><span class=\"n\">normal</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">Factorial</span><span class=\"bp\">!</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">scoped</span><span class=\"w\"> </span><span class=\"n\">Nat.Factorial</span><span class=\"bp\">!</span>\n\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"c1\">-- x ! : ℕ</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">!</span><span class=\"w\">  </span><span class=\"c1\">-- x ! : ℕ</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">List.get</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"c1\">-- [1, 2, 3].get! 0 : ℕ</span>\n</code></pre></div>\n<p>The macro scope manipulation is to get things like this to \"work\":</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">quotPrecheck</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"factfun\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">!</span>\n\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">factfun</span><span class=\"w\"> </span><span class=\"c1\">-- fun x ↦ x ! : ℕ → ℕ</span>\n</code></pre></div>\n</div></div>",
        "id": 478317218,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729612091
    },
    {
        "content": "<p>I used that hack in my course <a href=\"https://github.com/fpvandoorn/LeanCourse23/blob/master/LeanCourse/Common.lean#L89\">last year</a>, but decided against it this year. Was sad to see the issue at the top if this thread, but I told them to write <code>(n)!</code> with parentheses.</p>",
        "id": 478326061,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729614993
    },
    {
        "content": "<p>Should we add <code>noWs</code> to the factorial parser so that <code>n !</code> is illegal?</p>",
        "id": 478332989,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729617532
    },
    {
        "content": "<p>This looks like it'll require a core fix for the parenthesizer. Having <code>noWs</code> would make it pretty print as <code>n!</code> at the moment.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"?\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">sqrt</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">sqrt</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpandNatSqrt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"bp\">?</span>\n<span class=\"c1\">-- 5?</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"c1\">-- fun x ↦ x? : Nat → Nat</span>\n</code></pre></div>",
        "id": 478335617,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729618535
    },
    {
        "content": "<p>There's not a clear fix. Parenthesis insertion occurs in a phase before formatting, but this lexical issue can only be detected at formatting time.</p>",
        "id": 478336049,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729618678
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478332989\">said</a>:</p>\n<blockquote>\n<p>Should we add <code>noWs</code> to the factorial parser so that <code>n !</code> is illegal?</p>\n</blockquote>\n<p>Banning it outright might be a little extreme (although I'm not against it), but we can start by saying it is the preferred way to write the factorial function, and pointing out the danger of writing <code>n !</code> in the docstring for the notation.<br>\nThen we should also fix the ~300 occurrences found by regex <code>[^a-zA-Z][a-z] ![^[=!]</code> in Mathlib.</p>",
        "id": 478337451,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729619153
    },
    {
        "content": "<p>This seems to work <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"?\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">sqrt</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">sqrt</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpandNatSqrt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">))</span><span class=\"bp\">?</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$_</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">))</span><span class=\"bp\">?</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"bp\">?</span>\n<span class=\"c1\">-- (5)?</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"c1\">-- (1 + 5)?</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">?</span>\n<span class=\"c1\">-- fun x ↦ (x)? : Nat → Nat</span>\n</code></pre></div>\n<p>(yes, it's a hack, but not an awful one)</p>",
        "id": 478337651,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729619225
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> Your original example's problem seems to be that <code>use</code> doesn't require that the terms coming after it to say after the column that <code>use</code> starts on. In fact, this is legal:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">use</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">contradiction</span>\n</code></pre></div>",
        "id": 478337935,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729619334
    },
    {
        "content": "<p>This is not just a problem with <code>use</code>. Pretty much any tactic taking a term has no column requirements:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span>\n<span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">?_⟩</span>\n<span class=\"w\">  </span><span class=\"n\">contradiction</span>\n</code></pre></div>",
        "id": 478338033,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729619373
    },
    {
        "content": "<p>It's parsing yours as <code>3 (! contradiction)</code> using the <code>not</code> syntax, even though <code>contradiction</code> is on its own line in the correct column and looking very much like it should be a tactic.</p>",
        "id": 478338092,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729619403
    },
    {
        "content": "<p>Yes, I think a lot of tactics don't require that, and it's somewhat reasonable since the expression argument is mandatory, so usually there is no ambiguity. I think it's fine to consistently add this to tactic parsers, but that is a pretty big change.<br>\nI've seen some beginners write </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">calc</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply</span>\n<span class=\"w\">    </span><span class=\"n\">foo</span>\n</code></pre></div>\n<p>but I think it's fine to disallow that.</p>",
        "id": 478338534,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729619589
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478337451\">said</a>:</p>\n<blockquote>\n<p>Banning it outright might be a little extreme (although I'm not against it), but we can start by saying it is the preferred way to write the factorial function, and pointing out the danger of writing <code>n !</code> in the docstring for the notation.<br>\nThen we should also fix the ~300 occurrences found by regex <code>[^a-zA-Z][a-z] ![^[=!]</code> in Mathlib.</p>\n</blockquote>\n<p>If we want this, here is the docstring change: <a href=\"https://github.com/leanprover-community/mathlib4/pull/18085\">#18085</a></p>",
        "id": 478339061,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729619823
    },
    {
        "content": "<p>The idea to make factorial use <code>noWs</code> is sort of a hack because the issue here is from <code>a ! b</code> being ambiguous. Using <code>noWs</code> is making use of the following feature of application parsing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">not</span><span class=\"o\">)</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"c1\">--          ^ error because function applications require whitespace after the function</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">not</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"c1\">-- !!true</span>\n</code></pre></div>",
        "id": 478339142,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729619861
    },
    {
        "content": "<p>If anyone can figure out how to change the second <code>notation</code> to get the third <code>#eval</code> to print 9, then you've cracked the problem for factorial notation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"~\"</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"~\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·*</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">~</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\">   </span><span class=\"c1\">-- 6</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">·*</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">   </span><span class=\"c1\">-- 9</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·*</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">     </span><span class=\"c1\">-- want 9, but it's 6</span>\n</code></pre></div>",
        "id": 478342339,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729620979
    },
    {
        "content": "<p>How bad would it to not allow a space in the Boolean negation notation <code>!b</code>? I expect we don't want to go that route, but at least that would not be ambiguous since names cannot start with <code>!</code>.</p>",
        "id": 478345917,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729622372
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478342339\">said</a>:</p>\n<blockquote>\n<p>If anyone can figure out how to change the second <code>notation</code> to get the third <code>#eval</code> to print 9, then you've cracked the problem for factorial notation:</p>\n</blockquote>\n<p>Like this? However, this would require parentheses in <code>f !b</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"~\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"mi\">1022</span><span class=\"w\"> </span><span class=\"s2\">\"~\"</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- or lower 1022</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·*</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">~</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\">   </span><span class=\"c1\">-- 6</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">·*</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">   </span><span class=\"c1\">-- 9</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·*</span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">     </span><span class=\"c1\">-- now 9</span>\n</code></pre></div>",
        "id": 478346656,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729622718
    },
    {
        "content": "<p>What if <code>!b</code> has precedence <code>max</code> and <code>! b</code> (with space) has precedence <code>&lt;1022</code> <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> <br>\n(I think you can start ignoring me, I think I'm starting to sound more like a monkey on a typewriter than usual.)</p>",
        "id": 478346941,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729622856
    },
    {
        "content": "<p>Hmm, <code>notation:lead \"~\" b:40 =&gt; b + 1</code> works too. I'm a <span aria-label=\"monkey\" class=\"emoji emoji-1f412\" role=\"img\" title=\"monkey\">:monkey:</span> too though</p>",
        "id": 478347149,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729622950
    },
    {
        "content": "<p>(Ah, and <code>lead</code> is 1022, so makes sense...)</p>",
        "id": 478347276,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1729623005
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478345917\">said</a>:</p>\n<blockquote>\n<p>How bad would it to not allow a space in the Boolean negation notation <code>!b</code>? I expect we don't want to go that route, but at least that would not be ambiguous since names cannot start with <code>!</code>.</p>\n</blockquote>\n<p>Empirically, in the Lean 4 repo there are 700 hits for <code>[^\\]a-zA-Z-0-9]![(a-zA-Z]</code> (and almost all of them are Boolean negation) and only 5 hits for <code>[^\\]a-zA-Z-0-9]! </code> (including a trailing space) (4 of them in a test) (both patterns only include <code>*.lean</code> files). <br>\nSo code-style wise there seems to be already a firmly established code style to not add a space after the Boolean negation <code>!</code>. But it's up to the FRO to decide whether they want to enforce this (especially if the main reason is to avoid a pretty obscure interaction with <code>Nat.factorial</code>).</p>",
        "id": 478579921,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729716173
    },
    {
        "content": "<p>To keep <a href=\"https://github.com/leanprover-community/mathlib4/pull/18085\">#18085</a> moving along, what are the possible options here? Should we have a poll about whether to prefer <code>(n)!</code> over <code>n !</code> in mathlib, or are there some other issues that could / should be resolved in core that I missed?</p>",
        "id": 479281662,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1730123654
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5824\">lean4#5824</a> and <a href=\"https://github.com/leanprover/lean4/pull/5826\">lean4#5826</a> are two experiments, the first is changing the precedence of boolean <code>!</code>, and the second is making it require whitespace. I think the first solution is makes more sense than the second, but I'm not sure if or when we'd change core notation. We need some sort of cooperation with core to solve the issue of confusing error message, no matter how we decide to parenthesize factorial in mathlib.</p>",
        "id": 479297104,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730127936
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/479281662\">said</a>:</p>\n<blockquote>\n<p><code>(n)!</code> over <code>n !</code></p>\n</blockquote>\n<p>At least with the second, <code>(n !)</code> can be used in the <code>use</code> example to avoid the confusing error.</p>",
        "id": 479297278,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1730127979
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18085\">#18085</a> is apparently still blocked on this discussion. I would prefer to simply merge it.</p>\n<p>If another maintainer seconds this motion, please just merge it.</p>",
        "id": 500761014,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1740006781
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478286589\">said</a>:</p>\n<blockquote>\n<p>Are people opposed to some unicode trickery here?</p>\n</blockquote>\n<p>Do you mean full width one <code>！</code> ?</p>",
        "id": 500925371,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740070025
    },
    {
        "content": "<p>I don't know the history of <code>\\|</code> for divisibility, but I could imagine it was: \"mathematicians wanted a symbol for divisibility and | was taken for set notation so they used <code>\\|</code>\". In Lean 4 the situation is analogous: mathematicians want a symbol for factorial, but now <code>!</code> is taken already so we use some unicode hack <code>\\!</code> and just tell people that it's because ! means something else in core Lean.</p>",
        "id": 500926163,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740070242
    },
    {
        "content": "<p>There seem to be several variants available: <a href=\"https://www.amp-what.com/unicode/search/exclamation\">https://www.amp-what.com/unicode/search/exclamation</a></p>",
        "id": 500926348,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740070293
    },
    {
        "content": "<p>Oh, we could use <span aria-label=\"exclamation\" class=\"emoji emoji-2757\" role=\"img\" title=\"exclamation\">:exclamation:</span></p>",
        "id": 500927315,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1740070554
    },
    {
        "content": "<p>Unicode trickery is sad, but it really would help solve the problem.</p>\n<p>There's <code>nǃ</code> (pronounced \"enn <em>alveolar click</em>\")</p>\n<p>The full-width exclamation <code>n！</code> would help distinguish <code>n！！</code> from <code>n‼</code>, but it does look a bit funny.</p>",
        "id": 500945430,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740076438
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/500926163\">said</a>:</p>\n<blockquote>\n<p>I don't know the history of <code>\\|</code> for divisibility, but I could imagine it was: \"mathematicians wanted a symbol for divisibility and | was taken for set notation so they used <code>\\|</code>\". </p>\n</blockquote>\n<p>I think it's more likely \"Unicode decided that the existing <code>|</code> character used in computer code was semantically different from the divides symbol used in mathematics, so they allocated a symbol for it\".</p>",
        "id": 500947252,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740077087
    },
    {
        "content": "<p>My (probably weak) argument against that was that in LaTeX we use <code>|</code> in both <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">{</mo><mi>x</mi><mtext> </mtext><mi mathvariant=\"normal\">∣</mi><mtext> </mtext><msup><mi>x</mi><mn>2</mn></msup><mo>=</mo><mn>2</mn><mo stretchy=\"false\">}</mo></mrow><annotation encoding=\"application/x-tex\">\\{x\\,|\\,x^2=2\\}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mopen\">{</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">∣</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">2</span><span class=\"mclose\">}</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>5</mn><mtext> </mtext><mi mathvariant=\"normal\">∣</mi><mtext> </mtext><mn>15</mn></mrow><annotation encoding=\"application/x-tex\">5\\,|\\,15</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">∣</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">15</span></span></span></span>.</p>",
        "id": 500949391,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740077775
    },
    {
        "content": "<p>You should use <code>\\mid</code> for the first one.</p>",
        "id": 500949498,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740077816
    },
    {
        "content": "<p>instead of managing space by hand.</p>",
        "id": 500949534,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740077830
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/500949498\">said</a>:</p>\n<blockquote>\n<p>You should use <code>\\mid</code> for the first one.</p>\n</blockquote>\n<p>For divisibility, too (IMO). Note that non-divisibility is <code>\\nmid</code>.</p>",
        "id": 500949845,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1740077942
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/500949498\">said</a>:</p>\n<blockquote>\n<p>You should use <code>\\mid</code> for the first one.</p>\n</blockquote>\n<p>Ha ha I knew this but felt it weakened my argument :-) In fact you should use <code>\\mid</code> for the second one too, as it's a binary operator.</p>",
        "id": 500950418,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740078130
    },
    {
        "content": "<p>/poll Straw poll: What should we do about <code>Nat.factorial</code> notation?<br>\nWait and hope that Lean core does something to help<br>\nThe current situation (writing<code>n !</code> and having unexpected parse errors) is fine<br>\nSwitch to <code>ǃ</code> (alveolar click)<br>\nSwitch to <code>！</code> (two-character-width exclamation)<br>\nSwitch to <code>❗</code> (emoji)<br>\nUse a more ridiculous option: <code>🆙</code> (votes for this count as \"abstain\")</p>",
        "id": 500952243,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740078795
    },
    {
        "content": "<p>(A \"straw poll\" means this is a non-binding vote. It's just to get a sense of what people thing is acceptable.)</p>",
        "id": 500952284,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740078820
    },
    {
        "content": "<p>Can you straw-disambiguate the first two options, what's the difference between \"wait for Lean core\" and \"leave things as-is\"? Does the second one mean someone thinks there's no issue whatsoever?</p>",
        "id": 500953053,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740079115
    },
    {
        "content": "<p>Yes, second means no issue whatsoever. The situation is fine as-is, people should just learn to deal with it.</p>",
        "id": 500953119,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740079146
    },
    {
        "content": "<p>I meant to have that one come first, since all the others involve change (except for <code>n🆙</code>, which I hope we'll never do).</p>",
        "id": 500953279,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740079203
    },
    {
        "content": "<p>There's a variant to <a href=\"https://github.com/leanprover-community/mathlib4/pull/18085\">#18085</a> <span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span>. What if the notation required parentheses like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"!\"</span>\n</code></pre></div>",
        "id": 500953562,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740079304
    },
    {
        "content": "<p>My vote for the alveolar click is contingent on it being acceptable to make <code>\\!</code> produce this character (right now in VS Code it produces <code>¡</code>, so <a href=\"https://github.com/leanprover/vscode-lean4/blob/f95786de5d9ca8912c45a36a1d941cb96446ce65/lean4-unicode-input/src/abbreviations.json#L80C2-L80C14\">this line</a> needs changing).</p>",
        "id": 500953711,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740079346
    },
    {
        "content": "<p>Me too <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span></p>",
        "id": 500953788,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740079375
    },
    {
        "content": "<p><del>Isn't the solution then to make <code>\\!</code> produce <code> !</code> and now done?</del> if only...</p>",
        "id": 500953887,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740079420
    },
    {
        "content": "<p>If we go for <code>(n)!</code>, there are indeed questions whether we want to enforce it, or only encourage it.</p>",
        "id": 500953984,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740079447
    },
    {
        "content": "<p>Is it better to have <code>syntax \"(\" term \")\" noWs \"!\"</code> over <code>syntax term noWs \"!\"</code> (other than the pretty-printer not round-tripping), since the latter allows <code>2!</code>?</p>",
        "id": 500953988,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740079449
    },
    {
        "content": "<p>No that doesn't work, see the first example in this thread <span class=\"user-mention\" data-user-id=\"321696\">@Julian Berman</span></p>",
        "id": 500953989,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1740079449
    },
    {
        "content": "<p>I personally dislike the fact that mathlib uses very similar characters like | and ∣, and I hope that we don't add more. In particular,  I think people will see 'n &lt;alveolar click&gt;' when reading code, interpret it as being 'n!' with the usual exclamation point, and see a confusing error when they try it out themselves.</p>",
        "id": 501370705,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1740313844
    },
    {
        "content": "<p>I think using similar characters is ok if they are unicode-approved for their purpose (divides vs regular<code>|</code>), but less so if we're abusing graphically similar but semantically inappropriate characters like alveolar click.</p>",
        "id": 501373917,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740316674
    },
    {
        "content": "<p>That is, unless we start a movement to read factorial out loud with such a click</p>",
        "id": 501373976,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740316700
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"753178\">Aaron Hill</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/501370705\">said</a>:</p>\n<blockquote>\n<p>I personally dislike the fact that mathlib uses very similar characters like | and ∣, and I hope that we don't add more. In particular,  I think people will see 'n &lt;alveolar click&gt;' when reading code, interpret it as being 'n!' with the usual exclamation point, and see a confusing error when they try it out themselves.</p>\n</blockquote>\n<p>I don't buy this argument because <code>n!</code> <em>already gives a confusing error</em>!</p>",
        "id": 501375978,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740318269
    },
    {
        "content": "<p>I think adjusting the lean-core behavior would be the right solution to that parse error, rather than introducing a new way to write factorial</p>",
        "id": 501376541,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1740318795
    },
    {
        "content": "<p>Also, I think the experience for users is worse when they get an error trying to replicate exisiting (working) code due to using the wrong unicode character</p>",
        "id": 501376758,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1740318907
    },
    {
        "content": "<p>If I hadn't seen this thread and I saw '(n+1)!=(n+1)*n&lt;alveolar click&gt;', I would expect that the same '!' character was used twice, and not two distinct (but intentionally visually similar) characters</p>",
        "id": 501377889,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1740319311
    },
    {
        "content": "<p>The change would universally replace factorial with the click, so the same character would be used twice. In my experience people don't trip up on divisibility because they look at code in mathlib and see what symbol is used. I don't think that the core devs have any interest in changing how they use <code>!</code> (all this <code>get!</code> stuff is a core part of the naming convention there) and \"mathematicians have used it in another way for hundreds of years\" will not convince them, they have far more important things to worry about. So we have to work around their decisions in mathlib and changing the symbol is the lesser of all the evils which has been suggested as far as I can see. I totally appreciate your objections but the \"use another unicode character\" approach is a solution which has worked fine in other parts of number theory and if we add the explanation that you use <code>\\!</code> to the factorial docstring then I think we should be fine.</p>",
        "id": 501378547,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740319633
    },
    {
        "content": "<p>Would we deprecate <code>!</code> In favor of &lt;click&gt;, or allow both but exclusively use &lt;click&gt; inside of mathlib itself?</p>",
        "id": 501378763,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1740319802
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.factorial#doc\">docs#Nat.factorial</a> is in mathlib and it would just be a case of changing the notation and then removing all the horrible spaces in the theorems like <code>factorial_succ (n : ℕ) : (n + 1)! = (n + 1) * n !</code>.</p>",
        "id": 501379046,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740320030
    },
    {
        "content": "<p>I mean, would downstream users eventually use &lt;click&gt; as the only supported factorial notation?</p>",
        "id": 501379374,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1740320288
    },
    {
        "content": "<p>If this change were to be made then yes, just like downstream users don't use the <code>|</code> symbol on their keyboard to talk about divisibility.</p>",
        "id": 501379436,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740320349
    },
    {
        "content": "<p>Downstream users would of course be free to define their own notation using <code>!</code> and then they'll run into the parsing problems which we currently face in mathlib because of core's decision to allow <code>!</code> in identifiers and the clash with boolean not (also in core and also unlikely to be changeable).</p>",
        "id": 501379630,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740320517
    },
    {
        "content": "<blockquote>\n<p>\"mathematicians have used it in another way for hundreds of years\" will not convince them</p>\n</blockquote>\n<p>This is a bit of a strawman isn't it (by which I mean I don't think the choice is presumed to be \"convince core not to call things <code>get!</code>, it's \"make <code>get!</code> work, and make <code>n!</code> work when <code>n!</code> is not an identifier)? The actual shape of a core change I presume would be something more like \"allow suffix notations a chance at parsing something that looks like an identifier if that identifier ends up not existing\", and though I have never written anything like one I would bet there are some other cases where this might be useful beyond this specific math notation.</p>\n<p>Anyways I get that it's annoying and perhaps \"we can hack around this\" is very attractive (and maybe even the right solution given how long the wait) but I also don't think that using crazy confusable characters has zero ongoing cost (which is even why I felt comfortable voting personally).</p>",
        "id": 501383903,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740323955
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/478258684\">said</a>:</p>\n<blockquote>\n<p>note that if we made the rule \"try the name <code>n!</code> then try <code>factorial n</code>\", there would be a footgun for people writing <code>x.get!</code> who didn't realize that <code>X.get!</code> doesn't exist</p>\n</blockquote>\n<p>what do you mean by this? as in someone would get strange errors in a file where <code>n!</code> meant factorial and then tried <code>.get!</code> on something where it didn't exist (but <code>.get</code> does)  and then the errors say things about taking factorials of some function? Isn't the \"fix\" there \"just\"™ \"when a second error happens, show the first error (the identifier one)\"?</p>",
        "id": 501385705,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740325232
    },
    {
        "content": "<p>I'm thinking of the case where the user thinks both <code>get</code> and <code>get!</code> exist, but in fact only the former does (they haven't written it yet, they put it in the wrong namespace, etc). If they're unfortunate enough to have <code>foo.get : Nat</code>, then they are in for a nasty surprise when their naturals are <em>way</em> bigger than intended.</p>",
        "id": 501431028,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740362361
    },
    {
        "content": "<p>(Aside, I'm progressively getting rid of <code>get!</code> across multiple namespaces. Users should use <code>xs[i]!</code> notation, and where the functions need to exist they are being renamed <code>get!Internal</code>.)</p>",
        "id": 501460179,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740380868
    },
    {
        "content": "<p>I expect that there will still be identifiers ending with <code>!</code> after this, however.</p>",
        "id": 501460489,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740380928
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/precedence.20of.20Nat.2Efactorial/near/501460179\">said</a>:</p>\n<blockquote>\n<p>Users should use <code>xs[i]!</code> notation</p>\n</blockquote>\n<p>Same problem, if users think both <code>[ ]</code> and <code>[ ]!</code> exist, but only <code>[ ]</code> exists and is of type <code>Nat</code></p>",
        "id": 501461417,
        "sender_full_name": "Jz Pan",
        "timestamp": 1740381118
    },
    {
        "content": "<p>My position all along has been that there is nothing wrong with the word <code>factorial</code>, and the benefits of notation for it are outweighed by the downsides...</p>",
        "id": 501461918,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740381215
    }
]