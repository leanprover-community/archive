[
    {
        "content": "<p>Am I correct in believing that instance loops are troublesome for the typeclass machinery? </p>\n<p>I just noticed that, for a topological space <code>X</code>, we have instances showing that</p>\n<p>\"if <code>X</code> is <code>TotallySeparated</code>, then it is <code>TotallyDisconnected</code>\" (here: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TotallySeparatedSpace.totallyDisconnectedSpace#doc\">docs#TotallySeparatedSpace.totallyDisconnectedSpace</a>)</p>\n<p>and also</p>\n<p>\"if <code>X</code> is <code>TotallyDisconnected</code> and also compact Hausdorff, then it is <code>TotallySeparated</code>\" (here: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instTotallySeparatedSpace#doc\">docs#instTotallySeparatedSpace</a>)</p>\n<p>My understanding was that this sort of thing -- having two instances \"A implies B\" and \"B and C imply A\" -- was problematic, and usually the solution was that the second implication shouldn't be an instance. However, for this example, having both instances so far doesn't seem to be causing problems, and removing the second instance causes various proofs about profinite spaces to break.</p>",
        "id": 489704568,
        "sender_full_name": "David Loeffler",
        "timestamp": 1734510844
    },
    {
        "content": "<p>This didn't work in lean 3 but it's supposed to work in lean 4. There may still be rough edges, though, because it's not used all that much</p>",
        "id": 489705206,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1734511068
    },
    {
        "content": "<p>Lean 4 automatically handles instance loops so long as the looping typeclass searches are <em>strictly identical</em>. In practice this means that the same (but not strictly the same, eg because of the instance arguments being defeq but not synteq) typeclass search can be performed several times before the loop stabilizes</p>",
        "id": 489735192,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1734521090
    },
    {
        "content": "<p>Is stabilization guaranteed?</p>",
        "id": 489815224,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734545533
    },
    {
        "content": "<p>I am confident we could find a counter-example given some effort <span aria-label=\"smiling devil\" class=\"emoji emoji-1f608\" role=\"img\" title=\"smiling devil\">:smiling_devil:</span></p>",
        "id": 489828296,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1734550389
    },
    {
        "content": "<p>In fact, it might as easy as digging up one of the few PRs that tried adding those looping instances. Some went through, some didn't because of timeouts. I assume those timeouts were due to non-stabilization of the TC calls.</p>",
        "id": 489828442,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1734550449
    },
    {
        "content": "<p>I guess I'm asking about the more abstract distinction between intractably long and actually non-terminating</p>",
        "id": 489829869,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734551160
    },
    {
        "content": "<p>This works, although this might not be exactly what you mean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">i2</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>",
        "id": 489971911,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1734617178
    },
    {
        "content": "<p>Yeah, that's not really what I mean, since it reproduces as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 490001042,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734626045
    },
    {
        "content": "<p>I claim that all non-terminating loops are essentially this, with more complicated <code>id</code> functions and possible in implicit/instance variables of the class</p>",
        "id": 490013635,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1734628471
    }
]