[
    {
        "content": "<p>I found the following warning appears when import <code>Mathlib</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Tactic</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">Forbidden set_option `pp.mvars`; please remove</span>\n<span class=\"cm\">note: this linter can be disabled with `set_option linter.setOption false`</span>\n<span class=\"cm\">-/</span>\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp.mvars</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"c1\">-- no warning</span>\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>",
        "id": 449608014,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1720330564
    },
    {
        "content": "<p>Why do I get this warning?</p>",
        "id": 449608030,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1720330585
    },
    {
        "content": "<p>Why is <code>pp.mvars</code> banned?</p>",
        "id": 449608044,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1720330605
    },
    {
        "content": "<p>Do you need it checked in? Is it useful to you for something else than debugging?</p>",
        "id": 449610804,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720332216
    },
    {
        "content": "<p>this question is just for curiosity</p>",
        "id": 449612676,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1720334257
    },
    {
        "content": "<p>Then: because it's only useful for debugging and shouldn't be checked in</p>",
        "id": 449614651,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720335922
    },
    {
        "content": "<p>Can we update this linter so it makes explicit the idea that of course you can use this while debugging, and that the \"forbidden\" is only about committing to the repo?</p>",
        "id": 449666047,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720362702
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14491\">#14491</a></p>\n<p>I found it somewhat hard to convey the message: feel free to suggest improvements!</p>",
        "id": 449680571,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720368536
    },
    {
        "content": "<p>Is it possible for the linter to tell whether the file it is linting is a mathlib file (inside <code>Mathlib/**</code>) or a file that is just using mathlib as a dependency? I would guess this warning only needs to be for files that are intended to be PR'd to mathlib.</p>",
        "id": 449681345,
        "sender_full_name": "Richard Osborn",
        "timestamp": 1720368769
    },
    {
        "content": "<p>I would propose actually that we leave this active by default for downstream projects, and only add such logic if/when someone complains. If no one complains, then it's just a helpful linter that improves code quality downstream.</p>",
        "id": 449681736,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720368907
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"560559\">Richard Osborn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.60pp.2Emvars.60.20forbidden.3F/near/449681345\">said</a>:</p>\n<blockquote>\n<p>Is it possible for the linter to tell whether the file it is linting is a mathlib file (inside <code>Mathlib/**</code>) or a file that is just using mathlib as a dependency? I would guess this warning only needs to be for files that are intended to be PR'd to mathlib.</p>\n</blockquote>\n<p>While I agree with leaving the option on, the linter has access to the name of the file.  In particular, you could make the linter silent on files not inside <code>Mathlib</code>.  One of the linters does that, I forget which one.</p>",
        "id": 449683787,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720369554
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.60pp.2Emvars.60.20forbidden.3F/near/449683787\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"560559\">Richard Osborn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.60pp.2Emvars.60.20forbidden.3F/near/449681345\">said</a>:</p>\n<blockquote>\n<p>Is it possible for the linter to tell whether the file it is linting is a mathlib file (inside <code>Mathlib/**</code>) or a file that is just using mathlib as a dependency? I would guess this warning only needs to be for files that are intended to be PR'd to mathlib.</p>\n</blockquote>\n<p>While I agree with leaving the option on, the linter has access to the name of the file.  In particular, you could make the linter silent on files not inside <code>Mathlib</code>.  One of the linters does that, I forget which one.</p>\n</blockquote>\n<p>We could combine these ideas, and adjust the error message in downstream projects - to avoid mentioning \"mathlib\", for instance.</p>",
        "id": 449696173,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720374750
    },
    {
        "content": "<p>If you want it to be conditioned on being in mathlib, I think the test could be <code>(‚Üê getMainModule).getRoot == `Mathlib</code></p>",
        "id": 449698078,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720375619
    },
    {
        "content": "<p>What Kyle said is what I had in mind (with some thought about possibly also including <code>test</code>, <code>Archive</code>, <code>Counterexamples</code>).  For the moment, I will just leave it always on, though.</p>",
        "id": 449706459,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720379518
    },
    {
        "content": "<p>I just pushed yet another version of the message:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Setting</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"n\">starting</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">debug'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">pp'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">profiler'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">trace'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">intended</span>\n<span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">development</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">final</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">intend</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">submit</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">contribution</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span>\n<span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">project</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">please</span><span class=\"w\"> </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">output'</span><span class=\"bp\">.</span>\n<span class=\"n\">note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">disabled</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">setOption</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>I like explicitly mentioning what the rules of the linter are, hence the message contains <code>'debug', 'pp', 'profiler', 'trace'</code>.  This list is embedded in the code in such a way that the natural way of modifying it will also update automatically the message, maintaining it in sync.</p>\n<p>I agree with the desire to avoid PR and CI in the message, but I think that mentioning <code>Mathlib</code> is important, since when submitting there the command should be removed.</p>\n<p>I like mentioning explicitly also what exact <code>set_option</code> was used and the \"please remove ...` does that.</p>\n<p>Unless someone dislikes this message and says so in the next hour or so, I will proceed to merge!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 449709826,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720381543
    },
    {
        "content": "<p>Nice! :) Though, if it's going to be turned on in downstream projects, shouldn't it not reference Mathlib?</p>",
        "id": 449718944,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720385281
    },
    {
        "content": "<p>Would saying \"If you intend to submit this contribution\" be enough?</p>",
        "id": 449719062,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720385377
    },
    {
        "content": "<p>Other projects may not disallow the <code>set_option</code>, this is why I slightly prefer to include <code>Mathlib</code>: there you should definitely not include the command, elsewhere is up to each project.</p>",
        "id": 449719228,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720385484
    },
    {
        "content": "<p>For situations like this one, I think that it would be useful to allow each project to set its preferred defaults for each option, but that is not possible currently.</p>",
        "id": 449719437,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720385637
    },
    {
        "content": "<p>Gotcha; I was just thinking it might be a bit odd to see a message about Mathlib when not developing Mathlib, but I see the logic in keeping it :)</p>",
        "id": 449720376,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720385904
    },
    {
        "content": "<p>I agree: it is not perfect, but it seems like a good compromise.  It is also not something that should cause serious problems downstream and it is easy enough to change the message if it really rubs people the wrong way round.</p>",
        "id": 449721157,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720386311
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.60pp.2Emvars.60.20forbidden.3F/near/449681736\">said</a>:</p>\n<blockquote>\n<p>I would propose actually that we leave this active by default for downstream projects, and only add such logic if/when someone complains. If no one complains, then it's just a helpful linter that improves code quality downstream.</p>\n</blockquote>\n<p>Ok, let me be the one complaining. I think this warning message is distracting and potentially confusing for somewhat new users (though the new wording is a big improvement). I think it should not be enabled outside of Mathlib by default (but maybe it can be made configurable by the lakefile?)</p>",
        "id": 449893001,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720450488
    },
    {
        "content": "<p>Perhaps the wording should be different for mathlib vs not?</p>",
        "id": 449893574,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720450591
    },
    {
        "content": "<p>Outside mathlib, it could just say \"consider removing after you are done debugging\" or something</p>",
        "id": 449893662,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720450607
    },
    {
        "content": "<p>Michael had suggested as a comment in the PR that the linter could say something different depending on whether the file was <code>Mathlib/...</code> or not.</p>",
        "id": 449894505,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720450750
    },
    {
        "content": "<p>Alternatively, the linter could simply emit a warning saying something neutral like \"... option activated\".  This makes it fail Mathlib's CI anyway, since it would be noisy, but there would be no mention of removing the set_option.</p>",
        "id": 449894740,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720450796
    },
    {
        "content": "<p>I'd propose just disable it if you are outside of Mathlib.</p>",
        "id": 449962160,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720466401
    },
    {
        "content": "<p>Unfortunately you can only set options in the <code>lakefile</code> for builtin options (issue number, anyone? :-), so it's currently not easy to control this linters behaviour in a downstream lakefile.</p>",
        "id": 449962408,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720466438
    },
    {
        "content": "<p>Ok, I can take care of this, but likely it won't be before tomorrow.</p>",
        "id": 449966354,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720467597
    },
    {
        "content": "<p>I'm now wondering if it would be better to make the list of linted <code>set_option</code>s an <code>IO.Ref</code> instead, so that each project can define their own.  (I've never really used <code>IO.Ref</code>, so this may not actually work.)</p>",
        "id": 449987496,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720474991
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14558\">#14558</a> makes the linter only active in files whose path begins with <code>Mathlib</code>, <code>test</code>, <code>Archive</code>, <code>Counterexamples</code>.</p>",
        "id": 450101916,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720514473
    },
    {
        "content": "<p>The PR got merged: updating Mathlib in a downstream project should now no longer trigger the linter.</p>",
        "id": 450137157,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720523491
    },
    {
        "content": "<p>Do report here if something goes wrong as this is not completely straightforward to test!</p>",
        "id": 450137252,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720523511
    },
    {
        "content": "<p>I tested in a downstream project: the linter does not fire any more. (I cannot activate it either, if I want - but until <a href=\"https://github.com/leanprover/lean4/pull/3403\">lean4#3403</a> is fixed, that doesn't have a good solution.)</p>",
        "id": 450141558,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720524556
    },
    {
        "content": "<p>It <em>does</em> still fire on the web editor. Is that intended behaviour? <span class=\"user-mention\" data-user-id=\"385895\">@Jon Eugster</span></p>",
        "id": 450141606,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720524580
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.60pp.2Emvars.60.20forbidden.3F/near/450141558\">said</a>:</p>\n<blockquote>\n<p>I tested in a downstream project: the linter does not fire any more. (I cannot activate it either, if I want - but until <a href=\"https://github.com/leanprover/lean4/pull/3403\">lean4#3403</a> is fixed, that doesn't have a good solution.)</p>\n</blockquote>\n<p>If it is really wanted as a project opt-in, there could be a mechanism similar to the one for the unused tactic linter, where a <code>Bool</code>ean flag can be activated.</p>\n<p>Still, there is a limit to how many such workarounds there should be before coming to grips with the \"setting global options\" discussion!</p>",
        "id": 450143734,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720525289
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.60pp.2Emvars.60.20forbidden.3F/near/450141606\">said</a>:</p>\n<blockquote>\n<p>It <em>does</em> still fire on the web editor. Is that intended behaviour? <span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span></p>\n</blockquote>\n<p>It doesn't now, does it? I think you just met a race condition where the server hasn't updated yet. Idk how often the FRO updates their<br>\nr instance, we used to update <a href=\"http://lean.math.hhu.de\">lean.math.hhu.de</a> every 6 hours (or maybe 12?) I believe.</p>\n<p>With <code>import Webeditor</code> and <code>#package_version</code> you can always check which commit the editor's at.</p>",
        "id": 450403304,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1720605912
    },
    {
        "content": "<p>Thanks for checking, you are right. Glad to see this resolved!</p>",
        "id": 450413250,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720609003
    }
]