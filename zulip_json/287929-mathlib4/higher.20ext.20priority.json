[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Porting note: The priority should be higher than `LinearMap.ext`.</span>\n<span class=\"kd\">@[</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">lhom_ext'</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"n\">φ</span><span class=\"w\"> </span><span class=\"n\">ψ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→₀</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">⦄</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">φ</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lsingle</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">ψ</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lsingle</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- Porting note: we need high priority for this to fire first; not the case in ML3</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">ext</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"mi\">1100</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Porting note: increase priority so this applies before `LinearMap.ext`</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">linearMap_qext</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">⧸</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">→ₛₗ</span><span class=\"o\">[</span><span class=\"n\">τ₁₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">M₂</span><span class=\"o\">⦄</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">mkQ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">mkQ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n</code></pre></div>\n<p>This design seems to work as intended. Shall I change the <code>1100</code> to <code>high</code>, and remove the porting notes?</p>",
        "id": 511331354,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744269404
    },
    {
        "content": "<p>The notes here are I think because Lean 4 breaks ties in the opposite direction to Lean 3</p>",
        "id": 511359005,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744277417
    },
    {
        "content": "<p>And so we didn't need any priority markers before, because later declarations took priority over earlier ones in the case of a tie</p>",
        "id": 511359164,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744277468
    },
    {
        "content": "<p>Right. So remove the notes?</p>",
        "id": 511359645,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744277623
    },
    {
        "content": "<p>Well, looks like the issue wasn't fixed?</p>",
        "id": 511359857,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744277684
    },
    {
        "content": "<p>Why? We have a new design. And now you tag these lemmas with <code>high</code>.</p>",
        "id": 511361281,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744278108
    },
    {
        "content": "<p>How do you do if you have a series of three lemmas? Tag them <code>ext</code>, <code>ext high</code>, <code>ext higher</code>? What if you want to insert an extra one between the first and second? Tag it <code>ext high</code> and retag the latter two <code>ext higher</code> and <code>ext higherer</code>? I don't think that's sustainable</p>",
        "id": 511361631,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744278211
    },
    {
        "content": "<p>The Lean 3 default was correct. The Lean 4 isn't. Why don't we just fix it?</p>",
        "id": 511361756,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744278249
    },
    {
        "content": "<p>Is there an issue?</p>",
        "id": 511362568,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1744278484
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/higher.20ext.20priority/near/511361631\">said</a>:</p>\n<blockquote>\n<p>How do you do if you have a series of three lemmas? Tag them <code>ext</code>, <code>ext high</code>, <code>ext higher</code>? What if you want to insert an extra one between the first and second? Tag it <code>ext high</code> and retag the latter two <code>ext higher</code> and <code>ext higherer</code>? I don't think that's sustainable</p>\n</blockquote>\n<p>Tag them <code>ext 1000</code>, <code>ext 1050</code>, <code>ext 1100</code>? We have at least a thousand and probably more like MAXINT possible priorities going spare, so as long as we make our steps large enough to fit several extra new priorities between them, I don't think it'll be an issue.</p>",
        "id": 511511511,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1744320725
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/higher.20ext.20priority/near/511361756\">said</a>:</p>\n<blockquote>\n<p>Why don't we just fix it?</p>\n</blockquote>\n<p>\"Just\" is doing a lot of heavy lifting. What does \"just\" fixing it look like?</p>",
        "id": 511512790,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744321335
    },
    {
        "content": "<p>I think possibly I mispoke above, and the order changed from \"declaration order\" to \"unspecified\"</p>",
        "id": 511514927,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744322324
    },
    {
        "content": "<p>Does <code>ext</code> do discrtree matching on the type?</p>",
        "id": 511514976,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744322350
    },
    {
        "content": "<p>I think that would replace the need for (almost) any priorities</p>",
        "id": 511515016,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744322374
    },
    {
        "content": "<p>That would only work if it picks the thing that \"matches best\", not just something that matches at all. And it's not entirely clear what \"matches best\" means in all circumstances.</p>",
        "id": 511516245,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744322803
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Yes, it uses a discrimination tree to match on the type.</p>",
        "id": 511517017,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744323082
    },
    {
        "content": "<p>Am I right in thinking that discrtrees prefer the most specific match first? So for instance, should match an ext lemma about linear maps from the tensor product before matching a lemma about linear maps over a free variable?</p>",
        "id": 511518538,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744323755
    },
    {
        "content": "<p>(and a related question: did ext in Lean 4 always do this? Maybe I'm remembering a much older and less useful version)</p>",
        "id": 511518665,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744323806
    },
    {
        "content": "<p>I'm not sure what \"most specific\" means, as I think there's only a partial order on discr tree keys (I don't mean an instance of <code>PartialOrder</code>). E.g., if I have keys <code>foo a _</code>, <code>foo _ b</code> and <code>foo _ _</code>, and I'm matching against <code>foo a b</code>, which one is \"most specific\"?</p>",
        "id": 511518909,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744323923
    },
    {
        "content": "<p>I think in practice the keys with these porting notes are <code>SomeHom _ _</code> and <code>SomeHom (F _) _</code></p>",
        "id": 511519082,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744324014
    },
    {
        "content": "<p>I understand, I'm just arguing that I don't know how <code>ext</code> could reliably choose the most specific match because that's not well-defined.</p>",
        "id": 511519406,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744324158
    },
    {
        "content": "<p>I think the order is lexicographic <span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span>, with <code>foo _ _ &lt; foo _ b &lt; foo a _</code>. I don't know in what order discrimination trees return results though (whether it's least first or greatest first).</p>",
        "id": 511534618,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1744332128
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/287929-mathlib4/topic/higher.20ext.20priority/near/511512790\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/higher.20ext.20priority/near/511361756\">said</a>:</p>\n<blockquote>\n<p>Why don't we just fix it?</p>\n</blockquote>\n<p>\"Just\" is doing a lot of heavy lifting. What does \"just\" fixing it look like?</p>\n</blockquote>\n<p>I am aware that I am being a bit <span aria-label=\"chili pepper\" class=\"emoji emoji-1f336\" role=\"img\" title=\"chili pepper\">:chili_pepper:</span> but I really would like us not to remove those porting notes when improvements could be made</p>",
        "id": 511575374,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744354700
    },
    {
        "content": "<p>I think at some point porting notes like this need to either have a specific volunteer who will do the work, or be removed. As far as I am concerned it is by design the the order isn't specified here (because that then commits us to never changing the behaviour of discrimination trees), and there is a perfectly good mechanism to specify the order when needed.</p>",
        "id": 511967557,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744597298
    },
    {
        "content": "<p>Sorry, what's the perfectly good mechanism?</p>",
        "id": 511967658,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744597369
    },
    {
        "content": "<p><code>@[ext 1100]</code></p>",
        "id": 511990989,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744610716
    }
]