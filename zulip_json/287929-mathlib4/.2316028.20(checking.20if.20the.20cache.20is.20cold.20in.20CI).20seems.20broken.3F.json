[
    {
        "content": "<p>The purpose of <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span>'s <a href=\"https://github.com/leanprover-community/mathlib4/pull/16028\">#16028</a> was to avoid trying to download the olean for every file, in the event that we could tell quickly that nothing would be found.</p>\n<p>However it doesn't seem to be working as intended, cf <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/10676627430/job/29590464396?pr=16433\">https://github.com/leanprover-community/mathlib4/actions/runs/10676627430/job/29590464396?pr=16433</a>.</p>",
        "id": 467112366,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725338970
    },
    {
        "content": "<p>Could anyone be able to take a look at this?</p>",
        "id": 467112380,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725338978
    },
    {
        "content": "<p>Running <code>ls -ao .lake/build/lib/Mathlib/</code> after trying to get <code>Mathlib.Init</code> shows</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>drwxr-xr-x<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>lean<span class=\"w\">  </span><span class=\"m\">4096</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>.\ndrwxr-xr-x<span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span>lean<span class=\"w\">  </span><span class=\"m\">4096</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>..\n-rw-r--r--<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>lean<span class=\"w\">    </span><span class=\"m\">53</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>Init.ilean\n-rw-r--r--<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>lean<span class=\"w\">    </span><span class=\"m\">19</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>Init.ilean.hash\n-rw-r--r--<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>lean<span class=\"w\"> </span><span class=\"m\">19336</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>Init.olean\n-rw-r--r--<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>lean<span class=\"w\">    </span><span class=\"m\">20</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>Init.olean.hash\n-rw-r--r--<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>lean<span class=\"w\">   </span><span class=\"m\">940</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>Init.trace\ndrwxr-xr-x<span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span>lean<span class=\"w\">  </span><span class=\"m\">4096</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>Tactic\ndrwxr-xr-x<span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\"> </span>lean<span class=\"w\">  </span><span class=\"m\">4096</span><span class=\"w\"> </span>Sep<span class=\"w\">  </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"m\">05</span>:30<span class=\"w\"> </span>Util\n</code></pre></div>\n<p>so, it looks like testing if the file does not exist may not be the right approach.</p>",
        "id": 467120630,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725341753
    },
    {
        "content": "<p>I think that the issue is that the previous step <code>lake exe mk_all</code> builds <code>mk_all</code> and that has a <code>Mathlib</code> dependency.  Hence, the oleans for <code>Mathlib.Init</code> get created and then found by cache and by <code>test -e</code>.</p>",
        "id": 467135764,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725345352
    },
    {
        "content": "<p>Here are 3 options:</p>\n<ol>\n<li>get the cache for <code>Mathlib.Init</code> and perform the test <em>before</em> <code>mk_all</code> and store the result, run <code>mk_all</code> and then download/build depending on the earlier test;</li>\n<li>run <code>rm -rf .lake/build/lib/Mathlib</code> before asking <code>cache</code> to download <code>Mathlib.Init</code> (<del>there already is a <code>lake exe cache clean</code> step, maybe instead of <code>rm -rf</code> using <code>lake exe cache clean!</code> could work</del>I don't think that this works);</li>\n<li>try to fetch something higher up in the hierarchy than <code>Mathlib.Init</code> (and higher than <code>Mathlib.Util.GetAllModules</code> which is what <code>mk_all</code> uses).</li>\n</ol>",
        "id": 467137016,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725345593
    },
    {
        "content": "<p>After a little bit of testing, I propose this step:</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"nt\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">get cache</span>\n<span class=\"w\">        </span><span class=\"nt\">id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">get</span>\n<span class=\"w\">        </span><span class=\"nt\">run</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p p-Indicator\">|</span>\n<span class=\"w\">          </span><span class=\"no\">rm -rf .lake/build/lib/Mathlib/</span>\n<span class=\"w\">          </span><span class=\"no\"># Fail quickly if the cache is completely cold, by checking for Mathlib.Init</span>\n<span class=\"w\">          </span><span class=\"no\">lake exe cache get Mathlib.Init</span>\n<span class=\"w\">          </span><span class=\"no\">lake build --no-build Mathlib.Init &amp;&amp; lake exe cache get || echo \"No cache for 'Mathlib.Init' available\"</span>\n</code></pre></div>",
        "id": 467146463,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725347193
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16437\">#16437</a></p>",
        "id": 467155126,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725348673
    },
    {
        "content": "<p>Thanks for investigating. I wonder why this seemed to work on my test PR back then. Maybe the <code>mk_all</code> stuff was added after my branch forked off.</p>\n<p>Why not option 1? This way the <code>mk_all</code> step also benefits from the cache?</p>",
        "id": 467169060,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1725351633
    },
    {
        "content": "<p>Let me implement 1, then!</p>",
        "id": 467175964,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725353301
    },
    {
        "content": "<p>I went for 2 since it was more straightforward and the <code>mk_all</code> uses very little cache anyway.</p>",
        "id": 467175989,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725353307
    },
    {
        "content": "<p>As for why the failed tests, maybe since before you were using <code>Batteries.WF</code> and <em>that</em> file did not have an available cache?  Or maybe, since your PR was just about when <code>Mathlib.Init</code> was created, the file was empty and not imported where it was expected?  <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span>  I do not know, but I am not too surprised that testing in CI does not result in correct behaviour!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 467176502,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725353427
    },
    {
        "content": "<p>Ah, the former probably. I without checking assumed that something called <code>Mathlib.Init</code> would import  <code>Batteries</code>. Should have looked</p>",
        "id": 467177267,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1725353596
    },
    {
        "content": "<p>Well, that then crossed paths with the ultra-minimization of imports that had Mathlib.lean even not import all of Batteries.</p>",
        "id": 467177853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725353738
    },
    {
        "content": "<p>(This changed now.)</p>",
        "id": 467177861,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725353742
    },
    {
        "content": "<p>Oh, Kim has already merged the PR above.  Honestly, I am happy with this version and would avoid implementing the \"first <code>get cache</code>, then <code>mk_all</code>, eventually check the <code>get cache</code> step\" version.  The total time that the <code>mk_all</code> step takes is 18s anyway.</p>",
        "id": 467182398,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725354803
    },
    {
        "content": "<p>Thatâ€™s fine, and sorry for the mess I made</p>",
        "id": 467182538,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1725354832
    },
    {
        "content": "<p>No worries: I think that there is no way of modifying CI and not making a mess.</p>",
        "id": 467189723,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725356373
    },
    {
        "content": "<p>You only eventually settle for calling \"correct\" the final mess in which you find yourself.</p>",
        "id": 467189869,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725356401
    }
]