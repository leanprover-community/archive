[
    {
        "content": "<p>Still frantically trying to prepare for teaching using Lean 4, I see the <code>rename_bvar</code> teaching tactic is broken in mathlib4:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∣</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"w\">  </span><span class=\"n\">rename_bvar</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 493593195,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736863567
    },
    {
        "content": "<p>Here it does nothing, presumably because there is already some <code>k</code> in the context (but that’s the whole point of the tactic: renaming to avoid apparent notation clash).</p>",
        "id": 493593307,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736863609
    },
    {
        "content": "<p>As usual any help is much appreciated while I hunt down the next bug.</p>",
        "id": 493593364,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736863627
    },
    {
        "content": "<p>When this bug gets fixed: it would be great to add this test; the rename_bvar tactic is drastically undertested. (<a href=\"https://github.com/leanprover-community/mathlib4/pull/18139\">#18139</a> only added some very basic test.)</p>",
        "id": 493614531,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1736869669
    },
    {
        "content": "<p>This is the curse of teaching tactics: they are not tested in Mathlib. Usually they are tested in teaching libs before going to Mathlib. But here it was tested in Lean 3 teaching lib, PRed to mathlib3 and ported to Lean 4 without being tested.</p>",
        "id": 493614769,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736869733
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20743\">#20743</a></p>\n<p>This case was triggered by metavariables not being handled.</p>\n<p>There's also a fix in case the issue was metadata, but I didn't add a test for this.</p>",
        "id": 493625036,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736872656
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 493637153,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1736876598
    },
    {
        "content": "<p><code>instantiateMVarDeclMVars</code> is a function that could be helpful to fix tactics like this in general (it's a hammer that instantiates all metavariables that appear in the local context and target of a particular goal). Added it to <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Metaprogramming-gotchas\">https://github.com/leanprover-community/mathlib4/wiki/Metaprogramming-gotchas</a></p>",
        "id": 493639058,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736877352
    }
]