[
    {
        "content": "<p>Using the following </p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">DiscrTree</span>\n\n<span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">NaughtyInstance</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">isProjFn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToMessageData</span><span class=\"w\"> </span><span class=\"n\">NaughtyInstance</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toMessageData</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isProj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">inst.isProjFn</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"s2\">\"Projection\"</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"s2\">\"Not Projection\"</span>\n<span class=\"w\">  </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"{inst.name}, Type: {inst.type}, Priority: {inst.priority}, {isProj}\"</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">getNaughtyInstances</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">NaughtyInstance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">env.constants.toList.filterM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">isInstance</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">prio</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getInstancePriority</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isProj</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isProjectionFn</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">forallMetaTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">info.type</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">keys</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkPath</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">keys.toList.drop</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">star</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">keys</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">list</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prio.get</span><span class=\"bp\">!</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">isProjFn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isProj</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">::</span><span class=\"w\"> </span><span class=\"n\">list</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">list</span>\n\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">instances</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getNaughtyInstances</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"Total number universally application instances: {instances.length}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">defaultPrio</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instances.filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">inst.priority</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"Number with priority at or above default: {defaultPrio.length}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">projections</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instances.filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">inst.isProjFn</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"Number of projection functions: {projections.length}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">instances</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">!</span><span class=\"s2\">\"{inst}</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">msg</span>\n</code></pre></div>\n</div></div>\n<p>gives the following list <a href=\"https://gist.github.com/mattrobball/8690f3a7bbb5ccb4c8e6cb632a495a34\">https://gist.github.com/mattrobball/8690f3a7bbb5ccb4c8e6cb632a495a34</a></p>\n<p>These are instances that Lean will always attempt for the corresponding synthesis problem. Their current priority is listed</p>",
        "id": 504867174,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741705223
    },
    {
        "content": "<p>Library note: </p>\n<blockquote>\n<p>Therefore, if we create an instance that always applies, we set the priority of these instances to 100 (or something similar, which is below the default value of 1000).</p>\n</blockquote>\n<p>If you filter the list of 2600+, 1504 of them have default priority. (None above thankfully)</p>",
        "id": 504869162,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741705640
    },
    {
        "content": "<p>at first glance, a bunch of these look like <code>class extends</code> instances?</p>",
        "id": 504869567,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1741705726
    },
    {
        "content": "<p>Yes many are</p>",
        "id": 504869688,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741705750
    },
    {
        "content": "<p>btw, what is the tag of the library note you're referring to?</p>",
        "id": 504871238,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1741706076
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504869688\">said</a>:</p>\n<blockquote>\n<p>Yes many are</p>\n</blockquote>\n<p>792 to be exact</p>",
        "id": 504871548,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741706144
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504871238\">said</a>:</p>\n<blockquote>\n<p>btw, what is the tag of the library note you're referring to?</p>\n</blockquote>\n<p>\"lower instance priority\"</p>",
        "id": 504871665,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741706164
    },
    {
        "content": "<p>\"lower cancel priority\" seems to be a related (duplicate/specialized) library note?</p>\n<blockquote>\n<p>We lower the priority of inheriting from cancellative structures.<br>\n  This attempts to avoid expensive checks involving bundling and unbundling with the <code>IsDomain</code> class.<br>\nsince <code>IsDomain</code> already depends on <code>Semiring</code>, we can synthesize that one first.<br>\n<a href=\"#narrow/channel/113488-general/topic/Why.20is.20.60simpNF.60.20complaining.20here.3F\">#general &gt; Why is &#96;simpNF&#96; complaining here?</a></p>\n</blockquote>",
        "id": 504873112,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1741706492
    },
    {
        "content": "<p>There are two issues:</p>\n<ol>\n<li>slowing down instance synthesis that succeeds </li>\n<li>slowing down instance synthesis that fails</li>\n</ol>\n<p>Priority doesn't really matter for the latter as everything get tried. For that, the only real tool we have is scoping to a namespace. </p>\n<p>I would argue that some are pretty crazy from a human perspective. For example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsAddKleinFour.instFinite#doc\">docs#IsAddKleinFour.instFinite</a>. If I was handed a random type and asked to check it is <code>Finite</code>, asking \"Is it a Klein 4-group?\" would not be anywhere on my list of questions. Unless, of course, I was already working with such things. But it is globally available and has default priority.</p>",
        "id": 504876685,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741707200
    },
    {
        "content": "<p>Of the two issues, the latter seems to do the most damage to people's workflow.</p>",
        "id": 504877364,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741707311
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504876685\">said</a>:</p>\n<blockquote>\n<p>For example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsAddKleinFour.instFinite#doc\">docs#IsAddKleinFour.instFinite</a>. If I was handed a random type and asked to check it is <code>Finite</code>, asking \"Is it a Klein 4-group?\" would not be anywhere on my list of questions.</p>\n</blockquote>\n<p>looking into this, since among the fields of <code>IsAddKleinFour</code> is <code>Nat.card T = 4</code>, this indeed is a <em>very</em> useless instance <span aria-label=\"rolling on the floor laughing\" class=\"emoji emoji-1f923\" role=\"img\" title=\"rolling on the floor laughing\">:rolling_on_the_floor_laughing:</span></p>",
        "id": 504883648,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1741708439
    },
    {
        "content": "<p>Updated the gist to reflect that classes with more than one parameter exist.</p>",
        "id": 504886231,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741708886
    },
    {
        "content": "<p>Cool that we have a universal property for being the Klein four group though.</p>",
        "id": 504899861,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741711734
    },
    {
        "content": "<p>I agree :)</p>",
        "id": 504908172,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741713954
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504886231\">said</a>:</p>\n<blockquote>\n<p>Updated the gist to reflect that classes with more than one parameter exist.</p>\n</blockquote>\n<p>Updated the code also now</p>",
        "id": 504908365,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741714004
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/gIFyUBxqW68lC8Inse1SWfdI/naughty_instances.csv\">naughty_instances.csv</a><br>\nHere is a spreadsheet with the instances for easier human inspection</p>",
        "id": 504926130,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741718925
    },
    {
        "content": "<p>At some point there was an RFC to lean 4 to lower the priority of instances generated by <code>extends</code> (edit: <a href=\"https://github.com/leanprover/lean4/pull/2325\">lean4#2325</a>), but I think it was rejected because it didn't actually affect performance.</p>",
        "id": 504928601,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741719636
    },
    {
        "content": "<p>Yeah, I tried that about a year ago with different values for both the parent and non-parents. It didn't seem to make a big difference. </p>\n<p>I think the main issue are instances that expand the search space too much. Eg you are searching for <code>Unique</code> and then you hit a <code>Group</code> -&gt; <code>Unique</code> and you are crawling the whole algebraic hierarchy when it has little to do with your current setting</p>",
        "id": 504931469,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741720425
    },
    {
        "content": "<p>Probably, you mean <code>Group</code> -&gt; <code>Nonempty</code>. You can't prove <code>Group</code> -&gt; <code>Unique</code>.</p>",
        "id": 504981700,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1741735751
    },
    {
        "content": "<p>I'm not really convinced that these unconditional instances are a bad thing, so long as none of them loop. Worst case scenario should be that we visit every typeclass once though these, right?</p>",
        "id": 504982494,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741736051
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504982494\">said</a>:</p>\n<blockquote>\n<p>I'm not really convinced that these unconditional instances are a bad thing, so long as none of them loop. Worst case scenario should be that we visit every typeclass once though these, right?</p>\n</blockquote>\n<p>No, you can repeat typeclasses with different parameters.</p>",
        "id": 504982707,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741736137
    },
    {
        "content": "<p>The examples I can think of all have structurally \"smaller\" parameters in the assumptions, if you're describing what I think you are</p>",
        "id": 504984025,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741736689
    },
    {
        "content": "<p>I think instances that have the form <code>MyClass (MyReducibleDefinition ..)</code> are a footgun, since they always apply, but don't look like they do.</p>",
        "id": 505091919,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1741776117
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504982494\">said</a>:</p>\n<blockquote>\n<p>I'm not really convinced that these unconditional instances are a bad thing, so long as none of them loop. Worst case scenario should be that we visit every typeclass once though these, right?</p>\n</blockquote>\n<p>Is <code>simp</code> still checking whether a type is a subsingleton for all terms it traverses? You might be doing this check frequently, for many different types.</p>",
        "id": 505092219,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1741776182
    },
    {
        "content": "<p>But I'm very much in favor of scoping instances from a very domain-specific area to a general area with weak keys.</p>\n<p>For example, the following failure spends 90% of the time trying to show that <code>Fin 2</code> is a sifted category because of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.IsSifted.nonempty#doc\">docs#CategoryTheory.IsSifted.nonempty</a> (before <a href=\"https://github.com/leanprover-community/mathlib4/pull/22780\">#22780</a> it would also spend a bunch of time in the algebraic hierarchy).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"c1\">-- set_option trace.profiler true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"c1\">-- attribute [-instance]</span>\n<span class=\"c1\">--   CategoryTheory.IsSifted.nonempty</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsingleton</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 505101144,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1741778500
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504981700\">said</a>:</p>\n<blockquote>\n<p>Probably, you mean <code>Group</code> -&gt; <code>Nonempty</code>. You can't prove <code>Group</code> -&gt; <code>Unique</code>.</p>\n</blockquote>\n<p>Right. I was trying to say that <code>Group</code> + <code>Stuff</code> -&gt; <code>Unique</code>. Depending on the ordering, you end up searching the algebraic hierarchy.</p>",
        "id": 505111543,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741781222
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/505101144\">said</a>:</p>\n<blockquote>\n<p>But I'm very much in favor of scoping instances from a very domain-specific area to a general area with weak keys.</p>\n</blockquote>\n<p>If there is scoped notation, then there is no UX impact with scoping instances</p>",
        "id": 505111818,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741781290
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/504982494\">said</a>:</p>\n<blockquote>\n<p>I'm not really convinced that these unconditional instances are a bad thing, so long as none of them loop. Worst case scenario should be that we visit every typeclass once though these, right?</p>\n</blockquote>\n<p>Does caching use the context? I should look</p>",
        "id": 505112095,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741781374
    },
    {
        "content": "<p>I can try to rerun my experiment setting all projection instances to <code>100</code></p>",
        "id": 505112336,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741781438
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/505091919\">said</a>:</p>\n<blockquote>\n<p>I think instances that have the form <code>MyClass (MyReducibleDefinition ..)</code> are a footgun, since they always apply, but don't look like they do.</p>\n</blockquote>\n<p>Should we have a “redundant instance” linter? It wouldn’t ban them per se but the user would have to opt in in making it and give a doc string</p>",
        "id": 505112967,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741781611
    },
    {
        "content": "<p>Maybe. We can also port the instance priority linter <a href=\"https://github.com/leanprover-community/mathlib3/blob/65a1391a0106c9204fe45bc73a039f056558cb83/src/tactic/lint/type_classes.lean#L100\">from Lean 3</a> and make sure it looks at the key, so that reducible definitions are also caught. <br>\nBut before we do that, we probably should test that setting instance priorities actually speeds up (succeeding) instance synthesis.</p>",
        "id": 505116962,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1741782373
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.IsSifted.isSifted_of_hasBinaryCoproducts_and_nonempty#doc\">docs#CategoryTheory.IsSifted.isSifted_of_hasBinaryCoproducts_and_nonempty</a> forms a loop though, with IsSifted.nonempty</p>",
        "id": 505166805,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741792945
    },
    {
        "content": "<p>Why <code>Nonempty (Fin 2)</code> helps to prove <code>Subsingleton (Fin 2 → _)</code>?</p>",
        "id": 505311253,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1741837974
    },
    {
        "content": "<p>Yes you would think that this is a step backwards!</p>",
        "id": 505344499,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741852550
    },
    {
        "content": "<p>Can you follow the path that leads to this search?</p>",
        "id": 505566874,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1741919782
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsEmpty.instSubsingleton#doc\">docs#IsEmpty.instSubsingleton</a> + <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instIsEmptyForallOfNonempty#doc\">docs#instIsEmptyForallOfNonempty</a><br>\nThis indeed leads to the unfortunate consequence that you're solving useless side-conditions. Not sure how we can solve this... The simple search that type-class inference might just be too simple to figure out that these are \"stupid\" sequences of instances.</p>",
        "id": 505787203,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1741997279
    },
    {
        "content": "<p>I made <a href=\"https://github.com/leanprover-community/mathlib4/pull/22953\">#22953</a> to reorder the arguments of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instIsEmptyForallOfNonempty#doc\">docs#instIsEmptyForallOfNonempty</a>, so it becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsEmpty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsEmpty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>So then the useless side condition <code>Nonempty α</code> is only attempted after the main condition. This should fix the above slow synthesis.</p>",
        "id": 505843445,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1742041658
    },
    {
        "content": "<p>Arguably, the same swap should be made in <code>instCountableForallOfFinite</code>, so it becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Countable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">π</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Countable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">π</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>where <code>Finite α</code> plays the role of useless side condition.</p>",
        "id": 505843540,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1742041721
    },
    {
        "content": "<p><span aria-label=\"working on it\" class=\"emoji emoji-1f6e0\" role=\"img\" title=\"working on it\">:working_on_it:</span> the KleinFour instance</p>",
        "id": 505854696,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1742049957
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22958\">#22958</a> scopes the KleinFour.instFinite instance</p>",
        "id": 505855113,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1742050281
    },
    {
        "content": "<p>I was going to say that <code>CategoryTheory.IsSifted.nonempty</code> (with <code>IsSifted.isSifted_of_hasBinaryCoproducts_and_nonempty</code>) is a bad instance.</p>\n<p>But even worse is that following traverses the algebraic hierarchy three times, once for <code>Limits.WalkingPair</code>, once for <code>(J : Type _)</code> and once for <code>(J : Type)</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">HasBinaryCoproducts</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">infer_instance</span>\n</code></pre></div>",
        "id": 505862628,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1742055692
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23052\">#23052</a> scopes the IsSifted.nonempty instance.</p>",
        "id": 506500123,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1742308934
    },
    {
        "content": "<p>Results of the above: -0,5% on linting, neutral on instructions (which is probably not surprising, given that these files are close to leaf files).</p>",
        "id": 506517960,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1742313134
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/505843540\">said</a>:</p>\n<blockquote>\n<p>Arguably, the same swap should be made in <code>instCountableForallOfFinite</code>, so it becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Countable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">π</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Countable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">π</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>where <code>Finite α</code> plays the role of useless side condition.</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23073\">#23073</a> tries this (still running CI)</p>",
        "id": 506570934,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1742328559
    },
    {
        "content": "<p>Re: <a href=\"https://github.com/leanprover-community/mathlib4/pull/23073\">#23073</a>: No benchmark entry differed by at least +1.0⬝10⁹ instructions.</p>",
        "id": 506607090,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742344377
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instances.20that.20match.20unconditionally/near/505112336\">said</a>:</p>\n<blockquote>\n<p>I can try to rerun my experiment setting all projection instances to <code>100</code></p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/tree/mrb%2Freduce_prios\">branch#mrb/reduce_prios</a> will (should!) have a working toolchain in ~ 1 hr. If people want to hack on it to get it working, please do.</p>",
        "id": 506726720,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1742390390
    },
    {
        "content": "<p>CI in that run failed: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/13947455417/job/39037930447\">from the log</a>, in the \"print lean and lake versions\" step</p>\n<blockquote>\n<p>info: downloading component 'lean'<br>\nerror: binary package was not provided for 'linux'<br>\nError: Process completed with exit code 1.</p>\n</blockquote>",
        "id": 506734387,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1742392251
    },
    {
        "content": "<p>CI didn't wait an hour :) The toolchain should be there now</p>",
        "id": 506763043,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1742398663
    },
    {
        "content": "<p>I've pushed it along but have to step away for the day. Please feel free to continue</p>",
        "id": 506827692,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1742418199
    }
]