[
    {
        "content": "<p>In Mathlib.MeasureTheory.Measure.Prod the theorems <code>AEMeasurable.fst</code> and <code>AEMeasurable.snd</code> have a \"TODO: make this theorem usuable with <code>fun_prop</code>\". If you try to add a <code>fun_prop</code> declaration you get a error that says \"Not a valid <code>fun_prop</code> theorem!\" What is the issue here and what can I do to fix it?</p>",
        "id": 512457203,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1744776388
    },
    {
        "content": "<p><code>fun_prop</code> expects the theorem to be of the form <code>AEMeasurable fun x =&gt; (f x).1 μ</code> instead of having <code>f x.1</code>. Does it make sense to formulate it like that for <code>AEMeasurable</code>?</p>",
        "id": 512477001,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744786604
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"223948\">David Ledvinka</span> <a href=\"#narrow/stream/287929-mathlib4/topic/AEMeasurable.20fun_prop.20prod/near/512457203\">said</a>:</p>\n<blockquote>\n<p>\"Not a valid <code>fun_prop</code> theorem!\" What is the issue here and what can I do to fix it?</p>\n</blockquote>\n<p>The issue is similar to that fact that the head symbol of lhs of a simp theorem can't be a free variable. Similarly <code>fun_prop</code> does not allow free variable to be the head of the function body except for so called \"lambda theorems\"(described  <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/FunProp.html\">here</a>)</p>",
        "id": 512478430,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744787151
    },
    {
        "content": "<p>I think I am still too new to formalization to give an informed answer to your general question but here is a MWE of my use case that lead me to investigate this: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">Prod</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"n\">MeasureTheory</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">mα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">mβ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"bp\">∞</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"bp\">∞</span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- Works!</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measurable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measurable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fun_prop</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ν</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SFinite</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SFinite</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- My use case doesn't work!</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fun_prop</span>\n\n<span class=\"c1\">-- Intermediate case doesn't Work!</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fun_prop</span>\n</code></pre></div>\n<p>I suppose in the \"Measurable\" case this is a composition of lambda theorems but in the \"AEMeasurable\" case it is not?</p>",
        "id": 512486765,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1744789955
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/287929-mathlib4/topic/AEMeasurable.20fun_prop.20prod/near/512477001\">said</a>:</p>\n<blockquote>\n<p><code>fun_prop</code> expects the theorem to be of the form <code>AEMeasurable fun x =&gt; (f x).1 μ</code> instead of having <code>f x.1</code>. Does it make sense to formulate it like that for <code>AEMeasurable</code>?</p>\n</blockquote>\n<p>That is a different theorem. Compare <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Continuous.fst#doc\">docs#Continuous.fst</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Continuous.fst%27#doc\">docs#Continuous.fst'</a></p>",
        "id": 512520207,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1744800127
    },
    {
        "content": "<p>And yes, <code>AEMeasurable</code> is harder to support because the composition of two <code>AEMeasurable</code> functions is not necessarily <code>AEMeasurable</code>.</p>",
        "id": 512520375,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1744800188
    },
    {
        "content": "<p>But probably the way to go is to tag <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.QuasiMeasurePreserving#doc\">docs#MeasureTheory.Measure.QuasiMeasurePreserving</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AEMeasurable.comp_quasiMeasurePreserving#doc\">docs#AEMeasurable.comp_quasiMeasurePreserving</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.quasiMeasurePreserving_fst#doc\">docs#MeasureTheory.Measure.quasiMeasurePreserving_fst</a> with <code>@[fun_prop]</code>, and then <code>fun_prop</code> can probably handle this.</p>",
        "id": 512521187,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1744800431
    },
    {
        "content": "<p>I played with the code a bit and I can make <code>fun_prop</code> work by adding these two theorems</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">fun_prop</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"bp\">.</span><span class=\"n\">map_fst_measure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"bp\">.</span><span class=\"n\">smul_measure</span><span class=\"w\"> </span><span class=\"n\">hf</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">fun_prop</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"bp\">.</span><span class=\"n\">map_snd_measure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"bp\">.</span><span class=\"n\">smul_measure</span><span class=\"w\"> </span><span class=\"n\">hg</span>\n</code></pre></div>\n<p>As you can see the proof uses <code>simp</code> and <code>fun_prop</code> is not doing any reduction on the goal.</p>\n<p>Unfortunately it does not scale, this fails</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ν</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fun_prop</span>\n</code></pre></div>\n<p>because <code>fun_prop</code> can't prove <code>AEMeasurable (fun x0 =&gt; g x0) (Measure.map (fun x =&gt; x.2.1) (μ.prod (ν.prod μ)))</code></p>\n<hr>\n<p>To make <code>fun_prop</code> work properly it would need a theorem of the form</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">fun_prop</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"bp\">.</span><span class=\"n\">measure_change</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"n\">μ'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">μ'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>where <code>P</code> is some appropriate predicate on <code>μ</code> and <code>μ'</code> which can be solve by some other tactic. With that you would run <code>fun_prop</code> with that tactic as discharger.</p>\n<p>This theorem would be similar to how <code>fun_prop</code> uses <code>ContDiff.of_le</code> to prove <code>ContDiff R n f</code> from <code>ContDiff R m f</code></p>",
        "id": 512643409,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744828567
    },
    {
        "content": "<p>Ohh, now I'm looking at the trace of <code>fun_prop</code> and there is such theorem <code>AEMeasurable.mono'</code>.</p>\n<p>I will investigate why <code>fun_prop</code> is not reporting (you can see it in <code>fun_prop</code> trace only)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">discharge</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span>\n<span class=\"w\">          </span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≪</span><span class=\"w\"> </span><span class=\"n\">μ</span>\n</code></pre></div>\n<p>in </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"bp\">.</span><span class=\"n\">map_fst_measure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AEMeasurable</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fun_prop</span>\n</code></pre></div>",
        "id": 512646068,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744829006
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"223948\">@David Ledvinka</span> so for your example to work you just need to find a tactic that can solve</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≪</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">tactic</span><span class=\"bp\">&gt;</span>\n</code></pre></div>\n<p>and run <code>fun_prop (disch:=&lt;tactic&gt;)</code></p>",
        "id": 512647112,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744829173
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/287929-mathlib4/topic/AEMeasurable.20fun_prop.20prod/near/512646068\">said</a>:</p>\n<blockquote>\n<p>I will investigate why <code>fun_prop</code> is not reporting (you can see it in <code>fun_prop</code> trace only)</p>\n</blockquote>\n<p>Ohh I know why, because with the current error reporting you would get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Measurable</span><span class=\"bp\">.</span><span class=\"n\">aemeasurable</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">discharge</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span><span class=\"o\">,</span><span class=\"w\">  </span><span class=\"n\">Measurable</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"bp\">@</span><span class=\"n\">AEMeasurable</span><span class=\"bp\">.</span><span class=\"n\">mono'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">discharge</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≪</span><span class=\"w\"> </span><span class=\"n\">μ</span>\n<span class=\"bp\">@</span><span class=\"n\">Continuous</span><span class=\"bp\">.</span><span class=\"n\">aemeasurable</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">@</span><span class=\"n\">Continuous</span><span class=\"bp\">.</span><span class=\"n\">aemeasurable</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">OpensMeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"bp\">@</span><span class=\"n\">Continuous</span><span class=\"bp\">.</span><span class=\"n\">aemeasurable</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">discharge</span><span class=\"w\"> </span><span class=\"n\">hypotheses</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">OpensMeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>\n<p>I consider all of these except one to be false positives. This is relatively simple example, I think on more complicated examples the number of false positives would much larger.</p>",
        "id": 512652210,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744829958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"346070\">Tomas Skrivan</span> <a href=\"#narrow/channel/287929-mathlib4/topic/AEMeasurable.20fun_prop.20prod/near/512647112\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"223948\">David Ledvinka</span> so for your example to work you just need to find a tactic that can solve</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≪</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">tactic</span><span class=\"bp\">&gt;</span>\n</code></pre></div>\n<p>and run <code>fun_prop (disch:=&lt;tactic&gt;)</code></p>\n</blockquote>\n<p>This works thanks!</p>",
        "id": 512677536,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1744834125
    },
    {
        "content": "<p>Cool, which tactic do you use to prove absolute continuity of measures? I couldn't figure it out.</p>",
        "id": 512706974,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744847138
    },
    {
        "content": "<p>I couldn't find one single tactic, I just did <code>fun_prop (disch:=  intro _ hs; simp [hs])</code>. It works but is this discouraged? (The context I used it in is <a href=\"https://github.com/leanprover-community/mathlib4/pull/24127\">#24127</a>)</p>",
        "id": 512718239,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1744854532
    },
    {
        "content": "<p>It is totally valid thing to do. I was just hoping for something general that we can recommend to other people to do when proving <code>AEMeasurable</code></p>",
        "id": 512731425,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1744862506
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/AEMeasurable.20fun_prop.20prod/near/512521187\">said</a>:</p>\n<blockquote>\n<p>But probably the way to go is to tag <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.QuasiMeasurePreserving#doc\">docs#MeasureTheory.Measure.QuasiMeasurePreserving</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AEMeasurable.comp_quasiMeasurePreserving#doc\">docs#AEMeasurable.comp_quasiMeasurePreserving</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.quasiMeasurePreserving_fst#doc\">docs#MeasureTheory.Measure.quasiMeasurePreserving_fst</a> with <code>@[fun_prop]</code>, and then <code>fun_prop</code> can probably handle this.</p>\n</blockquote>\n<p>Ok so after running into this problem a bunch more I decided to go back and try this and it works! (Both for my example above as well as other examples). I am going to submit a PR for this (have a draft <a href=\"https://github.com/leanprover-community/mathlib4/pull/24273\">#24273</a>) but I wanted to ask if there is a good rule of thumb when to label a theorem <code>fun_prop </code>and when not? Is it better to start conservative and just add more fun_prop tags when needed?</p>",
        "id": 513513875,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1745296103
    },
    {
        "content": "<p>Could also do <code>MeasurePreserving</code>, is there a worry though that this will slow things down?</p>",
        "id": 513520006,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1745299843
    },
    {
        "content": "<p>Reading this might give you a better idea of what theorems to mark with <code>fun_prop</code> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/FunProp.html\">https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/FunProp.html</a></p>",
        "id": 513530104,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1745304753
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"223948\">David Ledvinka</span> <a href=\"#narrow/stream/287929-mathlib4/topic/AEMeasurable.20fun_prop.20prod/near/513520006\">said</a>:</p>\n<blockquote>\n<p>Could also do <code>MeasurePreserving</code>, is there a worry though that this will slow things down?</p>\n</blockquote>\n<p>That should not be a problem and if something gets suspiciously slow you can always turn on the trace <code>set_option trace.Meta.Tactic.fun_prop true</code> and see where <code>fun_prop</code> took the wrong turn and remove the offending theorem.</p>",
        "id": 513531485,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1745305207
    }
]