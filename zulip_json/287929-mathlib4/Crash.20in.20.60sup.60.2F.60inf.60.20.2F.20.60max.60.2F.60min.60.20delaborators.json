[
    {
        "content": "<p>These new delaborators seem to be giving me PANIC errors; or at least deleting them makes the PANICs go away. Here's the example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Ord</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">inf_eq_left</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">extracted_1</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">ih</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inf_eq_left</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Putting the cursor in the final <code>rw</code> gives me </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span><span class=\"bp\">.</span><span class=\"n\">getLevelDepth</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span><span class=\"o\">:</span><span class=\"mi\">874</span><span class=\"o\">:</span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">metavariable</span>\n<span class=\"n\">backtrace</span><span class=\"o\">:</span>\n</code></pre></div>\n<p>on local VSCode (it seems fine on the web editor)</p>",
        "id": 515946714,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746303062
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 515946911,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746303188
    },
    {
        "content": "<p>Can you make it fall in the command line with trace_state?</p>",
        "id": 515948515,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746304124
    },
    {
        "content": "<p>I'm looking at this trace:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span><span class=\"bp\">.</span><span class=\"n\">getLevelDepth</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span><span class=\"o\">:</span><span class=\"mi\">874</span><span class=\"o\">:</span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">metavariable</span>\n<span class=\"n\">backtrace</span><span class=\"o\">:</span>\n<span class=\"o\">(</span><span class=\"n\">lean_panic</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xf5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b77155</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_panic_fn</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x15</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b77335</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_SynthInstance_MkTableKey_normLevel</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x352</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d56ec992</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_List_mapM_loop___at_Lean_Meta_SynthInstance_MkTableKey_normExpr___spec__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x13b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d56ee6fb</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_SynthInstance_MkTableKey_normExpr</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1a3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d56eea33</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_SynthInstance_MkTableKey_normExpr</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x752</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d56eefe2</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_SynthInstance_mkTableKey___at_Lean_Meta_SynthInstance_main___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5743464</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_SynthInstance_main___lambda__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x9c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5743ffc</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_3</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xbac</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b87afc</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Core_withCurrHeartbeats___at_Lean_Meta_SynthInstance_main___spec__3</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x24</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5743bd4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_synthInstance_x3f___lambda__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x260</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5756cf0</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x8cc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8be2c</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_Basic_0__Lean_Meta_withNewMCtxDepthImp___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x447</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5684827</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_withNewMCtxDepth___at_Lean_Meta_matchesInstance___spec__1___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d51c7cff</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_synthInstance_x3f___lambda__4</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x12f2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57582d2</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x8cc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8be2c</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_withTraceNode___at_Lean_Meta_synthInstance_x3f___spec__4</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x2eb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57562eb</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_synthInstance_x3f___lambda__5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1f4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57611f4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe2f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b834bf</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_profileitIOUnsafe___rarg___lambda__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d50230ce</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_profileitIOUnsafe___rarg___lambda__1___boxed</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x9</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5023359</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xb5f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b831ef</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_profileit</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x83</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d886ffd3</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_profileitIOUnsafe___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5023234</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_synthInstance_x3f</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x162</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57614e2</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_SynthInstance_0__Lean_Meta_synthPendingImp___lambda__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xa0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57636b0</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_SynthInstance_0__Lean_Meta_synthPendingImp___lambda__3</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x12c0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57657b0</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xa70</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8bfd0</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_Basic_0__Lean_Meta_withMVarContextImp___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x203</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5688393</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_MVarId_withContext___at___private_Lean_Meta_SynthInstance_0__Lean_Meta_synthPendingImp___spec__2___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x17</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57633a7</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_synth_pending</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x4c2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d57670a2</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_unstuckMVar___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure___spec__1___lambda__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xb1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d53201e1</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_unstuckMVar___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x754</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d53218f4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_unstuckMVar___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure___spec__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x5a9</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5324329</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x8cc</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8be2c</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_withTraceNodeBefore___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_checkTypesAndAssign___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x2e4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d525edd4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqOnFailure</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1ef</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d532533f</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive___lambda__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe8c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d53426fc</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive___lambda__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x2256</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5345606</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xb6a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d534708a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_isExprDefEqAuxImpl___lambda__3</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x295b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d534f86b</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x5e6</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8bb46</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_withTraceNodeBefore___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_checkTypesAndAssign___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x2e4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d525edd4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_is_expr_def_eq</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x621</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d523cca1</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqLeft___lambda__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x26</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d52ef926</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqRight</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1cb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d52f009b</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isDefEqDelta</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xc72</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d53012a2</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive___lambda__2</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x129e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d534464e</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_ExprDefEq_0__Lean_Meta_isExprDefEqExpensive</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xb6a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d534708a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_isExprDefEqAuxImpl___lambda__3</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x295b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d534f86b</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x5e6</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8bb46</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_withTraceNodeBefore___at___private_Lean_Meta_ExprDefEq_0__Lean_Meta_checkTypesAndAssign___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x2e4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d525edd4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_is_expr_def_eq</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x621</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d523cca1</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_checkpointDefEq___at_Lean_Meta_isExprDefEq___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe20</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d56c17c0</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_isExprDefEq</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xd2e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d56c4e8e</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">ZN4lean5curryEPvjPP11lean_object</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1c9</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b825a9</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ece68a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d891368a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecc9a7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89119a7</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ed02a4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89152a4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecff07</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914f07</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecfcdd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914cdd</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_5</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xbe7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8c147</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l___private_Lean_Meta_Basic_0__Lean_Meta_withNewMCtxDepthImp___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x447</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d5684827</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_Meta_withNewMCtxDepth___at_Lean_Meta_matchesInstance___spec__1___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d51c7cff</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">ZN4lean5curryEPvjPP11lean_object</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1c9</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b825a9</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ece68a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d891368a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecc9a7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89119a7</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ece93c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d891393c</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecc9a7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89119a7</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ece93c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d891393c</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecc9a7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89119a7</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ed02a4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89152a4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecff07</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914f07</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecfd4a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914d4a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_10</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x987</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b94177</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_n</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x291</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b86e71</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecdf0d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8912f0d</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecc9a7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89119a7</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ed02a4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89152a4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecff07</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914f07</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecfc8a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914c8a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_8</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xc86</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b91a96</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_ReaderT_bind___at_Lean_PrettyPrinter_Delaborator_delabMVarAux___spec__1___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x286</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d7a7d146</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_7</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xde5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b901e5</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_PrettyPrinter_Delaborator_whenPPOption</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x295</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d7a4d995</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_7</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xde5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b901e5</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_PrettyPrinter_Delaborator_whenNotPPOption</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x3aa</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d7a4e16a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"n\">ZN4lean5curryEPvjPP11lean_object</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x25c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8263c</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ece68a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d891368a</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecc9a7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89119a7</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ed02a4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d89152a4</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ec82a9</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d890d2a9</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecff07</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914f07</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7ecfc2d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8914c2d</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_7</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xe2b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b9022b</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_List_firstM___at_Lean_PrettyPrinter_Delaborator_delabFor___spec__1</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x160</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d7a5e8a0</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_PrettyPrinter_Delaborator_delabFor</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x1b7</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d7a5f467</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_7</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x9a8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8fda8</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">l_Lean_PrettyPrinter_Delaborator_orElse___rarg</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">xce</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d7a4596e</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">lean_apply_7</span><span class=\"bp\">+</span><span class=\"mi\">0</span><span class=\"n\">x7f2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"n\">x7ff5d8b8fbf2</span><span class=\"o\">]</span>\n<span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span><span class=\"bp\">.</span><span class=\"n\">getLevelDepth</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span><span class=\"o\">:</span><span class=\"mi\">874</span><span class=\"o\">:</span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">metavariable</span>\n</code></pre></div>",
        "id": 515948703,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746304218
    },
    {
        "content": "<p>The panic is coming from an unknown universe metavariable, inside the <code>isDefEq</code> call in <code>hasLinearOrder</code> in <code>delabInf</code>.</p>",
        "id": 515950951,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746305543
    },
    {
        "content": "<p>The panic comes from the \"Expected type\" of <code>inf_eq_left</code>, so it's also triggered by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inf_eq_left</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>The expected type is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"bp\">.</span><span class=\"m\">8957</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst_1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 515951208,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746305721
    },
    {
        "content": "<p>I get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SemilatticeInf</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⊓</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 515951599,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746305950
    },
    {
        "content": "<p>I was using the <code>inf_eq_left</code> from <span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span>'s example</p>",
        "id": 515951887,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746306094
    },
    {
        "content": "<p>And the one in my example is modified from mathlib's version to make a more minimal example. You could just do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inf_eq_left</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and put your cursor over the <code>inf_eq_left</code> to get the same panic</p>",
        "id": 515952072,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746306192
    },
    {
        "content": "<p>oh, it panicked! yay!</p>",
        "id": 515953570,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746307064
    },
    {
        "content": "<p>time to bisect this</p>",
        "id": 515953796,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746307199
    },
    {
        "content": "<p>I already did :)</p>",
        "id": 515953874,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746307223
    },
    {
        "content": "<p>what'd you get</p>",
        "id": 515953962,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746307284
    },
    {
        "content": "<p>The problem is that this universe metavariable is not in the metavariable context during delaboration. But I don't understand why.</p>",
        "id": 515953966,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746307288
    },
    {
        "content": "<p>(I'm not sure in which way you mean the word bissect, but I meant it as \"figure out where the error comes from\")</p>",
        "id": 515954110,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746307372
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60sup.60.2F.60inf.60.20or.20.60max.60.2F.60min.60.20for.20set.20interval.20lemmas.3F/near/515953796\">said</a>:</p>\n<blockquote>\n<p>time to bisect this</p>\n</blockquote>\n<p>Yeah what happened here is I found the panic from <code>import Mathlib</code>, reduced it to something from <code>Order.Notation</code>, and Jovan found the line in that file which produces it! So we understand where it's coming from, but not why</p>",
        "id": 515955234,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746308090
    },
    {
        "content": "<p>the infoview now refuses to update for the one file that I'm investigating (it works fine for all the other files)</p>",
        "id": 515955657,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746308378
    },
    {
        "content": "<p>apparently it's bad to have IO operations on delaborators</p>",
        "id": 515955840,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746308495
    },
    {
        "content": "<p>It seems like this problem is specific to <code>rw</code>?</p>",
        "id": 515961168,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312078
    },
    {
        "content": "<p>Maybe we should be looking at the code for <code>rw</code> instead</p>",
        "id": 515961203,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312114
    },
    {
        "content": "<p>No, the problem is caused whenever it elaborates (and delaborates the expected type of) <code>inf_eq_left</code> without at expected type</p>",
        "id": 515961277,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746312150
    },
    {
        "content": "<p>I didn't get the panic on <code>simp</code> though, so what's the difference?</p>",
        "id": 515961480,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312297
    },
    {
        "content": "<p>I do seem to get a panic with <code>simp</code>, for example when hovering over <code>inf_eq_left</code></p>",
        "id": 515961663,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746312416
    },
    {
        "content": "<p>I'll try again then.</p>",
        "id": 515961822,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312524
    },
    {
        "content": "<p>panic on <code>rw</code></p>",
        "id": 515961847,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312548
    },
    {
        "content": "<p>panic on <code>rewrite</code></p>",
        "id": 515961868,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312563
    },
    {
        "content": "<p>no panic on <code>simp</code></p>",
        "id": 515961970,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746312617
    },
    {
        "content": "<p>Hmm, I was probably wrong</p>",
        "id": 515962906,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746313289
    },
    {
        "content": "<p><code>rw [(inf_eq_left)]</code> also doesn't panic</p>",
        "id": 515963288,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746313553
    },
    {
        "content": "<p>So it's something about how <code>rw</code> handles constants differently than expressions</p>",
        "id": 515963371,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746313581
    },
    {
        "content": "<p>The culprit is probably <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.withRWRulesSeq#doc\">docs#Lean.Elab.Tactic.withRWRulesSeq</a></p>",
        "id": 515963406,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746313617
    },
    {
        "content": "<p>You're right, thank you! Here is a minimization:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Ord</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">inf_eq_left</span><span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">optional</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">getFVarId</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"c1\">-- comment out this line to avoid the panic!</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">inf_eq_left</span>\n</code></pre></div>\n<p>Apparently Lean gets confused when the same syntax gets elaborated multiple times.</p>",
        "id": 515964855,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746314630
    },
    {
        "content": "<p>Now all that's left to do is to fix it</p>",
        "id": 515965011,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746314750
    },
    {
        "content": "<p>How does <code>simp</code> do it?</p>",
        "id": 515965298,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746314927
    },
    {
        "content": "<p>The issue seems to be that <code>optional</code>/<code>orElse</code> for <code>TacticM</code> does not restore the info state. If we instead use something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">observing?</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">restoreInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">saveState</span>\n<span class=\"w\">  </span><span class=\"n\">try</span>\n<span class=\"w\">    </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">restore</span><span class=\"w\"> </span><span class=\"n\">restoreInfo</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>\n<p>with <code>restoreInfo := true</code> (and this def might already exist somewhere?) I think it should be fine. :)</p>",
        "id": 515965302,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1746314931
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60sup.60.2F.60inf.60.20or.20.60max.60.2F.60min.60.20for.20set.20interval.20lemmas.3F/near/515965298\">said</a>:</p>\n<blockquote>\n<p>How does <code>simp</code> do it?</p>\n</blockquote>\n<p>Interestingly, <code>simp</code> uses <code>Term.isLocalIdent?</code>, which is a completely different approach!</p>\n<p><code>getFVarId</code> tries to elaborate the term, then fails if the expression is not an <code>.fvar</code> (and if it is, returns the <code>FVarId</code>). For idents, it uses <code>Term.resolveId?</code>, which resolves <em>any</em> identifier, and adds info to the infotree. In contrast, <code>Term.isLocalIdent?</code> seems to just traverse the local context (etc.) to try to match the actual identifier, without touching the info state.</p>",
        "id": 515968359,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1746317041
    },
    {
        "content": "<p>36 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.02klzzwxh.3A0000.03.2F.02klzzwxh.3A0001.03.20or.20.02klzzwxh.3A0002.03.2F.02klzzwxh.3A0003.03.20for.20set.20interval.20lemmas.3F\">#mathlib4 &gt; <code>sup</code>/<code>inf</code> or <code>max</code>/<code>min</code> for set interval lemmas?</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 515968910,
        "sender_full_name": "Notification Bot",
        "timestamp": 1746317397
    },
    {
        "content": "<p>Confusingly, the problem is the other way around. We get a panic if we do restore the state. Here it is further minimized:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Max</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Ord</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">inf_eq_left</span><span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">saveState</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">resolveId?</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">withInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- comment out `(withInfo := true)` to avoid the panic!</span>\n<span class=\"w\">  </span><span class=\"n\">restoreState</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"c1\">-- comment out this line to avoid the panic!</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">inf_eq_left</span>\n</code></pre></div>",
        "id": 515970094,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746318171
    },
    {
        "content": "<p>Now I'm just confused</p>",
        "id": 515970167,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746318216
    },
    {
        "content": "<p>Somehow, when hovering to see the type, you see the expression from the first time elaborating (with <code>(withInfo := true)</code>), but with the metavariable context from the second time elaborating. <code>restoreState s</code> doesn't affect the <code>InfoTree</code>, but it does affect the metavariable context, thus erasing any universe metavariable that was introduced during the first time elaborating.</p>",
        "id": 515971286,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746318986
    },
    {
        "content": "<p>I see</p>",
        "id": 515971311,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746319008
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> what do you mean by the problem being the other way around? We seem to be in agreement that not restoring the info state is the issue.</p>",
        "id": 515972843,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1746320145
    },
    {
        "content": "<p>No, my observation is that restoring the state causes the panic</p>",
        "id": 515973052,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746320256
    },
    {
        "content": "<p>In particular restoring the metavariable state removes the universe metavariable from the metavariable context. And that universe metavariable is causing the panic.</p>",
        "id": 515973249,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746320387
    },
    {
        "content": "<p>The best fix in this case would be to avoid <code>(withInfo := true)</code>.</p>",
        "id": 515973383,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746320444
    },
    {
        "content": "<p>But there is also an underlying problem of delaboration not using the correct metavariable context.</p>",
        "id": 515973552,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746320526
    },
    {
        "content": "<p>To be clear, the <em>info</em> state I’m talking about refers to the info trees (etc.)! As you observed, when you use <code>restoreState</code>, you’re not restoring the <em>info</em> state. But if you use <code>s.restore (restoreInfo := true)</code>, as I mentioned, then the info state is restored as well.</p>",
        "id": 515973711,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1746320640
    },
    {
        "content": "<p>You can also see this bug in an arbitrary <code>rw</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">mvars</span><span class=\"bp\">.</span><span class=\"n\">withType</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_comm</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>The universe level is different in the \"Expected type\" and the \"tactic 'rewrite' failed\".</p>",
        "id": 516029956,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746366473
    },
    {
        "content": "<p>I made a PR to fix this: <a href=\"https://github.com/leanprover/lean4/pull/8232\">lean4#8232</a></p>",
        "id": 516173018,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746445531
    },
    {
        "content": "<p>The issue here is that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=getFVarId#doc\">docs#getFVarId</a> causes elaboration?</p>",
        "id": 516179308,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746447109
    },
    {
        "content": "<p>Should the docs be updated to suggest using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Term.isLocalIdent%3F#doc\">docs#Term.isLocalIdent?</a> when possible instead?</p>",
        "id": 516179606,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746447194
    },
    {
        "content": "<p>I looked at the other uses of <code>getFVarId</code>, and it seems to mostly be used in situations where it is expected that the term is a free variable. So it seems to be used correctly usually.</p>",
        "id": 516181197,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746447695
    },
    {
        "content": "<p>The problem in <code>rw</code> is that the error from <code>getFVarId</code> was being caught</p>",
        "id": 516182251,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746447995
    },
    {
        "content": "<p>Thanks for figuring this out, everybody!</p>",
        "id": 516224842,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746457196
    },
    {
        "content": "<p>There is a mathlib failure on the PR. Apparently my approach with <code>Term.isLocalIdent</code> doesn't work?</p>",
        "id": 516229965,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746458494
    },
    {
        "content": "<p>You need to do it <code>withMainContext</code></p>",
        "id": 516246784,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746462623
    },
    {
        "content": "<p>(this was the product of an hour of debugging)</p>",
        "id": 516247347,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746462745
    },
    {
        "content": "<p>By a series of coincidences, not using <code>withMainContext</code> only causes problems when you want to rewrite with a local hypothesis that wasn't present at the beginning of the <code>by</code> block and that has the same name as a (non-ambiguous) global constant, which explains why it didn't cause problems in core.</p>",
        "id": 516250432,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746463399
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span> has marked this topic as resolved.</p>",
        "id": 520476309,
        "sender_full_name": "Notification Bot",
        "timestamp": 1748272100
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> has marked this topic as unresolved.</p>",
        "id": 545838331,
        "sender_full_name": "Notification Bot",
        "timestamp": 1760888398
    },
    {
        "content": "<p>I'm still getting this panic, here's my example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_max</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n</code></pre></div>",
        "id": 545838349,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1760888409
    },
    {
        "content": "<p>Is it reproducible on Lean web?</p>",
        "id": 545841454,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760891702
    },
    {
        "content": "<p>yes</p>",
        "id": 545841465,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760891712
    },
    {
        "content": "<p>I reproduced it</p>",
        "id": 545841468,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760891715
    },
    {
        "content": "<p>unfortunately, Lean web doesn't report the panics in the backend, so it just shows up as not pretty printing</p>",
        "id": 545841498,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760891752
    },
    {
        "content": "<p>What is not being printed?</p>",
        "id": 545841569,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760891831
    },
    {
        "content": "<p>oh that's not what I expected</p>",
        "id": 545845573,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760895761
    },
    {
        "content": "<p>maybe nothing's not being printed</p>",
        "id": 545845587,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760895769
    },
    {
        "content": "<p>Ok, I've done some investigation, and it seems that the problem is in <code>tryTactic</code>. It has a <code>try</code> <code>catch</code> block, and the <code>MonadExcept TacticM</code> instance calls <code>Lean.Elab.Term.SavedState.restore</code>, which has a default argument <code>(restoreInfo : Bool := false)</code>, and if we set this to <code>true</code> instead of <code>false</code>, then the panic disappears.</p>\n<p>The original problem was fixed by making sure the expression is only delaborated once. But for <code>rw at *</code>, the expression needs to be able to be delaborated multiple times.</p>",
        "id": 545845787,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760895935
    },
    {
        "content": "<p>Similarly to before, the problem is that the \"expected type\" part of the infoview contains some universe level metavaraibles which have been reverted by a try-catch block. But in this case we do want to keep this hover information. (Note that <code>rw</code> adds hover info to the info tree for each place where it tries to rewrite)</p>",
        "id": 545846243,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760896302
    },
    {
        "content": "<p>Shouldn't the infoview contain the snapshot before it was reverted, as context?</p>",
        "id": 545846427,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760896497
    },
    {
        "content": "<p>There is this combinator <code>withTacticInfoContext</code> which is called inside <code>withRWRulesSeq</code>. It stores the before &amp; after versions of the <code>MetavarContext</code> into the info tree.</p>\n<p>The issue is that the metavariable context is reset before <code>withTacticInfoContext</code> can store it.</p>",
        "id": 545846541,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760896599
    },
    {
        "content": "<p>This version of the bug actually is much more general than just the <code>sup</code>/<code>inf</code> delaborator. Here's a Mathlib-free version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n</code></pre></div>\n<p>If you put your cursor on the <code>_</code>, then the infoview says</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">updating</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">fetching</span><span class=\"w\"> </span><span class=\"n\">goals</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rpc</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">InternalError</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">metavariable</span><span class=\"w\"> </span><span class=\"bp\">'?_</span><span class=\"n\">uniq</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"bp\">'.</span><span class=\"w\"> </span><span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">again</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 545847467,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760897519
    },
    {
        "content": "<p>Nice minimization!</p>",
        "id": 545847663,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760897674
    },
    {
        "content": "<p>This infoview-breaking bug can also show up in a tactic that succeeds</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add_comm</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n</code></pre></div>",
        "id": 545856687,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760907639
    },
    {
        "content": "<p>This example seems to suggest that it would be better to reset the info tree for the locations where the tactic fails. But on the other hand, if the tactic fails everywhere, you'd still want to have some hover information available. But I guess in the case that the tactic fails everywhere, the hover info can be added separately.</p>",
        "id": 545857004,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1760908059
    },
    {
        "content": "<p>Is this at the point where it's worth filing a bug or moving to #lean4? I think contined conversation in this thread about our unusual delaborators is likely to end up overlooked.</p>",
        "id": 545857241,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1760908380
    },
    {
        "content": "<p>Jovan, would you mind making the bug for this? I think you understand this quite a bit better than me now!</p>",
        "id": 546471344,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1761142931
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/10898\">lean#10898</a></p>",
        "id": 546506156,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1761151681
    }
]