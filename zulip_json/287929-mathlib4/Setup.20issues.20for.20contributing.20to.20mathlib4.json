[
    {
        "content": "<p>Hi, I'm new here. I installed Lean by unpacking <a href=\"https://github.com/leanprover/lean4/releases/download/v4.17.0-rc1/lean-4.17.0-rc1-linux.tar.zst\">https://github.com/leanprover/lean4/releases/download/v4.17.0-rc1/lean-4.17.0-rc1-linux.tar.zst</a> and adding the <code>bin/</code> directory to my path.</p>\n<p>I am <em>not</em> using Elan nor VS Code (the reasons would be off-topic).</p>\n<p>The Lean LSP works in my editor, and I'm able to use mathlib in a package created with <code>lake</code> (after adding it to the dependencies in the <code>lakefile.toml</code>, fixing <code>lean-toolchain</code> and running <code>lake update</code> then <code>lake exe cache get</code>).</p>\n<p>However, when I try to contribute to mathlib itself, after doing <code>lake exe cache get</code>, a <code>lake build</code> succeeds, but I can't use the LSP. It fails on imports from mathlib itself, telling me: “Unknown module prefix 'Mathlib'. No directory 'Mathlib' or file 'Mathlib.olean' in the search path entries: /…/lib/lean”.</p>\n<p>What might be going on?</p>",
        "id": 501390990,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329190
    },
    {
        "content": "<p>(The only community supported setup is using elan, so I suspect for many people discussing some other setup is entirely offtopic for mathlib itself, and by doing so you're on your own there, but I sympathize, as I too occasionally use some other setup.)</p>\n<p>You'll have to be a bit more specific though on exactly what you ran and what you did -- in particular, running <code>lake update</code> is not part of contributing to Mathlib typically, and I don't know what you mean by \"fixing\" <code>lean-toolchain</code>, nothing should be touched there even from the rest of what you mention.</p>",
        "id": 501391370,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740329513
    },
    {
        "content": "<p>Sorry, copy-paste mistake, I did not run <code>lake update</code> in the mathlib repo (edited the OP).</p>",
        "id": 501391478,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329593
    },
    {
        "content": "<p>By \"fixing\" <code>lean-toolchain</code> I mean the <code>curl</code> command here: <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Using-mathlib4-as-a-dependency#in-an-existing-project\">https://github.com/leanprover-community/mathlib4/wiki/Using-mathlib4-as-a-dependency#in-an-existing-project</a></p>",
        "id": 501391558,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329646
    },
    {
        "content": "<p>(It changed the contents from <code>leanprover/lean4:4.17.0-rc1</code> to <code>leanprover/lean4:v4.17.0-rc1</code>, which seems a little strange to me, but I did not investigate. In any case, the LSP worked on this test package with mathlib dependency.)</p>",
        "id": 501391641,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329722
    },
    {
        "content": "<p>So.. it didn't change them in other words? That simply means you have the same version now as what Mathlib is using right now, which is all fine.</p>",
        "id": 501391726,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740329773
    },
    {
        "content": "<p>And you're saying everything works fine in your project depending on Mathlib?</p>",
        "id": 501391734,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740329783
    },
    {
        "content": "<p>And now you have a separate directory with a new clone of Mathlib itself, and in there stuff doesn't work?</p>",
        "id": 501391744,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740329794
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Setup.20issues.20for.20contributing.20to.20mathlib4/near/501391726\">said</a>:</p>\n<blockquote>\n<p>So.. it didn't change them in other words? That simply means you have the same version now as what Mathlib is using right now, which is all fine.</p>\n</blockquote>\n<p>Mind the <code>v</code> added to the version.</p>",
        "id": 501391756,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329815
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321696\">Julian Berman</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Setup.20issues.20for.20contributing.20to.20mathlib4/near/501391744\">said</a>:</p>\n<blockquote>\n<p>And now you have a separate directory with a new clone of Mathlib itself, and in there stuff doesn't work?</p>\n</blockquote>\n<p>Yes, exactly. I can use mathlib in a package I create with <code>lake</code>, but not contribute to mathlib itself.</p>",
        "id": 501391794,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329854
    },
    {
        "content": "<p>This is all I did to try contributing to mathlib:</p>\n<ul>\n<li><code>git clone</code> mathlib</li>\n<li><code>lake exe cache get</code></li>\n<li>Open some file in <code>Mathlib/</code></li>\n</ul>",
        "id": 501391866,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329896
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"880066\">Jean Abou Samra</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Setup.20issues.20for.20contributing.20to.20mathlib4/near/501391756\">said</a>:</p>\n<blockquote>\n<p>Mind the <code>v</code> added to the version.</p>\n</blockquote>\n<p>(oh, I see, yes I think that seems fine, the tag is named with a <code>v</code>, and certainly it doesn't seem to matter if things work there)</p>",
        "id": 501391893,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740329921
    },
    {
        "content": "<p>What editor are you in?</p>",
        "id": 501391902,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740329930
    },
    {
        "content": "<p>Helix. It auto-detected the <code>lean</code> command to launch the LSP.</p>",
        "id": 501391939,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740329963
    },
    {
        "content": "<p>That sounds wrong</p>",
        "id": 501392131,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740330104
    },
    {
        "content": "<p>Specifically you need to check that it ran <code>lake serve</code>, and that it did so from the right workspace root</p>",
        "id": 501392201,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740330131
    },
    {
        "content": "<p>(which should be the directory you cloned mathlib into)</p>",
        "id": 501392219,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740330156
    },
    {
        "content": "<p>Aaah, thank you, let me see if that fixes it.</p>",
        "id": 501392249,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740330187
    },
    {
        "content": "<p>In particular if it ran <code>lean --server</code> usually that means something has gone wrong (perhaps it ran <code>lake</code>, but in the wrong directory)</p>",
        "id": 501392257,
        "sender_full_name": "Julian Berman",
        "timestamp": 1740330194
    },
    {
        "content": "<p>Does the Helix plugin have an InfoView?</p>",
        "id": 501395238,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1740332787
    },
    {
        "content": "<p>I did some debugging. For a start, Helix was configured by default to run <code>lean --server</code>, I changed that to use <code>lake serve</code>. But now what happens is that Helix correctly detects the root folder based on the presence of <code>lakefile.lean</code>, but still spawns the LSP process in the CWD. Nevertheless I see in the LSP conversation log that it sends</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"nt\">\"rootPath\"</span><span class=\"p\">:</span><span class=\"s2\">\"/home/jean/repos/mathlib4\"</span><span class=\"p\">,</span>\n<span class=\"nt\">\"rootUri\"</span><span class=\"p\">:</span><span class=\"s2\">\"file:///home/jean/repos/mathlib4\"</span><span class=\"p\">,</span>\n<span class=\"nt\">\"workspaceFolders\"</span><span class=\"p\">:[{</span><span class=\"nt\">\"name\"</span><span class=\"p\">:</span><span class=\"s2\">\"mathlib4\"</span><span class=\"p\">,</span><span class=\"nt\">\"uri\"</span><span class=\"p\">:</span><span class=\"s2\">\"file:///home/jean/repos/mathlib4\"</span><span class=\"p\">}]</span>\n</code></pre></div>\n<p>in the <code>initialize</code> request. In the LSP spec (<a href=\"https://microsoft.github.io/language-server-protocol/specifications/specification-3-14/#workspace_workspaceFolders\">https://microsoft.github.io/language-server-protocol/specifications/specification-3-14/#workspace_workspaceFolders</a>) it is explained that these are how the client tells the server about the project root (and possibly other workspaces).</p>\n<p>This leaves me a bit confused. Does Lean really follow LSP conventions by requiring to be started in the root?</p>",
        "id": 501395304,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740332865
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Setup.20issues.20for.20contributing.20to.20mathlib4/near/501395238\">said</a>:</p>\n<blockquote>\n<p>Does the Helix plugin have an InfoView?</p>\n</blockquote>\n<p>I'm not using a Helix plugin (I don't think these even exist yet), just Helix's built-in LSP support. What do you mean by an InfoView?</p>",
        "id": 501395438,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740332980
    },
    {
        "content": "<p>Frankly I would suggest that you try the recommended setup with Vs code first before you try a custom one</p>",
        "id": 501395977,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1740333384
    },
    {
        "content": "<blockquote>\n<p>What do you mean by an InfoView?</p>\n</blockquote>\n<p>You would not be the first person to try Lean with a non-recommended set up and be completely unaware of the infoview, giving yourself a hugely degraded Lean experience and making things much harder for yourself, but I do not want you to be another one of these people. </p>\n<p>Here's some code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"n\">b</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">a</span><span class=\"bp\">*</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- put your cursor here and look right</span>\n<span class=\"w\">  </span><span class=\"n\">ring</span>\n</code></pre></div>\n<p>Click on \"View in Lean 4 playground\" (icon on the top right of the code) and you'll see the infoview in action in a web browser.</p>",
        "id": 501397584,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740334555
    },
    {
        "content": "<p>It's an interactive view giving you the current goal state, hypotheses, and lots of features like hovering on types and terms to see their definitions etc. It's indispensable for any nontrivial project.</p>",
        "id": 501397719,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740334666
    },
    {
        "content": "<p>So the InfoView is just the right panel on <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a> and in VS Code? I see. I would have assumed these features would be (mostly) covered by the LSP capabilities, but I guess the protocol might not be too tailored to proof assistants. In any case, I come from other proof assistant communities and only have one drive-by contribution to make for now (a simplification of <code>Mathlib/Algebra/Order/Ring/Defs.lean</code> based on <a href=\"https://proofassistants.stackexchange.com/a/4762/\">https://proofassistants.stackexchange.com/a/4762/</a>).</p>",
        "id": 501399619,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740336187
    },
    {
        "content": "<p>To summarize, my setup is working (I just have to remain in <code>mathlib4</code> and open files from there), and my question at this point is whether I should open a bug report for the fact that <code>lake serve</code> expects to be started in the project root (as my understanding is that this is contrary to normal behavior for LSP servers).</p>",
        "id": 501400410,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740336924
    },
    {
        "content": "<p>Before you waste too much time on this (based on reading the stackexchange post you linked to): if your proposal is to make some change to the order that things are done in the typeclass inference system then you might want to run the idea past the community before making the PR, because there are reasons it's set up the way it's set up, and I suspect that there won't be too much interest in a change which e.g. will make mathlib compile far slower but which will remove the use of an axiom when defining an identity map.</p>",
        "id": 501400686,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740337173
    },
    {
        "content": "<p>You might want to read the parts about \"preferred\" typeclass paths in <a href=\"https://arxiv.org/pdf/2306.00617\">https://arxiv.org/pdf/2306.00617</a> for example.</p>",
        "id": 501400910,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740337307
    },
    {
        "content": "<p>I understand people who don’t want to use VSCode, but if you use helix then you should use neovim when editing Lean code. You won’t be far from the kind of editing experience you like like but you will have almost full editor plugin features.</p>",
        "id": 501404627,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740340045
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> Thanks for the warning. I wanted to make a very simple change, but it's turning out a lot more complicated than I anticipated so I think I will give up on this one.</p>",
        "id": 501405926,
        "sender_full_name": "Jean Abou Samra",
        "timestamp": 1740341096
    },
    {
        "content": "<p>I think the proposed change to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=StrictOrderedRing.toStrictOrderedSemiring#doc\">docs#StrictOrderedRing.toStrictOrderedSemiring</a> is harmless, but also of minimal value</p>",
        "id": 501430691,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740362089
    }
]