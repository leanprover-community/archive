[
    {
        "content": "<p>On latest master, trying to add an <code>#lint</code> in a file gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"ss\">`_private.Mathlib.Tactic.Linter.TacticDocumentation</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">.</span><span class=\"n\">tacticDocs</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>Am I using it wrong?</p>",
        "id": 565443234,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1766755787
    },
    {
        "content": "<p>I guess <code>#lint</code> needs to learn about the module system?</p>",
        "id": 565451480,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766762770
    },
    {
        "content": "<p>I believe it worked last week, so the introduction of the module system isn't the issue</p>",
        "id": 565452752,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766763738
    },
    {
        "content": "<p>Maybe it's <a href=\"https://tqft.net/mathlib4files/Tactic/Linter/TacticDocumentation\">file#Tactic/Linter/TacticDocumentation</a>, which was added 4 days ago</p>",
        "id": 565454647,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766765390
    },
    {
        "content": "<p>it seems to be doing something different than a random sample of other linter files I looked at</p>",
        "id": 565454887,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766765606
    },
    {
        "content": "<p>Is the quick fix simply that the <code>@[env_linter]</code> <code>tacticDocs</code> in that file needs to be <code>public</code>?</p>\n<p>(Note: it also looks like maybe the <code>@[env_linter]</code> is creating some public declaration when it shouldn’t be, as I’m not sure why the privateModule linter isn’t firing! Also, perhaps <code>@[env_linter]</code> needs to do some new visibility-related validation to make sure its tagged declarations are public and can indeed be run by <code>#lint</code>; not sure, though, since I thought <code>#lint</code> behaves as though <em>not</em> in a module currently, and so this wouldn’t be an issue…how does <code>env_linter</code> tag its declarations, exactly? <del>Unfortunately I likely can’t investigate further today!</del> I had a bit of time to investigate. :) )</p>",
        "id": 565458569,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766769269
    },
    {
        "content": "<p>Ah, the <code>privateModule</code> linter does not fire because it's not imported. <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 565469318,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766780429
    },
    {
        "content": "<p>It does seem that marking it <code>public</code> was sufficient as a quick fix. :) <a href=\"https://github.com/leanprover-community/mathlib4/pull/33322\">#33322</a></p>\n<p>Next, we should make a PR to Batteries which does extra validation when adding <code>@[env_linter]</code>.</p>",
        "id": 565470090,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766781462
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/1578\">batteries#1578</a></p>",
        "id": 565489680,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766811681
    },
    {
        "content": "<p>It seems it is broken again (differently). When doing <code>#lint</code> on a file on mathlib, I get <code>unexpected token '#'; expected command</code>.</p>",
        "id": 567343651,
        "sender_full_name": "Joël Riou",
        "timestamp": 1768075364
    },
    {
        "content": "<p>probably just slow?</p>",
        "id": 567343690,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768075435
    },
    {
        "content": "<p>If you had typed just <code>#</code>, it'll hit you with  <code>unexpected token '#'; expected command</code>. So if the sequence of events were</p>\n<ul>\n<li>you type <code>#</code></li>\n<li>Lean reacts with that error</li>\n<li>you finish typing the rest (<code>lint</code>)</li>\n<li>Lean starts linting behind the scenes, but does it slowly (as Aaron said)</li>\n</ul>\n<p>then you could hypothetically still see that error the whole time it's linting.</p>\n<p>But I think Lean happens to erase parser errors like that before it restarts elaboration, and in this case I think you'd see just a yellow bar showing it was working.</p>",
        "id": 567345973,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768078406
    },
    {
        "content": "<p>My guess is it's just no longer imported for whatever reason?</p>",
        "id": 567345992,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768078434
    },
    {
        "content": "<p>oh the <code>#lint</code> command is defined in mathlib</p>",
        "id": 567346091,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768078584
    },
    {
        "content": "<p>I'm pretty sure it's in <code>Batteries.Tactic.Lint.Frontend</code>; did it recently get upstreamed or something?</p>",
        "id": 567346192,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768078725
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> \"#lint\"</p>",
        "id": 567346252,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768078789
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Batteries/Tactic/Lint/Frontend.html#Batteries.Tactic.Lint.%C2%ABcommand%23lint%2B-%2AOnly___%C2%BB\">Batteries.Tactic.Lint.«command#lint+-*Only___»</a></p>",
        "id": 567346258,
        "sender_full_name": "loogle",
        "timestamp": 1768078794
    },
    {
        "content": "<p>I guess it's in batteries then</p>",
        "id": 567346273,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768078805
    },
    {
        "content": "<p>I'm confused, are you claiming that <code>#lint</code> does work for you?<br>\nIt can't be the <code>#</code> + <code>lint</code> slowness, as demonstrated here:</p>\n<p><a href=\"/user_uploads/3121/9gDyJvhemVr7y4zGLlPWRm6m/lint.mp4\">lint.mp4</a></p>\n<div class=\"message_inline_image message_inline_video\"><a href=\"/user_uploads/3121/9gDyJvhemVr7y4zGLlPWRm6m/lint.mp4\" title=\"lint.mp4\"><video preload=\"metadata\" src=\"/user_uploads/3121/9gDyJvhemVr7y4zGLlPWRm6m/lint.mp4\"></video></a></div>",
        "id": 567346351,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768078888
    },
    {
        "content": "<p>FWIW it does work on live-lean, but not on my local copy for some reason (latest master)</p>",
        "id": 567346373,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768078924
    },
    {
        "content": "<p>which file is it in?</p>",
        "id": 567346374,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768078924
    },
    {
        "content": "<p>The video is from <code>Mathlib/GroupTheory/GroupAction/Defs.lean</code></p>",
        "id": 567346389,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768078942
    },
    {
        "content": "<p>Thanks. Importing <code>Batteries.Tactic.Lint</code> fixed the issue.</p>",
        "id": 567346400,
        "sender_full_name": "Joël Riou",
        "timestamp": 1768078955
    },
    {
        "content": "<p>Maybe it was <a href=\"https://github.com/leanprover-community/mathlib4/pull/32731\">#32731</a>? <a href=\"https://github.com/leanprover-community/mathlib4/pull/32731/changes#diff-897c89c045fd08d2c55c7cafc10aebade095c1bdb5c5f65251f3615cc59ea8a9L11\">Here's</a> an example of a removal an <code>import Batteries.Tactic.Lint</code></p>",
        "id": 567346445,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768079025
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"933054\">Snir Broshi</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.23lint.20is.20broken/near/567346373\">said</a>:</p>\n<blockquote>\n<p>FWIW it does work on live-lean, but not on my local copy for some reason (latest master)</p>\n</blockquote>\n<p>it doesn't work on live-lean either</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GroupTheory</span><span class=\"bp\">.</span><span class=\"n\">GroupAction</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"c1\">-- unexpected token '#'; expected command</span>\n<span class=\"bp\">#</span><span class=\"n\">lint</span>\n</code></pre></div>",
        "id": 567346446,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768079026
    },
    {
        "content": "<p>Should we just import it in Mathlib.Init?</p>",
        "id": 567346515,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768079104
    },
    {
        "content": "<p><code>#lint</code> is upstream of mathlib, we already import syntax linters in Mathlib.Init, <code>#lint</code> is the hook for the other kind of linter and is something someone might want to use anywhere...having it in <code>Mathlib.Init</code> makes sense to me, but is there a reason not to?</p>",
        "id": 567346662,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768079293
    },
    {
        "content": "<p>Hmmm</p>\n<p><a href=\"/user_uploads/3121/D6nUxriWIy5w9VjXmYOvgIl9/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/D6nUxriWIy5w9VjXmYOvgIl9/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2692x586\" src=\"/user_uploads/thumbnail/3121/D6nUxriWIy5w9VjXmYOvgIl9/image.png/840x560.webp\"></a></div><p>The shake tool broke <a href=\"https://github.com/leanprover-community/mathlib4/blob/9aabfe186c76f2d759cf863af8e2f0cf8a5db96f/Mathlib/Init.lean#L14-L15\">this comment</a></p>",
        "id": 567346667,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768079299
    },
    {
        "content": "<p>So it seems we should revert the change in the screenshot, and also fix some bug in the shake tool?</p>",
        "id": 567346734,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768079392
    },
    {
        "content": "<p>Ah, so it <em>was</em> imported! That makes sense.</p>\n<p>I don't think it's a bug in the shake tool so much as that <a href=\"https://github.com/leanprover-community/mathlib4/pull/32731\">#32731</a> might have been too much to carefully review. I think the solution is to tell shake to keep the import. (I think this is <code>-- shake: keep</code> now or something?)</p>",
        "id": 567346804,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768079472
    },
    {
        "content": "<p>I'll start a PR.</p>",
        "id": 567346825,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768079500
    },
    {
        "content": "<p>Oh, wait, I see what you're saying, I misinterpreted. Right, if a module is annotated keep-all, it doesn't necessarily keep its transitive imports...</p>",
        "id": 567346897,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768079592
    },
    {
        "content": "<p>idk what <code>meta import</code> does but it's also sus that the shake tool converted all of them to normal imports</p>",
        "id": 567346901,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768079599
    },
    {
        "content": "<p>Is there an annotation like <code>shake: keep-upstream</code>? (Or maybe that's not really what we want here anyway...seems rather nonlocal on reflection)</p>",
        "id": 567346908,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768079612
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span></p>",
        "id": 567347004,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768079728
    },
    {
        "content": "<p>Oh that's a strange special case: Shake does preserve an existing import <code>X</code> even if only some <code>X.Y</code> is needed but here it gets confused because <code>Batteries.Tactic.Lint</code> uses <code>meta import</code> (and does not even directly import <code>.Basic</code>), which should be avoided unless necessary and here is simply a porting artifact. <a href=\"https://github.com/leanprover-community/batteries/pull/1613\">batteries#1613</a> will make sure the next Shake run will not change it back to <code>Lint.Basic</code> (once fixed manually) even without annotations.</p>",
        "id": 567348613,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1768080926
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/33827\">#33827</a> for the quick fix restoring <code>#lint</code>'s availability through Mathlib.Init. Currently it just restores the status quo to get <code>#lint</code> working again without considering the import hierarchy there further.</p>",
        "id": 567349064,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768081099
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> Ah, I see—so does that mean leaving a <code>TODO</code> to remove the new <code>-- shake: keep</code> is appropriate? Or does shake automatically tell us to clean up unnecessary <code>keep</code>s?</p>",
        "id": 567349095,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768081140
    },
    {
        "content": "<p>It does not :)</p>",
        "id": 567349129,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1768081188
    },
    {
        "content": "<p>I do wonder whether instead of having a one-line comment in <code>Mathlib.Init</code> about how we rely on some module importing some other module here... we should simply import that module right there</p>",
        "id": 567349177,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1768081251
    },
    {
        "content": "<p><code>#lint</code> is special because it's never in any file (other than the tests) but people rely on it being available anywhere in Mathlib</p>",
        "id": 567349227,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768081312
    },
    {
        "content": "<p><code>#min_imports</code> is in there too</p>",
        "id": 567349337,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768081443
    },
    {
        "content": "<p>I assume the shake tool starts with <code>Mathlib.lean</code> as the \"root\", so a fix can be specifying <code>Mathlib/Init.lean</code> as another root. Where \"root\" means anything that exists in the file must still exist after any import changes.</p>",
        "id": 567349381,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768081503
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.23lint.20is.20broken/near/567349177\">said</a>:</p>\n<blockquote>\n<p>I do wonder whether instead of having a one-line comment in <code>Mathlib.Init</code> about how we rely on some module importing some other module here... we should simply import that module right there</p>\n</blockquote>\n<p>I was wondering the same thing... (hence my disclaimer about just restoring the status quo <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span>)</p>\n<p>The other half of that is whether that imported file (<code>Mathlib.Tactic.Linter.Lint</code>), or any file using <code>@[env_linter]</code>, should import <code>Batteries.Tactic.Lint</code> or just <code>*.Basic</code>. You can't really use <code>@[env_linter]</code> without <code>#lint</code>, so I'm inclined towards the former as a rule of thumb.</p>\n<p>And if <code>Mathlib.Tactic.Linter.Lint</code> <em>should</em> import <code>#lint</code>, I guess there's a broader stylistic question of when and whether we should rely on transitive imports or duplicate them as a direct import.</p>",
        "id": 567349389,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768081518
    },
    {
        "content": "<p>Is this new shake tool publically available? How do I use it in my repo?</p>",
        "id": 567623940,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1768245314
    },
    {
        "content": "<p>It will ship with the next RC</p>",
        "id": 567625141,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1768245755
    },
    {
        "content": "<p>In particular, it is out now!</p>",
        "id": 570453738,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769564602
    },
    {
        "content": "<p>I think <code>#min_imports</code> is suffering from the same problem, it seems not te be imported in <code>Mathlib.Init</code></p>",
        "id": 573303540,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1770820664
    },
    {
        "content": "<p>Maybe we need a test file with a <code>-- shake: keep-all</code> that only imports <code>Mathlib.Init</code> and tries all these commands that should work at any point in Mathlib (like <code>#lint</code> and <code>#min_imports</code>)</p>",
        "id": 573318666,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1770824002
    },
    {
        "content": "<p>That sounds like a good idea. Feel free to make a PR!</p>",
        "id": 573319517,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1770824231
    },
    {
        "content": "<p><code>#find_home</code> is another such command, and perhaps also <code>#simp</code>, <code>#check</code> and <code>#help</code>.</p>",
        "id": 573319671,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1770824268
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35143\">#35143</a> fixes <code>#min_imports</code> and others, and adds a test</p>",
        "id": 573358540,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1770833956
    },
    {
        "content": "<p>The PR is awaiting review btw</p>",
        "id": 573930719,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771108586
    },
    {
        "content": "<p>Given <code>#help</code> is currently broken, maybe remove that from this PR? No point writing wrong tests for it.</p>",
        "id": 573943448,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771125049
    },
    {
        "content": "<p>It's not supposed to test the functionality of <code>#help</code>, only that it's registered as a command.<br>\nAlso <code>#help</code> was fixed in Batteries, though I'm not sure how often Mathlib updates Batteries.<br>\nIf the tests get merged first then the PR that updates Batteries can fix the <code>#guard_msgs</code> to the new (working) output.</p>",
        "id": 573944371,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771126302
    },
    {
        "content": "<p><code>#find_syntax</code> was also broken and fixed btw (edit: I thought it was already merged, not yet)</p>",
        "id": 573944390,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771126324
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"933054\">Snir Broshi</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.23lint.20is.20broken/near/573944371\">said</a>:</p>\n<blockquote>\n<p>I'm not sure how often Mathlib updates Batteries.</p>\n</blockquote>\n<p>The <a href=\"https://github.com/leanprover-community/mathlib4/actions/workflows/update_dependencies.yml\">update mathlib dependencies</a> workflow runs <code>lake update</code>, opens a PR if there are any changes ,and posts results in these threads:</p>\n<ul>\n<li><a href=\"#narrow/channel/428973-nightly-testing/topic/Mathlib.20.60lake.20update.60.20success\">#nightly-testing &gt; Mathlib &#96;lake update&#96; success</a> </li>\n<li><a href=\"#narrow/channel/428973-nightly-testing/topic/Mathlib.20.60lake.20update.60.20failure\">#nightly-testing &gt; Mathlib &#96;lake update&#96; failure</a></li>\n</ul>",
        "id": 573946187,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1771128594
    },
    {
        "content": "<p>Apparently it happened right now (<a href=\"https://github.com/leanprover-community/mathlib4/pull/35330\">#35330</a>), did you trigger it? Thanks :)</p>",
        "id": 573946464,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771129066
    },
    {
        "content": "<p>Oh I see you did merge it</p>",
        "id": 573946509,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771129133
    },
    {
        "content": "<p>Isn't what you sent only for nightly testing? Or is the channel name just misleading?</p>",
        "id": 573946593,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771129285
    },
    {
        "content": "<p>The latter, there are actually a bunch of random bot-driven threads in the nightly testing channel which aren't related to nightly testing at all.</p>",
        "id": 573946676,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1771129453
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.23lint.20is.20broken/near/573943448\">said</a>:</p>\n<blockquote>\n<p>Given <code>#help</code> is currently broken, maybe remove that from this PR? No point writing wrong tests for it.</p>\n</blockquote>\n<p>Update: The fixes for both <code>#help</code> and <code>#find_syntax</code> were merged, so now the PR doesn't have tests with the wrong output anymore</p>",
        "id": 574150584,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771260497
    }
]