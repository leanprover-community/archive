[
    {
        "content": "<p>As a experiment, I tried to made <code>assert_not_exists OrderedSemiring</code> succeed in <code>RingTheory.Kaehler.Basic</code> in <a href=\"https://github.com/leanprover-community/mathlib4/tree/mrb%2Fworking\">branch#mrb/working</a>. (Note: it is far from building all of mathlib and there are many <code>sorry</code>'s) </p>\n<p>The intent was to spot check the impact on performance from not having the projections from ordered algebra classes on typeclass synthesis.</p>\n<p>Here its profile output </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cumulative<span class=\"w\"> </span>profiling<span class=\"w\"> </span>times:\n<span class=\"w\">    </span>attribute<span class=\"w\"> </span>application<span class=\"w\"> </span><span class=\"m\">12</span>.2ms\n<span class=\"w\">    </span>compilation<span class=\"w\"> </span><span class=\"m\">59</span>.6ms\n<span class=\"w\">    </span>dsimp<span class=\"w\"> </span>122ms\n<span class=\"w\">    </span>elaboration<span class=\"w\"> </span>859ms\n<span class=\"w\">    </span>import<span class=\"w\"> </span>380ms\n<span class=\"w\">    </span>initialization<span class=\"w\"> </span>16ms\n<span class=\"w\">    </span>interpretation<span class=\"w\"> </span><span class=\"m\">2</span>.8s\n<span class=\"w\">    </span>linting<span class=\"w\"> </span>100ms\n<span class=\"w\">    </span>parsing<span class=\"w\"> </span><span class=\"m\">23</span>.2ms\n<span class=\"w\">    </span>simp<span class=\"w\"> </span><span class=\"m\">2</span>.41s\n<span class=\"w\">    </span>tactic<span class=\"w\"> </span>execution<span class=\"w\"> </span><span class=\"m\">2</span>.32s\n<span class=\"w\">    </span><span class=\"nb\">type</span><span class=\"w\"> </span>checking<span class=\"w\"> </span><span class=\"m\">2</span>.15s\n<span class=\"w\">    </span>typeclass<span class=\"w\"> </span>inference<span class=\"w\"> </span>15s\n<span class=\"w\">    </span>Command<span class=\"w\"> </span>being<span class=\"w\"> </span>timed:<span class=\"w\"> </span><span class=\"s2\">\"lake env lean --profile Mathlib/RingTheory/Kaehler/Basic.lean\"</span>\n<span class=\"w\">    </span>User<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">25</span>.95\n<span class=\"w\">    </span>System<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>.43\n<span class=\"w\">    </span>Percent<span class=\"w\"> </span>of<span class=\"w\"> </span>CPU<span class=\"w\"> </span>this<span class=\"w\"> </span>job<span class=\"w\"> </span>got:<span class=\"w\"> </span><span class=\"m\">99</span>%\n<span class=\"w\">    </span>Elapsed<span class=\"w\"> </span><span class=\"o\">(</span>wall<span class=\"w\"> </span>clock<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>h:mm:ss<span class=\"w\"> </span>or<span class=\"w\"> </span>m:ss<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>:26.45\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>shared<span class=\"w\"> </span>text<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>unshared<span class=\"w\"> </span>data<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>stack<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>total<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Maximum<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">1104592</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Major<span class=\"w\"> </span><span class=\"o\">(</span>requiring<span class=\"w\"> </span>I/O<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">110</span>\n<span class=\"w\">    </span>Minor<span class=\"w\"> </span><span class=\"o\">(</span>reclaiming<span class=\"w\"> </span>a<span class=\"w\"> </span>frame<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">221275</span>\n<span class=\"w\">    </span>Voluntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">25</span>\n<span class=\"w\">    </span>Involuntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">2144</span>\n<span class=\"w\">    </span>Swaps:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>inputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>outputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>sent:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>received:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Signals<span class=\"w\"> </span>delivered:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Page<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">16384</span>\n<span class=\"w\">    </span>Exit<span class=\"w\"> </span>status:<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<p>vs current master </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cumulative<span class=\"w\"> </span>profiling<span class=\"w\"> </span>times:\n<span class=\"w\">    </span>attribute<span class=\"w\"> </span>application<span class=\"w\"> </span><span class=\"m\">12</span>.9ms\n<span class=\"w\">    </span>compilation<span class=\"w\"> </span><span class=\"m\">60</span>.3ms\n<span class=\"w\">    </span>dsimp<span class=\"w\"> </span>128ms\n<span class=\"w\">    </span>elaboration<span class=\"w\"> </span>888ms\n<span class=\"w\">    </span>import<span class=\"w\"> </span>498ms\n<span class=\"w\">    </span>initialization<span class=\"w\"> </span>16ms\n<span class=\"w\">    </span>interpretation<span class=\"w\"> </span><span class=\"m\">3</span>.14s\n<span class=\"w\">    </span>linting<span class=\"w\"> </span>105ms\n<span class=\"w\">    </span>norm_num<span class=\"w\"> </span><span class=\"m\">0</span>.653ms\n<span class=\"w\">    </span>parsing<span class=\"w\"> </span><span class=\"m\">23</span>.4ms\n<span class=\"w\">    </span>simp<span class=\"w\"> </span><span class=\"m\">2</span>.59s\n<span class=\"w\">    </span>tactic<span class=\"w\"> </span>execution<span class=\"w\"> </span><span class=\"m\">2</span>.39s\n<span class=\"w\">    </span><span class=\"nb\">type</span><span class=\"w\"> </span>checking<span class=\"w\"> </span><span class=\"m\">2</span>.23s\n<span class=\"w\">    </span>typeclass<span class=\"w\"> </span>inference<span class=\"w\"> </span>20s\n<span class=\"w\">    </span>Command<span class=\"w\"> </span>being<span class=\"w\"> </span>timed:<span class=\"w\"> </span><span class=\"s2\">\"lake env lean --profile Mathlib/RingTheory/Kaehler/Basic.lean\"</span>\n<span class=\"w\">    </span>User<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">31</span>.47\n<span class=\"w\">    </span>System<span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>seconds<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>.60\n<span class=\"w\">    </span>Percent<span class=\"w\"> </span>of<span class=\"w\"> </span>CPU<span class=\"w\"> </span>this<span class=\"w\"> </span>job<span class=\"w\"> </span>got:<span class=\"w\"> </span><span class=\"m\">99</span>%\n<span class=\"w\">    </span>Elapsed<span class=\"w\"> </span><span class=\"o\">(</span>wall<span class=\"w\"> </span>clock<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"nb\">time</span><span class=\"w\"> </span><span class=\"o\">(</span>h:mm:ss<span class=\"w\"> </span>or<span class=\"w\"> </span>m:ss<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>:32.26\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>shared<span class=\"w\"> </span>text<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>unshared<span class=\"w\"> </span>data<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>stack<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>total<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Maximum<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">1348592</span>\n<span class=\"w\">    </span>Average<span class=\"w\"> </span>resident<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>kbytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Major<span class=\"w\"> </span><span class=\"o\">(</span>requiring<span class=\"w\"> </span>I/O<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">602</span>\n<span class=\"w\">    </span>Minor<span class=\"w\"> </span><span class=\"o\">(</span>reclaiming<span class=\"w\"> </span>a<span class=\"w\"> </span>frame<span class=\"o\">)</span><span class=\"w\"> </span>page<span class=\"w\"> </span>faults:<span class=\"w\"> </span><span class=\"m\">247703</span>\n<span class=\"w\">    </span>Voluntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">131</span>\n<span class=\"w\">    </span>Involuntary<span class=\"w\"> </span>context<span class=\"w\"> </span>switches:<span class=\"w\"> </span><span class=\"m\">3941</span>\n<span class=\"w\">    </span>Swaps:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>inputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>File<span class=\"w\"> </span>system<span class=\"w\"> </span>outputs:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>sent:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Socket<span class=\"w\"> </span>messages<span class=\"w\"> </span>received:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Signals<span class=\"w\"> </span>delivered:<span class=\"w\"> </span><span class=\"m\">0</span>\n<span class=\"w\">    </span>Page<span class=\"w\"> </span>size<span class=\"w\"> </span><span class=\"o\">(</span>bytes<span class=\"o\">)</span>:<span class=\"w\"> </span><span class=\"m\">16384</span>\n<span class=\"w\">    </span>Exit<span class=\"w\"> </span>status:<span class=\"w\"> </span><span class=\"m\">0</span>\n</code></pre></div>\n<p>The main difference is 15s in typeclass synthesis vs 20s depending on whether you have ordered algebra floating around.</p>\n<p>Compared other files that had to be rid of ordered algebra to reach here, this on the low end. <code>LinearAlgebra.TensorProduct.RightExactness</code> dropped by about 40%.</p>",
        "id": 447499569,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719499872
    },
    {
        "content": "<p>If you've stared a winding trace of instances synthesis, then you can viscerally appreciate the problem when there are too many projections to, say, <code>Ring</code>, in the context and the file itself doesn't deal with orders or analysis.</p>",
        "id": 447500278,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719500051
    },
    {
        "content": "<p>This problem will only get worse as more complicated classes are built which intertwine algebra with other hierarchies so I want to get a sense of what people think should be done:</p>\n<ol>\n<li>Nothing -- not a great option but often the choice </li>\n<li>Core fix -- I don't know what avoids this without seriously touching instance synthesis which is a no-go currently.</li>\n<li>Carefully refactor to use the import structure to cut down on the instances in scope.</li>\n<li>Manually scope the instances in some way, eg write an attribute that erases the instance and scopes it on declaring. </li>\n<li>Unbundle algebra from everything else. </li>\n</ol>\n<p>Are there other options?</p>",
        "id": 447501605,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719500386
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> is planning on doing a version of 5 at some point.</p>",
        "id": 447501962,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1719500461
    },
    {
        "content": "<p>For ordered algebra, yes</p>",
        "id": 447502035,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719500478
    },
    {
        "content": "<p>The disadvantage of 5 is that you will need a <code>[Ring R]</code> every time you want an <code>OrderedRing</code>.</p>",
        "id": 447502495,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719500605
    },
    {
        "content": "<p>But nothing is hidden from the user as with 4.</p>",
        "id": 447502860,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719500685
    },
    {
        "content": "<p>I tried a version of 4 (for algebra vs. order) in <a href=\"https://github.com/leanprover-community/mathlib4/pull/12778\">#12778</a>.</p>",
        "id": 447503167,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1719500754
    },
    {
        "content": "<p>Hmm. I would expect more benefits than that</p>",
        "id": 447504245,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719500993
    },
    {
        "content": "<p>Yeah, it looks like some things leak through. For example, </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">OrderedRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\">  </span><span class=\"c1\">-- OrderedRing.toRing</span>\n</code></pre></div>\n<p>succeeds in the <code>Kaehler.Basic</code></p>",
        "id": 447504861,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719501159
    },
    {
        "content": "<p>Ok, I started on 5. It is something I can nibble at in between other commitments</p>",
        "id": 447516540,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719504515
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/the.20number.20of.20instances.20is.20too.20dang.20high/near/447516540\">said</a>:</p>\n<blockquote>\n<p>Ok, I started on 5. It is something I can nibble at in between other commitments</p>\n</blockquote>\n<p>I'm sure you're already aware of <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> thoughts and work on this, but let me an issue that I believe is relevant just in case: <a href=\"https://github.com/leanprover-community/mathlib4/issues/11757\">https://github.com/leanprover-community/mathlib4/issues/11757</a></p>",
        "id": 447518116,
        "sender_full_name": "Josha Dekker",
        "timestamp": 1719504971
    },
    {
        "content": "<p>I have gotten to similar conclusion around <a href=\"#narrow/stream/287929-mathlib4/topic/Ways.20to.20speed.20up.20Mathlib/near/435581626\">this message</a><br>\nIt would be great if we could decouple parts of the hierarchy more. It would be great if we can investigate option 4 more. I expect that if we scope all instances used &lt;10 times in Mathlib, that will already result in a noticeable gain.</p>",
        "id": 447545798,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719511670
    },
    {
        "content": "<p>If anyone wants something to do <a href=\"https://github.com/leanprover-community/mathlib4/tree/mrb%2Funbundle_algebra_from_orders\">branch#mrb/unbundle_algebra_from_orders</a></p>",
        "id": 447573337,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719518711
    },
    {
        "content": "<p>Not sure when I will touch it again today</p>",
        "id": 447573400,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719518731
    },
    {
        "content": "<p>I tested my example from 2 months ago again, and it fails 30x faster now. So the combination of <a href=\"https://github.com/leanprover/lean4/pull/3996\">lean4#3996</a>, removing some instances from Mathlib and whatever else we did in the meantime did have a big effect on this.</p>",
        "id": 447589400,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719523497
    },
    {
        "content": "<p>Yes, I have a pretty clear picture of what I want to try. Nothing concrete quite yet, and I won't have time to work on this before another two weeks</p>",
        "id": 447601509,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1719526793
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/the.20number.20of.20instances.20is.20too.20dang.20high/near/447573337\">said</a>:</p>\n<blockquote>\n<p>If anyone wants something to do <a href=\"https://github.com/leanprover-community/mathlib4/tree/mrb%2Funbundle_algebra_from_orders\">branch#mrb/unbundle_algebra_from_orders</a></p>\n</blockquote>\n<p>And I now realize I ran off too quickly and didn't push this at post time... <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 447725120,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719569428
    },
    {
        "content": "<p>This has reached submodules now.</p>",
        "id": 447818660,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719592627
    },
    {
        "content": "<p><a href=\"http://speed.lean-fro.org/mathlib4/compare/a966328b-3d4a-404d-98a7-1b8bf2efe3df/to/344a0242-49e9-41cd-8fdc-aafe5fa0aeb3\">Results</a> </p>\n<p>Headline: only ~2% decrease in total instructions . Observations:</p>\n<ul>\n<li>it is fairly straightforward except for the few cases where we built algebra data using ordered info, eg <code>Nonneg</code> types. </li>\n<li>writing the algebraic instances always is not terrible is pretty annoying (looking at <code>Valuation.Basic</code>)</li>\n<li>the <code>simp</code> lemmas proving algebraic statements using ordered info are still in scope and drag down performance</li>\n<li>some files really win, eg <code>Algebra.Star.NonUnitalSubalgebra</code> </li>\n<li>some  namespaces are kinda chaotic, eg <code>EllipticCurve</code></li>\n</ul>",
        "id": 448388123,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719853421
    },
    {
        "content": "<p><code>-7.632 %</code> on typeclass inference is very good, IMO.</p>",
        "id": 448388876,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1719853594
    },
    {
        "content": "<p>I can make it <a href=\"http://speed.lean-fro.org/mathlib4/compare/a966328b-3d4a-404d-98a7-1b8bf2efe3df/to/915e1b8a-fe7d-4b71-a16e-21e14ce33987\">better</a> with <a href=\"https://github.com/leanprover/lean4/pull/2905\">lean#2905</a> but overall we regress</p>",
        "id": 448389326,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719853702
    },
    {
        "content": "<p>I think the best solution is to comb the import ball of yarn. It is probably the most involved though.</p>",
        "id": 448394393,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719854923
    },
    {
        "content": "<p>In this direction, <a href=\"https://github.com/leanprover-community/mathlib4/pull/14121\">#14121</a> is <code>awaiting-review</code> now</p>",
        "id": 448397853,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719856109
    },
    {
        "content": "<p>Also <a href=\"https://github.com/leanprover-community/mathlib4/pull/14355\">#14355</a></p>",
        "id": 448399588,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719856708
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/TtEpQPfhrHQLUWJ7K7oV7-s3/out.pdf\">Here</a> is the graph from <code>Algebra.Order.Group.Defs</code> to <code>Algebra.Star.NonUnitalSubalgebra</code>.</p>",
        "id": 448400086,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719856857
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14336\">#14336</a> is another easy one avoiding importing <code>Algebra.Order.BigOperators.Ring.Finset</code> in <code>BigOperators.Finsupp</code> to talk about positive natural numbers.</p>",
        "id": 448403270,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719857699
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14338\">#14338</a> just deletes a redundant import. Waiting to see if it is needed downstream.</p>",
        "id": 448405685,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719858403
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/the.20number.20of.20instances.20is.20too.20dang.20high/near/448405685\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14338\">#14338</a> just deletes a redundant import. Waiting to see if it is needed downstream.</p>\n</blockquote>\n<p>Nope. Builds just fine. Clearly <code>easy</code> now</p>",
        "id": 448413215,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719860349
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14341\">#14341</a> avoids ordered algebra in <code>Data.Rat.Lemmas</code>.</p>",
        "id": 448429141,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719864968
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14129\">#14129</a> avoids ordered algebra in <code>Set.Pointwise.Basic</code> by moving one declaration to a new file <code>Set.Pointwise.BoundedMul</code></p>",
        "id": 448445789,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719871327
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/the.20number.20of.20instances.20is.20too.20dang.20high/near/448413215\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/the.20number.20of.20instances.20is.20too.20dang.20high/near/448405685\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14338\">#14338</a> just deletes a redundant import. Waiting to see if it is needed downstream.</p>\n</blockquote>\n<p>Nope. Builds just fine. Clearly <code>easy</code> now</p>\n</blockquote>\n<p>Why isn't <code>shake</code> going nuts about this one?</p>",
        "id": 448450827,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719872690
    },
    {
        "content": "<p>Not sure but rerunning locally it did. Then I had to do a shake hokey-pokey</p>",
        "id": 448451006,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719872773
    },
    {
        "content": "<p>Oh wait. That was another one.</p>",
        "id": 448451053,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719872804
    },
    {
        "content": "<p>I assume pollution of <code>noshake</code></p>",
        "id": 448451071,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719872819
    },
    {
        "content": "<p>The motivation for <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/shake.20hangs.20with.20no.20config.20file\">#mathlib4 &gt; shake hangs with no config file</a></p>",
        "id": 448451166,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719872869
    },
    {
        "content": "<p>what do you mean by pollution?</p>",
        "id": 448451288,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1719872916
    },
    {
        "content": "<p>People just run <code>--update</code> reflexively</p>",
        "id": 448451319,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719872938
    },
    {
        "content": "<p>Here is a question: how many <code>import Mathlib.Logic.Function.Iterate</code> can be straight deleted?</p>",
        "id": 448451502,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719873022
    },
    {
        "content": "<p>Is there something about <code>Mathlib.Logic.Function.Iterate</code> that foils shake? Some spot checks suggest that it can indeed be deleted in some cases but it's not noshaken</p>",
        "id": 448455303,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1719874700
    },
    {
        "content": "<p>Oh, I assumed it was noshaken</p>",
        "id": 448455347,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719874730
    },
    {
        "content": "<p>most likely it's transitively imported by sibling imports in many files</p>",
        "id": 448455628,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1719874855
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14122\">#14122</a> moves ordered algebra instances on products to a separate file</p>",
        "id": 448456065,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719875042
    },
    {
        "content": "<p>I know it's been said before but that declarations diff thing is an absolute godsend.</p>",
        "id": 448456141,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1719875085
    },
    {
        "content": "<p>Yes, that is very nice</p>",
        "id": 448456158,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719875096
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/the.20number.20of.20instances.20is.20too.20dang.20high/near/448399588\">said</a>:</p>\n<blockquote>\n<p>Also <a href=\"https://github.com/leanprover-community/mathlib4/pull/14355\">#14355</a></p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> I think this was a typo, I can't find it.</p>",
        "id": 448461223,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719877318
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14335\">#14335</a> ?</p>",
        "id": 448461834,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719877629
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14351\">#14351</a> avoids bundled ordered algebra in unbundled ordered algebra</p>",
        "id": 448572929,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719917170
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14371\">#14371</a> splits <code>Data.Nat.Cast.Order</code> into files depending on unbundled ordered algebra and bundled ordered algebra. </p>\n<p>Following up from that <a href=\"https://github.com/leanprover-community/mathlib4/pull/14370\">#14370</a> splits <code>Algebra.Order.Nonneg.Ring</code> similarly. </p>\n<p>The next step is <code>NNRat.Defs</code>.</p>",
        "id": 448716482,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1719960550
    },
    {
        "content": "<p>Could you also have a look at <a href=\"https://github.com/leanprover-community/mathlib4/pull/14357\">#14357</a>?</p>",
        "id": 448783467,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1719993883
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14380\">#14380</a> splits <code>Algebra.Order.Group.Defs</code> moving the unbundled results to <code>Algebra.Order.Group.Unbundled.Basic</code></p>",
        "id": 448836912,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720010106
    },
    {
        "content": "<p>Some <a href=\"http://speed.lean-fro.org/mathlib4/compare/2983abee-d37f-4773-ace1-4f30c7ff1087/to/24535d7d-53cd-4da2-9b07-3975d6bb3b16\">results</a> coming from minimizing imports. </p>\n<p>The goal was to cleave <code>Algebra.Star.NonUnitalSubalgebra</code> from <code>OrderedCommMonoid</code>. The benefits are the same as unbundling the algebra from bundled ordered algebra hierarchy.</p>",
        "id": 450461575,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720620264
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/wnqOkhhFuDD1UhEYQWg3xrZu/out.pdf\">Behold</a> the graph from bundled ordered rings to <code>Module.PID</code></p>",
        "id": 450464254,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720620950
    },
    {
        "content": "<p>We need sober spaces to talk about modules over a PID? :-)</p>",
        "id": 450495567,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720627327
    },
    {
        "content": "<p>Exactly how I was taught it in Algebra I</p>",
        "id": 450514141,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720632070
    },
    {
        "content": "<p>Algebraic geometry in my PIDs? <span aria-label=\"face with raised eyebrow\" class=\"emoji emoji-1f928\" role=\"img\" title=\"face with raised eyebrow\">:face_with_raised_eyebrow:</span></p>",
        "id": 450537740,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720638327
    },
    {
        "content": "<p>One thing you don't see compared to the unbundling is the increase in linting though. We are fairly flat for instructions.</p>",
        "id": 450550251,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720641360
    },
    {
        "content": "<p>Two main things are cause for the tangles:</p>\n<ol>\n<li>At the bottom of the ordered algebra stuff, it is quite common to have a single file with unbundled classes/results and bundled classes/results together. This means when you want something basic to glue together <code>mul</code> and <code>&lt;</code>, for example, then the full bundled machinery comes for a ride. </li>\n<li>There is tendency to put very small sections in <code>Basic</code> files where you prove your thing is <code>LinearOrderedField</code> under assumptions that make you import things you don't otherwise need for <code>Basic</code>.</li>\n</ol>",
        "id": 450551133,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720641630
    },
    {
        "content": "<p>If you don't want modules over a PID to require <code>Mathlib.Topology.Basic</code> <a href=\"https://github.com/leanprover-community/mathlib4/pull/14631\">#14631</a></p>",
        "id": 450572368,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720647915
    },
    {
        "content": "<p>I am still on this kick with PRs that should be pretty uncontroversial: <a href=\"https://github.com/leanprover-community/mathlib4/pull/15071\">#15071</a>, <a href=\"https://github.com/leanprover-community/mathlib4/pull/15072\">#15072</a>, and <a href=\"https://github.com/leanprover-community/mathlib4/pull/15152\">#15152</a></p>",
        "id": 462777082,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723811635
    }
]