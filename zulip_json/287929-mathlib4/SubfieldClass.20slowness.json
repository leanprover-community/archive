[
    {
        "content": "<p>While trying to unbundle normed structure, I have encountered a performance issue which is blocking my progress. This shows up also on current mathlib, with the following mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">MyFoo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">ofSubfieldClass</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SubfieldClass</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyFoo</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">soSlow</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyFoo</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p><code>soSlow</code> fails, of course, because there is no instance for it, but it makes several seconds to do so. I don't really see why, because <code>ofSubfieldClass</code> should not apply: there is no <code>SubfieldClass</code> around, so the assumptions of the instance are not satisfied. Still, Lean goes on trying to see if some weird things are defeq (the culprit being that we have rings, semirings, several possible paths, and with the path taken here things are not obviously defeq of not obviously non-defeq if I understand correctly). Any idea?</p>",
        "id": 538173362,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1757323313
    },
    {
        "content": "<p>I tried playing around with the definitions and <code>set_synth_order</code> (see code below), without much success. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SubfieldClass.toField#doc\">docs#SubfieldClass.toField</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subringclass.toRing#doc\">docs#Subringclass.toRing</a> both have the <code>fast_instance%</code> elaborator on there, which I thought would prevent this kind of slow structure defeq...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span>\n\n<span class=\"sd\">/-- Specify the synthesization order for instances. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Instances</span><span class=\"bp\">.</span><span class=\"n\">setSynthOrder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">synthOrder</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">instanceExtension</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">instanceNames</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"'{declName}' does not have [instance] attribute\"</span>\n<span class=\"w\">  </span><span class=\"n\">instanceExtension</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">synthOrder</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"bp\">.</span><span class=\"n\">attrKind</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"sd\">/-- Specify the synthesization order for instances. -/</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"set_synth_order \"</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">synthOrder</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">MatchExpr</span><span class=\"bp\">.</span><span class=\"n\">toDoubleQuotedName</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"n\">Instances</span><span class=\"bp\">.</span><span class=\"n\">setSynthOrder</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">synthOrder</span><span class=\"o\">))]</span>\n</code></pre></div>",
        "id": 538198009,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1757330662
    },
    {
        "content": "<p>Probably everyone reading is well aware of this, but one achilles heel of mathlib does seem to be typeclass inference on subtypes. We had a huge slowdown with rings of integers when they were defined as <code>Subring</code>s but everyone was using them as types; when we changed the definition to be a type directly, things got much better. From mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The ring of integers (or number ring) corresponding to a number field</span>\n<span class=\"sd\">is the integral closure of â„¤ in the number field.</span>\n\n<span class=\"sd\">This is defined as its own type, rather than a `Subalgebra`, for performance reasons:</span>\n<span class=\"sd\">looking for instances of the form `SMul (RingOfIntegers _) (RingOfIntegers _)` makes</span>\n<span class=\"sd\">much more effective use of the discrimination tree than instances of the form</span>\n<span class=\"sd\">`SMul (Subtype _) (Subtype _)`.</span>\n<span class=\"sd\">The drawback is we have to copy over instances manually.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">RingOfIntegers</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">integralClosure</span><span class=\"w\"> </span><span class=\"n\">â„¤</span><span class=\"w\"> </span><span class=\"n\">K</span>\n</code></pre></div>\n<p>The type of <code>integralClosure</code> is <code>Subalgebra R A</code> but the trick of making it into a type means that typeclass inference never sees that it's a subtype and this solved a lot of timeout problems in this corner of mathlib. The general issue was that there are many instances in Mathlib of the form <code>Foo S -&gt; Foo (t : Subthing S)</code> but for integer rings it would often be the case that something would be true for the integers but not the field it was the integers of (e.g. searching for actions of the integers on something would suddenly start searching for actions of the full field on the thing, where the action didn't extend).</p>",
        "id": 538199537,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757331148
    },
    {
        "content": "<p>The chaos starts at</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>                    [isDefEq] [0.840193] âŒï¸ MyFoo â†¥S =?= MyFoo â†¥?m.16 â–¼\n                      [] [0.840046] âŒï¸ S.toRing =?= (SubfieldClass.toField (Subalgebra ğ•œ A) S).toDivisionRing.toRing â–¼\n                        [] [0.839921] âŒï¸ S.toSubring.toRing =?= (SubfieldClass.toField (Subalgebra ğ•œ A) S).toDivisionRing.toRing â–¼\n                          [] [0.839877] âŒï¸ SubringClass.toRing S.toSubring =?= (SubfieldClass.toField (Subalgebra ğ•œ A) S).toDivisionRing.toRing â–¼\n                            [] [0.839840] âŒï¸ SubringClass.toRing S.toSubring =?= SubringClass.toRing S â–¶\n</code></pre></div>\n<p>You can kind of see why typeclass inference is confused. The second <code>=?=</code> in the above snippet, namely <code>S.toRing =?= (SubfieldClass.toField (Subalgebra ğ•œ A) S).toDivisionRing.toRing</code>, is a term with holes on the RHS such as <code>?m.13 : Field A</code>, so the RHS term cannot ever be made metavariable-free and no doubt typeclass inference would fail quickly if asked to fill in this hole. However typeclass inference decides not to worry about this for now, and instead try and figure out <code>SubringClass.toRing S.toSubring =?= SubringClass.toRing S</code> (the last <code>=?=</code> in the snippet, now with no explicit mention of <code>A</code>). This is the sort of typeclass problem that is usually solved very quickly, but unfortunately the RHS now has a <code>Field.toCommRing.toRing</code> term in it still containing this <code>Field A</code> metavariable, which presumably typeclass inference has now got down as \"deal with later, let's  first check that the multiplications and the zsmuls etc etc agree. Unfold, unfold, unfold, and then finally</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>           [] [0.016315] âŒï¸ n â€¢ x =?= n â€¢ x â–¼\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000005] âŒï¸ Field A â–¶\n             [synthInstance] [0.000005] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [synthInstance] [0.000004] âŒï¸ Field A â–¶\n             [synthInstance] [0.000003] âŒï¸ Field A â–¶\n             [] 155 more entries... â–¶\n</code></pre></div>\n<p>Oops!</p>",
        "id": 538206277,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757333012
    },
    {
        "content": "<p>In total, typeclass inference tries to solve <code>Field A</code> over 1000 times in Sebastien's code, always failing very quickly (at least after the first time), the problem is perhaps that it's postponing asking this question until it has wasted far too much time unfolding the two <code>Ring S</code> instances (the actual time sink), one genuine and one with this unfillable <code>Field A</code> metavariable.</p>",
        "id": 538208604,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757333642
    },
    {
        "content": "<p>It's a shame that this happens:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.880830</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span>\n<span class=\"w\">              </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">          </span><span class=\"o\">[</span><span class=\"n\">delta</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020898</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span>\n<span class=\"w\">                </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">            </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020664</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">ZeroMemClass</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">toSubring</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">ZeroMemClass</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020574</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">â‹¯âŸ©</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">â‹¯âŸ©</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">                </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020536</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">â‹¯âŸ©</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">â‹¯âŸ©</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">                  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020487</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">                    </span><span class=\"o\">[</span><span class=\"n\">delta</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020427</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">                      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020395</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"bp\">.</span><span class=\"n\">toOfNat0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"bp\">.</span><span class=\"n\">toOfNat0</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">                        </span><span class=\"o\">[</span><span class=\"n\">delta</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.011125</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"bp\">.</span><span class=\"n\">toOfNat0</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"bp\">.</span><span class=\"n\">toOfNat0</span><span class=\"w\"> </span><span class=\"bp\">â–¶</span>\n<span class=\"w\">                        </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000006</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">â–¶</span>\n<span class=\"w\">              </span><span class=\"o\">[</span><span class=\"n\">repeat</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"o\">]</span>\n<span class=\"w\">                        </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000006</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">â–¶</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.859734</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroup</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯;</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src_1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addMonoidWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯;</span>\n<span class=\"w\">              </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">intCast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toNatCast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src_1</span><span class=\"bp\">.</span><span class=\"n\">toNatCast</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toOne</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src_1</span><span class=\"bp\">.</span><span class=\"n\">toOne</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">natCast_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">natCast_succ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toNeg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">toNeg</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toSub</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">toSub</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">sub_eq_add_neg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zsmul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">zsmul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zsmul_zero'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">zsmul_succ'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zsmul_neg'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">neg_add_cancel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">intCast_ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">intCast_negSucc</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                  </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">                </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroup</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯;</span>\n<span class=\"w\">              </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src_1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addMonoidWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯;</span>\n<span class=\"w\">              </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">intCast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toNatCast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src_1</span><span class=\"bp\">.</span><span class=\"n\">toNatCast</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toOne</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src_1</span><span class=\"bp\">.</span><span class=\"n\">toOne</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">natCast_zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">natCast_succ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toNeg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">toNeg</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toSub</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">__</span><span class=\"n\">src</span><span class=\"bp\">.</span><span class=\"n\">toSub</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">sub_eq_add_neg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zsmul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">zsmul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zsmul_zero'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">zsmul_succ'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zsmul_neg'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">neg_add_cancel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">intCast_ofNat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"o\">,</span>\n<span class=\"w\">                </span><span class=\"n\">intCast_negSucc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">â–¶</span>\n</code></pre></div>\n<p>My understanding of this is that it says: \"Let's try and prove that two <code>AddGroupWithOne</code> structures on <code>â†¥S</code> are defeq, one of which has a (unfillable) hole (?m.13 : Field A). Well, if they're equal, then they'd better have the same zero! Let's unfold a very small amount. Oh wait a minute, the very existence of the zero on the RHS relies on the fact that A is a field! Is it? No! OK so that didn't work, let's go back to the beginning of figuring out if these <code>AddGroupWithOne</code>'s are equal, unfold one more step making matters much worse, and then start all over again.\" The zero failure calculation takes just 0.02 seconds on my machine but unfortunately this is not enough to get Lean to bail, and we ask many more (some much more complex) questions of this nature before finally giving up.</p>",
        "id": 538211868,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757334516
    },
    {
        "content": "<p>Do you remember <a href=\"https://github.com/leanprover-community/blog/pull/86\">blog#86</a> ? I would like to finish it and publish it eventually. Please let me know if some of my past insights are now outdated or if you discover new ones!</p>",
        "id": 538214470,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1757335174
    },
    {
        "content": "<p>To me, there are two issues here. The first is that the defeq checking is slow. But the second is that we should never get to this defeq: the instance it's trying to apply has assumptions <code>{S F : Type*} [SetLike S F] [Field F] [SubfieldClass S F]</code>. The <code>SetLike</code> one is satisfied in our context, for <code>Subalgebra ğ•œ A</code>, the <code>Field</code> one is satisfied by <code>ğ•œ</code>, but the <code>SubfieldClass S F</code> is not. If Lean tried to synthetize this instance, it would bail out right away, instead of trying to solve an undefined defeq problem (undefined because there's a metavariable in it, which would be coming from the <code>SubfieldClass S F</code> it it could solve it). I know the order in instance synthesis is something of a dark magical art, but here Lean is doing something really weird.</p>",
        "id": 538223745,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1757337380
    },
    {
        "content": "<p>I think there's a minor typo in the above -- it's <code>Field A</code> not <code>Field \\k</code> (so this should also fail), but your point remains.</p>",
        "id": 538225240,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757337743
    },
    {
        "content": "<p>You're right, it's <code>Field A</code>. Which is not even true, so it should stop one step earlier than what I wrote!</p>",
        "id": 538226924,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1757338147
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/SubfieldClass.20slowness/near/538211868\">said</a>:</p>\n<blockquote>\n<p>It's a shame that this happens:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.880830</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span>\n<span class=\"w\">              </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">          </span><span class=\"o\">[</span><span class=\"n\">delta</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.020898</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">âŒï¸</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span>\n<span class=\"w\">                </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â‹¯</span><span class=\"w\"> </span><span class=\"bp\">â–¼</span>\n<span class=\"w\">            </span><span class=\"bp\">...</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p><code>Function.Injective.addGroupWithOne</code> should almost never appear in traces; if it does a <code>fast_instance%</code> is missing</p>",
        "id": 538227532,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757338287
    },
    {
        "content": "<p>I'm afraid I have no idea what <code>fast_instance%</code> is, but (looking at where things start to go wrong) <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.toRing#doc\">docs#Subalgebra.toRing</a> doesn't have it and the (unrelated to this problem, but similar-looking to my naive eyes) <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subfield.toDivisionRing#doc\">docs#Subfield.toDivisionRing</a> does, so at least that looks to me like an inconsistency.</p>",
        "id": 538238019,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757340873
    },
    {
        "content": "<p>I have some spare CPU cycles right now (I'm about to spend 2 hours reading email) so can try adding <code>fast_instance%</code> to <code>Subalgebra.toRing</code> and recompiling mathlib to see if this helps, even though I'm happy to admit that I don't really know what I'm doing.</p>",
        "id": 538238969,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757341120
    },
    {
        "content": "<p>Thanks to whoever wrote <code>#min_imports</code>, that was quick! It's still slow but the trace has changed.</p>",
        "id": 538241866,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757341796
    },
    {
        "content": "<p>What's the new trace?</p>",
        "id": 538242154,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757341876
    },
    {
        "content": "<p>Sorry, I'm lying :-( I had misremembered, we're still faced with exactly the same problem. I'm assuming that <code>Field.toDivisionRing</code> shouldn't be a <code>fast_instance%</code> -- <code>Field</code> extends <code>DivisionRing</code>.</p>",
        "id": 538242724,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757342009
    },
    {
        "content": "<p>Here's the trace including the bad life choices right down to the suspicious <code>Function.Injective</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code> [Meta.synthInstance] [0.858099] ğŸ’¥ï¸ MyFoo â†¥S â–¼\n   [] [0.000014] new goal MyFoo â†¥S â–¶\n   [] [0.858069] âŒï¸ apply @ofSubfieldClass to MyFoo â†¥S â–¼\n     [tryResolve] [0.858054] âŒï¸ MyFoo â†¥S â‰Ÿ MyFoo â†¥?m.16 â–¼\n       [isDefEq] [0.858051] âŒï¸ MyFoo â†¥S =?= MyFoo â†¥?m.16 â–¼\n         [] [0.857903] âŒï¸ S.toRing =?= (SubfieldClass.toField (Subalgebra ğ•œ A) S).toDivisionRing.toRing â–¼\n           [] [0.857774] âŒï¸ S.toSubring.toRing =?= (SubfieldClass.toField (Subalgebra ğ•œ A) S).toDivisionRing.toRing â–¼\n             [] [0.857722] âŒï¸ SubringClass.toRing S.toSubring =?= (SubfieldClass.toField (Subalgebra ğ•œ A) S).toDivisionRing.toRing â–¼\n               [] [0.857670] âŒï¸ SubringClass.toRing S.toSubring =?= SubringClass.toRing S â–¼\n                 [] [0.857507] âŒï¸ { toSemiring := SubsemiringClass.toSemiring S.toSubring, toNeg := NegMemClass.neg,\n                       toSub := AddSubgroupClass.sub, sub_eq_add_neg := â‹¯, zsmul := AddGroupWithOne.zsmul,\n                       zsmul_zero' := â‹¯, zsmul_succ' := â‹¯, zsmul_neg' := â‹¯, neg_add_cancel := â‹¯,\n                       toIntCast := SubringClass.toHasIntCast S.toSubring, intCast_ofNat := â‹¯,\n                       intCast_negSucc :=\n                         â‹¯ } =?= { toSemiring := SubsemiringClass.toSemiring S, toNeg := NegMemClass.neg,\n                       toSub := AddSubgroupClass.sub, sub_eq_add_neg := â‹¯, zsmul := AddGroupWithOne.zsmul,\n                       zsmul_zero' := â‹¯, zsmul_succ' := â‹¯, zsmul_neg' := â‹¯, neg_add_cancel := â‹¯,\n                       toIntCast := SubringClass.toHasIntCast S, intCast_ofNat := â‹¯, intCast_negSucc := â‹¯ } â–¼\n                   [] [0.857124] âŒï¸ AddGroupWithOne.zsmul =?= AddGroupWithOne.zsmul â–¼\n                     [delta] [0.857015] âŒï¸ AddGroupWithOne.zsmul =?= AddGroupWithOne.zsmul â–¼\n                       [] [0.856608] âŒï¸ Function.Injective.addGroupWithOne Subtype.val â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯\n                             â‹¯ =?= Function.Injective.addGroupWithOne Subtype.val â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â‹¯ â–¶\n</code></pre></div>",
        "id": 538243314,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757342139
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SubsemiringClass.toSemiring#src\">src#SubsemiringClass.toSemiring</a> is missing a <code>fast_instance%</code> too</p>",
        "id": 538243567,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757342194
    },
    {
        "content": "<p>(as are most of the <code>Subtype.val_injective.foo</code>s in that file)</p>",
        "id": 538244035,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757342300
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/SubfieldClass.20slowness/near/538243567\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SubsemiringClass.toSemiring#src\">src#SubsemiringClass.toSemiring</a> is missing a <code>fast_instance%</code> too</p>\n</blockquote>\n<p>Not on master? <a href=\"https://github.com/leanprover-community/mathlib4/blob/582a39f64a00646d46ec665298a21080835e230f/Mathlib/Algebra/Ring/Subsemiring/Defs.lean#L101-L105\">https://github.com/leanprover-community/mathlib4/blob/582a39f64a00646d46ec665298a21080835e230f/Mathlib/Algebra/Ring/Subsemiring/Defs.lean#L101-L105</a></p>",
        "id": 538244130,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757342322
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/SubfieldClass.20slowness/near/538244035\">said</a>:</p>\n<blockquote>\n<p>(as are most of the <code>Subtype.val_injective.foo</code>s in that file)</p>\n</blockquote>\n<p>If you're talking about <code>Mathlib.Algebra.Ring.Subsemiring.Defs</code> I can't find a single missing <code>fast_instance%</code> in that file.</p>",
        "id": 538244971,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757342538
    },
    {
        "content": "<p>Ugh, I'm blind and missed it at the end of the line</p>",
        "id": 538253030,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757344486
    },
    {
        "content": "<p>Ah, I think this was why I dilly-dallied on merging the elaborator. I wanted it to check that an argument was a projection from a class instance that itself could be normalized by <code>fast_instance%</code>.</p>",
        "id": 538308139,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1757362630
    },
    {
        "content": "<p>Investigating further, it looks to me that this is an issue with <code>fast_instance%</code> that these <code>Function.injective</code> show up. Just before the instance <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SubringClass.toRing#doc\">docs#SubringClass.toRing</a>, an element of a subring class has a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Z</mi></mrow><annotation encoding=\"application/x-tex\">\\Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">Z</span></span></span></span>-action given by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddSubgroupClass.zsmul#doc\">docs#AddSubgroupClass.zsmul</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"n\">â„¤</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"c1\">-- AddSubgroupClass.zsmul</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">AddSubgroupClass</span><span class=\"bp\">.</span><span class=\"n\">zsmul</span><span class=\"w\"> </span><span class=\"c1\">-- smul := fun n a â†¦ âŸ¨n â€¢ â†‘a, â‹¯âŸ©</span>\n</code></pre></div>\n<p>So, a nice definition without any <code>Function.injective</code>. Then, we define</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- A subring of a ring inherits a ring structure -/</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">75</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">SubringClass</span><span class=\"bp\">.</span><span class=\"n\">toRing</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fast_instance</span><span class=\"bp\">%</span>\n<span class=\"w\">  </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">coe_injective</span><span class=\"bp\">.</span><span class=\"n\">ring</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>With <code>#print SubringClass.toRing</code>, you can see the field <code>zsmul</code> inside the structure, and it's given by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">AddGroupWithOne</span><span class=\"bp\">.</span><span class=\"n\">zsmul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">â†¥</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"bp\">.</span><span class=\"n\">addGroupWithOne</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This looks very weird to me because the <code>Subtype.coe_injective</code> constructors are supposed to take all the existing data instances and add proof fields. I definitely don't understand what is going on here, and I don't have the knowledge to open up <code>fast_instance%</code> further...</p>",
        "id": 538453255,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1757428455
    },
    {
        "content": "<p>I suspect the issue is that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddGroupWithOne.zsmul#doc\">docs#AddGroupWithOne.zsmul</a> is not a <code>SMul</code> instance, and so there is no existing instance to populate it with</p>",
        "id": 538456760,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757429374
    },
    {
        "content": "<p>But why should it use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddGroupWithOne.zsmul%3F#doc\">docs#AddGroupWithOne.zsmul?</a> The <code>Subtype.coe_injective.ring</code> function uses in its definition the ambient instance, i.e., <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddSubgroupClass.zsmul#doc\">docs#AddSubgroupClass.zsmul</a>, which is indeed an instance.</p>",
        "id": 538457449,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1757429543
    },
    {
        "content": "<p>The heuristics of <code>fast_instance%</code> are to replace each parent and/or field (I forget which) with instances that can be synthesized</p>",
        "id": 538457669,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757429595
    },
    {
        "content": "<p>This works for <code>toMul</code>, <code>toOne</code> etc, but <code>zsmul</code> doesn't expand to a smaller instance (it's a plain function not an SMul` object) so doesn't participate</p>",
        "id": 538457774,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757429621
    },
    {
        "content": "<p>I think this would be fixed by replacing the field with <code>[toZSMul : SMul Int A]</code>, but this will surely trip up <code>to_additive</code></p>",
        "id": 538458016,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757429692
    },
    {
        "content": "<p>But then why does it work for <code>nsmul</code> in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddSubmonoidClass.toAddMonoid%3F#doc\">docs#AddSubmonoidClass.toAddMonoid?</a> It is defined as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"sd\">/-- An `AddSubmonoid` of an `AddMonoid` inherits an `AddMonoid` structure. -/</span><span class=\"kd\">]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">75</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">toMonoid</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">SubmonoidClass</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fast_instance</span><span class=\"bp\">%</span>\n<span class=\"w\">  </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">coe_injective</span><span class=\"bp\">.</span><span class=\"n\">monoid</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and the <code>nsmul</code> field inside it is <code>nsmul := fun n x â†¦ n â€¢ x</code>. I think I'm just confused :-)</p>",
        "id": 538459873,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1757430190
    },
    {
        "content": "<p>For the former, it is built with a <code>where</code>/spread by supplying the parent classes. For the latter, it is inlined as a field.</p>",
        "id": 538460597,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1757430360
    },
    {
        "content": "<p>Aha. Then it means inlining it as a field should solve the issue in the thread. And indeed it works! If in the definition of <code>Function.Injective.ring</code> I add the explicit field <code> zsmul := fun n x â†¦ n â€¢ x</code>, then the issue at the start of the thread is solved (instead of 4s, the failure takes 0.09s). Thanks to all for your insights!</p>",
        "id": 538465552,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1757431730
    }
]