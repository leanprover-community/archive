[
    {
        "content": "<p>Hi,<br>\nI understand that if I clone mathlib and run <code>lake exe cache get</code> I will download all the library files and won't have to spend a lot of time compiling them. This works fine, but if I start a new project, add a dependency to mathlib and run <code>lake exe cache get</code> then it seems I still need to build mathlib. For instance, if I create a new blank project depending on mathlib with just this in <code>Main.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n</code></pre></div>\n<p>and run <code>lake exe cache get</code> and then <code>lake build</code> it builds all necessary files, instead of downloading them. Am I doing somehting wrong or is it expected?</p>",
        "id": 533885954,
        "sender_full_name": "Tomaz Mascarenhas",
        "timestamp": 1754957177
    },
    {
        "content": "<p>if you're on VSCode you can fetch the imports for just the file you're looking at</p>",
        "id": 533886616,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754957782
    },
    {
        "content": "<p>I see, thanks! But I am building a project that needs to be run through the command line...</p>",
        "id": 533888476,
        "sender_full_name": "Tomaz Mascarenhas",
        "timestamp": 1754959407
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"360938\">Tomaz Mascarenhas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/lake.20exe.20cache.20getting.20from.20another.20project/near/533885954\">said</a>:</p>\n<blockquote>\n<p>Hi,<br>\nI understand that if I clone mathlib and run <code>lake exe cache get</code> I will download all the library files and don't have to spend a lot of time compiling them. This works fine, but if I start a new project, add a dependency to mathlib and run <code>lake exe cache get</code> then it seems I still need to build mathlib. For instance, if I create a new blank project depending on mathlib with just this in <code>Main.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n</code></pre></div>\n<p>and run <code>lake exe cache get</code> and then <code>lake build</code> it builds all necessary files, instead of downloading them. Am I doing somehting wrong or is it expected?</p>\n</blockquote>\n<p>No, something unexpected is happening here. The cache should be sufficient that you don't need to compile the mathlib you depend on</p>",
        "id": 533913112,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1754978638
    },
    {
        "content": "<p>Could you give us a commit of your project to look at, that demonstrates this issue?</p>",
        "id": 533918785,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754981884
    },
    {
        "content": "<p>here: <a href=\"https://github.com/tomaz1502/cache-get-bug\">https://github.com/tomaz1502/cache-get-bug</a><br>\nafter running <code>lake update</code> and <code>lake exe cache get</code>, <code>lake build</code> goes up to 7000 files instantaneously and then starts to compile another 7000 files</p>",
        "id": 533989430,
        "sender_full_name": "Tomaz Mascarenhas",
        "timestamp": 1755007546
    },
    {
        "content": "<p>Because your project produces an executable, Lean builds platform-dependent object files (compiled versions of computable functions you might want to use at runtime) for every Mathlib file. These build steps correspond to lines in the lake log starting with \"Running\" (previously \"Compiling\"), and are currently not cached. There was an earlier thread which mentioned core devs wanted to improve this situation, I will try to find it. </p>\n<p>The platform-independent oleans (corresponding to lines in the log starting with \"Building\") are still reused, so the cache fetched with \"lake exe cache get\" is still useful.</p>",
        "id": 533995996,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1755009467
    },
    {
        "content": "<p>Oh, that makes sense! Thanks!</p>",
        "id": 533996674,
        "sender_full_name": "Tomaz Mascarenhas",
        "timestamp": 1755009714
    },
    {
        "content": "<p>Older relevant threads:<br>\n<a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/error.20building.20windows.20exe.20.20proj/with/439465037\">#mathlib4 &gt; error building windows exe  proj</a> <br>\n<a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/mathlib.20cache.20works.20for.20lean_lib.20but.20not.20for.20lean_exe.3F/with/530192942\">#mathlib4 &gt; mathlib cache works for lean_lib but not for lean_exe?</a></p>",
        "id": 533996906,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1755009785
    }
]