[
    {
        "content": "<p>While trying to make a term of type <code>ℝ →+*o Surreal</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"c1\">-- comes from `OreLocalization.hsmul`, depends on `SMul ℤ ℤ`</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submonoid</span><span class=\"bp\">.</span><span class=\"n\">powers</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">instSMulOfIsScalarTower</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"c1\">-- comes from `OreLocalization.zsmul`, depends on `AddGroup ℤ`</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"bp\">.</span><span class=\"n\">Away</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">toZSMul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- helpme</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 497250937,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738496258
    },
    {
        "content": "<p>I'm not sure if this is a reasonable <em>statement</em>; are the types of the LHS and RHS reducibly defeq?</p>",
        "id": 497253520,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738498487
    },
    {
        "content": "<p>(that is, can you do the same test again on the second arguments to <code>instHSMul</code>, and test if <code>with_reducible rfl</code> is happy?)</p>",
        "id": 497253636,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738498564
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submonoid</span><span class=\"bp\">.</span><span class=\"n\">powers</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"bp\">.</span><span class=\"n\">Away</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 497253972,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738498904
    },
    {
        "content": "<p>It works</p>",
        "id": 497253976,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1738498909
    },
    {
        "content": "<p>I don't think this has got anything to do with the difference between <code>Localization.Away</code> and <code>Localization</code>: both <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OreLocalization.instSMulOfIsScalarTower#doc\">docs#OreLocalization.instSMulOfIsScalarTower</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OreLocalization.instAddGroupOreLocalization#doc\">docs#OreLocalization.instAddGroupOreLocalization</a> work for general localization by submonoids. There's a <a href=\"https://github.com/leanprover-community/mathlib4/blob/8f1b0576c3aeb2851403b6f5dd56a5ee53e705de/Mathlib/GroupTheory/OreLocalization/Basic.lean#L534-L535\">warning</a> in the code that the former instance might cause diamonds in an obscure situation but ths seems far less obscure.</p>",
        "id": 497254621,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738499496
    },
    {
        "content": "<p>This diamond is known, yes. <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> and I hit it in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21021\">#21021</a></p>",
        "id": 497254739,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1738499577
    },
    {
        "content": "<p>Maybe one could try weakening the definition of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OreLocalization.zsmul#doc\">docs#OreLocalization.zsmul</a>, adding an assumption <code>[SMul ℤ R]</code> and defining it not as <code>zsmulRec</code> but as <code>OreLocalization.hsmul</code>. This would reduce the scope of <code>AddCommGroup X[S⁻¹]</code> a little (requiring that S is a submonoid of basically a ring rather than just a monoid) but do we care in practice?</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21344\">#21344</a> let's see if it compiles at least.</p>",
        "id": 497255500,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738500228
    },
    {
        "content": "<p>Hmm, it compiles (locally) but doesn't seem fix the diamond so I must have misanalysed something :-/</p>",
        "id": 497256246,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738500769
    },
    {
        "content": "<p>Sorry, was interrupted. Let me explain.</p>",
        "id": 497256458,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1738500924
    },
    {
        "content": "<p>Oh OK on that branch this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"c1\">-- comes from `OreLocalization.hsmul`, depends on `SMul ℤ ℤ`</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submonoid</span><span class=\"bp\">.</span><span class=\"n\">powers</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">instSMulOfIsScalarTower</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"c1\">-- comes from `OreLocalization.zsmul`, depends on `AddGroup ℤ`</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"bp\">.</span><span class=\"n\">Away</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">toZSMul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">SMul</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">toZSMul</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">zsmul</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">instSMulOfIsScalarTower</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">AddGroup</span><span class=\"bp\">.</span><span class=\"n\">toSubNegMonoid</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">instAddGroupOreLocalization</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"n\">only</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">zsmul</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>so it's now a reducibility issue (but I've now run out of time to think about this, unfortunately)</p>",
        "id": 497256717,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738501099
    },
    {
        "content": "<p>There is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OreLocalization.zsmul_eq_zsmul#doc\">docs#OreLocalization.zsmul_eq_zsmul</a> to show that they are at least equal.</p>",
        "id": 497259609,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738503678
    },
    {
        "content": "<p>And I’m not sure if we don’t need localization of modules of monoids.</p>",
        "id": 497260057,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738504143
    },
    {
        "content": "<p>We might need it in the future but apparently we don't need it yet in the non-commutative case.</p>",
        "id": 497266539,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738510017
    },
    {
        "content": "<p>Ok so <a href=\"https://github.com/leanprover-community/mathlib4/pull/21344\">#21344</a> now has</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">Ring</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GroupTheory</span><span class=\"bp\">.</span><span class=\"n\">MonoidLocalization</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"c1\">-- comes from `OreLocalization.hsmul`, depends on `SMul ℤ ℤ`</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submonoid</span><span class=\"bp\">.</span><span class=\"n\">powers</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">instSMulOfIsScalarTower</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"c1\">-- comes from `OreLocalization.zsmul`, depends on `AddGroup ℤ`</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submonoid</span><span class=\"bp\">.</span><span class=\"n\">powers</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">toZSMul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>so the diamond is gone (and I assume will remain gone after <code>import Mathlib</code>) but in order to deal with Andrew's concern I've also added back the SMul instance without assuming a Z-action on R (so it works for monoids) but with low priority, so it will be found only if R isn't a ring, which should hopefully be enough to deal with all the issues here. </p>\n<p>There are some <code>sorry</code>s which I've left as an exercise :-)</p>",
        "id": 497546379,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738622785
    },
    {
        "content": "<p>I don't think this low-priority trick works, because lemmas about groups will still find the <code>Group</code> instance which contains the bad zsmul instance.</p>",
        "id": 497546658,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738622916
    },
    {
        "content": "<p>Maybe it will work if <code>[SMul ℤ X[S⁻¹]]</code> is an assumption to <code>AddGroup X[S⁻¹]</code>, but I'm not sure if TC synthesis will like it.</p>",
        "id": 497547047,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738623083
    },
    {
        "content": "<p>I am hitting this diamond while working with <code>FractionRing</code>. But, Kevin's PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/21344\">#21344</a> does fix the issue for me. So even if it is not a perfect solution, it seems to be a step in the right direction. If I adopt the PR and complete it, is there a chance it will be merged (or do I have to look for another solution).</p>",
        "id": 542910960,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1759485743
    },
    {
        "content": "<p>I see that the conversation continued <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/failed.20to.20synthesize.20.60CommRing.20.28R.20.E2.8A.97.5B.E2.84.A4.5D.20Localization.20M.29.60/with/523548240\">here</a> and it seems that <a href=\"https://github.com/leanprover-community/mathlib4/pull/21344\">#21344</a> is not the right solution. I'll see if using <code>attribute [-instance] AddCommGroup.toIntModule</code> works for me...</p>",
        "id": 542917245,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1759488134
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> always understood this issue much better than me.</p>",
        "id": 542930431,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1759493016
    },
    {
        "content": "<p>what's the problem again</p>",
        "id": 542930505,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759493041
    },
    {
        "content": "<p>oh I get it now</p>",
        "id": 542931328,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759493342
    },
    {
        "content": "<p>You found the diamond IIRC!</p>",
        "id": 542931709,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1759493481
    },
    {
        "content": "<p>it was a while ago I forgot</p>",
        "id": 542931863,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759493535
    },
    {
        "content": "<p>I might try thinking of a solution later</p>",
        "id": 542932510,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1759493784
    },
    {
        "content": "<p><code>attribute [-instance] AddCommGroup.toIntModule</code> did not work so I ended up using <code>convert</code> and resolved the diamond by hand thanks to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OreLocalization.zsmul_eq_zsmul#doc\">docs#OreLocalization.zsmul_eq_zsmul</a></p>",
        "id": 542936270,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1759494964
    },
    {
        "content": "<p>I think I had a fix to this at Big Proof, but Andrew suggested we do a different refactor first, then I suggested doing a different refactor, then Andrew pushed back and I agreed, then I ran out of time to review his compromise</p>",
        "id": 542976333,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1759506841
    },
    {
        "content": "<p>It would be nice to have some more details of these ideas available. Seems like at least three people have independently run into this diamond now.</p>",
        "id": 542988266,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1759510607
    }
]