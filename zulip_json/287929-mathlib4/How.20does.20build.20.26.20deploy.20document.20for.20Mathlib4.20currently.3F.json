[
    {
        "content": "<p>According to <a href=\"https://github.com/leanprover-community/mathlib4/pull/14229\">https://github.com/leanprover-community/mathlib4/pull/14229</a>, I know \"meta if\" in mathlib's <code>lakefile.lean</code> for doc-gen has veen removed. And we want to remove \"meta if\" in our project because it's troublesome when we update deps. However, I think if it's removed, we won't generate &amp; deploy the documentation, so I have a question. What is the workflow for build and deploy Mathlib4 documentation currently? As I saw It seems not to be found way in mathlib4 repository.</p>",
        "id": 476591680,
        "sender_full_name": "SnO2WMaN",
        "timestamp": 1728810920
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> may have the link on hand; it's in a separate repository</p>",
        "id": 476597802,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728817428
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4_docs\">https://github.com/leanprover-community/mathlib4_docs</a></p>",
        "id": 476599604,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728819223
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"543250\">SnO2WMaN</span> has marked this topic as resolved.</p>",
        "id": 476640598,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728856849
    },
    {
        "content": "<p>Probably related to this problem : I am trying to build an old <code>mathlib</code> doc for a teaching project for which I do not want to update mathlib. <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> 's suggestion was simply to <code>import Mathlib</code> in the main <code>lean file</code>and then to build the <code>doc</code> for the project, as this will build the doc for every mathlib file in the project, which will be the \"right, old\" ones. Unfortunately I cannot make this work, although I followed the instructions here<br>\n<a href=\"https://github.com/leanprover/doc-gen4\">https://github.com/leanprover/doc-gen4</a></p>",
        "id": 476796962,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1728914849
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300245\">Filippo A. E. Nuccio</span> has marked this topic as unresolved.</p>",
        "id": 476797020,
        "sender_full_name": "Notification Bot",
        "timestamp": 1728914871
    },
    {
        "content": "<p>Are those instructions still up-to-date?</p>",
        "id": 476797097,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1728914886
    },
    {
        "content": "<p>You don't need to import Mathlib at the top level, doc-gen picks up on the transitive dependencies of all your files on its own.</p>",
        "id": 476807300,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728918301
    },
    {
        "content": "<p>And the instructions are correct yes</p>",
        "id": 476807399,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1728918338
    },
    {
        "content": "<p>Well, but I <em>only</em> want the mathlib doc, so I only import mathlib, no?</p>",
        "id": 476808203,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1728918615
    },
    {
        "content": "<p>What I mean is that all other files will be classes, and I do not want any doc for them.</p>",
        "id": 476808303,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1728918669
    },
    {
        "content": "<p>And at any rate I get an error, that begins with</p>\n<blockquote>\n<p>$ lake -R -Kenv=dev build M2Lyon2425:docs<br>\n✖ [7/10123] Building DocGen4.Process.Hierarchy<br>\ntrace: .&gt; LEAN_PATH=.\\.\\.lake/packages\\batteries\\.lake\\build\\lib;.\\.\\.lake/packages\\Qq\\.lake\\build\\lib;.\\.\\.lake/packages\\aesop\\.lake\\build\\lib;.\\.\\.lake/packages\\proofwidgets\\.lake\\build\\lib;.\\.\\.lake/packages\\Cli\\.lake\\build\\lib;.\\.\\.lake/packages\\importGraph\\.lake\\build\\lib;.\\.\\.lake/packages\\mathlib\\.lake\\build\\lib;.\\.\\.lake/packages\\MD4Lean\\.lake\\build\\lib;.\\.\\.lake/packages\\UnicodeBasic\\.lake\\build\\lib;.\\.\\.lake/packages\\BibtexQuery\\.lake\\build\\lib;.\\.\\.lake/packages\\doc-gen4\\.lake\\build\\lib;.\\.\\.lake\\build\\lib PATH c:\\Users\\nf51454h\\.elan\\toolchains\\leanprover--lean4---v4.11.0-rc2\\bin\\lean.exe .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean -R .\\.\\.lake/packages\\doc-gen4\\.\\. -o .\\.\\.lake/packages\\doc-gen4\\.lake\\build\\lib\\DocGen4\\Process\\Hierarchy.olean -i .\\.\\.lake/packages\\doc-gen4\\.lake\\build\\lib\\DocGen4\\Process\\Hierarchy.ilean -c .\\.\\.lake/packages\\doc-gen4\\.lake\\build\\ir\\DocGen4\\Process\\Hierarchy.c --json<br>\nerror: .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean:80:23: unknown identifier 'Std.HashSet'<br>\nerror: .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean:81:2: unknown identifier 'Std.HashSet.ofList'<br>\nwarning: .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean:111:4: declaration uses 'sorry'<br>\nerror: Lean exited with code 1<br>\n</p>\n</blockquote>",
        "id": 476809279,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1728919020
    },
    {
        "content": "<p>Sounds like your version of doc-gen doesn't agree with your version of lean</p>",
        "id": 476813433,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728920500
    },
    {
        "content": "<p>Indeed, you're right. I was using <code>v4.11.0-rc2</code> but doc-gen is now based upon <code>4.13.0-rc1</code>. Now I do not know how to proceed:</p>\n<ol>\n<li>If I change the <code>lean-toolchain</code>my project does not build anymore, because I need to <code>lake update</code> and I don't think I want to do this basically for the same reason that put me in this situation: I do not want to update <code>mathlib</code> because all students have already started working on some version that I do not want to touch.</li>\n<li>I tried changing <code>\"https://github.com/leanprover/doc-gen4\" @ \"main\"</code> with <code>\"https://github.com/leanprover/doc-gen4\" @ \"114aabc6f0f8d117eb1a853c0dc1591126d9c559\"</code> (pointing to <a href=\"https://github.com/leanprover/doc-gen4/commit/114aabc6f0f8d117eb1a853c0dc1591126d9c559\">this commit</a>) but this does not seem to work.</li>\n</ol>\n<p>Any idea?</p>",
        "id": 477161771,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729068551
    },
    {
        "content": "<p>Did you <code>lake update</code> after that?</p>",
        "id": 477162239,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1729068697
    },
    {
        "content": "<p>Well, as explained in 1. I do not want to do this...</p>",
        "id": 477162899,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729068888
    },
    {
        "content": "<p><code>lake update</code> with a pinned dependency won't actually update past the pinned version</p>",
        "id": 477163005,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1729068925
    },
    {
        "content": "<p>So you should <code>lake update</code> to see what happens. It won't change the toolchain</p>",
        "id": 477163224,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1729068977
    },
    {
        "content": "<p>Well, but as <span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span> said if my toolchain is not aligned with the lean version in <code>doc-gen</code> I get an error.</p>",
        "id": 477163461,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729069038
    },
    {
        "content": "<p>I think that if I change the toolchain <em>and</em> I <code>lake update</code> with a pinned version of <code>mathlib</code>, this could work (I can try, actually, I am on a trial branch)...</p>",
        "id": 477163872,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729069157
    },
    {
        "content": "<p>Let me try</p>",
        "id": 477163880,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729069159
    },
    {
        "content": "<p>My point is, just changing <code>lakefile.lean</code> doesn't help, you also need to update the json to match the commit you put in the the lakefile</p>",
        "id": 477165846,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1729069769
    },
    {
        "content": "<p>Ah, I see. But in the <code>json</code> should I update the commit for doc-gen only or for all the other dependencies?</p>",
        "id": 477166312,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729069918
    },
    {
        "content": "<p>I guess <code>lake update doc-gen4</code> might work?</p>",
        "id": 477167462,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1729070305
    },
    {
        "content": "<p>Let me try</p>",
        "id": 477170127,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729071133
    },
    {
        "content": "<p>If only there were a <code>lake downdate</code></p>",
        "id": 477174172,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729072457
    },
    {
        "content": "<p>No, unfortunately after <code>lake update</code> although my <code>lake build</code> gives no error, I am still stuck with the following</p>\n<div class=\"codehilite\" data-code-language=\"BBCode\"><pre><span></span><code>$ lake -R -Kenv=dev build M2Lyon2425:docs\n✖ <span class=\"k\">[7</span><span class=\"err\">/10123</span><span class=\"k\">]</span> Building DocGen4.Process.Hierarchy\ntrace: .&gt; LEAN_PATH=.\\.\\.lake/packages\\batteries\\.lake\\build\\lib;.\\.\\.lake/packages\\Qq\\.lake\\build\\lib;.\\.\\.lake/packages\\aesop\\.lake\\build\\lib;.\\.\\.lake/packages\\proofwidgets\\.lake\\build\\lib;.\\.\\.lake/packages\\Cli\\.lake\\build\\lib;.\\.\\.lake/packages\\importGraph\\.lake\\build\\lib;.\\.\\.lake/packages\\mathlib\\.lake\\build\\lib;.\\.\\.lake/packages\\MD4Lean\\.lake\\build\\lib;.\\.\\.lake/packages\\UnicodeBasic\\.lake\\build\\lib;.\\.\\.lake/packages\\BibtexQuery\\.lake\\build\\lib;.\\.\\.lake/packages\\doc-gen4\\.lake\\build\\lib;.\\.\\.lake\\build\\lib PATH c:\\Users\\nf51454h\\.elan\\toolchains\\leanprover--lean4---v4.11.0-rc2\\bin\\lean.exe .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean -R .\\.\\.lake/packages\\doc-gen4\\.\\. -o .\\.\\.lake/packages\\doc-gen4\\.lake\\build\\lib\\DocGen4\\Process\\Hierarchy.olean -i .\\.\\.lake/packages\\doc-gen4\\.lake\\build\\lib\\DocGen4\\Process\\Hierarchy.ilean -c .\\.\\.lake/packages\\doc-gen4\\.lake\\build\\ir\\DocGen4\\Process\\Hierarchy.c --json\nerror: .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean:80:23: unknown identifier 'Std.HashSet'\nerror: .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean:81:2: unknown identifier 'Std.HashSet.ofList'\nwarning: .\\.\\.lake/packages\\doc-gen4\\.\\.\\DocGen4\\Process\\Hierarchy.lean:111:4: declaration uses 'sorry'\nerror: Lean exited with code 1\n</code></pre></div>",
        "id": 477241174,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729091736
    },
    {
        "content": "<p>I am still completely stuck. I think I have tried all possible combinations of</p>\n<ol>\n<li>Manually changing the <code>lakefile</code></li>\n<li>running <code>lake update</code></li>\n<li>running <code>lake update doc-gen4</code></li>\n</ol>\n<p>and I still get all sort of errors. <span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span> or <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> , do you have any idea?</p>",
        "id": 477275979,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729103435
    },
    {
        "content": "<p>Well, I realized that after <code>lake update</code> even if I manually change the <code>lakefile</code> to <code>leanprover/lean4:v4.13.0-rc1</code>, it gets reverted immediately to <code>leanprover/lean4:v4.11.0-rc1</code>, probably because I am forcing the <code>mathlib</code> rev to be an old one what used that version of lean. So I do not really know how to follow <span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span> 's suggestion of having lean and doc-gen4 being aligned on the same version.</p>",
        "id": 477462160,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1729176644
    }
]