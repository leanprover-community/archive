[
    {
        "content": "<p>The <code>#min_imports in</code> command has just been merged into master.  It works as follows: add <code>import Mathlib.Tactic.MinImports</code> as an import and then you can write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">MinImports</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"bp\">#</span><span class=\"n\">min_imports</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">XX</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>and it should tell you a minimal set of imports for <code>theorem XX</code> to parse and elaborate.  The command is intended to track also <code>Syntax</code> and tactic information.</p>",
        "id": 452289146,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721292828
    },
    {
        "content": "<p>The command has received a small amount of testing, so bug reports are expected and welcome!</p>\n<p>In particular, the command seems to like a lot the import <code>Lean.Parser.Command</code>: do report if you see it, but I am aware of it and have not been able to track exactly where this could be removed, but isn't!</p>",
        "id": 452289365,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721292906
    },
    {
        "content": "<p>Very nice! </p>\n<p>Can we leverage this to make <code>#split_file</code>?</p>",
        "id": 452315404,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721300792
    },
    {
        "content": "<p>I have a <code>min_imports</code> linter in development that should be useful for that: it flags every time that a command requires more imports than the cumulative imports so far.</p>",
        "id": 452315897,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721300918
    },
    {
        "content": "<p>It is basically the same as <code>#min_imports in</code>, but running systematically on every command and keeping track of the \"imports so far\".</p>",
        "id": 452316046,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721300958
    },
    {
        "content": "<p>It works almost well, in the sense that it does what you expect, <em>except</em> that I still cannot get it to compute imports completely reliably.</p>",
        "id": 452316247,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721301010
    },
    {
        "content": "<p>Every once in a while, it thinks that fewer imports are necessary than what it really is and, when that happens, it seems related to an issue with instances.</p>",
        "id": 452316363,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721301044
    },
    {
        "content": "<p>Ideally it would </p>\n<ul>\n<li>choose a split of the declarations based on the imports</li>\n<li>create new folders/files </li>\n<li>copy the headers of the target file to each </li>\n<li>figure out the parameters and open namespaces necessary </li>\n<li>write everything to the files after confirmation</li>\n</ul>",
        "id": 452316482,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721301074
    },
    {
        "content": "<p>For that kind of automation there is still some work ahead, but I have already found files where the very last declaration requires more imports than everything before it!</p>",
        "id": 452316851,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721301184
    },
    {
        "content": "<p>I just saw one 5 minutes ago: not the last but line ~2000 of <code>GroupTheory.MonoidLocalization</code></p>",
        "id": 452317793,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1721301436
    },
    {
        "content": "<p>E.g., look at this file: the yellow warnings are import bumps.</p>\n<p><a href=\"/user_uploads/3121/oKyvGMn7sqd_ZyEZK0RYeT5W/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/oKyvGMn7sqd_ZyEZK0RYeT5W/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/oKyvGMn7sqd_ZyEZK0RYeT5W/image.png\"></a></div>",
        "id": 452317899,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721301469
    },
    {
        "content": "<p>Given I want to add a theorem that does import more than all the other stuff above, I'm advised to create a new file <code>Lemmas.lean</code> if it not already exists, right?</p>",
        "id": 452318430,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1721301612
    },
    {
        "content": "<p>My usual rule of thumb is to avoid as much as possible to add <code>import</code> lines, except when creating  a new file.  <code>#find_home!</code> should give you a reasonable choice of candidate files that already have the right imports (but may fail due to missing tactics/notation, though it is often correct).</p>",
        "id": 452319569,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721301914
    },
    {
        "content": "<p>The new <code>#min_imports in</code> command should give you a lower bound, consisting of the files that must be imported for the declaration to compile and such that no smaller subset has that property.  This is at the moment not completely correct, but also seems accurate often.</p>",
        "id": 452319882,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721301993
    },
    {
        "content": "<p>Creating a new file is good, but use the name <code>Lemmas</code> as last resort, preferring a descriptive subject specific name.</p>",
        "id": 452330281,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721305255
    },
    {
        "content": "<p>(if there really is nothing better, Lemmas or Basic are still better than adding imports to existing files or especially to definitions only files.)</p>",
        "id": 452330459,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721305308
    },
    {
        "content": "<p>It's also helpful if, upon resisting the temptation to add an import somewhere, everyone can help out by adding <code>assert_not_exists</code> statements to the file that guard against future temptation!</p>",
        "id": 452330775,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1721305394
    },
    {
        "content": "<p>I'd like to perhaps add one exception: when adding results to an existing file that \"always belonged there\" (but were left as future work), imho it can be appropriate to just add the existing import.</p>",
        "id": 452331028,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1721305455
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14878\">#14878</a> improves handling of \"nameless\" <code>instance</code>s and <code>attribute</code>s in <code>#min_imports in</code>.</p>",
        "id": 452421543,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721329849
    }
]