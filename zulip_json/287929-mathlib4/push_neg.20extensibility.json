[
    {
        "content": "<p>I would like <code>push_neg</code> to simplify <code>s ≠ ∅</code> to <code>s.Nonempty</code> when <code>s : Finset α</code>. <code>push_neg</code> already does this when <code>s : Set α</code> thanks to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Tactic.PushNeg.ne_empty_eq_nonempty#doc\">docs#Mathlib.Tactic.PushNeg.ne_empty_eq_nonempty</a>. But this is a hardcoded lemma and we certainly don't want to import finsets in <code>Tactic.PushNeg</code></p>",
        "id": 481289823,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731063470
    },
    {
        "content": "<p>Does that mean we need a full redesign of <code>push_neg</code>?</p>",
        "id": 481289906,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731063487
    },
    {
        "content": "<p>I don't think a full redesign is necessary. You could add an attribute, and then mark theorems of a particular form (e.g., <code>Ne</code>) with it, and in the tactic you could apply these at the relevant point if they match.</p>",
        "id": 481313298,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731071992
    },
    {
        "content": "<p>I think that would be a full redesign <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> Look at the <code>push_neg</code> code.</p>",
        "id": 481318734,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731073916
    },
    {
        "content": "<p>I'm taking a look, and I'm not sure what I'm supposed to be seeing Yaël.</p>",
        "id": 481334716,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731078881
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> Yeah, there could be a <code>@[push_neg]</code> simp set that's used when invoking simp at <code>Mathlib.Tactic.PushNeg.pushNegCore</code></p>",
        "id": 481334926,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731078962
    },
    {
        "content": "<p>Yaël, I looked at the code before I sent that message. I don't see anything that requires a <em>full</em> redesign.</p>",
        "id": 481334967,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731078964
    },
    {
        "content": "<p>I'll see if I can implement this real quick before I go teach.</p>",
        "id": 481335466,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731079151
    },
    {
        "content": "<p>Sometimes I wish it could be configurable whether <code>push_neg</code> pushes negations everywhere or just along the \"spine\". I tried doing this a couple years ago, but it'd take writing a new driver for it that doesn't use simp... It didn't seem worth it.</p>",
        "id": 481335787,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731079252
    },
    {
        "content": "<p>I don't know what you mean by \"spine\"</p>",
        "id": 481335843,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731079276
    },
    {
        "content": "<p>It currently pushes negations inside arguments and binder types too. The \"spine\" would be (1) the top level expression, (2) the conclusion of a forall or exists that is a spine expression, (3) the arguments to a conjunction or disjunction that is a spine expression.</p>",
        "id": 481336164,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731079403
    },
    {
        "content": "<p>What's an example where you would prefer this behavior?</p>",
        "id": 481336313,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731079452
    },
    {
        "content": "<p>I don't have any offhand, but I've wanted to be able to push the outermost negation inward before, and only the outermost negation, without simplifying anything else.</p>",
        "id": 481336482,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731079519
    },
    {
        "content": "<p>I think my motivation looking into it was during the SLMath Lean school a couple years ago, a student was surprised at how global <code>push_neg</code> was.</p>",
        "id": 481336776,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731079613
    },
    {
        "content": "<p>Hmmm... Is it not possible to just take <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=transformNegationStep#doc\">docs#transformNegationStep</a> and use it in <code>simp</code> with a <code>singlePass</code> downwards (like <code>↓simp</code>)?</p>",
        "id": 481338854,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731080304
    },
    {
        "content": "<p>Also, is there some documentation on <code>register_simp_attr</code>? I would expect it to put some sort of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.SimpTheoremsArray#doc\">docs#Lean.Meta.SimpTheoremsArray</a> (or similar) into the environment, along with the attribute that actually adds the lemma, but I'm having trouble finding it.</p>",
        "id": 481339289,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731080453
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/push_neg.20extensibility/near/481338854\">said</a>:</p>\n<blockquote>\n<p>Hmmm... Is it not possible to just take <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=transformNegationStep#doc\">docs#transformNegationStep</a> and use it in <code>simp</code> with a <code>singlePass</code> downwards (like <code>↓simp</code>)?</p>\n</blockquote>\n<p>I don't think so — simp will keep going into subexpressions even if transformNegationStep didn't do anything.</p>",
        "id": 481339855,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731080629
    },
    {
        "content": "<p>It looks like <code>SimpExtension</code> has a <code>getTheorems</code> function</p>",
        "id": 481340095,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731080697
    },
    {
        "content": "<p>(Found this by looking through <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.elabSimpArgs#doc\">docs#Lean.Elab.Tactic.elabSimpArgs</a>)</p>",
        "id": 481340200,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731080732
    },
    {
        "content": "<p>So, I realized after you sent that message before that the thing I should have done was:</p>\n<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> |- Lean.Meta.SimpTheorems</p>",
        "id": 481365771,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731090381
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/Tactic/Simp/SimpTheorems.html#Lean.Meta.addSimpTheoremEntry\">Lean.Meta.addSimpTheoremEntry</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Meta/Tactic/Simp/SimpTheorems.html#Lean.Meta.SimpTheorems.addDeclToUnfoldCore\">Lean.Meta.SimpTheorems.addDeclToUnfoldCore</a>, and <a href=\"https://loogle.lean-lang.org/?q=%7C-%20Lean.Meta.SimpTheorems\">6 more</a></p>",
        "id": 481365775,
        "sender_full_name": "loogle",
        "timestamp": 1731090382
    },
    {
        "content": "<p>In any case, I'm having a bit of trouble because I <em>think</em> (using <code>whatsnew in</code>) that <code>register_simp_attr</code> creates a hygienic name for the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.SimpExtension#doc\">docs#Lean.Meta.SimpExtension</a> that it declares. I guess the point is that it is only meant to be used in the context of <code>simp [my_fancy_simp_attr]</code>, and not intended for use with the internals of <code>simp</code>. Am I missing something? Or do I need to declare this attribute and register the simp extension manually (which would be <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span>).</p>",
        "id": 481366260,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731090579
    },
    {
        "content": "<p>I mean, it's not that hard to use <code>registerSimpAttr</code> directly, it just seems silly that <code>register_simp_attr</code> makes this hygienic for no apparent reason.</p>",
        "id": 481368644,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731091587
    },
    {
        "content": "<p>Yeah, it looks like you have to do it manually.</p>\n<p>For why the extension is hygienic, I guess it's because it's not wanting to make a choice for what the simp extension's name should be. It seems like it could be reasonable to expose it.</p>\n<p>I wonder if it would make sense to change <code>push_neg</code> to be a macro for <code>simp only [push_neg]</code>, and move the main implementation into a simproc. It would be convenient being able to throw <code>push_neg</code> into any given <code>simp</code></p>",
        "id": 481373920,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731093897
    },
    {
        "content": "<p>Well, the issue is that <code>push_neg</code> is also intended as a pedagogical tool. As such, it puts a large emphasis on preserving things like binder names. Would we be able to preserve that behavior if it were a <code>simproc</code>?</p>",
        "id": 481375048,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731094390
    },
    {
        "content": "<p>And also there is a flag for how <code>¬ (a ∧ b)</code> should be handled.</p>",
        "id": 481375114,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731094419
    },
    {
        "content": "<blockquote>\n<p>Would we be able to preserve that behavior if it were a <code>simproc</code>?</p>\n</blockquote>\n<p>Yes, definitely, and I would hope we would be able to preserve binder names even just for general usability.</p>",
        "id": 481375867,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731094726
    },
    {
        "content": "<p>I'm not sure if simprocs can access options. If they can, then that's solved, but if not, we could get it to work by conditionally inserting a simp lemma that overrides the normal <code>push_neg</code> set.</p>",
        "id": 481375950,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731094766
    },
    {
        "content": "<p>Maybe simprocs are how we can deal with commuting <code>Finset.prod</code>/<code>Finset.prod</code> and preserving the binder names... Though I suppose there's not a sophisticated enough interface to simprocs to be able to select which products to commute.</p>",
        "id": 481376132,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731094843
    },
    {
        "content": "<p>Aha, then I think a <code>simproc</code> for <code>push_neg</code> sounds like a nice idea.</p>",
        "id": 481376272,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731094919
    },
    {
        "content": "<p>The idea is that <code>Mathlib.Tactic.PushNeg.transformNegation</code> is already the simproc (it's got the correct signature and everything), and you just need to add it to the <code>push_neg</code> simp set</p>",
        "id": 481377294,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731095359
    }
]