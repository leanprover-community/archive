[
    {
        "content": "<p>Hi, I asked long time ago but didn't get an answer so decided to repeat my question here again :)<br>\nHere is my mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">FieldTheory</span><span class=\"bp\">.</span><span class=\"n\">IntermediateField</span><span class=\"bp\">.</span><span class=\"n\">Adjoin</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Dimension</span><span class=\"bp\">.</span><span class=\"n\">Finrank</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"c\">/-</span><span class=\"cm\"> `F⟮a⟯` notation -/</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> failed to synthesize Module ↥(IntermediateField.lift F⟮a⟯) ↥E -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test_error</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">finrank</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"bp\">⟮</span><span class=\"n\">a</span><span class=\"bp\">⟯</span><span class=\"w\"> </span><span class=\"n\">E</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">finrank</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">K</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> works -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test_ok</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"bp\">⟮</span><span class=\"n\">a</span><span class=\"bp\">⟯</span>\n</code></pre></div>\n<p>Why dealing directly with intermediate fields of intermediate fields does not work but when redirecting through another function, it just works?<br>\nIf I provide an instance of <code>Algebra F⟮a⟯ E</code> it starts working but then how this instance is found in <code>aux</code>?</p>",
        "id": 512762932,
        "sender_full_name": "Michał Staromiejski",
        "timestamp": 1744876859
    },
    {
        "content": "<p>This works</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">test_also_ok</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Module.finrank</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"bp\">⟮</span><span class=\"n\">a</span><span class=\"bp\">⟯.</span><span class=\"n\">toSubalgebra</span><span class=\"w\"> </span><span class=\"n\">E</span>\n</code></pre></div>\n<p>so if you \"help\" Lean a little bit telling it to first see your intermediate field as a subalgebra, and then coercing this to a submodule, class type inference works. I suspect that this is caused by <a href=\"https://leanprover-community.github.io/mathlib4_docs//Mathlib/FieldTheory/IntermediateField/Adjoin/Defs.html#IntermediateField.%C2%ABterm_%E2%9F%AE_,,%E2%9F%AF%C2%BB\">this definition</a> that does not make it transparent/reducible for Lean that <code>F(a)</code> is \"simply\" an intermediate field and can be coerced to a subalgebra-&gt;submodule, whereas when you apply <code>aux</code>it only tries to see it as an intermediate field, which it can. By I believe that <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> would have a better explanation.</p>",
        "id": 512856926,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1744904138
    },
    {
        "content": "<p>Hm.. that's interesting, thanks for the explanation. So it means that the type of <code>F⟮a⟯</code> is not <code>IntermediateField F E</code> but can be coerced to it?</p>",
        "id": 512860745,
        "sender_full_name": "Michał Staromiejski",
        "timestamp": 1744905232
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IntermediateField.toAlgebra#doc\">docs#IntermediateField.toAlgebra</a> is not as general as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.toAlgebra#doc\">docs#Subalgebra.toAlgebra</a></p>",
        "id": 512860885,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744905270
    },
    {
        "content": "<p>Fixing that should fix this issue</p>",
        "id": 512860926,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744905285
    },
    {
        "content": "<p>Ok, I tried to play around to make <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IntermediateField.toAlgebra#doc\">docs#IntermediateField.toAlgebra</a> more or less like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.toAlgebra#doc\">docs#Subalgebra.toAlgebra</a> but with no success:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"bp\">.</span><span class=\"n\">toSubalgebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>So maybe there's more. Also, the trick with explicit casts to <code>Subalgebra</code> does not work with dosc#Module.finrank_mul_finrank (but some configurations work):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> those commented out fail -/</span>\n<span class=\"c1\">--#check := Module.finrank_mul_finrank F E₁ E</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">finrank_mul_finrank</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">E₁</span><span class=\"w\"> </span><span class=\"n\">K</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">finrank_mul_finrank</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">E₂</span><span class=\"w\"> </span><span class=\"n\">K</span>\n<span class=\"c1\">--#check Module.finrank_mul_finrank F E₁ E₂</span>\n<span class=\"c1\">--#check Module.finrank_mul_finrank E₁ E₂ K</span>\n<span class=\"c1\">--#check Module.finrank_mul_finrank E₁ E E₂</span>\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>, any hint how to fix it properly?</p>",
        "id": 513015088,
        "sender_full_name": "Michał Staromiejski",
        "timestamp": 1744974861
    },
    {
        "content": "<p>It's known that IntermediateField sometimes needs some shortcut instances to work (or to be fast enough to work with). Maybe the instances that work are due to the shortcuts. I just found that one more instance was added during a bump <a href=\"https://github.com/leanprover-community/mathlib4/blob/dad08fa365650bbf2f7aed844722fea2c735069c/Mathlib/FieldTheory/IntermediateField/Basic.lean#L411-L419\">next to shortcuts</a> I added ~2 years ago: <br>\n<a href=\"/user_uploads/3121/6k1ac6ufC52oxiLi9Du-TeSU/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/6k1ac6ufC52oxiLi9Du-TeSU/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1525x249\" src=\"/user_uploads/thumbnail/3121/6k1ac6ufC52oxiLi9Du-TeSU/image.png/840x560.webp\"></a></div>",
        "id": 513020714,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1744977402
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">IntermediateField</span><span class=\"bp\">.</span><span class=\"n\">instCoeOutSubtypeMem</span>\n</code></pre></div>\n<p>fixes it</p>",
        "id": 513021979,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744977774
    },
    {
        "content": "<p>I think this instance (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IntermediateField.instCoeOutSubtypeMem#doc\">docs#IntermediateField.instCoeOutSubtypeMem</a>) is changing the type of your statement in a way that is surprising</p>",
        "id": 513022005,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744977787
    },
    {
        "content": "<p>We don't have this instance for any other subobjects, so I think we should remove it here too</p>",
        "id": 513022030,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744977801
    },
    {
        "content": "<p>Indeed it fixes everything I needed. Thanks for your help. Should I create PR to remove the instance?</p>",
        "id": 513024486,
        "sender_full_name": "Michał Staromiejski",
        "timestamp": 1744979048
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"759408\">Michał Staromiejski</span> has marked this topic as resolved.</p>",
        "id": 513027654,
        "sender_full_name": "Notification Bot",
        "timestamp": 1744980473
    },
    {
        "content": "<p>PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/24182\">#24182</a> ready <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 513090099,
        "sender_full_name": "Michał Staromiejski",
        "timestamp": 1745006369
    }
]