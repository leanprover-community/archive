[
    {
        "content": "<p>I am confused by frequently reading <code>class Foo extends BarCast</code> in Mathlib.<br>\nFor example, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=DivisionRing#doc\">docs#DivisionRing</a> extends <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NNRatCast#doc\">docs#NNRatCast</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RatCast#doc\">docs#RatCast</a> .<br>\nI find it weird that <code>BarCast</code> is part of the definition.<br>\nWhy isn't it just an <code>instance</code> for given class?</p>",
        "id": 464290689,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724313245
    },
    {
        "content": "<p>Why wouldn't it just extend it?</p>",
        "id": 464294944,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724314015
    },
    {
        "content": "<p>A nice explanation is in <a href=\"https://leanprover.github.io/theorem_proving_in_lean4/structures_and_records.html#inheritance\">this chapter</a> of the Lean Manual, for instance.</p>",
        "id": 464295359,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1724314095
    },
    {
        "content": "<p>If you don't \"extend\", you need to define all the fields again from scratch (plus you loose some nice automatic instance creation, but even without this the extension mechanism is great).</p>",
        "id": 464295488,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1724314159
    },
    {
        "content": "<p>Another advantage is that otherwise you need to call all these instances before being allowed to insert the one you're defining: see the examples:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CommGroup</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">another_plus</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">AddCommMagma.add_comm</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">another_plus</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommGroup</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"c1\">--cannot simply put [bar α]</span>\n<span class=\"w\">   </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">AddCommMagma.add_comm</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span>\n</code></pre></div>",
        "id": 464298169,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1724314942
    },
    {
        "content": "<p>Another advantage is that the extension mechanism helps in checking that fields with the same name are actually the same field: see the examples below</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kd\">extends</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">another_plus</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">MulOneClass.mul_one</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kd\">class</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">another_plus</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">MulOneClass.mul_one</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"c1\">--gets an error, Lean is confused whether * is the CommRing one or the One one.</span>\n</code></pre></div>",
        "id": 464300172,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1724315344
    },
    {
        "content": "<p>I didn't mean <code>Foo</code> having an instance argument of type <code>BarCast</code>.<br>\nI meant <code>Foo</code> having an <code>instance</code> of type <code>BarCast</code>.<br>\nIn the following example, imagine that the <code>One</code> instance does not exist yet...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">another_plus</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"n\">toOne'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>",
        "id": 464305530,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724316583
    },
    {
        "content": "<p>I am not sure to follow what you want to say. How would you suggest to define <code>DivisionRing</code> without <code>extend</code>?</p>",
        "id": 464306060,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1724316691
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Foo.20extends.20BarCast/near/464294944\">said</a>:</p>\n<blockquote>\n<p>Why wouldn't it just extend it?</p>\n</blockquote>\n<p>It makes it harder to check that the formal definition corresponds to the informal definition.</p>",
        "id": 464306206,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724316726
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300245\">Filippo A. E. Nuccio</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Foo.20extends.20BarCast/near/464306060\">said</a>:</p>\n<blockquote>\n<p>I am not sure to follow what you want to say. How would you suggest to define <code>DivisionRing</code> without <code>extend</code>?</p>\n</blockquote>\n<p>Why doesn't Mathlib do something along these lines?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">DivisionRing'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">DivInvMonoid</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nontrivial</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">mul_inv_cancel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">inv_zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">DivisionRing'</span><span class=\"bp\">.</span><span class=\"n\">hasNNRatCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DivisionRing'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NNRatCast</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">DivisionRing'</span><span class=\"bp\">.</span><span class=\"n\">hasRatCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DivisionRing'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RatCast</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 464306782,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724316918
    },
    {
        "content": "<p>That's to allow <code>NNRat.cast q = q</code> definitionally when <code>q : ℚ≥0</code></p>",
        "id": 464320092,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724319915
    },
    {
        "content": "<p>See the doc of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Field#doc\">docs#Field</a>.</p>",
        "id": 464320470,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1724319976
    },
    {
        "content": "<p>What is the note [forgetful inheritance] please?</p>",
        "id": 464321659,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724320232
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Foo.20extends.20BarCast/near/464320092\">said</a>:</p>\n<blockquote>\n<p>That's to allow <code>NNRat.cast q = q</code> definitionally when <code>q : ℚ≥0</code></p>\n</blockquote>\n<p>I still don't get it. Is it <code>extends NNRatCast</code> in order to prevent diamonds that would occur if the <code>NNRatCast</code> instance was synthesized instead of being a part of the definitions?</p>",
        "id": 464331617,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724322501
    },
    {
        "content": "<p>Just to be clear, there are three possibility here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">RatCast</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ratCast</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"bp\">.</span><span class=\"n\">toRatCast</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RatCast</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ratCast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">DIvisionRing</span><span class=\"bp\">.</span><span class=\"n\">ratCast</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"bp\">.</span><span class=\"n\">toRatCast</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RatCast</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ratCast</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"bp\">.</span><span class=\"n\">den</span>\n</code></pre></div>\n<p>I assume you understand why we prefer choice 1 to choice 2 (it's shorter and otherwise identical), and your question is really why choice 3 is bad?</p>",
        "id": 464333626,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724323146
    },
    {
        "content": "<p>Please enlighten me why the 3rd option is bad.</p>",
        "id": 464344848,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724326144
    },
    {
        "content": "<p>Note that there's a default to <code>ratCast</code>, so if you create an instance of <code>DivisionRing</code> without changing <code>ratCast</code> it automatically uses <code>q.num / q.den</code>.<br>\nThe benefit of using option 1 is that we can create the field instance of <code>ℚ</code> such that <code>Rat.cast q = q</code> holds definitionally, which doesn't work with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Rat.castRec#doc\">docs#Rat.castRec</a>, which is the default value of <code>ratCast</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">guard_expr</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=~</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">guard_expr</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=~</span><span class=\"w\"> </span><span class=\"n\">id</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: failed: Rat.castRec (1 / 2 : ℚ) =~ (1 / 2 : ℚ) is not true</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_expr</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">castRec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=~</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 464423315,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1724343480
    },
    {
        "content": "<p>The reason we care about <code>Rat.cast q = q</code> being true by definition is that otherwise we end up with two different <code>Algebra ℚ ℚ</code> instances</p>",
        "id": 464436536,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724346725
    },
    {
        "content": "<p>(and similarly for <code>Nat.cast</code> and <code>Int.cast</code>)</p>",
        "id": 464436616,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724346739
    },
    {
        "content": "<p>I mean, even on a basic level, def-eqs are really nice</p>",
        "id": 464527606,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724383224
    },
    {
        "content": "<p>It's always satisfying to show some huge result by a single <code>rfl</code></p>",
        "id": 464527644,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724383252
    },
    {
        "content": "<p>This just extends that idea</p>",
        "id": 464527656,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724383259
    },
    {
        "content": "<p>BTW, why removing <code>algebraMap</code> from <code>Algebra</code> (and defining it in terms of <code>smul</code>) instead of adding all these <code>*Cast</code> fields is a bad idea?</p>",
        "id": 464528086,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724383545
    },
    {
        "content": "<p>I remember that there was a reason, but I keep forgetting it. It would be nice to add it to docs.</p>",
        "id": 464528160,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724383580
    },
    {
        "content": "<p>Let me write what I understand: we need nice <code>Nat.cast</code> defeq to avoid conflicting <code>OfNat</code> instances. What about the other <code>*Cast</code>s?</p>",
        "id": 464535776,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724385597
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra#doc\">docs#Algebra</a></p>",
        "id": 464577262,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1724399653
    },
    {
        "content": "<p>I think it's related to how we have a <code>sub</code> field in <code>Ring</code> vs deriving it from <code>neg</code></p>",
        "id": 464577377,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724399715
    },
    {
        "content": "<p>Module docstring explains how to deal with existing instances, but doesn't explain what are the issues with different approaches.</p>",
        "id": 464793217,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724477867
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Foo.20extends.20BarCast/near/464577377\">said</a>:</p>\n<blockquote>\n<p>I think it's related to how we have a <code>sub</code> field in <code>Ring</code> vs deriving it from <code>neg</code></p>\n</blockquote>\n<p>I assumed that we do it to avoid some diamonds, but I don't remember what diamonds appear if we use <code>instance [Mul G] [Inv G] : Div G</code> instead of the current approach. It's not <code>Prod</code> or <code>Pi</code> types. AFAIR, there was a type, where one can define <code>Div</code> or <code>Sub</code>, and under additional assumptions it becomes propeq to <code>a * b⁻¹</code>.</p>",
        "id": 464793458,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724478007
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover-community/mathlib/pull/5303\">!3#5303</a></p>",
        "id": 464793953,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724478241
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span> Do we have an actual type, where <code>DivInvMonoid</code> allows us to avoid a diamond?</p>",
        "id": 464794121,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724478321
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Foo.20extends.20BarCast/near/464794121\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> Do we have an actual type, where <code>DivInvMonoid</code> allows us to avoid a diamond?</p>\n</blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FractionalIdeal#doc\">docs#FractionalIdeal</a> has a division defined in general. But <code>b⁻¹</code> (or <code>1/b</code>) isn't an inverse unless some conditions hold (specifically <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsDedekindDomain#doc\">docs#IsDedekindDomain</a>), so we can't define <code>a/b = a * b⁻¹</code>.</p>",
        "id": 465123420,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1724662123
    },
    {
        "content": "<p>Should this be in the docstring of <code>DivInvMonoid</code>?</p>",
        "id": 465178962,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724677047
    },
    {
        "content": "<p>Or maybe in the hierarchy design docstring</p>",
        "id": 465276670,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724709016
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Foo.20extends.20BarCast/near/464527644\">said</a>:</p>\n<blockquote>\n<p>It's always satisfying to show some huge result by a single <code>rfl</code></p>\n</blockquote>\n<p>This is actually a bit of a dangerous idea. :-) We should be thinking that it's even more satisfying to write a proof and know that <em>even if</em> someone changes an essential definition, our proof will survive unchanged (assuming they update the relevant API lemmas, and that's what we use).</p>\n<p>\"a single <code>rfl</code>\" can hide arbitrary complexity: both what the lean kernel has to do to check the proof, and arbitrary hidden dependencies on minor implementation details.</p>",
        "id": 465284645,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724713269
    },
    {
        "content": "<p>I guess I'm mostly thinking about stuff like <code>toDual</code> and <code>ofDual</code>. If anyone changes the defeqs for those, a lot of the library will just implode <span aria-label=\"stuck out tongue\" class=\"emoji emoji-1f61b\" role=\"img\" title=\"stuck out tongue\">:stuck_out_tongue:</span></p>",
        "id": 465302434,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724723034
    },
    {
        "content": "<p>We've done some big defeq changes in the past. :-)</p>",
        "id": 465311059,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724727642
    },
    {
        "content": "<p>So, are there any reasons besides <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra#doc\">docs#Algebra</a> to have <code>*Cast</code> fields other than <code>Nat.cast</code>?</p>",
        "id": 465312895,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724728579
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span> <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <span aria-label=\"up\" class=\"emoji emoji-2b06\" role=\"img\" title=\"up\">:up:</span></p>",
        "id": 466437875,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1725077139
    }
]