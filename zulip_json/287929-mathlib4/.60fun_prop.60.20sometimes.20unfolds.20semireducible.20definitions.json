[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: `fun_prop` was unable to prove `Continuous f`</span>\n\n<span class=\"sd\">Issues:</span>\n<span class=\"sd\">  No theorems found for `f` in order to prove `Continuous fun x =&gt; f x`</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span>\n\n<span class=\"c1\">-- This works because `fun_prop` unfolds `f` even though it isn't reducible</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span>\n</code></pre></div>\n<p>The reason for this is that <code>fun_prop</code> calls <code>whnfCore</code> with default transparency, which unfolds definitions when a projection is applied. This seems to be an oversight in the implementation of <code>fun_prop</code>, since normally it should only unfold reducible definitions.</p>\n<p>Unfortunately, there are some proofs which rely on this behavior. I'd like to ask whether it is worth fixing this bug, since it would break many existing proofs.</p>",
        "id": 574596569,
        "sender_full_name": "Attila Gáspár",
        "timestamp": 1771446074
    },
    {
        "content": "<p>I was hoping someone more knowledgable would answer but it seems desirable for <code>fun_prop</code> to have consistent behaviour. The fix itself should be easy right? Perhaps make a draft PR with the fix and then we can look into the damage? (I am willing to help fix proofs if it seems feasible).</p>",
        "id": 574762568,
        "sender_full_name": "David Ledvinka",
        "timestamp": 1771516335
    },
    {
        "content": "<p>I've implemented a fix in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35548\">#35548</a>, which passes CI.</p>",
        "id": 574841728,
        "sender_full_name": "Attila Gáspár",
        "timestamp": 1771544469
    },
    {
        "content": "<p>Yes it is desirable to have consistent behavior. Thanks a lot <span class=\"user-mention\" data-user-id=\"932362\">@Attila Gáspár</span> for finding this and for fixing it!</p>",
        "id": 574842714,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1771545168
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35697\">#35697</a> changes the default tactic in <code>Homeomorph</code> to <code>first | fun_prop | eta_expand; dsimp -failIfUnchanged; fun_prop</code>. This avoids some of the breakages.</p>",
        "id": 575415996,
        "sender_full_name": "Attila Gáspár",
        "timestamp": 1771888771
    },
    {
        "content": "<p>All the problems are related to beta style reduction/function application for bundled morphisms, right? </p>\n<p>Do you have a mwe to demonstrate the problem? I would have a look at it if it the reduction is indeed necessary or we are just missing a theorem.</p>",
        "id": 575465656,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1771916139
    },
    {
        "content": "<p>I don't think the issue is reduction of bundled morphisms. I assume you were thinking about something like <code>Continuous ⇑{toFun := f, ...}</code>, where the coercion could be a problem, but <code>Homeomorph</code> uses <code>toFun</code> directly instead of the coercion.</p>\n<p>A typical example is <code>def Homeomorph.mulLeft (a : G) : G ≃ₜ G := { Equiv.mulLeft a with }</code>. Here, <code>fun_prop</code> would need to prove <code>Continuous (Equiv.mulLeft a).toFun</code>, but <code>Equiv.mulLeft</code> isn't reducible, so this fails with my fix. But these bundled <code>Equiv</code>s usually have <code>@[simps]</code> lemmas, so we can unfold them using <code>dsimp</code>.</p>\n<p>Also, could you take a look at <a href=\"https://github.com/leanprover-community/mathlib4/pull/35683\">#35683</a>, which fixes an unrelated <code>fun_prop</code> bug? It is needed in some cases for the new default tactic to work in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35697\">#35697</a>.</p>",
        "id": 575513420,
        "sender_full_name": "Attila Gáspár",
        "timestamp": 1771931119
    },
    {
        "content": "<p>I see, in cases like that there should be a <code>fun_prop</code> theorem <code>foeall a, Continuous fun x =&gt; Homeomorphism.mulLeft a x</code>. Is there? Of course in the proof of it you have to manually unfold whatever necessary</p>",
        "id": 575596367,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1771952272
    }
]