[
    {
        "content": "<p>that's a bug in the implementation of <code>by_cases</code></p>",
        "id": 513766943,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745379190
    },
    {
        "content": "<p>I see that <code>by_cases</code> is implemented as <code>dite</code>. I think that <code>if h : p x then (code using h) else (code not using h)</code> in <code>Prop</code> context should report unused variable too.</p>",
        "id": 513773066,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745382798
    },
    {
        "content": "<p>Well then how the heck am I supposed to prove it without writing noisy code?</p>",
        "id": 513779898,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745386564
    },
    {
        "content": "<p>Just use the negative branch of the argument.</p>",
        "id": 513781933,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745387761
    },
    {
        "content": "<p>4 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Call.20for.20help.3A.20technical.2F.20organisational.20debt/with/512346398\">#mathlib4 &gt; Call for help: technical/ organisational debt</a> by <span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span>.</p>",
        "id": 513782061,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745387822
    },
    {
        "content": "<p>The messages above were replies to this message:<br>\n<span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Call.20for.20help.3A.20technical.2F.20organisational.20debt/near/513737752\">said</a>:</p>\n<blockquote>\n<ol start=\"32\">\n<li>Better support for <code>by_cases</code> (and may be some <code>cases</code> - not sure) in the \"unused *\" linters. If I run <code>by_cases h : _</code>, but one of the branches doesn't use <code>h</code>, then <code>h</code> is unused. For <code>rcases, see src#iteratedDerivWithin_const_add (going to be fixed in #24227): the 2nd branch doesn't use </code>hxs<code>, but this </code>hxs` isn't marked as unused.</li>\n</ol>\n</blockquote>",
        "id": 513782197,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745387885
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Unused.20arguments.20and.20by_cases/near/513773066\">said</a>:</p>\n<blockquote>\n<p>I see that <code>by_cases</code> is implemented as <code>dite</code>. I think that <code>if h : p x then (code using h) else (code not using h)</code> in <code>Prop</code> context should report unused variable too.</p>\n</blockquote>\n<p>Neither of these are giving me unused variable warnings:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h0</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">by_cases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h0</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>I'm testing on 4.19.0-rc3, which I think is the latest version. There was another report about a recent regression on unused variable warnings which could be related?</p>",
        "id": 513791904,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745392005
    },
    {
        "content": "<p>At least the version of the unused variable warning that I wrote is designed to handle this case - if you have multiple variables declared by the same syntax then if any of them is used the unused variable warning on it is suppressed</p>",
        "id": 513792275,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745392145
    },
    {
        "content": "<p>it's been rewritten at least once since then though, and it's possible that some correctness was traded for efficiency</p>",
        "id": 513792341,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745392176
    },
    {
        "content": "<p>This is not a recent regression. This bug was there for quite some time.</p>",
        "id": 513857145,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745411011
    },
    {
        "content": "<p>Can you give a reproduction? As I mentioned, the obvious thing is not a reproducer</p>",
        "id": 513960089,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745440597
    },
    {
        "content": "<p>In what sense your examples aren't reproducers? They don't mark <code>h</code> as unused while they should.</p>",
        "id": 513981281,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745451584
    },
    {
        "content": "<p>I found our previous discussion of this topic: <a href=\"#narrow/channel/270676-lean4/topic/Unused.20linter.20with.20.60by_cases.60\">#lean4 &gt; Unused linter with &#96;by_cases&#96;</a></p>",
        "id": 513981833,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745451908
    },
    {
        "content": "<p>wait, the complaint is that the linter <em>doesn't</em> fire? As I said, this is by design; it would make no sense to call <code>h</code> unused here because it is used and if you change the name of the variable binder then the proof breaks</p>",
        "id": 514255263,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745544617
    },
    {
        "content": "<p>Reading the other thread, the issue isn't so much that <code>h</code> is unused as the whole <code>by_cases</code> is unused (in the sense of the \"tactic does nothing\" lint)</p>",
        "id": 514255455,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745544748
    },
    {
        "content": "<p>I think this should be done by an entirely different tactic / linter than the unused variables linter</p>",
        "id": 514255518,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1745544799
    },
    {
        "content": "<p>I won't enter the argument \"should it be a part of the existing linter or a new one?\" Let me rephrase my request as \"add a linter that catches this anti-pattern\".</p>",
        "id": 514267218,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745552340
    },
    {
        "content": "<p>BTW, this is definitely out of scope of the \"tactic does nothing\" lint, because the call to <code>by_cases</code> modifies the goal. It's closer to \"unused have\" (but that's not it, because it's not a <code>have</code> or <code>let</code>).</p>",
        "id": 514289173,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745559499
    },
    {
        "content": "<p>It is just \"suboptimal proof\"</p>",
        "id": 514292696,
        "sender_full_name": "Jz Pan",
        "timestamp": 1745560563
    },
    {
        "content": "<p>All the \"unused ...\" linters check for suboptimal proofs.</p>",
        "id": 514295389,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745561406
    },
    {
        "content": "<p>E.g., if one of your assumptions is used in the unneeded branch only, then it's actually an unneeded assumption.</p>",
        "id": 514295460,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745561453
    },
    {
        "content": "<p>Well there are reasons for why one might intentionally have it unused in one of the branches (that is, when constructing data), e.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">toFin3?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">none</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">inverse</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">by_cases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">choose</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">ofNonempty</span>\n</code></pre></div>\n<p>For <code>Prop</code> goals I would say the tactic is more at fault then the variable (you can also omit the variable name but that won't change  whether the <code>by_cases</code> is unused).</p>",
        "id": 514298814,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1745563107
    },
    {
        "content": "<p>Yes, but Yury explicitly said \"in <code>Prop</code> context\"</p>",
        "id": 514302514,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745564666
    },
    {
        "content": "<p>The point (which took me a while to understand) is that if <code>if h : P then &lt;proof using h&gt; else &lt;proof not using h&gt;</code> can always be replaced by <code>&lt;proof not using h&gt;</code></p>",
        "id": 514306465,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745566053
    }
]