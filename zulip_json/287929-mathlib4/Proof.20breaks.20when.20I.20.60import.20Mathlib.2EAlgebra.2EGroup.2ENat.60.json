[
    {
        "content": "<p>Here's my example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">me</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pow_mod</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>\n<p>The proof is fine if I don't have imports, but breaks if I import that file. What's going on here?</p>",
        "id": 521096691,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1748525957
    },
    {
        "content": "<p>Copying the error messages:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">mathlib</span><span class=\"bp\">-</span><span class=\"n\">demo</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"mi\">2</span>\n<span class=\"n\">exponent</span><span class=\"w\"> </span><span class=\"mi\">390625</span><span class=\"w\"> </span><span class=\"n\">exceeds</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">256</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">exponentiation</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">evaluated</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">exponentiation</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">threshold</span>\n\n<span class=\"n\">mathlib</span><span class=\"bp\">-</span><span class=\"n\">demo</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">3</span><span class=\"o\">:</span><span class=\"mi\">0</span>\n<span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">recursion</span><span class=\"w\"> </span><span class=\"n\">depth</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">increase</span><span class=\"w\"> </span><span class=\"n\">limit</span>\n<span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">diagnostic</span><span class=\"w\"> </span><span class=\"n\">information</span>\n</code></pre></div>",
        "id": 521099788,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1748527011
    },
    {
        "content": "<p>It's strange because the statement compiles if you use <code>sorry</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">me</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>but both the statement and proof are squiggle-lined when you supply the proof.</p>",
        "id": 521100081,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1748527097
    },
    {
        "content": "<p>It works just before <code>Nat.instCommMonoid</code> and fails just after, presumably because of the npow setup</p>",
        "id": 521100641,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1748527251
    },
    {
        "content": "<p>The lemma <code>Nat.pow_mod</code> uses the direct instance of <code>instNatPowNat</code>, whereas the expression you wrote down uses <code>Nat.instCommMonoid</code> for the exponentiation. To unify them, lean needs to check that the two instances are the same. It does this using WHNF. But that leads to a very big natural number that is too big.</p>",
        "id": 522455887,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749072976
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instNatPowNat#doc\">docs#instNatPowNat</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.instCommMonoid#doc\">docs#Nat.instCommMonoid</a></p>",
        "id": 522469478,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749080372
    },
    {
        "content": "<p>Do you think replacing <code>npow : _ -&gt; _ -&gt; M</code> with <code>[toNatPow : Pow Nat M]</code> would help?</p>",
        "id": 522469683,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749080505
    },
    {
        "content": "<p>No, I think the problem arises as soon as the instance isn't <code>==</code> to <code>instNatPowNat</code>. As long as it goes through <code>Monoid</code>, the instance won't be <code>==</code>. So this leads to lean calling WHNF on the expression <span aria-label=\"boom\" class=\"emoji emoji-1f4a5\" role=\"img\" title=\"boom\">:boom:</span></p>",
        "id": 522469853,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749080620
    },
    {
        "content": "<p>Is this a job for unification hints?</p>",
        "id": 522470093,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749080796
    },
    {
        "content": "<p>Or perhaps for reducibility hints, which I think exist somewhere?</p>",
        "id": 522470114,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749080810
    },
    {
        "content": "<p>It is an inherent limitation in <code>whnf</code>. <code>whnf</code> is (naturally) the first thing that <code>isDefEq</code> does. But when combined with natural number exponentiation, it blows up.</p>",
        "id": 522470172,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749080856
    },
    {
        "content": "<p>When the exponents aren't too big, you can set the exponentiation limit to be high enough</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">exponentiation</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">1000000</span>\n</code></pre></div>\n<p>But for really large exponents you get into trouble :(</p>",
        "id": 522470214,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749080888
    },
    {
        "content": "<p>The only way around it I can think of is to have <code>Nat.pow</code> being marked as irreducible, but of course this isn't desirable globally.</p>\n<p>Edit: we can't set this in the kernel, so the problem remains</p>",
        "id": 522470344,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749080981
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Proof.20breaks.20when.20I.20.60import.20Mathlib.2EAlgebra.2EGroup.2ENat.60/near/522470344\">said</a>:</p>\n<blockquote>\n<p>Edit: we can't set this in the kernel, so the problem remains</p>\n</blockquote>\n<p>Then make it settable!</p>",
        "id": 522471118,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1749081551
    },
    {
        "content": "<p>Arguably, the implementation of <code>Lean.Meta.reduceNat?</code> should be changed so that if the number is too big, it still returns a (as much as possible) reduced expression. And in particular it then avoids doing <code>whnf</code>.</p>\n<p>The trouble is, if we make this change, <code>whnf</code> doesn't anymore do what its name claims. Because e.g. <code>2 ^ 1000</code> isn't actually in weak head normal form.</p>",
        "id": 522471747,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749081872
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598052\">Jeremy Tan</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Proof.20breaks.20when.20I.20.60import.20Mathlib.2EAlgebra.2EGroup.2ENat.60/near/522471118\">said</a>:</p>\n<blockquote>\n<p>Then make it settable!</p>\n</blockquote>\n<p>I would agree it makes sense to make the kernel aware of what constants are <code>irreducible</code>. But making changes to the kernel is dangerous of course.</p>",
        "id": 522471962,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1749081998
    }
]