[
    {
        "content": "<p>I would like to change <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Logic/Equiv/Basic.html#Equiv.Perm.subtypeCongr\">Equiv.Perm.subtypeCongr</a> so that it has better defeqs - in particular I would like to avoid going via <code>sumCongr</code>. I keep running into the fact that it means that both this and <code>Equiv.perm.extendDomain</code> just are more annoying to use and give things based on them worse <code>simps</code> lemmas than one would otherwise want.</p>\n<p>(I think there's a bit of other work we could do in this related area - i.e. we could consider a non-MulHom version of <code>Equiv.Perm.ofSubtype</code> and the like - but that would be outside the scope of what I am proposing here.)</p>\n<p>I wanted to test the water first and ask people what they thought. Does this irritate anyone else or is it just me?</p>",
        "id": 529973849,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753136621
    },
    {
        "content": "<p>What defeq do you care about and why?</p>",
        "id": 529973984,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753136726
    },
    {
        "content": "<p>I would quite like it to be a dite-via-defeq. i.e. I would like <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Logic/Equiv/Basic.html#Equiv.Perm.subtypeCongr.apply\">Equiv.Perm.subtypeCongr.apply</a> (why isn't this subtypeCongr_apply, btw?) to be rfl.</p>",
        "id": 529974058,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753136772
    },
    {
        "content": "<p>As I say the main issue for me here is that using <code>simps</code> (or I suppose in particular <code>simps!</code>) on stuff based on it gives fairly useless lemmas - which means when you construct things using this they are just, well, a pain to use and you end up manually building API.</p>",
        "id": 529974296,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753136923
    },
    {
        "content": "<p>Does <code>simps +simpRhs</code> help?</p>",
        "id": 529974332,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753136947
    },
    {
        "content": "<p>No</p>",
        "id": 529974471,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137042
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">extendDomain_apply</span><span class=\"o\">:</span>\n<span class=\"w\">      </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_9</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_10</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">α'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β'</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidablePred</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α'</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β'</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">extendDomain</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sumCompl</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⇑</span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">permCongr</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">sumCompl</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 529974502,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137066
    },
    {
        "content": "<p>For an example of the kind of stuff generated (here by simps! +simpRHS - without the ! gives a warning)</p>",
        "id": 529974534,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137087
    },
    {
        "content": "<p>Wait, what are you putting <code>simps</code> on here?</p>",
        "id": 529974560,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753137098
    },
    {
        "content": "<p>Perm.extendDomain</p>",
        "id": 529974582,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137107
    },
    {
        "content": "<p>first example I thought of</p>",
        "id": 529974596,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137113
    },
    {
        "content": "<p>I think for me it's just not good that it exposes all this sum-related stuff, which really it doesn't particularly have anything to do with sum types except that it's a convenient construction to conjugate through them for this. But it's very straightforward to do things the more obvious way and it means you don't constantly get these horrible sum expressions</p>",
        "id": 529974733,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137188
    },
    {
        "content": "<p>It also then impacts Perm.ofSubtype because that's built on top of extendDomain (some of the order in which we define these things doesn't entirely make sense to me but that is again a different issues).</p>",
        "id": 529974895,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137291
    },
    {
        "content": "<p>This came about because I was effectively replicating this in a special case (permutations on Nat, predicate <code>&lt; n</code> for fixed n) and I realised that was silly, I should try and use the existing functions - but they are frustrating and cumbersome to use and they expose ugly internals to my eye.</p>",
        "id": 529974965,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137339
    },
    {
        "content": "<p><em>but</em> I think me just trying to bodge together a fix would be very bad - so I am not going to do a PR until, well, I've chatted about it a bit</p>",
        "id": 529975033,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137385
    },
    {
        "content": "<p>I've been doing this long enough now to know that keeping my \"just do a PR\" ego in check and talking about it is 95% of the time the better option.</p>",
        "id": 529975070,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137414
    },
    {
        "content": "<p>I think in this case the answer is \"just write the simp lemmas you want by hand\", <code>simps</code> isn't expected to be perfect everywhere</p>",
        "id": 529975335,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753137611
    },
    {
        "content": "<p>Fair. I think partially I'm also a little unsure what the best simps lemmas are for this kind of thing.</p>",
        "id": 529975417,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137675
    },
    {
        "content": "<p>I find the naming using for subtypeCongr/extendDomain and related somewhat ideosyncratic.</p>",
        "id": 529975464,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137695
    },
    {
        "content": "<p>Do you think it <em>is</em> better to use library functions like this when you can, or is it acceptable for a particular application to make a different, perhaps cleaner definition and just provide a lemma showing it can be implemented in some other way?</p>",
        "id": 529975596,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1753137751
    }
]