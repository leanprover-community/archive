[
    {
        "content": "<p>Jannis kindly pushed out a quick bugfix to a problem I was having with Aesop. I'd like to test out the new behaviour in a project I have downstream of Mathlib (and eventually use it in a Mathlib PR). What is the process for Mathlib dependencies being updated, and how can I see when it has happened? I'm happy to wait for whatever internal process but I don't know what exactly I'm waiting <em>for</em>.</p>",
        "id": 563720509,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765757589
    },
    {
        "content": "<p>If it's landed in aesop, mathlib should get it in due course through a PR like <a href=\"https://github.com/leanprover-community/mathlib4/pull/32647\">#32647</a></p>",
        "id": 563720667,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1765757825
    },
    {
        "content": "<p>Got it, thanks. Do you know how regularly the bot runs?</p>",
        "id": 563720686,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765757859
    },
    {
        "content": "<p>It looks like <a href=\"https://github.com/leanprover-community/mathlib4/blob/e7f9e396b9790970bc57d66bfec6091676938f27/.github/workflows/update_dependencies.yml\">this workflow</a> is scheduled for every hour?</p>",
        "id": 563721962,
        "sender_full_name": "Chris Henson",
        "timestamp": 1765759664
    },
    {
        "content": "<p>The PR is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/32878\">#32878</a> and it was opened 9 hours ago, however it looks like its build was taking longer than an hour so the scheduled workflow pushed new updates to it and CI was getting canceled repeatedly. I guess these updates corresponded to actual <a href=\"https://github.com/leanprover-community/aesop/commits/master/\">new commits to aesop</a>, so assuming Jannis is done for now, the build should finish this time <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 563722184,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1765759908
    },
    {
        "content": "<p>Yeah looks like the last time the <code>aesop</code> dependency was updated in <code>mathlib</code> is when Kim manually(?) bumped the toolchain</p>",
        "id": 563722436,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765760167
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20dependencies.20.28eg.20Aesop.29/near/563722184\">said</a>:</p>\n<blockquote>\n<p>The PR is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/32878\">#32878</a> and it was opened 9 hours ago, however it looks like its build was taking longer than an hour so the scheduled workflow pushed new updates to it and CI was getting canceled repeatedly. I guess these updates corresponded to actual <a href=\"https://github.com/leanprover-community/aesop/commits/master/\">new commits to aesop</a>, so assuming Jannis is done for now, the build should finish this time <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>\n</blockquote>\n<p>Oh right, I see! Interesting to get a glimpse of how the sausage is made, as it were. Thanks everyone.</p>\n<p>My understanding is that dependencies get updated pretty much instantly, in principle, but the dependency needs to stay the same for long enough that a build can finish.</p>",
        "id": 563722556,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765760310
    },
    {
        "content": "<p>Yeah, though if the build times stay long we may want to reduce the frequency of the workflow so we can at least get some of the incoming changes tested against mathlib. By the way, here are the threads where the build results should be reported; hopefully we'll see some results there in an hour or so:</p>\n<ul>\n<li><a href=\"#narrow/channel/428973-nightly-testing/topic/Mathlib.20.60lake.20update.60.20failure\">#nightly-testing &gt; Mathlib &#96;lake update&#96; failure</a> </li>\n<li><a href=\"#narrow/channel/428973-nightly-testing/topic/Mathlib.20.60lake.20update.60.20success\">#nightly-testing &gt; Mathlib &#96;lake update&#96; success</a></li>\n</ul>",
        "id": 563722899,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1765760650
    },
    {
        "content": "<p>oh wow <code>✔ [7746/7749] Built Mathlib.CategoryTheory.Limits.Shapes.Pullback.Categorical.Basic (3084s)</code></p>",
        "id": 563723069,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765760833
    },
    {
        "content": "<p>I commented on the PR and added a blocking label to it since we shouldn't merge this until this slowdown is addressed (the bot will keep putting the <code>auto-merge-after-CI</code> label on it). cc <span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> who I pinged on the PR too.</p>",
        "id": 563723984,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1765762031
    },
    {
        "content": "<p>Oh is this not normal? /gen</p>",
        "id": 563724017,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765762074
    },
    {
        "content": "<p>The same file took 23 seconds to build on a recent build of <code>master</code>: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20208676021/job/58011152402\">https://github.com/leanprover-community/mathlib4/actions/runs/20208676021/job/58011152402</a> (which is still long, but not 3000 seconds long)</p>",
        "id": 563724072,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1765762144
    },
    {
        "content": "<p>I'm taking a look at the performance regression. (I wonder how it's even possible for a file to take this long and not time out. ^^)</p>",
        "id": 563806248,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1765800728
    },
    {
        "content": "<p>There's something profoundly weird going on here. I've bisected the regression down to Aesop commit <a href=\"https://github.com/leanprover-community/aesop/commit/76b54a233cfe2c347b67ac25c40a4ec799b92672\"><code>76b54a2</code></a>. When I <code>lake build Mathlib/CategoryTheory/Limits/Shapes/Pullback/Categorical/Basic.lean</code> with this Aesop version, it does indeed take super long (and maybe doesn't finish at all; I was too impatient to let it run). However, when I <code>lake env lean Mathlib/CategoryTheory/Limits/Shapes/Pullback/Categorical/Basic.lean</code>, after building the dependencies, it finishes in reasonable time, but reports <code>sorry</code> warnings on two <em>other</em> declarations that appear before the declaration that times out. <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> any quick guesses what could be going on? What could be relevant differences between these two modes of operation?</p>",
        "id": 563880575,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1765819002
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/144\">https://github.com/leanprover-community/mathlib4-nightly-testing/pull/144</a> is also timing out. I don't see any particular evidence it is due to aesop, except that there's this thread about aesop causing time outs!</p>",
        "id": 563949243,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765846308
    },
    {
        "content": "<p>Can we just revert the changes to aesop and deploy them once tested? I'd prefer not to have to manually prevent aesop updates in nightly-testing/master in the meantime.</p>",
        "id": 563949307,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765846340
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20dependencies.20.28eg.20Aesop.29/near/563949243\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/144\">https://github.com/leanprover-community/mathlib4-nightly-testing/pull/144</a> is also timing out. I don't see any particular evidence it is due to aesop, except that there's this thread about aesop causing time outs!</p>\n</blockquote>\n<p>Sorry, false alarm, restarting CI fixed this.</p>",
        "id": 563957951,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765854368
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20dependencies.20.28eg.20Aesop.29/near/563880575\">said</a>:</p>\n<blockquote>\n<p>There's something profoundly weird going on here. I've bisected the regression down to Aesop commit <a href=\"https://github.com/leanprover-community/aesop/commit/76b54a233cfe2c347b67ac25c40a4ec799b92672\"><code>76b54a2</code></a>. When I <code>lake build Mathlib/CategoryTheory/Limits/Shapes/Pullback/Categorical/Basic.lean</code> with this Aesop version, it does indeed take super long (and maybe doesn't finish at all; I was too impatient to let it run). However, when I <code>lake env lean Mathlib/CategoryTheory/Limits/Shapes/Pullback/Categorical/Basic.lean</code>, after building the dependencies, it finishes in reasonable time, but reports <code>sorry</code> warnings on two <em>other</em> declarations that appear before the declaration that times out. <span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> any quick guesses what could be going on? What could be relevant differences between these two modes of operation?</p>\n</blockquote>\n<p>From a quick options bisection, looks like it's <code>-Dbackward.proofsInPublic=true</code>. So in other words, it appears that new restrictions introduced by the module system <em>would</em> make the file work here (probably by delaying some <code>by</code> blocks until mvars are assigned), except that because of incompatibilities of existing Mathlib code with these new restrictions, the restrictions are temporarily disabled and so we run the file with the semantics before the module system in this specific respect. So adding <code>set_option backward.proofsInPublic false</code> seems like a valid workaround to me as we do want this to be the Mathlib-global default eventually.</p>",
        "id": 563963910,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1765859541
    },
    {
        "content": "<p>Note that <a href=\"https://github.com/leanprover-community/mathlib4/pull/32934\">#32934</a> just got merged, which sets <code>proofsInPublic</code> to false globally.</p>",
        "id": 563979242,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1765870727
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/32945\">#32945</a> begins the process of removing them</p>",
        "id": 563987296,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1765874088
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/32878\">#32878</a> now builds quickly!</p>",
        "id": 564012206,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765882164
    },
    {
        "content": "<p>I found that <code>to_additive</code> is not correctly exporting hidden declarations. I tried removing the <code>backward.proofsInPublic</code> in <code>GroupTheory.OreLocalization.Basic</code> and got the following downstream errors:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">GroupTheory</span><span class=\"bp\">/</span><span class=\"n\">MonoidLocalization</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">197</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">translated</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">help</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">docstring</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"ss\">`to_additive</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"ss\">`Troubleshooting</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n<span class=\"n\">AddLocalization</span><span class=\"bp\">.</span><span class=\"n\">r_iff_oreEqv_r</span><span class=\"o\">:</span>\n<span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"ss\">`AddOreLocalization.oreEqv._proof_2</span><span class=\"bp\">`</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">GroupTheory</span><span class=\"bp\">/</span><span class=\"n\">MonoidLocalization</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">225</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">translated</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">help</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">docstring</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"ss\">`to_additive</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"ss\">`Troubleshooting</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n<span class=\"n\">AddLocalization</span><span class=\"bp\">.</span><span class=\"n\">mk_eq_mk_iff</span><span class=\"o\">:</span>\n<span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"ss\">`AddLocalization.r_iff_oreEqv_r</span><span class=\"bp\">`</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">GroupTheory</span><span class=\"bp\">/</span><span class=\"n\">MonoidLocalization</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">234</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">translated</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">help</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">docstring</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"ss\">`to_additive</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"ss\">`Troubleshooting</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n<span class=\"n\">AddLocalization</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"o\">:</span>\n<span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"ss\">`AddLocalization.mk_eq_mk_iff</span><span class=\"bp\">`</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">GroupTheory</span><span class=\"bp\">/</span><span class=\"n\">MonoidLocalization</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">271</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">translated</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">help</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">docstring</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"ss\">`to_additive</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"ss\">`Troubleshooting</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n<span class=\"n\">AddLocalization</span><span class=\"bp\">.</span><span class=\"n\">ndrec_mk</span><span class=\"o\">:</span>\n<span class=\"n\">Unknown</span><span class=\"w\"> </span><span class=\"n\">constant</span><span class=\"w\"> </span><span class=\"ss\">`AddLocalization.mk_eq_mk_iff</span><span class=\"bp\">`</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">GroupTheory</span><span class=\"bp\">/</span><span class=\"n\">MonoidLocalization</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">284</span><span class=\"o\">:</span><span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">20</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">p</span>\n</code></pre></div>",
        "id": 564034684,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1765889447
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> <span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> on the above to_additive find</p>",
        "id": 564036013,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765889829
    },
    {
        "content": "<p>Hmm, I think the issue may be that currently, the approach for translating auxiliary proofs is to unfold them, then do the whole translation, and then to refold them. But I think this is a bad approach for proofs generated by <code>proofsInPublic</code>, and instead we should not unfold them, but translate them directly.</p>\n<p>One anoying issue with that though is that the <code>dont_translate := ...</code> option doesn't get passed along.</p>",
        "id": 564037448,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765890249
    },
    {
        "content": "<p>Or it might just be a matter of exporting declarations that aren't being exported.</p>",
        "id": 564039583,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765890922
    },
    {
        "content": "<p>I've had a closer look, and it turns out that removing the <code>proofsInPublic</code> option causes<code>OreLocalization.oreEqv._proof_1</code> to instead be called <code>OreLocalization.oreEqv._proof_2</code>.</p>\n<p>But the additive version generated by <code>to_additive</code> is still <code>._proof_1</code>.</p>\n<p>So far, <code>to_additive</code> was relying on always one of these two things happening:</p>\n<ul>\n<li>The names just happen to have the same postfix (e.g. <code>_proof_1</code>), so it works out.</li>\n<li>The auxiliary theorem is never used again, so it's not a problem that we don't know how to translate it.</li>\n</ul>",
        "id": 564050725,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765894171
    },
    {
        "content": "<p>This looks like the same issue as <a class=\"stream-topic\" data-stream-id=\"239415\" href=\"/#narrow/channel/239415-metaprogramming-.2F-tactics/topic/to_additive.20.20and.20module.20system/with/561764674\">#metaprogramming / tactics &gt; to_additive  and module system</a>. It can be fixed by using <code>import all</code> on some modules.</p>",
        "id": 564051988,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1765894480
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20dependencies.20.28eg.20Aesop.29/near/564037448\">said</a>:</p>\n<blockquote>\n<p>Hmm, I think the issue may be that currently, the approach for translating auxiliary proofs is to unfold them, then do the whole translation, and then to refold them. But I think this is a bad approach for proofs generated by <code>proofsInPublic</code>, and instead we should not unfold them, but translate them directly.</p>\n<p>One anoying issue with that though is that the <code>dont_translate := ...</code> option doesn't get passed along.</p>\n</blockquote>\n<p>I don't know what <code>proofsInPublic</code> is, but the reason to unfold aux-decls is to get enough context to apply the <code>to_additive</code>-heuristics. If we don't unfold them, it can be very hard to decide what to additivize on an aux-decl.</p>",
        "id": 564052329,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1765894573
    },
    {
        "content": "<p>Ah right if you <code>import all</code>, then the aux theorem can be unfolded.</p>",
        "id": 564053684,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765894971
    },
    {
        "content": "<p>Is there a way to access a theorem body even if it has not explicitly been imported via <code>import all</code>?</p>",
        "id": 564055019,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765895311
    },
    {
        "content": "<p>Is there no way we could additivize the aux decl in the module it was declared in?</p>",
        "id": 564055971,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1765895576
    },
    {
        "content": "<p>If I recall correctly, that is what we did up to about a year ago, and then <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> changed it so that the proofs are unfolded, which was necessary in one of the lean version bumps?</p>",
        "id": 564058724,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765896285
    },
    {
        "content": "<p>What I'm remembering is that there was an improvement to the way proof terms are abstracted from definitions that unfortunately changed their types in such a way that they no longer were meaningful to <code>to_additive</code> — and that previously they were only <em>accidentally</em> meaningful. The fix Floris and I made was to unfold these proofs, since that way in context it was clear how to additivize. Then it would be sure to abstractNestedProofs for defs to put things back into a similar form.</p>\n<p>I don't recall <code>to_additive</code> needing the <code>_proof_1</code> postfixes needing to be the same, unless what you're saying <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> is that this is one of the conditions that happens to make the current code work when using the new module system.</p>\n<p>Why is it that additivization is happening across modules?</p>\n<p>If it's necessary, could there be a flag to make the abstracted proofs (and simp aux lemmas) necessary for a definition be exported?</p>",
        "id": 564082790,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1765902024
    },
    {
        "content": "<p>Yeah I take that back about the <code>_proof_1</code> postfixes having needed to match. But indeed now with the mulodule system this does happen to make the current code work when the postfixes match.</p>",
        "id": 564116863,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765912942
    },
    {
        "content": "<p>I have created <a href=\"https://github.com/leanprover-community/mathlib4/pull/33603\">#33603</a> to fix the issue, by not unfolding <code>_proof_i</code> theorem and instead translating them. Now, only <code>_simp_i</code> theorems are unfolded.</p>",
        "id": 566550732,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1767708651
    }
]