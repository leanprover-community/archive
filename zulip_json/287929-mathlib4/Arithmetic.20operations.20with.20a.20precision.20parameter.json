[
    {
        "content": "<p>Say I have a type T with bunch of arithmetic operations (Mul, Add, Div, Pow, etc.) but where each takes an extra <code>precision : Nat</code> parameter. Is there a nice way of representing things so that one can specify the overall precision of an expression with a bunch of arithmetic operators, and use normal arithmetic notation within the expression?</p>",
        "id": 470140847,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1726308562
    },
    {
        "content": "<p>That is, I want to be able to write something like <code>withPrec p (x * y + z)</code> and have it expand to <code>(x.mul y p).add z p</code> where <code>T.mul : T -&gt; T -&gt; (precision : Nat) -&gt; T</code> and similar.</p>",
        "id": 470145536,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1726310636
    },
    {
        "content": "<p>You can define a type synonym</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Prec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">T</span>\n</code></pre></div>\n<p>And then define instances on it which use the <code>prec</code>, and finally define</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">withPrec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prec</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">val</span>\n</code></pre></div>",
        "id": 470149607,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726311812
    },
    {
        "content": "<p>You might also need to define a coercion from <code>T</code> to <code>Prec n</code></p>",
        "id": 470150784,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1726312052
    },
    {
        "content": "<p>Nice, that's a lot simpler than the kind of type class implicit thing I was imagining.</p>",
        "id": 470155181,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1726313525
    },
    {
        "content": "<p>Another option is to have an <code>elab</code> that expands to <code>letI := myAddWithPrec p; letI := myMulWithPrec p; $arg</code></p>",
        "id": 470643471,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726499772
    },
    {
        "content": "<p>(where the two names are instances)</p>",
        "id": 470643544,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726499792
    }
]