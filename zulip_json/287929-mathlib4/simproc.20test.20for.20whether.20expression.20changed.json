[
    {
        "content": "<p>I'm writing my first simproc and there are many gaps in my knowlege. Here's a particular issue I am currently encountering: When the simproc runs on an expression and returns <code>.visit</code>, it <a href=\"https://github.com/leanprover/lean4/blob/51ae98ae30f72bc7a8942675b5910259f53b9130/src/Lean/Meta/Tactic/Simp/Types.lean#L312-L313\">is supposed</a> to check whether the simproc run actually changed the expression: if unchanged we continue, if changed then we send the expression back to the main loop, e.g. to see if some simp-lemmas now apply.</p>\n<p>I believe <a href=\"https://github.com/leanprover/lean4/blob/8b8561a699c951bab2e312b7d0963577f12c98b0/src/Lean/Meta/Tactic/Simp/Main.lean#L1039\">this</a> is the line where <code>simp</code> checks whether the simproc changed the expression. The check is done at the level of literal equality (<code>==</code>) of expressions.</p>\n<p>In some of my tests, the simproc gets run twice on seemingly identical impressions, apparently because they are not literally equal (e.g. the simproc has changed an occurrence of exponentiation to a different <code>Monoid ℚ</code> instance).</p>\n<p>Is this a common issue? Is it expected that simprocs be lightweight enough that running them repeatedly is harmless?</p>",
        "id": 529924523,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1753114824
    },
    {
        "content": "<p>BTW, the simproc is (experimentally) a replacement for <code>field_simp</code>! The context is that <span class=\"user-mention\" data-user-id=\"585783\">@Arend Mellendijk</span> <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> and I have been rewriting <code>field_simp</code> to follow a (hopefully smarter, faster and more flexible) algorithm.</p>\n<p>The old <code>field_simp</code> doesn't just clear denominators: it's implemented on top of <code>simp</code> and it does regular simp-ing, too.  For example,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- no denominators cleared here, just simp-ing</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span>\n</code></pre></div>\n<p>To preserve this behaviour, which users have come to expect, I was thinking of implementing the new <code>field_simp</code> as a simproc; that way it too can be wrapped into a normal simp call.</p>",
        "id": 529924706,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1753114908
    }
]