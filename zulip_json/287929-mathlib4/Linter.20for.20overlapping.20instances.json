[
    {
        "content": "<p>A common stumbling block when using type classes is that things go wrong when you have multiple data carrying local instances carrying different copies of the same data. This came up again today:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Dual.20Functor/near/566527076\">said</a>:</p>\n<blockquote>\n<p>We really really need a linter for this.</p>\n</blockquote>\n<p>So, I took a stab at writing such a linter. The code is in <a href=\"https://github.com/leanprover-community/mathlib4/pull/33677\">#33677</a>.</p>\n<p>And here's the list of the 84 current offenders: <a href=\"https://gist.github.com/JovanGerb/f104519064aa2d902dde64693e8341a3\">https://gist.github.com/JovanGerb/f104519064aa2d902dde64693e8341a3</a></p>",
        "id": 566602658,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1767725405
    },
    {
        "content": "<p>This is an environment linter, right? Could it be made a syntax linter, so that it gives feedback when writing the code, instead of when submitting a PR?</p>",
        "id": 566603026,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1767725581
    },
    {
        "content": "<p>There was also <a href=\"https://github.com/leanprover-community/mathlib4/pull/14731\">#14731</a>, although that is really outdated now.</p>",
        "id": 566603498,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1767725768
    },
    {
        "content": "<p>Hi Jovan! This looks great! Would you like to collaborate on making it a syntax linter? I think I can reuse some components used in the unusedInstancesInType linters to turn it into one without too much trouble.</p>",
        "id": 566605684,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767726641
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> yes, I would be happy to! I haven't made a syntax linter before. How hard is it for it to get access to the type of the declaration? In a perfect world, the linter would be able to run as soon as the type of a theorem has been written, without a proof, or with a partial proof.</p>",
        "id": 566618609,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1767732011
    },
    {
        "content": "<p>This particular task feels like a bit of a hack, but is ultimately sort of doable! :)</p>\n<p>What we (can) do is look through the infotrees for a <code>Lean.Elab.BodyInfo</code> representing the body. I <em>believe</em> this should be present even in the case of partial proofs, but haven't checked. Its child is a <code>TermInfo</code>, <code>PartialTermInfo</code>, or <code>TacticInfo</code>, which has a local context and expected type we can use (one way or another)!</p>",
        "id": 566620227,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767732718
    },
    {
        "content": "<p>Nice! A local context is all that we need for this linter.</p>",
        "id": 566620762,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1767732949
    },
    {
        "content": "<p>Alternatively, we can simply get the name of the declaration from the <code>parentDecl</code> at this point, and look for that in the environment. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.InfoTree.getDeclsByBody#doc\">docs#Lean.Elab.InfoTree.getDeclsByBody</a> However, I'm not sure if that works with partial proofs. This was the strategy I took in the unused instances in type linters, because (1) it was the simplest to implement and review (2) it was actually better performance-wise to use the type directly.</p>",
        "id": 566620768,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767732952
    },
    {
        "content": "<p>Shall I make a PR to your branch? Or, do you want to try writing your first syntax linter? :) Or! I could review your environment linter PR, and then you could review my syntax linter PR (which would be based on your environment linter infrastructure). I'm happy with any one of these! :)</p>",
        "id": 566620918,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767733032
    },
    {
        "content": "<p>Feel free to make a PR to my PR :)</p>",
        "id": 566621156,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1767733138
    },
    {
        "content": "<p>the biggest crime in that list is having a declaration simply known as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=impl#doc\">docs#impl</a></p>",
        "id": 566628930,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1767736975
    },
    {
        "content": "<p>My fault! :-) At least it is already deprecated.</p>\n<p>Can I say again: please, please, can we namespace Mathlib? :-)</p>",
        "id": 566632106,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767738865
    },
    {
        "content": "<p>4 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Namespacing.20Mathlib/with/566632905\">#mathlib4 &gt; Namespacing Mathlib</a> by <span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span>.</p>",
        "id": 566632906,
        "sender_full_name": "Notification Bot",
        "timestamp": 1767739449
    }
]