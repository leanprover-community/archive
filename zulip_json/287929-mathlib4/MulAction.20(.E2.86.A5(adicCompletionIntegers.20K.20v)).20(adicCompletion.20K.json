[
    {
        "content": "<p>I just ran into this timeout in FLT.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsFractionRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- set_option synthInstance.maxHeartbeats 80000 in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">MulAction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↥</span><span class=\"o\">(</span><span class=\"n\">adicCompletionIntegers</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Mathematically: K is a field, v is something you can complete K with respect to, getting a typically much bigger field <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>K</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">K_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>, and the claim is that the subring of integers of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>K</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">K_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> acts on <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>K</mi><mi>v</mi></msub></mrow><annotation encoding=\"application/x-tex\">K_v</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>. </p>\n<p>The problem is that the MulAction instances available to Lean are (in order</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[instances] #[@Submonoid.instMulActionSubtypeMem,\nMonoid.toMulAction,\n@MulDistribMulAction.toMulAction,\n@MulActionWithZero.toMulAction,\n@DistribMulAction.toMulAction, @GradedMonoid.GradeZero.mulAction, Action.FintypeCat.instMulActionCarrierOf,\n@Action.instMulAction, UniformSpace.Completion.instMulActionOfUniformContinuousConstSMul]\n</code></pre></div>\n<p>and the last one, which is the one tried first, is a disaster here because it says \"if X acts on K in a nice way then X acts on K_v\" and if we apply this to the integers of K_v then we get \"if the integers of K_v act on K (which they don't) in a nice way, then we're done\" and this takes a very long time to fail. Here's some commented trace for those interested:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>trace</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">```</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsFractionRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">synthInstance</span><span class=\"bp\">.</span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">80000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">MulAction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↥</span><span class=\"o\">(</span><span class=\"n\">adicCompletionIntegers</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- LieAlgebra.ofAssociativeAlgebra.toMulAction</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">  [Meta.synthInstance] [71393636.000000] ✅️ MulAction (↥(adicCompletionIntegers K v)) (adicCompletion K v) ▼</span>\n<span class=\"cm\">...(here's the question)</span>\n<span class=\"cm\">    [] [1119.000000] new goal MulAction (↥(adicCompletionIntegers K v)) (adicCompletion K v) ▼</span>\n<span class=\"cm\">...(what instances are available?)</span>\n<span class=\"cm\">      [instances] #[@Submonoid.instMulActionSubtypeMem, Monoid.toMulAction, @MulDistribMulAction.toMulAction, @MulActionWithZero.toMulAction, @DistribMulAction.toMulAction, @GradedMonoid.GradeZero.mulAction, Action.FintypeCat.instMulActionCarrierOf, @Action.instMulAction, UniformSpace.Completion.instMulActionOfUniformContinuousConstSMul]</span>\n<span class=\"cm\">    [] [6410.000000] ✅️ apply UniformSpace.Completion.instMulActionOfUniformContinuousConstSMul to MulAction</span>\n<span class=\"cm\">          (↥(adicCompletionIntegers K v)) (adicCompletion K v) ▼</span>\n<span class=\"cm\">(uh-uh, mathematically incorrect move; action of R_v on K_v not induced by action of R_v on K)</span>\n<span class=\"cm\">      [] [827.000000] new goal MulAction (↥(adicCompletionIntegers K v)) (WithVal (valuation K v)) ▶</span>\n<span class=\"cm\">(can't be solved, but off we go)</span>\n\n<span class=\"cm\">    [] [732878.000000] ❌️ apply @NormedAlgebra.toAlgebra to Algebra (↥(adicCompletionIntegers K v)) K ▶</span>\n<span class=\"cm\">    [] [3956.000000] ✅️ apply @Bialgebra.toAlgebra to Algebra (↥(adicCompletionIntegers K v)) K ▶</span>\n<span class=\"cm\">    [] [3856.000000] ✅️ apply @HopfAlgebraStruct.toBialgebra to Bialgebra (↥(adicCompletionIntegers K v)) K ▶</span>\n<span class=\"cm\">    [] [3864.000000] ✅️ apply @HopfAlgebra.toHopfAlgebraStruct to HopfAlgebraStruct (↥(adicCompletionIntegers K v)) K ▶</span>\n<span class=\"cm\">    [] [1549.000000] ❌️ apply CommSemiring.toHopfAlgebra to HopfAlgebra (↥(adicCompletionIntegers K v)) K ▶</span>\n<span class=\"cm\">    [] [1480.000000] ❌️ apply CommSemiring.toBialgebra to Bialgebra (↥(adicCompletionIntegers K v)) K ▶</span>\n<span class=\"cm\">    [] 509 more entries... ▶</span>\n<span class=\"cm\">(yikes)</span>\n<span class=\"cm\">... etc etc</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n</div></div>\n<p>So OK we've seen this sort of thing before, and my first thought was \"just make <code>adicCompletion K v</code> a def instead of an abbrev, and this will solve the problem\". So I started on this with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- was `abbrev`</span>\n<span class=\"sd\">/-- The completion of `K` with respect to its `v`-adic valuation. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valued</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Multiplicative</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Valued</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Multiplicative</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithVal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\">  </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithVal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span>\n</code></pre></div>\n<p>but then I realised when fixing up the next <code>sorry</code> that this probably wasn't actually going to solve the problem, because we still have the explicit instance</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">IsDedekindDomain</span><span class=\"bp\">.</span><span class=\"n\">HeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">instAlgebraAdicCompletion</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsFractionRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>in mathlib, and looking at the trace, all the problems are coming from the failure to find the non-existing <code>MulAction (adicCompletion K v) (WithVal (valuation K v))</code>, which of course appears for the same reason that integer rings were timing out -- if <code>(S : Subring R)</code> then one very natural way of finding an action of <code>↥S</code> on something is to find an action of <code>R</code> on the same thing.</p>\n<p>I'm writing all of this because I can see the problem and I can see several solutions but I don't know which one I should be persevering with. The cheap solution is an instance shortcut</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MulAction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletionIntegers</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">toModule</span><span class=\"bp\">.</span><span class=\"n\">toMulAction</span>\n</code></pre></div>\n<p>just after the definition of <code>v.adicCompletionIntegers</code> which then puts this instance after the bad (in this case) completion instance in the list and solves everything. But is this a hack?</p>\n<p>Another approach is to reduce the priority of <code>UniformSpace.Completion.instMulActionOfUniformContinuousConstSMul</code> but that feels like even more of a hack (and for all I know it's the right answer in lots of places in another corner of mathlib).</p>\n<p>Finally one other approach <em>might</em> be to change the definition of <code>adicCompletion</code> from an abbrev to a def, but as I say we still have some explicit instances with default prio in mathlib which are specific to adic completions of the \"bad\" form, so I am not even convinced that this will solve anything. It would start like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- used to be `abbrev`</span>\n<span class=\"sd\">/-- The completion of `K` with respect to its `v`-adic valuation. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valued</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Multiplicative</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Valued</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithZero</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Multiplicative</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithVal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\">  </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithVal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Completion</span>\n</code></pre></div>\n<p>but then the big question is whether this will actually solve anything, and it will be a pretty gnarly job getting mathlib compiling again.</p>",
        "id": 564917166,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1766353724
    },
    {
        "content": "<p>My new test minimizer says that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">NonAssoc</span><span class=\"bp\">.</span><span class=\"n\">LieAdmissible</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Action</span><span class=\"bp\">.</span><span class=\"n\">Concrete</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">DedekindDomain</span><span class=\"bp\">.</span><span class=\"n\">AdicValuation</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Normed</span><span class=\"bp\">.</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsFractionRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: failed to synthesize</span>\n<span class=\"sd\">  MulAction (↥(adicCompletionIntegers K v)) (adicCompletion K v)</span>\n<span class=\"sd\">(deterministic) timeout at `typeclass`, maximum number of heartbeats (20000) has been reached</span>\n\n<span class=\"sd\">Note: Use `set_option synthInstance.maxHeartbeats &lt;num&gt;` to set the limit.</span>\n\n<span class=\"sd\">Hint: Additional diagnostic information may be available using the `set_option diagnostics true` command.</span>\n\n<span class=\"sd\">Hint: Additional diagnostic information may be available using the `set_option diagnostics true` command.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">MulAction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↥</span><span class=\"o\">(</span><span class=\"n\">adicCompletionIntegers</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>is the minimal set of imports to exhibit this timeout (with the standard threshold).</p>",
        "id": 564927150,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766368574
    },
    {
        "content": "<p>This can be reproduced ( <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span>) by running <code>lake exe minimize --no-inline MathlibMinimizer/AdicCompletion.lean</code> in <a href=\"https://github.com/kim-em/mathlib-minimizer\">https://github.com/kim-em/mathlib-minimizer</a></p>",
        "id": 564927230,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766368706
    },
    {
        "content": "<p>I tried running the minimizer further, reaching <a href=\"https://gist.github.com/kim-em/bfac3c95d711f9696453a4e36898b3c8\">this</a> point. It certainly hasn't minimized all the way.</p>\n<p>Interestingly, inlining <code>import Mathlib.RingTheory.DedekindDomain.Ideal.Basic</code> at that point causes the error message to change from the timeout to a time mismatch at <code>mul_assoc</code>.</p>",
        "id": 564945595,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766387810
    },
    {
        "content": "<p>So it's very cool that this tool exists!</p>\n<p>In this particular case however, it's clear what is going wrong. There is no specific \"bad instance\" or anything; the system is performing as expected. </p>\n<p>1) I have <code>R : ValuationSubring A</code> and want to find <code>SMul ↥R A</code><br>\n2) As well as all the few sensible routes to <code>SMul</code> (including several for which typeclass inference would terminate almost instantly) there is the more exotic <code>UniformSpace.Completion.instSMul</code> which is defined far later on and thus is tried first; it applies here because <code>A</code> is indeed the completion of  another ring <code>K</code>.<br>\n3) But oh dear, <code>↥R</code> doesn't actually act on <code>K</code> because R is too big (it is also a completion so doesn't act on the uncompleted thing).<br>\n4) Let's spend a very long time failing, not least because one way to get <code>↥R</code> to act on <code>K</code> is to get <code>A</code> acting on <code>K</code> and again this can't happen mathematically because <code>A</code> is the completion of <code>K</code> and thus much bigger.</p>\n<p>One can see a baby version of this with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"w\"> </span><span class=\"n\">ℝ</span>\n</code></pre></div>\n<p>This action doesn't exist mathematically, but boy is it an adventure checking every corner of mathlib seeing if there's something which can help. C*-algebras, normed groups, Hopf algebras, preadditive categories, pseudometric spaces, graded monoids, pre-Lie-algebras and more. They're all in the trace; none of them last long but it does all add up.</p>\n<p>Is it possible to cache a typeclass failure pre-emptively? After the definition of adicCompletionIntegers it would be nice to say \"...and don't ever bother looking for an action on the un-adically-completed thing because it's not there\"; this would be another way of guiding typeclass inference in the right direction. </p>\n<p>In <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/808\">FLT#808</a> (where this came up; a mathlib bump made something time out) I just added shortcut instances</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletionIntegers</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">toModule</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MulAction</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletionIntegers</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">toModule</span><span class=\"bp\">.</span><span class=\"n\">toMulAction</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletionIntegers</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">adicCompletion</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">toModule</span><span class=\"bp\">.</span><span class=\"n\">toMulAction</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span>\n</code></pre></div>\n<p>which I suspect will solve all problems for me. I am just unclear about whether this sort of thing is a hack and should be avoided, or whether asking that typeclass inference \"becomes better\" or \"stops asking stupid questions\" is just a ridiculous goal and that instance shortcuts are fine.</p>",
        "id": 565014501,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1766413649
    },
    {
        "content": "<p>We're planning on working on typeclass search again in the new year!</p>\n<p>Examples where it feels like being able to pre-emptively fail a search is necessary are great. No guarantees we'd make that possible (simplicity matters here), of course.</p>",
        "id": 565097775,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1766464575
    }
]