[
    {
        "content": "<p>For the single-sorted first-order language of R-modules <code>deriving IsAlgebraic</code> not working, I wonder why that it.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">ModelTheory</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">FirstOrder</span><span class=\"bp\">.</span><span class=\"n\">Language</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">neg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span>\n\n<span class=\"sd\">/-- The language of R-modules over a semiring R contains the operations (+, 0, -, r • x) for every r : R and no relation. -/</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">semiringModule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Functions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">Relations</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Empty</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">IsAlgebraic</span><span class=\"w\">  </span><span class=\"c1\">-- why is this not working?</span>\n</code></pre></div>",
        "id": 533473926,
        "sender_full_name": "Sina Hazratpour",
        "timestamp": 1754663001
    },
    {
        "content": "<p>Can you make a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 533474841,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754663346
    },
    {
        "content": "<p>this is basically the mwe!</p>",
        "id": 533475028,
        "sender_full_name": "Sina Hazratpour",
        "timestamp": 1754663410
    },
    {
        "content": "<p>you are missing imports</p>",
        "id": 533475084,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754663430
    },
    {
        "content": "<p>(It's a lot easier to help people when there's code that can be copied into an editor; it's a courtesy for the community since then you don't have a handful of people each trying to get the code to run.)</p>",
        "id": 533475296,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754663498
    },
    {
        "content": "<p>I guess </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">ModelTheory</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n</code></pre></div>\n<p>should do.</p>",
        "id": 533475371,
        "sender_full_name": "Sina Hazratpour",
        "timestamp": 1754663527
    },
    {
        "content": "<p>also <code>open FirstOrder</code>, i think</p>",
        "id": 533475442,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754663556
    },
    {
        "content": "<p>Can you edit that into your original message?</p>",
        "id": 533475459,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754663561
    },
    {
        "content": "<p>also also, i think the <code>Language</code> field is <code>Functions</code></p>",
        "id": 533475499,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754663584
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60deriving.20IsAlgebraic.60.20not.20working/near/533475499\">said</a>:</p>\n<blockquote>\n<p>also also, i think the <code>Language</code> field is <code>Functions</code></p>\n</blockquote>\n<p>fixed it.</p>",
        "id": 533476258,
        "sender_full_name": "Sina Hazratpour",
        "timestamp": 1754663848
    },
    {
        "content": "<p><del>the deriving issue is a confusion between <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsAlgebraic#doc\">docs#IsAlgebraic</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FirstOrder.Language.IsAlgebraic#doc\">docs#FirstOrder.Language.IsAlgebraic</a></del> the previous is something to note when trying to make a MWE for this, but does not seem to be the issue at hand</p>",
        "id": 533477143,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664117
    },
    {
        "content": "<p>Is there a deriving handler for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FirstOrder.Language.IsAlgebraic#doc\">docs#FirstOrder.Language.IsAlgebraic</a>, how does it work?</p>",
        "id": 533477665,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754664267
    },
    {
        "content": "<p>the deriving handler is the one for <code>IsEmpty</code> i think</p>",
        "id": 533477720,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664286
    },
    {
        "content": "<p>Maybe since it's an abbrev it gets seen through?</p>",
        "id": 533477727,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754664289
    },
    {
        "content": "<p>yea, exactly</p>",
        "id": 533477743,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664296
    },
    {
        "content": "<p>i believe the issue might be that it tries to derive <code>IsAlgebraic (fun R _ =&gt; SemiringModule R)</code></p>",
        "id": 533477874,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664342
    },
    {
        "content": "<p>that doesn't typecheck?</p>",
        "id": 533477992,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754664377
    },
    {
        "content": "<p>you see the same issue with this variant of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FirstOrder.Language.empty#doc\">docs#FirstOrder.Language.empty</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">empty'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Empty</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Empty</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">IsAlgebraic</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">IsRelational</span>\n</code></pre></div>",
        "id": 533478008,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664384
    },
    {
        "content": "<p>(the code is the same as the one in mathlib, except that it has an argument)</p>",
        "id": 533478051,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664404
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60deriving.20IsAlgebraic.60.20not.20working/near/533477992\">said</a>:</p>\n<blockquote>\n<p>that doesn't typecheck?</p>\n</blockquote>\n<p>that might be why the deriving handler fails when the definition has arguments, actually</p>",
        "id": 533478153,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664444
    },
    {
        "content": "<p>oh yeah I just checked</p>",
        "id": 533478186,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754664455
    },
    {
        "content": "<p>it's trying to unify <code>Type u → Language =?= Language</code></p>",
        "id": 533478221,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754664470
    },
    {
        "content": "<p><code>set_option trace.Meta.isDefEq true</code> is amazing</p>",
        "id": 533478307,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754664502
    },
    {
        "content": "<p>i guess that means the conclusion is: the <code>IsEmpty</code> deriving handler is bugged, and doesn't think about things having arguments</p>",
        "id": 533478450,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754664564
    },
    {
        "content": "<p>This is a \"def deriving\", and the way it works is that it uses the value of the definition to try to synthesize an instance. There's no deriving handler except for <code>processDefDeriving</code>.</p>",
        "id": 533478471,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754664570
    },
    {
        "content": "<p>It looks like it just doesn't support the case where there are arguments. This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">semiringModule</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Functions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"n\">Relations</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Empty</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">IsAlgebraic</span>\n</code></pre></div>",
        "id": 533478746,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754664676
    },
    {
        "content": "<p>Interesting! <br>\nThis doesn't though: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsAlgebraic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">semiringModule</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n</code></pre></div>",
        "id": 533478923,
        "sender_full_name": "Sina Hazratpour",
        "timestamp": 1754664741
    },
    {
        "content": "<p>Side note about design: there's no need to include <code>[Semiring R]</code> in the inductive type itself I believe. Not including it could make some things easier. This doesn't solve your problem, but I thought I'd mention it.</p>",
        "id": 533478984,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754664761
    },
    {
        "content": "<p>That's expected <span class=\"user-mention\" data-user-id=\"420917\">@Sina Hazratpour</span>, since you need to unfold <code>semiringModule</code> first, since typeclass inference won't look through the definition.</p>",
        "id": 533479110,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754664805
    },
    {
        "content": "<p>Ah, I see. Thanks for explaining this.</p>",
        "id": 533479190,
        "sender_full_name": "Sina Hazratpour",
        "timestamp": 1754664835
    },
    {
        "content": "<p>Def deriving is a convenience to avoid needing to write the following <code>instance</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">semiringModule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Functions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SemiringModuleFunc</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">Relations</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Empty</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsAlgebraic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">semiringModule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">semiringModule</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n</code></pre></div>",
        "id": 533479443,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754664916
    },
    {
        "content": "<p>(It looks like this will be easy to fix; maybe in a week or two when the next Lean release comes out this will work.)</p>",
        "id": 533481505,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1754665629
    },
    {
        "content": "<p>nice!</p>",
        "id": 533516437,
        "sender_full_name": "Sina Hazratpour",
        "timestamp": 1754681524
    }
]