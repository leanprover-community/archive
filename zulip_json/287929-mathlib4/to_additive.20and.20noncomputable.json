[
    {
        "content": "<p>The plain <code>@[to_additive]</code> decorator does not properly transmit <code>noncomputable</code> to the derived definition. It works fine if the tagging is done after the fact:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Tactic.ToAdditive</span>\n\n<span class=\"kd\">@[to_additive Bar]</span>\n<span class=\"kd\">def</span> <span class=\"n\">Foo</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">a</span>\n\n<span class=\"kd\">@[to_additive Bar.bar]</span> <span class=\"c1\">-- this does not work</span>\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">Foo.foo</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"bp\">∃</span> <span class=\"n\">_</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">True</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">Classical.choose</span> <span class=\"n\">h</span>\n\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">Foo.foo2</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"bp\">∃</span> <span class=\"n\">_</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">True</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">Classical.choose</span> <span class=\"n\">h</span>\n<span class=\"kd\">noncomputable</span> <span class=\"kd\">def</span> <span class=\"n\">Bar.baz</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"bp\">∃</span> <span class=\"n\">_</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">,</span> <span class=\"n\">True</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">α</span> <span class=\"o\">:=</span> <span class=\"n\">Classical.choose</span> <span class=\"n\">h</span>\n\n<span class=\"kn\">attribute</span> <span class=\"o\">[</span><span class=\"n\">to_additive</span> <span class=\"n\">Bar.baz</span><span class=\"o\">]</span> <span class=\"n\">Foo.foo2</span> <span class=\"c1\">-- this works</span>\n</code></pre></div>",
        "id": 310541981,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1668657965
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/625\">mathlib4#625</a></p>",
        "id": 310611650,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1668692561
    },
    {
        "content": "<p>I have run into this issue again. The following doesn't work</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">SMul</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MonoidAlgebra</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"bp\">→₀</span><span class=\"w\"> </span><span class=\"n\">k</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MonoidAlgebra</span><span class=\"bp\">.</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonoidAlgebra</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">failed to compile definition,</span>\n<span class=\"cm\">compiler IR check failed at 'AddMonoidAlgebra.single._redArg'.</span>\n<span class=\"cm\">Error: depends on declaration 'Finsupp.single',</span>\n<span class=\"cm\">which has no executable code;</span>\n<span class=\"cm\">consider marking definition as 'noncomputable'</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 534917764,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755512603
    },
    {
        "content": "<p>Just add <code>noncomputable</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MonoidAlgebra</span><span class=\"bp\">.</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonoidAlgebra</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>\n<p>apparently works.</p>",
        "id": 534920537,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755513703
    },
    {
        "content": "<p>This is the workaround we currently use I think</p>",
        "id": 534920752,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755513781
    },
    {
        "content": "<p><code>Finsupp.single</code> is noncomputable so even without <code>to_additive</code> you need to write <code>noncomputable</code> for any def depending on it. (or use <code>noncomputable section</code>)</p>",
        "id": 534920943,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755513855
    },
    {
        "content": "<p>Yes, I used <code>noncomputable section</code>. But for some reason that doesn't work, and <code>noncomputable</code> does work.</p>",
        "id": 534921762,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755514127
    },
    {
        "content": "<p>i guess the auto gen can't see noncomputable section</p>",
        "id": 534922258,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755514291
    },
    {
        "content": "<p>I wonder how good LLMs (e.g. Claude) are at producing working code that fixes this ...</p>",
        "id": 534933577,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755518038
    },
    {
        "content": "<p>LLM needs data, and we don't have a lot of meta code</p>",
        "id": 534948161,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755522364
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>, are you heavily modifying <code>Algebra.MonoidAlgebra.Defs</code>? If so, please be aware that we'll get monster conflicts with <a href=\"https://github.com/leanprover-community/mathlib4/pull/25273\">#25273</a></p>",
        "id": 534971374,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755529640
    },
    {
        "content": "<p>I am <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n<p>But I'm also doing this in order to test the new <code>to_additive</code> heuristic. So it might make more sense to merge your change first, and then use <code>@[to_additive]</code> in the file afterwards?</p>",
        "id": 534984064,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755533813
    },
    {
        "content": "<p>(Note: currently fixing the noncomputable section issue in <code>to_additive</code>, unless someone has beaten me to it :) )</p>",
        "id": 534985073,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1755534245
    },
    {
        "content": "<p>Oops, maybe I spoke too soon. The flag set by <code>noncomputable section</code> lives in the <code>CommandElabM</code> state (namely, the scopes) but we seem to only have access to <code>CoreM</code> when adding attributes. Hmm.</p>",
        "id": 534987441,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1755535274
    },
    {
        "content": "<p>(Hopefully we can access the noncomputability indirectly through the decl if we're careful—let me see if I can get this to work.)</p>",
        "id": 534987995,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1755535553
    },
    {
        "content": "<p>Huh, turns out that we don't ever mark the definitions in a <code>noncomputable</code> section <code>noncomputable</code> in the <code>noncomputable</code> extension—we just refrain from logging errors when compiling (hence why the current approach in <code>to_additive</code> doesn't work)! I wonder if this ought to be changed. (I'll see if I can detect whether compilation has occurred or not, regardless.)</p>",
        "id": 534990468,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1755536735
    },
    {
        "content": "<p>If we merge your changes first, then my changes are half as short!</p>",
        "id": 535010861,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755545877
    },
    {
        "content": "<p>I've got it working by checking for executable code, but this has the slightly unfortunate side effect of successfully adding a generated noncomputable definition even when the original is loudly failing to compile (due to being outside of <code>noncomputable section</code>)—hence, the original declaration has no executable code, but <code>to_additive</code> has no way of telling that it \"should\". (We can't look for messages in the log or anything in the infotree, since these are reset before running <code>add</code>.)</p>\n<p>I think this is generally fine as a workaround, though, since we will never have an error in final code.</p>\n<p>Ideally, I think everything noncomputable in a <code>noncomputable section</code> should get marked noncomputable, but this is a core change I don't think we should wait for.</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28610\">#28610</a></p>",
        "id": 535013552,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1755547052
    }
]