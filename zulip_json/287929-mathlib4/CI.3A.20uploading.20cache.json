[
    {
        "content": "<p>In the \"Upload Archive and Counterexamples cache to Azure\" step (on <a href=\"https://github.com/leanprover-community/mathlib4/pull/29649\">#29649</a>) I see lots of lines</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Transfer failed (error code: 201)\n</code></pre></div>\n<p>interspersed with stuff like</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Non-JSON output from curl:\n  ﻿&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;Error&gt;&lt;Code&gt;BlobAlreadyExists&lt;/Code&gt;&lt;Message&gt;The specified blob already exists.\noffset 0: unexpected input\nNon-JSON output from curl:\n  RequestId:0c6c11af-701e-005c-65b1-25ecc5000000\noffset 0: unexpected input\nNon-JSON output from curl:\n  Time:2025-09-14T19:57:50.8630653Z&lt;/Message&gt;&lt;/Error&gt;{\"certs\":\"\",\"content_type\":\"application/xml\",\"conn_id\":40,\"errormsg\":null,\"exitcode\":0,\"filename_effective\":null,\"ftp_entry_path\":null,\"http_code\":409,\"http_connect\":0,\"http_version\":\"1.1\",\"local_ip\":\"172.17.0.2\",\"local_port\":51958,\"method\":\"PUT\",\"num_certs\":0,\"num_connects\":0,\"num_headers\":7,\"num_redirects\":0,\"proxy_ssl_verify_result\":0,\"redirect_url\":null,\"referer\":null,\"remote_ip\":\"20.209.19.193\",\"remote_port\":443,\"response_code\":409,\"scheme\":\"HTTPS\",\"size_download\":220,\"size_header\":311,\"size_request\":372,\"size_upload\":62481,\"speed_download\":6925,\"speed_upload\":1966976,\"ssl_verify_result\":0,\"time_appconnect\":0.000000,\"time_connect\":0.000000,\"time_namelookup\":0.000016,\"time_pretransfer\":0.000048,\"time_redirect\":0.000000,\"time_starttransfer\":0.031757,\"time_total\":0.031765,\"url\":\"https://lakecache.blob.core.windows.net/mathlib4/f/MichaelStollBayreuth/mathlib4/77cf339325021eac.ltar?***\",\"url.scheme\":\"https\",\"url.user\":null,\"url.password\":null,\"url.options\":null,\"url.host\":\"lakecache.blob.core.windows.net\",\"url.port\":\"443\",\"url.path\":\"/mathlib4/f/MichaelStollBayreuth/mathlib4/77cf339325021eac.ltar\",\"url.query\":\"***\",\"url.fragment\":null,\"url.zoneid\":null,\"urle.scheme\":\"https\",\"urle.user\":null,\"urle.password\":null,\"urle.options\":null,\"urle.host\":\"lakecache.blob.core.windows.net\",\"urle.port\":\"443\",\"urle.path\":\"/mathlib4/f/MichaelStollBayreuth/mathlib4/77cf339325021eac.ltar\",\"urle.query\":\"***\",\"urle.fragment\":null,\"urle.zoneid\":null,\"url_effective\":\"https://lakecache.blob.core.windows.net/mathlib4/f/MichaelStollBayreuth/mathlib4/77cf339325021eac.ltar?***\",\"urlnum\":1833,\"xfer_id\":1833,\"curl_version\":\"libcurl/8.5.0 OpenSSL/3.0.13 zlib/1.3 brotli/1.1.0 zstd/1.5.5 libidn2/2.3.7 libpsl/0.21.2 (+libidn2/2.3.7) libssh/0.10.6/openssl/zlib nghttp2/1.59.0 librtmp/2.3 OpenLDAP/2.6.7\"}\noffset 0: unexpected input\n</code></pre></div>\n<p>There is also a number of lines like</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Uploaded: 0 file(s) [attempted 7280/7282 = 99%, 621 KB/s], 7280 failed\n</code></pre></div>\n<p>In line 8123 it says</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Compressing cache\nAttempting to upload 7224 file(s) to MichaelStollBayreuth/mathlib4 cache\n</code></pre></div>\n<p>followed by a further sea of messages like</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>offset 0: unexpected input\nTransfer failed (error code: 201)\nNon-JSON output from curl:\n  ﻿&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;Error&gt;&lt;Code&gt;BlobAlreadyExists&lt;/Code&gt;&lt;Message&gt;The specified blob already exists.\n</code></pre></div>\n<p>(there are also quite long renderings of \"Non-JSON output from curl\"). The log has &gt; 70000 lines.<br>\nThe following step (uploading to Cloudflare) looks OK, though, and CI passes.</p>\n<p>Is this something one should be worried about?</p>",
        "id": 539436351,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1757880741
    },
    {
        "content": "<p>If CI passes then it's probably OK, but maybe <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> will be interested (?).</p>",
        "id": 539438237,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1757882827
    },
    {
        "content": "<p>Hmm... in practice it seems the Azure cache actually works, so I'm not sure what to make of this.</p>",
        "id": 539448187,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757895839
    },
    {
        "content": "<p>I am also having a similar issue on <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/70\">mathlib4-nightly-testing#70</a>, and in this case the cache does NOT appear to be working...</p>",
        "id": 540813073,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1758549792
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/17917789817/job/50944481384#step:24:63350\">https://github.com/leanprover-community/mathlib4-nightly-testing/actions/runs/17917789817/job/50944481384#step:24:63350</a></p>",
        "id": 540830780,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1758553874
    },
    {
        "content": "<p>See here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">upload</span><span class=\"w\"> </span><span class=\"mi\">7225</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">linesthatinterlace</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n<span class=\"n\">Non</span><span class=\"bp\">-</span><span class=\"n\">JSON</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">curl</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">﻿&lt;?</span><span class=\"n\">xml</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"bp\">=</span><span class=\"s2\">\"1.0\"</span><span class=\"w\"> </span><span class=\"n\">encoding</span><span class=\"bp\">=</span><span class=\"s2\">\"utf-8\"</span><span class=\"bp\">?&gt;&lt;</span><span class=\"n\">Error</span><span class=\"bp\">&gt;&lt;</span><span class=\"n\">Code</span><span class=\"bp\">&gt;</span><span class=\"n\">BlobAlreadyExists</span><span class=\"bp\">&lt;/</span><span class=\"n\">Code</span><span class=\"bp\">&gt;&lt;</span><span class=\"n\">Message</span><span class=\"bp\">&gt;</span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">specified</span><span class=\"w\"> </span><span class=\"n\">blob</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"bp\">.</span>\n<span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unexpected</span><span class=\"w\"> </span><span class=\"n\">input</span>\n<span class=\"n\">Non</span><span class=\"bp\">-</span><span class=\"n\">JSON</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">curl</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">RequestId</span><span class=\"o\">:</span><span class=\"n\">ee7f1f9b</span><span class=\"bp\">-</span><span class=\"mi\">701</span><span class=\"n\">e</span><span class=\"bp\">-</span><span class=\"mi\">005</span><span class=\"n\">c</span><span class=\"bp\">-</span><span class=\"mi\">05</span><span class=\"n\">d0</span><span class=\"bp\">-</span><span class=\"mi\">2</span><span class=\"n\">becc5000000</span>\n<span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unexpected</span><span class=\"w\"> </span><span class=\"n\">input</span>\n</code></pre></div>",
        "id": 540830842,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1758553887
    },
    {
        "content": "<p>Don't know if I have something misconfigured</p>",
        "id": 540830900,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1758553901
    },
    {
        "content": "<p>This is still happening and it's causing me some major issues.</p>",
        "id": 540879134,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1758568608
    },
    {
        "content": "<p>I have made <a href=\"https://github.com/leanprover-community/batteries/issues/1425\">https://github.com/leanprover-community/batteries/issues/1425</a></p>",
        "id": 540906825,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1758582939
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20uploading.20cache/near/539436351\">said</a>:</p>\n<blockquote>\n<p>In the \"Upload Archive and Counterexamples cache to Azure\" step I see lots of lines...</p>\n</blockquote>\n<p>I again or still see lines</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Non-JSON output from curl:\n</code></pre></div>\n<p>followed by seemingly random text (see <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19078538590/job/54500624618?pr=29649\">here</a>). It does not look to me like this is supposed to be so. Maybe somebody can look at it again? <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> ?</p>\n<p>EDIT: Maybe merging master helps. I'm trying this right now...</p>",
        "id": 553687199,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762280870
    },
    {
        "content": "<p>I've been tracking issues caused by this here: <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.22verify.20that.20everything.20was.20available.20in.20the.20cache.22.20fails.20CI/with/553615876\">#mathlib4 &gt; \"verify that everything was available in the cache\" fails CI</a> </p>\n<p>It seems that merging <code>master</code> usually fixes it, but not always (sometimes <code>master</code> has to be merged again after more commits have landed).</p>",
        "id": 553687888,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762281085
    },
    {
        "content": "<p>After merging master, \"Upload cache to Azure\" prints lots of lines</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Transfer failed (error code: 201)\n</code></pre></div>\n<p>and the same is true for the \"Upload Archive and Counterexamples cache to Azure\" step in CI. (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19078996964/job/54502205962?pr=29649\">Link</a>)</p>",
        "id": 553691188,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762282363
    },
    {
        "content": "<p>Right, you might have to merge <code>master</code> again, unfortunately.</p>",
        "id": 553691329,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762282426
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20uploading.20cache/near/553691329\">said</a>:</p>\n<blockquote>\n<p>Right, you might have to merge <code>master</code> again, unfortunately.</p>\n</blockquote>\n<p>How could that improve things when there are no new commits?</p>",
        "id": 553691632,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762282547
    },
    {
        "content": "<p>CI is non-deterministic!</p>",
        "id": 553691792,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762282612
    },
    {
        "content": "<p>Sorry, I meant after more commits have landed in <code>master</code>.</p>",
        "id": 553691950,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762282672
    },
    {
        "content": "<p>How would \"normal\" commits change this behavior?</p>",
        "id": 553692168,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762282761
    },
    {
        "content": "<p>I have no idea, since I don't understand the root cause, but so far the failures in the other thread have started working after merging <code>master</code> once or twice.</p>",
        "id": 553692971,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762283067
    },
    {
        "content": "<p>And retrying once or twice has not? Just trying to understand the nondeterminism nature</p>",
        "id": 553695124,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1762283858
    },
    {
        "content": "<p>Retrying what precisely?</p>",
        "id": 553696330,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762284338
    },
    {
        "content": "<p>Restarting the workflow without pushing new commits</p>",
        "id": 553698095,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1762284925
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20uploading.20cache/near/553691188\">said</a>:</p>\n<blockquote>\n<p>After merging master, \"Upload cache to Azure\" prints lots of lines</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Transfer failed (error code: 201)\n</code></pre></div>\n<p>and the same is true for the \"Upload Archive and Counterexamples cache to Azure\" step in CI. (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19078996964/job/54502205962?pr=29649\">Link</a>)</p>\n</blockquote>\n<p>I went to try re-running the job in this link but it looks like CI had already passed when you posted the link. The confusing thing is that even successful uploads have lots of \"Transfer failed\" messages, which we also ought to fix.</p>",
        "id": 553698249,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762284966
    },
    {
        "content": "<p>Ah, I see you've triggered a re-run just now.</p>",
        "id": 553698467,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762285025
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20uploading.20cache/near/553698095\">said</a>:</p>\n<blockquote>\n<p>Restarting the workflow without pushing new commits</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19078996964/job/54508103491?pr=29649\">Trying this right now.</a></p>",
        "id": 553698499,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762285034
    },
    {
        "content": "<p>I think the cache for that PR should already be working though, I saw a green check on the commit at <a href=\"https://github.com/leanprover-community/mathlib4/pull/29649\">#29649</a> (at least until you re-ran the workflow).</p>",
        "id": 553698700,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762285090
    },
    {
        "content": "<p>I'm re-running the workflow. I notice that it does not build any Mathlib files (as expected), but it <em>does</em> build a lot of stuff in Archive and Counterexamples. Then the \"Upload Archive and Counterexamples cache to Azure\" step shows again a lot of junk:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Attempting to upload 27 file(s) to MichaelStollBayreuth/mathlib4 cache\nNon-JSON output from curl:\n  ﻿&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;Error&gt;&lt;Code&gt;BlobAlreadyExists&lt;/Code&gt;&lt;Message&gt;The specified blob already exists.\noffset 0: unexpected input\nNon-JSON output from curl:\n  RequestId:f1010c24-001e-0034-74c3-4d8a55000000\noffset 0: unexpected input\nNon-JSON output from curl:\n  Time:2025-11-04T19:41:36.2735025Z&lt;/Message&gt;&lt;/Error&gt;{\"certs\":\"Subject:C = US, ST = WA, L = Redmond, O = Microsoft Corporation, CN = *.blob.core.windows.net\\nIssuer:C = US, O = Microsoft Corporation, CN = Microsoft Azure RSA TLS Issuing CA 08\\nVersion:2\\nSerial Number:330263b4c2a7aac4fd83de827c00000263b4c2\\nSignature Algorithm:sha384WithRSAEncryption\\nPublic Key Algorithm:rsaEncryption\\nCT Precertificate SCTs:Signed Certificate Timestamp:\\n    Version   : v1 (0x0)\\n    Log ID    : 96:97:64:BF:55:58:97:AD:F7:43:87:68:37:08:42:77:\\n                E9:F0:3A:D5:F6:A4:F3:36:6E:46:A4:3F:0F:CA:A9:C6\\n    Timestamp : Oct  2 02:42:20.869 2025 GMT\\n    Extensions: none\\n    Signature : ecdsa-with-SHA256\\n                30:46:02:21:00:8E:88:A0:A6:88:F0:C0:13:06:24:D1:\\n                20:26:F8:97:58:3F:B0:40:35:B2:76:90:86:E0:95:CC:\\n                E1:76:9F:A7:E5:02:21:00:C8:7D:EF:D2:DD:58:58:B8:\\n                E6:3D:D3:A5:A5:40:EF:5B:7A:20:90:B9:F7:6C:CA:B7:\\n                DF:90:4E:E8:D0:D0:B8:0D\\nSigned Certific\noffset 0: unexpected input\nNon-JSON output from curl:\n  ﻿&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;&lt;Error&gt;&lt;Code&gt;BlobAlreadyExists&lt;/Code&gt;&lt;Message&gt;The specified blob already exists.\noffset 0: unexpected input\nNon-JSON output from curl:\n  RequestId:b253ca9b-001e-0056-6bc3-4d4872000000\n</code></pre></div>\n<p>etc. etc.</p>",
        "id": 553699681,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762285410
    },
    {
        "content": "<p>It looks like it expects to receive JSON, but gets fed XML instead...</p>",
        "id": 553699768,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762285447
    },
    {
        "content": "<p>\"get cache for Mathlib\":</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code> Using cache (Azure) from origin: leanprover-community/mathlib4\nAttempting to download 7458 file(s) from leanprover-community/mathlib4 cache\n...\nDownloaded: 5877 file(s) [attempted 7458/7458 = 100%, 4740 KB/s]\nWarning: some files were not found in the cache.\nThis usually means that your local checkout of mathlib4 has diverged from upstream.\nIf you push your commits to a branch of the mathlib4 repository, CI will build the oleans and they will be available later.\nAlternatively, if you already have pushed your commits to a branch, this may mean the CI build has failed part-way through building.\nDecompressing 5877 file(s)\nUnpacked in 14896 ms\nCompleted successfully!\nAttempting to download 1581 file(s) from MichaelStollBayreuth/mathlib4 cache\n...\nDownloaded: 1581 file(s) [attempted 1581/1581 = 100%, 274 KB/s]\nDecompressing 7458 file(s)\nUnpacked in 17839 ms\nCompleted successfully!\n</code></pre></div>\n<p>Why does it decompress twice?</p>",
        "id": 553700364,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762285701
    },
    {
        "content": "<p>I think we've seen that JSON output many times before, are you sure it has anything to do with failures?</p>",
        "id": 553700371,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1762285702
    },
    {
        "content": "<p>\"get cache for Archive and Counterexamples\" look similar.</p>",
        "id": 553700462,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762285742
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20uploading.20cache/near/553700371\">said</a>:</p>\n<blockquote>\n<p>I think we've seen that JSON output many times before, are you sure it has anything to do with failures?</p>\n</blockquote>\n<p>I have no idea, but it does not look right, somehow.</p>",
        "id": 553700537,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762285771
    },
    {
        "content": "<p>So it looks like things are now working properly though the log output might be confusing. Note that cache files are downloaded from two separate caches: one for <code>leanprover-community/mathlib</code> (files from the <code>master</code> branch) and <code>MichaelStollBayreuth/mathlib4</code> (files specific to your PR); that's why you see two decompressing steps.</p>",
        "id": 553700652,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762285819
    },
    {
        "content": "<p>But when I do <code>lake exe cache get</code> locally, it also downloads from two sources, but only decompresses once at the end.</p>",
        "id": 553700991,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762285869
    },
    {
        "content": "<p>It may be that the <code>master</code> files were already present on your computer from a previous download.</p>",
        "id": 553701067,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762285896
    },
    {
        "content": "<p>If opening the files in your editor / <code>lake build</code> is fast, then I wouldn't worry more about this. We do need to improve the console output at some point though.</p>",
        "id": 553701218,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762285957
    },
    {
        "content": "<p>BTW, when \"verify[ing] that everything was available in the cache\" there is some noise:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>  ℹ [97/221] Replayed Batteries.Data.Array.Match\n  trace: .&gt; LEAN_PATH=/home/runner/work/mathlib4/mathlib4/.lake/packages/Cli/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/packages/batteries/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/packages/Qq/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/packages/aesop/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/packages/proofwidgets/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/packages/importGraph/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/packages/LeanSearchClient/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/packages/plausible/.lake/build/lib/lean:/home/runner/work/mathlib4/mathlib4/.lake/build/lib/lean /home/runner/.elan/toolchains/leanprover--lean4---v4.25.0-rc2/bin/lean /home/runner/work/mathlib4/mathlib4/.lake/packages/batteries/Batteries/Data/Array/Match.lean -o /home/runner/work/mathlib4/mathlib4/.lake/packages/batteries/.lake/build/lib/lean/Batteries/Data/Array/Match.olean -i /home/runne\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>ℹ [501/590] Replayed proofwidgets/widgetPackageLock\n  trace: ././widget&gt; npm install\n  trace: stdout:\n  added 1 package, changed 2 packages, and audited 367 packages in 2s\n  67 packages are looking for funding\n    run `npm fund` for details\n  1 moderate severity vulnerability\n  To address all issues, run:\n    npm audit fix\n  Run `npm audit` for details.\n  ℹ [502/590] Replayed proofwidgets/widgetJsAll\n  trace: /home/runner/work/ProofWidgets4/ProofWidgets4/widget&gt; npm clean-install\n  trace: stdout:\n  added 365 packages, and audited 366 packages in 8s\n  68 packages are looking for funding\n    run `npm fund` for details\n  1 low severity vulnerability\n  To address all issues, run:\n    npm audit fix\n  Run `npm audit` for details.\n  trace: stderr:\n  npm warn deprecated three-mesh-bvh@0.7.8: Deprecated due to three.js version incompatibility. Please use v0.8.0, instead.\n  trace: /home/runner/work/ProofWidgets4/ProofWidgets4/widget&gt; npm run build\n  trace: stdout:\n  &gt; @leanprover-community/proofwidgets4@0.1.0 build\n  &gt; npx tsc &amp;&amp; rollup --environment NODE_ENV:production --config\n  trace: stderr:\n\n  dist/rubiks.js → ../.lake/build/js...\n  created ../.lake/build/js in 9.9s\n\n  dist/recharts.js → ../.lake/build/js...\n  (!) Circular dependencies\n  node_modules/d3-interpolate/src/value.js -&gt; node_modules/d3-interpolate/src/array.js -&gt; node_modules/d3-interpolate/src/value.js\n  node_modules/d3-interpolate/src/value.js -&gt; node_modules/d3-interpolate/src/object.js -&gt; node_modules/d3-interpolate/src/value.js\n  node_modules/recharts/es6/util/ChartUtils.js -&gt; node_modules/recharts/es6/util/getLegendProps.js -&gt; node_modules/recharts/es6/util/ChartUtils.js\n  created ../.lake/build/js in 6.5s\n\n  dist/rbTree.js → ../.lake/build/js...\n  (!) Circular dependencies\n  node_modules/d3-selection/src/selection/index.js -&gt; node_modules/d3-selection/src/selection/select.js -&gt; node_modules/d3-selection/src/selection/index.js\n  node_modules/d3-selection/src/selection/index.js -&gt; node_modules/d3-selection/src/selection/selectAll.js -&gt; node_modules/d3-selection/src/selection/index.js\n  node_modules/d3-selection/src/selection/index.js -&gt; node_modules/d3-selection/src/selection/filter.js -&gt; node_modules/d3-selection/src/selection/index.js\n  ...and 12 more\n  created ../.lake/build/js in 1.6s\n\n  dist/presentSelection.js → ../.lake/build/js...\n  created ../.lake/build/js in 165ms\n\n  dist/penroseDisplay.js → ../.lake/build/js...\n  (!) Circular dependencies\n  node_modules/true-myth/dist/es/maybe.js -&gt; node_modules/true-myth/dist/es/result.js -&gt; node_modules/true-myth/dist/es/maybe.js\n  node_modules/@penrose/core/dist/engine/EngineUtils.js -&gt; node_modules/@penrose/core/dist/utils/Util.js -&gt; node_modules/@penrose/core/dist/engine/EngineUtils.js\n  node_modules/@penrose/core/dist/engine/BBox.js -&gt; node_modules/@penrose/core/dist/contrib/Queries.js -&gt; node_modules/@penrose/core/dist/engine/BBox.js\n  ...and 14 more\n  created ../.lake/build/js in 14s\n\n  dist/penroseCanvas.js → ../.lake/build/js...\n  (!) Circular dependencies\n  node_modules/true-myth/dist/es/maybe.js -&gt; node_modules/true-myth/dist/es/result.js -&gt; node_modules/true-myth/dist/es/maybe.js\n  node_modules/@penrose/core/dist/engine/EngineUtils.js -&gt; node_modules/@penrose/core/dist/utils/Util.js -&gt; node_modules/@penrose/core/dist/engine/EngineUtils.js\n  node_modules/@penrose/core/dist/engine/BBox.js -&gt; node_modules/@penrose/core/dist/contrib/Queries.js -&gt; node_modules/@penrose/core/dist/engine/BBox.js\n  ...and 14 more\n  created ../.lake/build/js in 13.6s\n\n  dist/ofRpcMethod.js → ../.lake/build/js...\n  created ../.lake/build/js in 206ms\n\n  dist/makeEditLink.js → ../.lake/build/js...\n  created ../.lake/build/js in 109ms\n\n  dist/interactiveSvg.js → ../.lake/build/js...\n  created ../.lake/build/js in 158ms\n\n  dist/interactiveExpr.js → ../.lake/build/js...\n  created ../.lake/build/js in 109ms\n\n  dist/index.js → ../.lake/build/js...\n  created ../.lake/build/js in 128ms\n\n  dist/htmlDisplayPanel.js → ../.lake/build/js...\n  created ../.lake/build/js in 129ms\n\n  dist/htmlDisplay.js → ../.lake/build/js...\n  created ../.lake/build/js in 124ms\n\n  dist/goalTypePanel.js → ../.lake/build/js...\n  created ../.lake/build/js in 166ms\n\n  dist/filterDetails.js → ../.lake/build/js...\n  created ../.lake/build/js in 135ms\n\n  dist/exprPresentation.js → ../.lake/build/js...\n  created ../.lake/build/js in 150ms\n\n  dist/d3Graph.js → ../.lake/build/js...\n  (!) Circular dependencies\n  node_modules/d3-selection/src/selection/index.js -&gt; node_modules/d3-selection/src/selection/select.js -&gt; node_modules/d3-selection/src/selection/index.js\n  node_modules/d3-selection/src/selection/index.js -&gt; node_modules/d3-selection/src/selection/selectAll.js -&gt; node_modules/d3-selection/src/selection/index.js\n  node_modules/d3-selection/src/selection/index.js -&gt; node_modules/d3-selection/src/selection/filter.js -&gt; node_modules/d3-selection/src/selection/index.js\n  ...and 12 more\n  created ../.lake/build/js in 2.9s\n\n  dist/cancellable.js → ../.lake/build/js...\n  created ../.lake/build/js in 116ms\n\n  dist/animatedHtml.js → ../.lake/build/js...\n  created ../.lake/build/js in 136ms\n</code></pre></div>\n<p>I find the \"circular dependencies(!)\" a bit scary...</p>",
        "id": 553701327,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1762286016
    },
    {
        "content": "<p>Yeah, that's expected. There's always a bit of output from proofwidgets for some reason.</p>",
        "id": 553701399,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762286045
    },
    {
        "content": "<p>If there's no red check at the end of the job, it's usually safe to assume things are working as expected.</p>",
        "id": 553701475,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762286080
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">&lt;</span><span class=\"n\">Error</span><span class=\"bp\">&gt;&lt;</span><span class=\"n\">Code</span><span class=\"bp\">&gt;</span><span class=\"n\">BlobAlreadyExists</span><span class=\"bp\">&lt;/</span><span class=\"n\">Code</span><span class=\"bp\">&gt;&lt;</span><span class=\"n\">Message</span><span class=\"bp\">&gt;</span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">specified</span><span class=\"w\"> </span><span class=\"n\">blob</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>seems to suggest that we're trying to upload something that was uploaded already</p>",
        "id": 553702271,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762286400
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19516744620/job/55870339751\">https://github.com/leanprover-community/mathlib4/actions/runs/19516744620/job/55870339751</a></p>\n<p>This commit builds successfully, but on the \"Upload cache to Azure\" step I get the error \"Transfer failed (error code: 201)\" 122 times (once for each new file), and <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19516744620/job/55870339751#step:26:272\">nothing</a> got uploaded <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19516744620/job/55870339751#step:26:147\">to the \"kckennylau/mathlib4 cache\"</a>.</p>",
        "id": 558313603,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763590368
    },
    {
        "content": "<p>Anyone? I realise it wasn't clear, but I'm asking for help in the message above.</p>",
        "id": 558395465,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763634569
    },
    {
        "content": "<p>And this is certainly not an isolated incident, a random new PR I looked at by <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> also suffers from the same error: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19536610578/job/55932181913?pr=31847\">https://github.com/leanprover-community/mathlib4/actions/runs/19536610578/job/55932181913?pr=31847</a></p>\n<p>and I would hypothesize that every PR is having the same issue?</p>",
        "id": 558421943,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763643149
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19530917530/job/55913439876?pr=31842#step:26:322\">one</a>, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19535941479/job/55929963202?pr=31845#step:26:871\">two</a>, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19525074491/job/55896254525?pr=31836#step:26:369\">three</a>, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19516375167/job/55869138289?pr=31825#step:26:30\">four</a> out of 4 randomly sampled PR's from the first page</p>",
        "id": 558422378,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763643278
    },
    {
        "content": "<p>Is <code>lake exe cache get</code> broken for these PRs? I think <code>cache</code> logs are a bit noisy, I've noticed that step outputting lots of stuff which looks like it might be an error even though things end up OK. Generally if the post-build-job succeeds, then that means that CI checked that <code>lake exe cache get</code> worked.</p>",
        "id": 558422478,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763643298
    },
    {
        "content": "<p>There is an issue where sometimes uploading does fail causing the post build job to break which I've been tracking here: <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.22verify.20that.20everything.20was.20available.20in.20the.20cache.22.20fails.20CI/with/556971383\">#mathlib4 &gt; \"verify that everything was available in the cache\" fails CI</a> The fact that the log in the upload step is noisy certainly doesn't help in debugging what's going on there.</p>",
        "id": 558422880,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763643390
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20uploading.20cache/near/558422478\">said</a>:</p>\n<blockquote>\n<p>I've noticed that step outputting lots of stuff which looks like it might be an error even though things end up OK.</p>\n</blockquote>\n<p>Why I discovered the error is that I noticed that when I push new changes to my PR (and I only changed proofs compared to the previous commit), it actually starts building from the main cache (even though under the new module system if i only change proofs i shouldn't have to recompile everything)</p>",
        "id": 558423055,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763643440
    },
    {
        "content": "<p>Links:</p>\n<ul>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/31817\">The PR</a></li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/31817/commits/0be017e79df6ccc26e4ac71d1fcf5e34147bedcc\">The commit that only changed proofs</a></li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19516744620/job/55870339751\">The previous successful build log</a></li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19517901420/job/55874356886#step:19:82\">The current build log, which does not use the last cache</a></li>\n</ul>",
        "id": 558423584,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763643588
    },
    {
        "content": "<p>It's very possible that the way <code>cache</code> works could be improved to take advantage of the new module system and that no one has gotten around to it yet.</p>",
        "id": 558424156,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763643742
    },
    {
        "content": "<p>sure, but that log still says it failed to download the new cache</p>",
        "id": 558424250,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763643773
    },
    {
        "content": "<p>This is speculation on my part: the way cache files are hashed probably doesn't take into account the fact that a change to Lean files that only touches proofs shouldn't require re-compiling downstream files, so it's looking for files that don't exist. Unfortunately, I don't have the capacity to look into this further...</p>",
        "id": 558425917,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763644254
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20uploading.20cache/near/558425917\">said</a>:</p>\n<blockquote>\n<p>so it's looking for files that don't exist</p>\n</blockquote>\n<p>but the logs show that it tried to download the previous cache and failed</p>",
        "id": 558433265,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763646187
    },
    {
        "content": "<p>Right, I think that's consistent with what I suggested. <code>cache</code> is running on a checkout of your branch including your latest changes. To find the cached version of oleans for a Lean file, it looks for a file on the cloud server with a filename coming from a hashing algorithm that takes into account the Lean file + its dependencies. So if your changes caused the hashes of a bunch of files to change (unnecessarily, possibly) then in that step, <code>cache</code> will end up trying to download a bunch of files that don't exist (yet). (It's been a while since I looked at the code so this could be wrong; if you're interested I encourage you to take a look <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Cache/Hashing.lean\">here</a>; you might get further than I did in understanding what's happening!)</p>",
        "id": 558436021,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763646950
    },
    {
        "content": "<p>Ok, I understand; would it be a better algorithm to just download the cache of the previous commit? Which, I suppose, is your previous message saying that we could make use of the new module system in a future algorithm</p>",
        "id": 558436830,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763647120
    }
]