[
    {
        "content": "<p>What to do if that check doesn't stop? See <a href=\"https://github.com/leanprover-community/mathlib4/pull/14389\">#14389</a>. Five hours now.</p>",
        "id": 449087555,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720099515
    },
    {
        "content": "<p>I've hit the \"cancel\" button</p>",
        "id": 449088231,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720099734
    },
    {
        "content": "<p>I guess github would have timed it out eventually</p>",
        "id": 449088323,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720099766
    },
    {
        "content": "<p>Does it stay cancelled? How to restart? Do I need to make a commit?</p>",
        "id": 449098221,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720102645
    },
    {
        "content": "<p>I just restarted it: I went to the <code>Required Build</code> and told it to re-run all failed jobs.</p>",
        "id": 449101915,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720103487
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 449102354,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720103636
    },
    {
        "content": "<p>Although it seems to be stuck again: normally, <code>Shake</code> takes under a minute to run and it has been going for over half an hour now.</p>",
        "id": 449109842,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720105783
    },
    {
        "content": "<p>Are there options that I can give the shaker locally to see what's wrong?</p>",
        "id": 449110481,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720105944
    },
    {
        "content": "<p>Does it also run forever locally?</p>",
        "id": 449110625,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720105980
    },
    {
        "content": "<p>(In any case, I do not know of such options, so this is mere curiosity.)</p>",
        "id": 449110685,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720105997
    },
    {
        "content": "<p>Cannot say, <code>lake build</code> already runs forever at the moment. Need to wait an hour probably to be able to test it.</p>",
        "id": 449111166,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720106118
    },
    {
        "content": "<p>Anyway, next I'll make a null commit, maybe it's not in the code.</p>",
        "id": 449111649,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720106244
    },
    {
        "content": "<p>I downloaded the cache and <code>lake exe shake</code> does seem to run forever</p>",
        "id": 449111651,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720106244
    },
    {
        "content": "<p>(or rather, for at least 20 seconds!)</p>",
        "id": 449111685,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720106254
    },
    {
        "content": "<p>I noticed something weird that it downloaded something from <code>aesop</code> with the cache.  Maybe merge master into the pr and push.</p>",
        "id": 449111937,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720106309
    },
    {
        "content": "<p>This is what it said, in case it is helpful:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>mathlib4<span class=\"w\"> </span><span class=\"o\">(</span>rwst/primesplit3<span class=\"o\">)</span>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get\ninfo:<span class=\"w\"> </span>aesop:<span class=\"w\"> </span>URL<span class=\"w\"> </span>has<span class=\"w\"> </span>changed<span class=\"p\">;</span><span class=\"w\"> </span>deleting<span class=\"w\"> </span><span class=\"s1\">'././.lake/packages/aesop'</span><span class=\"w\"> </span>and<span class=\"w\"> </span>cloning<span class=\"w\"> </span>again\ninfo:<span class=\"w\"> </span>aesop:<span class=\"w\"> </span>cloning<span class=\"w\"> </span>https://github.com/leanprover-community/aesop<span class=\"w\"> </span>to<span class=\"w\"> </span><span class=\"s1\">'././.lake/packages/aesop'</span>\nAttempting<span class=\"w\"> </span>to<span class=\"w\"> </span>download<span class=\"w\"> </span><span class=\"m\">4073</span><span class=\"w\"> </span>file<span class=\"o\">(</span>s<span class=\"o\">)</span>\nDownloaded:<span class=\"w\"> </span><span class=\"m\">4073</span><span class=\"w\"> </span>file<span class=\"o\">(</span>s<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span>attempted<span class=\"w\"> </span><span class=\"m\">4073</span>/4073<span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">100</span>%<span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">100</span>%<span class=\"w\"> </span>success<span class=\"o\">)</span>\nDecompressing<span class=\"w\"> </span><span class=\"m\">4767</span><span class=\"w\"> </span>file<span class=\"o\">(</span>s<span class=\"o\">)</span>\nlake<span class=\"w\"> </span>exe<span class=\"w\"> </span>shakeUnpacked<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">17102</span><span class=\"w\"> </span>ms\nCompleted<span class=\"w\"> </span>successfully!\n</code></pre></div>",
        "id": 449112145,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720106361
    },
    {
        "content": "<p>I would suspect an import cycle</p>",
        "id": 449113031,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720106565
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/check.20for.20unused.20imports.20doesn't.20stop/near/449113031\">said</a>:</p>\n<blockquote>\n<p>I would suspect an import cycle</p>\n</blockquote>\n<p>...that passes the build step?</p>",
        "id": 449113436,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720106647
    },
    {
        "content": "<p>No difference after merged master.</p>",
        "id": 449127657,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720110689
    },
    {
        "content": "<p>There is something really weird going on here, I think it is related to the latest lean bump. It appears that constants can now reference constants declared in later modules(?) and this is messing up shake's analysis which assumes some acyclicity</p>",
        "id": 449137381,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720114133
    },
    {
        "content": "<p>Here's a MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Commute</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Cast</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"ss\">`pow_bit1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"pow_bit1 not found\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">const2ModIdx</span><span class=\"bp\">.</span><span class=\"n\">find!</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">header</span><span class=\"bp\">.</span><span class=\"n\">moduleNames</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"ss\">`bit1.eq_1</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"bit1.eq_1 not found\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">const2ModIdx</span><span class=\"bp\">.</span><span class=\"n\">find!</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">header</span><span class=\"bp\">.</span><span class=\"n\">moduleNames</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n</code></pre></div>\n<p>This code says that <code>pow_bit1</code> is in Mathlib.Algebra.Group.Commute.Defs, and <code>bit1.eq_1</code> is in Mathlib.Data.Nat.Cast.Defs, and <code>pow_bit1</code> depends on <code>bit1.eq_1</code> even though Mathlib.Data.Nat.Cast.Defs comes after Mathlib.Algebra.Group.Commute.Defs in the import order (these two files do not import each other so it's just the order they are listed in the test file). It shouldn't be possible for <code>pow_bit1</code> to depend on a file not in its dependency closure?</p>\n<p>If I remove the import of Mathlib.Data.Nat.Cast.Defs, then the module of <code>bit1.eq_1</code> <em>changes</em> to Mathlib.Algebra.Group.Commute.Defs. Are these definitions just defined in multiple places?</p>",
        "id": 449139309,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720115307
    },
    {
        "content": "<p>the shake bug is fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/14417\">#14417</a> and the lean bug is <a href=\"https://github.com/leanprover/lean4/pull/4652\">lean4#4652</a></p>",
        "id": 449143864,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720117098
    },
    {
        "content": "<p>This passes locally after a dozen seconds:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">shake</span><span class=\"w\"> </span><span class=\"c1\">--no-downstream</span>\n<span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Dynamics</span><span class=\"bp\">/</span><span class=\"n\">PeriodicPts</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Dynamics</span><span class=\"bp\">.</span><span class=\"n\">Newton</span><span class=\"o\">]</span>\n<span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Int</span><span class=\"bp\">/</span><span class=\"n\">NatPrime</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>In contrast this does not stop:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">shake</span><span class=\"w\"> </span><span class=\"c1\">--gh-style</span>\n<span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Dynamics</span><span class=\"bp\">/</span><span class=\"n\">PeriodicPts</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unused</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">shake</span><span class=\"w\"> </span><span class=\"c1\">--fix` to fix this, or `lake exe shake --update` to ignore)</span>\n<span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Dynamics</span><span class=\"bp\">/</span><span class=\"n\">PeriodicPts</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">13</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Dynamics</span><span class=\"bp\">.</span><span class=\"n\">Newton</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">instead</span>\n<span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Dynamics</span><span class=\"bp\">/</span><span class=\"n\">PeriodicPts</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Dynamics</span><span class=\"bp\">.</span><span class=\"n\">Newton</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I committed the suggested fixes. Let's see.</p>",
        "id": 449143947,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720117145
    },
    {
        "content": "<p>The fixes make it no longer compile, so are the fixes buggy because shake is confused?</p>",
        "id": 449144645,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720117379
    },
    {
        "content": "<p>Anyway <code>shake --gh-style</code> or even <code>shake</code> in general seems no longer reliable. And I'm back tomorrow morning (although I don't think I can be much help from now on).</p>",
        "id": 449145235,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720117595
    },
    {
        "content": "<p>what do you mean by no longer compile?</p>",
        "id": 449145393,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720117662
    },
    {
        "content": "<p>shake has been confused since this issue was introduced in march</p>",
        "id": 449145500,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720117692
    },
    {
        "content": "<p>so it's possible there are some missed diagnostics</p>",
        "id": 449145574,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720117727
    },
    {
        "content": "<p>on the other hand it's also possible that the fix is not enough and the whole algorithm needs a rethink because definitions existing multiple times in the tree was never a part of the design</p>",
        "id": 449145659,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720117778
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/check.20for.20unused.20imports.20doesn't.20stop/near/449145393\">said</a>:</p>\n<blockquote>\n<p>what do you mean by no longer compile?</p>\n</blockquote>\n<p>\"build mathlib\" passed before the last commit.</p>",
        "id": 449146019,
        "sender_full_name": "Ralf Stephan",
        "timestamp": 1720117999
    }
]