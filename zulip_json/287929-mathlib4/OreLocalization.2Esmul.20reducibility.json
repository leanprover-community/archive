[
    {
        "content": "<p>Right now <code>OreLocalization.smul</code> is irreducible. So if <code>A</code> is an <code>R</code>-module and <code>S</code> is a submonoid of <code>R</code>, then <code>A[S⁻¹]</code> is an <code>R[S⁻¹]</code>-module. In mathlib we have defined <code>mul</code> on <code>R[S⁻¹]</code> as being equal to <code>smul</code>, so if <code>a b : R[S⁻¹]</code> then <code>a • b = a * b</code> and the proof is <code>rfl</code>.</p>\n<p>If however <code>A</code> is an <code>R</code>-algebra then in <a href=\"https://github.com/leanprover-community/mathlib4/pull/16650\">#16650</a> I made <code>A[S⁻¹]</code> into an <code>R[S⁻¹]</code>-algebra, and now if <code>a b : A[S⁻¹]</code> then <code>a • b = a * b</code> and the proof isn't <code>rfl</code> (at least not according to typeclass inference) because <code>smul</code> is irreducible so Lean can't see that it's defeq to <code>mul</code>. Here is some code illustrating this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">CommMagma</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommMonoid</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommMagma</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MulAction</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submonoid</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">}</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mul'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"bp\">/ₒ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s₂</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s₁</span><span class=\"o\">)</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mul''</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">liftExpand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mul'</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">r₁</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">s₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hs₁</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"n\">hr₁s₁</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- proof omitted</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">liftExpand</span><span class=\"w\"> </span><span class=\"n\">mul''</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">r₁</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"c1\">-- proof omitted</span>\n\n<span class=\"c1\">-- OreLocalization.smul is irreducible but this still</span>\n<span class=\"c1\">-- works because mul on R[S⁻¹] is defined to be smul.</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">mul</span>\n\n<span class=\"c1\">-- But here irreducibility causes problems:</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">as</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">bt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">HSMul</span><span class=\"bp\">.</span><span class=\"n\">hSMul</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">SMul</span><span class=\"bp\">.</span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">instSMul</span>\n<span class=\"w\">  </span><span class=\"c1\">-- rfl -- fails</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">smul</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- now works</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">CommMagma</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span>\n</code></pre></div>\n<p>To make the last proof <code>rfl</code> you can just remove the <code>irreducible</code> attribute on <code>smul</code>. This I do in <a href=\"https://github.com/leanprover-community/mathlib4/pull/16746\">#16746</a> and my understanding of recent comments by <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> was that this is the right thing to do in this situation. However <a href=\"https://github.com/leanprover-community/mathlib4/pull/16746#issuecomment-2347881307\">benchmarking only this change</a> reveals that it makes the file <code>Algebra.Module.LocalizedModule</code> 8% slower. Is this a deal breaker?</p>",
        "id": 470032532,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726253774
    },
    {
        "content": "<p>In my opinion correctness wins over performance unless the performance is really disastrous. An 8% change in just one file doesn't seem too bad to me.</p>",
        "id": 470033092,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726253993
    },
    {
        "content": "<p>In a future change, you could try making <code>liftExpand</code> irreducible instead</p>",
        "id": 470033252,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726254043
    },
    {
        "content": "<p>Something I'd very much like to have here is a way to tell the elaborator to treat <code>lift</code> as a recursor and <code>mk</code> as a constructor, such that both are irreducible in isolation but <code>lift f (mk x)</code> reduces to <code>f x</code></p>",
        "id": 470034623,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726254681
    },
    {
        "content": "<p>Here is another diamond which making smul not-irreducible doesn't fix:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">liftExpand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">mk'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">rs</span>\n</code></pre></div>\n<p>Proof is <code>cases rs; rfl</code>. Here <code>OreLocalization S R</code> is a quotient of <code>R x S</code>. The fact that this isn't rfl means that if I make A[1/S] into an R[1/S]-algebra and add this to typeclass inference then there are two nondefeq <code>toFun</code> instances of <code>Algebra R[S⁻¹] R[S⁻¹]</code> floating around. Is it likely that I can solve this by refactoring <code>liftExpand</code>?</p>",
        "id": 470035022,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726254881
    },
    {
        "content": "<p>That looks impossible to make rfl; but presumably this is an <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> problem and came from reducing something else that you wanted to be rfl?</p>",
        "id": 470036348,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726255548
    },
    {
        "content": "<p>Right, I want to make <code>Algebra R[1/S] A[1/S]</code> from <code>Algebra R A</code> but then I get two nondefeq <code>Algebra R[1/S] R[1/S]</code> instances</p>",
        "id": 470046836,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1726260490
    },
    {
        "content": "<p>I think this is a problem with any attempt to make <code>Algebra A B -&gt; Algebra (F A) (F B)</code> instances, for most <code>F</code>s</p>",
        "id": 470070333,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726275702
    },
    {
        "content": "<p>But arguably you should never create those instances anyway, as they create propositional diamonds when <code>B := F A</code></p>",
        "id": 470070441,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726275785
    }
]