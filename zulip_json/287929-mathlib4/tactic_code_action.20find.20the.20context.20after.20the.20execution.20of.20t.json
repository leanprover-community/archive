[
    {
        "content": "<p>Hi, i am doing some experiments with tactic_code_actions, (basically playing with the example of createCalc)  which is printing  a format version of the goal before the tactic is applied, but i would like to do similar stuff with the goal after the tactic is applied ( see mwe). However it turns out that the context (ctx variable) is not the good one to get a format of the goal after.<br>\nDoes somebody know how to find the adapted context, or a way to fix this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">CodeAction</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">RequestM</span><span class=\"w\"> </span><span class=\"n\">CodeAction</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">tactic_code_action</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">dsimp</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Suffices</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticCodeAction</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">snap</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofTacticInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eager</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Clic\"</span>\n<span class=\"w\">    </span><span class=\"n\">kind?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"quickfix\"</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">readDoc</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span>\n<span class=\"w\">    </span><span class=\"n\">eager</span>\n<span class=\"w\">    </span><span class=\"n\">lazy?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tacPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">utf8PosToLspPos</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getPos?</span><span class=\"bp\">.</span><span class=\"n\">get!</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">text</span><span class=\"bp\">.</span><span class=\"n\">utf8PosToLspPos</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">getTailPos?</span><span class=\"bp\">.</span><span class=\"n\">get!</span>\n\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">goalsAfter</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n<span class=\"w\">      </span><span class=\"c1\">--let goal := info.goalsBefore[0]!</span>\n\n<span class=\"w\">      </span><span class=\"c1\">-- here ctx is the context before applying the tactic not the tactic</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goalFmt</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">runMetaM</span><span class=\"w\">  </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">withContext</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">ppExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span><span class=\"o\">)</span>\n\n\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">eager</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"n\">edit?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">&lt;|.</span><span class=\"n\">ofTextEdit</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">.</span><span class=\"n\">versionedIdentifier</span>\n<span class=\"w\">          </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">tacPos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">endPos</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">newText</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"suffices {goalFmt} by dsimp;assumption\"</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">      </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">}]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span>\n<span class=\"w\">  </span><span class=\"c1\">-- i would like :</span>\n<span class=\"w\">  </span><span class=\"c1\">--suffices 4 = 5 by dsimp;assumption</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 529267182,
        "sender_full_name": "yannis monbru",
        "timestamp": 1752754960
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> any idea?</p>",
        "id": 529464443,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1752845757
    },
    {
        "content": "<p>It turns out that one can get the context (of type ContextInfo) by doing (thank's <span class=\"user-mention\" data-user-id=\"376152\">@Paul Lezeau</span> )<br>\n<code>let newCtx := {ctx with mctx := info.mctxAfter}</code></p>",
        "id": 530132315,
        "sender_full_name": "yannis monbru",
        "timestamp": 1753186343
    },
    {
        "content": "<p>I had not noticed this message, but there is also <a href=\"https://github.com/leanprover-community/mathlib4/pull/12006\">#12006</a> (from a very very long time ago).</p>",
        "id": 530133083,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1753186574
    },
    {
        "content": "<p>Note that it is not a code action, but a <code>Try this</code>.</p>",
        "id": 530133180,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1753186612
    }
]