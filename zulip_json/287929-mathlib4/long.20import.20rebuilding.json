[
    {
        "content": "<p>When I modify <code>Mathlib.MeasureTheory.Measure.MeasureSpace</code> and open <code>Mathlib.Probability.Distributions.Gaussian</code>, Lean tells me that my imports are out of date and must be rebuilt. Then I have to wait for about 30-60 minutes (I did not time it but it's a very long time) for ~80 files to build. Once imports are rebuilt, I realize that the lemma I stated in <code>Mathlib.MeasureTheory.Measure.MeasureSpace</code> does not quite work, so I change it, and incur another 30-60 minutes of imports rebuilding. This process is very time-consuming. How can I speed it up? One idea is to move all new lemmas to a single file, and only move them to their respective files at the very end. But it seems pretty incovenient. Any better way?</p>",
        "id": 490327133,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734812424
    },
    {
        "content": "<p>You probably want to write your lemma in the same file where you want to use it at least until you're sure you've stated it the way you want it, yeah</p>",
        "id": 490330924,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1734815781
    },
    {
        "content": "<p>Something is horribly wrong if it takes 30 minutes to compile 80 files!</p>",
        "id": 490338465,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734822804
    },
    {
        "content": "<p>In the past I've seen this slowness caused (on windows) by antivirus getting very in the way of Lean</p>",
        "id": 490339700,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734823983
    },
    {
        "content": "<p>Lean 3 (community edition) had an option \"don't recompile the unchanged dependencies, just load oleans and assume that my changes to <code>data/set/basic</code> didn't break them\". AFAIK, there is no such option in Lean 4, so I suggest one of 2 ways:</p>\n<ul>\n<li>put all your new lemmas in the new file, move them to appropriate files as the last step in PR preparation;</li>\n<li>when you modify a basic file, push to github, switch to another project, then get oleans from cache when you go back to this branch.</li>\n</ul>",
        "id": 490340209,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734824433
    },
    {
        "content": "<p>Also, I agree that compiling 80 files shouldn't take 30-60 minutes.</p>",
        "id": 490340232,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734824457
    },
    {
        "content": "<p>Thank you for the responses. I will try to time it to get a more precise estimate. I ssh to my school server to work on mathlib because my surface pro 7 seems unable to handle mathlib (compilations take an egregious amount of time). But even on the 60-core 512Gb-RAM server, the compilations take dozens of minutes when I work on mathlib.</p>",
        "id": 490361620,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734846487
    },
    {
        "content": "<p>Does it use a slow network filesystem?</p>",
        "id": 490368766,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734854301
    },
    {
        "content": "<p>It's a Linux machine, not sure if it answers your question.</p>",
        "id": 490373211,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734858818
    },
    {
        "content": "<p>The question is what path your .lake directory resides in, and whether that belongs to a slow filesystem</p>",
        "id": 490374667,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734860210
    },
    {
        "content": "<p>As an experience you could checkout mathlib inside<code>/tmp/lean_test</code> and see if the build is faster there</p>",
        "id": 490374709,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734860267
    },
    {
        "content": "<p>Though obviously don't actually keep any work there</p>",
        "id": 490374752,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734860284
    },
    {
        "content": "<p>What does <code>stat --file-system --format=%T .</code> say?</p>",
        "id": 490400184,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734883794
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> ,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">vilin</span><span class=\"bp\">@</span><span class=\"n\">doppio</span><span class=\"o\">:</span><span class=\"bp\">~/</span><span class=\"n\">mathlib4</span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"w\"> </span><span class=\"c1\">--file-system --format=%T .</span>\n<span class=\"n\">ext2</span><span class=\"bp\">/</span><span class=\"n\">ext3</span>\n</code></pre></div>",
        "id": 490408549,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734891545
    },
    {
        "content": "<p>Here is a test I did. I modified file <code>Mathlib.MeasureTheory.Measure.MeasureSpace</code> with a dummy theorem <code>theorem test : 1 = 1 := rfl</code>. Then I opened file <code>Mathlib.Probability.Distributions.Gaussian</code> and timed how long it took to rebuild its imports.<br>\nAfter 10 minutes: <code>[2110/2174]</code><br>\nAfter 15 minutes: <code>[2128/2174]</code><br>\nAfter 20 minutes: <code>[2134/2174]</code><br>\nAfter 29 minutes: Done!</p>\n<p>So it takes ~30 minutes to rebuild imports after modifying <code>Mathlib.MeasureTheory.Measure.MeasureSpace</code>.</p>",
        "id": 490410390,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734893498
    },
    {
        "content": "<p>While people are diagnosing this problem maybe you want to switch to Gitpod :) especially since you're remote anyway</p>",
        "id": 490410701,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1734893773
    },
    {
        "content": "<p>Could you repeat your test for a checkout in <code>/tmp</code>?</p>",
        "id": 490415522,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734898344
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/long.20import.20rebuilding/near/490415522\">said</a>:</p>\n<blockquote>\n<p>Could you repeat your test for a checkout in <code>/tmp</code>?</p>\n</blockquote>\n<p>I didn't quite understand the suggestion. I make a new folder <code>tmp</code> and clone mathlib there? I don't see how that makes any difference.</p>",
        "id": 490456313,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734933392
    },
    {
        "content": "<p>It can make difference, if <code>/tmp</code> is on <code>tmpfs</code> (a.k.a. RAM)</p>",
        "id": 490461794,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1734936473
    },
    {
        "content": "<p>This is <code>/tmp</code> in the root directory of a linux distribution, not a new directory <code>tmp</code> in your home directory. The point is that we want to rule out the conjecture that reading and writing from some disc or other is slow.</p>",
        "id": 490474240,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1734942239
    },
    {
        "content": "<p>For example I have a fast disc and a slow disc on my computer, and on the slow disc there are various operations which take forever. I just spun up a mathlib on the slow disc and I get this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">5786</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">5786</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">attempted</span><span class=\"w\"> </span><span class=\"mi\">5786</span><span class=\"bp\">/</span><span class=\"mi\">5786</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"o\">)</span>\n<span class=\"n\">Decompressing</span><span class=\"w\"> </span><span class=\"mi\">5786</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Unpacked</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">92460</span><span class=\"w\"> </span><span class=\"n\">ms</span>\n<span class=\"n\">Completed</span><span class=\"w\"> </span><span class=\"n\">successfully!</span>\n</code></pre></div>\n<p>i.e. 1.5 minutes to do some disc-intensive operation (unpacking mathlib compiled binaries).</p>",
        "id": 490474884,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1734942496
    },
    {
        "content": "<p>On this slow drive, my timings for building <code>Mathlib.Probability.Distributions.Gaussian</code> after adding your <code>test</code> to <code>Mathlib.MeasureTheory.Measure.MeasureSpace</code> are: started <code>08:29:36</code>, finished <code>08:33:48</code>, so just over 4 minutes.</p>\n<p>When I'm in this sort of situation, I do what's been suggested above: I add lemmas to the file I'm working on, and only move everything to the right directory right at the end of the process, just before pushing to github. Then github compiles everything for me and I can get cache later on.</p>",
        "id": 490475941,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1734942934
    },
    {
        "content": "<p>I did the same experiment on my local computer, with essentially the same result. Actually, it's a bit faster than on my university server (20 minutes instead of 30). I'll try the <code>tmp</code> thing now.</p>",
        "id": 490480420,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734944831
    },
    {
        "content": "<p>I now did the experiment where I cloned <code>mathlib</code> in <code>tmp</code>, with essentially the same result -- it takes around 20-30 minutes to rebuilt imports.</p>",
        "id": 490483906,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734946268
    },
    {
        "content": "<p>(I used quite a fast machine even though the disc was slow)</p>",
        "id": 490487299,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1734947648
    },
    {
        "content": "<p>I tried the same experiemnt on a free Github codespace. It's a bit faster (~15 minutes) but that's still way slower than 4 minutes. </p>\n<p><a href=\"/user_uploads/3121/oyaTVRiZU9SoVlIuPqOEaK5y/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/oyaTVRiZU9SoVlIuPqOEaK5y/image.png\" title=\"image.png\"><img data-original-dimensions=\"1964x768\" src=\"/user_uploads/thumbnail/3121/oyaTVRiZU9SoVlIuPqOEaK5y/image.png/840x560.webp\"></a></div>",
        "id": 490491865,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734949366
    },
    {
        "content": "<p>The nice thing about a Github codespace is that it should be completely reproducible.</p>",
        "id": 490492468,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734949620
    },
    {
        "content": "<p>I think Kim's statement about something being \"horribly wrong\" might just be a reflection of the fact that they are used to working with fast computers. What concerns me here is the comment about the 60-core 512Gb-RAM server. I just have a high end PC with 8 cores and 32 gigs and it took 4 minutes to compile those files.</p>",
        "id": 490492804,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1734949743
    },
    {
        "content": "<p>Maybe it has to do with the fact that this high-end school server is used by many other graduate students in the applied math department. It's interesting that a free GitHub codespace is ~2x faster</p>",
        "id": 490496287,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734951054
    },
    {
        "content": "<p>A higher number of cores can also be a hindrance if not enough files can be built in parallel as it usually means a lower per-CPU frequency</p>",
        "id": 490499636,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1734952356
    },
    {
        "content": "<p>On latest master it starts with [2068/2179], so it's more like 110 files.</p>",
        "id": 490499858,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1734952462
    },
    {
        "content": "<p>Tested on Gitpod:</p>\n<blockquote>\n<p>gitpod /workspace/mathlib4 (master) $ time lake build Mathlib.Probability.Distributions.Gaussian<br>\nBuild completed successfully.<br>\nreal    8m20.599s<br>\nuser    16m9.127s<br>\nsys     1m7.653s</p>\n</blockquote>\n<p>I noticed that these files are slow, but maybe there are more when I was not watching:<br>\n[2142/2179] Running Mathlib.MeasureTheory.Integral.SetToL1<br>\n[2143/2179] Running Mathlib.MeasureTheory.Integral.Bochner</p>",
        "id": 490501338,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1734953058
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/stream/287929-mathlib4/topic/long.20import.20rebuilding/near/490501338\">said</a>:</p>\n<blockquote>\n<p>Tested on Gitpod:</p>\n<blockquote>\n<p>gitpod /workspace/mathlib4 (master) $ time lake build Mathlib.Probability.Distributions.Gaussian<br>\nBuild completed successfully.<br>\nreal    8m20.599s<br>\nuser    16m9.127s<br>\nsys     1m7.653s</p>\n</blockquote>\n<p>I noticed that these files are slow, but maybe there are more when I was not watching:<br>\n[2142/2179] Running Mathlib.MeasureTheory.Integral.SetToL1<br>\n[2143/2179] Running Mathlib.MeasureTheory.Integral.Bochner</p>\n</blockquote>\n<p>Is the sum of these numbers the real wall clock time? I.e. ~25 minutes</p>",
        "id": 490507881,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734955848
    },
    {
        "content": "<p><del>I think the \"user\" number is close to the wall clock time.</del></p>",
        "id": 490508352,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1734956055
    },
    {
        "content": "<p>Real is the wall time</p>",
        "id": 490508785,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734956253
    },
    {
        "content": "<p>User tells you it's running on two cpus there, I think</p>",
        "id": 490508839,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734956278
    },
    {
        "content": "<p>Is there a guide to using Lean in Gitpod? I only found this old thread: <a href=\"https://leanprover-community.github.io/archive/stream/113488-general/topic/gitpod.html\">https://leanprover-community.github.io/archive/stream/113488-general/topic/gitpod.html</a></p>",
        "id": 490515139,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1734958909
    },
    {
        "content": "<p>You can just click \"Open in Gitpod\" <a href=\"https://github.com/leanprover-community/mathlib4#installation\">here</a> to work off master. Each PR also comes with such a button by default.</p>",
        "id": 490529145,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1734964382
    },
    {
        "content": "<p>Which is the same as just putting <code>gitpod.io/#</code> before the url</p>",
        "id": 490530951,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1734965149
    },
    {
        "content": "<p>Is Gitpod recommended over GitHub codespaces?</p>",
        "id": 491321337,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1735587697
    },
    {
        "content": "<p>They're \"the same thing\" but IIRC gitpod is being retired in April.</p>",
        "id": 491325251,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1735590199
    },
    {
        "content": "<p>I personally love gitpod and get 250h/month for free because of their open source plan, but indeed as Kevin says gitpod might soon disappear <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 491325287,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1735590228
    },
    {
        "content": "<p>I've started trying Codespaces and it has a nice feature that comments on the PR can be shown together with the code in the editor. Also I don't see the <code>lean exe cache get</code> run in the terminal, but the cache is indeed fetched; I'm not sure how it's done in the background. It seems to take longer to load a file, even though it's already built. It seems push/pull/fetch is faster probably because the server is native to GitHub. <del>It seems I can't stop a codespace within the VSCode editor, and must navigate to the repo and click various buttons.</del> The GitHub favicon causes more confusion than the Gitpod one, since you can't use it to distinguish codespaces from PRs ... Otherwise the experience is similar to Gitpod, so the transition should be smooth.</p>\n<p>Should we add a Codespaces button next to the Gitpod button in every PR? This saves  three clicks since currently you need to first click on the branch name, then on the green Code button, then the Codespaces tab, before you can finally create a codespace.</p>",
        "id": 491344051,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735602981
    },
    {
        "content": "<p>You don't have to click on the branch name, there is a \"code\" link in the top right of the PR page</p>",
        "id": 491349868,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735607545
    },
    {
        "content": "<p>Good find! Still two more clicks but the advantage is it's also accessible from the \"Files Changed\" view, not just the \"Conversation\" view.</p>",
        "id": 491357438,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735613803
    },
    {
        "content": "<blockquote>\n<p>It seems I can't stop a codespace within the VSCode editor, and must navigate to the repo and click various buttons.</p>\n</blockquote>\n<p>I found that I can stop the codespace by clicking the green button at the lower left corner of the editor.</p>",
        "id": 491423679,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1735665647
    }
]