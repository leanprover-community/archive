[
    {
        "content": "<p>A general request to reviewers. I've just been dealing with the Mathlib fallout of fixing a simp bug (cf <a href=\"https://github.com/leanprover/lean4/pull/6397\">lean#6397</a>), and I've been encountering a <em>lot</em> of entirely unnecessary <code>simp only</code> in terminal positions, where a much shorter (and generally more robust) <code>simp</code> statement works fine.</p>\n<p>Could reviewers please be on the watch for this, and discourage contributors from needlessly converting <code>simp</code> to <code>simp only</code> in terminal position? It's great to do this if otherwise there is a performance problem, but these should probably be explained with comments! Otherwise, it's just unnecessarily verbose and fragile.</p>",
        "id": 490050149,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734642569
    },
    {
        "content": "<p>c.f. <a href=\"https://github.com/leanprover-community/mathlib4/pull/20097\">#20097</a></p>",
        "id": 490073079,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1734655114
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I've looked at the post-merge benchmarking output of <a href=\"https://github.com/leanprover-community/mathlib4/pull/20097\">#20097</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/20098\">#20098</a>, and <code>Mathlib/ModelTheory/Algebra/Ring/Definability.lean</code> regresses by a factor of 1.85 (5 -&gt; 10*10⁹ instructions). That is the only such regression. Is there a passing <code>testing</code> branch on which I can squeeze this myself?/Can I entice you to doing so?</p>",
        "id": 490129517,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1734689111
    },
    {
        "content": "<p><code>lean-pr-testing-6397</code> should be that branch</p>",
        "id": 490129863,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734689225
    },
    {
        "content": "<p>I haven't yet merged master into it. Was planning to do that soonish</p>",
        "id": 490129904,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734689241
    },
    {
        "content": "<p>But I hope the merge is clean</p>",
        "id": 490129923,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734689247
    },
    {
        "content": "<p>Done, and pushed <img alt=\":push:\" class=\"emoji\" src=\"https://avatars.zulip.com/3121/emoji/images/8498449b.png\" title=\"push\"></p>",
        "id": 490130263,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734689384
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/345428-mathlib-reviewers/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/490050149\">said</a>:</p>\n<blockquote>\n<p>converting <code>simp</code> to <code>simp only</code> in terminal position [...] it's just unnecessarily verbose and fragile.</p>\n</blockquote>\n<p>I've been saying this... <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 490133539,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1734690580
    },
    {
        "content": "<p>There's no mathlib cache yet, right? Then I'll wait for that before I try to re-squeeze.</p>",
        "id": 490135087,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1734691144
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20120\">#20120</a></p>",
        "id": 490184177,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1734708858
    },
    {
        "content": "<p>CI for that fails, but in downstream files and for reasons that look clearly unrelated to the PR.</p>",
        "id": 490184386,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1734708938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/345428-mathlib-reviewers/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/490050149\">said</a>:</p>\n<blockquote>\n<p>A general request to reviewers. I've just been dealing with the Mathlib fallout of fixing a simp bug (cf <a href=\"https://github.com/leanprover/lean4/pull/6397\">lean#6397</a>), and I've been encountering a <em>lot</em> of entirely unnecessary <code>simp only</code> in terminal positions, where a much shorter (and generally more robust) <code>simp</code> statement works fine.</p>\n<p>Could reviewers please be on the watch for this, and discourage contributors from needlessly converting <code>simp</code> to <code>simp only</code> in terminal position? It's great to do this if otherwise there is a performance problem, but these should probably be explained with comments! Otherwise, it's just unnecessarily verbose and fragile.</p>\n</blockquote>\n<p>And I guess that the same suggestion applies to <code>simpa</code> calls?</p>",
        "id": 490193114,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1734711890
    },
    {
        "content": "<p>Kim, are you planning on documenting this discouragement somewhere, eg the contribution guide? If not, I am happy to do this myself in a few days.</p>",
        "id": 491342952,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1735602124
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/20362\">#20362</a> I followed <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>'s request and un-squeezed the terminal <code>simp</code>s. This resulted in a slowdown by ~30%. (I don't think the refactoring part of the PR should have a relevant influence on speed, but I could check that if desired.)</p>\n<p>Assuming that this is typical, is the prevailing opnion that the reduced maintenance burden is worth a global increase of build time by 30% or so? (In particular in view of Mathlib's continual growth...)</p>",
        "id": 491524034,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1735760646
    },
    {
        "content": "<p>Maybe I should really check this. The PR contains some additional material...</p>",
        "id": 491524281,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1735760907
    },
    {
        "content": "<p>I don't think it's usually that bad</p>",
        "id": 491524888,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1735761580
    },
    {
        "content": "<p>How many LOC are we talking about?</p>",
        "id": 491525195,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1735761875
    },
    {
        "content": "<p>OK, with <em>only</em> un-squeezing the terminal <code>simp only</code>s, the slow-down is ~3.8% (see <a href=\"https://github.com/leanprover-community/mathlib4/pull/20382\">#20382</a>) (with 25 new <code>simps</code>s in ~500 LOC).</p>\n<p>So it is indeed not that bad -- sorry for the noise!</p>",
        "id": 491527358,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1735764212
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/345428-mathlib-reviewers/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/491342952\">said</a>:</p>\n<blockquote>\n<p>Kim, are you planning on documenting this discouragement somewhere, eg the contribution guide? If not, I am happy to do this myself in a few days.</p>\n</blockquote>\n<p>That would be great, thank you <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>!</p>",
        "id": 491730123,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1735896880
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/leanprover-community.github.io/pull/567\">https://github.com/leanprover-community/leanprover-community.github.io/pull/567</a></p>",
        "id": 491784080,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1735923636
    },
    {
        "content": "<p>I'd like to make a counter-argument here. I do understand <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> 's maintainability concerns, but I think there are cases where squeezing terminal simps is actually better for maintainability, not worse.</p>\n<p>Consider the situation where a proof ends with <code>simp only [foo, bar]</code> where <code>foo</code> is part of the standard simp set but <code>baz</code> is not. If either <code>foo</code> or <code>bar</code> gets renamed, then the simp will break. The alternative <code>simp [bar]</code> is immune to failure caused by renaming <code>foo</code>. However, it can fail in another, much more pernicious reason, which is if a new lemma gets added to the standard simp set which works against <code>bar</code>; and this kind of failure, while probably rarer, is going to be a whole lot harder to debug.</p>\n<p>An extreme case of this (which is the example that alerted me to the existence of this new rule) came up in <a href=\"https://github.com/leanprover-community/mathlib4/pull/20813\">#20813</a>, where I (as reviewer) had suggested a <code>simp only</code> with 4 explicitly given simp lemmas, of which <em>none</em> are part of the standard simp set. So in this case, the prescription according to Kim's new rule – changing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">quux</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">quux</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>– seems (to me) to bring no actual maintainability benefit in terms of robustness against renames; and possibly even a loss in terms of the risk of new simp lemmas being added to the standard simp set which might block <code>foo</code>, <code>bar</code> etc from applying, because <code>{standard simp set} ∪ {foo, bar, baz, quux}</code> may well not be confluent. (The latter may not be an issue if <code>simp</code> prioritizes lemmas explicitly given as arguments over library simp lemmas; I don't know much about the internals of <code>simp</code>.)</p>\n<p>Perhaps it might be better to take a middle path, and say that if <code>simp</code> <em>without arguments</em> works as a terminal tactic, it should be left unsqueezed, but that terminal <code>simp only</code> may still be appropriate when the simp call needs to use a mixture of standard simp lemmas + other extra ones?</p>",
        "id": 494653837,
        "sender_full_name": "David Loeffler",
        "timestamp": 1737302566
    },
    {
        "content": "<p>Your example seems to argue that the rule should rather be \"if a terminal <code>simp</code> does not use any lemma from the standard simp set, then it can be squeezed\"</p>",
        "id": 494661369,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1737308305
    },
    {
        "content": "<p>That was not the intent of my argument. I presented this example as an extreme case, but there's a spectrum here. </p>\n<p>I'm arguing that: if a terminal simp uses <em>no</em> lemmas from the standard simp set, then it should <em>always</em> be squeezed (as in my example from <a href=\"https://github.com/leanprover-community/mathlib4/pull/20813\">#20813</a>); if it uses <em>only</em> lemmas from the standard set, it should <em>never</em> be squeezed; and if it is a mix of the two, then it should be up to the author's judgement whether to squeeze it or not.</p>",
        "id": 494736288,
        "sender_full_name": "David Loeffler",
        "timestamp": 1737358053
    },
    {
        "content": "<p>I definitely agree with your first two points, but the third one (the \"mix\") can be interpreted in a variety of different ways and personal experience suggests that it would better be interpreted as \"almost always leave unsqueezed\"</p>",
        "id": 494736606,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1737358185
    },
    {
        "content": "<p>Your personal experience and mine differ here, and that is precisely why I am suggesting that it should be up to the code author's judgement.</p>",
        "id": 494736790,
        "sender_full_name": "David Loeffler",
        "timestamp": 1737358240
    },
    {
        "content": "<p>Eg I am currently adapting the API for conditional expectation to conditional variance and (after fixing the statements the obvious way) most fixes to broken proofs have been \"unsqueeze the simp\"</p>",
        "id": 494736795,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1737358244
    },
    {
        "content": "<p>Sure, but can we trust beginners to do the right call? They tend to oversqueeze</p>",
        "id": 494736926,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1737358296
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/345428-mathlib-reviewers/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/494653837\">said</a>:</p>\n<blockquote>\n<p>it can fail in another, much more pernicious reason, which is if a new lemma gets added to the standard simp set which works against <code>bar</code>; and this kind of failure, while probably rarer, is going to be a whole lot harder to debug.</p>\n</blockquote>\n<p>This, to me, is a very hypothetical situation. When such a simp failure happens, you should turn <code>diagnostics</code> on and inspect which lemmas were used.</p>",
        "id": 494737134,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1737358383
    },
    {
        "content": "<p>I am concerned that the situation might become less hypothetical in future, if we start introducing lots of un-squeezed terminal simps to mathlib. But time will tell.</p>\n<p>(I would also like to suggest that it might be better if changes to library style / conventions, which all contributors are expected to abide by, could be announced a bit more prominently than this one was.)</p>",
        "id": 494769616,
        "sender_full_name": "David Loeffler",
        "timestamp": 1737368140
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/345428-mathlib-reviewers/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/494737134\">said</a>:</p>\n<blockquote>\n<p>This, to me, is a very hypothetical situation. When such a simp failure happens, you should turn <code>diagnostics</code> on and inspect which lemmas were used.</p>\n</blockquote>\n<p>If the simp was not squeezed, you now have to do this twice, once on your branch at and once on matter.</p>",
        "id": 494770362,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737368333
    },
    {
        "content": "<p>(and wait for the corresponding cache download and unpack)</p>",
        "id": 494770419,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737368355
    },
    {
        "content": "<p>Also, can we make this discussion public? I would like to point it out to a new contributor.</p>",
        "id": 494781394,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1737371378
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"345428\" href=\"/#narrow/channel/345428-mathlib-reviewers/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F\">#mathlib reviewers &gt; request: discourage squeezing terminal simps?</a> by <span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span>.</p>",
        "id": 494807772,
        "sender_full_name": "Notification Bot",
        "timestamp": 1737378957
    },
    {
        "content": "<p><span aria-label=\"looking\" class=\"emoji emoji-1f440\" role=\"img\" title=\"looking\">:looking:</span> new lore just dropped</p>",
        "id": 494833818,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1737385595
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/494737134\">said</a>:</p>\n<blockquote>\n<p>This, to me, is a very hypothetical situation. When such a simp failure happens, you should turn <code>diagnostics</code> on and inspect which lemmas were used.</p>\n</blockquote>\n<p>Yael's \"very hypothetical situation\" – or something very close to it – seems to be happening already. </p>\n<p>In the course of reviewing <a href=\"https://github.com/leanprover-community/mathlib4/pull/20661\">#20661</a>, I ran into several terminal <code>simp only</code>'s (or <code>simpa only</code>'s) which fail when changed into <code>simp</code>'s, for reasons which I have not been able to identify. Apparently some lemma from the default simp set is conflicting with the explicitly-provided lemmas, but I have not been able to work out which; and prefacing the theorem concerned with <code>set_option diagnostics true in</code> does not provide any relevant information at all.</p>",
        "id": 495978615,
        "sender_full_name": "David Loeffler",
        "timestamp": 1737907364
    },
    {
        "content": "<p>If it is considered a desirable goal to avoid squeezing terminal simps, can we have some guidance on how to diagnose and correct failures of this type?</p>",
        "id": 495978968,
        "sender_full_name": "David Loeffler",
        "timestamp": 1737907632
    },
    {
        "content": "<p>If you write <code>simp? [existing explicitly provided lemmas]</code>, does the output show lemmas that are not listed? What happens if your exclude those?</p>",
        "id": 495982637,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1737910383
    },
    {
        "content": "<p>Good point! Of course <code>simp?</code> will show what lemmas are applied even if it doesn't succeed in closing the goal. It took me a little while to realise how to extend this to <code>simpa only</code>, but the solution seems to be to replace <code>simpa only [...] using foo</code> with <code>have := foo; simp? [...] at this ⊢</code> and see what lemmas get applied.</p>",
        "id": 495985355,
        "sender_full_name": "David Loeffler",
        "timestamp": 1737912373
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21179\">#21179</a> squeezes a few slow terminal simps (and speeds up the file by 17%/ ~40*10⁹ instructions). Initially, I put comments that these were squeezed. <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> suggested I remove them (as they distract from the mathematics). I agree they do, but also would like to note the simps being squeezed for performance reasons. What do others think?</p>",
        "id": 496408689,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1738092199
    },
    {
        "content": "<p>(My comments also mention specific timings; I'd be happy to remove these before merging.)</p>",
        "id": 496408763,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1738092226
    },
    {
        "content": "<p>Bad idea: Periodically, someone could run a script which auto-unsqueezes terminal simps whenever that does not increase heartbeats by more than a certain threshold. Then it would be clear the remaining ones are there for performance reasons.</p>",
        "id": 496409613,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1738092506
    },
    {
        "content": "<p>It would be good to have some clarity on how slow is “too slow”, since we now have the slightly absurd situation that there are simultaneously PRs submitted to unsqueeze simps and others to squeeze them.</p>",
        "id": 496420052,
        "sender_full_name": "David Loeffler",
        "timestamp": 1738096702
    },
    {
        "content": "<p>As for <span class=\"user-mention\" data-user-id=\"325367\">@Mauricio Collares</span> suggestion: we have tooling for automatically squeezing simps, but not for unsqueezing them; it’s not easy to automate - sometimes it takes a bit of manual tinkering when a lemma from the standard simp set conflicts with an explicitly provided one. So I think your “bad idea” script would be very hard to write.</p>",
        "id": 496421582,
        "sender_full_name": "David Loeffler",
        "timestamp": 1738097336
    },
    {
        "content": "<p>didn't we once have <code>simp? says simp only [...]</code> as a syntax which <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>  made for exactly this situation? What happened to that?</p>",
        "id": 496422140,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738097548
    },
    {
        "content": "<p>I think that <code>says</code> did not really work as expected.  My impression is that it made code harder to maintain, since, for instance, any change in what <code>simp?</code> would output would trigger an error of <code>says</code>.</p>",
        "id": 496424284,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738098350
    },
    {
        "content": "<p>So, a <code>simp</code> producing a valid proof could stop working, since the output of <code>simp?</code> changed.</p>",
        "id": 496424405,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738098399
    },
    {
        "content": "<p>Maybe we could make two modifications to <code>says</code> to make it more usable:</p>\n<ul>\n<li>do not run <code>set_option says.verify true</code> in CI: maybe we don't care whether the result is outdated as long as it still compiles?</li>\n<li>If the latter part (i.e. the <code>simp only</code>) fails to compile, try to elaborate the former and suggest the new squeezed version if successful. (I never looked at how reviewdog works, but maybe that suggestion can be posted to the PR breaking a <code>says</code> automatically?)</li>\n</ul>",
        "id": 496425520,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738098843
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/496421582\">said</a>:</p>\n<blockquote>\n<p>As for <span class=\"user-mention silent\" data-user-id=\"325367\">Mauricio Collares</span> suggestion: we have tooling for automatically squeezing simps, but not for unsqueezing them; it’s not easy to automate - sometimes it takes a bit of manual tinkering when a lemma from the standard simp set conflicts with an explicitly provided one. So I think your “bad idea” script would be very hard to write.</p>\n</blockquote>\n<p>It would be very hard to write properly, but a naïve \"replace a terminal <code>simp only [...]</code> by just <code>simp</code>, and see if that succeeds in closing the goal\" shouldn't be too bad (famous last words). If it results in an error, just don't do anything. This still has the advantage that if you notice a terminal <code>simp only</code> than can be manually replaced by <code>simp</code>, then you know it's there for perf reasons.</p>",
        "id": 496426650,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1738099406
    },
    {
        "content": "<p>I should think that what we really want is to delete \"only\" and then start deleting elements of the list and putting them back if things break.</p>",
        "id": 496426944,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738099556
    },
    {
        "content": "<blockquote>\n<p>replace a terminal <code>simp only [...]</code> by just <code>simp</code>, and see if that succeeds in closing the goal</p>\n</blockquote>\n<p>This will almost always fail, if the examples I encountered when making <a href=\"https://github.com/leanprover-community/mathlib4/pull/21133\">#21133</a> are at all representative: most of them have one or two manually-added lemmas alongside a bunch more from the standard simp set. A slightly less naive \"replace a terminal <code>simp only [lemmas]</code> with <code>simp [subset of those lemmas which are not @simp flagged]</code>\" would have a much better chance of working, but would need to be able to interrogate the current context to find out which lemmas have @simp activated.</p>",
        "id": 496427235,
        "sender_full_name": "David Loeffler",
        "timestamp": 1738099671
    },
    {
        "content": "<blockquote>\n<p>I should think that what we really want is to delete \"only\" and then start deleting elements of the list and putting them back if things break.</p>\n</blockquote>\n<p>This is pretty much what I did by hand to make <a href=\"https://github.com/leanprover-community/mathlib4/pull/21133\">#21133</a>; but sometimes it already breaks as soon as you delete the <code>only</code>, without changing the content of the <code>[...]</code> at all, and then you need to work out which standard simp lemma you need to explicitly nerf in order to stop it conflicting with the rest (<code>neg_add_rev</code> was a frequent culprit)</p>",
        "id": 496427487,
        "sender_full_name": "David Loeffler",
        "timestamp": 1738099788
    },
    {
        "content": "<p>(Tangentially related question: how hard would it be to make the hover tooltip on lemma names in VSCode tell you whether those lemmas are <code>@simp</code> or not?)</p>",
        "id": 496427917,
        "sender_full_name": "David Loeffler",
        "timestamp": 1738099958
    },
    {
        "content": "<p>I do not know how to display this in VSCode, but you can easily write a command that checks if a declaration is marked with <code>simp</code> or not:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#is_simp \"</span><span class=\"w\"> </span><span class=\"n\">ids</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">se</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">simpExtension</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ids</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">id</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">se</span><span class=\"bp\">.</span><span class=\"n\">lemmaNames</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"'{.ofConstName nm}' has the `simp` attribute!\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">logWarningAt</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"'{.ofConstName nm}' does not have the `simp` attribute!\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">is_simp</span><span class=\"w\"> </span><span class=\"n\">X</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_mul</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">is_simp</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_mul</span>\n\n<span class=\"bp\">#</span><span class=\"n\">is_simp</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_mul</span>\n</code></pre></div>",
        "id": 496430079,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738100905
    },
    {
        "content": "<p>I think my preference is for lots of comments: squeeze terminal simps whenever you feel there is a performance benefit (probably should be at least 10,000 heartbeats to bother?), but then leave a comment to that effect.</p>",
        "id": 496442333,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738107411
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/496442333\">said</a>:</p>\n<blockquote>\n<p>I think my preference is for lots of comments: squeeze terminal simps whenever you feel there is a performance benefit (probably should be at least 10,000 heartbeats to bother?), but then leave a comment to that effect.</p>\n</blockquote>\n<p>Just to clarify: do you mean the simp call alone should be taking more than 10k heartbeats in order to be squeezed, or the whole proof that contains it? (I don't know if there's a one-shot way to count heartbeats in an individual tactic step, although of course one can count for the whole proof pre &amp; post squeezing and compare.)</p>",
        "id": 496522602,
        "sender_full_name": "David Loeffler",
        "timestamp": 1738148956
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/496522602\">said</a>:</p>\n<blockquote>\n<p>I don't know if there's a one-shot way to count heartbeats in an individual tactic step</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- 624</span>\n</code></pre></div>",
        "id": 496539841,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738154712
    },
    {
        "content": "<p>that said, I don't know the implementation and/or don't understand fully what heartbeats are:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 6 heartbeats, which is less than the current maximum of 200000.</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- 624</span>\n</code></pre></div>",
        "id": 496540581,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738154963
    },
    {
        "content": "<p>I don't know if this is the reason, but there are <code>heartbeats</code> and \"<code>kiloheartbeats</code>\", but they are both called the same.</p>",
        "id": 496601896,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738171997
    },
    {
        "content": "<p>So, sometimes, you have to divide by 1000 or multiply by 1000 to get the same scale.</p>",
        "id": 496601985,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738172023
    },
    {
        "content": "<p>(I just made up <code>kiloheartbeats</code>, in case it was not clear!)</p>",
        "id": 496602101,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738172049
    },
    {
        "content": "<p>Yes, this is a recurring issue: the whole-proof-level <code>count_heartbeats in …</code> uses kiloHBt, while the hashed <code>#count_heartbeats tac</code>seems to use raw HBt. I assume Kim’s intended threshold was 10,000 kHBt, which is several tens of seconds on my machine, not 10 kHBt, which is less than even the most trivial tactic steps.</p>",
        "id": 496622321,
        "sender_full_name": "David Loeffler",
        "timestamp": 1738176785
    },
    {
        "content": "<p>No one has mentioned <code>simp [-foo, bar]</code> as an option for making things more robust? </p>\n<p>Not infrequently I have something with one non-simp lemma bar, and that together with some ten standard simp lemmas will close the goal, but it's in conflict with a standard simp lemma foo.</p>\n<p>My usual go-to is a long <code>simp only</code>, but I've been toying with using simp lemma exclusion instead and I think it's more readable for myself later.</p>\n<p>If/when the simp later breaks, if I run <code>simp? [-foo, bar]?</code> at that place, I'm pretty much guaranteed to see one simp lemma in the output whose left hand side matches that of <code>foo</code>, and that's the culprit to exclude.</p>",
        "id": 496693723,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1738213090
    },
    {
        "content": "<p>(Just an aside: when you find yourself using <code>-foo</code>, please feel encouraged to investigate the impact of removing the <code>@[simp]</code> from <code>foo</code> entirely!)</p>",
        "id": 496693807,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738213190
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/request.3A.20discourage.20squeezing.20terminal.20simps.3F/near/496601985\">said</a>:</p>\n<blockquote>\n<p>So, sometimes, you have to divide by 1000 or multiply by 1000 to get the same scale.</p>\n</blockquote>\n<p>Just like with calories <span aria-label=\"rofl\" class=\"emoji emoji-1f923\" role=\"img\" title=\"rofl\">:rofl:</span></p>",
        "id": 496712166,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1738223695
    }
]