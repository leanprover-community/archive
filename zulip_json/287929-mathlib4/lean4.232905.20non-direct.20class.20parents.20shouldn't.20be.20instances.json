[
    {
        "content": "<p>It would be helpful if someone who's good at understanding typeclass synthesis issues could take a look at the <code>lean-pr-testing-5920</code> branch and figure out whether my adaptations for <a href=\"https://github.com/leanprover/lean4/pull/5920\">lean4#5920</a> are reflecting a deep issue, or whether we're sure we can adapt and we should move forward. Here are all the changes: <a href=\"https://github.com/leanprover-community/mathlib4/commit/bf65d209ffe1a810aa8b391c5061c8f9edcf99e3\">https://github.com/leanprover-community/mathlib4/commit/bf65d209ffe1a810aa8b391c5061c8f9edcf99e3</a>. In particular, in <code>‎Mathlib/RingTheory/TensorProduct/MvPolynomial.lean</code> the CoeFun instance simply stopped working and I wrote <code>.toFun</code> manually.</p>\n<p>A reminder about what <a href=\"https://github.com/leanprover/lean4/pull/5920\">lean4#5920</a> does: it adjusts the rule for which instances get created from the <code>extends</code> list. Now it's simply that <em>only</em> these parents' projections become instances. Formerly, every subobject projection to a class would become an instance as well.</p>\n<p>It's worth noting that in <code>Mathlib/Data/NNReal/Defs.lean</code> some instances are now noncomputable because it typeclass synthesis finds these big nested projections rather than a smaller term. (I'm wondering whether instance synthesis should collapse parent projections automatically. That would be an optimization to consider later.)</p>",
        "id": 481594371,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731270427
    },
    {
        "content": "<p>2 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Ways.20to.20speed.20up.20Mathlib\">#mathlib4 &gt; Ways to speed up Mathlib</a> by <span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span>.</p>",
        "id": 481597343,
        "sender_full_name": "Notification Bot",
        "timestamp": 1731272807
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/lean4.232905.20non-direct.20class.20parents.20shouldn't.20be.20instances/near/481594371\">said</a>:</p>\n<blockquote>\n<p>It's worth noting that in <code>Mathlib/Data/NNReal/Defs.lean</code> some instances are now noncomputable because it typeclass synthesis finds these big nested projections rather than a smaller term.</p>\n</blockquote>\n<p>We lazily added shortcut instances in the past to avoid this issue; so inevitably a refactor of parent instances will leave our sparse shortcuts in the wrong places. This should be easy enough to fix in mathlib the same way we have in the past.</p>",
        "id": 481602410,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731277134
    },
    {
        "content": "<p><code>toFun</code> is probably not the fix we want, but it's pretty common for some random unification problem to be solved by coincidence under one set of instances, but need extra explicit type arguments under another. Does adding the types to <code>rtensor</code> also work?</p>",
        "id": 481602642,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731277324
    },
    {
        "content": "<p>Yeah, <code>toFun</code> is not the right fix, just something to get mathlib to build. I'd really appreciate if you or someone could experiment with it if you have any time. I won't get back to this for another day or two.</p>",
        "id": 481603428,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731278128
    },
    {
        "content": "<p>I have some time this morning to check out your adaptations, will report back in a bit :)</p>",
        "id": 481660122,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731313516
    },
    {
        "content": "<p>I've fixed it, Lean was having problems unifying <code>Zero (_ ⊗[_] _)</code> and <code>Zero (addConGen (TensorProduct.Eqv _ _ _)).Quotient</code>.</p>",
        "id": 481665942,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1731315484
    },
    {
        "content": "<p>Maybe we should apply your fix directly to master?</p>",
        "id": 481673901,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731317930
    },
    {
        "content": "<p>After <span class=\"user-mention\" data-user-id=\"455791\">@Yuyang Zhao</span>'s fixes, the only issue is that we actually have a diamond (on the master branch!) between <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NNRat.instSemifield#doc\">docs#NNRat.instSemifield</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instNNRatLinearOrderedSemifield#doc\">docs#instNNRatLinearOrderedSemifield</a>, where the former defines <code>zsmul</code> using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=zsmulRec#doc\">docs#zsmulRec</a> and the latter with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nonneg.zsmul#doc\">docs#Nonneg.zsmul</a>. I made <a href=\"https://github.com/leanprover-community/mathlib4/pull/18860\">#18860</a> to fix that diamond.</p>",
        "id": 481693226,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731323638
    },
    {
        "content": "<p>In general <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TensorProduct#doc\">docs#TensorProduct</a> being a <code>def</code> seems like you are inviting trouble</p>",
        "id": 481703290,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731326444
    },
    {
        "content": "<p>Thanks everyone! It sounds like <a href=\"https://github.com/leanprover/lean4/pull/5920\">lean4#5920</a> doesn't have any fundamental problems and we should be able to adapt. There's a slight negative performance impact to it(*), but I take it that we should be able to add shortcut instances as necessary.</p>\n<p>Some problems do take more heartbeats now — I bumped up the default value of <code>synthInstance.maxHeartbeats</code> to compensate, at least to get mathlib to build. The failure was during the simpNF linter, where there was a timeout when trying to simplify the LHSs of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.sup_mul_right_self#doc\">docs#Ideal.sup_mul_right_self</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.sup_mul_left_self#doc\">docs#Ideal.sup_mul_left_self</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.mul_right_self_sup#doc\">docs#Ideal.mul_right_self_sup</a>, and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.mul_left_self_sup#doc\">docs#Ideal.mul_left_self_sup</a>.</p>\n<p>(*) I'm not sure exactly how to interpret the benchmark results for <a href=\"https://github.com/leanprover-community/mathlib4/pull/18830\">#18830</a>. Some of the differences seem random, and I wonder if it's actually comparing with a comparable run.</p>",
        "id": 481774592,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731346480
    }
]