[
    {
        "content": "<p>I've thought for a while that it would be nice to have some concrete benchmarks in CI for detecting when changes materially affect the performance of typeclass synthesis. </p>\n<p>One benchmark that seems reasonable is to instantiate the parameters of a typeclass as generically as possible and time how long it takes to fail. </p>\n<p>As an experiment, I tasked claude code to do this. At first it decided it was best if all the type arguments were metavariables, instead of free. This was not what I was expecting but the reasoning was the metavariables would specialize to any type carrying an instance. </p>\n<p>Performance was materially different from, though the times were very small compared to, my intended setup so this was left as a separate test. </p>\n<p>The code for generating each test was pretty good to me at quick inspection. </p>\n<p>I then let it freelance on \"human-readable\" representations of the instance graph traversed. It made a <a href=\"/user_uploads/3121/1Cj3rXgJh8brqU9zDQtAr5so/Screenshot-2026-02-25-at-11.59.25AM.png\">nice flame graph in html</a> which I found much more consumable than the cycle of clicking to unfold traces. The code for html and the consumption of the tracing output was more gross but that might also reflect the current situation somewhat, unsure because I don't try to use lean to generate html. </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/1Cj3rXgJh8brqU9zDQtAr5so/Screenshot-2026-02-25-at-11.59.25AM.png\" title=\"nice flame graph in html\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2232x1540\" src=\"/user_uploads/thumbnail/3121/1Cj3rXgJh8brqU9zDQtAr5so/Screenshot-2026-02-25-at-11.59.25AM.png/840x560.webp\"></a></div><p>The code itself can be found at <a href=\"https://github.com/leanprover-community/mathlib4/compare/master...mattrobball:mathlib4_fork:synth-failure-benchmark\">https://github.com/leanprover-community/mathlib4/compare/master...mattrobball:mathlib4_fork:synth-failure-benchmark</a> </p>\n<p>For some reason it thought storing the output json in .lake was a good idea. But as I said, I was pretty hands off. </p>\n<p>Running it did return some problematic instances with a repro below. The full file is <br>\n<a href=\"/user_uploads/3121/beQq6afFMJh_FNUHUBXYlwHg/synth_failure_benchmark_concrete.json\">synth_failure_benchmark_concrete.json</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span>\n\n<span class=\"c1\">-- #1: CategoryTheory.GrothendieckTopology.HasSheafCompose</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">J</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">GrothendieckTopology</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">J</span><span class=\"bp\">.</span><span class=\"n\">HasSheafCompose</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n\n<span class=\"c1\">-- #2: CategoryTheory.Injective</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">J</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Injective</span><span class=\"w\"> </span><span class=\"n\">J</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n\n<span class=\"c1\">-- #3: CategoryTheory.Projective</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Projective</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n\n<span class=\"c1\">-- #4: MeasurableSpace.CountablySeparated</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">MeasurableSpace</span><span class=\"bp\">.</span><span class=\"n\">CountablySeparated</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>I think tracking such information could be useful but I don't know enough about the inherent variability in the process to figure out meaningful cutoffs. </p>\n<p>Overall, I think a bit more investigation is needed before PRing anything for CI.</p>",
        "id": 576033524,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1772115129
    },
    {
        "content": "<p>Bonus points if you can guess the problems with Injective and Projective off the top of your head :)</p>",
        "id": 576035772,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1772115656
    }
]