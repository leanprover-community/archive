[
    {
        "content": "<p>I got the impression that there are too many different things that are all represented as <code>‚Ä¢</code> in Mathlib. Consider the following.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">AlgebraMap</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"c1\">-- A perfectly good action of `R` on `R[X]`:</span>\n<span class=\"kn\">noncomputable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">aeval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n<span class=\"kn\">noncomputable</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">inst1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">f</span>\n<span class=\"w\">  </span><span class=\"n\">one_smul</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">act</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">mul_smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">act</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">map_mul</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">aeval_algHom_apply</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">map_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">aeval_C</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">algebraMap_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">aeval_X</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">congr</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"n\">ring</span>\n<span class=\"w\">  </span><span class=\"n\">smul_zero</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">act</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">smul_add</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">act</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_add</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">smul_one</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">act</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">smul_mul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">act</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">act</span><span class=\"o\">]</span>\n\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- But now we have two different `Smul`s `R ‚Üí R[X] ‚Üí R[X]` ...</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">mul_one</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">smul_eq_C_mul</span><span class=\"o\">]</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">MulAction</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"bp\">.</span><span class=\"n\">toDistribMulAction</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">smul_one</span><span class=\"w\"> </span><span class=\"n\">r</span>\n</code></pre></div>\n<p>On the one hand, there is the natural action by scalar multiplication coming from the fact that <code>R[X]</code> is an <code>R</code>-algebra. On the other hand, we may want to have another action that (for example) acts via ring homomorphisms (as in the example). And usually, we may want to use both at the same time.</p>\n<p>So I think that it might make sense to separate true scalar multiplication (which satisfies <code>(r + s) ‚Ä¢ x = r ‚Ä¢ x + s ‚Ä¢ x</code>) from other actions by monoids (like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MulSemiringAction#doc\">docs#MulSemiringAction</a>). This would involve two have two different notation classes (and certainly some duplication of API), but would allow having both kinds of action at the same time (and, for example, enable one to write down that they are compatible without jumping through a lot of hoops). I also think that such a separation may help with problems like the one discussed in <a href=\"#narrow/channel/287929-mathlib4/topic/simp.20timeout.20at.20.60whnf.60/near/516747386\">#mathlib4 &gt; simp timeout at &#96;whnf&#96; @ üí¨</a>, where <code>simp</code> times out because it frantically tries to apply <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=smul_X#doc\">docs#smul_X</a> in a situation where it talks about the wrong kind of action. In particular, this could help with type class searches when <code>SMul</code> is involved.</p>\n<p>What do people think?</p>",
        "id": 518386688,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1747338207
    },
    {
        "content": "<p>I think it's not the case that <code>MulSemiringAction</code> can't use the notation, but rather that your particular instance of MulSemiringAction cannot</p>",
        "id": 518395384,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747341229
    },
    {
        "content": "<p><code>MulSemiringAction</code> works fine, I believe, for the action of a ring hom on a polynomial.</p>",
        "id": 518395461,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747341251
    },
    {
        "content": "<p>Section 4.5 in <a href=\"https://eric-wieser.github.io/thesis/eric-wieser-thesis.pdf#page=48\">my thesis chapter on scalar actions</a> has an example of why these endomorphism actions are in fact not a problem</p>",
        "id": 518395697,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747341354
    },
    {
        "content": "<p>But it can still interact badly behind the scenes and cause slowness...</p>",
        "id": 518395807,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1747341382
    },
    {
        "content": "<p>... even (or in particular?) when  there is no <code>MulSemiringAction</code> actually available.</p>",
        "id": 518396962,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1747341820
    },
    {
        "content": "<p>I don't think removing the instances or simp lemmas is the answer to the slowness</p>",
        "id": 518413731,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747349824
    },
    {
        "content": "<p>Or at least, I'd strongly prefer that we keep that solution as a last resort</p>",
        "id": 518413906,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747349953
    },
    {
        "content": "<p>I'm not suggesting to remove instances or <code>simp</code> attributes. Rather, the suggestion is to split the <code>SMul</code>s into actual scalar multiplications and other actions by monoids. This would separate the relevant instances (so that they don't interfere with each other), but not remove them. And having different notations would prevent <code>simp</code> from trying to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=smul_X#doc\">docs#smul_X</a> when we are dealing with scalar multiplication, because the terms wouldn't match.</p>",
        "id": 518496001,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1747387610
    }
]