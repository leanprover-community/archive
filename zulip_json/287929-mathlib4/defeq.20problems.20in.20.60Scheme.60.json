[
    {
        "content": "<p>I'm hoping to nerd-snipe someone into taking a look at this. :-)</p>\n<p>There are lots of <code>erw</code> problems in schemes in Lean, e.g. in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.inv_appTop#doc\">docs#AlgebraicGeometry.Scheme.inv_appTop</a>. Poking around with <code>erw?</code>, <code>check_compositions</code>, and the new <code>check_equalities</code> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/22366\">#22366</a> leads me to believe two things:</p>\n<ul>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Opens.map_top#doc\">docs#Opens.map_top</a> is a bad dsimp lemma, because it very often rewrites in implicit arguments and then later blocks syntactic rewriting: can we just replace its proof by <code>id rfl</code>, to prevent <code>dsimp</code> using it? What are the consequences?</li>\n<li>The definition of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.appTop#doc\">docs#AlgebraicGeometry.Scheme.appTop</a> is \"wrong\", and should be</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">appTop</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⊤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">⊤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"bp\">⊤</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">.</span><span class=\"n\">presheaf</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eqToHom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Opens</span><span class=\"bp\">.</span><span class=\"n\">map_top</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">op</span>\n</code></pre></div>\n<p>Can we repair the rest of the file after making this change? Does it reduce the need for <code>erw</code>?</p>",
        "id": 502258188,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740655099
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> it’s time to redo schemes, just like in the good old days!</p>",
        "id": 502259250,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740655480
    },
    {
        "content": "<p>I'll see if I can get some people at Xena interested in looking at this today. I feel like schemes has moved on a lot since I last looked at it :-)</p>",
        "id": 502262534,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1740656614
    },
    {
        "content": "<p>Should we more generally lint against reducible definitions that are not \"type correct at reducible transparency\"?</p>",
        "id": 502265877,
        "sender_full_name": "Christian Merten",
        "timestamp": 1740657712
    },
    {
        "content": "<p><code>appTop</code> should be <code>appLE ⊤ ⊤ sorry</code> (which is probably reducibly equal to your suggestion). <br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.comp_app#doc\">docs#AlgebraicGeometry.Scheme.comp_app</a> (<code>(f ≫ g).app U = g.app U ≫ f.app (f ⁻¹ᵁ U)</code>) also relies on the defeq <code>Opens.map</code> gives, and it might be time we phase these out and switch to <code>appLE</code> completely.</p>",
        "id": 502266863,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1740658032
    },
    {
        "content": "<p>Anyone interested in fixing the definition of <code>appTop</code> per <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span>'s suggestion?</p>",
        "id": 504712244,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1741652031
    },
    {
        "content": "<p>I did a start in <a href=\"https://github.com/leanprover-community/mathlib4/pull/22820\">#22820</a>, but have to run now. I'll have a look later today if it is not done by then :) Did you encounter any <code>erw</code>s that you associated with <code>appTop</code>, <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>?</p>",
        "id": 504776461,
        "sender_full_name": "Christian Merten",
        "timestamp": 1741683305
    },
    {
        "content": "<p>We might have to transition from <code>Scheme.Hom.app</code> to <code>Scheme.Hom.appLE</code> everywhere first before we get any gains from the <code>appTop</code> fix.</p>",
        "id": 504776797,
        "sender_full_name": "Christian Merten",
        "timestamp": 1741683391
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"648495\">@Christian Merten</span>, I think the first one I encountered was <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.IsAffineOpen.isoSpec_inv_appTop#doc\">docs#AlgebraicGeometry.IsAffineOpen.isoSpec_inv_appTop</a></p>",
        "id": 507091166,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1742512261
    },
    {
        "content": "<p>Fixing <code>appTop</code>alone does not seem to fix anything, another \"wrong\" lemma is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.Opens.toScheme_presheaf_map#doc\">docs#AlgebraicGeometry.Scheme.Opens.toScheme_presheaf_map</a> which \"abuses\" the def-eq <code>Γ(U, V) = Γ(X, U.ι ''ᵁ V)</code>. Almost every lemma in <code>Mathlib.AlgebraicGeometry.Restrict</code> uses this def-eq.</p>\n<p>A cheap fix is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">unif_hint</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">.</span><span class=\"n\">Opens</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"bp\">.</span><span class=\"n\">toScheme</span><span class=\"bp\">.</span><span class=\"n\">Opens</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"o\">(</span><span class=\"n\">U</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≟</span><span class=\"w\"> </span><span class=\"n\">Γ</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"bp\">.</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"bp\">''ᵁ</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>the proof of your example then becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">isoSpec_inv</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"bp\">.</span><span class=\"n\">isoSpec</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>Is this acceptable or do we need to fix every lemma in <code>Mathlib.AlgebraicGeometry.Restrict</code> manually? (By pre- and postcomposing with suitable <code>Γ(U, V) = Γ(X, U.ι ''ᵁ V)</code>-isomorphisms).</p>",
        "id": 507241977,
        "sender_full_name": "Christian Merten",
        "timestamp": 1742553425
    }
]