[
    {
        "content": "<p>I think the <code>existingAttributeWarning</code> should not fire for <code>to_additive existing</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">add_foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">warning: The source declaration mul_foo was given the simp-attribute(s) simp before calling @[to_additive].</span>\n<span class=\"sd\">The preferred method is to use something like `@[to_additive (attr := simp)]`</span>\n<span class=\"sd\">to apply the attribute to both mul_foo and the target declaration add_foo.</span>\n\n<span class=\"sd\">Note: This linter can be disabled with `set_option linter.existingAttributeWarning false`</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"n\">existing</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mul_foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>Does this make sense? The warning is disabled for <code>to_additive self</code>, and <code>to_additive</code> doesn't add attributes to <code>existing</code> decls anyways:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">add_foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">existing</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mul_foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"sd\">/-- warning: `add_foo` does not have the `[simp]` attribute -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">add_foo</span>\n</code></pre></div>\n<p>Maybe the warning shouldn't be turned off, but rather combining <code>existing</code> and <code>attr</code> should check if the existing decl has the specified attributes and warn if not?</p>",
        "id": 567158426,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1767970187
    },
    {
        "content": "<p>Seems reasonable. PR welcome!</p>",
        "id": 567585714,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1768235767
    },
    {
        "content": "<p>The problem is that you wrote <code>to_additive (attr := simp) existing</code> instead of <code>to_additive existing (attr := simp)</code>. Your version creates a new declaration called <code>existing</code>.</p>\n<p>I wonder what the best way is to safe-guard agains such easy to make mistakes. Similarly making a typo can give confusing results, e.g. <code>@[to_additive exitsing]</code> generates a declaration <code>exitsing</code>.</p>",
        "id": 567604641,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1768240360
    },
    {
        "content": "<p>So for <code>existingAttributeWarning</code>, it does fire for <code>to_additive existing</code>, because <code>to_additive existing (attr := ...)</code> does put the attributes on both declarations.</p>",
        "id": 567605161,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1768240504
    }
]