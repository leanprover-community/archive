[
    {
        "content": "<p>In experimenting with the upcoming overlapping variables linter in <a href=\"https://github.com/leanprover-community/mathlib4/pull/34955\">#34955</a>, it became apparent that it's (reasonably) common style to shadow instance variables when declaring an instance, e.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Baz</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>This means that in the local context in the fields of <code>Baz</code>, the instances are duplicated. The actual resulting declaration is (I believe) fine, though. (I.e. it does not wind up with duplicate instances, since lean only takes the ones that are used).</p>\n<p>How do we feel about this? On the one hand, I feel like duplicating instances in a local context is not great. Specifically, I'd weakly prefer <em>not</em> using <code>variable</code> before <code>instance</code>, so you can still always see the instances required explicitly for an <code>instance</code>, but do not duplicate them in the local context. But...I would also love to not have to restructure this linter. :) So I worry that that makes me biased, and that my sense that not shadowing variables is actually nicer is merely an artifact of its benefit to me.</p>\n<p>So, what do you think? Is it reasonable for this linter to discourage this sort of instance hypothesis shadowing, or should it stay silent in cases like this?</p>",
        "id": 572586194,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1770522377
    },
    {
        "content": "<p>What's the reason for duplicating the instance assumptions at the <code>instance</code> declaration?</p>",
        "id": 572586398,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770522582
    },
    {
        "content": "<p>I'm assuming the goal is showing in source more clearly which <code>instance</code>s let you synthesize this instance, but I'm just inferring this based on the fact that it turns out to be common enough to produce a ton of linter violations. (Sometimes the <code>variable</code> is further up, with some commands in between.)</p>\n<p>But it is possible it's just a bunch of oversights! :)</p>",
        "id": 572586508,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1770522682
    },
    {
        "content": "<p>My guess is that it should be an oversight in most cases.</p>",
        "id": 572589639,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770525280
    },
    {
        "content": "<p>Could it be the case that sometimes it is caused by weakening or strengthening assumptions? e.g. assuming <code>CommRing</code> when in the context we have <code>Ring</code> or vice versa?</p>",
        "id": 572609171,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770545756
    },
    {
        "content": "<p>That sounds like it would go wrong unless you also redeclare the <code>A</code>, right?</p>",
        "id": 572616706,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1770553184
    },
    {
        "content": "<p>Sometimes for defs I think it happens to make the type argument explicit</p>",
        "id": 572616754,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1770553228
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Style.3A.20shadowing.20instance.20variables.20in.20instance.20declarations/near/572616706\">said</a>:</p>\n<blockquote>\n<p>That sounds like it would go wrong unless you also redeclare the <code>A</code>, right?</p>\n</blockquote>\n<p>I think it merely <em>could</em> go wrong, it doesn't guarantee issues.</p>",
        "id": 572625727,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770561818
    },
    {
        "content": "<p>Ok, great. :) Based on sampling a handful of errors, it seems that they are by and large merely duplicated, not weakened.</p>\n<p>Do we feel strongly about whether the hypotheses should be in <code>variable</code> or <code>instance</code>? If not, my general rule in fixing these will be:</p>\n<p>If there aren't very many instance hypotheses and the offending instance declaration is at the beginning/end of a section, keep inlined hypotheses and remove <code>variable</code>. Otherwise, keep the <code>variable</code> hypotheses and remove them from <code>instance</code>.</p>",
        "id": 572638718,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1770573127
    },
    {
        "content": "<p>Linter-independent fixes in this direction are now in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35002\">#35002</a>, <a href=\"https://github.com/leanprover-community/mathlib4/pull/35003\">#35003</a>, <a href=\"https://github.com/leanprover-community/mathlib4/pull/35006\">#35006</a>, and <a href=\"https://github.com/leanprover-community/mathlib4/pull/35007\">#35007</a>. After these, Mathlib should be ready for the overlapping instances linter, modulo a small handful of declarations.</p>",
        "id": 572674498,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1770608466
    }
]