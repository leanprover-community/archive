[
    {
        "content": "<p>CI has been modified recently wrt cache. As far as I can see, the cache is not uploaded any more for a failing build (see for instance the run of <a href=\"https://github.com/leanprover-community/mathlib4/pull/35252\">#35252</a>). This means that one can not any more fix iteratively a PR, which looks very bad to me. Is that by design, or should we fix/revert?</p>",
        "id": 574078304,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1771237781
    },
    {
        "content": "<p>PR?</p>",
        "id": 574079380,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1771238186
    },
    {
        "content": "<p>This is certainly not intended.</p>",
        "id": 574079698,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1771238315
    },
    {
        "content": "<p>This may be the culprit: <a href=\"https://github.com/leanprover-community/mathlib4/blob/c1475f9635e4b0a4effd917098e2fa3acf2cb8be/.github/workflows/build_template.yml#L607\">https://github.com/leanprover-community/mathlib4/blob/c1475f9635e4b0a4effd917098e2fa3acf2cb8be/.github/workflows/build_template.yml#L607</a></p>",
        "id": 574080414,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1771238586
    },
    {
        "content": "<p>It seems that uploading the cache is subject to the build step succeeding.  EDIT: maybe not exactly there.</p>",
        "id": 574080455,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1771238601
    },
    {
        "content": "<p>The CI change comes from <a href=\"https://github.com/leanprover-community/mathlib4/pull/34847\">#34847</a>, I guess.</p>",
        "id": 574081727,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1771238997
    },
    {
        "content": "<p>We really need some CI behavior tests</p>",
        "id": 574081896,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1771239056
    },
    {
        "content": "<p>It looks like the script that builds mathlib should have tried up to 5 times, but errored before finishing the first round.</p>",
        "id": 574082396,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1771239206
    },
    {
        "content": "<p>Let's ping <span class=\"user-mention\" data-user-id=\"439514\">@Marcelo Lynch</span>, since he is more knowledgeable of the current setup.</p>",
        "id": 574082572,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1771239261
    },
    {
        "content": "<p>Marcelo already made a fix for this in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35390\">#35390</a>. I would also like to bring attention to another fix he made in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35389\">#35389</a> which will make PRs like <a href=\"https://github.com/leanprover-community/mathlib4/pull/35390\">#35390</a> easier to merge.</p>",
        "id": 574099681,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1771245393
    },
    {
        "content": "<p>(I would have merged these myself, but I pushed a commit to <a href=\"https://github.com/leanprover-community/mathlib4/pull/35389\">#35389</a>.)</p>",
        "id": 574100737,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1771245745
    },
    {
        "content": "<p>I just sent <a href=\"https://github.com/leanprover-community/mathlib4/pull/35389\">#35389</a> to bors.</p>",
        "id": 574100816,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1771245771
    },
    {
        "content": "<p>OK, I've put <a href=\"https://github.com/leanprover-community/mathlib4/pull/35390\">#35390</a> in the same batch.</p>",
        "id": 574102108,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1771246195
    },
    {
        "content": "<p>These PRs are now merged so hopefully the the cache will be uploaded for failing builds as well. (The new versions of the build workflows should work even without merging <code>master</code>, although I'm not sure if re-running previous jobs will trigger the new versions or not.)</p>",
        "id": 574108154,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1771248080
    },
    {
        "content": "<p>It would be lovely if we could recover the old (back in mathlib3 days??) behaviour whereby even when a build was cancelled due to a new push, it would take the time to upload what it had so far.</p>",
        "id": 574220860,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771306740
    },
    {
        "content": "<p>I am pretty sure cancelled workflows do upload their cache currently ?</p>",
        "id": 574227050,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1771311512
    },
    {
        "content": "<p>I thought I saw this not working today, but indeed the yaml files suggest it should work!</p>",
        "id": 574231737,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771314320
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/22104324431/job/63882522232#step:22:280\">Here's an example</a></p>",
        "id": 574319393,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1771342179
    },
    {
        "content": "<p>I'm not sure if this is related to the new CI workflow but <code>lake exe cache get</code> is not working for me on <a href=\"https://github.com/leanprover-community/mathlib4/pull/29550\">#29550</a>.<br>\nWhen I cross compare the output of <code>lake exe cache get</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Fetching</span><span class=\"w\"> </span><span class=\"n\">ProofWidgets</span><span class=\"w\"> </span><span class=\"n\">cloud</span><span class=\"w\"> </span><span class=\"n\">release</span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"n\">done!</span>\n<span class=\"n\">Current</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Raph</span><span class=\"bp\">-</span><span class=\"n\">DG</span><span class=\"bp\">-</span><span class=\"n\">DVR</span>\n<span class=\"n\">Using</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Azure</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Raph</span><span class=\"bp\">-</span><span class=\"n\">DG</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">raph</span><span class=\"bp\">-</span><span class=\"n\">dg</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span>\n<span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">7997</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">4351</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">attempted</span><span class=\"w\"> </span><span class=\"mi\">7997</span><span class=\"bp\">/</span><span class=\"mi\">7997</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">63</span><span class=\"w\"> </span><span class=\"n\">KB</span><span class=\"bp\">/</span><span class=\"n\">s</span><span class=\"o\">]</span>\n<span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">7997</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">raph</span><span class=\"bp\">-</span><span class=\"n\">dg</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">attempted</span><span class=\"w\"> </span><span class=\"mi\">7997</span><span class=\"bp\">/</span><span class=\"mi\">7997</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">KB</span><span class=\"bp\">/</span><span class=\"n\">s</span><span class=\"o\">]</span>\n<span class=\"n\">Warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"w\"> </span><span class=\"n\">were</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>and the output of the CI on that commit</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">3646</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Raph</span><span class=\"bp\">-</span><span class=\"n\">DG</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>\n<p>I noticed that the capitalization are different, and when I went into <code>Cache/Requests.lean</code> and overwrote <code>getRepoFromRemote</code> to always return <code>Raph-DG/mathlib4</code> instead it successfully got cache.</p>\n<p>My local machine is running on MacOS and it might be related as MacOS seems to treat capitalization weirdly.</p>",
        "id": 575090890,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1771683716
    },
    {
        "content": "<p>Looking at the logs, this indeed should be caused by the mismatch in capitalization between the URL that Github returns (which has the capitalization) and the one used locally (which is 'chosen' when you <code>git clone http://...</code>, and GitHub treats this case insensitvely at this point so the mismatch would not cause an issue here</p>\n<p>This is not a regression caused by the recent changes, <code>--repo</code> has been treated case-sensitively since before those. </p>\n<p>A manual <code>git clone ...</code> with all-lowercase would be my best guess of how this happened. If you run  <code>git remote -v</code> you should see your local all-lowercase URL. You can change it to match the mixed-case one that is canonical for GitHub with <code>git remote set-url origin &lt;normalized-url&gt;</code> (assuming <code>origin</code> is the name here), and <code>cache</code> should use the updated one.</p>",
        "id": 575092126,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1771685238
    },
    {
        "content": "<p>.</p>",
        "id": 575092178,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1771685301
    }
]