[
    {
        "content": "<p>Tonight, the compilation of <a href=\"https://github.com/leanprover-community/mathlib4/pull/15158\">#15158</a> works, but at the end, the linter brings a myriad of errors such as </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Util</span><span class=\"bp\">/</span><span class=\"n\">SleepHeartbeats</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">6</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unused</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"ss\">`lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">shake</span><span class=\"w\"> </span><span class=\"c1\">--fix` to fix this, or `lake exe shake --update` to ignore)</span>\n</code></pre></div>\n<p>What is happening?</p>",
        "id": 495143331,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1737493124
    },
    {
        "content": "<p>It looks like you have a merge artifact in the file <code>scripts/noshake.json</code> <a href=\"https://github.com/leanprover-community/mathlib4/pull/15158/files#diff-1016f73d90ccc32633659c80f5be0174ff2e0397287db4db9956f493cf9a6ef0R323-R329\">here</a>.</p>",
        "id": 495145342,
        "sender_full_name": "Nick Ward",
        "timestamp": 1737493915
    },
    {
        "content": "<p>oops! What happens if I just delete the <code>scripts/noshake.json</code> file?</p>",
        "id": 495145485,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1737493967
    },
    {
        "content": "<p>(meanwhile, I just resolved the merge problem…)</p>",
        "id": 495145596,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1737494023
    },
    {
        "content": "<p>Oh nice, that's exactly what I was going to say (don't delete the file, just delete the diff and run <code>lake exe shake --update</code> if you still need to).</p>",
        "id": 495146219,
        "sender_full_name": "Nick Ward",
        "timestamp": 1737494291
    },
    {
        "content": "<p>Though to answer your question, <code>scripts/noshake.json</code> tells <code>lake exe shake</code> which imports in which files to ignore, even if they might appear to be unused. if you were to delete <code>scripts/noshake.json</code>, you would see exactly what you saw when it was invalid json (lots of unused import errors from files that used to be ignored).</p>",
        "id": 495146649,
        "sender_full_name": "Nick Ward",
        "timestamp": 1737494495
    },
    {
        "content": "<p>Sounds like shake should give a better error if it encounters invalid json</p>",
        "id": 495148533,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1737495272
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20927\">#20927</a> should make <code>lake exe shake</code> report that the <code>noshake</code> file is invalid.  I tested it successfully against the commit that triggered all the errors.</p>",
        "id": 495152140,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737496829
    },
    {
        "content": "<p>Thank you! Unfortunately, more bizarre stuff arises. It seems I really do need to have <code>shake</code> ignore some <code>import</code> rules, and entering <code>lake exe shake --ignore</code> puts out the error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"kn\">prefix</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">[</span><span class=\"n\">anonymous</span><span class=\"o\">]</span><span class=\"bp\">'</span>\n\n<span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">[</span><span class=\"n\">anonymous</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">[</span><span class=\"n\">anonymous</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">olean'</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">search</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"o\">:</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Cli</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Qq</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">proofwidgets</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">importGraph</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">LeanSearchClient</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">plausible</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span>\n<span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">chambert</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.16.0-rc2/lib/lean</span>\n<span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">chambert</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.16.0-rc2/lib/lean</span>\n</code></pre></div>",
        "id": 495152467,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1737496983
    },
    {
        "content": "<p>Ok, for the previous error, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/12896676175/job/35960191145?pr=20929\">this CI run</a> shows what <code>shake</code> reports with an invalid json file.</p>",
        "id": 495152760,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737497109
    },
    {
        "content": "<p>Let me see what happens with the \"new\" shake and your new reports.</p>",
        "id": 495152993,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737497224
    },
    {
        "content": "<p>Locally, the json appears correct and <code>shake</code> reports</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">PowerSeries</span><span class=\"bp\">/</span><span class=\"n\">Evaluation</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">PowerSeries</span><span class=\"bp\">.</span><span class=\"n\">PiTopology</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">PowerSeries</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 495153586,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737497490
    },
    {
        "content": "<p>which is the same as what it says in CI on your PR.</p>",
        "id": 495153619,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737497508
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"130609\">@Antoine Chambert-Loir</span> I think you want to run <code>lake exe shake --update</code> to update <code>scripts/noshake.json</code>.</p>",
        "id": 495153686,
        "sender_full_name": "Nick Ward",
        "timestamp": 1737497528
    },
    {
        "content": "<p>The point is that <code>shake</code> is wrong. If I do has it says, the file doesn't work anymore.</p>",
        "id": 495153773,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1737497574
    },
    {
        "content": "<p>That's what <code>--update</code> is for. It updates the JSON so that shake stops complaining</p>",
        "id": 495153989,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1737497654
    },
    {
        "content": "<p>From the error you posted, it appears to me that you ran <code>lake exe shake --ignore</code>, when what you want to run is <code>lake exe shake --update</code>.</p>",
        "id": 495153997,
        "sender_full_name": "Nick Ward",
        "timestamp": 1737497660
    },
    {
        "content": "<p>If I then run <code>lake exe shake --update</code> (which I also think is the correct move), <code>shake</code> does indeed update the <code>noshake</code> file, I assume correctly.</p>",
        "id": 495154030,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737497677
    },
    {
        "content": "<p>If instead I run <code>lake exe shake --fix</code>, then <code>shake</code> modifies <code>Mathlib/RingTheory/PowerSeries/Evaluation.lean</code>, changing its imports (also correct behaviour, since this is what I asked it to do).</p>",
        "id": 495154136,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737497732
    },
    {
        "content": "<p>I cannot reproduce the <code>[anonymous]</code> message above, though.</p>",
        "id": 495154190,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737497760
    },
    {
        "content": "<p>OK. Thank you.</p>",
        "id": 495154450,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1737497868
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130609\">Antoine Chambert-Loir</span> has marked this topic as resolved.</p>",
        "id": 495155111,
        "sender_full_name": "Notification Bot",
        "timestamp": 1737498150
    },
    {
        "content": "<p>I will watch your CI run with anticipation.</p>",
        "id": 495155129,
        "sender_full_name": "Nick Ward",
        "timestamp": 1737498159
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> for the quick error message fix, too.</p>",
        "id": 495155234,
        "sender_full_name": "Nick Ward",
        "timestamp": 1737498215
    }
]