[
    {
        "content": "<p>I'm debugging a build failure on <a href=\"https://github.com/leanprover-community/mathlib4/pull/18734\">#18734</a> and it looks like this is caused by the import order changing the instance definition order. Namely, I can replicate the failure by inserting, just before, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TopCat.Presheaf.germToPullbackStalk#doc\">docs#TopCat.Presheaf.germToPullbackStalk</a> a line that changes the priority:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">OmegaCompletePartialOrder.toPartialOrder</span>\n</code></pre></div>\n<p>And conversely, if I do the opposite change in <a href=\"https://github.com/leanprover-community/mathlib4/pull/18734\">#18734</a> and either give this instance a higher than default priority or give <code>OrderedAddCommMonoid.toPartialOrder</code> a lower priority, the build also succeeds.</p>\n<p>The weird thing is, we are not close at all to the maxHeartbeats in the current situation (somewhere between 7500 and 8000 where the default limit is 20000). So presumably there is some bad path involving <code>OrderedAddCommMonoid</code> that takes too long to fail.</p>\n<p>Anyone have any suggestions on how to deal with this?</p>",
        "id": 481278163,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731059542
    },
    {
        "content": "<p>One option would be either to raise the <code>OmegaCompletePartialOrder.toPartialOrder</code> priority or to lower the <code>OrderedAddCommMonoid.toPartialOrder</code> priority globally, but that seems a very heavy hammer to hit this issue with.</p>",
        "id": 481278413,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731059631
    },
    {
        "content": "<p>(I am currently tracing out the <code>OrderedAddCommMonoid</code> synth log, but seeing nothing that particularly jumps out. It simply seems to try a few instances that have cached failures, and then continues with the <code>OmegaCompletePartialOrder</code> branch.)</p>",
        "id": 481279205,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731059895
    },
    {
        "content": "<p>I can't find any useful way to do this change globally, and it would likely interfere with the uncoupling/priority lowering proposed in the <a href=\"#narrow/channel/287929-mathlib4/topic/Ways.20to.20speed.20up.20Mathlib\">Ways to speed up Mathlib topic</a>. So I will keep it at a local change. A bit hacky but eh.</p>",
        "id": 481291468,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731064001
    },
    {
        "content": "<p>(Another slightly evil alternative is trying to avoid importing <code>OrderedMonoid</code> in that file entirely :P)</p>",
        "id": 481291761,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731064108
    },
    {
        "content": "<p>It is fairly easy to disconnect from <code>OrderedAddCommMonoid</code>. You need to move the results specific to <code>CommRingCat</code> elsewhere.</p>",
        "id": 481296595,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731065965
    },
    {
        "content": "<p>In fact, that's what I ended up doing after all :D</p>",
        "id": 481296626,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731065981
    },
    {
        "content": "<p>PR coming up in a few minutes...</p>",
        "id": 481296637,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731065987
    },
    {
        "content": "<p>That's the most principled approach in my mind</p>",
        "id": 481296756,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731066024
    },
    {
        "content": "<p>This import graph is just too tempting... <a href=\"/user_uploads/3121/v9J3r3sm4jEIiL2LEDfblqYr/from-Mathlib.Algebra.Order.Monoid.Defs-to-Mathlib.Topology.Sheaves.Stalks.pdf\">from-Mathlib.Algebra.Order.Monoid.Defs-to-Mathlib.Topology.Sheaves.Stalks.pdf</a></p>",
        "id": 481297213,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731066183
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18762\">#18762</a></p>",
        "id": 481297417,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1731066261
    }
]