[
    {
        "content": "<p>What is the correct way to compare the performance of two different tactics on the same example?</p>\n<p>I’ve tried using the setup shown in the <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> below, but I’m having trouble reconciling the numbers reported by <code>#count_heartbeats in</code> and those from <code>trace.profiler true</code> combined with <code>trace.profiler.useHeartbeats true</code>. The results seem to differ significantly.</p>\n<p>Given these results, is it correct to interpret that in this specific case <code>aesop</code> is approximately 56% slower than <code>rfl</code> (110/71), 46% slower (133138/91375), or should it be interpreted differently?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"c1\">-- Used 71 heartbeats, which is less than the current maximum of 200000.</span>\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"c1\">-- Used 111 heartbeats, which is less than the current maximum of 200000.</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats!</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"c1\">-- Min: 71 Max: 71 StdDev: 6%</span>\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats!</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"c1\">-- Min: 110 Max: 111 StdDev: 6%</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"c1\">-- [Elab.async] [1033.000000] Lean.addDecl</span>\n<span class=\"c1\">-- [Elab.async] [71.000000] Lean.compileDecls ▶</span>\n<span class=\"c1\">-- [Elab.command] [91375.000000] example : 1 + 2 = 3 := by rfl ▶</span>\n<span class=\"c1\">-- [Elab.async] [54.000000] _private.Lean.Elab.MutualDef.0.Lean.Elab.Term.logGoalsAccomplishedSnapshotTask</span>\n<span class=\"c1\">-- [Elab.async] [8728.000000] Lean.Elab.Command.runLintersAsync ▶</span>\n<span class=\"c1\">-- [Elab.command] [53.000000]</span>\n<span class=\"c1\">-- [Elab.async] [5299.000000] Lean.Elab.Command.runLintersAsync ▶</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">aesop</span>\n<span class=\"c1\">-- [Elab.async] [1003.000000] Lean.addDecl ▶</span>\n<span class=\"c1\">-- [Elab.async] [71.000000] Lean.compileDecls ▶</span>\n<span class=\"c1\">-- [Elab.command] [133138.000000] example : 1 + 2 = 3 := by aesop ▶</span>\n<span class=\"c1\">-- [Elab.async] [54.000000] _private.Lean.Elab.MutualDef.0.Lean.Elab.Term.logGoalsAccomplishedSnapshotTask</span>\n<span class=\"c1\">-- [Elab.async] [8677.000000] Lean.Elab.Command.runLintersAsync ▶</span>\n<span class=\"c1\">-- [Elab.command] [53.000000]</span>\n<span class=\"c1\">-- [Elab.async] [5284.000000] Lean.Elab.Command.runLintersAsync ▶</span>\n</code></pre></div>",
        "id": 518464845,
        "sender_full_name": "Louis Cabarion",
        "timestamp": 1747378235
    },
    {
        "content": "<p>I don't know much about statistics, but <code>-- Min: 71 Max: 71 StdDev: 6%</code> looks a bit funny to me. Note that heartbeats are like calories -- there are 1000 calories in a kcal but when people talk about the number of calories in a muffin they talk about the number of kcals. Similarly the profiler is talking about heartbeats but #count_heartbeats is displaying kheartbeats and calling them heartbeats.</p>",
        "id": 518499307,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747388565
    },
    {
        "content": "<p>Note also that the more tracing options you put on, the more heartbeats it takes to do all the tracing.</p>",
        "id": 518499612,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747388653
    },
    {
        "content": "<p>You need to <code>set_option Elab.async false</code></p>",
        "id": 518505380,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747390334
    },
    {
        "content": "<p>In general, I think that there is little tooling for comparing speed like this, but I would really like it if it were possible to have even rough estimates easily.</p>\n<p>Besides <code>Elab.async</code>, I also wonder about whether there is any caching that might mean that later commands are likelier to be quicker, since the previous ones stored some computations for them.</p>",
        "id": 518536486,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747399730
    }
]