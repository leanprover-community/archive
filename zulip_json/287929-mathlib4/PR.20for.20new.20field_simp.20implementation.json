[
    {
        "content": "<p>That PR is now up for review: <a href=\"https://github.com/leanprover-community/mathlib4/pull/28658\">#28658</a></p>",
        "id": 535184070,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1755628597
    },
    {
        "content": "<p>What is the difference between <code>simp [field]</code> (which this PR seems to turn most instances of <code>field_simp</code> into) and <code>field_simp</code>?</p>",
        "id": 535189125,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1755630846
    },
    {
        "content": "<p>I've also seen <code>simp [field_simps]</code>. This is a bit confusing...</p>",
        "id": 535189310,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1755630940
    },
    {
        "content": "<p>What I find a bit strange is that in some cases, <code>ring</code> after <code>field_simp</code> could be removed, but in other cases, it had to be added.</p>",
        "id": 535189385,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1755630990
    },
    {
        "content": "<p>There is even one case where <code>field_simp; ring</code> turns into <code>field_simp; simp [field, div_pow]; ring</code>.</p>",
        "id": 535189981,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1755631333
    },
    {
        "content": "<p>5 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"113489\" href=\"/#narrow/channel/113489-new-members/topic/Algebraic.20simplification.20.2F.20CAS/with/535172541\">#new members &gt; Algebraic simplification / CAS</a> by <span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span>.</p>",
        "id": 535190387,
        "sender_full_name": "Notification Bot",
        "timestamp": 1755631530
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/PR.20for.20new.20field_simp.20implementation/near/535189125\">said</a>:</p>\n<blockquote>\n<p>What is the difference between <code>simp [field]</code> (which this PR seems to turn most instances of <code>field_simp</code> into) and <code>field_simp</code>?</p>\n</blockquote>\n<p>See the PR description:</p>\n<blockquote>\n<p>There is a big diff: the old¬†<code>field_simp</code>¬†subsumed¬†<code>simp</code>, and this was often exploited. We offer a simproc version of the new¬†<code>field_simp</code>, and switching to a¬†<code>simp</code>¬†call with this simproc fixes about 80% of the cases that break; the rest are handled individually (typically by alternating¬†<code>simp</code>¬†and¬†<code>field_simp</code>¬†calls).</p>\n</blockquote>\n<p>The simproc version of the new <code>field_simp</code> is (provisionally) named <code>field</code>.</p>",
        "id": 535190546,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755631605
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/PR.20for.20new.20field_simp.20implementation/near/535189385\">said</a>:</p>\n<blockquote>\n<p>What I find a bit strange is that in some cases, <code>ring</code> after <code>field_simp</code> could be removed, but in other cases, it had to be added.</p>\n</blockquote>\n<p>The <code>field_simp</code> tactic aims to reduce to the form <code>‚ä¢ A / D = B / D</code> and then clear <code>D</code> to give <code>‚ä¢ A = B</code>, but (both in the current and the former implementation) has never made a guarantee about <em>what</em> expressions of that form it reduces to.</p>\n<p>The new implementation sometimes gets different <code>A</code> and <code>B</code> than the old implementation did.  Sometimes they used to be the same and are now different, so a final <code>ring</code> is necessary to prove <code>A = B</code>. Sometimes they used to be different and are now the same, so a final <code>ring</code> can be removed.</p>",
        "id": 535191180,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755631827
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/PR.20for.20new.20field_simp.20implementation/near/535189310\">said</a>:</p>\n<blockquote>\n<p>I've also seen <code>simp [field_simps]</code>. This is a bit confusing...</p>\n</blockquote>\n<p>This is a temporary hack to replicate the behaviour of the old implementation (which basically consisted of calling <code>simp</code> with the custom simp-set <code>field_simps</code> and with a custom discharger).</p>",
        "id": 535191382,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755631913
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> Thanks for clarifying!<br>\nAre there some guidelines as to when one should use the simproc and when the <code>field_simp</code> tactic?</p>",
        "id": 535192430,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1755632386
    },
    {
        "content": "<p>Personally, I think it's better style to separate your <code>simp</code>-ing from your <code>field_simp</code>-ing: the resulting proofs are easier to read. Maybe in the long run we will develop consensus on this and disable the simproc.</p>\n<p>However, as you see from the diff, providing the simproc makes it a lot easier to transition to the new implementation, since so many invocations of the current <code>field_simp</code> exploit the simp-ing capability!</p>",
        "id": 535192831,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755632578
    },
    {
        "content": "<p>There are a few TODO comments in mathlib referring to issue <a href=\"https://github.com/leanprover-community/mathlib4/pull/15486\">#15486</a> about slow <code>field_simp</code>, can those go back to using <code>field_simp</code> or similar with the new implementation?</p>",
        "id": 535220214,
        "sender_full_name": "Joseph Myers",
        "timestamp": 1755650027
    },
    {
        "content": "<p>Yes, I think it will be safe to bring back those <code>field_simp</code>s!  I had extracted one of those examples (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=InnerProductGeometry.cos_angle_sub_add_angle_sub_rev_eq_neg_cos_angle#doc\">docs#InnerProductGeometry.cos_angle_sub_add_angle_sub_rev_eq_neg_cos_angle</a>) as a <a href=\"https://github.com/leanprover-community/mathlib4/blob/8bb991a4a08f76e3acc412600e834b09ec9d55b4/MathlibTest/FieldSimp.lean#L543-L557\">performance test</a> for <code>field_simp</code>, and it goes from 19983 heartbeats in the old implementation to 2979 heartbeats in the new implementation.</p>",
        "id": 535223907,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755653246
    },
    {
        "content": "<p>Thanks to all the authors!!! I am trying it and looks great :)</p>",
        "id": 535268722,
        "sender_full_name": "Izan Beltran",
        "timestamp": 1755680242
    },
    {
        "content": "<p>I have a feature request for <code>field_simp</code>. It currently multiplies out the division in a goal like <code>a / b = c</code>. But I would like it to also multiply out the division in goals like <code>a / b &lt; c</code> or <code>a / b ‚â§ c</code>, by using a lemma like <code>div_le_iff‚ÇÄ</code>. It can use the same discharger as the rest of <code>field_simp</code>. This feature is also missing in the old <code>field_simp</code> implementation.</p>",
        "id": 536203117,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1756202965
    },
    {
        "content": "<p>The authors will know better than me, but I mentioned this exact improvement to some of them as well, and my understanding is that it's planned, but not included in this PR for ease of review</p>",
        "id": 536204065,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1756203407
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> This is the peril of having two simultaneous Zulip threads on the same topic!  See comment at <a href=\"#narrow/channel/144837-PR-reviews/topic/.2328658.20New.20.60field_simp.60/near/536087098\">#PR reviews &gt; #28658 New &#96;field_simp&#96; @ üí¨</a>.</p>",
        "id": 536212556,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756206862
    },
    {
        "content": "<p>Is the following meant to be in scope? I would say it should be.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span><span class=\"w\"> </span><span class=\"c1\">-- has no effect</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">div_pow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">div_mul_cancel‚ÇÄ</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">pow_ne_zero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>(I noticed this when trying to bump Mathlib in my <a href=\"https://github.com/MichaelStollBayreuth/Heights\">Heights</a> repo. This led to a <code>field_simp</code> breaking. The relevant goal is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">c</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Äñ</span><span class=\"n\">c</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">c</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- this used `field_simp` followed by some rewrites</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>and I would have hoped that the new <code>field_simp</code> would be able to solve that on its own...)</p>",
        "id": 537135335,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1756741577
    },
    {
        "content": "<p>The new <code>field_simp</code> doesn't handle variable exponents, only numeric exponents. If you <code>rw [div_pow]</code>, <code>field_simp</code> works after that.</p>",
        "id": 537135507,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756741646
    },
    {
        "content": "<p>Or <code>simp [field, div_pow]</code> for a one-liner.</p>",
        "id": 537135603,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756741679
    },
    {
        "content": "<p>Also, we also haven't (yet) made any improvements to the discharger, so you'll need to provide a by-hand proof that <code>M</code> is nonzero (or strictly positive), same as always. The following cleans it up pretty well:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lt_of_le_of_lt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">positivity</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">hc</span>\n<span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">field</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">div_pow</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 537136381,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1756741990
    },
    {
        "content": "<p>It seems like the new <code>field_simp</code> doesn't complain if you pass it lemmas or definitions that it doesn't (know how to) do anything with</p>",
        "id": 539546999,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1757940246
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span> That's true, but I'm a little surprised you're noticing it!  The old <code>field_simp</code> would have done this only since <code>simp</code> introduced that feature, quite recently (in v4.22.0 maybe?).</p>",
        "id": 539692984,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1758004855
    },
    {
        "content": "<p>Really? Pnt+ used it aggressively</p>",
        "id": 539693081,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758004897
    },
    {
        "content": "<p>At least, I don't remember any such feature on the slightly older versions we were working with when we wrote the <code>field_simp</code> refactor. Do you have an example? How was PNT+ using the feature?</p>",
        "id": 539693482,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1758005067
    },
    {
        "content": "<p>The adaptations are at <a href=\"https://github.com/AlexKontorovich/PrimeNumberTheoremAnd/pull/387\">https://github.com/AlexKontorovich/PrimeNumberTheoremAnd/pull/387</a>. I can point at specific instances when I'm back at my desk if that's helpful</p>",
        "id": 539695324,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758005886
    },
    {
        "content": "<p>Please do! I don't immediately see from the diff where this would be coming up.</p>",
        "id": 539704825,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1758009303
    },
    {
        "content": "<p><a href=\"https://github.com/AlexKontorovich/PrimeNumberTheoremAnd/pull/387/files#diff-c48bc7c964033abf9cf5153893de7388b0df489b8cddaef69bfe758fc4081e1bR1306\">https://github.com/AlexKontorovich/PrimeNumberTheoremAnd/pull/387/files#diff-c48bc7c964033abf9cf5153893de7388b0df489b8cddaef69bfe758fc4081e1bR1306</a> for example, <code>field_simp [F, f, f']</code> ‚Üí <code>simp [F, f, f']; field_simp</code></p>",
        "id": 539705760,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758009599
    },
    {
        "content": "<p>I'm writing without having experimented myself (can't do that until this evening), but let me check I understand: This is coming up because sometimes with the old <code>field_simp</code> (which subsumed <code>simp</code>) a proof was <code>field_simp [a, b, c]</code>, and now such a proof needs to be changed to <code>simp [a, b]; field_simp [c]</code>?  And in such cases it's hard to tell whether each of the <code>a</code>, <code>b</code>, <code>c</code> belongs to the <code>simp</code> part or the <code>field_simp</code> part?</p>",
        "id": 539707774,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1758010196
    },
    {
        "content": "<p>That's the situation, yeah. I'm not sure if I'd say it's hard, but it would be nice if <code>field_simp</code> gave a warning if you gave it something it doesn't know how to use, similar to how <code>simp</code> warns on unused lemmas now</p>",
        "id": 539710313,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758011033
    },
    {
        "content": "<p>I believe I hit a few places where this made <code>field_simp</code> do quite a bit less, and the proof only started breaking quite a bit lower down (maybe there were <code>have</code>s in between?), so it took a moment to realize that I needed to scroll back up to look for a <code>field_simp</code>. That said, the flexible linter probably would have caught that those proofs were brittle in the first place</p>",
        "id": 539710870,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758011203
    },
    {
        "content": "<p>Just checking, you are aware of the simproc version (<code>simp [field, ...]</code>)? One motivation for providing this was that it makes bumping easier.</p>",
        "id": 539711335,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1758011347
    },
    {
        "content": "<p>(But the simproc version does have some limitations too, see <a href=\"https://github.com/leanprover-community/mathlib4/pull/28658#issuecomment-3207858409\">here</a> for details)</p>",
        "id": 539711595,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1758011426
    },
    {
        "content": "<p>Yeah, I've used both with not much thought as to which one I picked <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> </p>\n<p>The idea was to eventually remove the simproc, right?</p>",
        "id": 539713550,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758012067
    },
    {
        "content": "<p>are there plans for a corresponding <code>ring</code> simproc? writing <code>simp [field]</code> or <code>simpa [field]</code> is really useful!</p>",
        "id": 547168728,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1761523132
    },
    {
        "content": "<p>and relatedly a <code>field_nf</code> for <code>field_simp; ring_nf</code>?</p>",
        "id": 547168751,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1761523151
    }
]