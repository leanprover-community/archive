[
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Actions.20on.20SeparationQuotient/near/433141755\">said</a>:</p>\n<blockquote>\n<p>Generally <code>[SMul A B] : SMul (F A) (F B)</code> instances are a bad idea</p>\n</blockquote>\n<p>This is a problematic position for me. </p>\n<p>Mathematical background: the Galois theory of valued fields is a really important theory in my area. The simplest nontrivial results in the Langlands program are a collection of results known as local class field theory, currently being formalized <a href=\"https://github.com/kbuzzard/ClassFieldTheory\">here</a>. The basic set-up here is that <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> are fields with valuations, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> is a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>-algebra, and one wants to understand <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>-algebra automorphisms of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> via the internal structure of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> (it is an extraordinary fact that the internal arithmetic of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> can say something about external structures such as <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span>, when <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> has a valuation).</p>\n<p>Mathlib now has <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsGaloisGroup#doc\">docs#IsGaloisGroup</a> which is a predicate for \"I am <code>L â‰ƒâ‚[K] L</code>\" where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> are commutative rings and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> is a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>-algebra satisfying some algebraic properties. I felt like this was a great step in the right direction for local class field theory, because in class field theory <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> are equipped with valuations and various Galois groups showing up here are all \"the same\". In this valued case,  <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> have integer rings <code>ğ’ª[K]</code> and <code>ğ’ª[L]</code>, and residue fields <code>ğ“€[K]</code> and <code>ğ“€[L]</code>, with this notation available scoped in the <code>ValuativeRel</code> namespace. Mathematically I would say the following: if <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi><mi mathvariant=\"normal\">/</mi><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">L/K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mord\">/</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> is a finite unramified Galois extension of valued fields with Galois group <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>G</mi></mrow><annotation encoding=\"application/x-tex\">G</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">G</span></span></span></span>, then <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>G</mi></mrow><annotation encoding=\"application/x-tex\">G</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">G</span></span></span></span> is also the Galois group of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">O</mi><mi>L</mi></msub><mi mathvariant=\"normal\">/</mi><msub><mi mathvariant=\"script\">O</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathcal{O}_L/\\mathcal{O}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.02778em;\">O</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.02778em;\">O</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> and of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>k</mi><mi>L</mi></msub><mi mathvariant=\"normal\">/</mi><msub><mi>k</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">k_L/k_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>.</p>\n<p>Unfortunately, the \"avoid <code>[SMul A B] : SMul (F A) (F B)</code>\" rule is problematic, because it means that it will be difficult to get the code below compiling:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- let K be a valued field</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- let L be a valued field</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeExtension</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- and say L/K is an extension compatible with the valuation</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- let G be a group</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- acting on L</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsGaloisGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- and say it's the Galois group of L/K</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">ValuativeRel</span>\n\n<span class=\"c1\">-- then G is also naturally the Galois group of ğ’ª[L]/ğ’ª[K]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsGaloisGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">failed to synthesize</span>\n<span class=\"cm\">  Algebra â†¥ğ’ª[K] â†¥ğ’ª[L]</span>\n<span class=\"cm\">-/</span>\n\n\n<span class=\"c1\">-- And in the unramified case (which we can only say in the CFT repo)</span>\n<span class=\"c1\">-- G is also naturally the Galois group of ğ“€[L]/ğ“€[K]</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsGaloisGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">ğ“€</span><span class=\"o\">[</span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ğ“€</span><span class=\"o\">[</span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">failed to synthesize</span>\n<span class=\"cm\">  Algebra (IsLocalRing.ResidueField â†¥ğ’ª[K]) (IsLocalRing.ResidueField â†¥ğ’ª[L])</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>The way this was fixed in the global setting (Dedekind domains) was <em>not</em> to set up a theory using rings of integers (a type depending on K), but instead to adopt the \"AKLB set-up\", where A, K, L, B were types, with A,B rings, K,L fields, K an A-algebra and L a B-algebra (and L an A-algebra and L a K-algebra and B an A-algebra and <code>IsScalarTower A B L</code> and <code>IsScalarTower A K L</code>) and extra ring-theoretic hypotheses being put on A and K to ensure that A was isomorphic to (as opposed to equal to) the integers of K. Here's what the set-up looks like in the number field case:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let K be a number field with ring of integers A</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NumberField</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsFractionRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">â„¤</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- let L be a number field containing K</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NumberField</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- and let B be the integers of L (which of course contains A)</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsIntegralClosure</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Let G be the Galois group of L/K</span>\n<span class=\"w\">    </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsGaloisGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsGaloisGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Then we can do stuff</span>\n</code></pre></div>\n<p>We could do this in the local field case too, although it would be a bit longer: instead of <code>[Field K] [NumberField K]</code> we would have <code>[Field K] [TopologicalSpace K] [ValuativeRel K] [IsNonarchimedeanLocalField K]</code> and instead of <code>[IsIntegralClosure A â„¤ K]</code> we would have a new predicate which mathematically said \"The algebraMap A -&gt; K is injective and its image is exactly <code>ğ’ª[K]</code>\", but this is not a problem.</p>\n<p>However, this only get us as far as <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"script\">O</mi><mi>L</mi></msub><mi mathvariant=\"normal\">/</mi><msub><mi mathvariant=\"script\">O</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathcal{O}_L/\\mathcal{O}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.02778em;\">O</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">/</span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.02778em;\">O</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>. If we're in the unramified case then we also want G acting on the residue field and if we are not allowed <code>[SMul A B] : SMul (F A) (F B)</code> then we can't use <code>ğ“€[K]</code> or <code>ğ“€[L]</code> so this would be new types <code>k</code> and <code>l</code> and <code>[Algebra A k] [Algebra B l] [Algebra k l] [IsScalarTower A k l] [IsScalarTower A B l] [MulSemiringAction G l] [IsGaloisGroup G k l] [IsScalarTower G B l]</code>.</p>\n<p>That would be the boilerplate in the theory, visible in the docs. I even wonder whether this would push us over the boilerplate record (currently held by differential geometry). As far as I can see, it's either this or <code>[Algebra K L] : Algebra ğ’ª[K] ğ’ª[L]</code> and <code>[Algebra K L] : Algebra ğ“€[K] ğ“€[L]</code>. Which path would people recommend here? This is a decision which needs to be made to unlock further progress in local class field theory.</p>",
        "id": 556690674,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763304872
    },
    {
        "content": "<p>I think we might or might not have collectively decided that we aren't going to have a predicate for \"IsQuotient\" (or maybe it's just that nobody made it yet), so for that reason we might have implicitly decided that \"<code>[SMul A B] : SMul (F A) (F B)</code>\" is fine for <code>F</code> = Quotient?</p>\n<p>(More precisely, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Module/Torsion/Basic.html#Module.instQuotientIdealSubmoduleHSMulTop\">Module (R â§¸ I) (M â§¸ I â€¢ âŠ¤)</a> is an instance)</p>",
        "id": 556691584,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763305620
    },
    {
        "content": "<p>I am not sure I understand properly why <code>[SMul A B] : SMul (F A) (F B)</code> is a bad idea; all I know is that more and more I see objections to instances on the basis that in pathological situations they can create diamonds, and this is something which I have accepted; I see it as a problem with the way the algebra heirarchy is set up in mathlib and it's not clear to me how to solve it. Another example of this phenomenon is that <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi><mo>âŠ—</mo><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">A\\otimes B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âŠ—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span> can't be a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span>-algebra because what if <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi><mo>=</mo><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">A=B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span>, which is a reasonable objection (1% of the time).</p>\n<p>Certainly if <code>A = B</code> there are issues with <code>[Algebra A B] : Algebra (F A) (F B)</code>, because this almost certainly creates a (propeq) diamond: we have <code>Algebra K K</code> so if we define <code>[Algebra K L] : Algebra ğ’ª[K] ğ’ª[L]</code> in the valued case then we get another <code>Algebra ğ’ª[K] ğ’ª[K]</code>. However we mitigated for this with <a href=\"https://github.com/leanprover-community/mathlib4/pull/13032\">#13032</a> , increasing the priority of <code>Algebra.id</code> to 1100, and this has worked fine so far.</p>\n<p>If this is the only objection to <code>[Algebra K L] : Algebra ğ’ª[K] ğ’ª[L]</code> then my instinct is to push for this to be an instance. But perhaps there are other problems which I don't immediately see here.</p>",
        "id": 556691873,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763305820
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556691584\">said</a>:</p>\n<blockquote>\n<p>or that reason we might have implicitly decided that \"<code>[SMul A B] : SMul (F A) (F B)</code>\" is fine for <code>F</code> = Quotient?</p>\n</blockquote>\n<p>This only deals with <code>[Algebra ğ’ª[K] ğ’ª[L]] : Algebra ğ“€[K] ğ“€[L]</code></p>",
        "id": 556691970,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763305886
    },
    {
        "content": "<p>Can we also implicitly decide that it's fine for <code>F = coerced sub</code> or is that a bridge too far?</p>",
        "id": 556692030,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763305923
    },
    {
        "content": "<p>\"GenerallyÂ <code>[SMul A B] : SMul (F A) (F B)</code>Â instances are a bad idea\" is because you get two instances of <code>SMul (F A) (F (F B))</code>. But this does not apply here because <code>ğ’ª[ğ’ª[K]]</code> doesn't even typecheck.</p>",
        "id": 556692075,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1763305941
    },
    {
        "content": "<p>Another issue is you get two <code>SMul (F A) (F A)</code> instances but I think they are defeq here.</p>",
        "id": 556692138,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1763305978
    },
    {
        "content": "<p>usually the self-act instances are only definitionally equal if <code>F</code> is some sort of structure with definitional eta I think</p>",
        "id": 556692235,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763306047
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"bp\">.</span><span class=\"n\">instAlgebraInteger</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"bp\">.</span><span class=\"n\">instAlgebraInteger</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ValuativeRel</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)))</span>\n</code></pre></div>\n<p>yes, they are defeq</p>",
        "id": 556692458,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306194
    },
    {
        "content": "<p>In general bumping up the priority of 1100 doesn't solve the problem; it just hides it. Whenever you want to apply your lemma to <code>K = L</code> you will get absolutely stuck. But maybe the latter is never the case for this specific scenario.</p>",
        "id": 556692493,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1763306229
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> so basically in this case <code>Algebra ğ’ª[K] ğ’ª[L]</code> is already an instance and for this specific scenario we don't have a problem because of this defeq</p>",
        "id": 556692562,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306278
    },
    {
        "content": "<p>Is this instance not enabled for you?</p>",
        "id": 556692575,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306285
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeExtension</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">ValuativeRel</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>Not in mathlib. What am I doing wrong? Edit: sorry, just saw your post.</p>",
        "id": 556692657,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306355
    },
    {
        "content": "<p>Oh but it still doesn't fire for me.</p>",
        "id": 556692722,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306388
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> I see, we're missing the below instance:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeExtension</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">ValuativeRel</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">âŸ¨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">comap_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">Compatible</span><span class=\"bp\">.</span><span class=\"n\">rel_iff_le</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ValuativeExtension</span><span class=\"bp\">.</span><span class=\"n\">rel_iff_rel</span><span class=\"o\">]</span><span class=\"bp\">âŸ©</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 556692987,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306578
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556692458\">said</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"bp\">.</span><span class=\"n\">instAlgebraInteger</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"bp\">.</span><span class=\"n\">instAlgebraInteger</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ValuativeRel</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)))</span>\n</code></pre></div>\n<p>yes, they are defeq</p>\n</blockquote>\n<p>That's not the right check. This is the right check I think:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">with_reducible_and_instances</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"bp\">.</span><span class=\"n\">instAlgebraInteger</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ValuativeRel</span><span class=\"bp\">.</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>and it doesn't work.</p>",
        "id": 556693048,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306619
    },
    {
        "content": "<p>this is actually good discovery, I didn't find this out when I was doing the local field in CFT workshop</p>",
        "id": 556693055,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306624
    },
    {
        "content": "<p>So we should make it more reducible?</p>",
        "id": 556693140,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763306688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556692987\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> I see, we're missing the below instance:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeRel</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ValuativeExtension</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">ValuativeRel</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">âŸ¨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">comap_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">Compatible</span><span class=\"bp\">.</span><span class=\"n\">rel_iff_le</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ValuativeExtension</span><span class=\"bp\">.</span><span class=\"n\">rel_iff_rel</span><span class=\"o\">]</span><span class=\"bp\">âŸ©</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ğ’ª</span><span class=\"o\">[</span><span class=\"n\">L</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>OK nice. So now the question is: should this instance be allowed in mathlib because it goes against Eric's claim at the top of this thread.</p>",
        "id": 556693144,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306691
    },
    {
        "content": "<p>oh, maybe that's why we don't have that instance then... if they aren't defeq then we'll have to use the AKLB formula?</p>",
        "id": 556693149,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306696
    },
    {
        "content": "<p>I just realized the the integers <em>are</em> a kind of structure (subtype) with definitional eta so that's why this works</p>",
        "id": 556693187,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763306729
    },
    {
        "content": "<p>but we just showed that it doesn't work in reducible setting</p>",
        "id": 556693213,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306749
    },
    {
        "content": "<p>So we need it to be more reducible</p>",
        "id": 556693221,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763306760
    },
    {
        "content": "<p>btw Kevin in case you didn't know, we have the predicate <code>Valuation.Integers</code> for \"is ğ’ª[K]\"</p>",
        "id": 556693239,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763306775
    },
    {
        "content": "<p>oh but this is great, your instance above <code>(valuation K).HasExtension (valuation L)</code> Kenny looks completely innocuous, nobody will notice that it creates the instance which Eric is worried about.</p>",
        "id": 556693250,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306783
    },
    {
        "content": "<p>The <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingHom.restrict#doc\">docs#RingHom.restrict</a> seems to be the problem here</p>",
        "id": 556693262,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1763306795
    },
    {
        "content": "<p>since it doesn't reduce under reducible+instances</p>",
        "id": 556693285,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1763306818
    },
    {
        "content": "<p>If we have an isinteger predicate then obviously we need to assume some smuls and some compatibility</p>",
        "id": 556693294,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763306822
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556693221\">said</a>:</p>\n<blockquote>\n<p>So we need it to be more reducible</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- We override `toFun` and `toSMul` because `RingHom.id` is not reducible and cannot</span>\n<span class=\"w\">  </span><span class=\"c1\">-- be made so without a significant performance hit.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- see library note [reducible non-instances].</span>\n</code></pre></div>",
        "id": 556693309,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306829
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instAlgebraInteger</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">vR</span><span class=\"bp\">.</span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"n\">vA</span><span class=\"bp\">.</span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">âŸ¨</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">â€¢</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">smul_def</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">â–¸</span><span class=\"w\"> </span><span class=\"n\">mul_mem</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">val_map_le_one_iff</span><span class=\"w\"> </span><span class=\"n\">vR</span><span class=\"w\"> </span><span class=\"n\">vA</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">âŸ©</span>\n<span class=\"w\">  </span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">restrict</span><span class=\"w\"> </span><span class=\"n\">vR</span><span class=\"bp\">.</span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"n\">vA</span><span class=\"bp\">.</span><span class=\"n\">integer</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">mem_integer_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">val_map_le_one_iff</span><span class=\"w\"> </span><span class=\"n\">vR</span><span class=\"w\"> </span><span class=\"n\">vA</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"n\">commutes'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">commutes</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">smul_def'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">smul_def</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 556693311,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1763306831
    },
    {
        "content": "<p>But for the actual construction of the integers (not just an isinteger predicate) we should have this smul instance if possible I think</p>",
        "id": 556693370,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763306886
    },
    {
        "content": "<p>I'm not suggesting that it's hard to write these instances, I am pointing out that they will give us the pattern mentioned in the title of this thread and thus I would like to understand more about why the pattern should be avoided in general and whether it's OK to have it in the situation for integers of valued fields.</p>",
        "id": 556693385,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306901
    },
    {
        "content": "<p>I think the problem is diamonds but I think we've demonstrated that those can be avoided</p>",
        "id": 556693468,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763306963
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556693285\">said</a>:</p>\n<blockquote>\n<p>since it doesn't reduce under reducible+instances</p>\n</blockquote>\n<p>Oh sorry, I had missed this comment.</p>",
        "id": 556693494,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763306989
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556693385\">said</a>:</p>\n<blockquote>\n<p>I would like to understand more about why the pattern should be avoided in general and whether it's OK to have it in the situation for integers of valued fields.</p>\n</blockquote>\n<p>I think the summary of this discussion is that if we change a few things so that Algebra ğ’ª[K] ğ’ª[K] is reducibly-defeq to .id then this is OK.</p>",
        "id": 556693548,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763307026
    },
    {
        "content": "<p>so the answer is that <code>SMul A B -&gt; SMul (F A) (F B)</code> is ok iff the identity is sent to identity under reducible defeq</p>",
        "id": 556693608,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763307064
    },
    {
        "content": "<p>and that <code>SMul (F A) (F (F A))</code> never appears</p>",
        "id": 556693647,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1763307097
    },
    {
        "content": "<p>After</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">HasExtension</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">valuation</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">âŸ¨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">â†¦</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">comap_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">â†</span><span class=\"w\"> </span><span class=\"n\">Valuation</span><span class=\"bp\">.</span><span class=\"n\">Compatible</span><span class=\"bp\">.</span><span class=\"n\">rel_iff_le</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ValuativeExtension</span><span class=\"bp\">.</span><span class=\"n\">rel_iff_rel</span><span class=\"o\">]</span><span class=\"bp\">âŸ©</span>\n</code></pre></div>\n<p>we get <code>[Algebra K L] [ValuativeExtension K L] : Algebra ğ’ª[K] ğ’ª[L]</code> but what about <code>[Algebra K L] [ValuativeExtension K L] : Algebra ğ“€[K] ğ“€[L]</code>?</p>",
        "id": 556693648,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763307097
    },
    {
        "content": "<p>I don't think we can do this for the residue fields since they're a quotient</p>",
        "id": 556693700,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763307141
    },
    {
        "content": "<p>I think that's what that notation means</p>",
        "id": 556693715,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763307152
    },
    {
        "content": "<p>If you add <code>instance : IsLocalHom (algebraMap ğ’ª[K] ğ’ª[L])</code> then you will get that algebra for free.</p>",
        "id": 556693723,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1763307158
    },
    {
        "content": "<p>OK then I think we have a way forward!</p>",
        "id": 556693770,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763307197
    },
    {
        "content": "<p>Thanks to all.</p>",
        "id": 556693776,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1763307205
    },
    {
        "content": "<p>I think in CFT we disovered that the localhom instance is bad because of a bad instance in mathlib that i don't remember if i have fixed or not</p>",
        "id": 556693777,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763307206
    },
    {
        "content": "<p>The fix was <a href=\"https://github.com/leanprover-community/mathlib4/pull/27445\">#27445</a></p>",
        "id": 556693800,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1763307233
    },
    {
        "content": "<p>*is (it hasn't been merged! <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span> )</p>",
        "id": 556693828,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763307268
    },
    {
        "content": "<p>oh no since it's a quotient acting on a quotient it might be fine?</p>",
        "id": 556693920,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763307344
    },
    {
        "content": "<p>it's fine, it's just bad in this case because they wrongly used RingHom.toAlgebra which kills the smul definition</p>",
        "id": 556693963,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763307371
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/RingTheory/LocalRing/ResidueField/Basic.html#IsLocalRing.ResidueField.instAlgebra\">IsLocalRing.ResidueField.instAlgebra</a></p>",
        "id": 556693969,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1763307376
    },
    {
        "content": "<p>\"was\" in the sense that it has totally rotten. I'll merge master and see what happens.</p>",
        "id": 556693983,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1763307391
    },
    {
        "content": "<p>After ploughing through like 9 definitions I'm fairly confident that it should be fine</p>",
        "id": 556694265,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763307610
    },
    {
        "content": "<p>It should be fine if we define it with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.Quotient.algebraOfLiesOver#doc\">docs#Ideal.Quotient.algebraOfLiesOver</a> since <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.Quotient.algebraQuotientOfLEComap#doc\">docs#Ideal.Quotient.algebraQuotientOfLEComap</a> should be definitionally coherent with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Con.hasMul#doc\">docs#Con.hasMul</a></p>",
        "id": 556694357,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763307706
    },
    {
        "content": "<p>Wait no but definitely it's not coherent?</p>",
        "id": 556694857,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763308151
    },
    {
        "content": "<p>The smul is fine but the algebraMap is different</p>",
        "id": 556694885,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763308174
    },
    {
        "content": "<p>So we can't have this instance because the algebraMap will not be definitionally equal</p>",
        "id": 556694905,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763308194
    },
    {
        "content": "<p><code>[NoBadDiamondsInstanceTransformer F]</code></p>",
        "id": 556923626,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1763411092
    },
    {
        "content": "<p>I have not understood the last few messages in this thread but <a href=\"https://github.com/leanprover-community/mathlib4/pull/27445\">#27445</a> looks like it's back up and running. <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> are you objecting to it with your last few comments?</p>",
        "id": 561221477,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764608503
    },
    {
        "content": "<p>yes I'm objecting</p>",
        "id": 561221577,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764608526
    },
    {
        "content": "<p>the <code>algebraMap</code> isn't the same</p>",
        "id": 561221609,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764608531
    },
    {
        "content": "<p>the <code>SMul</code> is fine though</p>",
        "id": 561221680,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764608542
    },
    {
        "content": "<p>In my mind it was the <code>SMul</code> which was the problem, which seems to have been resolved. Do you have a suggested resolution for the <code>algebraMap</code>?</p>",
        "id": 561223005,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764608787
    },
    {
        "content": "<p>no I don't</p>",
        "id": 561223129,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764608813
    },
    {
        "content": "<p>I guess the solution would be don't make it an instance</p>",
        "id": 561223235,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764608829
    },
    {
        "content": "<p>Sorry, I did not see this discussion before maintainer merging. I'll comment a link to this conversation on <a href=\"https://github.com/leanprover-community/mathlib4/pull/27445\">#27445</a></p>",
        "id": 561250617,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1764615167
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556923626\">said</a>:</p>\n<blockquote>\n<p><code>[NoBadDiamondsInstanceTransformer F]</code></p>\n</blockquote>\n<p>Sorry. My wife says Iâ€™m too indirect. This was meant to </p>\n<ol>\n<li>Codify which <code>F</code> are â€œokâ€</li>\n<li>Make a type class for such <code>F</code> </li>\n<li>Allow smul creation along such <code>F</code> by embedding it in instance search</li>\n</ol>\n<p>I havenâ€™t thought much about this though.</p>",
        "id": 561255645,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764616809
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/561255645\">said</a>:</p>\n<blockquote>\n<p>My wife says Iâ€™m too indirect.</p>\n</blockquote>\n<p>In my mind this is part of your appeal. I am still very much interested in this because as well as local fields, I am interested in <code>[Field K] [NumberField K] [Field L] [NumberField L] [Algebra K L] : Algebra (AdeleRing (ğ“ K) K) (AdeleRing (ğ“ L) L)</code> and fortunately this passes the Yang test <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/556693647\">#mathlib4 &gt; &#91;SMul A B&#93; : SMul (F A) (F B) @ ğŸ’¬</a>  as <code>F (F X)</code> cannot ever happen because the adele ring of a number field is never a number field.</p>",
        "id": 561267414,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764620791
    },
    {
        "content": "<p>The reason I want this is that if <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> is a number field with adele ring <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> (a topological ring and a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>-algebra) then for FLT I want to be able to say the following two things:</p>\n<p>1) If <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span> is also a number field and a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>-algebra then <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>L</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> has the <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>-module topology (proved in FLT but which I cannot even state without making <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>L</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> into an <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>-algebra); and</p>\n<p>2) there is a continuous ring equivalence <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub><msub><mo>âŠ—</mo><mi>K</mi></msub><mi>L</mi><mo>â‰…</mo><msub><mi mathvariant=\"double-struck\">A</mi><mi>L</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_K\\otimes_KL\\cong\\mathbb{A}_L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\"><span class=\"mbin\">âŠ—</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â‰…</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> which is both <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>-linear and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span>-linear (and I literally cannot even state this in mathlib because <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi><mo>âŠ—</mo><mi>Y</mi></mrow><annotation encoding=\"application/x-tex\">X\\otimes Y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âŠ—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span></span> is not allowed to be an <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi></mrow><annotation encoding=\"application/x-tex\">X</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span></span></span></span>-module and a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi></mrow><annotation encoding=\"application/x-tex\">Y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span></span>-module given our current set-up).</p>\n<p>This will cause problems going forwards. It's all well and good saying <code>[SMul A B] : SMul (F A) (F B)</code> is not allowed and that <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi><mo>âŠ—</mo><mi>Y</mi></mrow><annotation encoding=\"application/x-tex\">X\\otimes Y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">âŠ—</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span></span> isn't allowed to be an <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi></mrow><annotation encoding=\"application/x-tex\">X</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span></span></span></span>-module and a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi></mrow><annotation encoding=\"application/x-tex\">Y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span></span>-module but my feeling is that we are going to have to solve these problems rather than just declare them not acceptable for our library.</p>",
        "id": 561268608,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764621217
    },
    {
        "content": "<p>I am dreading the response \"just make <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub><msub><mo>âŠ—</mo><mi>K</mi></msub><mi>L</mi><mo>â‰…</mo><msub><mi mathvariant=\"double-struck\">A</mi><mi>L</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_K\\otimes_KL\\cong\\mathbb{A}_L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\"><span class=\"mbin\">âŠ—</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â‰…</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> into an <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">\\mathbb{A}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>-linear iso and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi><msub><mo>âŠ—</mo><mi>K</mi></msub><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub><mo>â‰…</mo><msub><mi mathvariant=\"double-struck\">A</mi><mi>L</mi></msub></mrow><annotation encoding=\"application/x-tex\">L\\otimes_K\\mathbb{A}_K\\cong\\mathbb{A}_L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\"><span class=\"mbin\">âŠ—</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">â‰…</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">L</span></span></span></span><span class=\"vlist-s\">â€‹</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> into an <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span>-linear iso and prove that the obvious triangle commutes\" i.e. \"work around the deficiencies of the library\". What we do in FLT instead is <a href=\"https://github.com/ImperialCollegeLondon/FLT/blob/main/FLT/Hacks/RightActionInstances.lean\">to break the mathlib rules with a hack</a> and I am still unclear about whether this will bite me going forwards.</p>",
        "id": 561269211,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764621474
    },
    {
        "content": "<p>It seems that <code>SMul</code> is too generic.</p>",
        "id": 561271396,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764622352
    },
    {
        "content": "<p>what do you mean?</p>",
        "id": 561271447,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764622376
    },
    {
        "content": "<p>Captures too much that might be better served with more granular classes.</p>",
        "id": 561271578,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764622429
    },
    {
        "content": "<p>Again I havenâ€™t thought much so just talking atm.</p>",
        "id": 561271833,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764622548
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/561271396\">said</a>:</p>\n<blockquote>\n<p>It seems that <code>SMul</code> is too generic.</p>\n</blockquote>\n<p>I've had this thought on several occasions, but I don't know how to get around it without notation.</p>",
        "id": 561276049,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1764623832
    },
    {
        "content": "<p>See also <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Too.20many.20.27Smul.27s/near/518386688\">#mathlib4 &gt; Too many 'Smul's @ ğŸ’¬</a> ...</p>",
        "id": 561280460,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1764625083
    },
    {
        "content": "<p>Here is a concrete path: should coerce and multiply be an smul?</p>",
        "id": 561284395,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764626695
    },
    {
        "content": "<p>That's a particularly interesting one because we've always had tension between <code>Algebra A B</code> and <code>SMul A B</code> (with several redesigns).</p>",
        "id": 561285816,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764627228
    },
    {
        "content": "<blockquote>\n<p>should coerce and multiply be an smul? </p>\n</blockquote>\n<p>cf the controversial <a href=\"https://github.com/leanprover-community/mathlib4/pull/26912\">#26912</a> where I simp away that smul into a mul.</p>",
        "id": 561286269,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1764627462
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.5BSMul.20A.20B.5D.20.3A.20SMul.20.28F.20A.29.20.28F.20B.29/near/561284395\">said</a>:</p>\n<blockquote>\n<p>Here is a concrete path: should coerce and multiply be an smul?</p>\n</blockquote>\n<p>I think this only postpones the question to \"which operations should be coercions\"</p>",
        "id": 561290591,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1764629374
    },
    {
        "content": "<p>For sure. In my mind Iâ€™m relying on â€œmathematical tasteâ€</p>",
        "id": 561290998,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764629577
    }
]