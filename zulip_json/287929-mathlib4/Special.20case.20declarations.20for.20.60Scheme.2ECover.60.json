[
    {
        "content": "<p>Recently, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.Cover#doc\">docs#AlgebraicGeometry.Scheme.Cover</a> was replaced by an <code>abbrev</code> for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Precoverage.ZeroHypercover#doc\">docs#CategoryTheory.Precoverage.ZeroHypercover</a> (a <code>0</code>-hypercover is an indexed family of morphisms in the precoverage).</p>\n<p>In the process, we deprecated many special case constructions for the case of <code>Scheme</code>s (e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.Cover.pullbackCover#doc\">docs#AlgebraicGeometry.Scheme.Cover.pullbackCover</a>). Some special declarations still remain though (of which most don't make sense in the general setting), e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.Cover.ulift#doc\">docs#AlgebraicGeometry.Scheme.Cover.ulift</a>.</p>\n<p>This leads to some annoying behaviour, for example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"w\"> </span><span class=\"n\">AlgebraicGeometry</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: Invalid field `ulift`: The environment does not contain `CategoryTheory.Precoverage.ZeroHypercover.ulift`</span>\n<span class=\"sd\">  Precoverage.ZeroHypercover.pullback₁ f U</span>\n<span class=\"sd\">has type</span>\n<span class=\"sd\">  (Scheme.precoverage IsOpenImmersion).ZeroHypercover X</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"bp\">.</span><span class=\"n\">OpenCover</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">.</span><span class=\"n\">OpenCover</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">U</span><span class=\"bp\">.</span><span class=\"n\">pullback₁</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ulift</span>\n</code></pre></div>\n<p>Whenever we use one of the general <code>ZeroHypercover</code> constructions, we end up with <code>(Scheme.precoverage IsOpenImmersion).ZeroHypercover</code>s instead of <code>OpenCover</code> in the infoview.</p>\n<p>A few options to improve the situation:</p>\n<ol>\n<li>Duplicate all general <code>PreZeroHypercover</code> and <code>ZeroHypercover</code> constructions for the special case of <code>Scheme.Cover</code> (and maybe also <code>Scheme.OpenCover</code>?!) and treat <code>ZeroHypercover</code> as an implementation detail that users should not interact with (this also means duplicating all generated <code>simps</code> lemmas!)</li>\n<li>Remove <code>AlgebraicGeometry.Scheme.Cover</code> and move all <code>AlgebraicGemetry.Scheme.Cover.*</code> declarations to the <code>AlgebraicGeometry.CategoryTheory.Precoverage.ZeroHypercover</code> namespace. After <code>open AlgebraicGeometry</code> this makes these available with dot notation as before.</li>\n<li>Make <code>Scheme.Cover</code> and <code>Scheme.OpenCover</code> notation equipped with a delaborator.  Users would still interact with <code>ZeroHypercover</code> and this fact would be explained in the docstring of the <code>Scheme.Cover</code> notation.</li>\n</ol>\n<p>In my opinion, option 1 is only feasible when done automatically by some meta program (maybe using <span class=\"user-mention\" data-user-id=\"519559\">@Dagur Asgeirsson</span> 's <code>duplicate</code> attribute?), because the <code>ZeroHypercover</code> API will keep growing and keeping the API in sync manually would be a nightmare.<br>\nOption 2 has all the disadvantages of the <code>TopLevelA.TopLevelB</code> <del>trick</del>feature, but avoids duplication and encourages more general statements because users are made aware of the more general <code>ZeroHypercover</code> API.<br>\nOption 3: Brings back the sane infoview, but does not hide the implementation.</p>\n<p>My preference would be a combination of 2 and 3.</p>\n<p>Happy to hear comments or suggestions (pinging some possibly interested people: <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span>, <span class=\"user-mention\" data-user-id=\"459699\">@Joël Riou</span>, <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>).</p>",
        "id": 560077782,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764052931
    },
    {
        "content": "<p>Intuitively, I think I would rank these from favorite to least favorite as 2,1,3.</p>",
        "id": 560079461,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764053860
    },
    {
        "content": "<p>2 looks good to me.</p>",
        "id": 560088891,
        "sender_full_name": "Joël Riou",
        "timestamp": 1764057788
    },
    {
        "content": "<p>I do not like 2 because this is very unreadable everywhere where the dot notation is not available: in docs, infoviews, loogle outputs, hovers etc. I do not think 1 is that bad as this is a common pattern when setting up API boundaries.</p>",
        "id": 560101098,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764061887
    },
    {
        "content": "<p>I'm not an expert in this sort of thing at all, but I am wondering whether in group cohomology we tried an analogue of 2 and it didn't work very well. <span class=\"user-mention\" data-user-id=\"699016\">@Edison Xie</span> <span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> an I making any sense? I'm talking about how you guys decided that trying to make Rep an abbrev for Action and then getting everyone to use Action under the hood didn't work very well for you (why not?). But I might be confused and talking about something else.</p>",
        "id": 560101135,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764061903
    },
    {
        "content": "<p>I do like 1 the best, I think metaprogramming is the best solution in this case. As Kevin mentioned, we had to define Rep.res in our repo and use that instead of Action.res (so another API duplication) because it kept leaking into Action.</p>",
        "id": 560122115,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1764068035
    },
    {
        "content": "<p>If we did 1, where do we stop? Do we duplicate <em>every</em> declaration that mentions <code>PreZeroHypercover</code> or <code>ZeroHypercover</code>? I.e. we also duplicate things like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.PreZeroHypercoverFamily#doc\">docs#CategoryTheory.PreZeroHypercoverFamily</a> or <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.MorphismProperty.IsLocalAtTarget%3F#doc\">docs#CategoryTheory.MorphismProperty.IsLocalAtTarget?</a> This is not only creating a bunch of <code>alias</code>es, we would also have to transform the bodies of definitions, inductive types etc.</p>",
        "id": 560125740,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764069100
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Special.20case.20declarations.20for.20.60Scheme.2ECover.60/near/560101135\">said</a>:</p>\n<blockquote>\n<p>I'm talking about how you guys decided that trying to make Rep an abbrev for Action and then getting everyone to use Action under the hood didn't work very well for you (why not?). But I might be confused and talking about something else.</p>\n</blockquote>\n<p>This is not what 2 is saying. 2 is saying to have no <code>abbrev</code> at all and directly use the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.PreZeroHypercover#doc\">docs#CategoryTheory.PreZeroHypercover</a> API. When specific declarations are needed, they would get the <code>AlgebraicGeometry</code> prefix.</p>",
        "id": 560125984,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764069182
    },
    {
        "content": "<p>I'd say we duplicate everything that we need. So yes to <code>IsLocalAtTarget</code> and maybe to <code>PreZeroHypercoverFamily</code>.</p>",
        "id": 560127040,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764069539
    },
    {
        "content": "<p>A middleground is to work with <code>ZeroHypercover</code> directly but avoid the unintelligible names. This means no dot notation but I don't think this matters a lot.</p>",
        "id": 560127254,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764069606
    },
    {
        "content": "<p>By \"the unintelligible names\" you mean the <code>TopLevelA.TopLevelB</code> feature?</p>",
        "id": 560127476,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764069684
    },
    {
        "content": "<p>If so, how would you call <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.Scheme.Cover.ulift#doc\">docs#AlgebraicGeometry.Scheme.Cover.ulift</a> then?</p>",
        "id": 560127565,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764069716
    },
    {
        "content": "<p><code>Scheme.uliftCover</code>?</p>",
        "id": 560127628,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764069735
    },
    {
        "content": "<p>Or keep the name and open <code>Scheme.Cover</code> and write <code>ulift \\McU</code>.</p>",
        "id": 560127751,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764069772
    },
    {
        "content": "<p>To clarify, the two main points against 2 are<br>\n(a) <code>open CategoryTheory</code> no longer works in <code>namespace AlgebraicGeometry</code><br>\n(b) The <code>AlgebraicGeometry.CategoryTheory.Precoverage.ZeroHypercover</code> namespace is unreadable everywhere but the source code.</p>\n<p>And the only point for 2 (compared to no-duplication + no-weird-names) is (afaik) dot notation.<br>\nI am happy to forfeit (a) for dot notation but I don't think the current downside in (b) outweighs the benefit you get from dot notation.</p>\n<p>A way to lessen the impact of (b) is by e.g. renaming <code>CategoryTheory.Precoverage.ZeroHypercover</code> to <code>CategoryTheory.Cover</code>, and to write a delaborator to let the infoview (and perhaps statments in docs) pretty print like the source code. In this case at least only the declaration names in docs/search results are moderately bad.</p>",
        "id": 560129658,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764070441
    },
    {
        "content": "<p>Already now without any delaborators and independent of the namespace, the docs only show the last part of the declaration's name inside the statement.<br>\n(Side note: A delaborator would not help for improving the looks of the docs, because the delaborator would probably be scoped and hence ignored by docgen.)</p>\n<p>Are declaration names with many nested namespaces in docs / search really that bad? I don't find them visually distracting and reasonably readable, because the names are structured by <code>.</code>.</p>\n<p>In my opinion, we should prioritise<br>\n(a) readability in the infoview, and<br>\n(b) readability in the sourcecode, and<br>\n(c) typing load.</p>\n<p>(a) can be fixed by a delaborator, independent of any of the other decisions.<br>\n(b) and (c) can mostly be dealt with by <code>open</code> and dot notation in option 2 above.</p>",
        "id": 560145245,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764074961
    },
    {
        "content": "<p>The (only?) place where full declaration names matter, is loogle and here I definitely agree that typing out <code>AlgebraicGeometry.CategoryTheory.Precoverage.ZeroHypercover.Foo</code> is annoying.</p>",
        "id": 560145691,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764075072
    },
    {
        "content": "<blockquote>\n<p>Are declaration names with many nested namespaces in docs / search really that bad?</p>\n</blockquote>\n<p>Here's an example where I replaced <code>Scheme.Cover</code> in the docs with <code>CategoryTheory.Precoverage.ZeroHypercover</code>.<br>\n<a href=\"/user_uploads/3121/s7VW69pHN0bvUsnJbdtJmSTm/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/s7VW69pHN0bvUsnJbdtJmSTm/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"738x1416\" src=\"/user_uploads/thumbnail/3121/s7VW69pHN0bvUsnJbdtJmSTm/image.png/840x560.webp\"></a></div>",
        "id": 560150048,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764076276
    },
    {
        "content": "<p>OTOH is dot notation really necessary for readability? How unreadable does the statement get without dot notation?</p>",
        "id": 560151764,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764076690
    },
    {
        "content": "<p>I don't think this is significantly worse than:<br>\n<a href=\"/user_uploads/3121/N8pzKVQuGMBl2vtmYoPsFiFZ/image.png\">image.png</a><br>\nFor me both are unreadable enough that I never use the sidebar to find a declaration.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/N8pzKVQuGMBl2vtmYoPsFiFZ/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"422x970\" src=\"/user_uploads/thumbnail/3121/N8pzKVQuGMBl2vtmYoPsFiFZ/image.png/840x560.webp\"></a></div>",
        "id": 560157146,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764078018
    },
    {
        "content": "<p>You are forced to look at them in loogle and docs search results and the autocompletion dropdowns though. Even if you don't personally use them, I believe they are a key part of most people's workflow that we should not disregard the usability of these tools.</p>",
        "id": 560165126,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764079865
    },
    {
        "content": "<p>It seems to me that autocomplete is already namespace aware? (Admittedly, I don't use autocomplete, so I might very well be wrong. But some quick experiments in vscode seem to confirm this.)</p>",
        "id": 560167436,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764080420
    },
    {
        "content": "<p>Thinking about this a bit more, I would still strongly prefer seeing <code>X.OpenCover</code> over <code>Precoverage.ZeroHypercover (Scheme.precoverage IsOpenImmersion) X</code> in infoviews though.</p>",
        "id": 560167498,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764080436
    },
    {
        "content": "<p>By autocomplete I mean the dropdown search menu in docs.</p>",
        "id": 560167555,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764080449
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Special.20case.20declarations.20for.20.60Scheme.2ECover.60/near/560167498\">said</a>:</p>\n<blockquote>\n<p>Thinking about this a bit more, I would still strongly prefer seeing <code>X.OpenCover</code> over <code>Precoverage.ZeroHypercover (Scheme.precoverage IsOpenImmersion) X</code> in infoviews though.</p>\n</blockquote>\n<p>This could be (partially) fixed by a delaborator though.</p>",
        "id": 560167868,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764080537
    },
    {
        "content": "<p>I think we should first decide on the following question:</p>\n<p>Do we want users to interact with the general <code>ZeroHypercover</code> API at all or do we want to treat this entirely as an implementation detail?</p>",
        "id": 560168216,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764080624
    },
    {
        "content": "<p>Middleground could be: We want special support for <code>Scheme.OpenCover</code> and anything that involves changing the topology should use <code>ZeroHypercover</code> directly.</p>",
        "id": 560168701,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764080741
    },
    {
        "content": "<p>I would be okay with this as a temporary solution, and when we start doing a bunch of concrete computations with covers in other topologies we could re-evaluate if this special support should be extended to the other topologies or scrapped entirely.</p>",
        "id": 560169749,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764080954
    },
    {
        "content": "<p>OTOH do you not think renaming <code>CategoryTheory.Precoverage.ZeroHypercover</code> to <code>CategoryTheory.Cover</code> would improve readability substantially though while losing little? Is 0-hypercover a common name in the literature? I usually see them called covering families or just covers.</p>",
        "id": 560170878,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764081191
    },
    {
        "content": "<p><code>ZeroHypercover</code> is in analogy with <code>OneHypercover</code>.</p>",
        "id": 560171418,
        "sender_full_name": "Christian Merten",
        "timestamp": 1764081322
    },
    {
        "content": "<p>Yes I understand the reason but is this analogy that important? Do you need to know about <code>OneHypercover</code> to use the API of <code>ZeroHypercover</code> or to understand the mathematical concept of <code>ZeroHypercover</code>?</p>",
        "id": 560193778,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764086470
    }
]