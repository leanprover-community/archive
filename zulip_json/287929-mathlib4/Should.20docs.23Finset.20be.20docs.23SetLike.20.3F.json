[
    {
        "content": "<p>Recently, <span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span> added a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SetLike#doc\">docs#SetLike</a> instance for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset#doc\">docs#Finset</a> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/28241\">#28241</a>. While this instance is valid, <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> had told me years ago that this was not the intended use case for <code>SetLike</code>, and instead that it should be reserved to subobjects. In this instance, I find it damageable that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.toSet#doc\">docs#Finset.toSet</a> was deprecated, as it was a very convenient way to insert the <code>Finset</code> to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Set#doc\">docs#Set</a> coercion exactly where needed.</p>",
        "id": 553344694,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1762165139
    },
    {
        "content": "<p>What do people think?</p>",
        "id": 553344706,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1762165142
    },
    {
        "content": "<p>Do you remember the reasons why Finset shouldn't be SetLike? Or can you link to a conversation where this was discussed?</p>",
        "id": 553345618,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762165389
    },
    {
        "content": "<p>One annoying thing is that this doesn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Even though this does:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→₀</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 553351599,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762167066
    },
    {
        "content": "<p>Absolutely. The lack of \"functorial coercions\" is particularly felt around the finset API</p>",
        "id": 553352099,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1762167160
    },
    {
        "content": "<p>semirelatedly i've been struggling with that a lot in the hom classes, I think this is a well-known issue here</p>",
        "id": 553352206,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762167190
    },
    {
        "content": "<p>is it possible to write a macro to fix that? like <code>alg% x</code></p>",
        "id": 553353199,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762167527
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553344694\">said</a>:</p>\n<blockquote>\n<p>Eric Wieser had told me years ago that this was not the intended use case for <code>SetLike</code>, and instead that it should be reserved to subobjects.</p>\n</blockquote>\n<p>To make this less vague, this seems to be Eric's actual objection:</p>\n<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/28241#issuecomment-3429850623\">said</a></p>\n<blockquote>\n<p>I think I remember what I find weird about this; no other SetLike instances implement the set notation lattice operators.</p>\n</blockquote>",
        "id": 553354766,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1762168005
    },
    {
        "content": "<p>When I implemented a <code>CoeSort Finset</code> instance (back when it was spelled <code>has_coe_to_sort finset</code>), there was some feeling that this instance had to be missing for a reason. But it really did improve the situation.</p>",
        "id": 553355062,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1762168112
    },
    {
        "content": "<p>I agree though that it is currently a pain to convert things to a <code>Set _</code>. Can we fix this by writing a better elaborator that inserts the right coercion?</p>",
        "id": 553355185,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1762168156
    },
    {
        "content": "<p>We would need a change in core to get my above example to work. An easier alternative would be a <code>toSet% s</code> elaborator, which would just be a macro for <code>SetLike.coe s</code></p>",
        "id": 553355972,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762168449
    },
    {
        "content": "<p>Are there more \"functorial coercions\" that could benefit from such a core change? If so, that could make for a stronger RFC.</p>",
        "id": 553356533,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762168663
    },
    {
        "content": "<p>I also was a bit saddened by the deprecation of <code>Finset.toSet</code>, because when I had a <code>finset</code> <code>s</code> it was nice to be able to write <code>s.toSet.pi</code> to refer to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Set.pi#doc\">docs#Set.pi</a>, and I now have to spell that <code>.pi (SetLike.coe s)</code> (although I'd be happy to hear if there is a nicer way).</p>",
        "id": 553356850,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1762168783
    },
    {
        "content": "<p>In FLT I changed all <code>X.toSet</code>s to <code>(X : Set Y)</code></p>",
        "id": 553358181,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762169213
    },
    {
        "content": "<p>the problem with this is that now you're mentioning the type</p>",
        "id": 553358544,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762169271
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553351599\">said</a>:</p>\n<blockquote>\n<p>One annoying thing is that this doesn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Even though this does:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→₀</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Note: this worked in Lean 2. Coercions are a lot more complicated now, but maybe we can ask the Lean FRO if they are willing to investigate whether this is feasible to support.</p>\n<p>I'm personally happy to have a macro/notation for <code>Finset.toSet</code>. (Or other \"simple\" coercions that fire even if the expected type is not fully known).</p>",
        "id": 553361928,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762170361
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553358181\">said</a>:</p>\n<blockquote>\n<p>In FLT I changed all <code>X.toSet</code>s to <code>(X : Set Y)</code></p>\n</blockquote>\n<p>This does not work in my case, it seems to be because <code>s</code> is <code>Finset.univ</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">γ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">⁻¹'</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"bp\">.</span><span class=\"n\">toSet</span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"c1\">-- works but deprecated</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">⁻¹'</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">coe</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"c1\">-- works but verbose</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">⁻¹'</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">⁻¹'</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">pi</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 553362395,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1762170537
    },
    {
        "content": "<p>Oh I see, with Finset.univ, the α is a metavariable on the inside of the coercion instead of the outside of the coercion. That case would also need to be supported by this potential core support. Though it should work with the <code>toSet%</code> that I desceibed above.</p>",
        "id": 553363327,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762170871
    },
    {
        "content": "<p>would this also work with the hom problem I mentioned above?</p>",
        "id": 553363923,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762171083
    },
    {
        "content": "<p>mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">→+</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 553364039,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762171125
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span></p>",
        "id": 553377513,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762175547
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> since we discussed this coercion a little while ago</p>",
        "id": 553391866,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1762179479
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n\n<span class=\"c1\">-- to be replaced with attribute stuff</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">homDict</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">HashMap</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{(</span><span class=\"ss\">``AddMonoidHom</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``AddMonoidHomClass.toAddMonoidHom</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"ss\">``Set</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">``SetLike.coe</span><span class=\"o\">)}</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"alg% \"</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">head</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"bp\">.</span><span class=\"n\">getAppFnArgs</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ofClass</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">homDict</span><span class=\"bp\">.</span><span class=\"n\">get?</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">head</span>\n<span class=\"w\">  </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"n\">ofClass</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">typ</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddMonoid</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddMonoid</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→+</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">f</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">alg</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">alg</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 553443650,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192156
    },
    {
        "content": "<p>this new <code>alg%</code> macro solves both problems (actually the same problem) at once (and is very easy to implement)!</p>",
        "id": 553443708,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192172
    },
    {
        "content": "<p>or maybe this is an <a href=\"#narrow/channel/270676-lean4/topic/a.20question.20on.20elaboration.20order/with/553376914\">elaboration order issue</a> again?</p>",
        "id": 553444068,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192306
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> do you think this one could be solved by changing the compiler? as in, to have the compiler resolve coercions before filling in all the metavariables</p>",
        "id": 553444412,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192415
    },
    {
        "content": "<p>why would the compiler be relevant</p>",
        "id": 553444553,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192465
    },
    {
        "content": "<p>because the dictionary above looks like one that Lean would already have stored somewhere for constructing coercions</p>",
        "id": 553444555,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192466
    },
    {
        "content": "<p>do you mean the elaborator?</p>",
        "id": 553444590,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192473
    },
    {
        "content": "<p>probably, i'm still not sure what the different parts do</p>",
        "id": 553444626,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192487
    },
    {
        "content": "<p>The changes that this caused in CSlib were minor, but I will say that looking through the diff of that PR that I find some of replacements of <code>Finset.toSet</code> to <code>(↑)</code> a bit harder to read, especially in a composition.</p>",
        "id": 553444761,
        "sender_full_name": "Chris Henson",
        "timestamp": 1762192529
    },
    {
        "content": "<p>not sure how you could do any coercions without fulling in metavariables</p>",
        "id": 553444781,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192538
    },
    {
        "content": "<p>is my code above a good solution then</p>",
        "id": 553444904,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192577
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553444781\">said</a>:</p>\n<blockquote>\n<p>not sure how you could do any coercions without fulling in metavariables</p>\n</blockquote>\n<p>my code above is essentially doing coercions just by resolving the head symbol without first waiting for all the mvars to be filled in</p>",
        "id": 553445213,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192665
    },
    {
        "content": "<p>I don't like the use of <code>Lean.mkIdent</code></p>",
        "id": 553445235,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192675
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553445213\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553444781\">said</a>:</p>\n<blockquote>\n<p>not sure how you could do any coercions without fulling in metavariables</p>\n</blockquote>\n<p>my code above is essentially doing coercions just by resolving the head symbol without first waiting for all the mvars to be filled in</p>\n</blockquote>\n<p>so it doesn't work if the head symbol is a metavariable</p>",
        "id": 553445301,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192698
    },
    {
        "content": "<p>but the head symbol is often not a metavariable, it's always <code>RingHom</code>, what the elab gets stuck on are its arguments</p>",
        "id": 553445346,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192718
    },
    {
        "content": "<p>see my example in my code</p>",
        "id": 553445373,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192727
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553445235\">said</a>:</p>\n<blockquote>\n<p>I don't like the use of <code>Lean.mkIdent</code></p>\n</blockquote>\n<p>the head symbol is resolved from a dictionary so there's no syntax position information</p>",
        "id": 553445447,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762192753
    },
    {
        "content": "<p>I was referring to this message</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553444412\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> do you think this one could be solved by changing the compiler? as in, to have the compiler resolve coercions before filling in all the metavariables</p>\n</blockquote>",
        "id": 553445494,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192768
    },
    {
        "content": "<p>If you don't fill in the metavariables first I think you will get a lot more cases where the head symbol is a mvar</p>",
        "id": 553445587,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192797
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553445447\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553445235\">said</a>:</p>\n<blockquote>\n<p>I don't like the use of <code>Lean.mkIdent</code></p>\n</blockquote>\n<p>the head symbol is resolved from a dictionary so there's no syntax position information</p>\n</blockquote>\n<p>Use the syntax information attached to <code>alg%</code></p>",
        "id": 553445693,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192826
    },
    {
        "content": "<p>oh I get it now</p>",
        "id": 553446062,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192923
    },
    {
        "content": "<p>wait but you have a fullname</p>",
        "id": 553446133,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762192946
    },
    {
        "content": "<p>right now the thing to do (as I've been told) is to write <code>AddMonoidHomClass.toAddMonoidHom f</code> to have the coercion fire automatically, and what I've achieved is just an automatic (and much shorter) version of this</p>",
        "id": 553446684,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762193129
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Should.20docs.23Finset.20be.20docs.23SetLike.20.3F/near/553355972\">said</a>:</p>\n<blockquote>\n<p>We would need a change in core to get my above example to work. An easier alternative would be a <code>toSet% s</code> elaborator, which would just be a macro for <code>SetLike.coe s</code></p>\n</blockquote>\n<p>since people upvoted this, do we just want the macro for SetLike, or would it also be a good idea to extend this to other FunLike classes in the hierarchy like in my example code above?</p>",
        "id": 553456717,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762195507
    },
    {
        "content": "<p>Kenny, there has been discussion of removing <em>all</em> the <code>HomClass.toHom</code> coercions (as actual coercions, but keeping them as <code>def</code>s). Along with this, we will probably rename them all to <code>Hom.ofClass</code> (to match their <code>SetLike</code> counterparts). So in cases there the expected type is known, you should be able to simply write <code>.ofClass f</code>.</p>",
        "id": 553466518,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762198752
    },
    {
        "content": "<p>So I don't think a dedicated elaborator will be necessary (but perhaps I'm overlooking something).</p>",
        "id": 553466773,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762198835
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> do you have a link to such a discussion?</p>",
        "id": 553475595,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762202098
    },
    {
        "content": "<p>It's been discussed privately among reviewers (primarily to make sure we had consensus among that group, as it's a nontrivial change). I will post about it publicly soon.</p>",
        "id": 553477565,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762202895
    }
]