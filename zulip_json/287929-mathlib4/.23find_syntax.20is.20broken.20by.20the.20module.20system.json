[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/-- info: Found 0 uses among over 0 syntax declarations -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">find_syntax</span><span class=\"w\"> </span><span class=\"s2\">\"∘\"</span><span class=\"w\"> </span><span class=\"n\">approx</span>\n</code></pre></div>\n<p>Without the <code>module</code> line it successfully finds the notation.<br>\n(possibly related to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.23help.20is.20broken.20by.20the.20module.20system/with/573398169\">#mathlib4 &gt; #help is broken by the module system</a>)</p>",
        "id": 573573283,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1770915187
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span></p>",
        "id": 573573494,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1770915246
    },
    {
        "content": "<p>Probably you need to <code>public import Mathlib</code></p>",
        "id": 573648849,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1770947453
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.23find_syntax.20is.20broken.20by.20the.20module.20system/near/573648849\">said</a>:</p>\n<blockquote>\n<p>Probably you need to <code>public import Mathlib</code></p>\n</blockquote>\n<p>Still fails</p>",
        "id": 573648909,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1770947509
    },
    {
        "content": "<p>it gets weirder:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: Found 3 uses among over 0 syntax declarations</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">substring</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">find_syntax</span><span class=\"w\"> </span><span class=\"s2\">\"Mathlib\"</span><span class=\"w\"> </span><span class=\"n\">approx</span>\n</code></pre></div>",
        "id": 573706748,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770977376
    },
    {
        "content": "<p>ah wait, the <code>approx</code> bit means it rounds to hundreds <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 573711198,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770978863
    },
    {
        "content": "<p><del>atm my best guess is that <code>#find_syntax</code> filters out most syntax declarations because part of their names start with an underscore?</del> nop, that's wrong</p>",
        "id": 573712701,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770979325
    },
    {
        "content": "<p>It's just that all the syntax are non-public meta definitions, so they are simply not in the environment at this point.</p>",
        "id": 573716043,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770980434
    },
    {
        "content": "<p>no, that's not true either i think...</p>",
        "id": 573716335,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770980527
    },
    {
        "content": "<p>the issue is that the body of the syntax definitions is not exposed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"n\">meta</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">FindSyntax</span>\n\n<span class=\"bp\">#</span><span class=\"n\">find_syntax</span><span class=\"w\"> </span><span class=\"s2\">\"∘\"</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"n\">meta</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">term_</span><span class=\"bp\">∘_»</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#check_mem_env\"</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">prsr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``ParserDescr</span><span class=\"w\"> </span><span class=\"o\">[],</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``TrailingParserDescr</span><span class=\"w\"> </span><span class=\"o\">[]]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">csts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">csts</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isParser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prsr</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"c1\">-- &amp;&amp; cinfo.hasValue</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"found name {e.getId} in the environment, isParser: {isParser}\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">logError</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"did not find {e.getId} in the environment\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check_mem_env</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">term_</span><span class=\"bp\">∘_»</span>\n\n<span class=\"kn\">end</span>\n</code></pre></div>\n<p>note the <code>&amp;&amp; cinfo.hasValue</code> which is also one of the filtering conditions in the <code>find_syntax</code> command</p>",
        "id": 573716765,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770980669
    },
    {
        "content": "<p>the declarations are available in the environment (as in, their names and types exist), but not their bodies... but maybe that's what you meant</p>",
        "id": 573716916,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770980717
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35248\">#35248</a></p>",
        "id": 573726049,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1770984194
    }
]