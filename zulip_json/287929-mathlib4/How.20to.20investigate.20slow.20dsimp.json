[
    {
        "content": "<p>Currently, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Functor.commShiftIso#doc\">docs#CategoryTheory.Functor.commShiftIso</a> is defined as the <code>iso</code> field of the typeclass <code>Functor.CommShift</code>, but the relatively new syntax about making explicit certain variables of typeclasses would allow to remove the need for the extra definition <code>Functor.commShiftIso</code>, which is what I am trying to do in <a href=\"https://github.com/leanprover-community/mathlib4/pull/31504\">#31504</a>.<br>\nI do not know exactly how, but this leads to a very significant slowdown in the file <code>CategoryTheory.Triangulated.Opposite.Functor</code>.<br>\nI could get <code>mapTriangleOpCompTriangleOpEquivalenceFunctorApp</code> to compile in a reasonable time by squeezing <code>dsimp</code> (which is not a very good solution as <code>simp</code> should take care of this):<br>\n<a href=\"https://github.com/joelriou/mathlib4/blob/f797c24145813ce2a10367a2602c3cc0be5ca210/Mathlib/CategoryTheory/Triangulated/Opposite/Functor.lean#L172-L196\">https://github.com/joelriou/mathlib4/blob/f797c24145813ce2a10367a2602c3cc0be5ca210/Mathlib/CategoryTheory/Triangulated/Opposite/Functor.lean#L172-L196</a><br>\nThe generation of the <code>simps</code>-lemmas attached to this definition is also extremely long. How could I investigate further what is creating this slow-down?<br>\nI have tried</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">simps</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"n\">hom_hom₁</span><span class=\"w\"> </span><span class=\"n\">hom_hom₂</span><span class=\"w\"> </span><span class=\"n\">hom_hom₃</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">mapTriangleOpCompTriangleOpEquivalenceFunctorApp</span>\n</code></pre></div>\n<p>but it only tells me \"<code>dsimp took 2.25s</code>\".</p>",
        "id": 554967799,
        "sender_full_name": "Joël Riou",
        "timestamp": 1762883183
    },
    {
        "content": "<p>Is it possible that extra reductions are happening? Eg simp knows how to reduce <code>Prod.fst (a, b)</code> to <code>a</code>, but not necessarily <code>Prod.myOwnFst (a, b)</code> where <code>Prod.myOwnFirst</code> is a wrapper around <code>Prod.fst</code></p>",
        "id": 554968661,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1762883577
    },
    {
        "content": "<p>You should use <code>set_option trace.profiler true in</code>. This lets you see which parts are slow.</p>",
        "id": 554969198,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1762883810
    },
    {
        "content": "<p>Thanks very much! Indeed, this gives more details. It seems it was trying to apply the irrelevant simp lemmas attached to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Adjunction.rightAdjointCommShift#doc\">docs#CategoryTheory.Adjunction.rightAdjointCommShift</a>. The slow down seems mostly fixed by not making these simp lemmas.</p>",
        "id": 554971971,
        "sender_full_name": "Joël Riou",
        "timestamp": 1762884980
    }
]