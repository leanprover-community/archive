[
    {
        "content": "<p>Here's my example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myVec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">!</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"mi\">10</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"mi\">20</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">26</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">27</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"o\">]</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">myVec</span><span class=\"w\"> </span><span class=\"mi\">24</span>\n</code></pre></div>\n<p>On the playground, 24 took 10ish seconds for me. I did the same thing for the other entries, and here's a plot of the results.<br>\n<a href=\"/user_uploads/3121/4VEIjSudnx3-ouq2y3KSBtA5/image.png\">image.png</a><br>\nThat's nearly 4 minutes to evaluate myVec 29. Note that reducing these is relatively fast. Now this notation presumably wasn't designed for good evaluation, but this seems exponentially bad.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/4VEIjSudnx3-ouq2y3KSBtA5/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"782x504\" src=\"/user_uploads/thumbnail/3121/4VEIjSudnx3-ouq2y3KSBtA5/image.png/840x560.webp\"></a></div>",
        "id": 573759143,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1770993918
    },
    {
        "content": "<p>This seems surprising, since ultimately this should compile to a linear chain of <code>if</code>s</p>",
        "id": 573776563,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770998366
    },
    {
        "content": "<p>Does putting <code>inline</code> or <code>specialize</code> on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Matrix.vecCons#src\">src#Matrix.vecCons</a> help</p>",
        "id": 573781067,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770999566
    },
    {
        "content": "<p>There is a <code>-- FIXME: Performance review</code> in core for <code>Fin.induction</code></p>",
        "id": 573782291,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770999921
    },
    {
        "content": "<p>After a bit of simplification we arrive at:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">32</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecEmpty</span><span class=\"w\"> </span><span class=\"bp\">_;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">33</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">32</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">34</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">33</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">35</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">34</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">36</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">35</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">37</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">36</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">38</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">37</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">39</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">38</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">40</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">16</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">39</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">41</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">19</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">40</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">42</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">20</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">41</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">43</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">23</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">22</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">42</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">44</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">43</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">45</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">26</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">44</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">46</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">29</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">45</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">47</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">31</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">30</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">46</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">48</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">30</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">31</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">47</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">49</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">28</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">29</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">48</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">50</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">26</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">27</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">49</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">51</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">25</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">50</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">52</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">22</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">23</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">51</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">53</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">20</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">21</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">52</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">54</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">18</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">19</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">53</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">55</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">16</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">17</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">54</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">56</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">14</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">15</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">55</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">57</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">12</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">13</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">56</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">58</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">11</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">57</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">59</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">8</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">9</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">58</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">60</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">7</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">59</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">61</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">vecCons</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">60</span><span class=\"bp\">;</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">62</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">61</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">;</span>\n</code></pre></div>\n<p>And under the hood each of these <code>Matrix.vecCons</code> is going to allocate a closure that calls <code>Fin.cases</code> as well. Now <code>Fin.cases</code> is implemented in terms of <code>Fin.induction</code> which is implemented like an ordinary recursor. This means <code>Fin.cases</code> will traverse down along the entire successor chain every time it is called despite only wanting to know if the value is a succ or zero.</p>\n<p>What happens now is that due to this funny closuring etc. each of these steps spawns in turn a separate computation that also traverses down the remaining successor chain in the same tree fashion, so we get an exponential computation tree.<br>\nIf <code>Fin.cases</code> was defined as just a pattern match on the <code>Fin</code> instead of with <code>Fin.induction</code> this would basically just work.</p>\n<p>TLDR: Don't compile your recursors or you end up in situations like this <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 573788415,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771001872
    },
    {
        "content": "<p>But <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.induction#doc\">docs#Fin.induction</a> is just defined as a pattern match?</p>",
        "id": 573788836,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771002005
    },
    {
        "content": "<p>I tried making <code>cases</code> and <code>vecCons</code> <code>always_inline</code>, but I wasn't sure if that was better than <code>macro_inline</code> or <code>specialize</code></p>",
        "id": 573789462,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771002180
    },
    {
        "content": "<p>Yes, it is defined as the pattern match you would get when compiling the recursor for <code>Fin</code> using the mathlib infrastructure. And that pattern match is at fault.</p>\n<p><code>Fin.cases</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>\n<p>and the author here expected that the <code>_</code> argument, which provides the result of calling the <code>induction</code> recursively on <code>i</code>, would not be computed. But due to the fact that induction is defined as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">elab_as_elim</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">expose</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">induction</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">castSucc</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">hi</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Use a curried function so that this is structurally recursive</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rwa</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">mk_zero</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_of_succ_lt_succ</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_of_succ_lt</span><span class=\"w\"> </span><span class=\"n\">hi</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>where the result of <code>go</code> is always used so doing the recursion cannot be optimized away unless you specialize <code>go</code> for the specific <code>succ</code> function. But that is just pointless code blowup really. Instead what should be done is to define <code>cases</code> as just a pattern match and it will work.</p>",
        "id": 573789789,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771002274
    },
    {
        "content": "<blockquote>\n<p>unless you specialize <code>go</code> for the specific <code>succ</code> function. But that is just pointless code blowup really</p>\n</blockquote>\n<p>Is it? Is there an situation in which we don't want to specialize this recursor?</p>",
        "id": 573790325,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771002431
    },
    {
        "content": "<p>I agree that this is overkill vs a pattern match, but it seems like independently a reasonable idea.</p>",
        "id": 573790455,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771002476
    },
    {
        "content": "<p>As an aside, I suspect it would be better not to redefine <code>cases</code> (which would break defeqs), and instead set up a <code>csimp</code> lemma that expands it to the version defined with a match</p>",
        "id": 573790565,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771002512
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/eval.20matrix.20notation.20for.20the.20end.20entries.20is.20really.20slow/near/573790325\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>unless you specialize <code>go</code> for the specific <code>succ</code> function. But that is just pointless code blowup really</p>\n</blockquote>\n<p>Is it? Is there an situation in which we don't want to specialize this recursor?</p>\n</blockquote>\n<p>I think if you want to do it <code>induction</code> and <code>cases</code> should be marked <code>inline</code> and <code>go</code> as <code>specialize</code>, then it would generate somewhat reasonable code.</p>",
        "id": 573791649,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771002878
    },
    {
        "content": "<p>Note that this does of course rely on optimization to discover that the recursive argument is unused. So while it's going to work out pretty well for Fin.cases specialization won't fix all explosive situations for Fin.induction</p>",
        "id": 573793909,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1771003399
    },
    {
        "content": "<p>Drawing from what I learned through my experience with <a href=\"https://github.com/leanprover-community/mathlib4/pull/20519\">#20519</a>, <a href=\"https://github.com/leanprover-community/mathlib4/pull/20538\">#20538</a> &amp; <a href=\"https://github.com/leanprover-community/mathlib4/pull/12610\">#12610</a>, let me say that function types (e.g. <code>Fin n → α</code>, <code>Matrix</code>, <code>Equiv.Perm</code>), unlike inductive types (e.g. <code>List</code>), are fundamentally not suited for computations beyond a certain level of complexity.</p>\n<p>The reason is that inductive types get \"reduced\" during computation, whereas function types do not.</p>",
        "id": 573797248,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1771004463
    },
    {
        "content": "<p>To give a concrete example, once the n-th value of <code>l : List</code> has been computed, no further computation is required to retrieve the n-th element again.</p>",
        "id": 573797731,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1771004650
    },
    {
        "content": "<p>However, with <code>v : Fin m → α</code>, even if the n-th value has been computed once, whenever that n-th value is needed again, the same computation generally has to be performed all over again.</p>",
        "id": 573798197,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1771004813
    },
    {
        "content": "<p>This phenomenon leads to an exponential increase in computational cost.<br>\nFor example, suppose each component of <code>v₁ : Fin n → α</code> is computed based on all the components of <code>v₀ : Fin n → α</code>. Then every time a component of <code>v₁</code> is called, the components of <code>v₀</code> are called n times.<br>\nNext, if each component of <code>v₂ : Fin n → α</code> is similarly computed based on all the components of <code>v₁ : Fin n → α</code>, then every time a component of <code>v₂</code> is called, <code>v₁</code> is called n times, and <code>v₀</code> is called n² times. The rest, as you can imagine, follows accordingly. (cont.)</p>",
        "id": 573799653,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1771005316
    },
    {
        "content": "<p>For what it's worth, this phenomenon can be resolved with the following workarounds.</p>\n<ul>\n<li>After computing <code>v₁</code> from <code>v₀</code>, save the result to a <code>List</code> or similar structure by setting <code>v₁' := (Vector.ofFn v₁).get</code></li>\n<li>Devise the algorithm so that when computing the components of <code>v₄</code>, instead of directly calling the components of <code>v₃</code>, <code>v₂</code>, <code>v₁</code>, it calls the components of <code>v₀</code> directly (which is what I did in <a href=\"https://github.com/leanprover-community/mathlib4/pull/20519\">#20519</a>, <a href=\"https://github.com/leanprover-community/mathlib4/pull/20538\">#20538</a> &amp; <a href=\"https://github.com/leanprover-community/mathlib4/pull/12610\">#12610</a>)</li>\n</ul>",
        "id": 573802124,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1771006129
    },
    {
        "content": "<p>However, dealing with this problem will undoubtedly introduce extra considerations during computation and make definitions more complex. This also does not align with the spirit of Mathlib, which determines the appropriateness of definitions based on how mathematically tractable they are, without considering computational efficiency. Therefore, I would generally recommend against using function types for data types that require moderately complex computations involving concrete values.<br>\nIncidentally, I personally refer to this problem as the \"function closure issue\".</p>",
        "id": 573804618,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1771006884
    },
    {
        "content": "<p>(These replies were translated from Japanese by Claude. Please bear with us if there are any awkward translations.)</p>",
        "id": 573805255,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1771007012
    },
    {
        "content": "<p>If we want to be computationally effective, then we may want to add <code>FinMatrix</code> storing its values in a <code>Vector</code> of <code>Vector</code>s or in a single <code>Vector</code> of size <code>m * n</code>.</p>",
        "id": 573846285,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771027963
    },
    {
        "content": "<p>(or replace <code>Matrix</code> with it, if we don't care about other index types - I rarely use this part of the library, so I don't know)</p>",
        "id": 573846329,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771028003
    },
    {
        "content": "<p>At NYC Lean I think we were pleasantly surprised when it finally dawned on us why Matrix allowed for other index types, it made our proof of Graham-Pollak easier to have matrices indexed by our arbitrary vertex set <code>V</code>.</p>",
        "id": 573846709,
        "sender_full_name": "Julian Berman",
        "timestamp": 1771028287
    },
    {
        "content": "<p><span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span> Of course, we need arbitrary index types for the incidence matrix of a graph.</p>",
        "id": 573846832,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771028387
    },
    {
        "content": "<p>Another option is to make <code>![a, b]</code> a notation for <code>Vector.get #[a, b]</code>, though this may lead to a different kind of a natural API.</p>",
        "id": 573846944,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771028467
    }
]