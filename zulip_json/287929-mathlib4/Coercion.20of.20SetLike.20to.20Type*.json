[
    {
        "content": "<p>Currently, the coercion of <code>SetLike</code> structures like submonoids or submodules to <code>Type*</code> gets expanded to <code>{x // x ∈ s}</code>. If there is a <code>simp</code> lemma for <code>x ∈ s</code> (e.g., <code>s = LinearMap.range f</code>), then sometimes <code>simp</code> simplifies <code>x ∈ LinearMap.range f</code> to something, then fails to apply facts about <code>x : LinearMap.range f</code> that are in context. WDYT about hiding this coercion behind a definition, like we do for <code>DFunLike</code>? It can be the same definition for <code>Set</code>s and other stuff that will take a <code>Membership</code> instance as an argument.</p>",
        "id": 564278123,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1765985001
    },
    {
        "content": "<p>It was hidden in Lean 3, which I thought was great, and I would be willing to get back to that situation because of</p>\n<ol>\n<li>the simp issue you mention</li>\n<li><code>{x // x ∈ s}</code> being IMO quite mentally unparseable in the infoview</li>\n</ol>\n<p>On the other hand, <span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span> was happy with the change, saying it had gotten rid of a nothing definition.</p>",
        "id": 564849294,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1766259290
    },
    {
        "content": "<p>I'm going to wait for a few days before I start adding this \"nothing\" definition back.</p>",
        "id": 564849577,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766259604
    },
    {
        "content": "<p>My suggestion is that we give a generic definition that takes <code>Membership</code> as an argument, then register it as an instance for some types, incl. all <code>SetLike</code>. Doing it for <code>Set</code>s would mean going away from <code>Subtype</code>s there. I'm not sure if we want it.</p>",
        "id": 564852857,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766263625
    },
    {
        "content": "<p>We already have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Set.Elem#doc\">docs#Set.Elem</a> as such a nothing definition</p>",
        "id": 564853750,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766264797
    },
    {
        "content": "<p>I guess it's reducible though</p>",
        "id": 564853777,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766264833
    },
    {
        "content": "<p>I suggest that we add a semireducible definition</p>",
        "id": 564853862,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766264941
    },
    {
        "content": "<p>Yup I've since changed my mind, the simp issue is really annoying and I'm in favour of the above changes</p>",
        "id": 564855933,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1766267347
    },
    {
        "content": "<p>As someone who's been burned by this simp issue before, I'm glad to get rid of it.</p>",
        "id": 564872364,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1766294510
    },
    {
        "content": "<p>I wonder if having a semireducible definition will force us to introduce special names for <code>Subtype.val</code> etc.</p>",
        "id": 564914912,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766350193
    },
    {
        "content": "<p>A few downsides of a new definition:</p>\n<ul>\n<li>code duplication between <code>Subtype</code> and <code>Elem</code> (new type);</li>\n<li>if it's defined to be <code>Subtype</code>, then we're going to have <code>(Subtype.mk _ _ : Elem _)</code> (we already have this issue for, e.g., <code>NNReal</code>); if not, then we need even more code duplication.</li>\n</ul>",
        "id": 564915944,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766351787
    },
    {
        "content": "<p>What's the right way to resolve the <code>(Subtype.mk _ _ : Elem _)</code> issue? It isn't clear if, e.g., <code>simp</code> will recognize it as <code>Elem _</code> or as <code>Subtype _</code>.</p>",
        "id": 564915980,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766351841
    },
    {
        "content": "<p>So, what should we do here?</p>",
        "id": 565057775,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766430815
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Coercion.20of.20SetLike.20to.20Type*/near/564278123\">said</a>:</p>\n<blockquote>\n<p>If there is a <code>simp</code> lemma for <code>x ∈ s</code> (e.g., <code>s = LinearMap.range f</code>), then sometimes <code>simp</code> simplifies <code>x ∈ LinearMap.range f</code> to something, then fails to apply facts about <code>x : LinearMap.range f</code> that are in context.</p>\n</blockquote>\n<p>Can you produce a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> of this?</p>",
        "id": 565105255,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766472132
    },
    {
        "content": "<p>This:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">ker</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>creates a new copy of <code>x</code></p>",
        "id": 565105618,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766472392
    },
    {
        "content": "<p>Does this help?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Subtype</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">constructorNameAsVariable</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">simproc</span><span class=\"w\"> </span><span class=\"bp\">↓</span><span class=\"w\"> </span><span class=\"n\">avoid_subtypes</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofQ</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">SetLike</span><span class=\"bp\">.</span><span class=\"n\">instMembership</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">inst</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"c1\">-- Don't simplify set-like membership</span>\n\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s'_result</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">s'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s'_result</span><span class=\"bp\">.</span><span class=\"n\">expr</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s'</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">done</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hs'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">s'_result</span><span class=\"bp\">.</span><span class=\"n\">getProof</span>\n\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">done</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">hs'</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">continue</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">ker</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"c1\">-- does nothing</span>\n\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ℝ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">ker</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"c1\">-- simplifies the `.comp id`</span>\n</code></pre></div>",
        "id": 565108032,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766473933
    },
    {
        "content": "<p>I'll test it tomorrow</p>",
        "id": 565108161,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766474029
    },
    {
        "content": "<p>To be more precise; what if we just trained simp not to do this instead of changing the design?</p>",
        "id": 565108465,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766474236
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Coercion.20of.20SetLike.20to.20Type*/near/564849294\">said</a>:</p>\n<blockquote>\n<ol>\n<li><code>{x // x ∈ s}</code> being IMO quite mentally unparseable in the infoview</li>\n</ol>\n</blockquote>\n<p>This doesn't actually happen, right?</p>",
        "id": 565108511,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766474264
    },
    {
        "content": "<p>Up until now, I didn't know that we can use simprocs to ignore parts of the expressions. Looks like an option to me, if it works.</p>",
        "id": 565108701,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1766474388
    }
]