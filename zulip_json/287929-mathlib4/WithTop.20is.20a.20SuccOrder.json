[
    {
        "content": "<p>Currently, we have 2 instances that turn <code>WithTop</code> into a <code>SuccOrder</code>, depending on whether the original type has a maximal element or not. What do you think about unifying them into</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span> <span class=\"n\">WithTop.succ</span> <span class=\"o\">:</span> <span class=\"n\">WithTop</span> <span class=\"n\">α</span> <span class=\"bp\">→</span> <span class=\"n\">WithTop</span> <span class=\"n\">α</span>\n  <span class=\"bp\">|</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">α</span><span class=\"o\">)</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">if</span> <span class=\"n\">succ</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">a</span> <span class=\"k\">then</span> <span class=\"bp\">\\</span><span class=\"n\">top</span> <span class=\"k\">else</span> <span class=\"n\">some</span> <span class=\"o\">(</span><span class=\"n\">succ</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n  <span class=\"bp\">|</span> <span class=\"bp\">\\</span><span class=\"n\">top</span> <span class=\"bp\">=&gt;</span> <span class=\"bp\">\\</span><span class=\"n\">top</span>\n</code></pre></div>",
        "id": 418210171,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1706243137
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> <span aria-label=\"up\" class=\"emoji emoji-2b06\" role=\"img\" title=\"up\">:up:</span></p>",
        "id": 418210191,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1706243161
    },
    {
        "content": "<p>I didn't test that it works for any <code>[PartialOrder α] [SuccOrder α] [DecidableEq α]</code> yet.</p>",
        "id": 418210330,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1706243274
    },
    {
        "content": "<p>Another option is to test for <code>IsMax a</code> assuming <code>∀ a, Decidable (IsMax a)</code>. On the one hand, this way we can have efficient <code>Decidable</code> instances for this predicate. On the other hand, a generic instance assuming <code>[DecidableEq α] [OrderTop α]</code> would conflict with, e.g., type-specific instance for <code>WithTop _</code>.</p>",
        "id": 418210530,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1706243413
    },
    {
        "content": "<p>My PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/9480\">#9480</a> depends on the defeq <code>succ (some a) = some (succ a)</code> which isn't preserved by your proposed unification ...</p>",
        "id": 418228761,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1706256674
    },
    {
        "content": "<p>That looks fine to me, but I guess you'll have to fix Junyan's application</p>",
        "id": 418229589,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1706257099
    },
    {
        "content": "<p>How crucial is the defeq?</p>",
        "id": 418242384,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1706262720
    },
    {
        "content": "<p>I can add a <code>def</code> that works in all cases, then use <code>.copy</code> (adding if it's not here yet) to provide necessary defeq in the existing cases.</p>",
        "id": 418291258,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1706280989
    },
    {
        "content": "<p>In the meantime, the unification of the two instances has been implemented by <span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/15881\">#15881</a>. I'm now reviving my PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/9480\">#9480</a> and found that the defeq has been broken. <del>What I plan to do is to restore the removed NoMax/MinOrder instances as defs and use the <a href=\"https://github.com/leanprover-community/mathlib4/commit/45e815c5edc12baa16b76deaa2438068de46f60d#diff-ab59b1a549f80ae79568ddd230958273f3c97ae24b93c4fdfbea7eecb326dfddL1016-L1018\">NoMaxOrder instance</a> in my PR. Hopefully there's no objection.</del> I think I'll go ahead to implement Yury's suggestion above.</p>",
        "id": 477923773,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729455708
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"284160\">Eric Rodriguez</span> <a href=\"#narrow/channel/287929-mathlib4/topic/WithTop.20is.20a.20SuccOrder/near/418242384\">said</a>:</p>\n<blockquote>\n<p>How crucial is the defeq?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span>, would you mind answering the above?</p>",
        "id": 477928995,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1729460387
    },
    {
        "content": "<p>Oh wait, I think I misdiagnosed the breakage in <a href=\"https://github.com/leanprover-community/mathlib4/pull/9480\">#9480</a>, and my solution in <a href=\"https://github.com/leanprover-community/mathlib4/pull/15881\">#15881</a> isn't optimal. I think we can unify the instances while keeping favorable defeq, by replacing [DecidableEq] by [Decidable (a = succ a)] and provide an instances for the latter in the case of NoMaxOrder (that is always false). But deriving data-carrying instance like Decidable from Prop instance is probably not good practice, as it may conflict with existing DecidableEq instance. So maybe I'll just locally add a [Decidable (a = succ a)] instance in my PR.</p>\n<p>The situation is basically this: you have a sequence of vector subspaces <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi mathvariant=\"double-struck\">R</mi><mn>0</mn></msup><mo>⊂</mo><msup><mi mathvariant=\"double-struck\">R</mi><mn>1</mn></msup><mo>⊂</mo><msup><mi mathvariant=\"double-struck\">R</mi><mn>2</mn></msup><mo>⊂</mo><mo>…</mo></mrow><annotation encoding=\"application/x-tex\">\\mathbb{R}^0\\subset\\mathbb{R}^1\\subset\\mathbb{R}^2\\subset\\dots</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8532em;vertical-align:-0.0391em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">R</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">⊂</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8532em;vertical-align:-0.0391em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">R</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">⊂</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8532em;vertical-align:-0.0391em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">R</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">⊂</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.123em;\"></span><span class=\"minner\">…</span></span></span></span> indexed by ℕ of the countably infinite-dimensional space <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi mathvariant=\"double-struck\">R</mi><mi mathvariant=\"normal\">∞</mi></msup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{R}^\\infty</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">R</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">∞</span></span></span></span></span></span></span></span></span></span></span>, and you want to add a top element as the index of their union, which is the whole space <code>⊤</code>. After you do this you still want the successor of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi mathvariant=\"double-struck\">R</mi><mn>1</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{R}^1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">R</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span></span></span> reduce to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi mathvariant=\"double-struck\">R</mi><mn>2</mn></msup></mrow><annotation encoding=\"application/x-tex\">\\mathbb{R}^2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">R</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span></span></span> rather than some if-then-else expression. (If you do a rewrite it might break the algebraic/topological instances on these subspaces.) Of course for ℕ the reduction does work, but not in my setting where the SuccOrder is from an ordinal and doesn't have computable DecidableEq.</p>",
        "id": 477932473,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729462880
    },
    {
        "content": "<p>Actually <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/SetTheory/Ordinal/Basic.html#linearOrder_toType\">linearOrder_toType</a> for <code>Ordinal.toType</code> contains a noncomputable DecidableEq instance, so I'll need more maneuver to get the correct <code>SuccOrder</code> instance on <code>WithTop o.toType</code>.</p>",
        "id": 477933213,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729463529
    },
    {
        "content": "<p>Why are you using <code>o.toType</code>?</p>",
        "id": 477947265,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1729476846
    },
    {
        "content": "<p>As the docstring explains, you should only be using this over <code>Iio o</code> when you absolutely need something in <code>Type u</code></p>",
        "id": 477947341,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1729476928
    },
    {
        "content": "<p>I'd also like to mention an idea I previously had to generalize <code>succ</code> and <code>pred</code> to arbitrary orders and to instead have <code>SuccOrder</code> as a <code>Prop</code>-valued typeclass constraining these functions. I'm still not sure if this is a good idea, and in particular, I'd like to know whether the def-eqs provided by <code>succ</code> and <code>pred</code> are important in practice.</p>",
        "id": 477947512,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1729477066
    },
    {
        "content": "<p>I have been able to make <a href=\"https://github.com/leanprover-community/mathlib4/pull/9480\">#9480</a> compile by just adding <a href=\"https://github.com/leanprover-community/mathlib4/pull/9480/files#diff-ab59b1a549f80ae79568ddd230958273f3c97ae24b93c4fdfbea7eecb326dfddL995-R1147\">two lines</a> in SuccPred/Basic and one line <code>local instance (i : ι) : Decidable (succ i = i) := .isFalse (lt_succ i).ne'</code> in the main file, so I'll probably abandon <a href=\"https://github.com/leanprover-community/mathlib4/pull/15881\">#15881</a>. As I explained the defeq of the <code>succ</code> field is very convenient.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> <a href=\"#narrow/channel/287929-mathlib4/topic/WithTop.20is.20a.20SuccOrder/near/477947341\">said</a>:</p>\n<blockquote>\n<p>As the docstring explains, you should only be using this over <code>Iio o</code> when you absolutely need something in <code>Type u</code></p>\n</blockquote>\n<p>I checked and there are multiple places that break with the universe bump: first if you define <code>ι := Iio (Module.rank F E).ord</code> instead of <code>(Module.rank F E).ord.toType</code> then <code>#ι = Module.rank F E</code> doesn't compile and you'd need to use <code>Cardinal.lift</code>. Second, there's two families of types <code>Factor</code> and <code>Emb</code> (both in the universe of E) such that <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mrow><mi mathvariant=\"normal\">E</mi><mi mathvariant=\"normal\">m</mi><mi mathvariant=\"normal\">b</mi></mrow><mo stretchy=\"false\">(</mo><mi>o</mi><mo stretchy=\"false\">)</mo><mo>≃</mo><msub><mo>∏</mo><mrow><mi>i</mi><mo>&lt;</mo><mi>o</mi></mrow></msub><mrow><mi mathvariant=\"normal\">F</mi><mi mathvariant=\"normal\">a</mi><mi mathvariant=\"normal\">c</mi><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">r</mi></mrow><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\mathrm{Emb}(o)\\simeq\\prod_{i &lt; o}\\mathrm{Factor}(i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">Emb</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">o</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≃</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0771em;vertical-align:-0.3271em;\"></span><span class=\"mop\"><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">∏</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.162em;\"><span style=\"top:-2.4003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">i</span><span class=\"mrel mtight\">&lt;</span><span class=\"mord mathnormal mtight\">o</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3271em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">Factor</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span>, and if <code>o</code> is in a higher universe then the cardinal equality would require a <code>Cardinal.lift</code>. In summary, making the change would unnecessarily complicate the code.</p>",
        "id": 477985835,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729497533
    },
    {
        "content": "<p>Hm, that's unfortunate, but I guess <code>o.toType</code> might be the solution.</p>",
        "id": 478031526,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1729510844
    }
]