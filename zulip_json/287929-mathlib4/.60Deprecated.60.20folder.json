[
    {
        "content": "<p>I have a question on <a href=\"https://github.com/leanprover-community/mathlib4/pull/20979\">#20979</a>, in which I deprecate a whole file <code>AnalyticManifold</code>. I have moved it to the <code>Deprecated</code> folder, but I wonder if it doesn't break the purpose of deprecations: downstream projects which use <code>AnalyticManifold</code> import the file at its old location, so if I leave the file there they will see the deprecations and understand what they have to change, while if I move the file they will just get a wrong import and fail to get the suggestions given by the deprecation mechanism. </p>\n<p>Any thought?</p>",
        "id": 495451394,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1737622100
    },
    {
        "content": "<p>Maybe we could move the file to the deprecated folder and leave in its place a file with the original name that defines a function that deprecates the <em>import</em> in favour of the deprecated <em>file</em>?</p>",
        "id": 495452044,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737622293
    },
    {
        "content": "<p>E.g., the file with the path that you want to move defines a linter that flags the import line of itself as deprecated in favour of the path in the deprecated dir.</p>",
        "id": 495452190,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737622335
    },
    {
        "content": "<p>That would be very nice! I've seen several instances where we split a file into several subfiles in a subdirectory, and where this breaks downstream projects without any hint. This would also be solved by this mechanism.</p>",
        "id": 495452580,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1737622472
    },
    {
        "content": "<p>Ok, so maybe we could define an \"import deprecation linter\" that knows about these renames (either dynamically or statically) and that you can import in stubs of deprecated files to point to the right place.</p>",
        "id": 495452889,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737622569
    },
    {
        "content": "<p>I have a very busy day today, so I am not sure if I will have the time to get to this quickly, but I also think that it should not be particularly hard: the import parsing mechanism is already in the <code>header</code> linter and the rest is basically a simple matter of parsing a \"new\" name to the linter.</p>",
        "id": 495453388,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737622718
    },
    {
        "content": "<p>I don't think there is any hurry here. And I don't think I am able to write this linter myself, unfortunately :-(</p>",
        "id": 495453733,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1737622817
    },
    {
        "content": "<p>I'm happy to write it!  I'll ping you when I did!</p>",
        "id": 495454285,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737622958
    },
    {
        "content": "<p>Great, thanks!</p>",
        "id": 495454328,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1737622971
    },
    {
        "content": "<p>(The discussion about the implementation was more of a mental note to myself, not a subtle implication that you could write the linter, btw!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> )</p>",
        "id": 495454530,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737623040
    },
    {
        "content": "<p>I think this same issue was discussed a few months ago, possibly with resolution \"moving stuff to the Deprecated folder is deprecated\"</p>",
        "id": 495454583,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737623047
    },
    {
        "content": "<p>But there is still a question of renaming files and how to communicate this with downstream projects, right?</p>",
        "id": 495458576,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737624358
    },
    {
        "content": "<p>If you rename a file <code>Foo.lean</code> to another file <code>Bar.lean</code> (or even two files <code>Bar1.lean</code> and <code>Bar2.lean</code>), one could create an almost empty file <code>Foo.lean</code> looking like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Bar1</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Bar2</span>\n\n<span class=\"n\">deprecate_import</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"ss\">`Bar1</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`Bar2</span><span class=\"bp\">`</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which upon import would output a message \"This file has been renamed and split\" and a code action suggesting to replace itself with </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Bar1</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Bar2</span>\n</code></pre></div>\n<p>Isn't it what you had in mind?</p>",
        "id": 495459134,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1737624622
    },
    {
        "content": "<p>Yes, this is what I had in mind.</p>",
        "id": 495459874,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737624859
    },
    {
        "content": "<p>And if I thought about this right, you don't even need to pass the file names to the command, since it can read them off the import list.</p>",
        "id": 495460033,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737624910
    },
    {
        "content": "<p>An import deprecation linter would be great!</p>",
        "id": 495461482,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1737625365
    },
    {
        "content": "<p>Very happy to review :-)</p>",
        "id": 495461504,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1737625373
    },
    {
        "content": "<p>Ok, I think that I can procrastinate a little longer and write a first draft of this!</p>",
        "id": 495464117,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737626567
    },
    {
        "content": "<p>I think a <code>since</code> field would also be useful, to know when we can delete the stub files.</p>",
        "id": 495464220,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1737626591
    },
    {
        "content": "<p>Yes, I was planning to have a mandatory date requirement.</p>",
        "id": 495464326,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737626616
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20987\">#20987</a> contains a prototype.  I won't be very responsive for a while, but this is where I got to so far!</p>",
        "id": 495499542,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737639304
    },
    {
        "content": "<p>I guess we turn off the linter in <code>Mathlib.lean</code>?</p>",
        "id": 495503204,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737640267
    },
    {
        "content": "<p>Or we switch our lakefile to build things not imported by Mathlib.lean</p>",
        "id": 495503370,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737640316
    },
    {
        "content": "<p>Yes, turning off the linter in <code>Mathlib.lean</code> seems the way to go. But can we turn it off <em>before</em> the imports? (Otherwise, a hack is to desactivate it if the name of the current file is <code>Mathlib.lean</code> :-)</p>",
        "id": 495505134,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1737640790
    },
    {
        "content": "<p>The linter is already off in <code>Mathlib</code> and <code>Mathlib.Tactic</code>.</p>",
        "id": 495511088,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737642296
    },
    {
        "content": "<p>I renamed it to more consistently use <code>deprecateModules</code>.</p>",
        "id": 495512448,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737642643
    },
    {
        "content": "<p>The linter is taking a better shape.</p>",
        "id": 495541615,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737650210
    },
    {
        "content": "<p>The main missing feature for me right now is a test file.</p>",
        "id": 495541629,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737650216
    },
    {
        "content": "<p>To properly test the linter, though, I think that I need two extra test files: one that plays the role of the file-to-be-deprecated and one that plays the role of the file-unkowingly-importing-a-deprecated-file.</p>",
        "id": 495541642,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737650220
    },
    {
        "content": "<p>Does adding two test files for this seem reasonable, or should I extract as many \"internals\" as I can to test them, but produce a single test file?</p>",
        "id": 495541649,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737650222
    },
    {
        "content": "<p>Also, this is what the syntax seems to have settled on.  File <code>A</code>, whose original content has been moved to files <code>B, C, ..., Z</code> becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n<span class=\"bp\">...</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Z</span>\n\n<span class=\"n\">deprecated_module</span><span class=\"w\"> </span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"n\">yyyy</span><span class=\"bp\">-</span><span class=\"n\">mm</span><span class=\"bp\">-</span><span class=\"n\">dd</span>\n</code></pre></div>\n<p>Then, any file containing <code>import A</code> will have a warning on <code>A</code> suggesting to import <code>B, C, ..., Z</code> instead.</p>",
        "id": 495543562,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737650732
    },
    {
        "content": "<p>As usual with linters, I do not think that I can hook into the <code>Try this</code> machinery and I do not know if it is possible or not to get a code action.  The output of the warning contains the copy-pastable string</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n<span class=\"bp\">...</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Z</span>\n</code></pre></div>\n<p>though.</p>",
        "id": 495543866,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737650814
    },
    {
        "content": "<p>Does this need to be a linter? What does <code>initialize Lean.logInfo \"import Bar instead\"</code> do?</p>",
        "id": 495549603,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737652598
    },
    {
        "content": "<p>(or whatever the real spelling is)</p>",
        "id": 495549643,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737652619
    },
    {
        "content": "<p>Eric, I am not sure that I understand, mostly because I do not really know what <code>initialize</code> actually does.  I tried with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Deprecated\"</span>\n</code></pre></div>\n<p>but a file that imports the file where this command is defined simply hangs.</p>",
        "id": 495554844,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737654369
    },
    {
        "content": "<p>It probably doesn't hang if you use <code>eprintln</code></p>",
        "id": 495585784,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737666548
    },
    {
        "content": "<p>But indeed, you can't use the logger because you're in the wrong monad!</p>",
        "id": 495585825,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737666565
    },
    {
        "content": "<p>So I retract my suggestion</p>",
        "id": 495585845,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737666574
    },
    {
        "content": "<p>Ok, I confirm that with <code>eprintln</code> it does report the message, but in a weird way.  It might work from the command-line, since it is displayed as an <code>info</code> there.</p>",
        "id": 495586903,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737666970
    },
    {
        "content": "<p>I am currently updating Carleson to latest mathlib. And this is not going very well, because we haven't made a good job of deprecating file splittings: when a long file in mathlib is deleted and replaced by several short files, this leads to a hard error in downstream projects that used to import the initial file.</p>\n<p>There is a solution to this, which is <a href=\"https://github.com/leanprover-community/mathlib4/pull/20987\">#20987</a>, but it stalled in limbo -- and then <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> stopped updating it, so there is a merge conflict and it is not even in the queue any more. But I still think this is very helpful, and I'd be extremely happy if we could get this in -- except that it's meta code, so I'm not qualified to review it, unfortunately. If this lands in the near future, I'm willing to add suitable deprecations for all the files that have been split recently, which should be extremely helpful to downstream projects.</p>",
        "id": 511730700,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1744404239
    },
    {
        "content": "<p>Oh, I hadn't noticed that the PR was awaiting author!  I'm not entirely sure what needs doing, though.  I'll take a look again.</p>",
        "id": 511731883,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744404829
    },
    {
        "content": "<p>It won't help in scenarios like \"we moved some lemmas out of <code>Basic.lean</code> to a new file\".</p>",
        "id": 511732009,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744404893
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60Deprecated.60.20folder/near/511732009\">said</a>:</p>\n<blockquote>\n<p>It won't help in scenarios like \"we moved some lemmas out of <code>Basic.lean</code> to a new file\".</p>\n</blockquote>\n<p>I think that there is a \"search for a possible declaration in the current project, but not in the current environment\", for this.</p>",
        "id": 511733083,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744405296
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/116290-rss/topic/Recent.20Commits.20to.20lean4.3Amaster/near/509653979\">#rss &gt; Recent Commits to lean4:master @ üí¨</a>  is the PR with the \"search for an identifier that is not in the environment\".</p>",
        "id": 511734535,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744405634
    },
    {
        "content": "<p>The merge conflict in <a href=\"https://github.com/leanprover-community/mathlib4/pull/20987\">#20987</a> was just <code>Mathlib.lean</code> and <code>Tactic.lean</code> being out of sync.</p>",
        "id": 511734685,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744405669
    },
    {
        "content": "<p>The PR is again ready for review!</p>",
        "id": 511737874,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744406779
    },
    {
        "content": "<p>Re: Carleson, I presume you are aware of <a href=\"https://github.com/fpvandoorn/carleson/pull/287\">https://github.com/fpvandoorn/carleson/pull/287</a>? (Help getting that over the line is certainly welcome, as well as bumping further.)</p>",
        "id": 511738147,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744406945
    },
    {
        "content": "<p>I also experienced this in FLT recently; after a bump a random proof broke because an action no longer seemed to exist and when I asked for help it turned out that it was no longer imported</p>",
        "id": 511785762,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744442038
    },
    {
        "content": "<p>I saw that <code>Mathlib.lean</code> was out of date in my \"fix\", but now locally it says it is ok and in the PR that it needs updating...</p>",
        "id": 511787273,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744443410
    },
    {
        "content": "<p>Sorry, my bad: I modified locally the <code>Mathlib.lean</code> file, but did not commit it.  <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 511787358,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744443486
    },
    {
        "content": "<p>The PR is maintainer-merged now.</p>",
        "id": 511794441,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744450151
    },
    {
        "content": "<p>How difficult is it to have CI access a PR's diff? If we have the module deprecation mechanism, I'd like to ensure it gets used --- by mandating that module removals become deprecations instead.</p>",
        "id": 511804145,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744458125
    },
    {
        "content": "<p>It should be pretty easy to have a bot act on PRs that remove a file.  For instance, it could add a <code>file-removed</code> label and the humans take it from there.</p>",
        "id": 511808815,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744461985
    },
    {
        "content": "<p>In fact, if you wanted, you could extend the script that updates the PR summary, around where it manages the <code>merge-conflict</code> label, to also add a <code>file-removed</code> label.  Probably, the relevant git command is</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git<span class=\"w\"> </span>diff<span class=\"w\"> </span>--name-only<span class=\"w\"> </span>--diff-filter<span class=\"w\"> </span>D<span class=\"w\"> </span>origin/master...HEAD\n</code></pre></div>\n<p>that should return the removed files of the PR with respect to master.</p>",
        "id": 511812394,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744465176
    },
    {
        "content": "<p>Thanks, that git incantation is very helpful!</p>",
        "id": 511842923,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744490345
    },
    {
        "content": "<p>What do you think about updating the summary comment instead --- to comment if a module removal is not deprecated properly? (Basically, if a file is removed and that module does not contain a <code>deprecated_module</code> command, add a sentence to the summary: \"This PR removes a Lean module. Please keep a deprecation warning using <code>deprecated_module</code> command instead, by putting the line <code>deprecated_module since 2025-04-12</code> in the file. This notifies downstream users of the deprecation.)</p>",
        "id": 511842931,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744490351
    },
    {
        "content": "<p>That also looks ok, I just thought that a label would be more visible.</p>",
        "id": 511843044,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744490444
    },
    {
        "content": "<p>Btw, when you say \"if a file is removed and that module does not contain a <code>deprecated_module</code> command\", specifically in \"and that module...\": do you refer to the case of removing an \"old\" deprecated module?</p>",
        "id": 511843182,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744490558
    },
    {
        "content": "<p>... which presumably will not happen in the next N months, until a deprecation is old enough.</p>",
        "id": 511843200,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744490584
    },
    {
        "content": "<p>We can certainly have both a comment and a label! I care about the label being \"little noise\", i.e. only present when it indicates an issue.</p>",
        "id": 511843225,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744490610
    },
    {
        "content": "<p>Ok, that is ok, but since this will be looked at by a human, getting a flag might always be good (or at least, for a while to test the workflow, before we let automation take over).</p>",
        "id": 511843227,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744490612
    },
    {
        "content": "<p>Well, the script that adds the label can also remove it.</p>",
        "id": 511843254,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744490643
    },
    {
        "content": "<p>(And I think that it <em>should</em> remove it, so that the label should be entirely automated.)</p>",
        "id": 511843304,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744490676
    },
    {
        "content": "<p>Then, reviewers may decide to ignore the label, but ideally no one should modify it manually.</p>",
        "id": 511843339,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744490706
    },
    {
        "content": "<p>This is probably too strict, but we could potentially just fail CI for anything that  deletes a file in Mathlib/ that didn't already contain the string <code>deprecated_module</code>!</p>",
        "id": 511851139,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744498309
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60Deprecated.60.20folder/near/511812394\">said</a>:</p>\n<blockquote>\n<p>Probably, the relevant git command is</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git<span class=\"w\"> </span>diff<span class=\"w\"> </span>--name-only<span class=\"w\"> </span>--diff-filter<span class=\"w\"> </span>D<span class=\"w\"> </span>origin/master...HEAD\n</code></pre></div>\n<p>that should return the removed files of the PR with respect to master.</p>\n</blockquote>\n<p>Perhaps worth noting that this does not always align with what the github diff shows; github is caching a particular copy of origin/master, and does not always choose to recompute the diff unless forced to, for instance via the target branch being toggled.</p>",
        "id": 511851356,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744498519
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60Deprecated.60.20folder/near/511851139\">said</a>:</p>\n<blockquote>\n<p>This is probably too strict, but we could potentially just fail CI for anything that  deletes a file in Mathlib/ that didn't already contain the string <code>deprecated_module</code>!</p>\n</blockquote>\n<p>Maybe we can wait to see how the deprecation system works, before making CI depend on it!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 511879909,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744525306
    },
    {
        "content": "<p>Eric, I did not know about caching in github!  There is also another \"bug\" with the command above: it does not catch <em>renames</em>.  This should be better</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git<span class=\"w\"> </span>diff<span class=\"w\"> </span>--name-only<span class=\"w\"> </span>--diff-filter<span class=\"w\"> </span>DR<span class=\"w\"> </span>origin/master...HEAD\n</code></pre></div>",
        "id": 511879974,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744525361
    },
    {
        "content": "<p>Also, Kim delegated the PR and suggested several improvements.  I implemented them all and tested them, but if someone else wants to take a look, I'll wait a few hours before merging.</p>",
        "id": 511880072,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744525457
    },
    {
        "content": "<p>The PR now fails on CI, with an error <code>unable to locate share/zoneinfo in the local timezone database at '/etc/localtime'</code>.  <a href=\"https://stackoverflow.com/questions/3896587/are-linuxs-timezone-files-always-in-usr-share-zoneinfo\">My impression is</a> that something about the CI runners' configuration should be tweaked.</p>",
        "id": 511883386,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744528984
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23991\">#23991</a> starts on making the script post a comment if there are removed files. My code works locally, but fails in CI (for reasons probably related to \"checking out the right revision\" - probably something basic). I'm stepping away for a moment; fixes welcome.</p>",
        "id": 511891432,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744536313
    },
    {
        "content": "<p>File deprecation is now in mathlib!</p>",
        "id": 511933884,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744571343
    },
    {
        "content": "<p>If you use it and notice something strange or some bugs, please report it and I'll try to fix it!</p>",
        "id": 511933892,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744571348
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23991\">#23991</a> is now ready for a first round of review: the \"update summary comment\" part works well in CI now. The \"add or remove the <code>file-removed</code> label\" part fails on this PR. (This could be expected, though; I'm not sure. Help welcome.)</p>",
        "id": 511944490,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744579947
    },
    {
        "content": "<p>I've used it in <a href=\"https://github.com/leanprover-community/mathlib4/pull/20979\">#20979</a>. Seems to work fine!</p>",
        "id": 511986133,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1744608656
    },
    {
        "content": "<p>It is probably a good idea to automatically disable the header linter for deprecated files.</p>",
        "id": 511986519,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744608834
    },
    {
        "content": "<p>Maybe also the directoryDependency, I am not sure.</p>",
        "id": 511986586,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744608852
    },
    {
        "content": "<p>I'm not sure about the latter either: to me <a href=\"https://github.com/leanprover-community/mathlib4/pull/20979\">#20979</a> is a bit of an exception, in that it deprecates a file with content; I wouldn't mind it getting special treatment.<br>\nI expect the common case to be \"moving a file within a directory\" (or splitting a file), and that shouldn't need adjustments to the directoryDependency linter.</p>",
        "id": 511997544,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744613708
    },
    {
        "content": "<p>I see a major disadvantage of this new file deprecation system: git sees a file being deleted and a file being added where previously it would be renamed with few to no changes</p>",
        "id": 511997793,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1744613815
    },
    {
        "content": "<p>The old file is not deleted, just modified to contain the deprecation (and removal of content).</p>",
        "id": 511997882,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744613857
    },
    {
        "content": "<p>I suggest we add the deprecations in a separate PR to the one renaming the file. Then the diff stays manageable</p>",
        "id": 511997887,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1744613859
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60Deprecated.60.20folder/near/511997882\">said</a>:</p>\n<blockquote>\n<p>The old file is not deleted, just modified to contain the deprecation (and removal of content).</p>\n</blockquote>\n<p>Yes! That's the issue</p>",
        "id": 511997907,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1744613872
    },
    {
        "content": "<p>Ah, you are talking about the git diff!</p>\n<p>Anyway, if the file is split, then the diff is still hard to parse.</p>",
        "id": 511998019,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744613909
    },
    {
        "content": "<p>Good point! Having two separate PRs, merged back to back, is fine with me.</p>",
        "id": 511998459,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744614085
    },
    {
        "content": "<p>How about a draft PR without the deprecation and then a \"real\" PR that performs the deprecation on top of the draft?  The draft gets the comments, but the one that gets merged is the other?</p>",
        "id": 511998773,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744614186
    },
    {
        "content": "<p>No, I don't think that's great, because git archaeologists wanting to understand what happened would still see a huge commit with a mangled diff</p>",
        "id": 512000295,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1744614717
    },
    {
        "content": "<p>Another round at <a href=\"https://github.com/leanprover-community/mathlib4/pull/24024\">#24024</a>. This should make it much more comfortable to update projects involving measure theory, notably PFR.</p>",
        "id": 512012289,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1744618379
    },
    {
        "content": "<p>FWIW updating PFR has been fine to me so far <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 512013332,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1744618659
    },
    {
        "content": "<p>It's just that a lot of files have been split/moved very recently (notably all the files about the Bochner and Lebesgue integrals). This should break a lot of imports in PFR. This is not hard to fix, but it takes some time, and it should take less time with the new deprecated modules.</p>",
        "id": 512018657,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1744620010
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60Deprecated.60.20folder/near/511997887\">said</a>:</p>\n<blockquote>\n<p>I suggest we add the deprecations in a separate PR to the one renaming the file. Then the diff stays manageable</p>\n</blockquote>\n<p>Sounds good. And then ideally we make sure that the two parts of such a pair don't fall on both sides of a release . So we should not deprecate files right at the end of a month.</p>\n<p>Also, we should just have bots merge (and even create) the PRs that add <code>deprecated_module</code>.</p>",
        "id": 512024626,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744621298
    },
    {
        "content": "<p>Yes, an automated deprecation PR would be great! although possibly a bit ambitious</p>",
        "id": 512024922,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1744621375
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24027\">#24027</a> sets the header linter option to false when parsing the command <code>deprecated_module</code>.</p>",
        "id": 512027944,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744622247
    },
    {
        "content": "<p>Wow, was that the fastest review in mathlib history? (Perhaps I'll crunch the queueboard data later to check...)</p>",
        "id": 512029208,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744622624
    },
    {
        "content": "<p>I think that creating the deprecation PR should be doable, although I would rather it be merged by humans, at least for a while to test that the system works.</p>",
        "id": 512029679,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744622766
    },
    {
        "content": "<p>I am not sure that I can devote much time to trying out auto-module-deprecations in the next few days, but if someone else wants to try it, please do!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 512030264,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744622941
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24028\">#24028</a> will remove the <code>set_option linter.header false</code> that <a href=\"https://github.com/leanprover-community/mathlib4/pull/24024\">#24024</a> had to add.</p>",
        "id": 512030592,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744623025
    },
    {
        "content": "<p>S√©bastien, a module deprecation PR has been merged: if you end up \"bumping across the deprecations\", can you report on how it went, please?  <span aria-label=\"thank you\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"thank you\">:thank_you:</span></p>",
        "id": 512030619,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744623033
    },
    {
        "content": "<p>I just did so for Carleson: it went nicely. Building the project gave a warning (but built fine!), the warning told me the imports to replace with, and everything worked :-)</p>",
        "id": 512351322,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744730754
    }
]