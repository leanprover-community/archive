[
    {
        "content": "<p>There is an implementation of <code>dual</code> for <code>PointedCone</code> based on a pairing <code>p</code> like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">PointedCone</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PointedCone</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"n\">x</span><span class=\"o\">⦄,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>I implemented an analogous duality for submodules like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"n\">x</span><span class=\"o\">⦄,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>I then needed to reprove most lemmas from cone duality (about 20, but numbers rising). Both definitions could be unified as follows</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">→ₗ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Dual</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"n\">x</span><span class=\"o\">⦄,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>and I checked that all basic lemmas can still be proven in this context.<br>\nThe previous definitions one obtains as follows</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Dual</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⊥</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">PointedCone</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Dual</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">PointedCone</span><span class=\"bp\">.</span><span class=\"n\">positive</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>\n<p>I am not certain how one would structure this in mathlib to make this maximally easy to use and extend. Ideally one has the following features:</p>\n<ul>\n<li>The general <code>Dual.dual</code> is not used directly when working within the submodule or cone context. Ideally it is hidden in some namespace (as I have done here), or uses some other name like <code>dual'</code>.</li>\n<li>The general duality lemmas are implemented using the<code>Dual.dual</code>. They are not hidden but are intended to be used directly from the specialized contexts.</li>\n<li>For <code>Submodule</code> and <code>PointedCone</code> only the abbrevs shown above need to be implemented, but all the lemmas need not to be reproven. The general duality lemmas should be usable without friction.</li>\n<li>The statements of the general duality lemmas are still easily readable and are not obfuscated by the name or namespace we end up using for the general <code>Dual.dual</code>.</li>\n</ul>\n<p>What's the best way to achieve all of this?</p>",
        "id": 566775553,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767803952
    },
    {
        "content": "<p>For example, I ran into the following problem:</p>\n<p>Suppose that the goal contains <code>Submodule.dual p (span R s)</code>. Then <code>rw [dual_span]</code> should be able to rewrite this part of the goal. And it does so if I use an implementation of <code>dual_span</code> written in terms of <code>Submodule.dual</code>. But if I define</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Dual</span><span class=\"bp\">.</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⊥</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>\n<p>and use a <code>dual_span</code> written in terms of <code>Dual.dual</code>, then <code>rw [dual_span]</code> cannot find the expression in the goal, even though <code>Submodule.dual</code> is an abbrev of <code>Dual.dual</code>.</p>\n<p>Is there anything one can do about it? Or does this indicate that unifying the two duality concepts wont work?</p>",
        "id": 566831431,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767823401
    },
    {
        "content": "<p>I personally avoid <code>abbrev</code> in Mathlib. It is not transparent enough for most purposes. For instance, <code>Ideal R</code> is an abbrev for <code>Submodule R R</code>, but most of the <code>Submodule</code> API is duplicated for <code>Ideal</code> anyway.</p>\n<p>Also, do you want <code>PointedCone.dual</code> to have type <code>PointedCone</code>, or <code>Submodule</code>?</p>",
        "id": 566834049,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1767824662
    },
    {
        "content": "<blockquote>\n<p>Also, do you want <code>PointedCone.dual</code> to have type <code>PointedCone</code>, or <code>Submodule</code>?</p>\n</blockquote>\n<p><code>PointedCone</code>, which is defined as a <code>Submodule</code> over the non-negative scalars. And the definition of <code>Dual.dual</code> that I propose would produce this sort of submodule. I was hoping this is enough to make the automation work. You seem skeptical?</p>",
        "id": 566834638,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767824929
    },
    {
        "content": "<blockquote>\n<p>For instance, <code>Ideal R</code> is an abbrev for <code>Submodule R R</code>, but most of the <code>Submodule</code> API is duplicated for <code>Ideal</code> anyway.</p>\n</blockquote>\n<p>Do you say it is duplicated because abbrev is not transparent enough to make the autmation work. Or is it a naming reason, e.g. people don't want to call <code>Submodule.something</code> when they work with ideals?</p>",
        "id": 566834920,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767825084
    },
    {
        "content": "<p>The usual pattern for avoiding duplication is to use a typeclass. Something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">DualMapClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">dual</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">kernel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">mem_iff</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"n\">iff</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>Or you can make <code>kernel</code> a parameter if you like, to avoid defeq issues.</p>\n<p>Then write your lemmas for maps <code>dual</code> satisfying this class, and then register your concrete duals as instances.</p>",
        "id": 566835024,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1767825127
    },
    {
        "content": "<p>In this case it feels overkill but maybe it's the right choice!</p>",
        "id": 566835049,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1767825145
    },
    {
        "content": "<p>Interesting. I will consider this.</p>",
        "id": 566835207,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767825220
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"950805\">Martin Winter</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Unifying.20duality.20for.20submodules.20and.20cones/near/566834920\">said</a>:</p>\n<blockquote>\n<p>Do you say it is duplicated because abbrev is not transparent enough to make the autmation work. Or is it a naming reason, e.g. people don't want to call <code>Submodule.something</code> when they work with ideals?</p>\n</blockquote>\n<p>Former. It's not just about syntactic equality either - I've found the transparency quite brittle.</p>",
        "id": 566835264,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1767825255
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"950805\">Martin Winter</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Unifying.20duality.20for.20submodules.20and.20cones/near/566834638\">said</a>:</p>\n<blockquote>\n<p><code>PointedCone</code>, which is defined as a <code>Submodule</code> over the non-negative scalars.</p>\n</blockquote>\n<p>Oh yeah I forgot about the definition. But yeah it's the abbrev issue again - not syntactically equal.</p>",
        "id": 566835351,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1767825298
    },
    {
        "content": "<blockquote>\n<p>In this case it feels overkill but maybe it's the right choice!</p>\n</blockquote>\n<p>Maybe. But I wonder: what is mathlib's stance on duplication of code like this? Don't worry too much unless you write it like 5 times?</p>",
        "id": 566835825,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767825490
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"950805\">Martin Winter</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Unifying.20duality.20for.20submodules.20and.20cones/near/566835825\">said</a>:</p>\n<blockquote>\n<p>what is mathlib's stance on duplication of code like this?</p>\n</blockquote>\n<p>I'm not a maintainer or anything like that but I'd note that the basic API for substructures - hundreds of lines of code - is duplicated maybe 10-20 times across Mathlib. (This is obviously bad and I have a proposal to fix it but big refactors take time and effort.)</p>\n<p>Your level of duplication is both common and tiny compared to the amount of existing tech debt. See also <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>'s comments on my positive cone proposal.</p>",
        "id": 566836479,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1767825866
    },
    {
        "content": "<p>Good to know. Thanks!</p>",
        "id": 566836945,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767826130
    },
    {
        "content": "<p>Yes, I find it intellectually satisfying that duality holds in this more general setting, but I doubt the small benefit of saving a few (10s of?) lines is worth the syntactic trouble</p>",
        "id": 566867767,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1767848889
    },
    {
        "content": "<p>It's certainly more than \"10s of lines\" but I think you are right.</p>",
        "id": 566898929,
        "sender_full_name": "Martin Winter",
        "timestamp": 1767864196
    }
]