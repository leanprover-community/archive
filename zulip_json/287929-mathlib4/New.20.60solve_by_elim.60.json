[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Scott Morrison</span> I was experimenting with the refactored <code>solve_by_elim</code>, particularly with the new functionality to throw in <code>symm</code>s of hypotheses.  I expected the following to work; can you tell me if I am doing something wrong?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Data.Int.ModEq</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"o\">:</span> <span class=\"n\">ℤ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">ha</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">≡</span> <span class=\"mi\">2</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">])</span> <span class=\"o\">:</span> <span class=\"mi\">2</span> <span class=\"bp\">≡</span> <span class=\"n\">a</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">apply_rules</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">ha</span><span class=\"o\">]</span> <span class=\"c1\">-- doesn't resolve the goal</span>\n</code></pre></div>\n<p>The goal state after this is</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>a : ℤ\nha : a ≡ 2 [ZMOD 4]\nha_symm : 2 ≡ a [ZMOD 4]\n⊢ 2 ≡ a [ZMOD 4]\n</code></pre></div>\n<p>so at least it correctly formed the <code>symm</code> of <code>ha</code>.</p>",
        "id": 320288690,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1673286882
    },
    {
        "content": "<p>I'm also curious why this one doesn't work: </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Data.Int.ModEq</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">ℤ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">ha</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">≡</span> <span class=\"mi\">2</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">])</span> <span class=\"o\">:</span>\n    <span class=\"n\">a</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"n\">a</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">≡</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"mi\">2</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">apply_rules</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">ha</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.add</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.mul</span><span class=\"o\">,</span>\n    <span class=\"n\">Int.ModEq.pow</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.rfl</span><span class=\"o\">]</span> <span class=\"c1\">-- doesn't resolve the goal</span>\n</code></pre></div>\n<p>After it runs there is one goal left which ought to be doable by <code>Int.ModEq.rfl</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>a b : ℤ\nha : a ≡ 2 [ZMOD 4]\nha_symm : 2 ≡ a [ZMOD 4]\n⊢ b ≡ b [ZMOD 4]\n</code></pre></div>\n<p>and it's strange because presumably it already resolved another <code>b ≡ b [ZMOD 4]</code> goal.</p>",
        "id": 320290164,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1673287282
    },
    {
        "content": "<p>The first one is presumably a bug/feature that <code>only</code> doesn't pick up the <code>symm</code> version of that named lemma. I'll have to think about how to allow that.</p>",
        "id": 320326015,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673296512
    },
    {
        "content": "<p>If it would be easier, we could have the syntax <code>apply_rules only [←ha]</code></p>",
        "id": 320327187,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1673296978
    },
    {
        "content": "<p><code>apply_rules only [←ha]</code> seems a bit superfluous given <code>apply_rules only [ha.symm]</code> works.</p>",
        "id": 321532956,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673818008
    },
    {
        "content": "<p>I can change the behaviour of <code>only</code> so it automatically includes all the symmetric versions, but then I worry someone will want <code>only only</code>.</p>",
        "id": 321532999,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673818040
    },
    {
        "content": "<p>Regarding the second example,</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">ℤ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">ha</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">≡</span> <span class=\"mi\">2</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">])</span> <span class=\"o\">:</span>\n    <span class=\"n\">a</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"n\">a</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">≡</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"mi\">2</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">apply_rules</span> <span class=\"o\">(</span><span class=\"n\">config</span> <span class=\"o\">:=</span> <span class=\"o\">{</span><span class=\"n\">maxDepth</span> <span class=\"o\">:=</span> <span class=\"mi\">13</span><span class=\"o\">})</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">ha</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.add</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.mul</span><span class=\"o\">,</span>\n    <span class=\"n\">Int.ModEq.pow</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.rfl</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>suffices.</p>",
        "id": 321533561,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673818454
    },
    {
        "content": "<p>We should probably increase the default maxDepth for <code>apply_rules</code>.</p>",
        "id": 321533575,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673818465
    },
    {
        "content": "<p>Reordering the lemmas as</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">ℤ</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">ha</span> <span class=\"o\">:</span> <span class=\"n\">a</span> <span class=\"bp\">≡</span> <span class=\"mi\">2</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">])</span> <span class=\"o\">:</span>\n    <span class=\"n\">a</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"n\">a</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">≡</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">+</span> <span class=\"mi\">2</span> <span class=\"bp\">^</span> <span class=\"mi\">2</span> <span class=\"bp\">*</span> <span class=\"n\">b</span> <span class=\"o\">[</span><span class=\"n\">ZMOD</span> <span class=\"mi\">4</span><span class=\"o\">]</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">apply_rules</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">ha</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.rfl</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.add</span><span class=\"o\">,</span> <span class=\"n\">Int.ModEq.mul</span><span class=\"o\">,</span>\n    <span class=\"n\">Int.ModEq.pow</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>also works.</p>",
        "id": 321533605,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673818492
    },
    {
        "content": "<p>i.e. so it tries <code>rfl</code> on things before decomposing products and powers that match to begin with. I'm not sure if there is a sensible way to make these tactics try to find better orderings themselves. That's probably out of scope for now.</p>",
        "id": 321533650,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673818548
    },
    {
        "content": "<p>Is there a reason to have a maxDepth for <code>apply_rules</code> at all?  It seems like with a sensible rule set (no <code>symm</code>s) there's no way it would loop.</p>",
        "id": 321534781,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1673819423
    },
    {
        "content": "<p>Actually, given that we already have the <code>config := { symm := false }</code> option, maybe <code>apply_rules only [ha]</code> could reasonably use <code>ha.symm</code> as well, and you have to write <code>apply_rules (config := {symm := false}) only [ha]</code> for the <code>only only</code> behaviour!</p>",
        "id": 321539018,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673823172
    },
    {
        "content": "<p>It would be nice if we could have different defaults: default to <code>symm := true</code> normally, but default to <code>symm := false</code> when called with <code>only</code>. Then users could call <code>apply_rules (config := { symm := true }) only [ha]</code> if they wanted the \"weird\" behaviour of <code>only</code> + <code>symm</code>.</p>",
        "id": 321539119,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673823259
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/New.20.60solve_by_elim.60/near/321534781\">said</a>:</p>\n<blockquote>\n<p>Is there a reason to have a maxDepth for <code>apply_rules</code> at all?  It seems like with a sensible rule set (no <code>symm</code>s) there's no way it would loop.</p>\n</blockquote>\n<p>Well, at some point we need a maxDepth, if only for implementation reasons. <a href=\"https://github.com/leanprover-community/mathlib/pull/1580\">mathlib#1580</a> changes the default to 50. <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span>, feel free to merge as is or change the default to anything else that suits you.</p>",
        "id": 321540107,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1673824261
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/1580\">mathlib4#1580</a></p>",
        "id": 321541889,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1673826233
    },
    {
        "content": "<p>From the <a href=\"https://github.com/leanprover-community/mathlib4/blob/3fd37757e9ae496854956fb2d0aec463d7e7d5a5/Mathlib/Tactic/SolveByElim.lean#L414\"><code>solve_by_elim</code> source</a>:</p>\n<blockquote>\n<p>(In mathlib3 we could also pass attributes, and all declarations with that attribute were included.  This has not been implemented here.)</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110087\">@Scott Morrison</span> Would it be difficult to implement that functionality?  It was very convenient in mathlib3.</p>\n<p>To <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> a bit, a typical use case for me would be to implement a tactic</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">mod_rw</span> <span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">,</span> <span class=\"n\">h2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which is a wrapper for</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">apply_rules</span> <span class=\"n\">only</span> <span class=\"o\">[</span><span class=\"n\">h1</span><span class=\"o\">,</span> <span class=\"n\">h2</span><span class=\"o\">]</span> <span class=\"n\">using</span> <span class=\"n\">mod_rules</span>\n</code></pre></div>\n<p>where <code>mod_rules</code> is an attribute which I have tagged <code>Int.ModEq.add</code>, <code>Int.ModEq.mul</code>, <code>Int.ModEq.pow</code> ... with.  I'm not sure how to do this without the attribute functionality.</p>",
        "id": 321542953,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1673827374
    }
]