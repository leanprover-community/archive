[
    {
        "content": "<p>Now that Mathlib is on v4.28.0-rc1 and the new shake is available as <code>lake shake</code>, it's time to update Mathlib CI so it runs <code>lake shake</code> again. I think the current preferred settings are <code>lake shake --add-public --keep-implied --keep-prefix</code> and <code>--fix</code> is you want it to apply the changes.</p>\n<p>Currently this suggests quite a few changes, so we'll have to make another PR before enabling this in CI.</p>",
        "id": 570470527,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769577115
    },
    {
        "content": "<p>Does anyone know the current state of automatically adding commits to a PR? I would love to not have to run <code>shake</code> myself, and to have CI run it, try rebuilding, and if that worked just apply the changes automatically.</p>",
        "id": 570470576,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769577154
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/34511\">#34511</a></p>",
        "id": 570470658,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769577243
    },
    {
        "content": "<p>(<span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>, I used the <code>x &lt;command line&gt;</code> format for the commit message. Is your machinery ready to handle this?)</p>",
        "id": 570470792,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769577337
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>, something I don't see how to do currently is to only run <code>shake</code> on a single file. I'd like to be able to do this, so it minimizes the imports of just that one file (plus adding imports as required downstream, of course).</p>\n<p>I think this would be quite useful when looking at the rebuild critical path e.g. <a href=\"https://speed.lean-lang.org/mathlib4-out/be6dc76a4049aab3ce7ae14bfd2a19720c8f43d2/\">https://speed.lean-lang.org/mathlib4-out/be6dc76a4049aab3ce7ae14bfd2a19720c8f43d2/</a></p>",
        "id": 570471008,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769577492
    },
    {
        "content": "<p>(I only just learnt how to find the rebuild critical path today: </p>\n<ul>\n<li>go to <a href=\"https://radar.lean-lang.org\">https://radar.lean-lang.org</a></li>\n<li>select \"mathlib4\" in the top right (or jump direct to <a href=\"https://radar.lean-lang.org/repos/mathlib4\">https://radar.lean-lang.org/repos/mathlib4</a>)</li>\n<li>select a recent commit (most recent at the top)</li>\n<li>click \"<a href=\"https://speed.lean-lang.org/mathlib4-out/be6dc76a4049aab3ce7ae14bfd2a19720c8f43d2\">Lakeprof report</a>\"</li>\n</ul>",
        "id": 570471101,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769577562
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/The.20long.20pole.20in.20mathlib/near/570475069\">#mathlib4 &gt; The long pole in mathlib @ üí¨</a></p>",
        "id": 570475152,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1769580177
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/shake/near/570471008\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span>, something I don't see how to do currently is to only run <code>shake</code> on a single file. I'd like to be able to do this, so it minimizes the imports of just that one file (plus adding imports as required downstream, of course).</p>\n</blockquote>\n<p>Can you say more, is it that you want to run this specific file under different flags than the rest?</p>",
        "id": 570505963,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769592036
    },
    {
        "content": "<p>I don't want any suggestions for anything upstream of it, but I want to convert <code>public import</code> to <code>import</code> just in that file.</p>",
        "id": 570525144,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769597628
    },
    {
        "content": "<p>Making sure that the base commit has already been shaken is likely the easiest option to avoid unrelated changes, no? Then I think you can just do import changes yourself in the file (which gives you more control on e.g. removing only a subset of <code>public import</code>s) and rerun shake afterwards. As it will use the oleans from the working base commit, it should understand that it needs to add imports to unbreak downstream files, even if the package is not actually buildable before doing so. I'll see if I can test this on Ya√´l's example</p>",
        "id": 570545692,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769604028
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/shake/near/570470576\">said</a>:</p>\n<blockquote>\n<p>Does anyone know the current state of automatically adding commits to a PR? I would love to not have to run <code>shake</code> myself, and to have CI run it, try rebuilding, and if that worked just apply the changes automatically.</p>\n</blockquote>\n<p>Mathlib uses <a href=\"https://pre-commit.com/\">pre-commit</a> whose config is in <a href=\"https://github.com/leanprover-community/mathlib4/blob/a1be981a4dfcae109bb63fb633eafd5a2edf34c4/.pre-commit-config.yaml\"><code>.pre-commit-config.yaml</code></a>.<br>\nCurrently it only removes trailing whitespace and then commits automatically, e.g. <a href=\"https://github.com/leanprover-community/mathlib4/pull/34353/commits/1ace2582137d23f7261db749327086b554c67aeb\">this commit</a> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/34353\">#34353</a>.</p>\n<p>It seems pretty easy to add <a href=\"https://pre-commit.com/#repository-local-hooks\">hooks from the current repo</a>, just need to add an entry in the config that says to run <code>lake shake --fix ...</code>.</p>\n<p>(I'm not sure if there are some other ways Mathlib commits automatically. It can be done without pre-commit of course, but it's a nice existing framework that is externally maintained)</p>",
        "id": 570561969,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1769608137
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/shake/near/570545692\">said</a>:</p>\n<blockquote>\n<p>I'll see if I can test this on Ya√´l's example</p>\n</blockquote>\n<p>Hmm that was a bit anticlimactic as it turned out there was nothing to fix downstream. But at least Shake seemed to be fine with this workflow. I've put both steps in <a href=\"https://github.com/leanprover-community/mathlib4/pull/34523\">#34523</a> though they could also be separated.</p>",
        "id": 570563349,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769608477
    },
    {
        "content": "<p>I would be happy to review PRs adding such functionality to our pre-commit setup! Some other commands that might be worth running automatically are <code>lake exe lint-style --fix</code> and <code>./scripts/lint-bib.sh &amp;&amp; rm docs/references.bib.old</code> (from the <a href=\"https://github.com/leanprover-community/lint-style-action/blob/a7e7428fa44f9635d6eb8e01919d16fd498d387a/action.yml\">old <code>bot fix style</code> command</a> which sadly doesn't seem to work at the moment.)</p>",
        "id": 570563713,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1769608552
    },
    {
        "content": "<p>and <code>lake exe mk_all</code>? (probably requires disabling the existing <code>lake exe mk_all --check</code> that fails the build, unless it comes after pre-commit)</p>",
        "id": 570564700,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1769608788
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/shake/near/570545692\">said</a>:</p>\n<blockquote>\n<p>Making sure that the base commit has already been shaken is likely the easiest option to avoid unrelated changes, no? Then I think you can just do import changes yourself in the file (which gives you more control on e.g. removing only a subset of <code>public import</code>s) and rerun shake afterwards. As it will use the oleans from the working base commit, it should understand that it needs to add imports to unbreak downstream files, even if the package is not actually buildable before doing so. I'll see if I can test this on Ya√´l's example</p>\n</blockquote>\n<p>I think we're still talking past each other here.</p>\n<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>, your commit <a href=\"https://github.com/leanprover-community/mathlib4/pull/34523/commits/efcc944fcb422f46c75540d0eeac8ffff134d809\">https://github.com/leanprover-community/mathlib4/pull/34523/commits/efcc944fcb422f46c75540d0eeac8ffff134d809</a> then broke the build, because we need to add <code>public import</code> below.</p>\n<p>I want to be able to run <code>lake shake &lt;...options...&gt; --only Mathlib/Analysis/Normed/Lp/SmoothApprox.lean</code>, which will have the effect of working out which <code>public import</code>s in <code>SmoothApprox</code> can be converted into <code>import</code>s, <em>and</em> make all necessary adjustments downstream.</p>\n<p>Currently I don't think <code>shake</code> can do this, and if we want to reduce <code>public import</code> to <code>import</code> where possible in a <em>single</em> file, it has to be done by hand.</p>",
        "id": 570674692,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769640613
    },
    {
        "content": "<p>Yes, I had some issues with Lake and thought it built. I see now that I would have to make some changes to shake to support my approach as well. I'm happy to support something like <code>--only</code> but can you think of similar use cases we may want to support with a more general interface? E.g. for core we might want to shake anything but Init with <code>--keep-public</code>, which cannot be split into two separate runs</p>",
        "id": 570759276,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769683150
    },
    {
        "content": "<p>A third interesting idea triggered by a comment by <span class=\"user-mention\" data-user-id=\"221653\">@Paul Reichert</span>: if we want to e.g. minimize Lp.SmoothApprox more thoroughly, we likely want it be kept minimized that way in the future as well, no? That would suggest an in-source annotation like <code>-- shake: no-add-public</code>, which would not require any new cmdline interface</p>",
        "id": 570780088,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769689426
    },
    {
        "content": "<p>I've encountered a weird situation on the shake PR. <a href=\"https://github.com/leanprover-community/mathlib4/pull/34511\">#34511</a></p>\n<p>At commit c997929cf0568c908e2de8476739b89ce8240ae9 (the current head of that PR branch), <code>lake build Mathlib.Control.Traversable.Equiv</code> produces an error, but opening the file in VSCode it looks fine.</p>\n<p>Would someone be able to try reproducing this for me? It is potentially a module system bug.</p>",
        "id": 572257022,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770329177
    },
    {
        "content": "<p>I can confirm that I get <code>error: Mathlib/Control/Traversable/Equiv.lean:138:29: Unknown identifier `functor_norm` </code> on command line and it builds fine in VS Code.</p>",
        "id": 572258210,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1770329716
    },
    {
        "content": "<p>Hovering over <code>functor_norm</code> in VS Code I get the surprising message</p>\n<blockquote>\n<p>A simp lemma specification is:</p>\n<ul>\n<li>optional¬†<code>‚Üë</code>¬†or¬†<code>‚Üì</code>¬†to specify use before or after entering the subterm</li>\n<li>optional¬†<code>‚Üê</code>¬†to use the lemma backward</li>\n<li><code>thm</code>¬†for the theorem to rewrite with</li>\n</ul>\n</blockquote>",
        "id": 572258391,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1770329801
    },
    {
        "content": "<p>Okay, can I bump this one up to some combination of <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>, <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>  and <span class=\"user-mention\" data-user-id=\"221921\">@Marc Huisinga</span>? Divergences between <code>lake build</code> and VS Code triggered by running <code>shake</code> seems tricky.</p>",
        "id": 572264133,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770332272
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Within the module system, the server loads more data about its imports than <code>lake build</code> does. Namely, it loads server metadata from <code>olean.server</code> and compiled code from <code>.ir</code> (e.g., for <code>#eval</code> to work). If elaboration relies on this additional data, a build can fail where the interactive session does not. For instance, <code>shake</code> may have removed a <code>meta import</code> in the transitive import graph that some Mathlib meta code (e.g., for prodoucing <code>functor_norm</code>) needed but Shake thought was unnecessary.</p>",
        "id": 572265879,
        "sender_full_name": "Mac Malone",
        "timestamp": 1770333113
    },
    {
        "content": "<p>Sadly, I am not sufficiently familiar with the breadth of Mathlib meta code to likely be able to debug this.</p>",
        "id": 572266113,
        "sender_full_name": "Mac Malone",
        "timestamp": 1770333269
    },
    {
        "content": "<p>FWIW adding <code>import Mathlib.Tactic.Attr.Register</code> (the file where <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Parser.Attr.functor_norm#doc\">docs#Parser.Attr.functor_norm</a> is defined) (or adding <code>public import Mathlib.Tactic.Attr.Register</code>) to <code>Mathlib/Control/Traversable/Equiv.lean</code> makes this file build on command line.</p>",
        "id": 572268567,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1770334814
    },
    {
        "content": "<p>Okay, this took a short while to analyze in full depth. The issue indeed is that <code>functor_norm</code> simply isn't imported anymore, so the cmdline behavior is correct; <a href=\"https://github.com/leanprover/lean4/pull/12375\">lean#12375</a> will ensure shake does not discard such imports. The divergence between server and cmdline here is a separate issue, which ultimately stems from simpsets being registered via <code>initialize</code>. This part will require some more thinking.</p>",
        "id": 572541492,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1770478181
    }
]