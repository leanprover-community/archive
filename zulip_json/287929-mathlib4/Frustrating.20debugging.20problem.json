[
    {
        "content": "<p>I'm no computer scientist -- does anyone have any hints about how to proceed with the problem I describe below?</p>\n<p>I want to analyse PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/24003\">#24003</a> . It causes minor slowdowns but I think it's a step in the right direction and I would be prepared to take these slowdowns on the chin and merge (these files are fast anyway). But I would at least like to understand what the slowdowns are, because they might just be something dumb which is easily fixable.</p>\n<p>The file with the most instructions added to it by the changes in the PR is <code>Mathlib.Analysis.Analytic.Basic</code> which is +46*10^9 instructions, an increase of 17%. This file is 1400 lines long and was not touched by the PR. The 17% increase does not seem like noise, the PR has been benchmarked several times against two different commits of master and always comes out slower. So the big question is: what exactly is slower? Is every declaration a bit slower, or is it just two declarations which are 20 times slower? </p>\n<p>I have a nice two-monitor setup on a fast PC, with the two commits of mathlib checked out which are being compared by the speedcenter <a href=\"https://github.com/leanprover-community/mathlib4/pull/24003#issuecomment-2846244791\">here</a>. It's true that the PR makes the file compile more slowly; indeed I can insert a character at the start of both files as quickly as I can and then watch them compile. Both of them compile very quickly but the change definitely causes a slowdown. </p>\n<p>Ideally I could stick <code>#count_heartbeats</code> just after the module docstring and compare the outputs manually to get a feeling for what's happening, but right now <code>#count_heartbeats</code> gives spurious results (see issue <a href=\"https://github.com/leanprover-community/mathlib4/pull/23905\">#23905</a>). </p>\n<p>Can people suggest other ways in which I can try and see what's going on? I've never been in this position before. When analysing slow alg geom or comm alg files, it's always manifestly obvious where the problem is, it's in the declaration which says <code>set_option maxHeartbeats 800000 in</code> in front of it. But that's not happening here, these files are super-fast. If there's no simple way to do this I might just give up because I am fussing about essentially nothing here. To put this +46*10^9 instructions figure into some context: a typical PR just adding API might add this many instructions to mathlib, it is a tiny figure. I was just curious.</p>",
        "id": 516728724,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746637766
    },
    {
        "content": "<p>Kevin, I am responsible for having produced a wrong <code>#count_heartbeats</code> function.  Let me give it a second try.  Would you mind trying out creating a new file with the content of the code below and then importing that file into wherever you want to measure?</p>",
        "id": 516733500,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746639327
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">CountHeartbeats</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"c\">/-</span><span class=\"cm\">!</span>\n<span class=\"cm\"># The \"countHeartbeats'\" linter</span>\n\n<span class=\"cm\">The \"countHeartbeats'\" linter reports the output of `#count_heartbeats in` for every declaration.</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">The \"countHeartbeats'\" linter reports the output of `#count_heartbeats in` for every declaration.</span>\n<span class=\"sd\">-/</span>\n<span class=\"n\">register_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">countHeartbeats'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">defValue</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"enable the countHeartbeats' linter\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">warnIfRef</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">mkRef</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Using `#count_at_least n` makes the `linter.countHeartbeats'` report a warning on commands that</span>\n<span class=\"sd\">take at least `n` heartbeats.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#count_at_least \"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Warn when the heartbeats exceed {n}\"</span>\n<span class=\"w\">  </span><span class=\"n\">warnIfRef</span><span class=\"bp\">.</span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n\n<span class=\"sd\">/-- Add string `a` at the start of the first component of the name `n`. -/</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">prepend</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"_\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">modifyBase</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prepend</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">CountHeartbeats'</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inherit_doc</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">countHeartbeats'</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">countHeartbeatsLinter</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linter</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withSetOptionIn</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">getLinterValue</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">countHeartbeats'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">messages</span><span class=\"bp\">.</span><span class=\"n\">hasErrors</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Parser.Command.declId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">newID</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prepend</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">replaceM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">getKind</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">``Parser.Command.declId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">modifyArg</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkIdentFrom</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">newID</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">none</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">oldState</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">errors?</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">report</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">stx'</span><span class=\"bp\">⟩</span><span class=\"o\">)))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">msgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">messages</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">allErrors</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">msgs</span><span class=\"bp\">.</span><span class=\"n\">reported</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">toString</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unknownId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">msgs</span><span class=\"bp\">.</span><span class=\"n\">reportedPlusUnreported</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">toString</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">partition</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">·.</span><span class=\"n\">splitOn</span><span class=\"w\"> </span><span class=\"s2\">\"unknown identifier\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">msgs</span><span class=\"bp\">.</span><span class=\"n\">hasErrors</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">unknownId</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">chb</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">oldState</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstNoOverloadWithInfo</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">getId</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">chb</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"Used \"</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">drop</span><span class=\"w\"> </span><span class=\"s2\">\"Used \"</span><span class=\"bp\">.</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">takeWhile</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!·.</span><span class=\"n\">isWhitespace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toNat!</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">warnIfRef</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">logInfoAt</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{.ofConstName nm}: {d}\"</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">logWarningAt</span><span class=\"w\"> </span><span class=\"n\">ID</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{.ofConstName nm}: {d}\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">report</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">logErrorAt</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"s2\">\"Probably unreliable results!\"</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">addLinter</span><span class=\"w\"> </span><span class=\"n\">countHeartbeatsLinter</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">CountHeartbeats'</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span>\n</code></pre></div>",
        "id": 516733509,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746639330
    },
    {
        "content": "<p>I did not create the <code>#count_heartbeat</code> command, but the linter is always on, so simply importing it in a file should give you the timing.</p>",
        "id": 516733656,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746639366
    },
    {
        "content": "<p>I hope that this is \"mostly\" right now.</p>",
        "id": 516733684,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746639377
    },
    {
        "content": "<p>Here is the beginning of its reports on the file that you mentioned in the PR:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">sum</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">872</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">94</span><span class=\"o\">:</span><span class=\"mi\">4</span>\n<span class=\"n\">partialSum</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">873</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">98</span><span class=\"o\">:</span><span class=\"mi\">8</span>\n<span class=\"n\">partialSum_continuous</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">842</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">117</span><span class=\"o\">:</span><span class=\"mi\">4</span>\n<span class=\"n\">radius</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">4428</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">121</span><span class=\"o\">:</span><span class=\"mi\">8</span>\n<span class=\"n\">le_radius_of_bound</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">2483</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">126</span><span class=\"o\">:</span><span class=\"mi\">8</span>\n<span class=\"n\">le_radius_of_bound_nnreal</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">2635</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">131</span><span class=\"o\">:</span><span class=\"mi\">8</span>\n<span class=\"n\">le_radius_of_isBigO</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">2494</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">136</span><span class=\"o\">:</span><span class=\"mi\">8</span>\n<span class=\"n\">le_radius_of_eventually_le</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">2399</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">140</span><span class=\"o\">:</span><span class=\"mi\">8</span>\n<span class=\"n\">le_radius_of_summable_nnnorm</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">2682</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">143</span><span class=\"o\">:</span><span class=\"mi\">8</span>\n<span class=\"n\">le_radius_of_summable</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">2398</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n</code></pre></div>",
        "id": 516734716,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746639772
    },
    {
        "content": "<p>I also added the command <code>#count_at_least n</code>, so that writing <code>#count_at_least 2000</code> will make the linter emit an info (blue) when the heartbeat count is <code>&lt; 2000</code> and emit a warning (yellow) otherwise.</p>",
        "id": 516737643,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746640857
    },
    {
        "content": "<p>If the linter results are correct, there are exactly 2 declarations (<code>structure</code>s, in fact) in that file that take more than 7000 heartbeats and they are the consecutive <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=HasFPowerSeriesOnBall#doc\">docs#HasFPowerSeriesOnBall</a> (7389) and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=HasFPowerSeriesWithinOnBall#doc\">docs#HasFPowerSeriesWithinOnBall</a> (7548).</p>",
        "id": 516738450,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746641143
    },
    {
        "content": "<p>(And trying <code>#count_heartbeats in</code> manually on these declarations yields essentially the same numbers.)</p>",
        "id": 516738608,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746641189
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> my understanding was that it was changes to core Lean (the work on parallelism within files?), made <em>after</em> your work on <code>#count_heartbeats</code>, which was what stopped it working. I can confirm that this version above, written in a different file and imported, makes <code>#count_heartbeats</code> perform exactly how I wanted! Many thanks!</p>",
        "id": 516746214,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746643986
    },
    {
        "content": "<p>Can you explain this output (compiling the file on the comnmand line):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">91</span><span class=\"o\">:</span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">sum'</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"mi\">765</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">91</span><span class=\"o\">:</span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">872</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">96</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">partialSum'</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"mi\">765</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">96</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">partialSum</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">873</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">100</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">partialSum_continuous'</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"mi\">765</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">100</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">partialSum_continuous</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">842</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">119</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">radius'</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"mi\">2150</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Analytic</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">119</span><span class=\"o\">:</span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">radius</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">4428</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>I get \"warning\" and \"info\" about each declaration, with different numbers (oh is <code>info</code> the old output or something?)</p>",
        "id": 516747818,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746644539
    },
    {
        "content": "<p>Ideally we'd use the Firefox profiler diff view here</p>",
        "id": 516748707,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746644876
    },
    {
        "content": "<p>Unfortunately Lean writes (slightly) invalid profile files, and the diff view crashes</p>",
        "id": 516748866,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746644926
    },
    {
        "content": "<p>(I half fixed this a while ago, but the diff viewer got more picky around the same time it landed in Lean!)</p>",
        "id": 516748916,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746644950
    },
    {
        "content": "<p>(oh I realised I need to remove <code>#count_heartbeats</code> with Damiano's import!)</p>",
        "id": 516749413,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746645157
    },
    {
        "content": "<p>I'm not at a computer now, but, was the double reporting issue due to <code>#count_heartbeats</code>?</p>",
        "id": 516751211,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746645911
    },
    {
        "content": "<p>Regarding the failure of the old command, it was never clear to me what the root cause was, and there are usually workarounds for most issues anyways.  Hopefully this one will work for longer!</p>",
        "id": 516751372,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746645964
    }
]