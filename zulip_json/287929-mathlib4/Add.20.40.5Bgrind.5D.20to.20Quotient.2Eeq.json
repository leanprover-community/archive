[
    {
        "content": "<p>Shouldn't we add @[grind] to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Quot.html#Quot.eq\"><code>Quot.eq</code></a> so that grind can derive <code>r x y</code> from <code>Quot.mk r x = Quot.mk r y</code>?</p>\n<p>I've been hit by that while working on <code>Sym2</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">eq_iff</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">Sym2</span><span class=\"bp\">.</span><span class=\"n\">Rel</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I can make PR, but wanted to ask first, cause I'm not experienced with <code>grind</code> yet.</p>",
        "id": 538309506,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1757363196
    },
    {
        "content": "<p>Ah, wait, it's not the simple <code>Quot.eq</code> is <code>mk r x = mk r y ↔ Relation.EqvGen r x y</code>, not <code>mk r x = mk r y ↔ r x y</code>.<br>\nWe should add <code>@[grind]</code> to <code>Quotient.eq</code>, not <code>Quot.eq</code>. It won't solve my problem with <code>Sym2</code> though, I wonder why <code>Sym2</code> is defined in terms of <code>Quot</code> and not <code>Quotient</code> when the setoid instance is like 10 lines above in the code.</p>",
        "id": 538311225,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1757363898
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Quotient.eq#doc\">docs#Quotient.eq</a></p>",
        "id": 538409788,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757416140
    },
    {
        "content": "<p>No, one should never annotate lemmas of the form <code>(x = y) ↔ P x y</code> for <code>grind</code>. If you are tempted, make sure to use <code>@[grind?]</code>, and see the (bad!) patterns that <code>grind</code> attempts to use.</p>\n<p>A general piece of advice is that if you are trying to annotate an equality or iff for grind, with the expectation that it will rewrite the LHS into the RHS, you should always use <code>@[grind =]</code> (which requires that the entire LHS is the pattern) rather than <code>@[grind]</code> (which is free to choose other patterns). <code>@[grind =]</code> will (helpfully) not be allowed on <code>Quotient.eq</code>.</p>",
        "id": 538410237,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1757416292
    },
    {
        "content": "<p>I guess you'd need something like a <code>SolverExtension</code>?</p>",
        "id": 538411268,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757416611
    },
    {
        "content": "<p>Very helpfully not allowed :-)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/-- info: Quotient.eq: [@Quotient.mk #3 #2 #1, @Quotient.mk _ #2 #0] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">grind?</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">eq</span>\n</code></pre></div>",
        "id": 538411632,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757416724
    },
    {
        "content": "<p>Yeah, I've also already noticed that <code>grind =</code> generates better pattern then <code>grind</code>. Although, the pattern generated by <code>grind</code> would still work, it's just less efficient I think? Not sure.</p>\n<p>I think adding <code>Quotient.eq</code> to grind wouldn't help much anyway. Because <code>grind</code> isn't be able to rewrite <code>Rel.setoid α p q</code> to <code>Rel α p q</code>. See <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/grind.20cannot.20see.20past.20CoeFun/with/538384381\">#lean4 &gt; grind cannot see past CoeFun</a>.</p>",
        "id": 538412044,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1757416857
    }
]