[
    {
        "content": "<p>I'm introducing AddIdemQuantale to define idempotent additive quantales and try to follow what is standard in other parts of the library. I first define the class:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddIdemQuantale</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">AddQuantale</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> addition is idempotent in an idempotent quantale -/</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">add_idem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>And after that, I try to make the add_item theorem available:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">AddIdemQuantale</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IdemQuantale</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">add_idem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">IdemQuantale</span><span class=\"bp\">.</span><span class=\"n\">add_idem</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">AddIdemQuantale</span>\n</code></pre></div>\n<p>But now, continuous integration complains, because add_idem is also defined in Algebra.Order.Kleene (on IdemSemirings).</p>\n<p>What is the best way to go about such a clash?</p>",
        "id": 474540266,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727948695
    },
    {
        "content": "<p>One option would be to add an <code>IdemAddCommMonoid</code> class, and change <code>IdemSemiring</code> and your class to extend it</p>",
        "id": 474540789,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727948855
    },
    {
        "content": "<p>Another would be to change <code>add_idem</code> to assume <code>Std.IsIdempotent</code> instead</p>",
        "id": 474540932,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727948889
    },
    {
        "content": "<p>I think the <code>AddIdemCommMonoid</code> solution is the best</p>",
        "id": 474541106,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727948926
    },
    {
        "content": "<p>I fear that Pieter also wants <code>IsdemAddCommGroup</code> or more</p>",
        "id": 474542173,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727949153
    },
    {
        "content": "<p>I would propose to extend <code>Algebra.Groups.Defs</code> with <code>AddIdemSemigroup</code> and <code>IdemSemigroup</code> and work from there.<br>\nNot sure yet how many of the combined variants would come in, but it may indeed build up a bit.</p>",
        "id": 474542975,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727949321
    },
    {
        "content": "<p>I would suggest <em>not</em> putting them in <code>Algebra.Group.Defs</code> as then the majority of the library, not needing them, won't import them</p>",
        "id": 474543525,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727949420
    },
    {
        "content": "<p>Pieter, in your context is the stronger <code>a + b = a ⊔ b</code> requirement that <code>IdemSemiring</code> uses ok?</p>",
        "id": 474545109,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727949702
    },
    {
        "content": "<p>Not exactly, but... an alternative definition for quantales in general is: </p>\n<blockquote>\n<p>A quantale, or complete dioid, Q, is a dioid in which the underlying sup-semilattice has arbitrary suprema over which the multiplication distributes.</p>\n</blockquote>\n<p>with dioid simply being another word for semiring... so maybe taking a different starting point for the definition may solve the issue. However, it may lead to notational confusion as well.</p>\n<p>If I view a quantale as a semigroup combined with a complete lattice, which is the more usual view, either the <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>+</mo></mrow><annotation encoding=\"application/x-tex\">+</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord\">+</span></span></span></span> or <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>∗</mo></mrow><annotation encoding=\"application/x-tex\">*</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4653em;\"></span><span class=\"mord\">∗</span></span></span></span> can be used to denote the semigroup, and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>⊔</mo></mrow><annotation encoding=\"application/x-tex\">\\sqcup</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5556em;\"></span><span class=\"mord\">⊔</span></span></span></span> is used for the lattice. When presented as a semiring, I would be forced to write <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>∗</mo></mrow><annotation encoding=\"application/x-tex\">*</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4653em;\"></span><span class=\"mord\">∗</span></span></span></span> for the semigroup and use <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>+</mo></mrow><annotation encoding=\"application/x-tex\">+</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord\">+</span></span></span></span> for the join.</p>",
        "id": 474548820,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727950476
    },
    {
        "content": "<p>(How do you manage to write the \\sqcup in this: <code>a + b = a ⊔ b</code>? I can only do it by copy-paste now... Newbie...)</p>",
        "id": 474549182,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727950546
    },
    {
        "content": "<p>Type <code>\\sup</code> in vscode</p>",
        "id": 474549557,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727950609
    },
    {
        "content": "<p>Ah, that's not what I meant. I meant within Zulip. The webinterface eludes me on how to write this.</p>",
        "id": 474559418,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727953372
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474543525\">said</a>:</p>\n<blockquote>\n<p>I would suggest <em>not</em> putting them in <code>Algebra.Group.Defs</code> as then the majority of the library, not needing them, won't import them</p>\n</blockquote>\n<p>What would be a good place? Make a separate file on idempotence <code>Algebra.Group.Idem</code> or so?</p>",
        "id": 474559855,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727953495
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474545109\">said</a>:</p>\n<blockquote>\n<p>Pieter, in your context is the stronger <code>a + b = a ⊔ b</code> requirement that <code>IdemSemiring</code> uses ok?</p>\n</blockquote>\n<p>I'm trying to go by the first approach, extending the definition of IdemSemiring, but I have trouble with the original definition. It goes like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- An idempotent semiring is a semiring with the additional property that addition is idempotent.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IdemSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SemilatticeSup</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">sup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">add_eq_sup</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⊔</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span>\n<span class=\"w\">    </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The bottom element of an idempotent semiring: `0` by default -/</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>\n<p>Thing is... the definition never explicitly mentions idempotence? Instead it mentions a SemilatticeSup?<br>\nFrom the textual description, I would have expected something along the lines of:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IdemSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">   </span><span class=\"n\">add_idem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>and subsequently a theorem saying<br>\n<code>instance [IdemSemiring α] : SemilatticeSup α</code></p>\n<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> am I missing something here? Do you know why the original definition is the way it is?</p>",
        "id": 474572111,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727956946
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474545109\">said</a>:</p>\n<blockquote>\n<p>Pieter, in your context is the stronger <code>a + b = a ⊔ b</code> requirement that <code>IdemSemiring</code> uses ok?</p>\n</blockquote>\n<p>That's what Eric was trying to get you to understand with this <span aria-label=\"point of information\" class=\"emoji emoji-261d\" role=\"img\" title=\"point of information\">:point_of_information:</span>  message: There are several definitions of idempotence</p>",
        "id": 474605056,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727965949
    },
    {
        "content": "<p>An idempotent semiring assumes that addition is the same as supremum, so in particular it is idempotent (<code>a + a = a ⊔ a = a</code>). Your idempotency requirement seems to just be <code>a + a = a</code>, with no mention of an order. There is a mismatch</p>",
        "id": 474605344,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727966038
    },
    {
        "content": "<p>From what I've been reading in some papers at least, an idempotent semiring is usually defined as \"a semiring with and idempotent addition\", just like the comment says in the Mathlib definition. No assumptions regarding any ordering are made. Instead, given that definition, literature usually argues that one can define a natural/canonical order on idempotent semirings through <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo>≤</mo><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">x \\leq y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span> iff <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>x</mi><mo>+</mo><mi>y</mi><mo>=</mo><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">x + y = y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span></span></span></span>, in which case <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>+</mo></mrow><annotation encoding=\"application/x-tex\">+</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord\">+</span></span></span></span> coincides with <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>u</mi><mi>p</mi></mrow><annotation encoding=\"application/x-tex\">sup</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">p</span></span></span></span>. Reversely, it can then be shown that any idempotent semiring can only be ordered in this way if one wants both + and * to be order preserving, and so an idempotent semiring can also be thought of as a semiring on a Sup-semilattice with + defined as sup. This latter viewpoint was apparently taken as a definition Mathlib, rather than being a result. </p>\n<p>I don't see an actual mismatch, really, just a different starting point. In fact, the quantales that I'm defining can also be described as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Quantale</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">IdemSemiring</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CompleteLattice</span>\n</code></pre></div>\n<p>But an additive quantale AddQuantale could not be defined in the same way unless we introduce AddIdemSemiring (i.e. a semiring in which * and + are reversed).</p>\n<p>The solution of the <code>AddIdemCommMonoid</code> class (or similar) still seems best. I'll try to make that work.</p>",
        "id": 474618954,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727969004
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474540789\">said</a>:</p>\n<blockquote>\n<p>One option would be to add an <code>IdemAddCommMonoid</code> class, and change <code>IdemSemiring</code> and your class to extend it</p>\n</blockquote>\n<p>Okay... so I'm trying this out, and now run into the next thing...<br>\nIf I extend IdemSemiring like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AddIdemSemigroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">AddSemigroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">add_idem</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">IdemSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">SemilatticeSup</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddIdemSemigroup</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">sup</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">add_eq_sup</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">⊔</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">intros</span>\n<span class=\"w\">    </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The bottom element of an idempotent semiring: `0` by default -/</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"n\">bot_le</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">bot</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>\n<p>then I will have to add the <code>add_idem</code> field everytime an instance of IdemSemiring is being made.<br>\nThere is a default solution, which comes down to applying add_eq_sup and sup_idem, but I don't know<br>\nhow to add this in such a way that I don't need to change anything downstream anymore. (It seems there<br>\nis a lot of theory already built on IdemSemiring, so I'm getting in a bit of a mess for my first PR...)</p>\n<p>Other solution would be to give up on the desire to have both Quantale and AddQuantale, but that sounds like creating problems in the future.</p>",
        "id": 474632094,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727972230
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"563058\">Pieter Cuijpers</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474618954\">said</a>:</p>\n<blockquote>\n<p>This latter viewpoint was apparently taken as a definition Mathlib, rather than being a result.</p>\n</blockquote>\n<p>This is because you generally don't want to define instances that build new data from existing instances. It can pretty easily lead to diamonds.</p>",
        "id": 474632906,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727972483
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"563058\">Pieter Cuijpers</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474632094\">said</a>:</p>\n<blockquote>\n<p>then I will have to add the <code>add_idem</code> field everytime an instance of IdemSemiring is being made.</p>\n</blockquote>\n<p>You can resolve this by not extending <code>AddIdemSemigroup </code>, and writing a <code>IdemSemiring.toAddIdemSemigroup </code> instance manually.</p>",
        "id": 474633641,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727972705
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474632906\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"563058\">Pieter Cuijpers</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474618954\">said</a>:</p>\n<blockquote>\n<p>This latter viewpoint was apparently taken as a definition Mathlib, rather than being a result.</p>\n</blockquote>\n<p>This is because you generally don't want to define instances that build new data from existing instances. It can pretty easily lead to diamonds.</p>\n</blockquote>\n<p>Thanks. I need to chew on that one a bit, I think. Is there a book or videolecture that goes into this a bit more?</p>",
        "id": 474660247,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1727980776
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathematics_in_lean/\">#mil</a></p>",
        "id": 474662753,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727981822
    },
    {
        "content": "<p>specifically: <a href=\"https://leanprover-community.github.io/mathematics_in_lean/C07_Hierarchies.html#basics\">https://leanprover-community.github.io/mathematics_in_lean/C07_Hierarchies.html#basics</a></p>\n<blockquote>\n<p>But the diamond we created with modules is definitely bad. The offending piece is the <code>smul</code> field which is data, not a proof, and we have two constructions that are not definitionally equal. The robust way of fixing this issue is to make sure that going from a rich structure to a poor structure is always done by forgetting data, not by defining data. This well-known pattern as been named “forgetful inheritance” and extensively discussed in <a href=\"https://inria.hal.science/hal-02463336\">https://inria.hal.science/hal-02463336</a>.</p>\n</blockquote>\n<p>Although there is much more in this section worth reading (and the rest of the book!)</p>",
        "id": 474663549,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727982123
    },
    {
        "content": "<p>Also: <span class=\"user-mention\" data-user-id=\"563058\">@Pieter Cuijpers</span> I'm worried that the discussion of quantales is too disjointed. I've seen several threads about your issues on Zulip, not to mention your PR and the back-and-forth we've had there. I think you need a single thread in which we converge on the correct design, as well as the correct prerequisites. A key thing to understand in formalization is that proofs are easy, definitions are hard. So getting the right definition(s) of quantales is important to make later use as straightforward as possible.</p>",
        "id": 474663881,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727982260
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists/near/474663881\">said</a>:</p>\n<blockquote>\n<p>proofs are easy, definitions are hard</p>\n</blockquote>\n<p><span aria-label=\"raised hand\" class=\"emoji emoji-270b\" role=\"img\" title=\"raised hand\">:raised_hand:</span> Combinatorics would like to object <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> But more seriously, yes I agree with Jireh that you should stop fragmenting the discussion. In fact, if someone could merge all the threads together in one thread called \"Quantales\" under <a class=\"stream\" data-stream-id=\"116395\" href=\"/#narrow/stream/116395-maths\">#maths</a>, that would be great.</p>",
        "id": 474664909,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727982649
    },
    {
        "content": "<p>Agreed. I'm not proficient enough on Zulip yet to comply to the merge request, but if someone can do it or show me how, let's go.</p>",
        "id": 475240909,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1728289450
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"563058\">@Pieter Cuijpers</span> , if you provide links here to all the threads, and then ping me, I can try to do something appropriate later.</p>",
        "id": 475312574,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1728311828
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> Thanks for the offer!</p>\n<p>There are four threads that I recently started to get help related to my efforts to formalize the Quantale definitions.</p>\n<p>The first one, I used to ask for help on to_additive, after I couldn't find out how to use it from reading example code on semigroups. (I'm not sure if that would belong in a \"Quantale\" group, as it is more about how to use to_additive.)<br>\n<a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/to_additive.20gives.20error.20.22can.27t.20transport.20XYZ.20to.20itself.22\">#mathlib4 &gt; to_additive gives error \"can't transport XYZ to itself\"</a> </p>\n<p>The second one also came up in the use of to_additive, because I felt uncertain about adding anything to a part of the library that I'm really not involved in developing. Turns out that would be okay. (Again, I feel this has nothing to do with Quantales really, and therefore it was okay for it to have its own thread. Maybe I should not have mentioned what I was working on, but I felt that may be relevant context for the answer.)<br>\n<a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/adding.20items.20to.20fixAbbreviation.20in.20to_additive\">#mathlib4 &gt; adding items to fixAbbreviation in to_additive</a> </p>\n<p>The third may actually be more important for the Quantale definition than I originally figured. I thought it would be a more generic question about semigroups, but perhaps the context is more important. I figured I needed to understand how to define an idempotent semigroup, and based on that would define an idempotent quantale in a similar manner. As it turns out, the choice becomes more whether I should use a parameterized definition of quantale and then indeed have a definition of idempotent semigroup, or have a definition of idempotent quantale (perhaps even without having a def. of idempotent semigroup). As I'm not completely decided on this yet, a discussion in the \"Quantale\" topic would be good.<br>\n<a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/Two.20ways.20of.20defining.20an.20idempotent.20semigroup\">#mathlib4 &gt; Two ways of defining an idempotent semigroup</a> </p>\n<p>The last one is derived from this. I added it because, while working on the idempotent semigroup, I discovered a dependency with kleene algebras. Ultimately, we worked out that it is probably best to replace the lemma in the kleene algebra file with a lemma that proves that and idempotent semiring is an instance of an idempotent semigroup, replacing the lemma that is currently there (and says exactly the same). I also got that to work fine, but if we go for a parameterized quantale definition, it should probably be done in a separate PR, while if we go for an integrated quantale definition, it may be done in this PR.<br>\n<a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/nameclash.3A.20add_idem.20already.20exists\">#mathlib4 &gt; nameclash: add_idem already exists</a> </p>\n<p>I hope this gives you enough information.</p>",
        "id": 475669462,
        "sender_full_name": "Pieter Cuijpers",
        "timestamp": 1728420668
    }
]