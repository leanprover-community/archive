[
    {
        "content": "<p>I also want to advertise that you can now write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">R</span>\n</code></pre></div>\n<p>to get nice syntax for polynomial variables in an MVPolynomial ring</p>",
        "id": 533947285,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1754993072
    },
    {
        "content": "<p>i guess what i'm really asking is, would I be wasting my time if I tried to write <code>algebra</code> myself</p>",
        "id": 533947411,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754993117
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> does that mean <a href=\"https://github.com/leanprover-community/mathlib4/pull/27196\">#27196</a> is redundant?</p>",
        "id": 533947620,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1754993201
    },
    {
        "content": "<p>No, because that is not about <code>MVPolynomial</code>.</p>",
        "id": 533948067,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1754993362
    },
    {
        "content": "<p>But I'm sure <code>name_poly_vars</code> can be beefed up.</p>",
        "id": 533948120,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1754993381
    },
    {
        "content": "<p>I could imagine a syntax like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- MVPoly</span>\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">[</span><span class=\"n\">q</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Poly</span>\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"o\">][</span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"c1\">-- Poly (Poly)</span>\n</code></pre></div>",
        "id": 533948351,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1754993474
    },
    {
        "content": "<p>it doesn't seem that hard to do looking at the <a href=\"https://github.com/FLDutchmann/mathlib4/blob/c1b416635a45285ea8e65289ec46468d037b0aa4/Mathlib/Tactic/Ring/NamePolyVars.lean#L46\">source</a></p>",
        "id": 533948493,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754993535
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/533947411\">said</a>:</p>\n<blockquote>\n<p>i guess what i'm really asking is, would I be wasting my time if I tried to write <code>algebra</code> myself</p>\n</blockquote>\n<p>Probably. I'm just now working on it again, so maybe wait and see if I've given up on it in two weeks <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 533949359,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1754993919
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28349\">#28349</a> implements the polynomial notation with two caveats:</p>\n<ol>\n<li><del>I have not figured out how to remove the space (please teach me if you know how)</del> (fixed thanks to Aaron)</li>\n<li>I have not fixed the existing notation because I want to get this approved first, which means the PR will error for now</li>\n</ol>\n<p>Usage:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"n\">Y</span><span class=\"o\">,</span><span class=\"n\">Z</span><span class=\"o\">]</span>\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">s</span><span class=\"o\">][</span><span class=\"n\">t</span><span class=\"o\">][</span><span class=\"n\">u</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"c1\">-- Y : MvPolynomial (Fin 3) R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"c1\">-- t : Polynomial (Polynomial (Polynomial R))</span>\n</code></pre></div>",
        "id": 534242953,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755095364
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span></p>",
        "id": 534243004,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755095378
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534242953\">said</a>:</p>\n<blockquote>\n<ol>\n<li>I have not figured out how to remove the space (please teach me if you know how)</li>\n</ol>\n</blockquote>\n<p>You seem to have a conflict with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=GetElem#doc\">docs#GetElem</a> notation</p>",
        "id": 534251650,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755097846
    },
    {
        "content": "<p>I think ideally the parser should just parse the first word unless it starts with <code>(</code>?</p>",
        "id": 534251876,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755097922
    },
    {
        "content": "<p>is this desirable?</p>",
        "id": 534251894,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755097928
    },
    {
        "content": "<p>what do you mean by \"word\"</p>",
        "id": 534252433,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755098103
    },
    {
        "content": "<p>identifier</p>",
        "id": 534252456,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755098113
    },
    {
        "content": "<p>that can probably work</p>",
        "id": 534252496,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755098127
    },
    {
        "content": "<p>do you want to PR to my PR?</p>",
        "id": 534252527,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755098139
    },
    {
        "content": "<p>I can try it</p>",
        "id": 534252622,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755098171
    },
    {
        "content": "<p><a href=\"https://github.com/kckennylau/mathlib4/pull/9\">kckennylau/mathlib4#9</a></p>",
        "id": 534257080,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755099584
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 534257286,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755099648
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> Cool! This looks good to me.</p>\n<p>But I also have another feature request. Could we make it so that the command also make <code>R[X,Y,Z]</code> available as notation for <code>MVPolynomial (Fin 3) R</code>?</p>",
        "id": 534269115,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1755104048
    },
    {
        "content": "<p>on  it</p>",
        "id": 534275793,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755107004
    },
    {
        "content": "<p>hmm, I have run into a <em>small</em> problem:</p>",
        "id": 534292482,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755113854
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"s2\">\"(Fin 37)[d,e]\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Int</span>\n<span class=\"c1\">-- invalid atom</span>\n<span class=\"c1\">-- invalid syntax node kind</span>\n</code></pre></div>",
        "id": 534292562,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755113882
    },
    {
        "content": "<p>apparently mathlib doesn't like brackets</p>",
        "id": 534292646,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755113912
    },
    {
        "content": "<p>but I have come up with an alternate solution:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"s2\">\"[d,e]\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"s2\">\"d\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">e</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- rfl : R[d,e] = R[d,e]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">e</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- rfl : S[d,e] = S[d,e]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">e</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Fin 37[d,e] : Type</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">d</span><span class=\"o\">,</span><span class=\"n\">e</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Fin 37[d,e] : Type</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"c1\">-- d : R[d,e]</span>\n</code></pre></div>",
        "id": 534292963,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755114031
    },
    {
        "content": "<p>(I tested name collision, name collision is fine)</p>",
        "id": 534293478,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755114223
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> is this acceptable? (the side effect is that for the <code>R[d,e]</code> notation it now doesn't matter what you put in the R, which would be inconsistent with how <code>d</code> still requires <code>R</code>...)</p>",
        "id": 534293535,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755114247
    },
    {
        "content": "<p>corollary: brackets now don't actually matter</p>",
        "id": 534293721,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755114337
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534292646\">said</a>:</p>\n<blockquote>\n<p>apparently mathlib doesn't like brackets</p>\n</blockquote>\n<p>after more testing, it's actually that notation3 doesn't spaces in strings and doesn't like words that start with a number</p>",
        "id": 534293935,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755114441
    },
    {
        "content": "<p>so there might be no other way out</p>",
        "id": 534293968,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755114460
    },
    {
        "content": "<p>Any notation using brackest should use <code>noWs</code> as well</p>",
        "id": 534302184,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755118187
    },
    {
        "content": "<p>Which means you can't use <code>notation</code> and have to use <code>syntax</code> instead, and write your own app_unexpander</p>",
        "id": 534302226,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755118207
    },
    {
        "content": "<p>Does this notation allow <code>R[X][Y,Z][W]</code>?</p>",
        "id": 534312923,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1755123635
    },
    {
        "content": "<p>good point</p>",
        "id": 534312969,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755123656
    },
    {
        "content": "<p>do we need this?</p>",
        "id": 534312972,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755123660
    },
    {
        "content": "<p>i guess it would be good to have it</p>",
        "id": 534312993,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755123668
    },
    {
        "content": "<p>Eventually we want all the things. Including <code>R[X][[Y,Z]][W](t)</code></p>",
        "id": 534313105,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1755123729
    },
    {
        "content": "<p>btw there was one implicit assumption that i always assumed, maybe it's good to voice it out eventually:</p>",
        "id": 534313167,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755123767
    },
    {
        "content": "<p>this notation basically just bans MvPolynomial (Fin 1) because of ambiguity</p>",
        "id": 534313193,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755123781
    },
    {
        "content": "<p>I think R[q] should just always be Polynomial R</p>",
        "id": 534313207,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755123789
    },
    {
        "content": "<p>Yeah, I agree with that…. unless we want to redefine <code>Polynomial</code>;)</p>",
        "id": 534313298,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1755123842
    },
    {
        "content": "<p>what should we call it? the current name I just had is 'polyesque'</p>",
        "id": 534313514,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755123983
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534313193\">said</a>:</p>\n<blockquote>\n<p>this notation basically just bans MvPolynomial (Fin 1) because of ambiguity</p>\n</blockquote>\n<p>You can put a trailing comma, like how one-tuples are done in python</p>",
        "id": 534314049,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755124301
    },
    {
        "content": "<p>This also allows <code>MvPolynomial (Fin 0)</code></p>",
        "id": 534314112,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755124338
    },
    {
        "content": "<p>so like this?<br>\nMvPolynomial (Fin 0) R = R[,]<br>\nMvPolynomial (Fin 1) R = R[x,]<br>\nMvPolynomial (Fin 2) R = R[x,y]</p>",
        "id": 534314174,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755124377
    },
    {
        "content": "<p>Well I guess R[] works too</p>",
        "id": 534314334,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755124501
    },
    {
        "content": "<p>ok i've finally put the pieces together to make a headstart:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">polyesque_head</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- syntax to allow specifying `MvPolynomial (Fin 1) R` with `R[t,]` and `Polynomial R` with `R[t]`</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">polyesque_mv?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sepBy</span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"o\">,</span><span class=\"s2\">\",\"</span><span class=\"o\">,</span><span class=\"s2\">\",\"</span><span class=\"o\">,</span><span class=\"n\">allowTrailingSep</span><span class=\"o\">)</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">polynomial_mv?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">polyesque_mv?</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">power_series_mv?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"[[\"</span><span class=\"w\"> </span><span class=\"n\">polyesque_mv?</span><span class=\"w\"> </span><span class=\"s2\">\"]]\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">rat_func</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">laurent_series</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"((\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"))\"</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">polyesque_body</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">polynomial_mv?</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">power_series_mv?</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">rat_func</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">laurent_series</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">polyesque_head</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">polyesque_body</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyesqueElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">toExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">,]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[[</span><span class=\"n\">X</span><span class=\"o\">]]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">)[</span><span class=\"n\">Y</span><span class=\"o\">][[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">]]((</span><span class=\"n\">d</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)(</span><span class=\"n\">X</span><span class=\"o\">)[</span><span class=\"n\">Y</span><span class=\"o\">][[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">]]((</span><span class=\"n\">d</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 534315290,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755125104
    },
    {
        "content": "<p>what should i do here? should i store something in the <del>global</del> environment, or should i try to override the elaborator locally?</p>",
        "id": 534317781,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755126737
    },
    {
        "content": "<p>(and how do i do either of these?)</p>",
        "id": 534317789,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755126743
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"kn\">syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">syntax</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyesqueElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">ty?</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ty?</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mdata</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"ss\">`var_name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofName</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">)])</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"sd\">/-- Construct a named variable. -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"v%\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"v_internal%\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"bp\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">%$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"n\">withoutErrToSorry</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">v_internal</span><span class=\"bp\">%$</span><span class=\"n\">i</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n<span class=\"w\">    </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">exceptionToSorry</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n\n<span class=\"n\">elab_rules</span><span class=\"w\"> </span><span class=\"bp\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">v_internal</span><span class=\"bp\">%$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mdata</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ty</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwErrorAt</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"s2\">\"Not a valid variable name\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">get?</span><span class=\"w\"> </span><span class=\"ss\">`var_name</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v_internal</span><span class=\"bp\">%$</span><span class=\"n\">i</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">ty</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">%</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">%</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">%</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">][</span><span class=\"n\">Y</span><span class=\"o\">])</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">%</span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">][</span><span class=\"n\">Y</span><span class=\"o\">])</span>\n</code></pre></div>",
        "id": 534327866,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755135325
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534317781\">said</a>:</p>\n<blockquote>\n<p>what should i do here? should i store something in the global environment, or should i try to override the elaborator locally?</p>\n</blockquote>\n<p>I think this should be as local as possible. Different files/sections may want different names for their polynomial variables.</p>",
        "id": 534328454,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1755135834
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534328454\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534317781\">said</a>:</p>\n<blockquote>\n<p>what should i do here? should i store something in the global environment, or should i try to override the elaborator locally?</p>\n</blockquote>\n<p>I think this should be as local as possible. Different files/sections may want different names for their polynomial variables.</p>\n</blockquote>\n<p>yes but I meant store something in the environment so that my elaborator in <code>NamePolyVars.Lean</code> can output different things depending on the environment in different files, while only changing that environment locally in different files</p>",
        "id": 534365076,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755154706
    },
    {
        "content": "<p>basically, something like local attributes (that change something global locally)</p>",
        "id": 534365235,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755154711
    },
    {
        "content": "<p>man, Lean's lack of documentation is really unfortunate for learners like me, mathlib's policy of enforcing a docstring on every def is really shining out here</p>",
        "id": 534378447,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755155260
    },
    {
        "content": "<p>I go to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/ScopedEnvExtension.html#Lean.ScopedEnvExtension.Entry\">https://leanprover-community.github.io/mathlib4_docs/Lean/ScopedEnvExtension.html#Lean.ScopedEnvExtension.Entry</a> and there is zero docstring</p>",
        "id": 534378764,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755155273
    },
    {
        "content": "<p>great, my first test went into stack overflow, i didn't even know this is possible</p>",
        "id": 534420561,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755157159
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 534420876,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755157176
    },
    {
        "content": "<p>(i debugged this in the local setup instead of the web, and it turned out it's because i can't do the testing in the same file where i initialised the commands)</p>",
        "id": 534429062,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755158597
    },
    {
        "content": "<p>ok, i now have working code to set local attributes</p>",
        "id": 534430860,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755159265
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NAT</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">SimpleScopedEnvExtension</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">NAT</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerSimpleScopedEnvExtension</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">addEntry</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">new</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">initial</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">0</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getNum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">setNum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">trace</span><span class=\"o\">[</span><span class=\"n\">debug</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Setting {n}\"</span>\n<span class=\"w\">  </span><span class=\"n\">test</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"kn\">local</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">setNumCmd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"#set_num\"</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">command_elab</span><span class=\"w\"> </span><span class=\"n\">setNumCmd</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">setNumCmdElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"n\">set_num</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"unrecognised syntax\"</span>\n<span class=\"w\">  </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">setNum</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">getNumCmd</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"get_num%\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">getNumCmd</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getNumCmdElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getNum</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 534430878,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755159272
    },
    {
        "content": "<p>(in a different file:)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Sandbox</span><span class=\"bp\">.</span><span class=\"n\">TestEnv</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">foo1</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 0</span>\n<span class=\"bp\">#</span><span class=\"n\">set_num</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 3</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">foo1</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">foo2</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 0</span>\n<span class=\"bp\">#</span><span class=\"n\">set_num</span><span class=\"w\"> </span><span class=\"mi\">37</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 37</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">foo2</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 0</span>\n<span class=\"bp\">#</span><span class=\"n\">set_num</span><span class=\"w\"> </span><span class=\"mi\">333</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 333</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">foo3</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 333</span>\n<span class=\"bp\">#</span><span class=\"n\">set_num</span><span class=\"w\"> </span><span class=\"mi\">34</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">get_num</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"c1\">-- 34</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">foo3</span>\n</code></pre></div>",
        "id": 534430981,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755159312
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534315290\">said</a>:</p>\n<blockquote>\n<p><code>syntax laurent_series := \"((\" ident \"))\"</code></p>\n</blockquote>\n<p>I can't type <code>))</code> anymore, should we use unicode? <code>⸨⸩</code></p>",
        "id": 534470830,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755173867
    },
    {
        "content": "<p>do we want a replacement for ratFunc as well?</p>",
        "id": 534470888,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755173892
    },
    {
        "content": "<p>LaurentSeries actually uses <code>R⸨X⸩</code></p>",
        "id": 534471130,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755173983
    },
    {
        "content": "<p>Can you use a syntax category so that parens are only parsed in such a way within a specific syntax context?</p>",
        "id": 534478307,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1755176349
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"308899\">Yakov Pechersky</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/near/534478307\">said</a>:</p>\n<blockquote>\n<p>Can you use a syntax category so that parens are only parsed in such a way within a specific syntax context?</p>\n</blockquote>\n<p>no, because you're supposed to be able to write <code>R[X,Y]</code> for <code>MvPolynomial (Fin 2) R</code> after you delcare it using <code>name_poly_vars</code></p>",
        "id": 534482819,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755177774
    },
    {
        "content": "<p>I don't see a way to do that without making that syntax available globally</p>",
        "id": 534482900,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755177796
    },
    {
        "content": "<p>71 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Tactic.20for.20polynomial.2Falgebra/with/533947141\">#mathlib4 &gt; Tactic for polynomial/algebra</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 534483649,
        "sender_full_name": "Notification Bot",
        "timestamp": 1755178033
    },
    {
        "content": "<p>thanks!</p>",
        "id": 534483746,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755178064
    },
    {
        "content": "<p>A message was moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Redefining.20polynomial/with/534483865\">#mathlib4 &gt; Redefining polynomial</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 534483867,
        "sender_full_name": "Notification Bot",
        "timestamp": 1755178103
    },
    {
        "content": "<p>Kenny, what are your thoughts on my <code>v%</code> trick above?</p>",
        "id": 534484034,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755178161
    },
    {
        "content": "<p>I thought it would be better to use <code>notation</code> so that we don't need to write the extra <code>v%</code></p>",
        "id": 534485226,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755178587
    },
    {
        "content": "<p>and also I thought we want to only be able to use <code>R[X][Y]</code> after declaring it</p>",
        "id": 534485293,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755178605
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> so there’s a slight issue, basically I don’t want the tactic to import polynomial and laurent series and ratfunc etc (6 different modules here), and as a result, I would need to do a slightly unhygienic thing of referring to the Ident `MvPowerSeries.C  rather than the real thing that exists in the MvPowerSeries module</p>\n<p>(I discussed this with <span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span> as well)</p>",
        "id": 534546610,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755199588
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534546610\">said</a>:</p>\n<blockquote>\n<p>referring to the Ident `MvPowerSeries.C  rather than the real thing that exists in the MvPowerSeries module</p>\n</blockquote>\n<p>These are the same thing?</p>",
        "id": 534546801,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755199659
    },
    {
        "content": "<p>the inf and sup delabs <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.delabInf#doc\">docs#Mathlib.Meta.delabInf</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.delabSup#doc\">docs#Mathlib.Meta.delabSup</a> do something similar with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearOrder#doc\">docs#LinearOrder</a></p>",
        "id": 534546962,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755199733
    },
    {
        "content": "<p>I would expect you to let these things register themselves when imported?</p>",
        "id": 534546986,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755199744
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534546986\">said</a>:</p>\n<blockquote>\n<p>I would expect you to let these things register themselves when imported?</p>\n</blockquote>\n<p>what does this mean?</p>",
        "id": 534547037,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755199775
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>, delaborators are different; it's ok to ask \"is this this thing that's not yet imported\", but it's worse to say \"your code elaborates to this thing that's not imported\"</p>",
        "id": 534547039,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755199777
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534547037\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534546986\">said</a>:</p>\n<blockquote>\n<p>I would expect you to let these things register themselves when imported?</p>\n</blockquote>\n<p>what does this mean?</p>\n</blockquote>\n<p>The same way any other syntax works?</p>",
        "id": 534547061,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755199787
    },
    {
        "content": "<p>Don't register it all at once, register it piecewise with handlers</p>",
        "id": 534547081,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755199799
    },
    {
        "content": "<p>oh ok</p>",
        "id": 534547096,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755199805
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534547039\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span>, delaborators are different; it's ok to ask \"is this this thing that's not yet imported\", but it's worse to say \"your code elaborates to this thing that's not imported\"</p>\n</blockquote>\n<p>You could check if it exists, and if it doesn't throw an error saying you need to import something</p>",
        "id": 534547142,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755199825
    },
    {
        "content": "<p>(this is also what <code>run_meta</code> and other commands do)</p>",
        "id": 534547247,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755199876
    },
    {
        "content": "<p>I think supporting user-defined variable-definers at the same time is a good idea</p>",
        "id": 534547789,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755200173
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> well it already checks whether MvPolynomial.C exists when it runs the command to add the notations for the formal variables</p>",
        "id": 534548589,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755200556
    },
    {
        "content": "<p>it has been suggested to me that Lean.mkCIdent is a more hygenic version that checks for global constants; are there any drawbacks?</p>",
        "id": 534556322,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755203953
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.mkCIdent#doc\">docs#Lean.mkCIdent</a></p>",
        "id": 534556546,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204013
    },
    {
        "content": "<p>the downside is that it's not hygienic</p>",
        "id": 534556561,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204016
    },
    {
        "content": "<p>well, it is hygienic but it uses the same hygiene every time</p>",
        "id": 534556764,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204079
    },
    {
        "content": "<p>it also loses source information</p>",
        "id": 534556897,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204137
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.mkCIdentFrom#doc\">docs#Lean.mkCIdentFrom</a> would be better</p>",
        "id": 534556912,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204145
    },
    {
        "content": "<p>why can't you just use a syntax quotation?</p>",
        "id": 534557045,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204210
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>  <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAGQKYEMB2AoDATJAzOPCCARjgC4BeOAORRiyQBsUAjOAIhiQGcYSOFONygg4lAHxxsEDHESo0AOgCiLVkoAqSUUuZttolWh4BXKMDQBzTQE8wSOAApACYRwABk6KkAlD7hKaBBoSIzqnNx8AEyC5MI6YpLSsvLI6KrqWgl66oYgxmYW1nYOzm6e3lF+AUEhWLgElRTUdAwYAMQAxgAWSJ0A1vF8ZAC0IwDu0P08HT19g5EwUXBjeCjATDxAA\">https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAGQKYEMB2AoDATJAzOPCCARjgC4BeOAORRiyQBsUAjOAIhiQGcYSOFONygg4lAHxxsEDHESo0AOgCiLVkoAqSUUuZttolWh4BXKMDQBzTQE8wSOAApACYRwABk6KkAlD7hKaBBoSIzqnNx8AEyC5MI6YpLSsvLI6KrqWgl66oYgxmYW1nYOzm6e3lF+AUEhWLgElRTUdAwYAMQAxgAWSJ0A1vF8ZAC0IwDu0P08HT19g5EwUXBjeCjATDxAA</a></p>",
        "id": 534557944,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755204632
    },
    {
        "content": "<p>oh yeah</p>",
        "id": 534558027,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204680
    },
    {
        "content": "<p>that's how hygiene works</p>",
        "id": 534558037,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204685
    },
    {
        "content": "<p>right</p>",
        "id": 534558155,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755204741
    },
    {
        "content": "<p>what would you do?</p>",
        "id": 534558180,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755204751
    },
    {
        "content": "<p>me?</p>",
        "id": 534558260,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204792
    },
    {
        "content": "<p>I would write an elab writer</p>",
        "id": 534558272,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204798
    },
    {
        "content": "<p>instead of notation</p>",
        "id": 534558279,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204801
    },
    {
        "content": "<p>or maybe a macro writer</p>",
        "id": 534558395,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204875
    },
    {
        "content": "<p>or maybe this should just be extensible</p>",
        "id": 534558407,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755204881
    },
    {
        "content": "<p>hmm i could see some part of that</p>",
        "id": 534561061,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755206026
    },
    {
        "content": "<p>so, basically, i have no code yet this is all in my head</p>\n<p>basically in Polynomial.lean I would be able to write something like</p>\n<p>register_poly_vars \"[\" X \"]\" Polynomial.C Polynomial.X</p>\n<p>and in MvPowerSeries.lean:</p>\n<p>register_poly_vars \"[[\" X, ... \"]]\" MvPowerSeries.C 2 MvPolynomial.X</p>\n<p>?</p>",
        "id": 534562015,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755206451
    },
    {
        "content": "<p>sure</p>",
        "id": 534562072,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755206472
    },
    {
        "content": "<p>is this what you have in mind?</p>",
        "id": 534562115,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755206487
    },
    {
        "content": "<p>that works</p>",
        "id": 534562151,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755206497
    },
    {
        "content": "<p>I guess one flaw is that then this file would be imported by the 6 files, so this file would suddenly become very low in the import hierarchy</p>",
        "id": 534562271,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755206550
    },
    {
        "content": "<p>is that bad?</p>",
        "id": 534562307,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755206572
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534378764\">said</a>:</p>\n<blockquote>\n<p>I go to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/ScopedEnvExtension.html#Lean.ScopedEnvExtension.Entry\">https://leanprover-community.github.io/mathlib4_docs/Lean/ScopedEnvExtension.html#Lean.ScopedEnvExtension.Entry</a> and there is zero docstring</p>\n</blockquote>\n<p>docstring PRs very welcome as you decipher what things mean :-)</p>",
        "id": 534562411,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755206622
    },
    {
        "content": "<p>hmm at that point do we still need Polynomial.X? <span aria-label=\"melting face\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melting face\">:melting_face:</span></p>",
        "id": 534563330,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755207089
    },
    {
        "content": "<p>just write name_poly_vars R[X] at the start of every file</p>",
        "id": 534563366,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755207112
    },
    {
        "content": "<p>or better, make R[X] a scoped name_poly_vars declaration?</p>",
        "id": 534563439,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755207151
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534563330\">said</a>:</p>\n<blockquote>\n<p>hmm at that point do we still need Polynomial.X? <span aria-label=\"melting face\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melting face\">:melting_face:</span></p>\n</blockquote>\n<p>then how would you name theorems about it</p>",
        "id": 534563520,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755207192
    },
    {
        "content": "<p>To be fair, it could be called <code>var</code>. Although I'm not a big fan... it's 2 chars longer...</p>",
        "id": 534591289,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1755228420
    },
    {
        "content": "<p>There's  a world where <code>Polynomial R</code> is defined as <code>AddMonoidAlgebra R Nat</code>, and then (almost) everything is proved at the level of <code>AddMonoidAlgebra</code>, where <code>X</code> doesn't make sense</p>",
        "id": 534601726,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755236949
    },
    {
        "content": "<p>I have come across a new roadblock. Let's take <code>(Fin 37)[t]</code> as example:</p>\n<ol>\n<li>We want <code>t</code> to mean <code>Polynomial.X.</code></li>\n<li>We want <code>(Fin 37)[t]</code> to mean <code>Polynomial</code></li>\n<li>We want to be able to extend this notation, so that <code>(Fin 37)[u]</code> would still make sense on the level of syntax</li>\n</ol>\n<p>Then the problem is that after the notation <code>t</code> is declared (step 1), then <code>t</code> is no longer a valid identifier, so that the following (auto-generated, don't worry) code fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : Polynomial (Fin 37)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ❌ unexpected token 't'; expected identifier</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">u</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ✔ not implemented</span>\n</code></pre></div>\n<p>I am now considering a workaround, which is to instead hardcode the notation <code>\"[t]\"</code> in <code>poly</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[t]\"</span>\n</code></pre></div>\n<p>but this feels a bit cursed. What are your opinions?</p>",
        "id": 534681652,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755276024
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span></p>",
        "id": 534681750,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755276060
    },
    {
        "content": "<p>I have some ideas</p>",
        "id": 534681828,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755276100
    },
    {
        "content": "<p>I wouldn't be surprised</p>",
        "id": 534681980,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755276165
    },
    {
        "content": "<p>it works!!!! i have my first working code <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>",
        "id": 534683774,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755277041
    },
    {
        "content": "<p>what did you do</p>",
        "id": 534683789,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755277050
    },
    {
        "content": "<p>what i said</p>",
        "id": 534683797,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755277056
    },
    {
        "content": "<p>that feels a bit cursed</p>",
        "id": 534683831,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755277073
    },
    {
        "content": "<p>well you didn't tell me your ideas</p>",
        "id": 534683856,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755277086
    },
    {
        "content": "<p>I'm working on it</p>",
        "id": 534683874,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755277095
    },
    {
        "content": "<p>My code can now do:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">NamePolyVars</span>\n\n<span class=\"c1\">-- set_option trace.name_poly_vars true</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"bp\">#</span><span class=\"n\">register_poly_vars</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial R : Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"bp\">#</span><span class=\"n\">register_poly_vars</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n\n<span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- MvPolynomial (Fin 2) R : Type</span>\n\n<span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">C</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial (MvPolynomial (Fin 2) R) : Type</span>\n</code></pre></div>",
        "id": 534685129,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755277698
    },
    {
        "content": "<p>unfortunately my ideas are not working so we might have to use the cursed grouping</p>",
        "id": 534686533,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755278411
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> do you know what's the magic to have the pretty printer use the new notation?</p>",
        "id": 534687201,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755278743
    },
    {
        "content": "<p>write a delab (or an unexpander)</p>",
        "id": 534687240,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755278764
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> I tried to learn both, but I could not get either to work, here is my code that does not work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">unexpandX</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">«$</span><span class=\"n\">R</span><span class=\"bp\">»</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">delabX</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferTypeQ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTermEnsuringTypeQ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">annotateGoToSyntaxDef</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 534690734,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755280523
    },
    {
        "content": "<p>Would you like to teach me how to fix it?</p>",
        "id": 534690748,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755280530
    },
    {
        "content": "<p>oh this might be tricky</p>",
        "id": 534691041,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755280683
    },
    {
        "content": "<p>yeah I have no idea how to make this work</p>",
        "id": 534692994,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755281569
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> would you have any idea? to summarise, in  the code above I introduce local notation <code>t</code> for <code>Polynomial.X (R := R)</code>, and I want a delab/unexpander to print <code>t</code> for <code>Polynomial.X (R := R)</code> but not for <code>Polynomial.X (R := S)</code>.</p>",
        "id": 534747879,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755331953
    },
    {
        "content": "<p>I should also say that the full working code is now available in <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349\">#28349</a></p>",
        "id": 534811444,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421523
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span></p>",
        "id": 534811445,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421526
    },
    {
        "content": "<p>though idk if I should make it work with scoped notation like you wanted in bivariates...</p>",
        "id": 534811537,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421649
    },
    {
        "content": "<p>it's a bit complicated because in the code the base ring is a fixed free variable</p>",
        "id": 534811553,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421672
    },
    {
        "content": "<p>I think the current idea is to just write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">][</span><span class=\"n\">Y</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>at the top of every file importing Bivariate?</p>",
        "id": 534811610,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421739
    },
    {
        "content": "<p>Yes, I think that's perfectly fine</p>",
        "id": 534811629,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755421767
    },
    {
        "content": "<p>Would be cool if there was a way to say \"<code>R(X]|Y]</code> will mean <code>Polynomial (Polynomial R)</code> for all rings <code>R</code>\", as this shows up in Toric, but if we have to do <code>#name_poly_vars R[X][Y] #name_poly_vars S[X][Y]</code> once then it's fine</p>",
        "id": 534811669,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755421827
    },
    {
        "content": "<p>it's definitely possible, but my impression was that the consensus is against that</p>",
        "id": 534811688,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421852
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534811669\">said</a>:</p>\n<blockquote>\n<p>Would be cool if there was a way to say \"<code>R(X]|Y]</code> will mean <code>Polynomial (Polynomial R)</code> for all rings <code>R</code>\", as this shows up in Toric, but if we have to do <code>#name_poly_vars R[X][Y] #name_poly_vars S[X][Y]</code> once then it's fine</p>\n</blockquote>\n<p>(you should also make the variable names different)</p>",
        "id": 534811707,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421872
    },
    {
        "content": "<p>i think this is a good point to bring up</p>",
        "id": 534811769,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755421958
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Proposal1</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"X\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Proposal1</span>\n\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Proposal2</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"X\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Proposal2</span>\n</code></pre></div>",
        "id": 534811797,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755422010
    },
    {
        "content": "<p>the current code is for proposal2, and that's what i've written as well, but it seems like you want proposal 1</p>",
        "id": 534811813,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755422027
    },
    {
        "content": "<p>I think there's a potential drawback for proposal1 where you would do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">][</span><span class=\"n\">Y</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">][</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">c</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and then <code>X</code> for <code>b</code> would typecheck</p>",
        "id": 534811860,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755422101
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534811860\">said</a>:</p>\n<blockquote>\n<p>I think there's a potential drawback for proposal1 where you would do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">][</span><span class=\"n\">Y</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">][</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">c</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and then <code>X</code> for <code>b</code> would typecheck</p>\n</blockquote>\n<p>Does it really happen that you simultaneously consider different polynomial rings over the <em>same</em> ring?</p>",
        "id": 534812041,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755422374
    },
    {
        "content": "<p>My use case really is to deal with things like base change, where I transfer information about some polynomial ring to some other polynomial ring over a <em>different</em> ring</p>",
        "id": 534812085,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755422410
    },
    {
        "content": "<p>I don't really mind either way but I would prefer if there's a consensus because I can't maintain two copies of the same code</p>",
        "id": 534812091,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755422419
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> I have an alternate proposal to encompass both:</p>\n<p>In my PR, there's currently already a workaround, to use <code>(_)</code> for the ring so that it can fit in any type:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Test1</span>\n\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">)[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Vector</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">)[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">v</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Test1</span>\n</code></pre></div>\n<p>but obviously this is suboptimal, so I propose a proposal 3 where I would enable:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>to do the thing you want, with special support so that you can later type <code>R[a,b][C]</code> and also <code>S[a,b][C]</code> and have Lean recognise the notation.</p>",
        "id": 534822411,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755435767
    },
    {
        "content": "<p>(cc <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> is this ok to you?)</p>",
        "id": 534822421,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755435778
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> I like proposal 3 <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 534877650,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1755498800
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> I've updated <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349\">#28349</a> to allow for <code>name_poly_vars _[a,b][C]</code> to mean do this for all rings</p>",
        "id": 535032741,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755558781
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> <span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> Is <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349\">#28349</a> ready to be reviewed or are you still actively working on it?</p>",
        "id": 535035019,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1755560532
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/535035019\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> Is <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349\">#28349</a> ready to be reviewed or are you still actively working on it?</p>\n</blockquote>\n<p>it is ready to be reviewed</p>",
        "id": 535077543,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755591382
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> Adam has raised a point on the syntax for registering the notation. Which one do you prefer?</p>\n<p>Proposal 1:</p>\n<ul>\n<li><code>register_poly_vars \"[\" X \"]\" Polynomial Polynomial.C Polynomial.X</code></li>\n<li><code>register_poly_vars \"[\" X, ... \"]\" MvPolynomial MvPolynomial.C MvPolynomial.X</code></li>\n</ul>\n<p>Proposal 2:</p>\n<ul>\n<li><code>register_poly_var \"[\" \"]\" Polynomial Polynomial.C Polynomial.X</code></li>\n<li><code>register_mv_poly_vars \"[\" \"]\" MvPolynomial MvPolynomial.C MvPolynomial.X</code></li>\n</ul>",
        "id": 539555649,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757942206
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span></p>",
        "id": 539555753,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757942239
    },
    {
        "content": "<p>To add a bit of context, I think the <code>X</code> in proposal 1 could only lead to confusion, since the actual notation doesn’t actually involve <code>X</code> after the command is issued (you need a separate command to declare the var names). These commands are just there to register the delimiters such as <code>[</code> and <code>]</code>. </p>\n<p>I think a nicer approach would be to have just one command, and to detect whether the notation is single or multi variable by checking the type of the functions that are specified after the delimiters, but that would require a bit more metaprogramming.</p>",
        "id": 539566396,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757944717
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> As I explained in the PR, I didn't like the last approach because that's like mixing syntax with evaluation</p>",
        "id": 539568274,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945120
    },
    {
        "content": "<p>Thats the whole point of elaboration, isn’t it?</p>",
        "id": 539568586,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757945196
    },
    {
        "content": "<p>no, the whole PR is strictly syntax</p>",
        "id": 539568743,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945228
    },
    {
        "content": "<p>I can give an implementation later today (hopefully) if you would like to try it out</p>",
        "id": 539568964,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757945277
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> I'm not saying it can't be done, I'm saying that the entirety of my PR is operating within syntax. See for example <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349/files#diff-54ab75d6e1d95ebd3815a4b9e0821901deb721508b113749b557ee00b8fb17e1R202\">my function to build the X term</a>, which is just syntactical function application</p>",
        "id": 539569578,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945410
    },
    {
        "content": "<p>there's no type checking done anywhere, because the whole point is just to build <code>notation</code></p>",
        "id": 539569595,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945415
    },
    {
        "content": "<p>so it feels wrong to suddenly jump out of syntax.</p>",
        "id": 539569757,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945452
    },
    {
        "content": "<p>another example is how I allow for underscores in the syntax, which aren't filled in at all until Lean decides to elaborate it</p>",
        "id": 539569932,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945485
    },
    {
        "content": "<p>the undescore in <code>register_poly_vars \"[[\" X \"]]\" PowerSeries (PowerSeries.C _) PowerSeries.X</code></p>",
        "id": 539569990,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945498
    },
    {
        "content": "<p>Ok, I guess I don’t really understand the objection then. Are you saying that having one command that detects how to modify the env extension is not a good idea for some reason? Or are you saying that you want to leave this PR as primarily syntax/notation manipulation and think about the suggestion in a follow up PR?</p>",
        "id": 539570358,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757945574
    },
    {
        "content": "<p>I'm saying these commands <em>should</em> operate entirely within syntax</p>",
        "id": 539570571,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945617
    },
    {
        "content": "<p>they <em>should</em> be purely syntax -&gt; syntax, so all the syntax info (in this case, whether it's 1v or mv) should be provided by syntax, not by further type checking of the terms provided</p>",
        "id": 539570865,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945680
    },
    {
        "content": "<p>Can you explain why you want them to only operate within syntax?</p>",
        "id": 539571127,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757945730
    },
    {
        "content": "<p>because the output is in syntax, i.e. the <code>notation</code> commands (<a href=\"https://github.com/leanprover-community/mathlib4/pull/28349/files#diff-54ab75d6e1d95ebd3815a4b9e0821901deb721508b113749b557ee00b8fb17e1R314\">here</a>)</p>",
        "id": 539571242,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945756
    },
    {
        "content": "<p>also like these should work regardless of whether <code>Polynomial.C</code> is implemented as a ring hom or just as a function, the command shouldn't care about these \"implementation details\"</p>",
        "id": 539571816,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945880
    },
    {
        "content": "<p>So in particular you want to allow <code>register_poly_vars “[“ X “]” foo bar</code> even if <code>foo</code> and <code>bar</code> don’t exist?</p>",
        "id": 539571954,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757945908
    },
    {
        "content": "<p>Note that there is precedent for jumping back and forth between syntax and elaboration; <code>variable</code> elaborates its arguments, even though they are ultimately reused as syntax</p>",
        "id": 539571994,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757945918
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539571954\">said</a>:</p>\n<blockquote>\n<p>So in particular you want to allow <code>register_poly_vars “[“ X “]” foo bar</code> even if <code>foo</code> and <code>bar</code> don’t exist?</p>\n</blockquote>\n<p>ideally, but Lean actually doesn't really allow that (due to \"hygiene\")</p>",
        "id": 539572099,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757945938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539571816\">said</a>:</p>\n<blockquote>\n<p>also like these should work regardless of whether <code>Polynomial.C</code> is implemented as a ring hom or just as a function, the command shouldn't care about these \"implementation details\"</p>\n</blockquote>\n<p>I forsee this being a little tricky with PowerSeries, where the objects themselves can be applied as functions with some defeq abuse</p>",
        "id": 539572327,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757945989
    },
    {
        "content": "<p>Which is not an argument against the metaprogramming, only for writing a test for this case</p>",
        "id": 539572406,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757946005
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539569990\">said</a>:</p>\n<blockquote>\n<p>the undescore in <code>register_poly_vars \"[[\" X \"]]\" PowerSeries (PowerSeries.C _) PowerSeries.X</code></p>\n</blockquote>\n<p>(hey looks like this was recently fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/27889\">#27889</a>)</p>",
        "id": 539572816,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757946092
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539572406\">said</a>:</p>\n<blockquote>\n<p>Which is not an argument against the metaprogramming, only for writing a test for this case</p>\n</blockquote>\n<p>well... I just don't think it's a good thing...</p>",
        "id": 539573267,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757946196
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/533947285\">said</a>:</p>\n<blockquote>\n<p>I also want to advertise that you can now write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"w\"> </span><span class=\"n\">over</span><span class=\"w\"> </span><span class=\"n\">R</span>\n</code></pre></div>\n<p>to get nice syntax for polynomial variables in an MVPolynomial ring</p>\n</blockquote>\n<p>Nice! Do we have the analogue for <code>MvPowerSeries</code>?</p>",
        "id": 539579345,
        "sender_full_name": "María Inés de Frutos Fernández",
        "timestamp": 1757947583
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"406490\">@María Inés de Frutos Fernández</span> that is my PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349\">#28349</a> which is currently being discussed</p>",
        "id": 539579473,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757947617
    },
    {
        "content": "<p>Awesome, thanks!</p>",
        "id": 539579552,
        "sender_full_name": "María Inés de Frutos Fernández",
        "timestamp": 1757947635
    },
    {
        "content": "<p>we're having a small disagreement over the way to declare multivariate notation vs univariate</p>",
        "id": 539579620,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757947653
    },
    {
        "content": "<p>Okay, I'm at my office now so I can write a bit more. Here is what I propose. We have a single command <code>register_vars</code> (or whatever) that has the following usage by default: <code>register_vars \"[\" \"]\" foo bar</code>. This command should try to deduce whether to register single or multi variables by looking at the types of <code>foo</code> and <code>bar</code> and checking if the type looks like the <code>Polynomial</code> case or the <code>MvPolynomial</code> case. </p>\n<p>There will be edge cases where no such determination can be made for whatever reason. In such cases, the command would throw an error and <em>require</em> require the user to provide a configuration option approximately like <code>register_vars (mv := true) \"[\" \"]\" foo bar</code>.</p>",
        "id": 539585248,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757949053
    },
    {
        "content": "<p>When such a configuration is provided, no further elaboration of <code>foo</code> or <code>bar</code> is done, and the command behaves as it does now, depending on whether <code>mv := true</code> or <code>mv := false</code>.</p>",
        "id": 539585392,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757949084
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> I would prefer (for the same reasons) to just have <code>(mv := true|false)</code> without the type checking</p>",
        "id": 539585686,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757949169
    },
    {
        "content": "<p>(additionally we can also default to <code>false</code>)</p>",
        "id": 539585849,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757949205
    },
    {
        "content": "<p>Another syntax proposal would be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">register_poly_vars</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"n\">register_poly_vars</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n</code></pre></div>",
        "id": 539586073,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757949270
    },
    {
        "content": "<p>Since we already have <code>,+</code> as a combinator for regular syntax</p>",
        "id": 539586114,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757949283
    },
    {
        "content": "<p>Okay, at the end of the day, I don't think this automatic detection is <em>that</em> important, so I would be fine with either <code>(mv := ...)</code> or <code>_</code>/<code>_,+</code> (but not <code>X</code> because I do think it could lead to confusion)</p>",
        "id": 539603342,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1757953426
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> please pick one <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 539603509,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757953468
    },
    {
        "content": "<p>Can you remind me why we need a custom registration function here? What goes wrong with something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">:</span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">vars</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">,</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">makePolyHandler</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">vars</span>\n</code></pre></div>",
        "id": 539606186,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757954225
    },
    {
        "content": "<p>aren't you doing the same thing then</p>",
        "id": 539606389,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757954291
    },
    {
        "content": "<p>but also making it harder for the average Lean user (who knows nothing about metaprogramming) to register a new polynomial-like functor</p>",
        "id": 539606471,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757954318
    },
    {
        "content": "<p>oh, and also, your code just registers the syntax for <code>R[q]</code>, but not for <code>q</code></p>",
        "id": 539606665,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757954377
    },
    {
        "content": "<p>Right, I'm only suggesting a replacement for <code>register_poly_vars</code></p>",
        "id": 539606737,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757954402
    },
    {
        "content": "<p>also it behaves differently than the specified behaviour, your code makes the notation <code>R[q]</code> globally available</p>",
        "id": 539606765,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757954409
    },
    {
        "content": "<p>my <code>register_poly_vars</code> only adds to the env extension</p>",
        "id": 539606906,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1757954452
    },
    {
        "content": "<p>I think <code>mv := ...</code> is easier for the average user than <code>_,+</code></p>",
        "id": 539618204,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1757958575
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> your <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349#discussion_r2349579474\">suggestion</a> seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decode_poly_var</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">decode_poly_var</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">decodePolyVar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">]]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Unrecognised polynomial-like notation: {stx}\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{str}\"</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">decodePolyesque</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">polyesque</span><span class=\"bp\">|$</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">v</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Unrecognised polynomial-like notation: {stx}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">raw</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"Unrecognised polynomial-like variable: {v}\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{str}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">Syntax</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 539754744,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758025545
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> expressed <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349#discussion_r2331477650\">concerns</a> on storing this as string, which you also agreed with</p>",
        "id": 539755102,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758025645
    },
    {
        "content": "<p>but I don't see a way to store this other than the string <code>[t]</code></p>",
        "id": 539755178,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758025666
    },
    {
        "content": "<p>i actually think it's the best way, it prevents someone from declaring <code>[t</code> as the open brackets and <code>]</code> as the closing brackets (i.e. prevents collisions)</p>",
        "id": 539755284,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758025700
    },
    {
        "content": "<p>you need something hashable to look up whether a notation has been declared, and string is the best way to do this</p>",
        "id": 539755361,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758025724
    },
    {
        "content": "<p>Do you need to look up if the notation is declared? Why not let the standard notation overloading deal with this?</p>",
        "id": 539756455,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758026075
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> if someone declares<br>\n<code>#name_poly_vars R[a,b][C]</code><br>\nthen <code>#check R[d,e][f]</code> should error</p>",
        "id": 539756992,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758026222
    },
    {
        "content": "<p>so given d e f, I need to look up in the table whether d e f specifically are declared</p>",
        "id": 539757097,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758026248
    },
    {
        "content": "<p>the best way to store that information imo is the string <code>[d,e][f]</code></p>",
        "id": 539757187,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758026270
    },
    {
        "content": "<p>I'd argue that <code>R[a,b][D]</code> should error on the D, which means you should store a structured object you can do a partial lookup on</p>",
        "id": 539762343,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758027581
    },
    {
        "content": "<p>I would disagree. you're saying that <code>R[a,b]</code> should not error, but I think it should error.</p>",
        "id": 539762477,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758027617
    },
    {
        "content": "<p>Is this legal? <code>def foo (x : R[a,b]) (y : R[a,b][c]) : R[a,b][c] := C x + y</code>?</p>",
        "id": 539763443,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758027906
    },
    {
        "content": "<p>I don't think it should be legal.</p>",
        "id": 539763554,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758027935
    },
    {
        "content": "<p>One reason could be that this would make <code>a</code> mean two things</p>",
        "id": 539763800,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758028009
    },
    {
        "content": "<p><code>a</code> would mean both <code>MvPolynomial.X 0</code> and <code>Polynomial.C (MvPolynomial.X 0)</code></p>",
        "id": 539763867,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758028027
    },
    {
        "content": "<p>as cursed as this would be, I would prefer:<br>\n<code>def foo (x : R[p,q]) (y : R[a,b][c]) : R[a,b][c] := C x + y</code></p>",
        "id": 539764053,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758028074
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/534681652\">said</a>:</p>\n<blockquote>\n<p>Then the problem is that after the notation <code>t</code> is declared (step 1), then <code>t</code> is no longer a valid identifier, so that the following code fails</p>\n</blockquote>\n<p>Would the following suffice as a solution to your problem? We add a syntax category  <code>poly_var</code>, and we locally add specific variables to this syntax category. This syntax category is allowed to give a <code>term</code>, and then we make the <code>macro</code> act on this when it is a <code>term</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : Polynomial (Fin 37)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ✔ not implemented</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">u</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ❌ unexpected identifier; expected poly_var</span>\n</code></pre></div>",
        "id": 539900965,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758060733
    },
    {
        "content": "<p>yep that works</p>",
        "id": 539901042,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758060782
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> could you explain to me how the <code>:max</code> magic works?</p>",
        "id": 539901544,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758061076
    },
    {
        "content": "<p>do you intend to remove the other use of <code>term_decl</code> as well?</p>",
        "id": 539902062,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758061428
    },
    {
        "content": "<p>also i forgot about <code>macro_rules</code>, thanks for the reminder</p>",
        "id": 539902202,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758061518
    },
    {
        "content": "<p>When declaring a syntax parser, it is often useful to tell Lean about precedence. For example using <code>infixl:65</code> for <code>+</code> expands to something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"mi\">66</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>\n<p>When parsing a term, to figure out if it is valid syntax, there is always the current precedence level, and each syntax has a precedence level in which it is allowed.<br>\nFor example <code>a + b</code> is allowed in precedence 65 or lower. The <code>a</code> is then parsed with precedence 65, and the <code>b</code> is parsed with precedence 66. This means that nested addition in the left is allowed, but not in the right.</p>\n<p>In function applications, like <code>f a</code>, <code>a</code> is parsed with the highest possible precedence, which is <code>max</code>, or 1024. So to allow our notation here, we need to set the precedence of our syntax to <code>max</code>.</p>",
        "id": 539902637,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758061781
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539902062\">said</a>:</p>\n<blockquote>\n<p>do you intend to remove the other use of <code>term_decl</code> as well?</p>\n</blockquote>\n<p>If possible, yes</p>",
        "id": 539902699,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758061820
    },
    {
        "content": "<p>So if I have <code>a + b * c</code>, basically <code>b</code> is located at a higher precedence therefore <code>a + b</code> doesn't activate? is that a correct understanding?</p>",
        "id": 539902845,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758061919
    },
    {
        "content": "<p>i'm trying to understand what you mean by a syntax being \"allowed\"</p>",
        "id": 539902871,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758061936
    },
    {
        "content": "<p>Yes, Lean might consider parsing <code>a + b * c</code> bracketed like <code>(a + b) * c</code>, but it will reject this option, because the first argument of the <code>_ * _</code> notation is parsed at precedence 70, and <code>a + b</code> has precedence 65, which is smaller than 70 and thus rejected.</p>",
        "id": 539903022,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758062061
    },
    {
        "content": "<p>so if it's <code>:max</code> then it's always allowed</p>",
        "id": 539903127,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758062136
    },
    {
        "content": "<p>Yes. For example, the bracket notation <code>(_)</code> has this <code>:max</code> precedence, so it is accepted in any place, and the inside is parsed with minimal precedence, so any syntax in there will always be accepted.</p>",
        "id": 539903194,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758062174
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539903127\">said</a>:</p>\n<blockquote>\n<p>so if it's <code>:max</code> then it's always allowed</p>\n</blockquote>\n<p>In particular, if the whole notation is marked with <code>:max</code>, then it is always allowed.</p>\n<p>On the other hand if a part of a notation is marked with <code>:max</code>, then this uses is the most restrictive kind of parsing.</p>",
        "id": 539903378,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758062304
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> how do i write that line <code>local macro_rules | `(t) = ...</code> dynamically?</p>",
        "id": 539903891,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758062685
    },
    {
        "content": "<p>i now have:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">toPolyVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PolyVar</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 539904083,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758062835
    },
    {
        "content": "<p>not sure if this is correct</p>",
        "id": 539904087,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758062841
    },
    {
        "content": "<p>It seems to be very awkward to refer to a <code>syntax</code> which is being defined on the fly. This is the solution I have now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">PolyVar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`poly_var</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkPolyVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stxName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PolyVar</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">stxName</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stxNameId</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mkStr</span><span class=\"w\"> </span><span class=\"ss\">`UniqueString</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- TODO: make this name hygienic</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">stxNameId</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stxName</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">realizeGlobalConstNoOverload</span><span class=\"w\"> </span><span class=\"n\">stxNameId</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkPolyVar</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"n\">stxName</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">var</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)))))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : Polynomial (Fin 37)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ✔ not implemented</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">u</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ❌ unexpected identifier; expected poly_var</span>\n</code></pre></div>",
        "id": 539910114,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758067899
    },
    {
        "content": "<p>thanks</p>",
        "id": 539910251,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758068052
    },
    {
        "content": "<p>Here's a cleaner solution I've found now, using <code>Command.elabSyntax</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">PolyVar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`poly_var</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"n\">run_cmd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabSyntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">mkNode</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkAtom</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">var</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)))))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : Polynomial (Fin 37)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ✔ not implemented</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">)[</span><span class=\"n\">u</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- ❌ unexpected identifier; expected poly_var</span>\n</code></pre></div>",
        "id": 539911174,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758068835
    },
    {
        "content": "<p>oh wow they made a specialised function just for this situation</p>",
        "id": 539911248,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758068906
    },
    {
        "content": "<p>Alternatively, should we just allow every <code>ident</code> to be a <code>poly_var</code>, and have the elaborator do the lookup in an environment extension?</p>",
        "id": 539911329,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758068973
    },
    {
        "content": "<p>well this approach seems to eliminate the need for env ext</p>",
        "id": 539911375,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758069005
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539911329\">said</a>:</p>\n<blockquote>\n<p>Alternatively, should we just allow every <code>ident</code> to be a <code>poly_var</code>, and have the elaborator do the lookup in an environment extension?</p>\n</blockquote>\n<p>well...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n</code></pre></div>",
        "id": 539911548,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758069179
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/539911329\">said</a>:</p>\n<blockquote>\n<p>Alternatively, should we just allow every <code>ident</code> to be a <code>poly_var</code>, and have the elaborator do the lookup in an environment extension?</p>\n</blockquote>\n<p>Originally, I also wanted to just use the <code>ident</code> syntax category. But the problem is that those identifiers that are declared to be polynomial variables do not get parsed as <code>ident</code>.</p>\n<p>I would still be happy to allow other <code>ident</code>s in the syntax if that helps improve error messages.</p>",
        "id": 539911654,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758069299
    },
    {
        "content": "<p>I now realised that <code>ident &lt;|&gt; poly_var</code> might work in one situation</p>",
        "id": 539911707,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758069359
    },
    {
        "content": "<p>actually no that doesn't really save any lines</p>",
        "id": 539911734,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758069393
    },
    {
        "content": "<p>Whoops, I forgot we care about <code>q</code> and not just <code>R[q]</code>, indeed my suggestion is stupid</p>",
        "id": 539911763,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758069416
    },
    {
        "content": "<p>There are 2 places where we want to parse polynomial variables:</p>\n<ol>\n<li>As loose expressions. For this we need a local notation.</li>\n<li>Inside of the brackets of <code>R[a,b]</code>. For this we are forced to jump through hoops to be able to parse those same variables. Here we could use <code>poly_var</code>, or use <code>poly_var &lt;|&gt; ident</code> if that helps give better error messages.</li>\n</ol>",
        "id": 539911906,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758069579
    },
    {
        "content": "<p>I have discovered a new tech:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#asdf\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">head</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pR</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabSyntax</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nv</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">pR</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">asdf</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>double-quoting for the win</p>",
        "id": 540012460,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758115044
    },
    {
        "content": "<p>Why is <code>head</code> mentioned only once there?</p>",
        "id": 540014048,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758115454
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <code>pR</code> contains another <code>$head</code> (hidden in <code>$R := $head</code>)</p>",
        "id": 540014115,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758115476
    },
    {
        "content": "<p>the code essentially does:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>but dynamically</p>",
        "id": 540014405,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758115555
    },
    {
        "content": "<p>Great! So we now don't need to implement a global elaborator/macro for the <code>R[t]</code> syntax either. It can also be declared as a local macro.</p>",
        "id": 540014697,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758115612
    },
    {
        "content": "<p>yes, that is my plan</p>",
        "id": 540014767,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758115623
    },
    {
        "content": "<p>We can also have the <code>syntax term:max \"[\" poly_var \"]\" : term</code> be scoped to some <code>PolyNotation</code> namespace. And the <code>#asdf</code> command can run the command <code>open scoped PolyNotation</code>. This way, the syntax can't get in the way of people trying to index arrays.</p>",
        "id": 540016299,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758115989
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540016299\">said</a>:</p>\n<blockquote>\n<p>the syntax can't get in the way of people trying to index arrays.</p>\n</blockquote>\n<p>you already can't, poly_var is very restrictive</p>",
        "id": 540016561,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116052
    },
    {
        "content": "<p>i don't know about the scoped syntax suggestion... I already don't like how <code>⊗</code> for <code>TensorProduct</code> is scoped</p>",
        "id": 540016692,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116085
    },
    {
        "content": "<p>In this case the user wouldn't even notice whether it is scoped, because they already need to turn in on using a special command.</p>",
        "id": 540016903,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758116132
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540016561\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540016299\">said</a>:</p>\n<blockquote>\n<p>the syntax can't get in the way of people trying to index arrays.</p>\n</blockquote>\n<p>you already can't, poly_var is very restrictive</p>\n</blockquote>\n<p>But what if you have <code>a : Std.HashMap (Polynomial Nat) Nat</code>, and <code>t</code> is a polynomial variable in <code>Nat[t]</code>. then <code>a[t]</code> could do the wrong thing.</p>",
        "id": 540017449,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758116264
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"c1\">-- local syntax \"t\" : poly_var</span>\n<span class=\"c1\">-- local macro_rules | `($head[t]) =&gt; `(Polynomial $head)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#asdf\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">head</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pR</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabSyntax</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nv</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">pR</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"triggered\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">false</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">asdf</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 540017648,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116305
    },
    {
        "content": "<p>check how \"triggered\" is never triggered</p>",
        "id": 540017677,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116315
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540017449\">said</a>:</p>\n<blockquote>\n<p>But what if you have <code>a : Std.HashMap (Polynomial Nat) Nat</code>, and <code>t</code> is a polynomial variable in <code>Nat[t]</code>. then <code>a[t]</code> could do the wrong thing.</p>\n</blockquote>\n<p>but this would happen regardless of whether you scope the notation...</p>",
        "id": 540017920,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116376
    },
    {
        "content": "<p>also if you declare it using Nat[t] then a[t] wouldn't trigger</p>",
        "id": 540018028,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116402
    },
    {
        "content": "<p>I made it an option to match against all head or one specific head</p>",
        "id": 540018088,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116415
    },
    {
        "content": "<p><code>name_poly_vars Nat[p,q]</code> only matches on <code>Nat</code></p>",
        "id": 540018136,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116424
    },
    {
        "content": "<p><code>name_poly_vars _[p,q]</code> matches on any head</p>",
        "id": 540018165,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758116431
    },
    {
        "content": "<p>Let's say we've declared <code>name_poly_vars R[x]</code> and <code>name_poly_vars S[y]</code>. Then if I write <code>R[y]</code>, this will be valid syntax, but there won't be a macro for it, and no elaborator, so it will give a silly error message. Do we need an elaborator that just throws an error, as a fall-back in this case?</p>",
        "id": 540021137,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758117084
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"#check_poly_var \"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"c1\">-- local syntax \"t\" : poly_var</span>\n<span class=\"c1\">-- local macro_rules | `($head[t]) =&gt; `(Polynomial $head)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#asdf \"</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabSyntax</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nv</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testElab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"triggered\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">false</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- local syntax \"x\" : poly_var</span>\n<span class=\"c1\">-- local macro_rules | `(R[x]) =&gt; `(Polynomial R)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">asdf</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span>\n<span class=\"c1\">-- error: expected no space before</span>\n</code></pre></div>",
        "id": 540023099,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758117546
    },
    {
        "content": "<p>I'm getting a strange error message here...</p>",
        "id": 540023120,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758117550
    },
    {
        "content": "<p>it seems like the <code>term:max</code> approach fails to circumvent the existing get-index notation</p>",
        "id": 540023231,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758117575
    },
    {
        "content": "<p>but why did it work in the last code snippet i sent??</p>",
        "id": 540023397,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758117617
    },
    {
        "content": "<p>GetElem is max</p>",
        "id": 540023748,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758117714
    },
    {
        "content": "<p>so it seems like we're stuck with <code>term_decl</code> then?</p>",
        "id": 540023815,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758117731
    },
    {
        "content": "<p>(but then why did it work before?)</p>",
        "id": 540023987,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758117777
    },
    {
        "content": "<p>I think Lean may have special support \"left recursive\" syntax, such as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>",
        "id": 540024403,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758117887
    },
    {
        "content": "<p>i think <code>max+1</code> works</p>",
        "id": 540025330,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1758118112
    },
    {
        "content": "<p>(untested)</p>",
        "id": 540025369,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1758118121
    },
    {
        "content": "<p>...</p>",
        "id": 540025378,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118123
    },
    {
        "content": "<p>it's very \"infinity plus one\" vibes</p>",
        "id": 540025486,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1758118151
    },
    {
        "content": "<p>I tried, but I think it doesn't work. I think <code>max</code> and <code>max+1</code> behave the same.</p>",
        "id": 540025493,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758118152
    },
    {
        "content": "<p>no they behave differently</p>",
        "id": 540025656,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118171
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#asdf \"</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:(</span><span class=\"n\">max</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">var</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabSyntax</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">):</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">nv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">nv</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- local syntax \"x\" : poly_var</span>\n<span class=\"c1\">-- local macro_rules | `(R[x]) =&gt; `(Polynomial R)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">asdf</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span>\n<span class=\"c1\">-- error: unexpected token at this precedence level; consider parenthesizing the term</span>\n</code></pre></div>",
        "id": 540025771,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118195
    },
    {
        "content": "<p>the error message is different</p>",
        "id": 540025827,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118208
    },
    {
        "content": "<p>Oops, my bad. I guess it just rejects any synax then, haha</p>",
        "id": 540025923,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758118231
    },
    {
        "content": "<p>man working with meta is quite exhausting, there's like much less knowledge in the community than normal lean code, i think any mathematician would crash out if this was the situation in main mathlib</p>",
        "id": 540026200,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118294
    },
    {
        "content": "<p>if i was instead asking \"how to take the square root of e\" i would receive 10 correct answers by the next minute</p>",
        "id": 540026335,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118327
    },
    {
        "content": "<p>i feel like i'm restricted every step of the way</p>",
        "id": 540026517,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118373
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540023815\">said</a>:</p>\n<blockquote>\n<p>so it seems like we're stuck with <code>term_decl</code> then?</p>\n</blockquote>\n<p>It seems so</p>",
        "id": 540026652,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758118407
    },
    {
        "content": "<p>By the way, you can use <code>mkNode</code> and <code>mkAtom</code> instead of <code>.node</code> and <code>.atom</code> to avoid having to write <code>default</code>.</p>",
        "id": 540027054,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758118502
    },
    {
        "content": "<p>thanks</p>",
        "id": 540027410,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758118596
    },
    {
        "content": "<p>/me has now realised that if <code>term:max</code> doesn't work then the double quotation tech <code>$$head</code> would also not work...</p>",
        "id": 540044043,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758122527
    },
    {
        "content": "<p>lemme cook up an mwe...</p>",
        "id": 540047813,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758123562
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"sd\">/-- An unambiguous term declaration, which is `_`, an identifier, or a term enclosed in brackets -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term_decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hole</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- A type synonym for a term declaration, used to avoid ambiguity in the syntax. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">TermDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``term_decl</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term_decl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">hole</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">hole</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">default</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"c1\">-- error: unexpected identifier; expected command</span>\n</code></pre></div>",
        "id": 540048247,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758123670
    },
    {
        "content": "<p>it seems like trying to interpret any <code>term_decl</code> as a <code>term</code> somehow breaks everything</p>",
        "id": 540048290,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758123683
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> could you help me here?</p>",
        "id": 540048325,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758123694
    },
    {
        "content": "<p>to see why this is needed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"sd\">/-- An unambiguous term declaration, which is `_`, an identifier, or a term enclosed in brackets -/</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term_decl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hole</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- A type synonym for a term declaration, used to avoid ambiguity in the syntax. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">TermDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">``term_decl</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">term_decl</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">:</span><span class=\"n\">term_decl</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">head</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">Application type mismatch: The argument</span>\n<span class=\"cm\">  head</span>\n<span class=\"cm\">has type</span>\n<span class=\"cm\">  TSyntax `term_decl</span>\n<span class=\"cm\">but is expected to have type</span>\n<span class=\"cm\">  TSyntax `term</span>\n<span class=\"cm\">in the application</span>\n<span class=\"cm\">  head.raw</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">td</span><span class=\"o\">:</span><span class=\"n\">term_decl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">td</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">hole</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">hole</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">k</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">tm</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">default</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">fib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"c1\">-- error: unexpected identifier; expected command</span>\n</code></pre></div>",
        "id": 540050862,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758124294
    },
    {
        "content": "<p>Interpreting <code>term_decl</code> as <code>term</code> seems like a very bad idea to me.</p>",
        "id": 540053266,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758124953
    },
    {
        "content": "<p>what's the safe way to do that?</p>",
        "id": 540053339,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758124974
    },
    {
        "content": "<p>honestly i don't know why this is happening in the first place, why can Lean only interpret <code>x[y]</code> one way?</p>",
        "id": 540053768,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758125102
    },
    {
        "content": "<p>why can't lean see <code>x[y]</code> and try both getelems and polynomial?</p>",
        "id": 540053802,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758125111
    },
    {
        "content": "<p>like i want to use <code>term:max</code> but this clash is making it not possible</p>",
        "id": 540053871,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758125128
    },
    {
        "content": "<p>I would define a function <code>TermDecl → Term</code>, and run that manually.</p>",
        "id": 540053898,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758125136
    },
    {
        "content": "<p>that's what i did the first time, but it doesn't work with <code>$head</code> because it doesn't match any of the three cases</p>",
        "id": 540053979,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758125158
    },
    {
        "content": "<p>I think we saw above that it is possible to use <code>term</code> for <code>R[t]</code> notation, but that we can't use it for the <code>name_poly_vars</code> command itself.</p>",
        "id": 540054134,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758125202
    },
    {
        "content": "<p>ok lemme calm my nerves and try again</p>",
        "id": 540056469,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758125922
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> you are correct!</p>",
        "id": 540057941,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758126466
    },
    {
        "content": "<p>do you know why this is the case?</p>",
        "id": 540057986,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758126483
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540024403\">said</a>:</p>\n<blockquote>\n<p>I think Lean may have special support \"left recursive\" syntax, such as</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I think it is because the left-recursiveness doing something special</p>",
        "id": 540058313,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758126601
    },
    {
        "content": "<p>why does it work where it works then</p>",
        "id": 540058778,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758126769
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> i'm still getting strange errors after switching to <code>term:max</code></p>",
        "id": 540062532,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128050
    },
    {
        "content": "<p>i can't quite minimalise it but basically in random places in my file i get the error <code>expected no space before</code></p>",
        "id": 540062614,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128077
    },
    {
        "content": "<p>the relevant part of my code is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">polyesque_notation</span><span class=\"bp\">+</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>",
        "id": 540062712,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128113
    },
    {
        "content": "<p>I see, I guess it might not work after all. I've been trying to get it to work even with using <code>term_decl</code> and I'm in the mud with all these quotations of quotations.</p>",
        "id": 540063385,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758128370
    },
    {
        "content": "<p>the fallback i have in my head is that given an input <code>#asdf _[t]</code> i would manually declare the syntax three times for each case of <code>term_decl</code></p>",
        "id": 540063592,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128454
    },
    {
        "content": "<p>so i would do:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 540063691,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128491
    },
    {
        "content": "<p>Oh, that seems not too bad actually</p>",
        "id": 540063741,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758128506
    },
    {
        "content": "<p>well but that means I need to repeat code three times</p>",
        "id": 540063766,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128518
    },
    {
        "content": "<p>or i guess not really but like</p>",
        "id": 540063792,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128525
    },
    {
        "content": "<p>this feels really suboptimal</p>",
        "id": 540063829,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128540
    },
    {
        "content": "<p>For the term, we don't even want the <code>_[t]</code> case</p>",
        "id": 540063854,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758128548
    },
    {
        "content": "<p>i think it's fine, like i think <code>(foo : _[t])</code> should be legal</p>",
        "id": 540063931,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128574
    },
    {
        "content": "<p>if lean already knows <code>foo : Polynomial (Fin 37)</code></p>",
        "id": 540063997,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128601
    },
    {
        "content": "<p>But if Lean already knows it, then why write the type annotation?</p>",
        "id": 540064143,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758128658
    },
    {
        "content": "<p>i don't really see the harm in permitting that</p>",
        "id": 540064242,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128707
    },
    {
        "content": "<p>If we had <code>declare_poly_vars Nat[t]</code>, then should <code>_[t]</code> mean the same as <code>Nat[t]</code>?</p>",
        "id": 540064585,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758128763
    },
    {
        "content": "<p>no</p>",
        "id": 540064614,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128773
    },
    {
        "content": "<p>the special support only happens when you use <code>_</code> in the command</p>",
        "id": 540064690,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128796
    },
    {
        "content": "<p>Why not, Lean already has the information that <code>t</code> is a polynomial variable over <code>Nat</code>, so <code>_[t]</code> is uniquely determined to mean the name as <code>Nat[t]</code>. Or are you saying that this syntax won't be allowed?</p>",
        "id": 540064832,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758128858
    },
    {
        "content": "<p>i don't plan to add it</p>",
        "id": 540064864,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758128874
    },
    {
        "content": "<p>This might be off-base, but have you tried wrapping <code>polyesque</code> (at one level or another) in <code>atomic()</code>? (The idea being that we want to insist on “full” backtracking if <code>polyesque</code> is attempted and fails.)</p>\n<p>(This isn’t based on much more than seeing an intermediate error at the top level when unexpected, and might be redundant or the “wrong” solution if splitting into cases works; apologies, I’m on mobile at the moment. Just wanted to mention it in case it’s relevant. :) )</p>",
        "id": 540066337,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758129493
    },
    {
        "content": "<p>thanks for the suggestion</p>",
        "id": 540066481,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758129545
    },
    {
        "content": "<p>Looking in mathlib, I found this syntax, which looks promisingly similar to what we want:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inherit_doc</span><span class=\"w\"> </span><span class=\"n\">OreLocalization</span><span class=\"kd\">]</span>\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">1075</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"⁻¹\"</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">S</span><span class=\"bp\">⁻¹</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">``</span><span class=\"o\">(</span><span class=\"n\">OreLocalization</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>(Though I wouldn't know where the <code>atomic</code> is supposed to go in general)</p>",
        "id": 540066968,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758129754
    },
    {
        "content": "<p>1075 looks like a  hack</p>",
        "id": 540067061,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758129781
    },
    {
        "content": "<p>hmm, it is larger than <code>max</code>, so I think it should just be <code>max</code> <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 540067522,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758129897
    },
    {
        "content": "<p>Also the first <code>term</code> should probably be <code>term:max</code> instead, but I think this notation hasn't been stress tested/used enough for that</p>",
        "id": 540067910,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758130034
    },
    {
        "content": "<p>Also, there is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">inherit_doc</span><span class=\"w\"> </span><span class=\"n\">AddMonoidAlgebra</span><span class=\"kd\">]</span>\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>\n<p>which doesn't even use <code>atomic</code> (but it is scoped)</p>",
        "id": 540068701,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758130257
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540063691\">said</a>:</p>\n<blockquote>\n<p>so i would do:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">))</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>update: this approach now works!</p>",
        "id": 540068772,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758130280
    },
    {
        "content": "<p>You can drop the brackets in the last line right?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540068948,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758130336
    },
    {
        "content": "<p>i suppose theoretically it is possible, i just wanted to be safer lol</p>",
        "id": 540069008,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758130364
    },
    {
        "content": "<p>Oh right, it will technically work, but could look a bit weird</p>",
        "id": 540069082,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758130392
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> i've pushed the new refactored code, i basically <a href=\"https://github.com/leanprover-community/mathlib4/pull/28349/files/c12e82d5decc011fadd6afbca5c029b734676033..6de7ba21bea79d08b1ca31b05b9d6429499b5c6a\">touched 90% of the lines</a></p>",
        "id": 540070891,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758130971
    },
    {
        "content": "<p>i'll get to your comments now but in the meantime you can also have a look again if you would like to</p>",
        "id": 540070938,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758130989
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> has marked this topic as resolved.</p>",
        "id": 540076302,
        "sender_full_name": "Notification Bot",
        "timestamp": 1758132936
    },
    {
        "content": "<p>huh?</p>",
        "id": 540076356,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758132955
    },
    {
        "content": "<p>Sorry I didn't want to mark it as solved</p>",
        "id": 540076382,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1758132965
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> has marked this topic as unresolved.</p>",
        "id": 540076421,
        "sender_full_name": "Notification Bot",
        "timestamp": 1758132983
    },
    {
        "content": "<p>The linter is complaining that the <code>repr</code> functions have an unused <code>prec : Nat</code> argument. How do I disable the linter?</p>",
        "id": 540089815,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758137943
    },
    {
        "content": "<p>take a <code>_ : Nat</code> argument instead?</p>",
        "id": 540090347,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758138132
    },
    {
        "content": "<p>For simpNF, we use the <code>@[nolint simpNF]</code> attribute. I presume the same could work here, to tag those declarations. I think this is a new issue since the new toolchain.</p>",
        "id": 540090369,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758138140
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> they are auto generated using <code>deriving Repr</code></p>",
        "id": 540090395,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758138150
    },
    {
        "content": "<p>oh no</p>",
        "id": 540090404,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758138155
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> is there a solution without importing <code>Batteries.Tactic.Lint.Basic</code>?</p>",
        "id": 540090616,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758138235
    },
    {
        "content": "<p>Probably not. You can add a comment to the import that it is a workaround</p>",
        "id": 540091000,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758138373
    },
    {
        "content": "<p>do you know anyone who might be interested to solve this issue?</p>",
        "id": 540091094,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758138403
    },
    {
        "content": "<p>Well, or just not deriving Repr :)</p>",
        "id": 540091115,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758138410
    },
    {
        "content": "<p>that works for me</p>",
        "id": 540091208,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758138443
    },
    {
        "content": "<p>It seems likely someone has taken a look at the problem or filed an issue already given how easy it is to encounter <span aria-label=\"man shrugging\" class=\"emoji emoji-1f937-200d-2642\" role=\"img\" title=\"man shrugging\">:man_shrugging:</span></p>",
        "id": 540091493,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758138548
    },
    {
        "content": "<p>well, it's also likely that the repr deriver is in core and the lint is in batteries and they have conflicting interests</p>",
        "id": 540091609,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758138596
    },
    {
        "content": "<p>Do we have a strategy for delaborating these notations? The problem is that there are not enough explicit arguments to figure out the types of the terms, so on the syntax level, we can't figure out which polynomial variable we are supposed to use.</p>",
        "id": 540110097,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758147203
    },
    {
        "content": "<p>I don't even know how that would be done in theory, last time we looked into this we pretty much gave up, I don't think there's a way to 1. make a delaborator trigger conditionally (as opposed to triggered by every instance of <code>vecCons</code>), and 2. make it match on a declared free variable (need to make it output <code>true</code> for <code>Polynomial R</code> but <code>false</code> for <code>Polynomial Nat</code>, where <code>R</code> is introduced as <code>variable (R : Type)</code>)</p>",
        "id": 540110371,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758147348
    },
    {
        "content": "<p>consider the following challenge:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"o\">[</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">here</span><span class=\"o\">]</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"c1\">-- R[t]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial S</span>\n</code></pre></div>",
        "id": 540110565,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758147465
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> can you add code to the <code>[insert code here]</code> so that the two <code>#check</code> commands output the thing in the comment?</p>",
        "id": 540110604,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758147490
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> can you PR to my PR?</p>",
        "id": 540112516,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758148606
    },
    {
        "content": "<p>Here's a solution:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"c1\">-- @[app_unexpander Polynomial]</span>\n<span class=\"c1\">-- def bar : Lean.PrettyPrinter.Unexpander</span>\n<span class=\"c1\">--   | `($_ $nat:ident) =&gt; match nat with</span>\n<span class=\"c1\">--     | `(Nat) =&gt; `($nat:ident[t])</span>\n<span class=\"c1\">--     | _ =&gt; throw ()</span>\n<span class=\"c1\">--   | _ =&gt; throw ()</span>\n\n<span class=\"c1\">-- #check Polynomial Nat -- Nat[t]</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"declare\"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$_</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"c1\">-- R[t]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial S</span>\n</code></pre></div>",
        "id": 540113099,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758148944
    },
    {
        "content": "<p>interesting</p>",
        "id": 540113185,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149002
    },
    {
        "content": "<p>looks like we can once again avoid env ext!</p>",
        "id": 540113197,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149013
    },
    {
        "content": "<p>is that stackable?</p>",
        "id": 540113227,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149030
    },
    {
        "content": "<p>it is!</p>",
        "id": 540113289,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149074
    },
    {
        "content": "<p>It should probably be marked private/local</p>",
        "id": 540113338,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758149109
    },
    {
        "content": "<p>I was about to ask, how does it work at all? I do <code>#check foo</code> and it doesn't show anything</p>",
        "id": 540113384,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149133
    },
    {
        "content": "<p>yeah looks like anything eval'ed is passed through some hygiene</p>",
        "id": 540113443,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149181
    },
    {
        "content": "<p>Yes it gets some hygienic macro scope attached to <code>foo</code></p>",
        "id": 540113531,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758149248
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540113338\">said</a>:</p>\n<blockquote>\n<p>It should probably be marked private/local</p>\n</blockquote>\n<p><code>@[local app_unexpander Polynomial]</code> seems to do the trick</p>",
        "id": 540113594,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758149287
    },
    {
        "content": "<p>Although there is no harm in also making it a <code>private def</code></p>",
        "id": 540113719,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758149370
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"declare \"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$_</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"declare' \"</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$_</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">S</span>\n<span class=\"n\">declare'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"c1\">-- R[t]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"c1\">-- S[t]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial T</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"c1\">-- (Nat)[t]</span>\n</code></pre></div>",
        "id": 540113761,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149395
    },
    {
        "content": "<p>uh it seems to be not stackable the other way...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"declare' \"</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">)</span>\n\n<span class=\"n\">declare'</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"c1\">-- expected: (Nat)[t]</span>\n<span class=\"c1\">-- actual: Polynomial (Polynomial Nat)</span>\n</code></pre></div>",
        "id": 540114011,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149542
    },
    {
        "content": "<p>It seems to work if you split the matching up. Maybe it hasn't inserted parentheses yet in the syntax at this point.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"declare' \"</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"w\">          </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Also using <code>u</code> to mean two things here is quite confusing.</p>",
        "id": 540114619,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758149940
    },
    {
        "content": "<p>oh no, custom matching...</p>",
        "id": 540114712,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758149994
    },
    {
        "content": "<p>how do i make it match n times?</p>",
        "id": 540114752,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150005
    },
    {
        "content": "<p>Recursively construct the above syntax? <span aria-label=\"melting face\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melting face\">:melting_face:</span></p>",
        "id": 540115123,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758150214
    },
    {
        "content": "<p>this is all quite cursed</p>",
        "id": 540115151,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758150230
    },
    {
        "content": "<p>right, it's just a function <code>Syntax -&gt; PrettyPrinter.UnexpandM Syntax</code> right</p>",
        "id": 540115157,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150234
    },
    {
        "content": "<p>i can builid any function i want</p>",
        "id": 540115175,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150244
    },
    {
        "content": "<p>yes you can</p>",
        "id": 540115198,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758150257
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540114619\">said</a>:</p>\n<blockquote>\n<p>It seems to work if you split the matching up. Maybe it hasn't inserted parentheses yet in the syntax at this point.</p>\n</blockquote>\n<p>I think I want to understand this more first.</p>",
        "id": 540115558,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150456
    },
    {
        "content": "<p>is there no way to put in parentheses that are not supposed to be part of syntax?</p>",
        "id": 540115592,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150480
    },
    {
        "content": "<p>also is there anyway to put debugging things inside Unexpander? it's complaining failed to synthesize<br>\n  MonadTrace PrettyPrinter.UnexpandM</p>",
        "id": 540115822,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150638
    },
    {
        "content": "<p>what I do is I put the thing I want into the output syntax</p>",
        "id": 540115856,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758150660
    },
    {
        "content": "<p>ah right ok that works</p>",
        "id": 540115892,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150680
    },
    {
        "content": "<p>If you can construct the syntax without parentheses in the syntax, then you can do it without nested <code>match</code>es. For example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"declare' \"</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$$</span><span class=\"n\">u</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540115939,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758150709
    },
    {
        "content": "<p>oh god</p>",
        "id": 540115993,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150737
    },
    {
        "content": "<p>yeah actually i think i can do that</p>",
        "id": 540116026,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150757
    },
    {
        "content": "<p>i think it's exactly the functor that i already have</p>",
        "id": 540116037,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758150768
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> well there's a side effect that I need to obtain the functor as an <code>ident</code> in order to use it in <code>@[app_unexpander Polynomial]</code> but currently I take in the functor (e.g. <code>MvPolynomial</code>) as a <code>term</code></p>",
        "id": 540117781,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758151897
    },
    {
        "content": "<p>this is because <code>MvPowerSeries.C</code> used to take in an extra argument so it had to be passed in as <code>(MvPowerSeries.C _)</code> (fixed a month ago)</p>",
        "id": 540117816,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758151923
    },
    {
        "content": "<p>like, i'm sure it's fine with the current 6 functors (lol) that their functors are actually usable as ident</p>",
        "id": 540117891,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758151979
    },
    {
        "content": "<p>What do you mean with taking the functor as an <code>ident</code>?</p>",
        "id": 540117963,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152021
    },
    {
        "content": "<p>so currently the syntax is <code>register_poly_vars \"[\" \"]\" Polynomial Polynomial.C Polynomial.X</code></p>",
        "id": 540118007,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152049
    },
    {
        "content": "<p>the <code>@[app_unexpander foobar]</code> syntax expects <code>foobar</code> to be an <code>ident</code></p>",
        "id": 540118024,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758152058
    },
    {
        "content": "<p>the <code>Polynomial</code> there is taken in as a <code>term:max</code> currently</p>",
        "id": 540118025,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152060
    },
    {
        "content": "<p>If you think there are real use cases where it is not an ident, then I would suggest not implementing the unexpander for those cases. You can do a match to get the <code>ident</code> if it is an <code>ident</code>.</p>",
        "id": 540118222,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152177
    },
    {
        "content": "<p>i don't think there are real use cases where it is not an ident (idk how many more functors we'll get) but i guess it's a good idea to do the matching in any case</p>",
        "id": 540118282,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152214
    },
    {
        "content": "<p>are there more functors than the 6?</p>",
        "id": 540118310,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152232
    },
    {
        "content": "<p>The easier thing is to just ask for an <code>ident</code> directly. And also for <code>Polynomial.X</code> and <code>Polynomial.C</code></p>",
        "id": 540118361,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152265
    },
    {
        "content": "<p>as I explained earlier, that would not have worked one month ago</p>",
        "id": 540118390,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152282
    },
    {
        "content": "<p>Good thing it works now :)</p>",
        "id": 540118448,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152303
    },
    {
        "content": "<p>well...</p>",
        "id": 540118522,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152352
    },
    {
        "content": "<p>Which 6 are we talking about by the way? I knew about Polynomial, Powerseries and the multivariate versions</p>",
        "id": 540118525,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152353
    },
    {
        "content": "<p>R[t] ((mv) polynomial)<br>\nR[[t]] ((mv) power series)<br>\nR(t) (rat func)<br>\nR((t)) (laurent series)</p>",
        "id": 540118562,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152366
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RatFunc#doc\">docs#RatFunc</a></p>",
        "id": 540118574,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758152376
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LaurentSeries#doc\">docs#LaurentSeries</a></p>",
        "id": 540118592,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758152388
    },
    {
        "content": "<p>Ah right, so we have 4 * 2 = 8?</p>",
        "id": 540118658,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152428
    },
    {
        "content": "<p>last two have no mv version (yet)</p>",
        "id": 540118676,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152439
    },
    {
        "content": "<p>oh no</p>",
        "id": 540118684,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758152443
    },
    {
        "content": "<p>That sounds like missing API!</p>",
        "id": 540118719,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152468
    },
    {
        "content": "<p>it's not missing until someone needs them</p>",
        "id": 540118745,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758152488
    },
    {
        "content": "<p>btw will anyone complain if i leave the name of the unexpander as <code>foo</code></p>",
        "id": 540118760,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758152500
    },
    {
        "content": "<p>what are you naming <code>foo</code></p>",
        "id": 540118774,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758152511
    },
    {
        "content": "<p>can you name it something reasonable</p>",
        "id": 540118793,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758152524
    },
    {
        "content": "<p>It will be a <code>private def</code> and it will get macro scopes, but at least maybe give it a descriptive name like <code>unexpand</code>.</p>",
        "id": 540119249,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758152854
    },
    {
        "content": "<p>If you want to mimic how <code>notation</code> does it, then use <code>aux_def</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"declare\"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">aux_def</span><span class=\"w\"> </span><span class=\"n\">unexpand</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$_</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">id</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"o\">()))</span>\n</code></pre></div>",
        "id": 540119714,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758153168
    },
    {
        "content": "<p>so now my code works for polynomial but fails for polynomial, so i turned everything to string, the pattern in the unexpander is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">app</span>\n<span class=\"w\">     </span><span class=\"ss\">`Polynomial</span>\n<span class=\"w\">     </span><span class=\"o\">[(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">app</span>\n<span class=\"w\">       </span><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"ss\">`MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"ss\">`Fin._</span><span class=\"bp\">@.</span><span class=\"n\">MathlibTest</span><span class=\"bp\">.</span><span class=\"n\">NamePolyVars</span><span class=\"bp\">.</span><span class=\"m\">3111633584</span><span class=\"bp\">._</span><span class=\"n\">hygCtx</span><span class=\"bp\">._</span><span class=\"n\">hyg</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"s2\">\"2\"</span><span class=\"o\">)])])</span>\n<span class=\"w\">       </span><span class=\"o\">[(</span><span class=\"n\">ident</span><span class=\"bp\">.</span><span class=\"n\">antiquot</span><span class=\"w\"> </span><span class=\"s2\">\"$\"</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"ss\">`i._</span><span class=\"bp\">@.</span><span class=\"n\">MathlibTest</span><span class=\"bp\">.</span><span class=\"n\">NamePolyVars</span><span class=\"bp\">.</span><span class=\"m\">3111633584</span><span class=\"bp\">._</span><span class=\"n\">hygCtx</span><span class=\"bp\">._</span><span class=\"n\">hyg</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">antiquotName</span><span class=\"w\"> </span><span class=\"s2\">\":\"</span><span class=\"w\"> </span><span class=\"s2\">\"ident\"</span><span class=\"o\">))])])</span>\n</code></pre></div>\n<p>and the actual term to be matched is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"ss\">`Polynomial</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"ss\">`MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"ss\">`Fin</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"s2\">\"2</span><span class=\"se\">\\\"</span><span class=\"s2\">)]) `R])])</span>\n</code></pre></div>",
        "id": 540122269,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758154716
    },
    {
        "content": "<p>they kinda look the same, is <code>Fin</code> the problematic part? but the forward elaboration uses <code>Fin</code> too and there's no problem</p>",
        "id": 540122534,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758154896
    },
    {
        "content": "<p>how do I tell Lean that <code>Fin</code> is just <code>Fin</code>?</p>",
        "id": 540122701,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758155014
    },
    {
        "content": "<p>Does it work if you replace <code>Fin</code> by <code>$$_</code>?</p>",
        "id": 540122909,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758155141
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540122701\">said</a>:</p>\n<blockquote>\n<p>how do I tell Lean that <code>Fin</code> is just <code>Fin</code>?</p>\n</blockquote>\n<p>I think you can use <code>$(mkIdent ``Fin)</code></p>",
        "id": 540123150,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758155305
    },
    {
        "content": "<p>I haven't been reading all this, but: please don't overload or complicate the meaning of <code>[ ]</code>. These are for constructing lists, and getelem notation, and everyone else should be using other symbols.</p>",
        "id": 540124137,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758155972
    },
    {
        "content": "<p>but it's what mathematicians write on paper</p>",
        "id": 540124199,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758156008
    },
    {
        "content": "<p>i'm sure mathlib would disagree and say that it's the notation for polynomial</p>",
        "id": 540124206,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758156010
    },
    {
        "content": "<p>btw it's also used in OreLocalization and AddMonoidAlgebra</p>",
        "id": 540124318,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758156081
    },
    {
        "content": "<p>Note that this particular notation has to be turned on locally using a command, so there is no need to worry about it accidentally popping up in usual getelem notation. (Similarly with (Add)MonoidAlgebra and OreLocalization, which are scoped)</p>",
        "id": 540124440,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758156168
    },
    {
        "content": "<p>Yes, it's of course what we write on paper, but it's not what we should write in Lean. <span aria-label=\"woman shrugging\" class=\"emoji emoji-1f937-200d-2640\" role=\"img\" title=\"woman shrugging\">:woman_shrugging:</span></p>",
        "id": 540125525,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758156941
    },
    {
        "content": "<p>bruh i found out what caused the issue</p>",
        "id": 540193954,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758189524
    },
    {
        "content": "<p><code>Term.app a [b c]</code> doesn't match <code>Term.app (Term.app a [b]) [c]</code></p>",
        "id": 540194180,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758189589
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t₁₁</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₁₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Term.app (Term.app a [b]) [c]</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Term.app a [b c]</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpand</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"1\"</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"2\"</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"3\"</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"c1\">-- guess the output</span>\n</code></pre></div>",
        "id": 540194909,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758189806
    },
    {
        "content": "<p>minimised</p>",
        "id": 540194916,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758189809
    },
    {
        "content": "<p>great so now that's fixed, but now a new problem arised, it adds a dagger</p>",
        "id": 540195992,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190183
    },
    {
        "content": "<p>Where does it add a dagger?</p>",
        "id": 540196268,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758190304
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare\"</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"w\">    </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpand</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"3\"</span><span class=\"o\">))</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"c1\">-- R✝ : Type</span>\n</code></pre></div>",
        "id": 540196523,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190402
    },
    {
        "content": "<p>minimised</p>",
        "id": 540196528,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190403
    },
    {
        "content": "<p>further minimised:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpand</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"3\"</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"c1\">-- R✝ : Type</span>\n</code></pre></div>",
        "id": 540196857,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190513
    },
    {
        "content": "<p>I think this is why I had the double <code>match</code> in my version. I want to return the <code>R</code> form the <code>Polynomial R</code> syntax that the user wrote down. You are returning the <code>R</code> from the <code>#declare</code> command.</p>",
        "id": 540196937,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758190540
    },
    {
        "content": "<p>aha ok so this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpand</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"2\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"3\"</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"c1\">-- R : Type</span>\n</code></pre></div>",
        "id": 540197190,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190624
    },
    {
        "content": "<p>right i guess i understand why you need to match twice</p>",
        "id": 540197232,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190638
    },
    {
        "content": "<p>But don't match on <code>Polynomial</code>:</p>\n<blockquote>\n<p>Unexpanders should match the function name against an antiquotation <code>$_</code> so as to be independent of the specific pretty printing of the name.</p>\n<p>Note: This linter can be disabled with <code>set_option linter.suspiciousUnexpanderPatterns false</code></p>\n</blockquote>\n<p>I don't know why the linter warning disappears when you use <code>local app_unexpander</code></p>",
        "id": 540197633,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758190776
    },
    {
        "content": "<p>yeah i saw that warning but it's a little bit more complicated to change it to <code>$_</code></p>",
        "id": 540197738,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190815
    },
    {
        "content": "<p>Really? Why so?</p>",
        "id": 540197783,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758190837
    },
    {
        "content": "<p>You mean because of nesting..?</p>",
        "id": 540197802,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758190847
    },
    {
        "content": "<p>it's not impossible, it's just more code</p>",
        "id": 540197845,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190865
    },
    {
        "content": "<p>everything you see here is dynamically generated</p>",
        "id": 540197866,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190874
    },
    {
        "content": "<p>and i don't see people changing <code>Polynomial</code></p>",
        "id": 540197905,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758190891
    },
    {
        "content": "<p>The real issue is the nesting, because in <code>Polynomial (Polynomial _)</code> I think we really do need to match on the second <code>Polynomial</code></p>",
        "id": 540198051,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758190954
    },
    {
        "content": "<p>Well I guess this <em>could</em> be a concern:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"c1\">-- doesn't trigger unexpander when matching on `Polynomial`</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">root_</span><span class=\"bp\">.</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"c1\">-- _root_.Polynomial R : Type</span>\n</code></pre></div>\n<p>but really, this will probably not be relevant</p>",
        "id": 540198235,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758191038
    },
    {
        "content": "<p>i mean, the warning is also very specific, there are other ways to change the pretty printing other than just changing the initial constant?</p>",
        "id": 540198404,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758191104
    },
    {
        "content": "<p>Well, when using <code>app_unexpander</code> I believe it guarantees that you get an <code>app</code> node with all of the explicit arguments. The individual arguments may be pretty-printed in any weird way though, yes</p>",
        "id": 540198828,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758191266
    },
    {
        "content": "<p>Well, it also gets messed up by <code>set_option pp.explicit true</code>. But I don't think that's a problem</p>",
        "id": 540199104,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758191387
    },
    {
        "content": "<p>maybe that's a feature!</p>",
        "id": 540199156,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758191407
    },
    {
        "content": "<p>It does have the funny side effect that <code>Polynomial (R : Type) [Semiring R] : Type</code> and <code>Polynomial (R : Type) : Type</code> behave differently in this scenario.</p>",
        "id": 540199503,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758191543
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> I have pushed the unexpander. Not sure if you missed the previous message, but could you please PR to my PR?</p>",
        "id": 540199699,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758191621
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540199503\">said</a>:</p>\n<blockquote>\n<p>It does have the funny side effect that <code>Polynomial (R : Type) [Semiring R] : Type</code> and <code>Polynomial (R : Type) : Type</code> behave differently in this scenario.</p>\n</blockquote>\n<p>I've added <code>Semiring</code> to the tests</p>",
        "id": 540200260,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758191828
    },
    {
        "content": "<p>Here's the PR: <a href=\"https://github.com/kckennylau/mathlib4/pull/14\">https://github.com/kckennylau/mathlib4/pull/14</a></p>",
        "id": 540201671,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758192398
    },
    {
        "content": "<p>thanks!</p>",
        "id": 540201691,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758192408
    },
    {
        "content": "<p>(I'll work out the merge conflict)</p>",
        "id": 540203446,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758192995
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540199104\">schrieb</a>:</p>\n<blockquote>\n<p>Well, it also gets messed up by <code>set_option pp.explicit true</code>. But I don't think that's a problem</p>\n</blockquote>\n<p>Doesn't it just <em>not</em> use unexpanders with <code>pp.explicit</code>?</p>",
        "id": 540204920,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758193455
    },
    {
        "content": "<p>Oh yeah you're right</p>",
        "id": 540205102,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758193521
    },
    {
        "content": "<p>Here's another: <a href=\"https://github.com/kckennylau/mathlib4/pull/15\">https://github.com/kckennylau/mathlib4/pull/15</a></p>",
        "id": 540211603,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758195794
    },
    {
        "content": "<p>thanks!</p>",
        "id": 540212876,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196220
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> uh... why do you want to ban <code>_[x,y]</code>?</p>",
        "id": 540213343,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196367
    },
    {
        "content": "<p>I want to ban if from the unexpander, because I don't think that the pretty printer will ever produce a <code>_</code>.</p>",
        "id": 540213449,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758196411
    },
    {
        "content": "<p>Also, for the <code>_</code> in the macro for <code>_[x,y]</code>, I made it so that the newly produced syntax contains the same <code>_</code> as the original <code>_[x,y]</code> syntax, which is better for hover information</p>",
        "id": 540213580,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758196461
    },
    {
        "content": "<p>your PR contains</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elabMacroRulesAndTrace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">polyesque</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$$</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"n\">hole</span><span class=\"bp\">$</span><span class=\"n\">body</span><span class=\"o\">:</span><span class=\"n\">polyesque_notation</span><span class=\"bp\">*</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"n\">hole</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 540213893,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196571
    },
    {
        "content": "<p>you changed the expander too</p>",
        "id": 540213980,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196598
    },
    {
        "content": "<p>Oh oops</p>",
        "id": 540213991,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758196603
    },
    {
        "content": "<p>also, are all holes the same? (are all electrons the same?)</p>",
        "id": 540214251,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196680
    },
    {
        "content": "<p>When you hover over a hole, you can often see how it was filled in by Lean, which is very useful :)</p>",
        "id": 540214427,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758196736
    },
    {
        "content": "<p>hmm i never knew that</p>",
        "id": 540214512,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196758
    },
    {
        "content": "<p>oh wow it does work!</p>",
        "id": 540214686,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196802
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Tn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Tn</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>",
        "id": 540214753,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196821
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540213449\">said</a>:</p>\n<blockquote>\n<p>I want to ban if from the unexpander, because I don't think that the pretty printer will ever produce a <code>_</code>.</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpand</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Quote</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{x}\"</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"c1\">-- \"(Term.app `Polynomial [(Term.syntheticHole \\\"?\\\" `m.1)])\" : Type</span>\n</code></pre></div>",
        "id": 540215396,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196984
    },
    {
        "content": "<p>is this a hole?</p>",
        "id": 540215406,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758196987
    },
    {
        "content": "<p>No, <code>?m.1</code> is not a syntactic hole. A syntactic hole is just <code>_</code>.</p>",
        "id": 540215717,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758197076
    },
    {
        "content": "<p>interesting</p>",
        "id": 540215794,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758197100
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_unexpander</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unexpand</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Unexpander</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h</span><span class=\"o\">:</span><span class=\"n\">hole</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Quote</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"h: {h}\"</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Quote</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"i: {i}\"</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Quote</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"t: {t}\"</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Quote</span><span class=\"bp\">.</span><span class=\"n\">quote</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"x: {x}\"</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"c1\">-- \"t: (Term.syntheticHole \\\"?\\\" `m.1)\" : Type</span>\n</code></pre></div>",
        "id": 540216048,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758197160
    },
    {
        "content": "<p>yep you're right</p>",
        "id": 540216058,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758197162
    },
    {
        "content": "<p>it would be very funny to see <code>(?m.1)[t]</code> though</p>",
        "id": 540216123,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758197174
    },
    {
        "content": "<p>I'm testing it and seeing <code>(?m.145 this✝² this✝¹ this✝ this)[a,b][C] = (?m.147 this✝² this✝¹ this✝ this)[a,b][C]</code> :)</p>",
        "id": 540216206,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758197199
    },
    {
        "content": "<p>I think the last main challenge is to get the delaborator for the polynomial variables to work. It would be great if we could do this in the same way as with the polynomial types. But the problem is that there is some information missing in the syntax.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span>\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">[</span><span class=\"n\">y</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : R[x]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : S[y]</span>\n</code></pre></div>\n<p>As you can see, <code>x</code> and <code>y</code> are currently printed the same by the pretty printer.</p>\n<p>So we will need to write a <code>delab</code> instead of a <code>app_unexpander</code>. I imagine it like this:</p>\n<ol>\n<li>Delaborate the term as usual</li>\n<li>Delaborate the type of the term</li>\n<li>Do a match with the syntax of the term and the type. If it matches one of the declared variables, then return that variable. Otherwise return the term syntax.</li>\n</ol>\n<p>This delaborator would be tagged with <code>@[app_delab Polynomial.X]</code> and <code>@[app_delab Polynomial.C]</code> and friends.</p>",
        "id": 540222199,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758198938
    },
    {
        "content": "<p>are <code>Polynomial.X</code> and <code>R[x]</code> treated separately?</p>",
        "id": 540222550,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199045
    },
    {
        "content": "<p>In what sense?</p>",
        "id": 540222818,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758199123
    },
    {
        "content": "<p>well i see them together in the <code>#check</code> output</p>",
        "id": 540222875,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199139
    },
    {
        "content": "<p><code>Polynomial.X</code> is what it delaborates to. <code>R[x]</code> is what the type delaborates to.</p>",
        "id": 540222963,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758199162
    },
    {
        "content": "<p>hmm...</p>",
        "id": 540222995,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199176
    },
    {
        "content": "<p>so how do you access the type?</p>",
        "id": 540223029,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199187
    },
    {
        "content": "<p>i guess u need to use <code>inferType</code> etc?</p>",
        "id": 540223142,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199224
    },
    {
        "content": "<p>In a delaborator, you get access to the <code>Expr</code>, so you can do <code>inferType</code>. Then we can delaborate both it and its type.</p>",
        "id": 540223145,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758199224
    },
    {
        "content": "<p>how do delab and unexpander interact?</p>",
        "id": 540223226,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199254
    },
    {
        "content": "<p><code>delab</code> happens first, and then the unexpanders</p>",
        "id": 540223307,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758199284
    },
    {
        "content": "<p>delab is Expr -&gt; Syntax?</p>",
        "id": 540223359,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199298
    },
    {
        "content": "<p>Exactly</p>",
        "id": 540223396,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758199304
    },
    {
        "content": "<p>then why don't we use delab for R[x,y] too?</p>",
        "id": 540223451,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758199319
    },
    {
        "content": "<p>You mentioned earlier that you want this stuff to operate on the syntax level and not on the expression level. So this is what is most convenient with that constraint.</p>\n<p>I could also imagine an implementation where we would do some <code>Expr</code> matching instead of <code>Syntax</code> matching, which would then live naturally in a <code>delab</code></p>",
        "id": 540223996,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758199456
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> can we import <code>Batteries.Tactic.Lint.Misc</code> instead of <code>Mathlib.Init</code>?</p>",
        "id": 540226043,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758200057
    },
    {
        "content": "<p>Every file in Mathlib has to import Mathlib.Init</p>",
        "id": 540226112,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758200081
    },
    {
        "content": "<p>then why didn't it complain before?</p>",
        "id": 540226197,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758200106
    },
    {
        "content": "<p>Maybe we don't have automation that checks this?</p>",
        "id": 540226304,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758200131
    },
    {
        "content": "<p>so what you said is like a policy that is not checked by CI?</p>",
        "id": 540226504,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758200182
    },
    {
        "content": "<p>Hmm, good question. I think it would be good to have a linter that checks that every file imports, or is imported by, <code>Mathlib.Init</code>.</p>",
        "id": 540226881,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758200285
    },
    {
        "content": "<p>also please check my comment on <a href=\"https://github.com/kckennylau/mathlib4/pull/15/files\">https://github.com/kckennylau/mathlib4/pull/15/files</a></p>",
        "id": 540226984,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758200318
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> I don't understand what's happening here, why is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>better than</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>?</p>",
        "id": 540234702,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758202331
    },
    {
        "content": "<p>Oh sorry, I think I messed that up</p>",
        "id": 540235567,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758202506
    },
    {
        "content": "<p>pushed a fix</p>",
        "id": 540236146,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758202628
    },
    {
        "content": "<p>thanks!</p>",
        "id": 540236279,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758202666
    },
    {
        "content": "<p>Should we also allow the space-separated syntax <code>name_poly_vars R[a,b][C] _[x,y,z]</code>?</p>",
        "id": 540241968,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758204064
    },
    {
        "content": "<p>uh... i don't know</p>",
        "id": 540242513,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758204215
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- the target type</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">typeE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"n\">typeE</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"c1\">-- todo: match `e` as well</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540245439,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758204953
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> hi i'm having problem here because TermElabM and DelabM are incompatible monads</p>",
        "id": 540245490,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758204966
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/q2mYm0MmmQjJsy2aOhSyDjjN/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/q2mYm0MmmQjJsy2aOhSyDjjN/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"825x310\" src=\"/user_uploads/thumbnail/3121/q2mYm0MmmQjJsy2aOhSyDjjN/image.png/840x560.webp\"></a></div>",
        "id": 540245582,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758204989
    },
    {
        "content": "<p>Well, we want to <code>delab</code> and not to <code>elab</code></p>",
        "id": 540245735,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205027
    },
    {
        "content": "<p>yes, but my strategy is to first elab <code> `(Polynomial Nat) </code> and see if it matches the given tyype of the given expression</p>",
        "id": 540245861,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205060
    },
    {
        "content": "<p>Oh huh, I see. My idea was to <code>delab</code> the type, and see if it matches with `(Polynomial Nat)</p>",
        "id": 540246035,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205106
    },
    {
        "content": "<p>that sounds bad</p>",
        "id": 540246106,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205123
    },
    {
        "content": "<p>as we saw earlier <code>(MvPolynomial (Fin 2)) R</code> and <code>MvPolynomial (Fin 2) R</code> are different syntaxes</p>",
        "id": 540246271,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205162
    },
    {
        "content": "<p>I thought you said a while ago that you didn't want to <code>elab</code> things because you wanted to do everything at the syntax level</p>",
        "id": 540246376,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205188
    },
    {
        "content": "<p>maybe syntax is just bad</p>",
        "id": 540246379,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205188
    },
    {
        "content": "<p>will it convert it to <code>Nat[t]</code>?</p>",
        "id": 540246516,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205224
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540246271\">said</a>:</p>\n<blockquote>\n<p>as we saw earlier <code>(MvPolynomial (Fin 2)) R</code> and <code>MvPolynomial (Fin 2) R</code> are different syntaxes</p>\n</blockquote>\n<p>But we know how to deal with this right? I.e. always use <code>MVPolynomial (Fin 2) R</code></p>",
        "id": 540246585,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205241
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540246516\">said</a>:</p>\n<blockquote>\n<p>will it convert it to <code>Nat[t]</code>?</p>\n</blockquote>\n<p>Oh that's a good point</p>",
        "id": 540246609,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205249
    },
    {
        "content": "<p>also how do i call the delaborator? to my surprise <code>Delab</code> is not defined as <code>Expr -&gt; DelabM Term</code></p>",
        "id": 540246738,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205283
    },
    {
        "content": "<p>but rather you need to access the Expr via <code>(&lt;- getExpr)</code></p>",
        "id": 540246776,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205294
    },
    {
        "content": "<p>Although I'm not sure now, since I said earlier that <code>delab</code> runs before the app unexpanders</p>",
        "id": 540246826,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205313
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540246376\">said</a>:</p>\n<blockquote>\n<p>you wanted to do everything at the syntax level</p>\n</blockquote>\n<p>I wanted to do <code>Syntax -&gt; CoreM Syntax</code> at the syntax level, but now we're building a function <code>Expr -&gt; DelabM Syntax</code> so it makes sense to do things at the Expr level? idk</p>",
        "id": 540247358,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205472
    },
    {
        "content": "<p>I think you can do <code>withType delab</code>, and it will give you the delaborated type.</p>",
        "id": 540247439,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205493
    },
    {
        "content": "<p>However to delaborate the expression itself, you want to just call <code>delab</code>, but that will cause an infinite loop...</p>",
        "id": 540247534,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205514
    },
    {
        "content": "<p>I just want to call <code>delab</code> with a custom <code>Expr</code></p>",
        "id": 540247694,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205548
    },
    {
        "content": "<p>I still feel like it makes sense to call elab rather than call delab</p>",
        "id": 540247820,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205583
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540247694\">said</a>:</p>\n<blockquote>\n<p>I just want to call <code>delab</code> with a custom <code>Expr</code></p>\n</blockquote>\n<p>It doesn't work like that, because the delaborator doesn't just create the <code>Syntax</code>, it also creates hover information, and this information is tied to locations in the <code>Expr</code>, and to locations in the <code>Syntax</code> and the monad keeps track of all of this.</p>",
        "id": 540248096,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205660
    },
    {
        "content": "<p>i mean intuitively i'm doing:</p>\n<ol>\n<li>given the expression to delaborate,</li>\n<li>check if <code>t</code> elaborates to the given expression (matching type)</li>\n<li>if yes, return <code>t</code></li>\n<li>otherwise use the default delaborator</li>\n</ol>",
        "id": 540248237,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205692
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540248096\">said</a>:</p>\n<blockquote>\n<p>It doesn't work like that</p>\n</blockquote>\n<p>ok, so surely it makes sense to elab?</p>",
        "id": 540248431,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205740
    },
    {
        "content": "<p>Are you planning to do <code>Expr</code> matching for both the expression itself and for its type?</p>",
        "id": 540248661,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205801
    },
    {
        "content": "<p>oh look <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/PrettyPrinter/Delaborator/Basic.html#Lean.PrettyPrinter.delab\">Lean.PrettyPrinter.delab</a> exists and is exactly what i'm looking for</p>",
        "id": 540248747,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205815
    },
    {
        "content": "<p>Because at that point, just doing <code>Expr</code> matching with the expression itself is enough</p>",
        "id": 540248982,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205871
    },
    {
        "content": "<p>how do i check if two <code>Term</code>s are the same?</p>",
        "id": 540249122,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758205901
    },
    {
        "content": "<p>The bad way would be <code>try elabCommand (← `(example : $stx1 = $stx2 := rfl))</code> <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 540249504,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758205997
    },
    {
        "content": "<p>well it looks like <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Meta/Defs.html#Lean.Syntax.structEq\">Lean.Syntax.structEq</a> is what i'm looking for and it's also the BEq instance</p>",
        "id": 540249612,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206027
    },
    {
        "content": "<p>nope that doesn't ignore hygiene</p>",
        "id": 540249968,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206116
    },
    {
        "content": "<p>maybe your way is the correct way</p>",
        "id": 540249994,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206123
    },
    {
        "content": "<p>Well that way is bad because we were explicitly trying to avoid elaboration</p>",
        "id": 540250125,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758206155
    },
    {
        "content": "<p>ah no i know how to do it now</p>",
        "id": 540250222,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206177
    },
    {
        "content": "<p>one of them is now an explicit pattern</p>",
        "id": 540250247,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206183
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">eT</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"c1\">-- the target type as an explicit pattern</span>\n<span class=\"w\">    </span><span class=\"c1\">-- todo: match `e` as well</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540250523,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206258
    },
    {
        "content": "<p>this works!</p>",
        "id": 540250542,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206263
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> are you happy with this code?</p>",
        "id": 540250579,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206269
    },
    {
        "content": "<p>How are you planning to make the <code>if let `(Polynomial Nat) := eTS then</code> work in general though?</p>",
        "id": 540250963,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758206371
    },
    {
        "content": "<p>i have that explicit pattern in general</p>",
        "id": 540251004,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206381
    },
    {
        "content": "<p>that's the <code>typeIdent</code></p>",
        "id": 540251020,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206385
    },
    {
        "content": "<p>But how does that deal with nested things like <code>Polynomial (MvPolynomial (Fin 4) _)</code>?</p>",
        "id": 540251338,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758206475
    },
    {
        "content": "<p>that is still one pattern</p>",
        "id": 540252144,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206669
    },
    {
        "content": "<p>Aha, I had thought that this would be a globally defined delaborator, but you want to generate one on the fly for each variable defined with <code>declare_poly_vars</code>.</p>",
        "id": 540252822,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758206810
    },
    {
        "content": "<p>yes</p>",
        "id": 540252866,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758206821
    },
    {
        "content": "<p>oh no trying to match <code>e</code> sends it to stackoverflow because delab calls this function again</p>",
        "id": 540253619,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207007
    },
    {
        "content": "<p>is there a way to tell delab to not call this function?</p>",
        "id": 540253658,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207016
    },
    {
        "content": "<p>A hacky way to accomplish this is to define a Boolean <code>Lean.Option</code> (like the ones used in <code>set_option</code>). Then it is false by default, but you set it to true when calling the delaborator recursively.</p>",
        "id": 540254256,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758207188
    },
    {
        "content": "<p>how do other applications do it?</p>",
        "id": 540254407,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207224
    },
    {
        "content": "<p>or is this cutting edge?</p>",
        "id": 540254476,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207240
    },
    {
        "content": "<p>The other applications use app unexpanders <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 540254569,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758207264
    },
    {
        "content": "<p>i think i'm running into brackets problems again, can i tell `() to not use brackets?</p>",
        "id": 540254833,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207331
    },
    {
        "content": "<p>You can use separate `() blocks, if that's what you mean. And then put the result of one in the other, so that you don't need to write brackets explicitly.</p>",
        "id": 540255147,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758207403
    },
    {
        "content": "<p>Essentially <code>$(← `(...))</code> is a way to write bracketless brackets</p>",
        "id": 540255379,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758207460
    },
    {
        "content": "<p>if i do that it tells me i can't use bind there; if i build the term before that it tells me redundant alternative</p>",
        "id": 540255458,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207479
    },
    {
        "content": "<p>The error about not being able to use <code>←</code> under binders can be fixed by moving the <code>←</code> to outside the binder</p>",
        "id": 540255673,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758207530
    },
    {
        "content": "<p>please have a look at the codes:</p>",
        "id": 540255812,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207561
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabC</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">eT</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₃</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₂</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t₃</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"c1\">-- the target type as an explicit pattern</span>\n<span class=\"w\">    </span><span class=\"c1\">-- if let `(Polynomial.X) := eS then</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"1\"</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- @[app_delab MvPolynomial.X] def delabA : Delab := do</span>\n\n<span class=\"c1\">-- Nat[a,b][c]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>\"redundant alternative\"</p>",
        "id": 540255839,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207567
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabC</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">eT</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₃</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₂</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"c1\">-- the target type as an explicit pattern</span>\n<span class=\"w\">    </span><span class=\"c1\">-- if let `(Polynomial.X) := eS then</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"1\"</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- @[app_delab MvPolynomial.X] def delabA : Delab := do</span>\n\n<span class=\"c1\">-- Nat[a,b][c]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>\"&lt;- over binder\"</p>",
        "id": 540256074,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207616
    },
    {
        "content": "<p><del>In the first option, I think you need to use double dollar signs:</del> No that seems wrong</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabC</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">eT</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₃</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₂</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$$</span><span class=\"n\">t₃</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"c1\">-- the target type as an explicit pattern</span>\n<span class=\"w\">    </span><span class=\"c1\">-- if let `(Polynomial.X) := eS then</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"1\"</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540256322,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758207670
    },
    {
        "content": "<p>then both tests don't match (return <code>\"1\"</code>)</p>",
        "id": 540256466,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207705
    },
    {
        "content": "<p>Ok, so I think in this example, you are going to have to split up the <code>match</code>/<code>if let</code> into multiple parts, because I don't know how to not but the brackets there. But when you will be automatically generating this delaborator, I think you won't have this issue, because you will create the syntax with no brackets.</p>",
        "id": 540257420,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758207931
    },
    {
        "content": "<p>I think with this approach the t3 etc cease to be patterns and are now Lean objects of <code>Term</code></p>",
        "id": 540257424,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207932
    },
    {
        "content": "<p>i see</p>",
        "id": 540257502,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758207947
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₃</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₂</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delabC</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">eT</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">t₃</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"c1\">-- the target type as an explicit pattern</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"s2\">\"1\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Command.elabCommand &lt;| ← `(command| #print delabC)</span>\n\n<span class=\"c1\">-- @[app_delab Polynomial.X] def delabC : Delab := do</span>\n<span class=\"c1\">--   let e ← SubExpr.getExpr</span>\n<span class=\"c1\">--   let eT ← Lean.Meta.inferType e</span>\n<span class=\"c1\">--   let eTS ← PrettyPrinter.delab eT</span>\n<span class=\"c1\">--   let t₁ ← `(Fin 2)</span>\n<span class=\"c1\">--   let t₂ ← `(MvPolynomial $t₁ Nat)</span>\n<span class=\"c1\">--   let t₃ ← `(Polynomial $t₂)</span>\n<span class=\"c1\">--   if let `($t₃) := eTS then -- the target type as an explicit pattern</span>\n<span class=\"c1\">--     -- if let `(Polynomial.X) := eS then</span>\n<span class=\"c1\">--     `(c)</span>\n<span class=\"c1\">--   else `(\"1\")</span>\n\n<span class=\"c1\">-- @[app_delab MvPolynomial.X] def delabA : Delab := do</span>\n\n<span class=\"c1\">-- Nat[a,b][c]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 540258427,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758208177
    },
    {
        "content": "<p>now Lean doesn't know what <code>Polynomial.X</code> is</p>",
        "id": 540258460,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758208185
    },
    {
        "content": "<p>the errors are getting stranger</p>",
        "id": 540258481,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758208189
    },
    {
        "content": "<p>\"<code>@[app_delab c]</code> first performs name resolution on <code>c</code> in the current scope.\"</p>",
        "id": 540260252,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758208664
    },
    {
        "content": "<p>it seems like this might be the problem</p>",
        "id": 540260276,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758208669
    },
    {
        "content": "<p>it might be impossible to define app_delab dynamically</p>",
        "id": 540260311,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758208679
    },
    {
        "content": "<p>You should use <code>$(mkIdent ``Polynomial.X)</code> instead of <code>Polynomial.X</code></p>",
        "id": 540271155,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758211408
    },
    {
        "content": "<p>Although it might work without the <code>mkIdent</code> when you already have the <code>ident</code> that was given by the user.</p>",
        "id": 540271529,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758211517
    },
    {
        "content": "<p>ah ok lemme try</p>",
        "id": 540295868,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758219541
    },
    {
        "content": "<p>is there a function that returns the \"head\" of a <code>Term</code> similar to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Expr.html#Lean.Expr.getAppFn\">Lean.Expr.getAppFn</a>?</p>",
        "id": 540296513,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758219770
    },
    {
        "content": "<p>Head as in head of an application? You can do that with usual syntax matching.</p>",
        "id": 540297699,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758220130
    },
    {
        "content": "<p>well <code>(a b) c</code> and <code>a b c</code> are considered different syntaxes</p>",
        "id": 540297789,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758220161
    },
    {
        "content": "<p>you'll need to do like recursive syntax matching</p>",
        "id": 540297816,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758220175
    },
    {
        "content": "<p>also <code>Term.app</code> doesn't seem to be a constructor</p>",
        "id": 540297831,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758220181
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getHead</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">$_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"get_head% \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">head</span>\n\n<span class=\"n\">get_head</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- A Nat Nat</span>\n<span class=\"n\">get_head</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- A</span>\n</code></pre></div>",
        "id": 540298978,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758220631
    },
    {
        "content": "<p>I can't get it to work if it has multiple arguments</p>",
        "id": 540299061,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758220662
    },
    {
        "content": "<p>Look at the signature of app</p>",
        "id": 540299208,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758220718
    },
    {
        "content": "<p>You need to match the many arguments</p>",
        "id": 540299240,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758220729
    },
    {
        "content": "<p>I also can't find out anything about <code>Term.app</code>, the only result on loogle is <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Parser/Term.html#Lean.Parser.Term.app\">Lean.Parser.Term.app</a> which i don't think it's the real <code>Term.app</code></p>",
        "id": 540299538,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758220844
    },
    {
        "content": "<p>I also can't match against <code>Term.app a b</code> directly</p>",
        "id": 540299560,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758220854
    },
    {
        "content": "<p>aha <code>repr</code> seems to return more info</p>",
        "id": 540299973,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221012
    },
    {
        "content": "<p>You should match with `($f $args*)</p>",
        "id": 540300064,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221045
    },
    {
        "content": "<p>The * is what <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> means with the many arguments</p>",
        "id": 540300139,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221077
    },
    {
        "content": "<p>aha, thanks!</p>",
        "id": 540300161,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221084
    },
    {
        "content": "<p>how could i have found this out on my own?</p>",
        "id": 540300257,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221119
    },
    {
        "content": "<p>Ehhh, by reading enough Lean source code I guess...</p>",
        "id": 540300339,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221152
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getHead</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">$_*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"get_head% \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">head</span>\n\n<span class=\"n\">get_head</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- A</span>\n<span class=\"n\">get_head</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- A</span>\n</code></pre></div>",
        "id": 540300485,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221202
    },
    {
        "content": "<p>so now this works -- do we have any use for it?</p>",
        "id": 540300510,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221211
    },
    {
        "content": "<p>Well that's what I wanted to ask - what do you need this for?</p>",
        "id": 540300578,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221241
    },
    {
        "content": "<p>dynamically find out the head of the term in order to build the corresponding delab/unexpander dynamically</p>",
        "id": 540300656,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221276
    },
    {
        "content": "<p>Oh, yeah that makes sense</p>",
        "id": 540300859,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221354
    },
    {
        "content": "<p>I was still thinking that we could switch to taking the <code>Polynomial.X</code> and <code>Polynomial.C</code> as <code>ident</code>, so then we could just use that <code>ident</code></p>",
        "id": 540300982,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221402
    },
    {
        "content": "<p>btw don't run the following code <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">binaryHell</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">binaryHell</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">binaryHell</span><span class=\"o\">))</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#explode\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span><span class=\"bp\">.</span><span class=\"n\">binaryHell</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">explode</span>\n</code></pre></div>",
        "id": 540301132,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221444
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540300982\">said</a>:</p>\n<blockquote>\n<p>I was still thinking that we could switch to taking the <code>Polynomial.X</code> and <code>Polynomial.C</code> as <code>ident</code>, so then we could just use that <code>ident</code></p>\n</blockquote>\n<p>well I would repeat the argument that this would not have worked one month ago</p>",
        "id": 540301282,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221501
    },
    {
        "content": "<p>(i.e. it seems less flexible)</p>",
        "id": 540301349,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221529
    },
    {
        "content": "<p>what's wrong with using <code>getHead</code>?</p>",
        "id": 540301372,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221538
    },
    {
        "content": "<p>Well and I would repeat the argument that it has been fixed one month ago, so we can use the fact that everything is good now...</p>",
        "id": 540301430,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221554
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540301372\">said</a>:</p>\n<blockquote>\n<p>what's wrong with using <code>getHead</code>?</p>\n</blockquote>\n<p>There's nothing wrong with it, but if we didn't need to then it would be less code.</p>",
        "id": 540301477,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221572
    },
    {
        "content": "<p>well what if someone in the future writes MvRatFunc.X with the wrong type signature</p>",
        "id": 540301527,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221590
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540301477\">said</a>:</p>\n<blockquote>\n<p>it would be less code</p>\n</blockquote>\n<p>you still need some code to figure out the head of each expression</p>",
        "id": 540301636,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221635
    },
    {
        "content": "<p>but now you're proposing to do it indirectly</p>",
        "id": 540301670,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221644
    },
    {
        "content": "<p>not from the term we built, but from the syntax that was passed in the command</p>",
        "id": 540301721,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221659
    },
    {
        "content": "<p>and not using a unified function, but by inspecting how we built the term</p>",
        "id": 540301789,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221686
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540301527\">said</a>:</p>\n<blockquote>\n<p>well what if someone in the future writes MvRatFunc.X with the wrong type signature</p>\n</blockquote>\n<p>Well they wouldn't, because we have made a decision on what the mathlib standard is. So if they have a compelling argument why it should be different, then we should change it everywhere, which I don't see happening anymore.</p>",
        "id": 540301798,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758221691
    },
    {
        "content": "<p>also morally <code>Polynomial</code> is not just a simple function, it also implicitly takes in <code>[Semiring R]</code>, so it's more than just the ident...</p>",
        "id": 540301936,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221742
    },
    {
        "content": "<p>also what if someone figures out a way to unify all of those functors and now <code>Polynomial R</code> is instead <code>BigFunctor .polynomial R</code></p>",
        "id": 540302066,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758221793
    },
    {
        "content": "<p>Well we kind of already have this. <code>Polynomial R</code> is secretly just <code>AddMonoidAlgebra R Nat</code>, but for some reason the arguments of <code>AddMonoidAlgebra</code> are backwards from what would be needed to make this notation work. And <code>X</code> is <code>AddMonoidAlgebra.single 1 1</code>, while <code>C</code> is <code>AddMonoidAlgebra.single 0</code>.</p>\n<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> has some plans to make <code>Polynomial</code> an <code>abbrev</code> for this.</p>\n<p>But somehow I don't think that our notation is going to be that useful/intuitive for <code>AddMonoidAlgebra</code>s.</p>",
        "id": 540303235,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758222255
    },
    {
        "content": "<p>I think it doesn't make much sense to make the notation more general/complicated for a use case that we don't even know about.</p>",
        "id": 540303401,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758222318
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540303401\">said</a>:</p>\n<blockquote>\n<p>a use case that we don't even know about.</p>\n</blockquote>\n<p><code>LaurentSeries</code> has no <code>.X</code>, and in fact it's actually <code>single 1 1</code></p>",
        "id": 540303954,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758222555
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/RingTheory/LaurentSeries.html#PowerSeries.coe_X\">PowerSeries.coe_X</a></p>",
        "id": 540303999,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758222575
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">PowerSeries</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPowerSeries</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">RatFunc</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">LaurentSeries</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">PowerSeries</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPowerSeries</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">RatFunc</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">LaurentSeries</span><span class=\"bp\">.</span><span class=\"n\">C</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">PowerSeries</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPowerSeries</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">RatFunc</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">LaurentSeries</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n</code></pre></div>",
        "id": 540304655,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758222848
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540301430\">said</a>:</p>\n<blockquote>\n<p>it has been fixed one month ago</p>\n</blockquote>\n<p>we shouldn't write code that depends on every part of mathlib cooperating with each other</p>",
        "id": 540304977,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758222966
    },
    {
        "content": "<p>Well, I guess <code>LaurentSeries</code> is a bit cursed then. If it is so little used that it doesn't have this API, then I wouldn't bother writing delaborators for it either.</p>",
        "id": 540305017,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758222981
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540304977\">said</a>:</p>\n<blockquote>\n<p>we shouldn't write code that depends on every part of mathlib cooperating with each other</p>\n</blockquote>\n<p>I think we should, no?</p>",
        "id": 540305088,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758223006
    },
    {
        "content": "<p>also even if we make them <code>ident</code> I still think we should be using <code>getHead</code></p>",
        "id": 540305133,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223031
    },
    {
        "content": "<p>I get now that there is an advantage to taking the X and C as a <code>term</code>, but I don't understand what you mean by using <code>getHead</code> on an <code>ident</code></p>",
        "id": 540305224,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758223082
    },
    {
        "content": "<p>I'm proposing to use <code>getHead</code> on the expression <code>Polynomial (MvPolynomial (Fin 2) R)</code> in order to figure out the constant identifier <code>Polynomial</code></p>",
        "id": 540305360,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223132
    },
    {
        "content": "<p>instead of looking at the last step of the for loop when you receive the syntax <code>R[a,b][c]</code></p>",
        "id": 540305399,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223149
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540304977\">said</a>:</p>\n<blockquote>\n<p>we shouldn't write code that depends on every part of mathlib cooperating with each other</p>\n</blockquote>\n<p>I think if all of the parts of mathlib do the same things is different ways, it will become horribly unusable.</p>",
        "id": 540305618,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758223235
    },
    {
        "content": "<p>I agree, but they do, and we should be prepared</p>",
        "id": 540305715,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223277
    },
    {
        "content": "<p>we can't make every PR depend on each other, then no PR will ever get merged</p>",
        "id": 540305756,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223291
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540305360\">said</a>:</p>\n<blockquote>\n<p>use <code>getHead</code> on the expression <code>Polynomial (MvPolynomial (Fin 2) R)</code></p>\n</blockquote>\n<p>That works too, it doesn't matter that much, but that does require defining <code>getHead</code> :)</p>",
        "id": 540305851,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758223334
    },
    {
        "content": "<p>which we will also use on every .C and .X expression</p>",
        "id": 540305898,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223352
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getHead</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">$_*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">getHead</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">TSyntax</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#make_delab\"</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"n\">tgt</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t₁</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">tgtHead</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tgt</span><span class=\"bp\">.</span><span class=\"n\">getHead</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">tgtHead</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">delab37</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">getExpr</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">eT</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eTS</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"c1\">-- the target type as an explicit pattern</span>\n<span class=\"w\">        </span><span class=\"c1\">-- if let `($tgt) := eS then</span>\n<span class=\"w\">        </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">result</span><span class=\"o\">:</span><span class=\"n\">poly_var</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">delab</span>\n<span class=\"w\">  </span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">make_delab</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 540306680,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223683
    },
    {
        "content": "<p>partially working code here</p>",
        "id": 540306699,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223692
    },
    {
        "content": "<p>i haven't implemented the bool hack so that delab won't call itself</p>",
        "id": 540306750,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223715
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> is this code good enough and would you like to write the bool hack?</p>",
        "id": 540306825,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758223748
    },
    {
        "content": "<p>Btw are you sure that you're not supposed to match the type with <code>R[x]</code>?</p>",
        "id": 540307455,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758223976
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540307455\">said</a>:</p>\n<blockquote>\n<p>Btw are you sure that you're not supposed to match the type with <code>R[x]</code>?</p>\n</blockquote>\n<p>well i was told that delab happens before unexpander</p>",
        "id": 540307691,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758224071
    },
    {
        "content": "<p>but it doesn't really matter, if it becomes R[x] then i can match that as well</p>",
        "id": 540307788,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758224095
    },
    {
        "content": "<p>i have access to both <code>Term</code>s</p>",
        "id": 540307846,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758224113
    },
    {
        "content": "<p>(typeIdent and polyesqueIdent)</p>",
        "id": 540307856,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758224119
    },
    {
        "content": "<p>Also I wonder if the <code>Bool</code> hack could cause unexpected problems...</p>",
        "id": 540307975,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758224176
    },
    {
        "content": "<p>who might know a non hacky way to do this?</p>",
        "id": 540312431,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758226288
    },
    {
        "content": "<p>Don't recursively call</p>",
        "id": 540314985,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758227533
    },
    {
        "content": "<p>what do i call instead?</p>",
        "id": 540315014,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758227548
    },
    {
        "content": "<p>no idea</p>",
        "id": 540315032,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758227557
    },
    {
        "content": "<p>This all seems very tricky</p>",
        "id": 540315061,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758227569
    },
    {
        "content": "<p>like, in the unexpander we had <code>throw ()</code> to mean \"don't use this unexpander\"</p>",
        "id": 540315079,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758227577
    },
    {
        "content": "<p>but nobody has told me what the corresponding syntax is for delab</p>",
        "id": 540315115,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758227590
    },
    {
        "content": "<p>Use a delab</p>",
        "id": 540315150,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758227596
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540315115\">said</a>:</p>\n<blockquote>\n<p>but nobody has told me what the corresponding syntax is for delab</p>\n</blockquote>\n<p>Try <code>failure</code></p>",
        "id": 540315368,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758227681
    },
    {
        "content": "<p>aha! that works, thanks</p>",
        "id": 540315488,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758227720
    },
    {
        "content": "<p>ah, ok, that works for the alternative, but i still need to actually call the \"default\" delab on this term</p>",
        "id": 540316010,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758227910
    },
    {
        "content": "<p>what do you mean</p>",
        "id": 540316075,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758227930
    },
    {
        "content": "<p>if you're running the <code>delab</code> function and it fails one delab it will try the next one</p>",
        "id": 540316178,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758227970
    },
    {
        "content": "<p>the algorithm is:</p>\n<ol>\n<li>given expression <code>e</code></li>\n<li>find its type <code>eT</code></li>\n<li>delab <code>eT</code> using the default delab and see if it matches <code>Polynomial Nat</code></li>\n<li>delab <code>e</code> using the default delab and see if it matches <code>Polynomial.X</code></li>\n<li>if both are yes, then return <code>t</code></li>\n<li>otherwise use the default delab</li>\n</ol>",
        "id": 540316208,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758227985
    },
    {
        "content": "<p>so you've solved step 6, but there's still step 4</p>",
        "id": 540316227,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758227991
    },
    {
        "content": "<p>that seems like a bad algorithm</p>",
        "id": 540316302,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228016
    },
    {
        "content": "<p>yeah maybe we should really convert syntax to expr instead of the other way</p>",
        "id": 540316375,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228048
    },
    {
        "content": "<p>why are you running delab in the delab</p>",
        "id": 540316394,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228056
    },
    {
        "content": "<p>I guess this issue is really complicated</p>",
        "id": 540316751,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228187
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> so is this a better algorithm?</p>\n<ol>\n<li>elaborate <code>Polynomial.X : Polynomial Nat</code> to an expression <code>tgt</code> (outside the Delab)</li>\n<li>check if <code>e</code> matches against <code>tgt</code></li>\n<li>if yes, return <code>t</code></li>\n<li>if no, use the default delab</li>\n</ol>",
        "id": 540316760,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228190
    },
    {
        "content": "<p>why are you running elab in the delab</p>",
        "id": 540316854,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228219
    },
    {
        "content": "<p>no, step 1 is done outside</p>",
        "id": 540316879,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228229
    },
    {
        "content": "<p>is that even possible</p>",
        "id": 540316880,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228230
    },
    {
        "content": "<p>it is not possible</p>",
        "id": 540316898,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228236
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540316879\">said</a>:</p>\n<blockquote>\n<p>no, step 1 is done outside</p>\n</blockquote>\n<p>This sounds doable but there <del>may be</del> are edge cases</p>",
        "id": 540316992,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228273
    },
    {
        "content": "<p>i guess <code>Semiring R</code> might be an issue?</p>",
        "id": 540317073,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228306
    },
    {
        "content": "<p>what's the edge case you're thinking about</p>",
        "id": 540317088,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228310
    },
    {
        "content": "<p>if you declare a polyvars for a free variable</p>",
        "id": 540317162,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228332
    },
    {
        "content": "<p>will the fvarid be preserved</p>",
        "id": 540317230,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228358
    },
    {
        "content": "<p>what if you abstract over it</p>",
        "id": 540317253,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228364
    },
    {
        "content": "<p>i can make that match against <code>$R</code></p>",
        "id": 540317259,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228367
    },
    {
        "content": "<p>step 1 is making a pattern</p>",
        "id": 540317281,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228374
    },
    {
        "content": "<p>what if there's another instance</p>",
        "id": 540317292,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228376
    },
    {
        "content": "<p>Is there a reason not to guide delaboration just by matching on the <code>Expr</code> contents directly?</p>",
        "id": 540317300,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758228379
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317300\">said</a>:</p>\n<blockquote>\n<p>Is there a reason not to guide delaboration just by matching on the <code>Expr</code> contents directly?</p>\n</blockquote>\n<p>how do you check you have the correct ring</p>",
        "id": 540317356,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228400
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317300\">said</a>:</p>\n<blockquote>\n<p>Is there a reason not to guide delaboration just by matching on the <code>Expr</code> contents directly?</p>\n</blockquote>\n<p>because the whole point of this is operating on the level of syntax, one benefit of which is that we don't ever have to worry about synthesising the Semiring instances</p>",
        "id": 540317422,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228429
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317422\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317300\">said</a>:</p>\n<blockquote>\n<p>Is there a reason not to guide delaboration just by matching on the <code>Expr</code> contents directly?</p>\n</blockquote>\n<p>because the whole point of this is operating on the level of syntax, one benefit of which is that we don't ever have to worry about synthesising the Semiring instances</p>\n</blockquote>\n<p>now I'm confused</p>",
        "id": 540317496,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228464
    },
    {
        "content": "<p>up until this point i have never had to touch Expr</p>",
        "id": 540317553,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228486
    },
    {
        "content": "<p>you don't need to synthesize any instances during delab or unexpand</p>",
        "id": 540317566,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228490
    },
    {
        "content": "<p>what's your algorithm?</p>",
        "id": 540317746,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228572
    },
    {
        "content": "<p>too many edge cases I don't know what to do with</p>",
        "id": 540317811,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228599
    },
    {
        "content": "<p>I guess they're not really edge cases</p>",
        "id": 540317863,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228614
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317300\">said</a>:</p>\n<blockquote>\n<p>Is there a reason not to guide delaboration just by matching on the <code>Expr</code> contents directly?</p>\n</blockquote>\n<p>is this the same algorithm as the one here? <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540316760\">#mathlib4 &gt; Notation for polynomial variables @ 💬</a></p>",
        "id": 540317866,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228615
    },
    {
        "content": "<p>they're just cases</p>",
        "id": 540317877,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228620
    },
    {
        "content": "<p>too many things where I don't know what's the desired outcome</p>",
        "id": 540317957,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228648
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317292\">said</a>:</p>\n<blockquote>\n<p>what if there's another instance</p>\n</blockquote>\n<p><code>$R</code> is only used in its own delab</p>",
        "id": 540317969,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228651
    },
    {
        "content": "<p>I guess once I'm back at a keyboard I show you and you decide what wants to happen does that sound good</p>",
        "id": 540318309,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758228776
    },
    {
        "content": "<p>sure</p>",
        "id": 540318337,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758228786
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317866\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540317300\">said</a>:</p>\n<blockquote>\n<p>Is there a reason not to guide delaboration just by matching on the <code>Expr</code> contents directly?</p>\n</blockquote>\n<p>is this the same algorithm as the one here? <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540316760\">#mathlib4 &gt; Notation for polynomial variables @ 💬</a></p>\n</blockquote>\n<p>I think so, as long as you’re getting the ingredients in step 1 from <code>$poly</code>/the arguments to the outer command. Why do you say it’s not possible?</p>",
        "id": 540319035,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758229049
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> it's only possible outside the Delab, because termElab happens in the TermElabM monad which cannot be lifted to DelabM</p>",
        "id": 540319146,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229095
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> would you like to try writing the code if i give you the specification?</p>",
        "id": 540319570,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229284
    },
    {
        "content": "<p>I could write the code if given a specification that covers every possible case but</p>",
        "id": 540319745,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758229365
    },
    {
        "content": "<p>every possible case is really strong</p>",
        "id": 540319767,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758229376
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540319146\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> it's only possible outside the Delab, because termElab happens in the TermElabM monad which cannot be lifted to DelabM</p>\n</blockquote>\n<p>Right, I meant your proposal to elaborate it outside. Which probably still gets you into a tricky place if you want to do it in an on-the-fly manner by adding a new declaration for the delaborator (you might have to e.g. quote the resulting expr into the body of a new declaration), without something like an environment extension to look up information in…</p>",
        "id": 540320105,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758229516
    },
    {
        "content": "<p>well we can start small, we don't need to do every case first</p>",
        "id": 540320127,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229524
    },
    {
        "content": "<p>yes, but that approach is working well for the unexpander in the other cases</p>",
        "id": 540320158,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229547
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540319570\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> would you like to try writing the code if i give you the specification?</p>\n</blockquote>\n<p>I would but I’m likely unavailable for at least two days <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span>However, it’s probably worth writing down a spec anyway, as it will function as/be fairly close to the documentation that will go with this.</p>",
        "id": 540320264,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758229591
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyDelab1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- insert code here</span>\n<span class=\"w\">  </span><span class=\"n\">failure</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyDelab2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- insert code here</span>\n<span class=\"w\">  </span><span class=\"n\">failure</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- a</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- b</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- c</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X</span>\n</code></pre></div>",
        "id": 540320473,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229674
    },
    {
        "content": "<p>this is the spec</p>",
        "id": 540320483,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229677
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> since you can't write code, do you see an algorithm for this?</p>",
        "id": 540320565,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229708
    },
    {
        "content": "<p>your spec is weird</p>",
        "id": 540320656,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758229744
    },
    {
        "content": "<p>you want the exact same term to delaborate two different ways</p>",
        "id": 540320700,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758229761
    },
    {
        "content": "<p>oops sorry fixed that</p>",
        "id": 540320756,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229779
    },
    {
        "content": "<p>The real spec is actually way more general than this, right? As in, you want a way to modify elaboration/delaboration according to a local command, right? (I think that affects how this should be approached)</p>",
        "id": 540321156,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758229937
    },
    {
        "content": "<p>yes</p>",
        "id": 540321184,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758229948
    },
    {
        "content": "<p>I mean the problem in its essence is:</p>\n<ol>\n<li>Given <code>newStx : Term</code></li>\n<li>Given <code>targetStx : Term</code>, <code>targetType : Term</code></li>\n<li>Make sure that <code>newStx</code> elaborates to <code>targetStx : targetType</code></li>\n<li>Make sure that <code>targetStx : targetType</code> delaborates back to <code>newStx</code></li>\n</ol>",
        "id": 540323385,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758231026
    },
    {
        "content": "<p>3 can be done entirely on the level of syntax, but 4 requires knowing the type, which is not an available information on the syntax level</p>",
        "id": 540323432,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758231058
    },
    {
        "content": "<p>because like just the syntax <code>1</code> can have type Nat, Int, Rat, and Real</p>",
        "id": 540323560,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758231112
    },
    {
        "content": "<p>current attempt:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyDelab2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)),</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferTypeQ</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540324814,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758231740
    },
    {
        "content": "<p>uh... I might have created a monster</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyDelab1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- insert code here</span>\n<span class=\"w\">  </span><span class=\"n\">failure</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare \"</span><span class=\"w\"> </span><span class=\"n\">polyX</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">termS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">typeS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">  </span><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">polyX</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyDelab2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">typeE</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">typeS</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">termE</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">elabTermEnsuringType</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">termS</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">typeE</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">termE</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">failure</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- #check (Polynomial.C (MvPolynomial.X 0) : Polynomial (MvPolynomial (Fin 2) Nat)) -- a</span>\n<span class=\"c1\">-- #check (Polynomial.C (MvPolynomial.X 1) : Polynomial (MvPolynomial (Fin 2) Nat)) -- b</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- c</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X</span>\n</code></pre></div>",
        "id": 540329336,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233269
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> what's your expert opinion on this code?</p>",
        "id": 540329354,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233281
    },
    {
        "content": "<p>it won't work for if you declare where the ring is a <code>variable</code></p>",
        "id": 540329410,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758233318
    },
    {
        "content": "<p>it at least be unlikely to work</p>",
        "id": 540329441,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758233339
    },
    {
        "content": "<p>actually it does work, change the <code>Nat</code> in my code to <code>_</code> and both give <code>c</code></p>",
        "id": 540329461,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233353
    },
    {
        "content": "<p>did you use a <code>variable</code></p>",
        "id": 540329558,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758233411
    },
    {
        "content": "<p>also the two <code>TermElabM.run</code> lines can be combined into one:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">termE</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">termS</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeS</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">none</span>\n</code></pre></div>",
        "id": 540329562,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233414
    },
    {
        "content": "<p>oh, right lemme test that</p>",
        "id": 540329576,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233423
    },
    {
        "content": "<p>ok it doesn't work <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 540329659,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233480
    },
    {
        "content": "<p>do you see how to make it work?</p>",
        "id": 540329844,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233628
    },
    {
        "content": "<p>depends on what you want to do in the edge cases</p>",
        "id": 540329878,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758233654
    },
    {
        "content": "<p>well my spec is now:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- c</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X</span>\n</code></pre></div>",
        "id": 540330118,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233708
    },
    {
        "content": "<p>the problematic part of the code is <code>TermElabM.run</code> right</p>",
        "id": 540331176,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758233959
    },
    {
        "content": "<p>which monad has access to the <code>variable</code>s?</p>",
        "id": 540332200,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234186
    },
    {
        "content": "<p>i know <code>TermElabM</code> does, so the question now is whether <code>MetaM</code> does</p>",
        "id": 540332251,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234202
    },
    {
        "content": "<p>it's in the termelabm read-only state I think</p>",
        "id": 540332460,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758234246
    },
    {
        "content": "<p>so there's no way for <code>DelabM</code> to get it then basically?</p>",
        "id": 540333328,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234440
    },
    {
        "content": "<p>who knows it might technically be possible</p>",
        "id": 540333490,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758234470
    },
    {
        "content": "<p>well but CommandElabM can get it</p>",
        "id": 540333540,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234478
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{← ppExpr x} : {← ppExpr (← inferType x)}\"</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">α : Type u</span>\n<span class=\"cm\">f : α → α</span>\n<span class=\"cm\">n : Nat</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>(not my code)</p>",
        "id": 540333621,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234499
    },
    {
        "content": "<p>the problem is that i've found no other function that can deal with <code>xs : List Expr</code> and do anything meaningful with them</p>",
        "id": 540334311,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234646
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540334311\">said</a>:</p>\n<blockquote>\n<p>the problem is that i've found no other function that can deal with <code>xs : List Expr</code> and do anything meaningful with them</p>\n</blockquote>\n<p>huh what do you mean by that</p>",
        "id": 540334476,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758234681
    },
    {
        "content": "<p><code>xs : List Expr</code> is storing all the <code>variable</code>s but i couldn't find any function that takes in <code>List Expr</code> and <code>Syntax</code> and return... i guess <code>TermElabM Expr</code></p>",
        "id": 540334779,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234750
    },
    {
        "content": "<p>like the <code>elabTerm</code> function is indeed <code>Syntax -&gt; TermElabM Expr</code> but it doesn't take in an additional <code>List Expr</code> right</p>",
        "id": 540334933,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234779
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> Lean.Elab.TermElabM, List</p>",
        "id": 540335126,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758234826
    },
    {
        "content": "<p><span aria-label=\"exclamation\" class=\"emoji emoji-2757\" role=\"img\" title=\"exclamation\">:exclamation:</span> unknown identifier 'Lean.Elab.TermElabM'<br>\nDid you mean <a href=\"https://loogle.lean-lang.org/?q=%22Lean.Elab.TermElabM%22%2C%20List\"><code>\"Lean.Elab.TermElabM\", List</code></a>?</p>",
        "id": 540335132,
        "sender_full_name": "loogle",
        "timestamp": 1758234827
    },
    {
        "content": "<p>the downside to these namespaces</p>",
        "id": 540335338,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758234876
    },
    {
        "content": "<p>is actually <code>Lean.Elab.Term.TermElabM</code></p>",
        "id": 540335440,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758234896
    },
    {
        "content": "<p>well you can always <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.TermElabM.run#doc\">docs#Lean.Elab.Term.TermElabM.run</a></p>",
        "id": 540335791,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758234967
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#asdf\"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"bp\">#</span><span class=\"n\">asdf</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>this works and i have no idea why</p>",
        "id": 540335911,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758234994
    },
    {
        "content": "<p>why wouldn't it work</p>",
        "id": 540336081,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235023
    },
    {
        "content": "<p>this makes sense to me</p>",
        "id": 540336106,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235028
    },
    {
        "content": "<p>because it did nothing with the <code>xs</code></p>",
        "id": 540336141,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758235033
    },
    {
        "content": "<p>it's in the state though right</p>",
        "id": 540336187,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235051
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">class</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Real</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyDelab37</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">termE</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">termE</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare \"</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">polyX</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">termS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">typeS</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">R</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">termE</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">((</span><span class=\"bp\">$</span><span class=\"n\">termS</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">typeS</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">polyDelab37</span><span class=\"w\"> </span><span class=\"n\">termE</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"c1\">-- uh...</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">))</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 540338814,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758235685
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> I now have a live <code>Delab</code> object called <code>delab</code> but I don't know how to tell pp to use it</p>",
        "id": 540338843,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758235707
    },
    {
        "content": "<p>I can't tag it dynamically with <code>@[app_delab $polyX]</code></p>",
        "id": 540338860,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758235720
    },
    {
        "content": "<p>You can run the delab on an expr to get a syntax</p>",
        "id": 540338883,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235742
    },
    {
        "content": "<p>but that doesn't actually tell pp to now use that syntax</p>",
        "id": 540338939,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758235787
    },
    {
        "content": "<p>well don't go through expr pp if you want a different delab function</p>",
        "id": 540338978,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235814
    },
    {
        "content": "<p>the point is i need to tag something with <code>@[app_delab]</code> so that it actually triggers when I run the testcases at the bottom</p>",
        "id": 540339012,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758235855
    },
    {
        "content": "<p>It's in an environment extension probably</p>",
        "id": 540339048,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235884
    },
    {
        "content": "<p>see if you can hack that</p>",
        "id": 540339065,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235903
    },
    {
        "content": "<p>You can <code>whatsnew in</code> to see what gets added to</p>",
        "id": 540339245,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758235950
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"bp\">.</span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"n\">failure</span>\n\n<span class=\"c1\">-- Lean.declRangeExt extension: 1 new entries</span>\n\n<span class=\"c1\">-- Lean.Compiler.LCNF.baseExt extension: 1 new entries</span>\n\n<span class=\"c1\">-- Lean.Compiler.LCNF.monoExt extension: 2 new entries</span>\n\n<span class=\"c1\">-- Lean.IR.declMapExt extension: 3 new entries</span>\n\n<span class=\"c1\">-- Lean.IR.UnreachableBranches.functionSummariesExt extension: 2 new entries</span>\n\n<span class=\"c1\">-- Lean.Compiler.LCNF.UnreachableBranches.functionSummariesExt extension: 2 new entries</span>\n\n<span class=\"c1\">-- Lean.PrettyPrinter.Delaborator.delabAttribute extension: 1 new entries</span>\n</code></pre></div>",
        "id": 540339563,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758236051
    },
    {
        "content": "<p>found it</p>",
        "id": 540339592,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236068
    },
    {
        "content": "<p>now we go to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Delaborator.delabAttribute#doc\">docs#Lean.PrettyPrinter.Delaborator.delabAttribute</a></p>",
        "id": 540339850,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236121
    },
    {
        "content": "<p>i love this hacking</p>",
        "id": 540340109,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758236179
    },
    {
        "content": "<p>I'm not sure if you realize this or not, but the same <code>R</code> declared with <code>variable (R : Type)</code> will have a different <code>FVarId</code> in each declaration. So you can't just elaborate <code>Polynomial.X : Polynomial R</code> one time, and then reuse the resulting <code>Expr</code>. Because the <code>Expr</code> that you want to get is different every time.</p>",
        "id": 540342260,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758236662
    },
    {
        "content": "<p>i mean, this is why going into <code>Expr</code> is a bad idea...</p>",
        "id": 540342457,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758236719
    },
    {
        "content": "<p>but it doesn't seem like we have any other choice</p>",
        "id": 540342468,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758236727
    },
    {
        "content": "<p>so you're saying that this will just not work?</p>",
        "id": 540342483,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758236734
    },
    {
        "content": "<p>we could hook the command elaborator</p>",
        "id": 540342540,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236777
    },
    {
        "content": "<p>store the fvarid somewhere and update it each time</p>",
        "id": 540342563,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236805
    },
    {
        "content": "<p>we could index into the context in order</p>",
        "id": 540342588,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236828
    },
    {
        "content": "<p>there are so many ways</p>",
        "id": 540342599,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236834
    },
    {
        "content": "<p>Another silly idea I have is that you could modify the delaborator to include the type as an extra argument in <code>Polynomial.X</code>. And then once you have the type, use the app unexpander to either</p>\n<ul>\n<li>detect that it should be a variable, and put the variable there</li>\n<li>remove this silly extra argument</li>\n</ul>",
        "id": 540342671,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758236886
    },
    {
        "content": "<p>I don't understand</p>",
        "id": 540342726,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236934
    },
    {
        "content": "<p>how does this help us verify the ring</p>",
        "id": 540342758,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758236958
    },
    {
        "content": "<p>I propose to write a stupid delaborator that turns <code>(Polynomial.X : Polynomial (MvPolynomial (Fin 2) R))</code> into <code>Polynomial.X (MvPolynomial (Fin 2) R)</code>.</p>",
        "id": 540342787,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758236988
    },
    {
        "content": "<p>makes sense</p>",
        "id": 540342811,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237011
    },
    {
        "content": "<p>And then we use an app unexpander to either get rid of the extra argument, or make it a variable</p>",
        "id": 540342812,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758237011
    },
    {
        "content": "<p>but how do we decide which one to do</p>",
        "id": 540342829,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237026
    },
    {
        "content": "<p>Well, we now have in principle enough information to decide that. (and we can tweak what information exactly we'd want)</p>",
        "id": 540342945,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758237079
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540342787\">said</a>:</p>\n<blockquote>\n<p>I propose to write a stupid delaborator that turns <code>(Polynomial.X : Polynomial (MvPolynomial (Fin 2) R))</code> into <code>Polynomial.X (MvPolynomial (Fin 2) R)</code>.</p>\n</blockquote>\n<p>I like this idea, but i'm not sure if the other big names would</p>",
        "id": 540343015,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758237144
    },
    {
        "content": "<p>surely there's a non hacky way to solve this problem</p>",
        "id": 540343036,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758237157
    },
    {
        "content": "<p>I really don't see how doing this helps at all</p>",
        "id": 540343052,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237168
    },
    {
        "content": "<p>we're not really adding anything new</p>",
        "id": 540343064,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237179
    },
    {
        "content": "<p>all of this is possible without the stupid delab</p>",
        "id": 540343080,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237192
    },
    {
        "content": "<p>the algorithm here is that firstly the given expr <code>Polynomial.X : anything</code> will first turn into the stupid syntax <code>Polynomial.X anything</code>, and very importantly now we're in the level of syntax and we have enough information to verify if it's part of the newly declared variables</p>",
        "id": 540343345,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758237261
    },
    {
        "content": "<p>How do we verify that?</p>",
        "id": 540343465,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237282
    },
    {
        "content": "<p>and since we're now in syntax, we can then use unexpander instead of delab</p>",
        "id": 540343473,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758237283
    },
    {
        "content": "<p>The crucial problem is that the app unexpander, under normal conditions, can't tell these two appart:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">]</span>\n<span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">[</span><span class=\"n\">y</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : R[x]</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : S[y]</span>\n</code></pre></div>\n<p>Because it just sees <code>Polynomial.X</code>, instead of also seeing its type.</p>",
        "id": 540343746,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758237344
    },
    {
        "content": "<p>so why do we need the unexpander at all</p>",
        "id": 540343855,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237373
    },
    {
        "content": "<p>why not just do everything in delab</p>",
        "id": 540343879,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237382
    },
    {
        "content": "<p>because none of us has figured out a way to do it in delab</p>",
        "id": 540343938,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758237391
    },
    {
        "content": "<p>I still don't know how you're verifying the type</p>",
        "id": 540344101,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237424
    },
    {
        "content": "<p>Well it should work in delab, but there is this annoying infinite loop issue, which can be fixed only in a hacky way</p>",
        "id": 540344106,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758237429
    },
    {
        "content": "<p>is it just a syntactic match?</p>",
        "id": 540344131,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237443
    },
    {
        "content": "<p>Yes, we want to match the syntax</p>",
        "id": 540344296,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758237469
    },
    {
        "content": "<p>I hope it's not just a syntactic match</p>",
        "id": 540344302,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758237469
    },
    {
        "content": "<p>But I think there might be a better hack to fix the infinite loop issue than just a <code>Bool</code>. Instead we can use the fact that the delaborator keeps track of a <code>SubExpr.Pos</code> (which is just <code>Nat</code>). So we can store in the options this number, and avoid an infinite loop like that. And we can default to 0, because <code>SubExpr.Pos</code> is never 0. (We could also use an <code>IO.Ref</code>, or an environment extension, but I doubt that makes much of a difference)</p>",
        "id": 540347955,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758238319
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> would you know of a non-hacky way to do this?</p>",
        "id": 540411400,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758274122
    },
    {
        "content": "<p>Sorry, at this point I have no idea what \"this\" even refers to!</p>",
        "id": 540413229,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758274734
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> here's a specification:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare \"</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">polyX</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">polyX</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyDelab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"c\">/-</span><span class=\"cm\"> insert code here? -/</span><span class=\"w\"> </span><span class=\"n\">failure</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"c1\">-- you're gonna need this for hygiene</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Expected: 1 : Polynomial R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Expected: Polynomial.X : Polynomial S</span>\n</code></pre></div>",
        "id": 540413682,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758274896
    },
    {
        "content": "<p>basically, we're looing for a way to <strong>conditionally</strong> delaborate/unexpand a term based on user specification</p>",
        "id": 540413744,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758274915
    },
    {
        "content": "<p>so in the example above, we want <code>Polynomial.X : Polynomial R</code> to become <code>1</code>, but <code>Polynomial.X : Polynomial S</code> to be untouched</p>",
        "id": 540413862,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758274955
    },
    {
        "content": "<p>I've figured out how to do it if R is a constant like <code>Nat</code>, but i'm stuck when it's a <code>variable</code></p>",
        "id": 540413944,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758274986
    },
    {
        "content": "<p>this might be impossible... lemme try to prove it:</p>\n<ol>\n<li>We want the delab to be generated once by the command <code>#declare R Polynomial.X</code></li>\n<li>A delab is <em>essentially</em> (not really) a function <code>Expr -&gt; DelabM Term</code></li>\n<li>But the <code>Expr</code> that corresponds to the variable <code>R</code> is not constant, it changes after every declaration.</li>\n</ol>",
        "id": 540416130,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758275704
    },
    {
        "content": "<p>so we might need to use <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>'s other idea to actually generate the syntax to tag the type in the <code>Term</code></p>",
        "id": 540416317,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758275774
    },
    {
        "content": "<p>Jovan's proposal is this:<br>\nGiven <code>Polynomial.X : Polynomial R</code>:</p>\n<ol>\n<li>delab -&gt; <code>Polynomial.X (Polynomial R)</code></li>\n<li>unexpand -&gt; <code>1</code></li>\n</ol>\n<p>Given <code>Polynomial.X : Polynomial S</code>:</p>\n<ol>\n<li>delab -&gt; <code>Polynomial.X (Polynomial S)</code></li>\n<li>unexpand -&gt; <code>Polynomial.X</code></li>\n</ol>",
        "id": 540416490,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758275831
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> what do you think about this?</p>",
        "id": 540416659,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758275887
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540413862\">said</a>:</p>\n<blockquote>\n<p>so in the example above, we want <code>Polynomial.X : Polynomial R</code> to become <code>1</code>, but <code>Polynomial.X : Polynomial S</code> to be untouched</p>\n</blockquote>\n<p>That seems like a very bad thing to want...?</p>",
        "id": 540416962,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758275996
    },
    {
        "content": "<p>well I essentially did the forward direction already in the PR</p>",
        "id": 540417037,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758276017
    },
    {
        "content": "<p>Which PR?</p>",
        "id": 540417086,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758276031
    },
    {
        "content": "<p>I made <code>t</code> expand to <code>Polynomial.X : Polynomial R</code></p>",
        "id": 540417087,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758276032
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28349\">#28349</a></p>",
        "id": 540417212,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758276067
    },
    {
        "content": "<p>I would like to be convinced, via a clear and readable document laying out the behaviour, that this is not going to badly confuse users and introduce significant fragility. I am currently very sceptical.</p>",
        "id": 540417683,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758276226
    },
    {
        "content": "<p>this = the PR or the delab?</p>",
        "id": 540417791,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758276250
    },
    {
        "content": "<p>honestly i'm happy for the PR to proceed without the delab</p>",
        "id": 540417817,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758276258
    },
    {
        "content": "<p>i'm not entirely sure why <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> wants the delab</p>",
        "id": 540417845,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758276268
    },
    {
        "content": "<p>The PR.</p>",
        "id": 540418384,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1758276447
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> The PR allows the user to type in a command like <code>name_poly_vars R[a,b][C]</code>, and does the following:</p>\n<ol>\n<li>register <code>a</code>, <code>b</code>, and <code>C</code> as declared variables, which are stored in the <code>poly_var</code> syntax category. Essentially:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"b\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"C\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>compute the term that these variables are supposed to expand to, which are:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">)</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>Additionally, the same thing is done for the type itself:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">))</span>\n</code></pre></div>\n<ol start=\"4\">\n<li>More specifications: the ring specified <code>R</code> can be a section <code>variable</code> or a term like <code>Fin 37</code> or a combination of both like <code>Fin n</code>.</li>\n<li>And if instead a hole <code>_</code> is specified, then we process all of the above cases.</li>\n</ol>\n<p>As preamble, to make the above work, we have the following syntax declarations:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">poly_var</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"o\">,</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"o\">)</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n</code></pre></div>\n<p>And as a final remark we allow for other functors other than Polynomial or MvPolyonomial, which would require other types of brackets, but that part is not user-facing, so pretend that the above code also works with other types of brackets.</p>",
        "id": 540419325,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758276782
    },
    {
        "content": "<p>in summary, this PR did what mathematicians wanted to do for a long time: to refer to a complicated polynomial-esque ring like <code>Polynomial (MvPolynomial (Fin 2) R)</code> by <code>R[a,b][c]</code></p>",
        "id": 540420057,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758277053
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare \"</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">polyX</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span>\n<span class=\"w\">    </span><span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">polyX</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyXDelab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">``$</span><span class=\"n\">polyX</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">_</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">getAppFnArgs</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">``$</span><span class=\"n\">poly</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eT</span><span class=\"bp\">.</span><span class=\"n\">getAppFnArgs</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">failure</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"c1\">-- for hygiene</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- 1 : Polynomial R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : Polynomial S</span>\n</code></pre></div>",
        "id": 540423039,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758278168
    },
    {
        "content": "<p>static qq version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"w\"> </span><span class=\"n\">Delaborator</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">app_delab</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyXDelab</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">rr</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferTypeQ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"n\">rr</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- 1 : Polynomial R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial.X : Polynomial S</span>\n</code></pre></div>",
        "id": 540423901,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758278474
    },
    {
        "content": "<p>I want to make this dynamic but Lean is complaining about <code>$rr</code> (and <code>$$rr</code> doesn't solve it)</p>",
        "id": 540424067,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758278530
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> I have to admit that I completely lost track of this thread. Why do you need to generate delaborators now?</p>",
        "id": 540490225,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1758298100
    },
    {
        "content": "<p>So in my opinion, elaborators are one half of the story and delaborators are the other half. I want to see the thing I write in the infoview.</p>",
        "id": 540496422,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758300235
    },
    {
        "content": "<p>That I understand. But generating delaborators as done above seems very hacky.</p>",
        "id": 540500066,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1758301395
    },
    {
        "content": "<p>E.g. the current <code>name_poly_vars</code> command uses <code>notation3</code> under the hood, which takes care of delaboration.</p>",
        "id": 540500426,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1758301464
    },
    {
        "content": "<p>how does <code>notation3</code> do it?</p>",
        "id": 540513533,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758306553
    },
    {
        "content": "<p>you can take a look at the code here: <a href=\"https://github.com/leanprover-community/mathlib4/blob/9fd7af820ab2c2d0ae8164bdd98d6c19b0600afd/Mathlib/Util/Notation3.lean#L520\">https://github.com/leanprover-community/mathlib4/blob/9fd7af820ab2c2d0ae8164bdd98d6c19b0600afd/Mathlib/Util/Notation3.lean#L520</a></p>",
        "id": 540513654,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1758306601
    },
    {
        "content": "<p>It's complex. You probably don't want to reinvent the wheel here.</p>",
        "id": 540513811,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1758306659
    },
    {
        "content": "<p>yeah that's why i was asking to see if you have already gone through the code and could summarise the main part</p>",
        "id": 540513991,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758306722
    },
    {
        "content": "<p>or are you saying my PR should just call <code>notation3</code>?</p>",
        "id": 540514318,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758306816
    },
    {
        "content": "<p>Yes, I think so.</p>",
        "id": 540514397,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1758306853
    },
    {
        "content": "<p>IIUC it attempts to create a <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Util/Notation3.html#Mathlib.Notation3.Matcher\">Mathlib.Notation3.Matcher</a>, and uses that to build the delaborator. The code starts on line 625 of the linked file.</p>",
        "id": 540514463,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1758306887
    },
    {
        "content": "<p>Thanks a lot for suggesting this! I forgot about the fact that  <code>notation3</code> creates such an advanced delaborator on the fly. I can get the following to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"s2\">\"u\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"c1\">-- t : Polynomial R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"c1\">-- u : Polynomial S</span>\n</code></pre></div>",
        "id": 540538204,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758319308
    },
    {
        "content": "<p><a href=\"https://github.com/kckennylau/mathlib4/pull/16\">https://github.com/kckennylau/mathlib4/pull/16</a></p>",
        "id": 540546148,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758326043
    },
    {
        "content": "<p>I ended up not using <code>notation3</code> directly, but copying a bit of the code, and using its expression matcher.</p>",
        "id": 540546203,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758326107
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> wow, very nice! do you understand how it works (and could you explain it to me?)</p>",
        "id": 540743067,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758530940
    },
    {
        "content": "<p>(also, merged)</p>",
        "id": 540743198,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758530978
    },
    {
        "content": "<p>Yes, the <code>notation3</code> command creates a <code>delab</code> on the fly (unlike <code>notation</code>, which creates an app unexpander). When writing down the <code>notation3</code> command, it elaborates the RHS, to turn it into an expression. Then based on this expression in creates the delaborator. The delaborator decides whether to fire or not based on the shape of the expression. Remember that I earlier said that this was going to be hard?</p>\n<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540342260\">said</a>:</p>\n<blockquote>\n<p>I'm not sure if you realize this or not, but the same <code>R</code> declared with <code>variable (R : Type)</code> will have a different <code>FVarId</code> in each declaration. So you can't just elaborate <code>Polynomial.X : Polynomial R</code> one time, and then reuse the resulting <code>Expr</code>. Because the <code>Expr</code> that you want to get is different every time.</p>\n</blockquote>\n<p>Well, it has some smartness built in to keep track of the <code>FVarId</code>s correctly.</p>",
        "id": 540751074,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758533326
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> but how does it know about the type?</p>",
        "id": 540752937,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758533856
    },
    {
        "content": "<p>Because it works at the expression level, if the expression is the correct thing, the type is automatically also the correct thing</p>",
        "id": 540753050,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758533895
    },
    {
        "content": "<p>thanks!</p>",
        "id": 540753775,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758534121
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> would you like to look at the PR?</p>",
        "id": 540753913,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758534158
    },
    {
        "content": "<p>Yes, I've made another cleanup PR: <a href=\"https://github.com/kckennylau/mathlib4/pull/17\">https://github.com/kckennylau/mathlib4/pull/17</a></p>",
        "id": 540773036,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758539983
    },
    {
        "content": "<p>I'm not sure if we want to change the name of the command <code>name_poly_vars</code>. I think it acts like a fancy version of the <code>variable</code> command, so I'd think it should be called something along the lines of <code>poly_variable</code>.</p>",
        "id": 540773382,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758540074
    },
    {
        "content": "<p>thanks, merged</p>",
        "id": 540773848,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758540194
    },
    {
        "content": "<p>I'm  fine with <code>poly_variable</code></p>",
        "id": 540774116,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758540259
    },
    {
        "content": "<p>Here's another slight issue with the notation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">name_poly_vars</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>This complains because it parses <code>l[t]</code> using <code>syntax:max polyesque : term</code>, and there's no elaborator for it. So either we need to restrict the syntax sufficiently that there is always a <code>macro_rules</code> for it, or if that doesn't work, we need to implement an elaborator that gives a clearer error message here.</p>",
        "id": 540780480,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758542036
    },
    {
        "content": "<p>If we switch to <code>poly_variable</code>, then how should we call <code>register_poly_vars</code>? Maybe <code>register_poly_notation</code>?</p>",
        "id": 540781281,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758542253
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">noWs</span><span class=\"w\"> </span><span class=\"n\">atomic</span><span class=\"o\">(</span><span class=\"s2\">\"[\"</span><span class=\"w\"> </span><span class=\"n\">poly_var</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"o\">)</span>\n<span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">polyesqueFallback</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">polyesque</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">term_elab</span><span class=\"w\"> </span><span class=\"n\">polyesqueFallback</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">polyesqueFallbackMacro</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{stx} is not a declared polynomial-like notation.\"</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro_rules</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">])</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 540782615,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758542573
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540781281\">said</a>:</p>\n<blockquote>\n<p>If we switch to <code>poly_variable</code>, then how should we call <code>register_poly_vars</code>? Maybe <code>register_poly_notation</code>?</p>\n</blockquote>\n<p>sure</p>",
        "id": 540782714,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758542597
    },
    {
        "content": "<p>Yes, that works. You can just use <code>throwError</code> (which doesn't need a <code>m!</code>) (naming-wise I would rather call the syntax itself <code>polyesque_term</code>, and <code>polyesqueFallbackMacro</code> isn't actually a macro).</p>\n<p>Can you also add a test for this?</p>",
        "id": 540783938,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758542923
    },
    {
        "content": "<p>I'd also be in favour of scoping the <code>polyesque_term</code> and <code>syntax poly_var : term</code> into some namespace, and then <code>poly_variable</code> can <code>open scoped</code> that namespace. This is just to avoid that the parser does extra unnecessary work when not working with polynomials.</p>",
        "id": 540784728,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758543147
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/540784728\">said</a>:</p>\n<blockquote>\n<p>and then <code>poly_variable</code> can <code>open scoped</code> that namespace</p>\n</blockquote>\n<p>earlier I rejected the idea, but with this new observation now I think it's a good idea!</p>",
        "id": 540784988,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758543224
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> I have made all the changes you requested:</p>\n<ol>\n<li>renamed the two commands to <code>poly_variable</code> and <code>register_poly_notation</code>.</li>\n<li>added the fallback elaborator (and a test for it).</li>\n<li>added \"a lot more detail\" to the docstring of poly_variable.</li>\n<li>scoped the two <code>syntax : term</code>s.</li>\n<li>moved the file out of the Ring/ folder into <code>Mathlib/Tactic/PolyVariable.lean</code>.</li>\n<li>fixed the algebraic geometry docstrings.</li>\n</ol>",
        "id": 540978954,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758623527
    },
    {
        "content": "<p>(I think there was an accidental addition that causes CI to complain)</p>",
        "id": 540980686,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758624165
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> you mean, for everyone?</p>",
        "id": 540981185,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758624358
    },
    {
        "content": "<p>No, I meant in your PR</p>",
        "id": 540982037,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758624696
    },
    {
        "content": "<p>in <code>Mathlib.lean</code></p>",
        "id": 540982175,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758624739
    },
    {
        "content": "<p>oh...</p>",
        "id": 540982260,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758624775
    },
    {
        "content": "<p>remind me to not use <code>mk_all</code>, it ignores the gitignore stuff</p>",
        "id": 540982306,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758624791
    },
    {
        "content": "<p>fixed</p>",
        "id": 540982409,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758624836
    },
    {
        "content": "<p>It should ignore the gitignore stuff, if you use <code>lake exe mk_all --git</code>.</p>",
        "id": 540992497,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758628257
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28349#discussion_r2373145955\">https://github.com/leanprover-community/mathlib4/pull/28349#discussion_r2373145955</a><br>\n<span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> Should we discuss it here?</p>",
        "id": 541078269,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758652787
    },
    {
        "content": "<p>Yes, let's discuss it here. With the current implementation, when writing <code>R[X][Y]</code>, then <code>X</code> is not the generator of <code>R[X]</code>, but its image in <code>R[X][Y]</code>. Formally, <code>X</code> is <code>Polynomial.C (Polynomial.X (R := R))</code>. Setting aside all questions about the implementation, or whether we should avoid new notations with brackets, I am a little bit surprised by this design choice. What is the rationale behind this?</p>",
        "id": 541081548,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1758654186
    },
    {
        "content": "<p>Well my rationale was that our interest is the big ring <code>R[X][Y]</code> (which is isomorphic to <code>R[X,Y]</code>) so <code>X</code> and <code>Y</code> should both be referring to elements of the big ring.</p>",
        "id": 541081756,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758654284
    },
    {
        "content": "<p>I don't actually know why <code>R[X][Y]</code> was developed in that Bivariate file rather than <code>R[X,Y]</code> (and then subsequently in the elliptic curve files).</p>",
        "id": 541081825,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758654314
    },
    {
        "content": "<p>I did not write the bivariate and elliptic curve files.</p>",
        "id": 541081926,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758654354
    },
    {
        "content": "<p>another example: <a href=\"https://github.com/leanprover-community/mathlib4/pull/29497/files\">#29497</a> talks about the ring <code>A = {f ∈ k(t)⟦Y⟧ | f(0) ∈ k}</code>, and then <code>A[X]</code>. there are two instances of <code>PowerSeries.C RatFunc.X</code> in that file and no mention of just <code>RatFunc.X</code> alone. But then it gets more complicated with <code>A[X]</code>. I think in the new scheme it would be:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">⟦</span><span class=\"n\">Y</span><span class=\"bp\">⟧</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subring</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">⟦</span><span class=\"n\">Y</span><span class=\"bp\">⟧</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 541082813,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758654779
    },
    {
        "content": "<p>I don't understand your last example. You mention <code>A[X]</code>, so <code>X</code> would be something like a polynomial variable, but then you talk about <code>RatFunc.X</code>(so <code>A(X)</code>, rather?) and then <code>PowerSeries.C RatFunc.X</code>(so <code>A(X)[[z]]</code>?)</p>",
        "id": 541085324,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1758655787
    },
    {
        "content": "<p>sorry, I'm referring to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">RatFunc</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n<span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"bp\">⟦</span><span class=\"n\">Y</span><span class=\"bp\">⟧</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PowerSeries</span><span class=\"bp\">.</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">RatFunc</span><span class=\"bp\">.</span><span class=\"n\">X</span>\n</code></pre></div>",
        "id": 541085478,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758655851
    },
    {
        "content": "<p>I'm pointing out that in the PR they never mentioned the first one (just <code>RatFunc.X</code>), and mentioned the second one twice (<code>PowerSeries.C RatFunc.X</code>)</p>",
        "id": 541085585,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758655890
    },
    {
        "content": "<p><code>A[X]</code> appears as one more layer of complication in the PR, the PR basically talks about both the ring <code>A</code> and then <code>A[X]</code></p>",
        "id": 541085725,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758655944
    },
    {
        "content": "<p>My point is that, if we talk about <code>R[X][Y]</code>, it's precisely because we want to do something in the ring <code>R[X]</code> (and for that we need <code>X</code> in <code>R[X]</code>) and then use its properties to get something in <code>R[X][Y]</code>. Otherwise, we would use <code>R[X, Y]</code>.</p>",
        "id": 541085732,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1758655947
    },
    {
        "content": "<p>my point is that the PR talks about A and A[X], as two rings (so it would make sense to have two <code>poly_variable</code> commands), but Bivariate only talks about one ring R[X][Y] and not the smaller ring R[X] (so it would make sense to just have one <code>poly_variable</code> command).</p>",
        "id": 541085884,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758656009
    },
    {
        "content": "<p>feel free to read the <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Polynomial/Bivariate.html#top\">bivariate file</a>, I don't think they used the smaller ring R[X].</p>",
        "id": 541086005,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758656070
    },
    {
        "content": "<p>well, never is a strong word, they do have some auxiliary lemmas on that (e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Polynomial/Bivariate.html#Polynomial.evalEval_C\">Polynomial.evalEval_C</a>)</p>",
        "id": 541086115,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758656119
    },
    {
        "content": "<p>I think my preferred choice is that if you do want to talk about the smaller ring R[X], then you should do <code>poly_variable</code> twice:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">][</span><span class=\"n\">y</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and yes I think you should have two different names for <code>t</code> and <code>x</code>, because even though mathematically they might be ZFC-equal, in Lean's type theory they are different objects.</p>",
        "id": 541086265,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758656185
    },
    {
        "content": "<p>I think whether or not you care about <code>Polynomial.X (R := R)</code> more or <code>Polynomial.C Polynomial.X</code> more, there should still be a way to refer to <code>Polynomial.C Polynomial.X</code> by one letter. (if I understand correctly, your proposal is to instead refer to it as <code>Polynomial.C x</code>.)</p>",
        "id": 541086353,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758656223
    },
    {
        "content": "<p>Well, when we have a ring <code>A</code>, an element <code>a</code> in <code>A</code> and we want to refer to it in <code>A[Y]</code>, we use <code>C a</code>. That's the design we have in mathlib. I don't understand why you would want to do it differently when <code>A = R[X]</code> and <code>a = X</code>. The bivariate file is probably a little bit weird in this respect because it's used to craft by hand a two variables polynomial ring (instead of just using <code>R[X, Y]</code> which would probably be a better idea), but mathematically most of the time we use <code>R[X][Y]</code> and not <code>R[X, Y]</code> it's precisely because we don't want the two variables to play the same role.</p>",
        "id": 541100657,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1758661888
    },
    {
        "content": "<p>Well, I don't know as much mathematics as you do, but I think one of my mental models of <code>R[x1, ..., xn]</code> is just <code>R[x1][x2][x3]...[xn]</code>, in fact I'm sure some theorems implicitly use this \"definition\" (in the land of notation abuse that is widely accepted in maths),</p>\n<p>And apart from this example there is also the <code>k(t)⟦Y⟧</code> above where <code>t</code> and <code>Y</code> have play an equal role. I don't know if there are other examples of these \"stacked polynomial-like rings\", so more examples are welcome.</p>\n<p>In any case your usecase can be done via:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])[</span><span class=\"n\">Y</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 541101980,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758662458
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541101980\">said</a>:</p>\n<blockquote>\n<p>In any case your usecase can be done via:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])[</span><span class=\"n\">Y</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Ah, that's the important information! If the syntax allows both, then it's perfectly fine. This is the kind of thing that should definitely be discussed in the file-level docstring.</p>",
        "id": 541154882,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1758696985
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I don't think PR is a great place for discussion, can we continue the discussion here?</p>",
        "id": 541196802,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758710543
    },
    {
        "content": "<p>For reference, they said that they don't want iterated brackets to be supported.</p>",
        "id": 541196837,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758710557
    },
    {
        "content": "<p>is that the secret maintainer stream's opinion or your own opinion? I don't know what the consensus is in the secret maintainers' stream</p>",
        "id": 541196962,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758710608
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> well the syntax is very flexible and I feel like the fact that it allows this is a corollary and I can't foresee every possible usecase to be included in the docstring but sure I can include this case.</p>",
        "id": 541197961,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758710951
    },
    {
        "content": "<p>I have now added a long explanation in the beginning of the file to explain how the command works.</p>",
        "id": 541474589,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758810947
    },
    {
        "content": "<p>This functionality looks great, and it's wonderful to see all the problems that have been solved here! I would like to give the meta code a thorough review, if it is welcome.</p>\n<p>However, my first comment is general: I am concerned about the heavy reliance on syntax throughout. I worry that this makes the notation potentially fragile, and susceptible to behaving in unexpected ways as a result.</p>\n<p>For example, I think users would expect identifiers leading the polynomial type to behave like identifiers elsewhere (and it would be nice if they did), but reliance on pure syntax at certain stages breaks things here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kd\">@[</span><span class=\"n\">instance</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span><span class=\"bp\">.</span><span class=\"n\">semiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span>\n\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"n\">z</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> Elaborates, but does not delaborate correctly: -/</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"n\">z</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Polynomial (MvPolynomial (Fin 3) Bar) : Type</span>\n<span class=\"c\">/-</span><span class=\"cm\"> Does not elaborate -/</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"n\">z</span><span class=\"o\">][</span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- Bar[x,y,z][C] is not a declared polynomial-like notation.</span>\n</code></pre></div>\n<p>My suspicion is that something like this is not an isolated edge case, but an instance of broader fragility arising from working in syntax when the meaning in this specific situation seems to lie naturally at the <code>Expr</code> level.</p>\n<p>In contrast, by working with <code>Expr</code>s, we would automatically respect namespacing for idents, allow different syntax to refer to the same base ring, be able to log more descriptive errors, and be able to handle different delaboration results for the same base ring robustly (due to e.g. different prettyprinting options). (We could also open the door to more complex use cases down the line, like ring expressions with holes, which I suspect would be useful, and more general multivariate handling.)</p>\n<p>It would also be easier to address the issue raised by <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span>, which could be addressed by having <code>x</code> elaborate to an expression of either type <code>R[x]</code> or <code>R[x][y]</code> based on the expected type (using a sensible default if the expected type does not exist or does not match). I also believe the code itself might be simpler and more maintainable (but the jury is really out on this until it's implemented).</p>\n<p>You and Jovan have done a <em>lot</em> of work on this already, though, so I realize what it means to suggest changes to the core approach (and am certainly in no position to insist on it)! But if you and/or the maintainers think that this is a reasonable take, I would be happy to either contribute to this PR or answer questions about an <code>Expr</code>-level implementation. (I'd also be happy to outline the algorithm I'm imagining.)</p>\n<p>Or, if you disagree, would you mind explaining why syntax is a reasonable choice here and does not introduce fragility? (Indeed, sometimes syntax transformations are appropriate, due to e.g. the ability to exploit cleverness and robustness in the elaboration of the resulting syntax!) I'll also note that I'm interested in the general case, not just this specific issue I found to illustrate the point.</p>",
        "id": 541533825,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758829613
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> thanks a lot for your feedback! my rationale of using syntax is that it allows for more flexibility, such as:</p>\n<ol>\n<li>not having to think about whether <code>Polynomial.C</code> is a function or a ring hom (the <code>.C</code> are actually quite uniform in this regard: they are all ring homs)</li>\n<li>not having to think about which instances to synthesize, where this time actually the different functors assume different instances: <code>PowerSeries</code> and <code>MvPowerSeries</code> assumes nothing, <code>Polynomial</code> assumes <code>Semiring</code>, <code>MvPolynomial</code> assumes <code>CommSemiring</code>, <code>RatFunc</code> assumes <code>CommRing</code>, and <code>LaurentSeries</code> assumes <code>Zero</code>.</li>\n</ol>\n<p>It is unfortunate that this leads to namespace issues as you have discovered, but I don't see how to make the base ring an <code>Expr</code> without having to also build <code>Expr</code> for the whole type... I thought <code> ``Foo.Bar </code> usually solves issues like this.</p>\n<p>Do you understand what's happening in the following code?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">notation3</span><span class=\"w\"> </span><span class=\"s2\">\"%67\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">67</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">67</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Bar</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n</code></pre></div>\n<p>I don't think it's a good idea to have <code>x</code> mean different things with different expected types; this would require writing type ascriptions everywhere, and introduces an extra layer of confusion. I don't think one should view <code>R[x]</code> as a subtype of <code>R[x][y]</code> in the context of Lean.</p>",
        "id": 541538538,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758831650
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541538538\">said</a>:</p>\n<blockquote>\n<ol>\n<li>not having to think about whether <code>Polynomial.C</code> is a function or a ring hom (the <code>.C</code> are actually quite uniform in this regard: they are all ring homs)</li>\n</ol>\n</blockquote>\n<p>I see; I do indeed consider that a good example of when to use syntax, since we're relying on (d)elaboration complexity in <code>Polynomial.C</code> syntax applications. :) It's possible, though, that we should still elaborate the application at <code>poly_variable</code>, then store and use/match against the resulting <code>Expr</code> instead of hoping that the syntax we choose (d)elaborates everywhere correctly. (Note also that <code>@[app_delab Polynomial.C]</code> has no problem seeing through <code>DFunLike.coe</code>.)</p>\n<blockquote>\n<ol start=\"2\">\n<li>not having to think about which instances to synthesize, where this time actually the different functors assume different instances: <code>PowerSeries</code> and <code>MvPowerSeries</code> assumes nothing, <code>Polynomial</code> assumes <code>Semiring</code>, <code>MvPolynomial</code> assumes <code>CommSemiring</code>, <code>RatFunc</code> assumes <code>CommRing</code>, and <code>LaurentSeries</code> assumes <code>Zero</code>.</li>\n</ol>\n</blockquote>\n<p>I'm a little confused by this. I don't believe we'd have to worry about which instances have to be synthesized when working at the <code>Expr</code> level; most of that is taken care of in uniform ways by the relevant parts of the meta API. Where are you worried about having to do this?</p>",
        "id": 541549630,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758836947
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> how would you synthesize the <code>Semiring R</code> to make a valid expression that we read as <code>Polynomial R</code>?</p>",
        "id": 541549952,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837148
    },
    {
        "content": "<p>i'm referring to the step where the command is supposed to build the correct <code>Expr</code> that say <code>R[x,y]</code> should expand to</p>",
        "id": 541549995,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837185
    },
    {
        "content": "<p>You mean during <code>poly_variable</code>, or when elaborating <code>R[x,y]</code> later?</p>",
        "id": 541550091,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758837251
    },
    {
        "content": "<p>well I suppose that <code>poly_variable</code> would build the expression once, and later when you type <code>R[x,y]</code> it will just use the same expression that it built... wait this wouldn't work for section variables</p>",
        "id": 541550218,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837331
    },
    {
        "content": "<p>I think the fact that we support section variables is another point for keeping this within syntax</p>",
        "id": 541550269,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837356
    },
    {
        "content": "<p>Right, you would need to abstract the variables, then fill them back in. But depending on the implementation, the right telescoping function and/or application functions create mvars for the instance arguments (and either synthesize them or let us synthesize them) without needing to go one-by-one.</p>",
        "id": 541550552,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758837505
    },
    {
        "content": "<p>do you know which function does that? I might have seen such a function, my metaprogramming knowledge is not very deep</p>",
        "id": 541550613,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837547
    },
    {
        "content": "<p>(I also don't know what's an effective way to look for something like this, I don't think the metaprogramming documentation is very complete)</p>",
        "id": 541550665,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837578
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mkAppM#doc\">docs#Lean.Meta.mkAppM</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.lambdaMetaTelescope#doc\">docs#Lean.Meta.lambdaMetaTelescope</a> come to mind off the top of my head as relevant here; <code>mkAppM</code> synthesizes instances immediately, but an alternative (standard) strategy is to make sure the metavariables created for the instance-implicit arguments have been added to the list of pending metavariables (in the <code>TermElabM</code> state), and make sure that these get synthesized later in elaboration (see e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.withSynthesize#doc\">docs#Lean.Elab.Term.withSynthesize</a>)</p>",
        "id": 541551198,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758837862
    },
    {
        "content": "<p>thansk for the pointers!</p>",
        "id": 541551285,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837913
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541550269\">said</a>:</p>\n<blockquote>\n<p>I think the fact that we support section variables is another point for keeping this within syntax</p>\n</blockquote>\n<p>There's an issue with these that I've written down as one of my review comments, but haven't raised yet to keep focused! Namely:</p>\n<ul>\n<li>In the following:<br>\n<code>\n  variable (R : Type) [Semiring R]\n  poly_variable R[x]\n  example {R : Type} [Semiring R] : R[x] := ...\n  </code><br>\n  I would expect that <code>R[x]</code> would refer to the <code>R</code> that's accessible in the local context at the type, not the variable. But maybe this is a <code>notation3</code> issue? (Note that delaboration breaks here as well.)</li>\n</ul>",
        "id": 541551328,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758837935
    },
    {
        "content": "<p>what does that output?</p>",
        "id": 541551381,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758837971
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541551328\">said</a>:</p>\n<blockquote>\n<ul>\n<li>I would expect that <code>R[x]</code> would refer to the <code>R</code> that's accessible in the local context at the type, not the variable</li>\n</ul>\n</blockquote>\n<p>I would expect otherwise... syntax already has some good built-in hygiene</p>",
        "id": 541551461,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838019
    },
    {
        "content": "<p>But normally, the identifier <code>R</code> at that point in the type would refer to the accessible <code>R</code>, not the shadowed <code>R</code>. I don't consider referring to the shadowed <code>R</code> as referring to the \"correct\" <code>R</code> here (since <code>variable</code>s are just there to be automatically-added free variables in each theorem's local context, not the \"same\" variable for each theorem).</p>",
        "id": 541551909,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758838272
    },
    {
        "content": "<p>so, going back to the namespace issue, is that something that can be fixed at the level of syntax? I think right now the namespace issue is a point for Expr, but still Syntax feels better for the stuff with instances</p>",
        "id": 541552147,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838318
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541551909\">said</a>:</p>\n<blockquote>\n<p>But normally, the identifier <code>R</code> at that point in the type would refer to the accessible <code>R</code></p>\n</blockquote>\n<p>I feel like you're probably a bit underestimating the power of hygiene, it was in fact a bit tricky for me to deal with as well</p>",
        "id": 541552209,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838368
    },
    {
        "content": "<p>I think you might be misunderstanding my point; I'm claiming that <code>R</code> <em>should</em> refer to the accessible <code>R</code>, and referring to the inaccessible, shadowed <code>R</code> is <em>not good behavior</em>. :)</p>",
        "id": 541552303,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758838444
    },
    {
        "content": "<p>well, I disagree with this point, I think <code>poly_variable</code> should create notations that point to one fixed ring (and a list of fixed elements of that ring) and its meaning shouldn't change depending on context</p>",
        "id": 541552460,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838546
    },
    {
        "content": "<p>actually your usecase is covered by <code>poly_variable _[t]</code> which I forgot to mention in the docstring</p>",
        "id": 541552497,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838573
    },
    {
        "content": "<p>The command <code>variable (R : Type)</code>, though, does not create \"one fixed ring\". Rather, it allows each theorem to have a free variable <code>R : Type</code> in its local context. So referring to the <code>R</code> introduced by <code>variable</code> does not actually achieve the goal of referring to \"one fixed ring\".</p>",
        "id": 541552554,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758838615
    },
    {
        "content": "<p>hmm....</p>",
        "id": 541552580,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838633
    },
    {
        "content": "<p>maybe we disagree on what <code>variable</code> means <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>",
        "id": 541552606,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838651
    },
    {
        "content": "<p>Further, sometimes theorems deliberately shadow <code>variable</code>s to change the plicity or argument order (and thus exclude them from the resulting type), which is why this is not just a contrived example. :)</p>",
        "id": 541552794,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758838800
    },
    {
        "content": "<p>so, going back to your interpretation, if you choose to interpret <code>variable R</code> as \"any arbitrary ring\", does <code>poly_variable _[t]</code> cover this usage?</p>",
        "id": 541552865,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758838858
    },
    {
        "content": "<p>No; I believe <code>R</code> should not be \"any arbitrary ring\", but \"any ring in the local context with the name <code>R</code> and correct type\"</p>",
        "id": 541553050,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758838991
    },
    {
        "content": "<p>well... I understand where you're coming from, sometimes I also have to shadow variables, but I feel like it's actually rather a limitation of Lean that when you shadow variables they kind of still exist in the local context (with a dagger attached), so then I have come to interpret them as actually new variables</p>",
        "id": 541553129,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839072
    },
    {
        "content": "<p>I think I try to avoid shadowing variables as much as possible due to this, so you will see mathlib files structured like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">CommSemiring</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommSemiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">lemmas</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">CommSemiring</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Field</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">lemmas</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Field</span>\n</code></pre></div>",
        "id": 541553199,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839127
    },
    {
        "content": "<p>Consider the following to see the behavior of <code>variable</code> I'm talking about:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"c1\">-- bar (R : Type) : R</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">bar'</span><span class=\"w\"> </span><span class=\"c1\">-- bar' (R : Type) : R</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"c1\">-- foo {R : Type} : R</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"c1\">-- baz {R : Prop} : R</span>\n</code></pre></div>\n<p><code>bar</code> winds up with its own argument <code>R</code> which is unrelated to the <code>R</code> in <code>bar'</code>. Further, when <code>foo</code> changes the plicity or <code>baz</code> changes the type so that the shadowed <code>R</code> no longer appears in the type, it is not present in the type of the resulting declaration (the user expects it to be gone).</p>",
        "id": 541553202,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758839131
    },
    {
        "content": "<p>and expanding on my previous point I've come to adopt the practice of using <code>variable {R}</code> or <code>variable {R} in</code></p>",
        "id": 541553257,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839170
    },
    {
        "content": "<p>I agree that this is good style when possible, but does not allow fine-tuning of argument order. :)</p>",
        "id": 541553341,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758839235
    },
    {
        "content": "<p>I think I would also like to know what other people think about shadowing variables</p>",
        "id": 541553348,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839243
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541553341\">said</a>:</p>\n<blockquote>\n<p>I agree that this is good style when possible, but does not allow fine-tuning of argument order. :)</p>\n</blockquote>\n<p>again, a limitation of Lean <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>",
        "id": 541553363,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839255
    },
    {
        "content": "<p>I also would not want to insist on this style before the notation behaves as the user probably expects.</p>",
        "id": 541553380,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758839267
    },
    {
        "content": "<p>well I think me and you are expecting different things</p>",
        "id": 541553412,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839295
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541553363\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541553341\">said</a>:</p>\n<blockquote>\n<p>I agree that this is good style when possible, but does not allow fine-tuning of argument order. :)</p>\n</blockquote>\n<p>again, a limitation of Lean <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>\n</blockquote>\n<p>Is it? <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> I think being able to just write the type signature as you want it, knowing that variables inaccessible to you are gone, is actually a feature!</p>",
        "id": 541553466,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758839338
    },
    {
        "content": "<p>they are gone in the resulting type, but you can still see them inside the declaration</p>",
        "id": 541553516,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839384
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/fxFuzjSh9kj7piht3zrgnJ3W/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/fxFuzjSh9kj7piht3zrgnJ3W/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"728x153\" src=\"/user_uploads/thumbnail/3121/fxFuzjSh9kj7piht3zrgnJ3W/image.png/840x560.webp\"></a></div>",
        "id": 541553591,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839436
    },
    {
        "content": "<p>Sure, but shadowed. No usage of <code>R</code> in syntax will refer to it, which is why the usage of <code>R</code> in polynomial syntax referring to it is, imo, unexpected.</p>",
        "id": 541553740,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758839539
    },
    {
        "content": "<p>Indeed, I understand your reasoning, so I understand why you would expect what you expect, but that doesn't change the fact that I interpret things differently, so I expect different things.</p>",
        "id": 541553920,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839678
    },
    {
        "content": "<p>let me give you another example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">FOo</span>\n</code></pre></div>\n<p>What would you expect here?</p>",
        "id": 541554045,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758839768
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541552147\">said</a>:</p>\n<blockquote>\n<p>so, going back to the namespace issue, is that something that can be fixed at the level of syntax? I think right now the namespace issue is a point for Expr, but still Syntax feels better for the stuff with instances</p>\n</blockquote>\n<p>My intuition says the elaboration issue can possibly(?) be fixed without too much trouble—the delaboration issue is harder. The real issue to me is that it feels like we're taping leaks shut on a somewhat fragile hull, rather than working at the appropriate level of abstraction. But I agree that syntax manipulations certainly have their place in this PR, given your point about <code>Polynomial.C</code>—my concern is where. :) (Alternatively, there should/could be meta API somewhere that handles <code>DFunLike.coe</code> coercions when applying constants automatically, which would make these sorts of applications straightforward.)</p>",
        "id": 541554837,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758840164
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541554837\">said</a>:</p>\n<blockquote>\n<p>my concern is where</p>\n</blockquote>\n<p>I think as we have discussed above, elaborating the base ring seems to be better in Expr-land, but then calculating the big ring and the terms afterwards seems to be suited in Syntax-land, but then this puts us in an impossible situation...</p>",
        "id": 541554940,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758840240
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541554837\">said</a>:</p>\n<blockquote>\n<p>My intuition says the elaboration issue can possibly(?) be fixed without too much trouble—the delaboration issue is harder.</p>\n</blockquote>\n<p>is the issue that constants and variables are indistinguishable on the level of the syntax? as in, they are both <code> `(term|$i:ident)</code></p>",
        "id": 541555013,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758840294
    },
    {
        "content": "<p>like I agree that if constants vs. variables are indistinguishable in Syntax then they are better suited for Expr</p>",
        "id": 541555083,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758840347
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541554045\">said</a>:</p>\n<blockquote>\n<p>let me give you another example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">FOo</span>\n</code></pre></div>\n<p>What would you expect here?</p>\n</blockquote>\n<p>I would expect this to be unrelated to how <code>variable</code> is handled, since resolving a global constant in the current namespace is to me a different process than resolving an identifier in the local context with respect to variable shadowing. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>\n<p>But to address this case as well, I would actually want it to resolve the ident as it would when <em>not</em> in the notation, i.e. as <code>Foo.Bar</code>, and then error—the same way <code>Polynomial Bar</code> would error. Having <code>Bar[t]</code> mean a different <code>Bar</code> than the current <code>Bar</code> is, I think, confusing. It might make me think I had declared the notation when I hadn't. (A more helpful approach would be to find all possible resolutions of the constant, then tell me that while <code>Foo.Bar</code> doesn't work, <code>Bar</code> does.)</p>",
        "id": 541556353,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758841292
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541556353\">said</a>:</p>\n<blockquote>\n<p>I would expect this to be unrelated to how <code>variable</code> is handled, since resolving a global constant in the current namespace is to me a different process than resolving an identifier in the local context with respect to variable shadowing.</p>\n</blockquote>\n<p>Indeed, I understand your point, but I think my brain treats them the same</p>",
        "id": 541556415,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758841340
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541556353\">said</a>:</p>\n<blockquote>\n<p>resolve the ident</p>\n</blockquote>\n<p>ok, fair enough, what if it's a term involving an ident?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Wrapper</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Wrapper</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Wrapper</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n</code></pre></div>",
        "id": 541556559,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758841427
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541554940\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541554837\">said</a>:</p>\n<blockquote>\n<p>my concern is where</p>\n</blockquote>\n<p>I think as we have discussed above, elaborating the base ring seems to be better in Expr-land, but then calculating the big ring and the terms afterwards seems to be suited in Syntax-land, but then this puts us in an impossible situation...</p>\n</blockquote>\n<p>A pattern I might expect here is to do our necessary syntax manipulations first, within a larger <code>TermElabM</code> elaborator. We can possibly have the best of both worlds. :)</p>",
        "id": 541556643,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758841473
    },
    {
        "content": "<p>I would also like to have a substitutable syntax but I don't think I have found it</p>",
        "id": 541556710,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758841513
    },
    {
        "content": "<p>like ideally I want a syntax <code> i : Term &lt;- `(Polynomial (Polynomial $a))</code> and then have <code>i.subst (a := &lt;- `(R))</code></p>",
        "id": 541556781,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758841572
    },
    {
        "content": "<p>even if I have that (I used to do that by storing an <code>Array</code> of the functor <code>Term</code>s), I don't think I can apply it to an <code>Expr</code>...</p>",
        "id": 541556829,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758841626
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541555013\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541554837\">said</a>:</p>\n<blockquote>\n<p>My intuition says the elaboration issue can possibly(?) be fixed without too much trouble—the delaboration issue is harder.</p>\n</blockquote>\n<p>is the issue that constants and variables are indistinguishable on the level of the syntax? as in, they are both <code> `(term|$i:ident)</code></p>\n</blockquote>\n<p>I think the issue is that the <code>ident</code>s we get from delaboration are different (since they depend on the namespace we're in) than the ones we are matching against. We could try normalizing both to their global forms first, but I don't think we would have to worry about this if delaborating from <code>Expr</code>s directly.</p>",
        "id": 541556859,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758841661
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541556559\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541556353\">said</a>:</p>\n<blockquote>\n<p>resolve the ident</p>\n</blockquote>\n<p>ok, fair enough, what if it's a term involving an ident?</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Wrapper</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Wrapper</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Wrapper</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">)[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I'd expect idents to resolve to the same thing in all cases, personally! I.e., this should fail for the same reasons I think the prior example should fail—because <code>Bar</code> should now refer to <code>Foo.Bar</code>.</p>",
        "id": 541557041,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758841803
    },
    {
        "content": "<p>I feel like you want some sort of syntactic behaviour (by having <code>Bar</code> as an ident rather than the expression <code>.const Bar []</code>), but you also want some sort of expression behaviour; or rather, you want to do some sort of further matching when elaborating a declared notation, rather than just storing one term; this would also put more pressure on the delaborator.</p>",
        "id": 541557214,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758841942
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541556781\">said</a>:</p>\n<blockquote>\n<p>like ideally I want a syntax <code> i : Term &lt;- `(Polynomial (Polynomial $a))</code> and then have <code>i.subst (a := &lt;- `(R))</code></p>\n</blockquote>\n<p>This sort of thing is rather straightforward when working with <code>Expr</code>s. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> First we abstract the fvars to get a lambda expression (there is API for this), then later we form expression applications with the thing we want to substitute in and beta-reduce. (Or, we form a lambda telescope, then assign the mvars.) (There is API for all of this as well.)</p>",
        "id": 541557359,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758842066
    },
    {
        "content": "<p>I take it that you're not in the qq camp?</p>",
        "id": 541557429,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758842113
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541557214\">said</a>:</p>\n<blockquote>\n<p>I feel like you want some sort of syntactic behaviour (by having <code>Bar</code> as an ident rather than the expression <code>.const Bar []</code>), but you also want some sort of expression behaviour; or rather, you want to do some sort of further matching when elaborating a declared notation, rather than just storing one term; this would also put more pressure on the delaborator.</p>\n</blockquote>\n<p>I think your intuition is probably good here, and I do think that this is one of the junctures at which <code>Syntax</code> can be helpful; it really depends on the stage of elaboration we're at, and what we're elaborating, imo. Without talking more about  which part of the situation we're addressing here exactly, it's hard for me to say if I agree or disagree, though. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 541557737,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758842354
    },
    {
        "content": "<p>so, basically, after <code>poly_variable ($term)[t]</code>, you want <code>($term)[t]</code> to elaborate to the following:</p>\n<ol>\n<li>elaborate <code>($term)</code> here (instead of at the point of the <code>poly_variable</code> command) to an expression <code>termE : Expr</code></li>\n<li>then do some expression-level transformation (using some of the magic functions above) to form what amounts to <code>q(Polynomial $termE)</code> but not really (or maybe really)</li>\n</ol>",
        "id": 541557863,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758842430
    },
    {
        "content": "<p>the problem seems to be that for 1, the string you see is not the full syntax; so the <strong>code</strong> <code>R</code> actually becomes two different syntaxes in two different contexts, so the pseudocode above won't even trigger</p>",
        "id": 541557947,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758842503
    },
    {
        "content": "<p>so now it's not an issue of syntax or expr, you're asking for something impossible here</p>",
        "id": 541557973,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758842525
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541557429\">said</a>:</p>\n<blockquote>\n<p>I take it that you're not in the qq camp?</p>\n</blockquote>\n<p>I am actually s<code>Qq</code>uarely in the Qq camp! <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> It might certainly help out in this sort of situation in general. But it does help the most when you want to construct specific expressions (possibly with nonspecific antiquotations, of course) at elaboration time of your <em>meta code</em>.</p>\n<p>At the level of generality we're working at here, with very general expressions at just about every stage, I think Qq might be of limited utility, though. (I could be wrong here though, and would be happy to be.) (If we were constructing these notations by hand on a per-instance basis, I'd think differently.)</p>",
        "id": 541558095,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758842595
    },
    {
        "content": "<p>for 1 you're instead asking for the level of the code (code -&gt; syntax -&gt; expr -&gt; virtual machine), where the bytes of the source code literally matches the string <code>Wrapper Bar</code></p>",
        "id": 541558097,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758842598
    },
    {
        "content": "<blockquote>\n<p>for 1, the string you see is not the full syntax; so the <strong>code</strong> <code>R</code> actually becomes two different syntaxes in two different contexts, so the pseudocode above won't even trigger</p>\n</blockquote>\n<p>I'm a bit lost here. Are you talking about specifically for expressions which involve section variables?</p>",
        "id": 541558252,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758842732
    },
    {
        "content": "<p>whichever case, section variables or namespace constants</p>",
        "id": 541558311,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758842779
    },
    {
        "content": "<p>Ah, I just caught</p>\n<blockquote>\n<p>(instead of at the point of the <code>poly_variable</code> command)</p>\n</blockquote>\n<p>No, I would imagine elaborating at the point of the <code>poly_variable</code> command.</p>",
        "id": 541558333,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758842795
    },
    {
        "content": "<p>I can write down a high-level outline for the algorithm I have in mind, which might be the most clear here. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 541558357,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758842819
    },
    {
        "content": "<p>However, my high-level outline was formed before you brought up the usefulness of syntax in forming these applications re: ring homs and the like. Let me break to eat, think it over so that I don't waste your time suggesting something incomplete, and get back to you with something more concrete. :)</p>",
        "id": 541558758,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758843079
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare \"</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"%67\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">67</span>\n</code></pre></div>",
        "id": 541558853,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758843147
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> what do you think about this?</p>",
        "id": 541558857,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758843151
    },
    {
        "content": "<p>(I'd also still like to bring up some review comments, but will hold off on those until we finish this dicussion! :) )</p>",
        "id": 541558894,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758843183
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541558853\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">axiom</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#declare \"</span><span class=\"w\"> </span><span class=\"n\">poly</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"%67\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">poly</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">declare</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"mi\">67</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>(First reaction, the nested <code>Qq</code> within an <code>elab</code> within a quotation within another <code>elab</code> looks rather cursed to me <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>)</p>",
        "id": 541558987,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758843259
    },
    {
        "content": "<p>I think the point is to show you antiquoting of term in qq</p>",
        "id": 541559264,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758843492
    },
    {
        "content": "<p>which seems to be what you want</p>",
        "id": 541559273,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758843501
    },
    {
        "content": "<p>So, I am a little wary of the approach of \"construct the syntax of the specific command we would use if we were defining a single notation, then elaborate it\" as opposed to \"do the thing we want to do directly, in general\". I feel that acting directly is a little more maintainable.</p>\n<p>I'd like to think a bit more before suggesting anything, since there are a couple of different approaches available. (For example, for elaborating the polynomial ring: when encountering <code>R[x,y,z][w]</code> in <code>poly_variable</code>, one could store the polynomial ring expression in the env extension; then during elaboration, infer the functors from the bracketing, apply them on the syntax level, elaborate, <em>then</em> attempt to match against the stored expr. Or one could attempt to elaborate &amp; store the base ring, match against that when elaborating and then apply the functors on the <code>Expr</code> level, etc.)</p>",
        "id": 541568164,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758849962
    },
    {
        "content": "<p>I'm going to return to this tomorrow (<strong>edit</strong>: Tuesday is actually when I am first free again!), but I'll also leave tonight with some other review comments/questions. (I'll put each one in a separate message, so they can easily be responded to!) If some internals are going to change, it might not make sense to address them yet, but at least they can be discussed.</p>",
        "id": 541568273,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758850083
    },
    {
        "content": "<ul>\n<li><code>poly_variable R[x]</code> should probably check that the required instances are actually available for <code>R</code>, and error if not; instead, the user is only made aware of this later, when attempting to use the notation.</li>\n</ul>",
        "id": 541568283,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758850093
    },
    {
        "content": "<ul>\n<li>I would expect <code>poly_variable R[x,y][z]</code> to also set up <code>R[x,y]</code>. Is there a reason it doesn't?</li>\n</ul>",
        "id": 541568290,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758850104
    },
    {
        "content": "<ul>\n<li>I believe the error messages in the following situations could be improved:<ul>\n<li>When re-using a variable name in a <code>poly_variable</code> declaration (e.g. <code>poly_variable R[x]</code> and then <code>poly_variable S[x]</code>). Currently the error is <code>unexpected token 'x'; expected poly_closing</code>. A better error message could be achieved by parsing a <code>poly_var &lt;|&gt; ident</code>, then logging a descriptive error on <code>poly_var</code>s (ideally, telling the user which notation it is registered in).</li>\n<li>When writing incorrect type notation—e.g. <code>R[x,y][z]</code> when only <code>R[x,y][w]</code> is registered. It would be helpful to tell the user which notations <em>were</em> registered for <code>R</code>/<code>R[x,y]</code>.</li>\n</ul>\n</li>\n</ul>",
        "id": 541568310,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758850122
    },
    {
        "content": "<p>And finally, a softer question:</p>\n<ul>\n<li>Are we sure it ought to be named <code>poly_variable</code> instead of e.g. <code>poly_notation</code>? <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span> It does name the variables, but it also sets up the syntax for the type. Its functionality is also not very similar to <code>variable</code>, and the \"variables\" of a polynomial are very different beasts than the free variables of <code>variable</code>. (If we like <code>poly_notation</code>, it might make sense to change <code>register_poly_notation</code> to something like <code>register_poly_brackets</code>.)</li>\n</ul>",
        "id": 541568357,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1758850174
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541568283\">said</a>:</p>\n<blockquote>\n<ul>\n<li><code>poly_variable R[x]</code> should probably check that the required instances are actually available for <code>R</code>, and error if not; instead, the user is only made aware of this later, when attempting to use the notation.</li>\n</ul>\n</blockquote>\n<p>this would make sense if we are building <code>Expr</code>, but wouldn't make sense if we are building syntax. note that the existing <code>name_poly_vars</code> also doesn't check the comm_semiring instance.</p>",
        "id": 542455340,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759312983
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541568290\">said</a>:</p>\n<blockquote>\n<ul>\n<li>I would expect <code>poly_variable R[x,y][z]</code> to also set up <code>R[x,y]</code>. Is there a reason it doesn't?</li>\n</ul>\n</blockquote>\n<p>see the whole discussion above with <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span>. Some people (including him) hold the opinion that <code>R[x,y][t]</code> means we are talking about two rings, but some people (including me) have the opposite opinion that <code>R[x,y][t]</code> means one big ring. The concrete difference is whether <code>x</code> belongs to a subring <code>R[x,y]</code> or the big ring <code>R[x,y][t]</code>.</p>\n<p>And I noted that his interpretation can be done by the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">]</span>\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">])[</span><span class=\"n\">t</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>To which he said that I should document this, which I did.</p>\n<p>But personally I prefer:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"n\">b</span><span class=\"o\">]</span>\n<span class=\"n\">poly_variable</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">][</span><span class=\"n\">t</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>that is, I would prefer to use a completely different letter to refer to the element of the subring.</p>",
        "id": 542455976,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759313175
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541568310\">said</a>:</p>\n<blockquote>\n<ul>\n<li>A better error message could be achieved by parsing a <code>poly_var &lt;|&gt; ident</code></li>\n</ul>\n</blockquote>\n<p>I agree with this.</p>",
        "id": 542456118,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759313229
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541568310\">said</a>:</p>\n<blockquote>\n<ul>\n<li>When writing incorrect type notation—e.g. <code>R[x,y][z]</code> when only <code>R[x,y][w]</code> is registered. It would be helpful to tell the user which notations <em>were</em> registered for <code>R</code>/<code>R[x,y]</code>.</li>\n</ul>\n</blockquote>\n<p>That sounds too advanced. You're basically suggesting autocorrection. VSCode does have autocompletion features (when you hit ctrl+space) and if you have a way to hack into that I'm all for it.</p>",
        "id": 542456279,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759313288
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Notation.20for.20polynomial.20variables/near/541568357\">said</a>:</p>\n<blockquote>\n<ul>\n<li>Are we sure it ought to be named <code>poly_variable</code></li>\n</ul>\n</blockquote>\n<p>I am not attached to any names.</p>",
        "id": 542456873,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759313489
    },
    {
        "content": "<p>Great, thanks for answering those questions!</p>\n<p>I've had a chance to think about this (apologies—busy time for me, which spilled over into this week). I wanted to clear my head on this by outlining what exactly the necessary tasks and obligations are at different stages. I arrived at the following:</p>\n<ul>\n<li>when elaborating syntax for a type, we have enough information, in principle (given the positions of the brackets and number of variables they contain, and relying only on the global state created by <code>register_poly_notation</code>), to determine the big ring. Our task, after inferring the expression, is to <em>validate</em> that the bracket sequence is locally registered for the given base ring, and validate that the provided variable names appear as they do in the locally registered syntax.</li>\n<li>when elaborating syntax for a variable, we need to <em>recall</em> the ring it is a generator of, and construct that generator.</li>\n<li>when delaborating an expression, we have to <em>identify</em> the expression as representing a locally registered polynomial ring or variable, and <em>recall</em> the variable names, then construct all the appropriate syntax.</li>\n</ul>\n<p>I'm hoping that breaking it down this way lets us more easily consider when using an <code>Expr</code> approach might be more or less fragile than a <code>Syntax</code> approach.</p>\n<p>(Note also that the first bullet shows why it is not too advanced in principle to</p>\n<blockquote>\n<p>tell the user which notations <em>were</em> registered for <code>R</code>/<code>R[x,y]</code></p>\n</blockquote>\n<p>depending on how we set things up. If we can look up the bracket sequences and variable names registered by matching against the base ring, we can match as much as we can, and report what <em>would</em> be valid on the mismatch. I am specifically talking about error messages here, by the way, not autocomplete!)</p>",
        "id": 542567146,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1759346474
    },
    {
        "content": "<p>If we did want to take an <code>Expr</code>-based approach here, here's an outline describing what that could look like.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Expr-based outline</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<ul>\n<li>at parsing:<ul>\n<li>(no change required) parse everything that looks like some kind of registered notation (when notation is active).</li>\n</ul>\n</li>\n<li>at <code>poly_variable</code>:<ul>\n<li>elaborate base ring term<ul>\n<li>if fvars present, abstract to lambda as appropriate, and remember them (with care)</li>\n<li>store (resulting, abstracted) base ring expr in an env extension (to be matched on at reducible defeq)</li>\n<li>associate it (in said extension) with:<ul>\n<li>a sequence of something like: <code>Functor × PolyVarSeq</code>, where<ul>\n<li><code>Functor</code> tells us the <code>Name</code> of the functor corresponding to the bracket pair, as well as the <code>.X</code> constant and the <code>.C</code> constant</li>\n<li><code>PolyVarSeq</code> holds the (sequence of) variable name(s)/syntax(es) in whatever form is appropriate</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>elaborate result to check that instances get synthesized/notation works (and add hover info)</li>\n<li>note: could also allow mvars in the base ring, and abstract/track those too, like fvars; if so, do not insist that instances are synthesized</li>\n</ul>\n</li>\n<li>(probably no change required) add local syntax for polynomial variable names</li>\n</ul>\n</li>\n<li>at elaboration<ul>\n<li>of types:<ul>\n<li>Elaborate base ring term; check base rings in env extension for a match (handling <code>variable</code>s as well)</li>\n<li>deduce functors (using global state set up by <code>register_poly_notation</code>) bracket pair by bracket pair, and match to the functor sequence stored for the base ring; validate that written variable names match registered variable names. Report any mismatches along with available \"correct\" syntax for the base ring.</li>\n</ul>\n</li>\n<li>of variable names:<ul>\n<li>have a single, global, scoped elaborator for <code>poly_var</code>s which looks up the syntax in the env extension (the state will probably be very small, so a linear scan is probably fine)</li>\n<li>if allowing multiple types:  and constructs the appropriate application. (Note: it is not too hard to coerce a ring hom to a function on the <code>Expr</code> level.)<ul>\n<li>match expected type to possible recorded types. if no match, use a chosen default.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>at <code>register_poly_notation</code><ul>\n<li>associate the bracket pair with the functor, <code>.X</code>, and <code>.C</code> constant names</li>\n<li>set up fixed delaborators for the functor, <code>.X</code>, and <code>.C</code> notation (note: app delaborators can see through <code>DFunLike.coe</code>) which will inspect the state set up by <code>poly_variable</code> and match against the extracted base ring</li>\n</ul>\n</li>\n</ul>\n</div></div>\n<p>I realize this is basically a rewrite, though. (I'd be happy to contribute, but would not want to step on any toes!) While I do think an <code>Expr</code>-based approach would make the notation more robust, predictable, and featureful (e.g. better error messages), I am ultimately not in a position to make the call on whether this PR as-is should or should not make it into Mathlib. An <code>Expr</code>-based approach is just my personal recommendation after considering the PR, but I'll defer to maintainers—and to whether you agree with this approach or not. :)</p>",
        "id": 542567322,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1759346539
    }
]