[
    {
        "content": "<p>The recent PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/14168\">#14168</a> (June 26, 2024) deprecated a number of <code>AlgHom.map_*</code> lemmas on the basis that they are redundant, and asks to replace them with the standard <code>map_*</code> lemma. Unfortunately, this leads to time out problems, in mathlib (as explained in the documentation of the PR), and in the project with <span class=\"user-mention\" data-user-id=\"406490\">@María Inés de Frutos Fernández</span> .</p>",
        "id": 474784764,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1728035517
    },
    {
        "content": "<p>Here is a mwe:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">TensorProduct</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">T₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↥</span><span class=\"n\">T₀</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">↥</span><span class=\"n\">S₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">T₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">S₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">T₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">S₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">T₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">S₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AlgHom</span><span class=\"bp\">.</span><span class=\"n\">map_add</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- But `rw [map_add]` times out.</span>\n</code></pre></div>",
        "id": 474784833,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1728035543
    },
    {
        "content": "<p>The proof <code>exact Eq.symm (map_add (Algebra.TensorProduct.map T₀.val S₀.val) x y)</code> also works in my laptop, but it is slow.<br>\n(In the online editor it also times out).</p>",
        "id": 474785570,
        "sender_full_name": "María Inés de Frutos Fernández",
        "timestamp": 1728035809
    },
    {
        "content": "<p>I also noticed the same thing.</p>",
        "id": 474787942,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1728036611
    },
    {
        "content": "<p>Ugh. Does it still work with <code>rw</code> if you explicitly pass the hom?</p>",
        "id": 474789073,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728036949
    },
    {
        "content": "<p>No, it times out as well.</p>",
        "id": 474789192,
        "sender_full_name": "María Inés de Frutos Fernández",
        "timestamp": 1728036974
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.237288</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">✅️</span><span class=\"w\"> </span><span class=\"n\">NonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">T₀</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S₀</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n</code></pre></div>\n<p>is at least part of the problem.</p>",
        "id": 474898451,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728074615
    },
    {
        "content": "<p>Random hacks like <code>attribute [-instance] Subalgebra.smulCommClass_right in</code> fix the timeout (this is just looking at things in the instance trace which are making things go the long way around)</p>",
        "id": 474898856,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728074835
    },
    {
        "content": "<p>We should try to mwe this further. <span class=\"user-mention\" data-user-id=\"130609\">@Antoine Chambert-Loir</span> I have recorded your MWE as the following issue: </p>\n<blockquote>\n<p><code>map_add</code> times out, and AlgHom.map_* is deprecated <a href=\"https://github.com/leanprover-community/mathlib4/pull/17507\">#17507</a></p>\n</blockquote>",
        "id": 475316878,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728313041
    },
    {
        "content": "<p>Thanks a lot. But I don't know what I can do for it. <br>\n(Actually, it would be useful, and even reasonable, that “advanced” users of Lean start learning seriously this kind of stuff, but for the moment I feel lost there.)</p>",
        "id": 475380752,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1728330635
    },
    {
        "content": "<p>My experience with trying to minimise these things is that the actual problem might be that mathlib is big, so when you try to minimise, things then get much quicker.</p>",
        "id": 475391906,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728333749
    },
    {
        "content": "<p>What I mean is that I have no clue about the internal process ran by the compiler. I only have an abstract understanding (if at all) of all the terms that are uttered here and there — unification, typeclass inference, etc. And the game of setting some option (but which one, how can one remember?) to try to find out remains a mysterious one.</p>",
        "id": 475399277,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1728335552
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"130609\">@Antoine Chambert-Loir</span> I didn't mean to oblige you into more work. Actually, there's ongoing work to help automate further minimization of such problems. So we should wait a bit, but maybe this isn't a skill that people should invest in for the future.</p>",
        "id": 475465945,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728361501
    },
    {
        "content": "<p>I commented on the GitHub issue by the way. I think it's pretty clear what the problem is, but the only solution I can think of is a massive refactor of mathlib changing the way the order hierarchy interacts with the algebra hierarchy.</p>\n<p>I'll repeat my thoughts here: the issue is that whenever faced with a goal of the form \"↥X acts on Y\" where X is a subthing (eg a subalgebra) of R, but coerced to a type, then lean can apply a fact from typeclass inference saying \"it suffices to prove that R acts on Y\". This fact turns true statements into false ones in these problematic cases (R is too big to act on Y) and then typeclass inference attempts to use the order hierarchy to find the action and takes a long time to fail because it's so big.</p>",
        "id": 475483860,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728369455
    },
    {
        "content": "<p>The trace makes dismal reading because any attempt to solve this unsolvable goal using order theory is necessarily completely fruitless because there is no order in the question. The easiest fix would just be to not import any order stuff but this is not feasible in practice</p>",
        "id": 475484287,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728369570
    },
    {
        "content": "<p>Possibly related comment <a href=\"#narrow/stream/287929-mathlib4/topic/Infrastructure.20for.20tracking.20frequently.20applied.20simp.20theorems/near/475331955\">here</a>.</p>",
        "id": 475497233,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728372846
    },
    {
        "content": "<p>There is the approach I tried in <a href=\"https://github.com/leanprover-community/mathlib4/pull/12778\">#12778</a>, but <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> vetoed it on the grounds that it is not the right way of doing things. Alas, nothing seems to have come of the plans to do it the right way<span aria-label=\"tm\" class=\"emoji emoji-2122\" role=\"img\" title=\"tm\">:tm:</span> ...</p>",
        "id": 475572220,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1728396498
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20and.20time.20out/near/475483860\">said</a>:</p>\n<blockquote>\n<p>[...]</p>\n<p>I'll repeat my thoughts here: the issue is that whenever faced with a goal of the form \"↥X acts on Y\" where X is a subthing (eg a subalgebra) of R, but coerced to a type, then lean can apply a fact from typeclass inference saying \"it suffices to prove that R acts on Y\". [...]</p>\n</blockquote>\n<p>Would it perhaps be possible to give that instance low priority (or the other instance high priority), or would that cause more harm than good?</p>",
        "id": 475578732,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1728397703
    },
    {
        "content": "<p>This is pretty much what Michael did in <a href=\"https://github.com/leanprover-community/mathlib4/pull/12778\">#12778</a> and the results looked really good!</p>",
        "id": 475648966,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728415130
    },
    {
        "content": "<p>annoyingly, I can't remember how to change the priority of an instance to <code>low</code>. The troublesome instances here are <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.smulCommClass_right#doc\">docs#Subalgebra.smulCommClass_right</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsScalarTower.subalgebra%27#doc\">docs#IsScalarTower.subalgebra'</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.isScalarTower_mid#doc\">docs#Subalgebra.isScalarTower_mid</a></p>\n<p>I bet that decreasing the prio of these instances will make the example above work fine.</p>",
        "id": 475649591,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728415353
    },
    {
        "content": "<p>Could we remove these instances in a given file ?</p>",
        "id": 475651049,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1728415778
    },
    {
        "content": "<p>Maybe something like <code>attribute [local instance 50]  ...</code>?</p>",
        "id": 475651213,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1728415817
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">TensorProduct</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">smulCommClass_right</span>\n<span class=\"w\">  </span><span class=\"n\">IsScalarTower</span><span class=\"bp\">.</span><span class=\"n\">subalgebra'</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">isScalarTower_mid</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span>\n\n<span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- 32416</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">T₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↥</span><span class=\"n\">T₀</span><span class=\"w\"> </span><span class=\"bp\">⊗</span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">↥</span><span class=\"n\">S₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">T₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">S₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">T₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">S₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">T₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">S₀</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">map_add</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 475651846,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1728415963
    },
    {
        "content": "<p>The tipping point is prio 999 vs 1000.</p>",
        "id": 475652257,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1728416071
    },
    {
        "content": "<p>I always imagine that <code>prio</code> should be involved (like when you're declaring the instance) and then my search fails me.</p>",
        "id": 475655180,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728416704
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> do you have an objection to globally lowering the prio of these instances?</p>",
        "id": 475655484,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728416769
    },
    {
        "content": "<p>I see the results of the benchmark, but tweaking priorities only makes working TC searches faster. Failing ones will still search the full tree</p>",
        "id": 475656691,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728417095
    },
    {
        "content": "<p>Right, but this is making less of them fail!</p>",
        "id": 475656936,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1728417154
    },
    {
        "content": "<p>I think we can tweak the priorities, but the better thing would be to fully cut off the hierarchies</p>",
        "id": 475656998,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728417173
    },
    {
        "content": "<p>And I've been working recently on making less lemmas rely on bundled algebra+order classes. I believe that's a requirement to a greater overhaul.</p>",
        "id": 475657312,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728417255
    },
    {
        "content": "<p>Anyway, you can tweak the priorities in the meantime</p>",
        "id": 475657370,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728417274
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20and.20time.20out/near/475497233\">said</a>:</p>\n<blockquote>\n<p>Possibly related comment <a href=\"#narrow/stream/287929-mathlib4/topic/Infrastructure.20for.20tracking.20frequently.20applied.20simp.20theorems/near/475331955\">here</a>.</p>\n</blockquote>\n<p>It's even worse there, I'll make a mwe.</p>",
        "id": 475687429,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1728426957
    },
    {
        "content": "<p>I've tried to update <a href=\"https://github.com/leanprover-community/mathlib4/pull/12778\">#12778</a>. It passes CI, but benching it gives an error.</p>",
        "id": 475775738,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1728458697
    },
    {
        "content": "<p>The speedcenter is still broken.</p>",
        "id": 475780610,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1728459904
    },
    {
        "content": "<p>After merging master again, the speed center works agaon on <a href=\"https://github.com/leanprover-community/mathlib4/pull/12778\">#12778</a>, and it shows a gain of 9.7% in typeclass inference. There are some files that get slower, but this should be fixable with a bit more tinkering...</p>",
        "id": 476589304,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1728808505
    },
    {
        "content": "<p>It's funny how the files that got slower are mostly mine <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> Maybe because I mostly do algebraic order stuff?</p>",
        "id": 476589383,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728808571
    },
    {
        "content": "<p>I think there has been some refactoring, so probably there are some files or declarations that now need the <code>open scoped AlgebraOrderInstances</code>, but didn't before, and there are most likely some new files, too. If I have time, I'll look at that (but you <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> or anybody else is also welcome to do so).</p>",
        "id": 476611665,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1728830783
    },
    {
        "content": "<p>I've recently come back to the <code>FunLike</code> hierarchy slowness. (Before adjusting the priorities) <a href=\"https://github.com/leanprover-community/mathlib4/pull/17675\">#17675</a> has a 10x speedup for some other examples, but not for the examples in this topic. I realized we have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingHomClass.toLinearMapClassNNRat#doc\">docs#RingHomClass.toLinearMapClassNNRat</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingHomClass.toLinearMapClassRat#doc\">docs#RingHomClass.toLinearMapClassRat</a>, but the scalar type parameter of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearMapClass#doc\">docs#LinearMapClass</a> is <code>outParam</code>. This may have caused some failed attempts and slow unification.</p>\n<p>I'm not sure it's the critical issue of performance, but this looks wrong...</p>",
        "id": 481195601,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1731011601
    },
    {
        "content": "<p>If we want these two instances, should we refactor <code>LinearMapClass</code>? cc <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> who added them.</p>",
        "id": 481521270,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1731209252
    },
    {
        "content": "<p>Why do we want these instances, esp. with <code>RingHomClass</code> assumptions?</p>",
        "id": 481528062,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1731215651
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=map_rat_smul#doc\">docs#map_rat_smul</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=map_nnrat_smul#doc\">docs#map_nnrat_smul</a> have much weaker assumptions</p>",
        "id": 481528116,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1731215709
    },
    {
        "content": "<p>Hmm, I don't remember why I needed those instances off the top of my head. I would have to dig through APAP</p>",
        "id": 481544648,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731231045
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Deprecation.20and.20time.20out/near/481528116\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=map_rat_smul#doc\">docs#map_rat_smul</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=map_nnrat_smul#doc\">docs#map_nnrat_smul</a> have much weaker assumptions</p>\n</blockquote>\n<p>Yes, but they don't return a linear map, which makes them somewhat useless in linear map-full applications</p>",
        "id": 481544689,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731231085
    },
    {
        "content": "<p>Something that will definitely work for now is to make them non-instances</p>",
        "id": 481544704,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731231104
    },
    {
        "content": "<p>You can use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddMonoidHom.toRatLinearMap#doc\">docs#AddMonoidHom.toRatLinearMap</a></p>",
        "id": 481569463,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1731251181
    },
    {
        "content": "<p>(which can be generalized to <code>AddMonoidHomClass</code>)</p>",
        "id": 481569487,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1731251210
    }
]