[
    {
        "content": "<p>I am not sure I understand how bibliographic references work in Mathlib docs. For example, looking at the <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/NumberTheory/FunctionField.html\">Function field</a> file. Only one reference listed there actually points to the corresponding entry of the <code>References</code> page. However, looking at the file <code>references.bib</code> in the <code>docs</code> folder, I can see that a reference with the key <code>marcus1977number</code> is indeed there.  (The reference to Samuel's book is incorrect though since the key should be <code>samuel1967</code>).  Something similar happens in <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/NumberTheory/NumberField/CanonicalEmbedding/NormLeOne.html\">this file</a>.</p>\n<p>So, why isn't the reference to Marcus found and how to fix that?</p>",
        "id": 504405272,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741535197
    },
    {
        "content": "<p>I am really quite surprised that even though mathlib has many many references <a href=\"https://leanprover-community.github.io/mathlib4_docs/references.html\">https://leanprover-community.github.io/mathlib4_docs/references.html</a> the last one alphabetically apparently starts with L. This might have something to do with it...</p>",
        "id": 504408515,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741537530
    },
    {
        "content": "<p>I meant to debug this a while ago but didn't get around to it, so thanks for bringing it up!</p>",
        "id": 504408746,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741537689
    },
    {
        "content": "<p>Hmm, I thought we'd see that no references after the last one in references.bib were included, but that's not it</p>",
        "id": 504409052,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741537926
    },
    {
        "content": "<p>Hypothesis: something throws an exception (or similar) while processing the references, after they've been sorted by author, on the reference that comes after Lack</p>",
        "id": 504409340,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741538160
    },
    {
        "content": "<p>That sounds like a reasonable hypothesis</p>",
        "id": 504409411,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741538192
    },
    {
        "content": "<p>Can't test it right now, and the ci logs don't seem to have anything obviously wrong</p>",
        "id": 504409716,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741538442
    },
    {
        "content": "<p>I created a LaTex file and used <code>references.bib</code>and everything works fine <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 504410396,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741539000
    },
    {
        "content": "<p>What is the reference after Lack--Sobocinski alphabetically? Does your experiment reveal that?</p>",
        "id": 504411127,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741539576
    },
    {
        "content": "<p>If I get it right, it's </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">Book</span><span class=\"o\">{</span><span class=\"w\">            </span><span class=\"n\">lam_1999</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">series</span><span class=\"w\">        </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Graduate</span><span class=\"w\"> </span><span class=\"n\">Texts</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">Mathematics</span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"n\">title</span><span class=\"w\">         </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Lectures</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">Modules</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">Rings</span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"n\">doi</span><span class=\"w\">           </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mf\">10.1007</span><span class=\"bp\">/</span><span class=\"mi\">978</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"bp\">-</span><span class=\"mi\">4612</span><span class=\"bp\">-</span><span class=\"mi\">0525</span><span class=\"bp\">-</span><span class=\"mi\">8</span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"n\">publisher</span><span class=\"w\">     </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Springer</span><span class=\"w\"> </span><span class=\"n\">New</span><span class=\"w\"> </span><span class=\"n\">York</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">NY</span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"n\">author</span><span class=\"w\">        </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">T</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Lam</span><span class=\"o\">},</span>\n<span class=\"w\">  </span><span class=\"n\">year</span><span class=\"w\">          </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">1999</span><span class=\"o\">}</span>\n<span class=\"o\">}</span>\n</code></pre></div>",
        "id": 504411790,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741540032
    },
    {
        "content": "<p>looks fine to me <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span></p>",
        "id": 504412691,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741540728
    },
    {
        "content": "<p>I came to the same conclusion.</p>",
        "id": 504412751,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741540781
    },
    {
        "content": "<p>How is the page <a href=\"https://leanprover-community.github.io/mathlib4_docs/references.html\">Reference</a> generated from this file?</p>",
        "id": 504412860,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741540841
    },
    {
        "content": "<p>short answer is <a href=\"https://github.com/leanprover/doc-gen4\">https://github.com/leanprover/doc-gen4</a> ; longer answer is \"I have no idea\"</p>",
        "id": 504413572,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741541403
    },
    {
        "content": "<p>Heh, FLT also uses doc-gen4 and in the <a href=\"https://imperialcollegelondon.github.io/FLT/docs/Mathlib/NumberTheory/FunctionField.html\">FLT version of the mathlib function field file</a> all three of the references are broken</p>",
        "id": 504413775,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741541546
    },
    {
        "content": "<p>Maybe it's just looking for the bib file in the wrong place in that case</p>",
        "id": 504415850,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741543113
    },
    {
        "content": "<p>Most probably <a href=\"https://github.com/dupuisf/BibtexQuery\">https://github.com/dupuisf/BibtexQuery</a> does not like the bib files in mathlib. Unfortunately the bib processing code in it does not print messages if it encounters thing it cannot process; it just silently quits.</p>\n<p>Run <code>lake exe bibtex-query l references.bib &gt; output.txt</code> to see what entry makes it unhappy.</p>",
        "id": 504480392,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741586856
    },
    {
        "content": "<p>The bug was introduced in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21688\">#21688</a>. The reason is simple: bibkey contains non-ASCII characters!</p>",
        "id": 504481817,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741587496
    },
    {
        "content": "<p><code>bibtex-query</code> should really report errors on such things, instead of silently errors.</p>",
        "id": 504481889,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741587540
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22755\">#22755</a></p>",
        "id": 504482909,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741588024
    },
    {
        "content": "<p>Can we have a comment at the top of the file to warn people as well?</p>",
        "id": 504487261,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741589840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Reference/near/504487261\">said</a>:</p>\n<blockquote>\n<p>Can we have a comment at the top of the file to warn people as well?</p>\n</blockquote>\n<p>Sure.</p>",
        "id": 504489110,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741590612
    },
    {
        "content": "<p>Maybe we can add scripts to <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/scripts/lint-bib.sh\">https://github.com/leanprover-community/mathlib4/blob/master/scripts/lint-bib.sh</a> to detect such things</p>",
        "id": 504489218,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741590662
    },
    {
        "content": "<p><code>bibtool --pass.comments=on -- 'select{$key \"[^-.:A-Za-z0-9_]+\"}' references.bib -o out.bib</code> can filter entries whose key contains non-ASCII characters.</p>",
        "id": 504489428,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741590732
    },
    {
        "content": "<p>There are any such entries if and only if the <code>out.bib</code> is not 0 bytes</p>",
        "id": 504489579,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741590792
    },
    {
        "content": "<p>the linter is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/22757\">#22757</a></p>",
        "id": 504494710,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741592655
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Run ./scripts/lint-bib.sh\n+ bibtool --pass.comments=on -- 'select{$key \"[^-.:A-Za-z0-9_]+\"}' docs/references.bib -o docs/non-ascii.bib\n+ '[' -s docs/non-ascii.bib ']'\n+ echo 'ERROR: There are items in references.bib with keys containing non-ASCII characters:'\n+ echo\n+ cat docs/non-ascii.bib\nERROR: There are items in references.bib with keys containing non-ASCII characters:\n\n\n@Book{        hytönen_vanneerven_veraar_wies_2016,\n  author    = {Hytönen, Tuomas and Van Neerven, Jan and Veraar, Mark and\n          Weis, Lutz},\n  title     = {Analysis in Banach spaces},\n  series    = {A Series of Modern Surveys in Mathematics},\n  publisher = {Springer Cham},\n  year      = {2016},\n  pages     = {xvii+614},\n  isbn      = {978-3-319-48520-1},\n  doi       = {10.1007/978-3-319-48520-1},\n  url       = {https://doi.org/10.1007/978-3-319-48520-1}\n}\n+ rm docs/non-ascii.bib\n+ exit 1\nError: Process completed with exit code 1.\n</code></pre></div>\n<p>It works</p>",
        "id": 504495041,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741592770
    },
    {
        "content": "<p>The linter is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/22757\">#22757</a> and is ready for review.</p>",
        "id": 504497435,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741593519
    },
    {
        "content": "<p>References are now fixed! Thanks</p>",
        "id": 504505134,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741595705
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Reference/near/504409340\">said</a>:</p>\n<blockquote>\n<p>Hypothesis: something throws an exception (or similar) while processing the references, after they've been sorted by author, on the reference that comes after Lack</p>\n</blockquote>\n<p>(so this was wrong)</p>",
        "id": 504509541,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741596812
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"488648\">Xavier Roblot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Reference/near/504405272\">said</a>:</p>\n<blockquote>\n<p>(The reference to Samuel's book is incorrect though since the key should be <code>samuel1967</code>).</p>\n</blockquote>\n<p>You want to fix this, then? :)</p>",
        "id": 504509712,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741596851
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Reference/near/504509712\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"488648\">Xavier Roblot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Reference/near/504405272\">said</a>:</p>\n<blockquote>\n<p>(The reference to Samuel's book is incorrect though since the key should be <code>samuel1967</code>).</p>\n</blockquote>\n<p>You want to fix this, then? <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>\n</blockquote>\n<p>I'll put it on my TODO list but you're welcome to do it first <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 504510167,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741596967
    },
    {
        "content": "<p>Ditto <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 504510313,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741597013
    },
    {
        "content": "<p>I just did it: <a href=\"https://github.com/leanprover-community/mathlib4/pull/22763\">#22763</a></p>",
        "id": 504521315,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1741599582
    },
    {
        "content": "<p>The first commit should be clearly good; the second commit (to <a href=\"https://tqft.net/mathlib4files/Mathlib/RingTheory/Spectrum/Prime/Basic\">file#Mathlib/RingTheory/Spectrum/Prime/Basic</a>) is more speculative: I'd be glad if a domain expert could double-check.</p>",
        "id": 504521632,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1741599647
    },
    {
        "content": "<p>It looks good to me</p>",
        "id": 504522849,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1741599922
    },
    {
        "content": "<p>Much more comprehensive than I would have been, thanks :)</p>",
        "id": 504534416,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741602673
    },
    {
        "content": "<p>I have to say that, if I remembered correctly, the syntax <code>[samuel1967, § 3.3, Lemma 3]</code> is not recognized by doc-gen and will be rendered as-is.</p>",
        "id": 504587003,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741614439
    },
    {
        "content": "<p><code>[samuel1967], § 3.3, Lemma 3</code> is not ideal, but at least the <code>[samuel1967]</code> will be linked correctly to bibliography (with system auto-generated last name + year tag).</p>",
        "id": 504587637,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741614581
    },
    {
        "content": "<p>I think you're right, I should've caught that (but it's no worse than before)</p>",
        "id": 504587670,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741614589
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Reference/near/504521632\">said</a>:</p>\n<blockquote>\n<p>the second commit (to <a href=\"https://tqft.net/mathlib4files/Mathlib/RingTheory/Spectrum/Prime/Basic\">file#Mathlib/RingTheory/Spectrum/Prime/Basic</a>) is more speculative</p>\n</blockquote>\n<p>In order to link from docstring to the bibliography page, it's not necessary to always add a <code>References</code> section to module docstring. For example, if your sole purpose is to make the following <code>samuel1967</code> works, then it's enough to write a <code>[samuel1967], § 3.3, Lemma 3</code> in the theorem docstring, and that's enough. Hope this clarifies.</p>",
        "id": 504588973,
        "sender_full_name": "Jz Pan",
        "timestamp": 1741614870
    },
    {
        "content": "<p>(I added that reference also for good measure: if a file follows a reference, we might as well say so.)</p>",
        "id": 504593207,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1741615725
    }
]