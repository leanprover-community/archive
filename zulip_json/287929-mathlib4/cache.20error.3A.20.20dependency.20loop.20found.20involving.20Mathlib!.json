[
    {
        "content": "<p>Since yesterday, I was getting the following error message when I tried to update the cache:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">dependency</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">involving</span><span class=\"w\"> </span><span class=\"n\">Mathlib!</span>\n</code></pre></div>\n<p>After a lot of experiments, I found out that the error happens because some files were importing all of Mathlib, that is starting with the line:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n</code></pre></div>\n<p>I understand this is a bad practice in general but this is a development branch and it is useful to have access to all of Mathlib sometimes when developing.</p>\n<p>Anyway, I just wanted to put the information out there in case somebody else has the same issue.</p>",
        "id": 532396793,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1754094273
    },
    {
        "content": "<p>Are you saying you get this error in any downstream project that contains a file with <code>import Mathlib</code>? If that is the case, it is a problem we should fix.</p>",
        "id": 532523258,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754201550
    },
    {
        "content": "<p>FWIW, I thought you meant \"on a branch of mathlib, I have a file which does <code>import Mathlib</code>\". Feel free to clarify which one you meant :-)</p>",
        "id": 532525584,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754203406
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/cache.20error.3A.20.20dependency.20loop.20found.20involving.20Mathlib!/near/532525584\">said</a>:</p>\n<blockquote>\n<p>FWIW, I thought you meant \"on a branch of mathlib, I have a file which does <code>import Mathlib</code>\". Feel free to clarify which one you meant :-)</p>\n</blockquote>\n<p>Yes, that what I meant:  it happened on a branch of Mathlib in which some files were importing all of Mathlib.</p>",
        "id": 532616306,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1754266763
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/cache.20error.3A.20.20dependency.20loop.20found.20involving.20Mathlib!/near/532523258\">said</a>:</p>\n<blockquote>\n<p>Are you saying you get this error in any downstream project that contains a file with <code>import Mathlib</code>? If that is the case, it is a problem we should fix.</p>\n</blockquote>\n<p>I'll see if I can reproduce the error in a cleaner way.</p>",
        "id": 532616353,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1754266792
    },
    {
        "content": "<p>I guess the failure mode here is more generally:</p>\n<ul>\n<li>Start a new branch with a clean cache</li>\n<li>Make an import loop and commit, which breaks the build</li>\n<li>Clear your local cache</li>\n<li>Attempt to get a partial cache, which fails to compute the needed files because of the import loop</li>\n</ul>",
        "id": 532616448,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754266861
    },
    {
        "content": "<p>I think the desired behavior is to cut all the files implicated in the loop, and fetch the cache upstream of them, rather than the error that it sounds like is happening</p>",
        "id": 532616528,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754266917
    },
    {
        "content": "<p>I made <a href=\"https://github.com/leanprover-community/mathlib4/pull/27915\">#27915</a> following Eric suggestion.</p>",
        "id": 532623878,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1754271263
    },
    {
        "content": "<p>I have no problems importing mathlib in scratch files in mathlib; it sounds to me like Xavier must have been taking an already-existing file and then increasing the imports to <code>import Mathlib</code>? At least this is the only way I can envisage trouble (and in this case it's pretty clear that there will be trouble).</p>",
        "id": 532796372,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1754340781
    },
    {
        "content": "<p>I think the issue is that the trouble is worse than it should be</p>",
        "id": 532799793,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754342260
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/cache.20error.3A.20.20dependency.20loop.20found.20involving.20Mathlib!/near/532796372\">said</a>:</p>\n<blockquote>\n<p>I have no problems importing mathlib in scratch files in mathlib; it sounds to me like Xavier must have been taking an already-existing file and then increasing the imports to <code>import Mathlib</code>? At least this is the only way I can envisage trouble (and in this case it's pretty clear that there will be trouble).</p>\n</blockquote>\n<p>Yes, this one in on me. Having a file that import <code>Mathlib</code> is fine but then this file should not be listed in <code>Mathlib.lean</code>. Somehow, I didn't realized that this was the problem at first, maybe because I could not download the cache and build (efficiently) Mathlib. It seems however that there is an error message that warns about that:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">242</span><span class=\"bp\">/</span><span class=\"mi\">7003</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">cycle</span><span class=\"w\"> </span><span class=\"n\">detected</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Loop</span><span class=\"o\">:</span><span class=\"n\">leanArts</span>\n<span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Loop</span><span class=\"o\">:</span><span class=\"n\">olean</span>\n<span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">setup</span>\n<span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">leanArts</span>\n<span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">olean</span>\n<span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Loop</span><span class=\"o\">:</span><span class=\"n\">setup</span>\n<span class=\"w\">  </span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">leanArts</span>\n<span class=\"w\">  </span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">default</span>\n<span class=\"w\">  </span><span class=\"bp\">+</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Loop</span><span class=\"o\">:</span><span class=\"n\">leanArts</span>\n<span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">243</span><span class=\"bp\">/</span><span class=\"mi\">7003</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Loop</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">roblot</span><span class=\"bp\">/</span><span class=\"n\">Desktop</span><span class=\"bp\">/</span><span class=\"n\">EnCours</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">/</span><span class=\"n\">Lean4</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"n\">alt</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Loop</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">bad</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Mathlib'</span>\n</code></pre></div>\n<p>So I might have missed that or is it a new thing?<br>\nAnyway, since I clearly did something wrong, I am not sure there is the need for a fix.</p>",
        "id": 532809783,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1754349443
    },
    {
        "content": "<p>It does seem like we could go ahead and download the cache anyway in this situation!</p>",
        "id": 532841025,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754374420
    }
]