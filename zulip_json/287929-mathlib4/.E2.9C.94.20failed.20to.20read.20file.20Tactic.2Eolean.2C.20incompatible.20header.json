[
    {
        "content": "<p>I managed to setup mathlib4 insider MyProject in such a way that 'lake build' successfully checks the proofs inside the project that use Mathlib4. </p>\n<p>Now I want to check the proofs using 'lean --server', Python and a custom LSP client. </p>\n<p>Without mathlib everything works fine. Inspired by 'lake build --verbose' output, to pick it up in Lean, I declare enviromental variables and run the server:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">environ</span><span class=\"p\">[</span><span class=\"s2\">\"LD_LIBRARY_PATH\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"/home/my_name/.elan/toolchains/leanprover--lean4---v4.17.0-rc1/bin/lean\"</span>\n<span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">environ</span><span class=\"p\">[</span><span class=\"s2\">\"LEAN_PATH\"</span><span class=\"p\">]</span><span class=\"o\">=</span><span class=\"s2\">\"../MyProject/mathlib4-old/.lake/build/lib\"</span>\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">start_server</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">\"\"\"Start Lean 4 LSP server\"\"\"</span>\n        <span class=\"k\">return</span> <span class=\"bp\">cls</span><span class=\"p\">(</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">Popen</span><span class=\"p\">(</span>\n            <span class=\"p\">[</span><span class=\"s2\">\"lean\"</span><span class=\"p\">,</span> <span class=\"s2\">\"--server\"</span><span class=\"p\">,</span> <span class=\"s2\">\"-R ../MyProject\"</span><span class=\"p\">],</span>\n            <span class=\"n\">stdin</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">,</span>\n            <span class=\"n\">stdout</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">,</span>\n            <span class=\"n\">stderr</span><span class=\"o\">=</span><span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">PIPE</span><span class=\"p\">,</span>\n            <span class=\"n\">bufsize</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span>  <span class=\"c1\"># Line buffered</span>\n        <span class=\"p\">))</span>\n</code></pre></div>\n<p>however, after rebuilding mathlib4-old,  I get the error message</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">read</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">'../</span><span class=\"n\">MyProject</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"n\">old</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">olean'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">incompatible</span><span class=\"w\"> </span><span class=\"n\">header</span>\n</code></pre></div>\n<p>Both MyProject and mathlib4-old use leanprover/lean4:v4.17.0-rc1. Any ideas what could have gone wrong ?</p>\n<p>The start of the file in question from the text editor looks like this:</p>\n<blockquote>\n<p>olean^B^A4.17.0-rc1^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@93d4ae6635c0c755c9f7368f9b99483d4557b7a6^@^@b�t{^@^@��b�t{^@^@^@^@^@^@^A^@^@�^E^@^@^@^@^@^@^@^E^@^@^@^@^@^@^@^D^@^@^@^@^@^@^@Init^@^@^@^@^@^@^@^@ ^@^B^A^A^@^@^@^@^@^@^@`^@&gt;<br>\n^@^@^@^@^@^@^@Algebraize</p>\n</blockquote>",
        "id": 516187746,
        "sender_full_name": "Stan Kikot",
        "timestamp": 1746449565
    },
    {
        "content": "<p>This is the theorem I use for testing:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nn\">Mathlib.Tactic</span>\n\n<span class=\"o\">--</span> <span class=\"n\">Define</span> <span class=\"n\">what</span> <span class=\"n\">it</span> <span class=\"n\">means</span> <span class=\"k\">for</span> <span class=\"n\">a</span> <span class=\"n\">number</span> <span class=\"n\">to</span> <span class=\"n\">be</span> <span class=\"n\">even</span>\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">even</span> <span class=\"p\">(</span><span class=\"n\">n</span> <span class=\"p\">:</span> <span class=\"n\">ℕ</span><span class=\"p\">)</span> <span class=\"p\">:</span> <span class=\"n\">Prop</span> <span class=\"o\">:=</span> <span class=\"err\">∃</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">n</span> <span class=\"o\">=</span> <span class=\"mi\">2</span> <span class=\"o\">*</span> <span class=\"n\">k</span>\n\n<span class=\"o\">--</span> <span class=\"n\">Define</span> <span class=\"n\">what</span> <span class=\"n\">it</span> <span class=\"n\">means</span> <span class=\"k\">for</span> <span class=\"n\">a</span> <span class=\"n\">number</span> <span class=\"n\">to</span> <span class=\"n\">be</span> <span class=\"n\">odd</span>\n<span class=\"k\">def</span><span class=\"w\"> </span><span class=\"nf\">odd</span> <span class=\"p\">(</span><span class=\"n\">n</span> <span class=\"p\">:</span> <span class=\"n\">ℕ</span><span class=\"p\">)</span> <span class=\"p\">:</span> <span class=\"n\">Prop</span> <span class=\"o\">:=</span> <span class=\"err\">∃</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">n</span> <span class=\"o\">=</span> <span class=\"mi\">2</span> <span class=\"o\">*</span> <span class=\"n\">k</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n\n<span class=\"o\">--</span> <span class=\"n\">The</span> <span class=\"n\">theorem</span> <span class=\"n\">statement</span>\n<span class=\"n\">theorem</span> <span class=\"n\">even_plus_odd</span> <span class=\"p\">:</span> <span class=\"err\">∀</span> <span class=\"n\">n</span> <span class=\"n\">m</span><span class=\"p\">,</span> <span class=\"n\">even</span> <span class=\"n\">n</span> <span class=\"err\">→</span> <span class=\"n\">odd</span> <span class=\"n\">m</span> <span class=\"err\">→</span> <span class=\"n\">odd</span> <span class=\"p\">(</span><span class=\"n\">n</span> <span class=\"o\">+</span> <span class=\"n\">m</span><span class=\"p\">)</span> <span class=\"o\">:=</span> <span class=\"n\">by</span>\n  <span class=\"o\">--</span> <span class=\"n\">The</span> <span class=\"n\">proof</span>\n  <span class=\"n\">intro</span> <span class=\"n\">n</span> <span class=\"n\">m</span> <span class=\"n\">hn</span> <span class=\"n\">hm</span>\n  <span class=\"n\">cases</span><span class=\"s1\">' hn with k hk</span>\n  <span class=\"n\">cases</span><span class=\"s1\">' hm with l hl</span>\n  <span class=\"n\">use</span> <span class=\"n\">k</span> <span class=\"o\">+</span> <span class=\"n\">l</span>\n  <span class=\"n\">rw</span> <span class=\"p\">[</span><span class=\"n\">hk</span><span class=\"p\">,</span> <span class=\"n\">hl</span><span class=\"p\">]</span>\n  <span class=\"n\">ring</span>\n</code></pre></div>\n<p>'lake build' can see that it is correct, however, my custom LSP communication setup fails to import Mathlib.Tactic.</p>",
        "id": 516189688,
        "sender_full_name": "Stan Kikot",
        "timestamp": 1746450052
    },
    {
        "content": "<p>Sorry about taking your time by a stupid mistake. <br>\n<code>/home/my_name/.elan/toolchains/leanprover--lean4---v4.17.0-rc1/bin/lean</code> is not LD_LIBRARY_PATH, but the name of the executable. This solves this  particular problem.</p>",
        "id": 516204952,
        "sender_full_name": "Stan Kikot",
        "timestamp": 1746453424
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"897275\">Stan Kikot</span> has marked this topic as resolved.</p>",
        "id": 516204965,
        "sender_full_name": "Notification Bot",
        "timestamp": 1746453426
    }
]