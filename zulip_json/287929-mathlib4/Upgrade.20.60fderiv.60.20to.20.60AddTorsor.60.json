[
    {
        "content": "<p>Currently fderiv has the type signature</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fderiv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NontriviallyNormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_5</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n\n<span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_6</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ùïú</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">F</span>\n</code></pre></div>\n<p>but I contend it could work just as well with the signature</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fderiv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NontriviallyNormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_5</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_6</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddTorsor</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span>\n<span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_7</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span>\n<span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"n\">L</span><span class=\"o\">[</span><span class=\"n\">ùïú</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">F</span>\n</code></pre></div>\n<p>That is: the domain of the function only needs to be an <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/AddTorsor/Defs.html#AddTorsor\">AddTorsor</a>. For the special case where <code>E = P</code>, the instance <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/AddTorsor/Defs.html#addGroupIsAddTorsor\">addGroupIsAddTorsor</a> makes everything work as before. The basic fact is that the domain doesn't need to be a group <code>E</code> itself, it just needs the action of the group <code>E</code>.</p>\n<p>The same generalization works up/down the hierarchy from <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Analysis/Calculus/FDeriv/Basic.html#HasFDerivAtFilter\">HasFDerivAtFilter</a> down to <code>deriv</code> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Analysis/Calculus/ContDiff/Defs.html#ContDiff\">ContDiff</a>.</p>\n<p>Of course in the end all derivatives could be ultimately first defined with regards to some manifold structure or something similar, which I think many people would agree is undesirable in adding too much complexity. But this should give a defeq definition of derivative to what is currently there, while capturing an important larger case.</p>\n<p>So, I would be interested to try to make this change in mathlib. But since I recognize it might end up being unpopular or unwelcome of a refactor, I wanted to ask here first.</p>",
        "id": 513189031,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745083188
    },
    {
        "content": "<p>This was prompted by a conversation at <a href=\"#narrow/channel/479953-PhysLean/topic/Vector.20calculus\">#PhysLean &gt; Vector calculus</a> ... flat spacetime is naturally viewed as a torsor, one should be able to take derivatives on it without any notion a manifold being necessary. Currently this isn't possible with the notions of derivative in mathlib</p>",
        "id": 513189232,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745083350
    },
    {
        "content": "<p>In theory you're correct that affine spaces are the right setting for derivatives. In practice I'm afraid this refactor would be a nightmare. For the physics application, the right setting is clearly manifolds, as you want to be able to do physics on any spacetime, not only flat ones!</p>",
        "id": 513191202,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1745084931
    },
    {
        "content": "<p>Of course, and we'd also like to be able to do physics on a manifold with boundaries, in any number of dimensions, and accordingly the signature of the metric has to change too... :)</p>\n<p>But given that <em>most</em> physics <em>is</em> done in flat spacetime, and that Riemannian manifolds don't even exist in Mathlib yet, I think it's a reasonable stepping stone.</p>",
        "id": 513191762,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745085393
    },
    {
        "content": "<p>Of course it's possible that the refactor is a nightmare, but I'm cautiously optimistic: I think the change could be made and most \"downstream\" users of the definition would be totally oblivious.</p>\n<p>It also doesn't have to be everything at once, for instance just <code>HasFDerivAtFilter</code> could be upgraded first, I estimate this would mean maybe ten theorems touched total, tops. And then <code>HasFDerivWithin</code> can come after, and so on.</p>",
        "id": 513193681,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745086874
    },
    {
        "content": "<p>If your medium-term goal is to speak about spacetime on Riemannian manifolds - how bad is waiting for that? I'm not sure to what extent \"boiling the ocean\" in mathlib is justified for a purely temporary change.</p>",
        "id": 513194128,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745087260
    },
    {
        "content": "<p>FWIW, I'll be visiting Patrick Massot in June/July, and one very possible project idea is \"formalise Riemannian manifolds\". So you may not have to wait <em>very</em> long.</p>",
        "id": 513194201,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745087304
    },
    {
        "content": "<p>\"Boiling the ocean\" feels a little harsh...! Is it that you think this would be harmful to Mathlib? Or a lot of \"wasted\" work?</p>",
        "id": 513194789,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745087818
    },
    {
        "content": "<p>(Very happy to hear the second half, though! :) )</p>",
        "id": 513194799,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745087833
    },
    {
        "content": "<p>Oh, I'm sorry if this came across as harsh! I certainly did not mean to say that connotation.</p>",
        "id": 513195159,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745088131
    },
    {
        "content": "<p>Just reading this thread, it sounds like \"generalise everything to AddTorsor\" could be a substantial refactoring. I'm worried about that making fderiv harder to work with (differential geometry is already too cumbersome - for other reasons; I'd like that to get easier not harder :-)). It's not clear to me <em>why</em> we'd like to make this change in the long run: all motivation so far sounds like formalising Riemannian manifolds soon and switching to those would be a preferred outcome.</p>\n<p>(edit: so, to clarify: I mostly worry about 'wasted work' - and wonder about 'makes things harder')</p>",
        "id": 513195296,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745088280
    },
    {
        "content": "<p>To do physics, can't you assume you are in a vector space? I have the impression that in my undergraduate studies every physics I did was in a vector space, and later in my studies everything was in a manifold, and there was no intermediate \"affine space\" step.</p>",
        "id": 513195324,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1745088304
    },
    {
        "content": "<p>I don't have a very qualified opinion: feel free to tell me a different position is more convincing :-)</p>",
        "id": 513195341,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745088320
    },
    {
        "content": "<p>I like affine spaces, I wish people would use them more</p>",
        "id": 513195347,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1745088332
    },
    {
        "content": "<p>A half-baked refactor, where we change only the first definitions and then give up because it's too hard, would be really bad, so I don't think we could start incorporating any change along this line into mathlib before there is a branch showing that this can be done up to the end. And I am afraid that this refactor would be extremely painful, for a gain which is not really proportionate to the pain, so I'm not convinced this is a good idea, to be honest.</p>",
        "id": 513195538,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1745088500
    },
    {
        "content": "<p>To say something more friendly: the manifold and calculus libraries in mathlib can use lots of helping hands. I'm happy to collect ideas/missing pieces what would make <em>your</em> life easier. I'd be very happy to review PRs making progress - there's only so much time for everything.<br>\nI certainly have some pieces (towards submanifolds, for example), where help is welcome and doesn't require much context. So if you want to help, there are definitely useful ways.</p>",
        "id": 513195812,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1745088803
    },
    {
        "content": "<p>Please wait with this reactor for a few weeks. We're moving from normed spaces to topological vector spaces, and I don't think that we should do both at the same time.</p>",
        "id": 513196727,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745089581
    },
    {
        "content": "<p>I think your message contains a topo, Yury</p>",
        "id": 513197319,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745090067
    },
    {
        "content": "<p>I was toping on the phyne</p>",
        "id": 513198149,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745090815
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Upgrade.20.60fderiv.60.20to.20.60AddTorsor.60/near/513196727\">said</a>:</p>\n<blockquote>\n<p>Please wait with this <strong>reactor</strong> for a few weeks.</p>\n</blockquote>\n<p>Typing from the phone rarely gives typoless results</p>",
        "id": 513198625,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1745091179
    },
    {
        "content": "<p>HoTT (homophone type theory) when? </p>\n<p>In seriousness: alright, thanks for the warning, if there's a change soon that would break any attempts to do this refactor I certainly won't try right now. </p>\n<p>Regarding \"only a few definitions\": alright, that makes sense that you would need the full stack of definitions changed. I'll restrict myself to considering only that, then. </p>\n<p>\"Why not vector spaces\" / \"Why not manifolds\": Physics curricula almost never use affine spaces, true. They're logically equivalent to vector spaces by picking an origin, and this lets you immediately do coordinate geometry, and it saves you having to explain to your students what this not-a-vector-space is and why they should care. In the same way, general relativity <em>can</em> be done entirely in a given coordinate frame, and for some domains (like LIGO simulations of BH mergers) this is the norm. But for students learning GR it's generally agreed that the \"type safe\" description with manifolds is better pedagogy, and we generally expect students to have the mathematical maturity by that point to handle talking about a manifold without an explicit coordinate system. </p>\n<p>But for the 95% of physics that's done in flat spacetime, affine spaces really are the \"morally correct\" formalization, even if they're not used in education. As one other example: \"voltage\" is something that is treated as a real number for most physics education, but only by the time that you're studying abelian QFT does it become a 1D torsor (and this is now quite necessary to get a sensible understanding on QED).</p>",
        "id": 513199203,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745091683
    },
    {
        "content": "<p>If it's going to be a big refactor, well, I guess I'm willing to take that risk as a stab (and if it turns out to be so big and messy that it's never going to be reviewed, ok). I guess that risk doesn't bother to me too much, I see a material benefit to it</p>\n<p>But if the concern is that it will make differential geometry in Mathlib much harder down the line, I certainly don't want to cause that!</p>",
        "id": 513199482,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1745091955
    },
    {
        "content": "<p>I very much agree that affine spaces are the natural home of elementary calculus. It makes me very sad that it's not done properly in mathlib. But of course I also agree that half fixing this could make things much worse. So I would very much encourage Alex to try, but knowing it has to be a huge refactor and it may fail.</p>",
        "id": 513432272,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1745253446
    },
    {
        "content": "<p>BTW, if you want to speed up the migration to TVS (and opening doors for another refactor), you can review <a href=\"https://github.com/leanprover-community/mathlib4/pull/23756\">#23756</a></p>",
        "id": 513470711,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745269983
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24226\">#24226</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/24225\">#24225</a> are small dependencies for the upcoming refactor of <code>tangentConeAt</code>, first adding API in <a href=\"https://github.com/leanprover-community/mathlib4/pull/24227\">#24227</a> (WIP), then generalization to TVS.</p>",
        "id": 513471994,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745270637
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span>, is the TVS migration mostly done? I've been playing with a torsor upgrade just a little bit and so far it's been working out well, I would say.</p>\n<p>The funniest change is that your high-school notion of derivative is the limit of <code>(f(h + x) - f(x)) / h</code>, and not <code>(f(x + h) - f(x)) / h</code>, because (when <code>x</code> is a point in the Torsor and <code>h</code> is the vector), the VAdd notation requires the order to be <code>h +·µ• x</code> and not <code>x +·µ• h</code>.</p>",
        "id": 520126015,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1748032643
    },
    {
        "content": "<p>Not yet. I'm trying to split it into reviewable chunks.</p>",
        "id": 520131206,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748035435
    },
    {
        "content": "<p>I'll spend quite some time on this tomorrow.</p>",
        "id": 520131287,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748035458
    },
    {
        "content": "<p>There is a prerequisite that isn't in Mathlib yet: topological add torsors.</p>",
        "id": 520205892,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748099789
    },
    {
        "content": "<p>Adding them and generalizing lemmas like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Continuous.vsub#doc\">docs#Continuous.vsub</a> can be done in parallel to the current generalization of derivatives.</p>",
        "id": 520205955,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748099842
    },
    {
        "content": "<p>Sounds good, I'll give it a try when I get the time</p>",
        "id": 520208852,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1748102251
    }
]