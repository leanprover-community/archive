[
    {
        "content": "<p>This surprised me. I am running a Lean alg geom workshop next week so I thought I'd try and make the scheme associated to an elliptic curve. I made two affine patches but when attempting to glue them I ran into an error which I've minimised to this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"n\">suppress_compilation</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">ℂ</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">x</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"bp\">.</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"bp\">.</span><span class=\"n\">y</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">y</span><span class=\"bp\">^</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">}</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">⧸</span><span class=\"w\"> </span><span class=\"n\">I</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">DistribMulAction</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n<span class=\"c1\">-- #synth DistribMulAction Q Q -- fails</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxSynthPendingDepth</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">DistribMulAction</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"c1\">-- still fails</span>\n</code></pre></div>\n<p>My experience was that setting <code>maxSynthPendingDepth</code> to be something like 2 would usually solve these problems.</p>",
        "id": 482265737,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1731533731
    },
    {
        "content": "<p>That seems to step just outside of the default limits for synthesis</p>",
        "id": 482266308,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731533935
    },
    {
        "content": "<p><code>set_option synthInstance.maxHeartbeats 21000</code> fixes it</p>",
        "id": 482266369,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731533958
    },
    {
        "content": "<p>Oh I'm a fool, thanks.</p>",
        "id": 482266487,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1731534005
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/instance.20synth.20failure/near/482266369\">said</a>:</p>\n<blockquote>\n<p><code>set_option synthInstance.maxHeartbeats 21000</code> fixes it</p>\n</blockquote>\n<p>Even <code>20150</code> works for me :)</p>",
        "id": 482266612,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731534051
    },
    {
        "content": "<p>As does not using the <code>abbrev</code>. Lean doesn't want to peak into <code>R</code> for the matching on the keys which results in a ton of hits</p>",
        "id": 482267435,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731534368
    },
    {
        "content": "<p>But the difference in heartbeats isn't very big without <code>abbrev</code></p>",
        "id": 482267725,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731534508
    },
    {
        "content": "<p>I went with abbrevs everywhere because I wanted notation and didn't want to write weird stuff in front of the students justifying that things which were obviously rings, were rings. Maybe that's my mistake</p>",
        "id": 482267729,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1731534509
    },
    {
        "content": "<p>No I would expect the matching on keys to look into the <code>abbrev</code>. Notation makes sense</p>",
        "id": 482267832,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1731534559
    }
]