[
    {
        "content": "<p>I updated my Lean version from v4.18.0 to v4.19.0-rc2 and now I get the following error. I have no idea how to fix it, so please help me.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">parameter</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">configuration</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">flexible'</span>\n\n<span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">library</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"bp\">'-</span><span class=\"n\">Dweak</span><span class=\"bp\">.</span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">flexible'</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">conditionally</span>\n</code></pre></div>",
        "id": 509990266,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1743698812
    },
    {
        "content": "<p>my lakefile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"w\"> </span><span class=\"n\">DSL</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">linterOptions</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">LeanOption</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.flexible</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.oldObtain</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.cdot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.dollarSyntax</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.missingEnd</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.lambdaSyntax</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`structureDiamondWarning</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span>\n<span class=\"o\">]</span>\n\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">Example</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">keywords</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">description</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"foo bar\"</span>\n<span class=\"w\">  </span><span class=\"n\">leanOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`autoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`relaxedAutoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">linterOptions</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`weak</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"o\">})</span>\n<span class=\"w\">  </span><span class=\"n\">moreServerOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">linterOptions</span>\n</code></pre></div>",
        "id": 509990624,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1743698917
    },
    {
        "content": "<p>It means you don't have <code>Mathlib.Tactic.Linter.FlexibleLinter</code> imported.</p>\n<p>Another way to fix it is to disable setting the option by commenting out <code>⟨`linter.flexible, true⟩,</code></p>",
        "id": 509993056,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1743699641
    },
    {
        "content": "<p>thank you</p>",
        "id": 510029993,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1743711515
    },
    {
        "content": "<p>I suspect something deeper is broken with linters on v4.19.0-rc2.<br>\nI tried running <code>lake exe runLinter</code> on my project and it seemed to not run any linter at all. (Usually it gives me tons of warnings.)</p>",
        "id": 510037952,
        "sender_full_name": "David Renshaw",
        "timestamp": 1743714653
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243791\">@David Renshaw</span>, is there a repro I can run? Likely this is the same problem as affected doc-gen4.</p>",
        "id": 510053296,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743722733
    },
    {
        "content": "<p><code>lake exe runLinter Compfiles</code> in <a href=\"https://github.com/dwrensha/compfiles\">https://github.com/dwrensha/compfiles</a></p>",
        "id": 510072827,
        "sender_full_name": "David Renshaw",
        "timestamp": 1743734028
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> ^</p>",
        "id": 510072838,
        "sender_full_name": "David Renshaw",
        "timestamp": 1743734036
    },
    {
        "content": "<p>My guess is that it has to do with <code>withImportModules</code> no longer loading env extensions.</p>",
        "id": 510072900,
        "sender_full_name": "David Renshaw",
        "timestamp": 1743734069
    },
    {
        "content": "<p>I needed</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">runLinter</span><span class=\"w\"> </span><span class=\"n\">Compfiles</span>\n</code></pre></div>\n<p>but indeed yes, no output.</p>",
        "id": 510078467,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743737960
    },
    {
        "content": "<p>And setting <code>loadExts := true</code> in <code>runLinter</code> fixes it.</p>",
        "id": 510078692,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743738116
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/1190\">batteries#1190</a></p>",
        "id": 510078752,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743738138
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>, I think at this point I agree that <code>loadExts</code> should not have a default value. What do you think?</p>",
        "id": 510078959,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743738277
    },
    {
        "content": "<p>Ah, that sounds like a good compromise</p>",
        "id": 510088754,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743744166
    },
    {
        "content": "<p>(removed)</p>",
        "id": 510180573,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1743767783
    },
    {
        "content": "<p>(removed)</p>",
        "id": 510180949,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1743767873
    },
    {
        "content": "<p>This error now also appears if I try to edit files at the bottom of the Mathlib hierarchy, such as <code>Mathlib/Tactic/Linter/Lint.lean</code>.</p>",
        "id": 510194289,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1743771044
    },
    {
        "content": "<p>The files compile fine, so I think the issue is with the <code>moreServerOptions</code> in the lakefile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"sd\">/-- These options are used</span>\n<span class=\"sd\">* as `leanOptions`, prefixed by `` `weak``, so that `lake build` uses them;</span>\n<span class=\"sd\">* as `moreServerArgs`, to set their default value in mathlib</span>\n<span class=\"sd\">  (as well as `Archive`, `Counterexamples` and `test`). -/</span>\n<span class=\"n\">abbrev</span><span class=\"w\"> </span><span class=\"n\">mathlibOnlyLinters</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">LeanOption</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">  </span><span class=\"c1\">-- The `docPrime` linter is disabled: https://github.com/leanprover-community/mathlib4/issues/20560</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.docPrime</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.hashCommand</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.oldObtain</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.cases</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.cdot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.docString</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.dollarSyntax</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.header</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.lambdaSyntax</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.longLine</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.longFile</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">1500</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"c1\">-- `latest_import.yml` uses this comment: if you edit it, make sure that the workflow still works</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.missingEnd</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.multiGoal</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.openClassical</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.refine</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span>\n<span class=\"w\">  </span><span class=\"o\">⟨</span><span class=\"ss\">`linter.style.setOption</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩</span>\n<span class=\"o\">]</span>\n\n<span class=\"sd\">/-- These options are passed as `leanOptions` to building mathlib, as well as the</span>\n<span class=\"sd\">`Archive` and `Counterexamples`. (`tests` omits the first two options.) -/</span>\n<span class=\"n\">abbrev</span><span class=\"w\"> </span><span class=\"n\">mathlibLeanOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"o\">⟨</span><span class=\"ss\">`pp.unicode.fun</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">⟩,</span><span class=\"w\"> </span><span class=\"c1\">-- pretty-prints `fun a ↦ b`</span>\n<span class=\"w\">    </span><span class=\"o\">⟨</span><span class=\"ss\">`autoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">⟩,</span>\n<span class=\"w\">    </span><span class=\"o\">⟨</span><span class=\"ss\">`maxSynthPendingDepth</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"c1\">-- options that are used in `lake build`</span>\n<span class=\"w\">    </span><span class=\"n\">mathlibOnlyLinters.map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`weak</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">s.name</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">leanOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mathlibLeanOptions</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Mathlib also enforces these linter options, which are not active by default.</span>\n<span class=\"w\">  </span><span class=\"n\">moreServerOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mathlibOnlyLinters</span>\n</code></pre></div>\n<p>So probably we should set <code>moreServerOptions</code> to either <code>mathlibOnlyLinters.map fun s ↦ { s with name := `weak ++ s.name }</code> or empty (since they are all set in <code>mathlibLeanOptions</code> anyway).</p>",
        "id": 510194912,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1743771238
    },
    {
        "content": "<p>This may be unintentional (but ultimately consistent) breakage from <a href=\"https://github.com/leanprover-community/mathlib4/pull/7376\">#7376</a>, which fortunately suggests a much easier fix: you can simply delete the <code>moreServerOptions</code> and it should work fine now</p>",
        "id": 510196474,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1743771664
    },
    {
        "content": "<p>(I assume you mean <a href=\"https://github.com/leanprover/lean4/pull/7376\">lean4#7376</a>?)</p>",
        "id": 510196872,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1743771762
    },
    {
        "content": "<p>Looks like the <code>moreServerOptions</code> are indeed unneeded, and removing them fixes the issue. I'll open a PR removing them from Mathlib.</p>",
        "id": 510197226,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1743771845
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23667\">#23667</a></p>",
        "id": 510198455,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1743772165
    }
]