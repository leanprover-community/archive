[
    {
        "content": "<p>The following code compiles but fails with the error <code>tactic 'rewrite' failed, motive is not type correct</code> at the first line when the whole Mathlib is imported:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">FreeAlgebra</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Cardinal</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">rank_adjoin_le</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">ℵ₀</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">adjoin_eq_range_freeAlgebra_lift</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">subsingleton_or_nontrivial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rank_subsingleton</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">one_le_aleph0</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le_max_right</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toLinearMap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">lift_le</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}]</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lift_rank_range_le</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">rank_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lift_id'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"n\">u</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">lift_umax</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"n\">u</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">lift_le</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">max_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">mk_list_le_max</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>Not sure what's causing the problem. cc <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span></p>",
        "id": 478555535,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729707076
    },
    {
        "content": "<p>I think unfortunately the game is now to prune the imports until you find the one that matters</p>",
        "id": 478556247,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729707296
    },
    {
        "content": "<p>I vote category theory :)</p>",
        "id": 478556354,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1729707323
    },
    {
        "content": "<p>You can try importing a very deep file in category theory and see if the error is still there.</p>",
        "id": 478556819,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1729707463
    },
    {
        "content": "<p><code>import Mathlib.Algebra.DirectSum.Internal</code> breaks it, but </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Operations</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span>\n</code></pre></div>\n<p>(its imports) doesn't</p>",
        "id": 478557645,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729707718
    },
    {
        "content": "<p>I was expecting #synth can tell the difference, but no matter I import Mathlib or just the FreeAlgebra file, #synth is showing that both instances come from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.instModuleSubtypeMem#doc\">docs#Subalgebra.instModuleSubtypeMem</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">↑</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">range</span>\n</code></pre></div>",
        "id": 478558030,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729707848
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">ofSubmonoidOnSemiring</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddSubmonoidClass</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p>seems to be the culprit</p>",
        "id": 478558234,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729707931
    },
    {
        "content": "<p>Can that be deleted?</p>",
        "id": 478558500,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1729708022
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">FreeAlgebra</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">from_Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">Internal</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n\n<span class=\"c1\">--uncomment to break</span>\n<span class=\"c1\">-- instance AddCommMonoid.ofSubmonoidOnSemiring [Semiring R] [SetLike σ R] [AddSubmonoidClass σ R]</span>\n<span class=\"c1\">--     (A : ι → σ) : ∀ i, AddCommMonoid (A i) := fun i =&gt; by infer_instance</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">from_Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">Internal</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Cardinal</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">rank_adjoin_le</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">ℵ₀</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">adjoin_eq_range_freeAlgebra_lift</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">subsingleton_or_nontrivial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rank_subsingleton</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">one_le_aleph0</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le_max_right</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toLinearMap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">lift_le</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}]</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lift_rank_range_le</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">rank_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lift_id'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"n\">u</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">lift_umax</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"n\">u</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">lift_le</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">max_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">mk_list_le_max</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>",
        "id": 478558610,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729708064
    },
    {
        "content": "<p>This is very weird. <code>AddCommMonoid.ofSubmonoidOnSemiring</code> is only a shortcut instance, so the root cause lies deeper.</p>",
        "id": 478559550,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729708354
    },
    {
        "content": "<p>Is it suggesting the problem is with <code>Add</code> not <code>SMul</code>? But the underlying instance <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddSubmonoidClass.toAddCommMonoid#doc\">docs#AddSubmonoidClass.toAddCommMonoid</a> definitely looks very innocent. And my example has nothing to do with Pi types. How does the shortcut instance affect the synthesis path?</p>",
        "id": 478560820,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729708870
    },
    {
        "content": "<p>It looks like it might be Add's problem. When importing Mathlib both instances are given by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddCommGroup.ofSubgroupOnRing#doc\">docs#AddCommGroup.ofSubgroupOnRing</a>, while when importing FreeAlgebra both are given by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ring.toAddCommGroup#doc\">docs#Ring.toAddCommGroup</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">↑</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">range</span>\n</code></pre></div>\n<p>For the AddCommMonoid instances (required by Module), the instances are given by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddCommMonoid.ofSubmonoidOnSemiring#doc\">docs#AddCommMonoid.ofSubmonoidOnSemiring</a> (the one Kevin found) and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NonUnitalNonAssocSemiring.toAddCommMonoid#doc\">docs#NonUnitalNonAssocSemiring.toAddCommMonoid</a> respectively.</p>",
        "id": 478561310,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729709046
    },
    {
        "content": "<p>The synthesis results are very interesting! I never expected it splits <code>Algebra.adjoin R s</code> as a function application, and the <code>AlgHom.range _</code> as well!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">ofSubmonoidOnSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">ofSubmonoidOnSemiring</span><span class=\"w\"> </span><span class=\"n\">AlgHom</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But there's nothing fishy going on here. Still haven't found the root cause ...</p>",
        "id": 478562457,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729709471
    },
    {
        "content": "<p>I would guess that <code>AddCommMonoid.ofSubmonoidOnSemiring </code> causes it to capture terms of an arbitrary type <code>ι</code> under binders, which then gets in the way of rewrites: so this isn't a diamond, but it's an unwanted eta expansion</p>",
        "id": 478563991,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710014
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Add.20diamond.20on.20Subalgebra/near/478558500\">said</a>:</p>\n<blockquote>\n<p>Can that be deleted?</p>\n</blockquote>\n<p>Did someone try? This might be left from Lean 3</p>",
        "id": 478564094,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710048
    },
    {
        "content": "<p>This works fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Cardinal</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">rank_adjoin_le</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">ℵ₀</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">ofSubmonoidOnSemiring</span><span class=\"w\">  </span><span class=\"c1\">-- added</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">adjoin_eq_range_freeAlgebra_lift</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">subsingleton_or_nontrivial</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rank_subsingleton</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">one_le_aleph0</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le_max_right</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">rank</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toLinearMap</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">lift_le</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}]</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lift_rank_range_le</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">rank_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lift_id'</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"n\">u</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">lift_umax</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"n\">u</span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">lift_le</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">max_comm</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">mk_list_le_max</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>",
        "id": 478564257,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710102
    },
    {
        "content": "<p>maybe making <code>AddCommMonoid.ofSubmonoidOnSemiring</code> an <code>abbrev</code> is also enough</p>",
        "id": 478564415,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710144
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Add.20diamond.20on.20Subalgebra/near/478564094\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Add.20diamond.20on.20Subalgebra/near/478558500\">said</a>:</p>\n<blockquote>\n<p>Can that be deleted?</p>\n</blockquote>\n<p>Did someone try? This might be left from Lean 3</p>\n</blockquote>\n<p>What are your feelings on the next line,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"bp\">.</span><span class=\"n\">ofSubgroupOnRing</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddSubgroupClass</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p>?</p>",
        "id": 478564654,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729710237
    },
    {
        "content": "<p>Probably also harmful</p>",
        "id": 478564836,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710295
    },
    {
        "content": "<p>I think I added these because I had no choice, not because I wanted them</p>",
        "id": 478564898,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710316
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/rewrite.20failure.20on.20Subalgebra/near/478563991\">said</a>:</p>\n<blockquote>\n<p>I would guess that <code>AddCommMonoid.ofSubmonoidOnSemiring </code> causes it to capture terms of an arbitrary type <code>ι</code> under binders, which then gets in the way of rewrites: so this isn't a diamond, but it's an unwanted eta expansion</p>\n</blockquote>\n<p>Yeah, I can see the difference between <code>Set S</code> and <code>FreeAlgebra R { x // x ∈ s } →ₐ[R] S</code> probably caused the trouble.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">ofSubmonoidOnSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subalgebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">toSemiring</span><span class=\"w\"> </span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">instSetLike</span><span class=\"w\"> </span><span class=\"bp\">⋯</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">↥</span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">adjoin</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n\n<span class=\"bp\">@</span><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">ofSubmonoidOnSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FreeAlgebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">→ₐ</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subalgebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">toSemiring</span>\n<span class=\"w\">  </span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">instSetLike</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"n\">AlgHom</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">↥</span><span class=\"o\">((</span><span class=\"n\">FreeAlgebra</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">range</span>\n</code></pre></div>",
        "id": 478565068,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729710368
    },
    {
        "content": "<p>In Lean 4 the <code>Internal</code> file compiles without the instances. <a href=\"https://github.com/leanprover-community/mathlib4/pull/18149\">#18149</a></p>",
        "id": 478565248,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729710440
    },
    {
        "content": "<p>Did <code>abbrev</code> also fix the issue?</p>",
        "id": 478565497,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710541
    },
    {
        "content": "<p>Not because I think it's a better solution, but to help understand the problem better</p>",
        "id": 478565540,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729710559
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/rewrite.20failure.20on.20Subalgebra/near/478565497\">said</a>:</p>\n<blockquote>\n<p>Did <code>abbrev</code> also fix the issue?</p>\n</blockquote>\n<p>Yeah, changing <code>instance</code> to <code>abbrev</code> in <a href=\"#narrow/channel/287929-mathlib4/topic/rewrite.20failure.20on.20Subalgebra/near/478558610\">Kevin's code</a> doesn't break the proof. (I mean, the proof is then no longer broken.)</p>",
        "id": 478566694,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729710995
    },
    {
        "content": "<p>The proof in this thread or the proof in that file?</p>",
        "id": 478566760,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729711026
    },
    {
        "content": "<p>Sorry, that was a stupid suggestion</p>",
        "id": 478566839,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729711058
    },
    {
        "content": "<p><code>@[reducible] instance</code> is what I meant</p>",
        "id": 478566867,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729711072
    },
    {
        "content": "<p>Or <code>@[instance] abbrev</code></p>",
        "id": 478566893,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729711082
    },
    {
        "content": "<p>Both would still break my proof</p>",
        "id": 478567142,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729711181
    },
    {
        "content": "<p>Is there a Module version of this instance in a later file that we should also remove?</p>",
        "id": 478567994,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729711498
    },
    {
        "content": "<p>mathlib compiles with the removal of the <code>∀ i, AddCommMonoid (A i)</code> and <code>∀ i, AddCommGroup (A i)</code> instances, but I can't see any module instances, although we do have <code>Semiring (A 0)</code>, <code>CommSemiring (A 0)</code> etc instances.</p>",
        "id": 478574837,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729714054
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddCommMonoid.ofSubmonoidOnSemiring#doc\">docs#AddCommMonoid.ofSubmonoidOnSemiring</a> seems like a bad instance. What is even the reason of stating it as <br>\n<code>(A : ι → σ) (i : ι) : AddCommMonoid ↥(A i)</code> instead of <code>(A : σ) : AddCommMonoid ↥A</code>? (sorry if this was mentioned before, I didn't read everything here.)</p>",
        "id": 478575544,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729714342
    },
    {
        "content": "<p>Oh, is it precisely because type-class inference struggles with these dependent types (or did so in Lean 3)?</p>",
        "id": 478575628,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729714384
    },
    {
        "content": "<p>Benchmarking indicates they seem to help a bit locally but overall effect is negligible</p>",
        "id": 478575830,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1729714462
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/rewrite.20failure.20on.20Subalgebra/near/478574837\">said</a>:</p>\n<blockquote>\n<p>although we do have <code>Semiring (A 0)</code>, <code>CommSemiring (A 0)</code> etc instances.</p>\n</blockquote>\n<p>These are surely bad enough to be scoped, but I never go around to it since they didn't cause any visible trouble</p>",
        "id": 478575885,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729714489
    },
    {
        "content": "<p>I think removing all the instances like this we don't need anymore in Lean 4 and scoping the remainder would be very good.</p>",
        "id": 478576449,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729714734
    },
    {
        "content": "<p>Any objections to <a href=\"https://github.com/leanprover-community/mathlib4/pull/18149\">#18149</a> before it boards the merge train? (Fixed: thanks Floris)</p>",
        "id": 478576524,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1729714770
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18149\">#18149</a></p>",
        "id": 478576671,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1729714822
    },
    {
        "content": "<p>The <code>A 0</code> instances were never a Lean 3 hack, but rather a questionable feature of my own making</p>",
        "id": 478576805,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729714883
    },
    {
        "content": "<p>Yes, my students needed them a few months ago, they're much newer</p>",
        "id": 478576858,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1729714908
    },
    {
        "content": "<p>Maybe some of them are, but I wrote many of them at the same time as the ones we're deleting, I thought</p>",
        "id": 478577463,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729715161
    },
    {
        "content": "<p>I remember them being stress-tested in a past PR</p>",
        "id": 478577674,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1729715244
    },
    {
        "content": "<p>They exist because there is no way to say \"Let <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">A_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> be a collection of additive monoids where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>A</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">A_0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> is also a semi ring\"</p>",
        "id": 478577717,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1729715264
    },
    {
        "content": "<p>Side story: I discovered this issue because nowadays I usually write little lemmas in the web editor importing Mathlib, and later use #find_home to put them into appropriate files. (Maybe a healthy habit to promote!) I had to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.rank_toSubmodule#doc\">docs#Subalgebra.rank_toSubmodule</a> (a rfl lemma) due to this failure, and since LinearAlgebra.FreeAlgebra is only imported by a leaf file, #find_home suggested Mathlib itself, so I ended up importing LinearAlgebra.Dimension.Constructions into LinearAlgebra.FreeAlgebra, causing a large-import alert. I decided to use <code>change</code> rather than the rfl lemma and remove the import, but was surprised to find the rewrite simply works in LinearAlgebra.FreeAlgebra. I went back to recheck this doesn't work with <code>import Mathlib</code> and opened this topic.</p>\n<p>I think many people (including myself) encountered such rewrite failures many times before, but in the case of myself, I just wasn't sufficiently convinced that such failures are something that shouldn't happen to report them.</p>",
        "id": 478580554,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1729716412
    }
]