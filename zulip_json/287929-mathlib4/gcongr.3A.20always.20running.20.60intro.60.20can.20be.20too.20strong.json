[
    {
        "content": "<p>The following example is minimized from the carleson project. I presume this is a regression from <a href=\"https://github.com/leanprover-community/mathlib4/pull/16747\">#16747</a>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">MeasureTheory</span><span class=\"w\"> </span><span class=\"n\">Metric</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">minimized</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MetricSpace</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MeasureSpace</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">cutoff</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measurable</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">cutoff</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"bp\">∞</span><span class=\"o\">))</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hf'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ball</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">cutoff</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∫⁻</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ball</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">∫⁻</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ball</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">cutoff</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">gcongr</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">y'</span>\n<span class=\"w\">  </span><span class=\"c1\">-- now, the goal has `y' : X`, which is too strong:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- I want to take `y'` in the ball, not just in `X`</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- -- in contrast, this works:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- apply setLIntegral_mono hf</span>\n<span class=\"w\">  </span><span class=\"c1\">-- intro y' hy'</span>\n<span class=\"w\">  </span><span class=\"c1\">-- -- closing the sorry</span>\n<span class=\"w\">  </span><span class=\"c1\">-- exact ENNReal.coe_le_coe.mpr (hf' ⟨y', hy'⟩)</span>\n</code></pre></div>\n<p>The automatic running of <code>intro</code> is overzealous here: it introduces a new variable <em>without any side conditions</em>.<br>\nI agree that running <code>intro</code> is often desirable. I wonder</p>\n<ul>\n<li>could it be fixed, to recognise that it should introduce y in the ball?</li>\n<li>if not, could running intro be made configurable?</li>\n</ul>",
        "id": 481137710,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1730991223
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> as the author of the above PR (see the above post)</p>",
        "id": 481139290,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1730991637
    },
    {
        "content": "<p>I don't think this is a regression from <a href=\"https://github.com/leanprover-community/mathlib4/pull/16747\">#16747</a>.  Rather, this is just a matter of the choice of <code>gcongr</code> lemma for <code>lintegral</code>: when Floris and I added the tagging in <a href=\"https://github.com/leanprover-community/mathlib4/pull/7681\">#7681</a>, we apparently chose <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.lintegral_mono_fn#doc\">docs#MeasureTheory.lintegral_mono_fn</a> rather than <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.lintegral_mono_ae#doc\">docs#MeasureTheory.lintegral_mono_ae</a>.</p>",
        "id": 481141727,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730992354
    },
    {
        "content": "<p>That is, we told <code>gcongr</code> to reduce an inequality between Lebesgue integrals to <code>∀ x, f x ≤ g x</code> rather than to <code>∀ᵐ (a : α) ∂μ, f a ≤ g a</code>.  The latter is more general and it's what would be needed for your use case, but the former is easier to use in the cases where it does work.  So I'm not sure what the right choice is!</p>",
        "id": 481142213,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730992495
    },
    {
        "content": "<p>I see, thanks for explaining! Let me think about this.<br>\nCC <span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> This should be interesting to discuss, next time we meet.</p>",
        "id": 481145061,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1730993323
    },
    {
        "content": "<p>Yes, we should make sure we tag the correct lemmas with <code>@[gcongr]</code>. Perhaps we can add an additional <code>gcongr</code> lemma that works for <code>setLIntegral</code>/<code>setIntegral</code>, but is still pointwise and has a higher priority (I don't know if the <code>gcongr</code> tactic supports that).</p>",
        "id": 481145892,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1730993548
    },
    {
        "content": "<p>There's no prioritization in <code>gcongr</code>, kind of on principle: having only one lemma which applies in a given situation means that <code>gcongr</code> is opinionated but fast.</p>\n<p>(Actually, there is back-door support for prioritization: if there are two lemmas which apply they will be tried in some order which is presumably determined by the tagging order in the library and/or the order of imports.  But hopefully this is not currently being exploited anywhere in the library, and maybe someday we will have linters to guard against it.)</p>",
        "id": 481146851,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730993835
    },
    {
        "content": "<p>Heather, you said in <a href=\"https://github.com/leanprover-community/mathlib4/pull/17653\">#17653</a> that a tagged lemma of the form <code>f a b ≤ f c d</code> wouldn't apply when trying to prove <code>f a b ≤ f a d</code>. Is that not a form of prioritization as well?</p>",
        "id": 481147780,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730994119
    },
    {
        "content": "<p>Nope, that's the opposite: <code>gcongr</code> looks at the goal and can read off which lemma to use (the 1-input or 2-input version) without having to try both.</p>",
        "id": 481148120,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1730994214
    }
]