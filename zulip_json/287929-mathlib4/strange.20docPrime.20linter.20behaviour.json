[
    {
        "content": "<p>what's going on in the following example?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">docPrime</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">testing</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Foo'</span>\n\n<span class=\"n\">whatsnew</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c1\">-- commenting out the above line makes the linter ping the instance for no clear reason; the whatsnew command doesn't show any declaration with a name ending with a prime though</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">Foo'</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Foo'</span>\n</code></pre></div>",
        "id": 489550515,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734461103
    },
    {
        "content": "<p><del>i'm guessing the <code>whatsnew in</code> command somehow alters what declarations get made?</del></p>",
        "id": 489550763,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734461194
    },
    {
        "content": "<p><del>i guess it might be beneficial if the linter error told us what declaration this is about?</del> i'm a dumbass and cant read</p>",
        "id": 489550905,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734461252
    },
    {
        "content": "<p>still, it is strange it does not recognise that <code>Foo'</code> already has a docstring?</p>",
        "id": 489551219,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734461400
    },
    {
        "content": "<p>presumably <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span></p>",
        "id": 489551364,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734461453
    },
    {
        "content": "<p>In the above example, <code>declId</code> gets set to <code>&lt;missing&gt;</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declId</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Lean.Parser.Command.instance</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">][</span><span class=\"mi\">3</span><span class=\"o\">][</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">stx</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">][</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n</code></pre></div>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/9890d5ff187e6a1625705cce1f16623a755a22db/Mathlib/Tactic/Linter/DocPrime.lean#L50\">https://github.com/leanprover-community/mathlib4/blob/9890d5ff187e6a1625705cce1f16623a755a22db/Mathlib/Tactic/Linter/DocPrime.lean#L50</a></p>",
        "id": 489552879,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734462019
    },
    {
        "content": "<p>... which gets appended to the namespace <code>Foo'</code>, to get a <code>declName</code> of <code>Foo'</code>, which ends in a prime.</p>",
        "id": 489553091,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734462103
    },
    {
        "content": "<p>I'm guessing this code was written without considering the possibility of an anonymous instance.</p>",
        "id": 489553350,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734462181
    },
    {
        "content": "<p>so if i understand correctly, the linter only <em>guesses</em> the name of declarations, and triggers based off of that guess?</p>",
        "id": 489553386,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734462194
    },
    {
        "content": "<p>I expect that adding a check for that would fix it.</p>",
        "id": 489553388,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734462195
    },
    {
        "content": "<p>I agree that the way of extracting the declaration name from syntax seems not super reliable.</p>",
        "id": 489553509,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734462241
    },
    {
        "content": "<p>I wonder if infotrees might provide a more reliable way.</p>",
        "id": 489553675,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734462292
    },
    {
        "content": "<p>We could get the infotree via <code>‚Üê getInfoTrees</code> and then get the declaration name via <code>ContextInfo.parentDecl?</code>.</p>",
        "id": 489553816,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734462346
    },
    {
        "content": "<p>The same problem with <code>example</code> instead of <code>instance</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n</code></pre></div>",
        "id": 489558982,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734464265
    },
    {
        "content": "<p>I'll prepare a PR with a fix for these cases.</p>",
        "id": 489559129,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734464315
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20027\">mathlib4#20027</a></p>",
        "id": 489561389,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734465147
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20027\">#20027</a>, just for the emoji bot's sake!</p>",
        "id": 489573393,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734470135
    },
    {
        "content": "<p>When I wrote the linter, there was not yet the utility to extract the \"correct\" name.  Since figuring out the performance of that function is work in progress, the proposed fix looks good!</p>",
        "id": 489573587,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734470219
    },
    {
        "content": "<p>Oh, the bot picked up the earlier link to the PR as well: good to know!</p>",
        "id": 489573645,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734470253
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/strange.20docPrime.20linter.20behaviour/near/489573645\">said</a>:</p>\n<blockquote>\n<p>Oh, the bot picked up the earlier link to the PR as well: good to know!</p>\n</blockquote>\n<p>right, the post contains <code>#20027</code> and a link to the corresponding PR, is in a public channel and not in <a class=\"stream\" data-stream-id=\"116290\" href=\"/#narrow/channel/116290-rss\">#rss</a> ; therefore, it should find it.</p>",
        "id": 489573829,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1734470355
    },
    {
        "content": "<blockquote>\n<p>When I wrote the linter, there was not yet the utility to extract the \"correct\" name.</p>\n</blockquote>\n<p>Is there such a utility now? Are infotrees the way to go?</p>",
        "id": 489577449,
        "sender_full_name": "David Renshaw",
        "timestamp": 1734472078
    },
    {
        "content": "<p>There is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Linter.getNamesFrom#doc\">docs#Mathlib.Linter.getNamesFrom</a> which admittedly should get some extra filters: as is, it returns a lot of autogenerated names, with no option to sift out any \"clearly unwanted\" declaration.</p>",
        "id": 489581853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734473979
    },
    {
        "content": "<p>It works by inspecting the DeclRange environment extension, rather than the InfoTrees.  I suspect that the InfoTrees approach would also work (I experimented with them for a similar reason with the minImports command), but I suspect that it might be harder to make that more efficient.</p>",
        "id": 489582054,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734474075
    }
]