[
    {
        "content": "<p>Apologies for the large <a href=\"https://gist.github.com/kbuzzard/50ca02a8d646986541a74e42b9095b48\">MWE</a>; it's mathlib-only but to minimise it from FLT I needed 150 lines of API for restricted products. </p>\n<p>I find this code pretty weird (although I've seen this phenomenon before; I just want to understand it better). After the boilerplate there are two declarations at the end. The last-but-one declaration is <code>padicRingEquiv</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">padicRingEquiv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùìû</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ+*</span><span class=\"w\"> </span><span class=\"bp\">Œ† ≥</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Primes</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">‚Ñö_</span><span class=\"o\">[</span><span class=\"n\">p</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">subring</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">__</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">something</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which is a ring isomorphism between two rings, and this compiles very quickly. The last declaration is <code>padicEquiv</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">padicEquiv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùìû</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ‚Çê</span><span class=\"o\">[</span><span class=\"n\">‚Ñö</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">Œ† ≥</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Primes</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">‚Ñö_</span><span class=\"o\">[</span><span class=\"n\">p</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">subring</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">__</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">same</span><span class=\"w\"> </span><span class=\"n\">thing</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">commutes'</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">proof</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>which is a <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Q</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Q}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8556em;vertical-align:-0.1667em;\"></span><span class=\"mord mathbb\">Q</span></span></span></span>-algebra isomorphism between the same rings, and the construction is simply the same ring equiv and then a proof that the <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Q</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Q}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8556em;vertical-align:-0.1667em;\"></span><span class=\"mord mathbb\">Q</span></span></span></span>-algebra structures are compatible. </p>\n<p>If I <code>sorry</code> the <code>commutes'</code> proof then <code>padicEquiv</code> compiles really quickly, and if I fill in the proof then it compiles super-slowly. But the problem isn't the proof, which the profiler indicates is still compiling quickly. The problem is what happens afterwards: the orange bars disappear (in particular the orange bars on the proof disappear) apart from the one-line bar on the <code>def padicEquiv</code> line and it stays for 30 seconds.  My understanding of what is going on is that some part of the system accepts the declaration, and then the kernel checks it and the kernel has a really hard time convincing itself that the declaration is actually OK. The profiler says</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.061745</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.061631</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">typechecking</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">padicEquiv</span><span class=\"bp\">._</span><span class=\"n\">proof_1</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.066556</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.066531</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">typechecking</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">padicEquiv</span><span class=\"bp\">._</span><span class=\"n\">proof_2</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">29.744237</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">29.744206</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">typechecking</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">padicEquiv</span><span class=\"bp\">._</span><span class=\"n\">proof_3</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.048560</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">addDecl</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.048416</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">typechecking</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">padicEquiv</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>so clearly the issue is with <code>padicEquiv._proof_3</code>. I've tried <code>#print</code>ing the proof but it doesn't round trip. </p>\n<p>What are the possible causes for such a situation? Am I abusing defeq somewhere? How does one go about debugging this? All I can get from the profiler is \"something is taking 29 seconds on a fast machine\". Are we now getting to the point where there are tools which I can use which give some kind of indication as to what exactly is being abused in this definition?</p>",
        "id": 565228610,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1766536622
    },
    {
        "content": "<p>maybe try inserting <code>as_aux_lemma =&gt;</code> in the middle of the proof I've found that it helps sometimes</p>",
        "id": 565228997,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766537039
    },
    {
        "content": "<p>oh you have code I can try stuff on it</p>",
        "id": 565229038,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766537096
    },
    {
        "content": "<p>it becomes fast if I replace the final <code>simp</code> with <code>simp -implicitDefEqProofs</code></p>",
        "id": 565229150,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766537224
    },
    {
        "content": "<p>so probably you have a <code>rfl</code>-proof that's slow when you instantiate it</p>",
        "id": 565229202,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766537280
    },
    {
        "content": "<p>this has caused problem before <a href=\"#narrow/channel/270676-lean4/topic/.60deep.20recursion.20detected.60.20with.2016-bit.20bitvec's/near/494897453\">#lean4 &gt; &#96;deep recursion detected&#96; with 16-bit bitvec's @ üí¨</a></p>",
        "id": 565229387,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766537510
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/help.20with.20diagnosis.20of.20slow.20declaration/near/565229150\">said</a>:</p>\n<blockquote>\n<p>it becomes fast if I replace the final <code>simp</code> with <code>simp -implicitDefEqProofs</code></p>\n</blockquote>\n<p>Oh nice find! Thanks! So I'll just do this and ignore the issue :-) Or will it bite me again later?</p>",
        "id": 565229611,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1766537746
    },
    {
        "content": "<p>I think it might prevent <code>simp</code> from calling <code>dsimp</code> in certain places, but it shouldn't have any negative consequences if it works</p>",
        "id": 565229786,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766537960
    }
]