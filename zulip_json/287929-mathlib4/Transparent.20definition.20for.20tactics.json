[
    {
        "content": "<p>I mentioned this already in <a href=\"#narrow/channel/113489-new-members/topic/unfold.20at.20.5BTERM.5D\">another</a> discussion, but I want to reformulate it here as a proper proposal.</p>\n<p><code>let</code> definitions don’t automatically unfold for <code>simp</code> (and probably other tactics). Would it be possible to have a tactic similar to <code>let</code>, but creating more transparent terms that don’t need unfolding in subsequent proofs?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"c1\">-- unfolding is necessary for simp</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"c1\">-- this works fine</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>Of course, in this simple example I could just write <code>rfl</code> instead of <code>by unfold x y; simp</code>. But in more complex proofs, I often run into situations where I want to abbreviate a term <code>T</code> that appears repeatedly. After introducing <code>let x := T</code> and replacing <code>T</code> with <code>x</code> subsequently, some tactics stop working and I need to insert <code>unfold t</code> (or similar fixes). This feels unintuitive to me, both as a programmer and as a mathematician, since introducing local helper terms to clean up code or proofs is such a common practice and should work with minimal friction.</p>\n<p>So I wonder: would it be technically possible to introduce a tactic alongside <code>let</code>, e.g. <code>abbrev</code>, that can be used inside proof contexts to create fully transparent abbreviations, working as drop-in replacements without breaking tactics or other proof details?</p>",
        "id": 538015196,
        "sender_full_name": "Klaus Gy",
        "timestamp": 1757175987
    },
    {
        "content": "<p>Try using <code>letI</code> in your actual example. This example above is a bit contrived because <code>simp</code> doesn't actually do anything; the reason the goal is closed is that after <code>simp</code> runs its simplification algorithm it tries <code>rfl</code> but only at some kind of reducible transparency, and <code>letI</code> doesn't help here. But it might help in your actual example.</p>",
        "id": 538023644,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757184683
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Transparent.20definition.20for.20tactics/near/538023644\">said</a>:</p>\n<blockquote>\n<p>This example above is a bit contrived because <code>simp</code> doesn't actually do anything; the reason the goal is closed is that after <code>simp</code> runs its simplification algorithm it tries <code>rfl</code> but only at some kind of reducible transparency, and <code>letI</code> doesn't help here. But it might help in your actual example.</p>\n</blockquote>\n<p>what do you mean by this?</p>",
        "id": 538023741,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757184783
    },
    {
        "content": "<p>I'm saying that the issue isn't that <code>let</code> isn't unfolding for <code>simp</code>, it's <code>let</code> not unfolding for <code>with_reducible rfl</code>; <code>letI</code> unfolds more than <code>let</code>(doesn't it?)  so maybe the OP will have more luck with <code>letI</code> when using the \"other tactics\".</p>",
        "id": 538023969,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757185033
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Transparent.20definition.20for.20tactics/near/538023969\">said</a>:</p>\n<blockquote>\n<p><code>letI</code> unfolds more than <code>let</code>(doesn't it?)</p>\n</blockquote>\n<p>it's the same within in the body, <code>letI</code> only differs from <code>let</code> once you finish elaborating the body of the <code>let</code></p>",
        "id": 538024009,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757185074
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Transparent.20definition.20for.20tactics/near/538023969\">said</a>:</p>\n<blockquote>\n<p>I'm saying that the issue isn't that <code>let</code> isn't unfolding for <code>simp</code>, it's <code>let</code> not unfolding for <code>with_reducible rfl</code></p>\n</blockquote>\n<p><code>with_reducible rfl</code> seems to be doing fine</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"c1\">-- unfolding is not necessary for rfl</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">with_reducible</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"c1\">-- this works fine</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 538024048,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757185103
    },
    {
        "content": "<p>You might want <code>simp +zetaDelta</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">zetaDelta</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 538024351,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1757185425
    },
    {
        "content": "<p>You can also tell <code>simp</code> to unfold specific let variables using <code>simp [x, y]</code>.</p>",
        "id": 538029452,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1757190456
    },
    {
        "content": "<p>nevertheless I think it would be convenient to have notation for long terms in tactic mode</p>",
        "id": 538037881,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1757200814
    },
    {
        "content": "<p>It would be a relatively large and delicate change to add transparency to let declarations, and it would affect all basic Lean systems.</p>\n<p>The alternative is making metavariables instead. These are completely transparent. It's possible to conveniently create them using a secret internal notation:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">let_mvar</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">let_mvar</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"c1\">-- ⊢ 3 = 3</span>\n<span class=\"w\">    </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>It's not a tactic though, just a term. The semicolon is necessary.</p>",
        "id": 538039293,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1757202947
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> thank you, that's what i was looking for! And Thanks <span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> , <code>+zetaDelta</code> is also a very nice trick I didn't know!</p>",
        "id": 538204247,
        "sender_full_name": "Klaus Gy",
        "timestamp": 1757332507
    }
]