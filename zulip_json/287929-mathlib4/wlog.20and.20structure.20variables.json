[
    {
        "content": "<p>I am stumbling upon something that looks crazy to me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BooleanAlgebra</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">]</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyStructure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">b</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">MyStructure</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">wlog</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">h</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">h</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"n\">MyStructure</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">h</span><span class=\"bp\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"c1\">-- depends on A, B, C, D, their class instances; and on X, x, y and h</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"c1\">-- depends on X, x, y and h</span>\n</code></pre></div>\n<p>Why does the <code>wlog</code> change the variables that <code>bar</code> and <code>foo</code> depend upon?</p>",
        "id": 527915109,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1752075148
    },
    {
        "content": "<p>It's because you've made them a <code>def</code></p>",
        "id": 527915491,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075257
    },
    {
        "content": "<p>If you make them a <code>theorem</code> then the proof can't affect the statement</p>",
        "id": 527915543,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075274
    },
    {
        "content": "<p>you can also use <code>wlog _ : _ generalizing var1 var2 var3</code> (the default is generalize everything)</p>",
        "id": 527915622,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075298
    },
    {
        "content": "<p><del> This does really answer my question, it's more of a way out...</del> Ah so it has generalised also `A, B, C, D ``, etc...</p>",
        "id": 527915641,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1752075304
    },
    {
        "content": "<p>so when <code>wlog</code> generalizes over a hypothesis, it adds a dependency</p>",
        "id": 527915770,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075338
    },
    {
        "content": "<p>and this is a way you can restrict it</p>",
        "id": 527915812,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075351
    },
    {
        "content": "<p>Oh great, I see.</p>",
        "id": 527915909,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1752075377
    },
    {
        "content": "<p>and <code>def</code> brings everything into scope but if something isn't used in the body it's removed from the type of the theorem</p>",
        "id": 527915952,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075387
    },
    {
        "content": "<p>This is why you should not use tactics in <code>def</code>.</p>",
        "id": 527915977,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1752075396
    },
    {
        "content": "<p>I mean, because sometimes they do strange things and in defs you really care on what is after the <code>:=</code></p>",
        "id": 527916134,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1752075438
    },
    {
        "content": "<p>but with <code>theorem</code> it brings everything into scope when checking the type of the statement, and removes the unused stuff before elaborating the body, so the body can't affect the statement</p>",
        "id": 527916157,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752075447
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/channel/287929-mathlib4/topic/wlog.20and.20structure.20variables/near/527915977\">said</a>:</p>\n<blockquote>\n<p>This is why you should not use tactics in <code>def</code>.</p>\n</blockquote>\n<p>My point was more to understand what was peculiar about <code>wlog</code> (this does not happen with other tactics), and I really believe that the point is <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> 's comment.</p>",
        "id": 527916198,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1752075457
    },
    {
        "content": "<p>Maybe then this is just another reason to hate <code>wlog</code> <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 527916555,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1752075570
    },
    {
        "content": "<p>More specifically, when Lean is elaborating a def/theorem, it initially assumes that all defined variables are used, and then at the end it automatically kicks out unused variables.</p>\n<p>For defs, this happens at the end, and for theorems, this happens after the statement. (I think)</p>",
        "id": 527916585,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1752075583
    },
    {
        "content": "<p>Oh, nice!</p>",
        "id": 527924012,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1752078054
    },
    {
        "content": "<p>But at any rate, this behaviour of <code>wlog</code> was unexpected.</p>",
        "id": 527924094,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1752078080
    },
    {
        "content": "<p>I'm actually not sure why this doesn't happen with <code>induction</code> or <code>cases</code>, because it definitely used to be a problem. During porting, before we had the new <code>variable</code> behavior for <code>theorem</code>, this was a continual problem where the types of theorems would be affected by these tactics because they would pull in new variables, and then Lean would decide they were used in the proof and therefore belonged in the statement.</p>",
        "id": 527942933,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1752085326
    }
]