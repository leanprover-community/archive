[
    {
        "content": "<p>So, I appreciate the recent-ish movement to add more informative error messages throughout Lean/Mathlib on the whole. In the specific case of <code>reassoc_of%</code>, however, I think the changed error is a bit of a regression.</p>",
        "id": 524678383,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750243703
    },
    {
        "content": "<p><code>reassoc_of%</code> now reports that<br>\n<code>`reassoc` can only be used on terms about equality of (iso)morphisms</code><br>\nany time it fails to fully elaborate, but a very common reason for <code>reassoc_of%</code> to fail isn't because you're using it on the wrong type, but rather because it can't infer the category you're in. This was an existing issue, but at least before it would simply tell you that fairly directly.</p>",
        "id": 524678430,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750243719
    },
    {
        "content": "<p>I have used <code>reassoc_of%</code> very extensively, and I never encountered any such error. Could you share a MWE?</p>",
        "id": 524681470,
        "sender_full_name": "Joël Riou",
        "timestamp": 1750244802
    },
    {
        "content": "<p>Huh, really? I get it absolutely constantly.</p>\n<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">Shapes</span><span class=\"bp\">.</span><span class=\"n\">Products</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"w\"> </span><span class=\"n\">Limits</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span>\n<span class=\"w\">         </span><span class=\"o\">{</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">HasCoproduct</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span>\n<span class=\"w\">         </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span>\n\n<span class=\"c1\">--fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">desc</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">reassoc_of</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">ι_desc</span><span class=\"o\">]</span>\n\n<span class=\"c1\">--succeeds</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">desc</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">reassoc_of</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">ι_desc</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)]</span>\n</code></pre></div>",
        "id": 524682008,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750245027
    },
    {
        "content": "<p>(unrelatedly, <code>Sigma.ι_desc</code> really should just have a <code>reassoc</code>...)</p>",
        "id": 524682171,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750245099
    },
    {
        "content": "<p>It is not \"unrelatedly\": the solution is to add the <code>reassoc</code> attribute to <code>Sigma.ι_desc</code>.</p>",
        "id": 524690146,
        "sender_full_name": "Joël Riou",
        "timestamp": 1750248109
    },
    {
        "content": "<p>In my own code, I use <code>reassoc_of%</code> only in two situations:</p>\n<ul>\n<li>I have an assumption like <code>fac : f ≫ g = h</code> and I want to rewrite this in a goal or in another assumption;</li>\n<li>I want to use a lemma <code>foo</code> (which may have an <code>assoc</code> variant), but the term produced by <code>foo</code> exactly matches a subexpression in my goal only after doing <code>dsimp</code>, then I do <code>have := foo ...; dsimp at this; rw [reassoc_of% this]</code>.</li>\n</ul>\n<p>Otherwise, the automatically generated <code>_assoc</code> lemmas should be enough, but some of these are missing.</p>",
        "id": 524692341,
        "sender_full_name": "Joël Riou",
        "timestamp": 1750248816
    },
    {
        "content": "<p>Perhaps it's not truly unrelated, but I generally use <code>reassoc_of%</code> precisely to avoid having to recompile some large number of files after having to change something early in the import tree. For something like <code>Sigma.ι_desc</code> that I use frequently it makes sense to just take the hit, but if it's a lemma I only use once, I'd rather not wait the twenty minutes until the end of the project.</p>",
        "id": 524774747,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750276694
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"359992\">Robert Maxton</span> <a href=\"#narrow/channel/287929-mathlib4/topic/reassoc_of.25.20misleading.20error/near/524678383\">said</a>:</p>\n<blockquote>\n<p>I appreciate the recent-ish movement to add more informative error messages</p>\n</blockquote>\n<p>Just to clarify this point, the recent change to <code>reassoc_of%</code> was not for the sake of changing the error messages, but to add isomorphism support.</p>\n<p>The way it works is that it tries both the isomorphism and morphism handlers, and if both handlers fail, it gives a somewhat generic error message. This can be improved, but I figured it was better to get isomorphism support sooner than to reengineer the PR to try to expose errors during construction.</p>\n<p>It's possible that what needs more work here isn't primarily the error, but getting this elaborator to postpone if it doesn't know the category yet. (Maybe it can work out the category from the expected type if it waits longer? Or maybe it could tolerate not finding instances by adding extra instance arguments?)</p>",
        "id": 524778877,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750278510
    },
    {
        "content": "<p>Roughly speaking, these errors are occurring in places where <code>rw</code> or <code>simp</code> could otherwise do the job, i.e. if you add <code>@[reassoc]</code> to the original lemma then the <code>rw</code> goes through. So in principle, the type information should be there; I don't know how to <em>communicate</em> it to <code>reassoc_of%</code>, but I'll take a look at it later today.</p>",
        "id": 524783217,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750280514
    },
    {
        "content": "<p>It looks like the issue is roughly that <code>reassoc_of%</code> uses <code>Term.elabTerm</code>, which for constants means to add in metavariables for each implicit argument.</p>\n<p>It could copy <code>rw</code>/<code>simp</code> and treat constants as a special case.</p>",
        "id": 524783416,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750280622
    },
    {
        "content": "<p>That might be a little strange for a term elaborator though...</p>",
        "id": 524783617,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750280694
    },
    {
        "content": "<p>Mm. It can't use one of the <code>mapFooTelescoping</code>s to just generate a quantified lemma?</p>",
        "id": 524783881,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750280817
    },
    {
        "content": "<p>Ah, I think I was thinking of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mapForallTelescope%27#doc\">docs#Lean.Meta.mapForallTelescope'</a></p>",
        "id": 524784033,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750280899
    },
    {
        "content": "<p>No, most uses of <code>reassoc_of%</code> are applied to a term, not a constant, so the elaborator has to be involved somehow.</p>",
        "id": 524784118,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750280947
    },
    {
        "content": "<p>The problem is that if you do <code>reassoc_of% Sigma.ι_desc</code>, then it's seeing <code>Sigma.ι_desc</code>, not <code>@Sigma.ι_desc</code>.</p>",
        "id": 524784212,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750281000
    },
    {
        "content": "<p>I suppose this does suggest a workaround for you: have you tried putting <code>@</code> in front of this lemma?</p>",
        "id": 524784247,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750281012
    },
    {
        "content": "<p>... Ahhhh. I see now. Interesting.</p>\n<p>Lemme try the <code>@</code>.</p>",
        "id": 524784297,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750281042
    },
    {
        "content": "<p>Just tried it, it works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">desc</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">reassoc_of</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Sigma</span><span class=\"bp\">.</span><span class=\"n\">ι_desc</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 524784310,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750281054
    },
    {
        "content": "<p>I think another approach here would be to modify these handlers to not use <code>mkAppM</code>, but rather some elaborator functions (and possibly also to wrap <code>elabTerm</code> in <code>withSynthesizeLight</code>)</p>",
        "id": 524784445,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750281135
    },
    {
        "content": "<p>Beat me to it. Given that I do ultimately agree that the 'correct' final solution for PRs should be \"just apply <code>@[reassoc]</code> at the source whenever possible\", I think it's probably fine if the solution looks like:</p>\n<ul>\n<li>Check to see if the error is because the target actually isn't a relation of morphisms/isomorphisms, or because of synthesis failure/unbound metavariables<ul>\n<li>Even if the term given is the body of an function with un-solved-for implicits, the body should still match against <code>Quiver.Hom _ _</code> or <code>Iso _ _</code> right?</li>\n</ul>\n</li>\n<li>If it's because of unbound metavariables, then say so and suggest prepending <code>@</code>, otherwise use the current error.</li>\n</ul>\n<p>But I certainly won't say no to a more sophisticated elaboration handler!</p>",
        "id": 524784891,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1750281394
    },
    {
        "content": "<p>Right now it's relying on <code>mkAppM</code> to do the defeq check you mention, but the big problem with using <code>mkAppM</code> is that it insists on synthesizing the Category theory instance itself, but it's in MetaM, so it has no concept of deferring synthesis.</p>\n<p>It would certainly help though if the handlers were broken into two phases, one to check if it should commit to applying, and another to build the proof. These are lumped into one step, which means any failure anywhere causes it to move on to the next handler.</p>",
        "id": 524785805,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750281923
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26130\">#26130</a> implements a new elaboration scheme, and it makes the MWE work.</p>\n<p>Haven't waited to see if all of mathlib builds yet though.</p>",
        "id": 524815836,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750309336
    }
]