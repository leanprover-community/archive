[
    {
        "content": "<p><a href=\"/user_uploads/3121/4KviBHqlrosgxMtnWzmopJUS/JordanSub.lean\">JordanSub.lean</a><br>\nHi, <br>\nI'm an associate professor in CS/Stats, and in my recent journey to learn Lean, I've develop a small contribution that links the sub of two positive measures to the Jordan decomposition of the sub of the associated signed measure. The file is attached. Before going on with the pull request process, I'd like to see if the contribution is worth the trouble. If so, I'd be interested in feedback on the contribution as well.</p>\n<p>Best,<br>\nLoïc</p>",
        "id": 509010986,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743329039
    },
    {
        "content": "<p>It's <em>much</em> easier to even give a first opinion if you just push a branch somewhere, rather than attach a file.</p>",
        "id": 509073933,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1743377042
    },
    {
        "content": "<p>The (edit) non-terminal <code>simp</code>s won't be allowed in mathlib but in general this looks promising to me (although I'm not an expert in the area, maybe experts will have reasons why this work should be done in another way)</p>",
        "id": 509225909,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743433136
    },
    {
        "content": "<p>Non-terminal, you mean, I imagine</p>",
        "id": 509226645,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1743433258
    },
    {
        "content": "<p>I started lean proving last week, so I m not sure what you mean by non terminal simp edit. Is it the same as simp squeezing?</p>",
        "id": 509243465,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743436836
    },
    {
        "content": "<p>Yes, <code>simp</code> followed by more tactics is strongly discouraged in mathlib because as simp changes over time (i.e. gets better) these proofs can break and can be hard to fix. If <code>simp</code> isn't the last line in a proof, then please squeeze it!</p>",
        "id": 509243958,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743436933
    },
    {
        "content": "<p>Ah nice, I was meaning to get around to this recently. I'll have a look when I get in front of a computer.</p>",
        "id": 509246031,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1743437382
    },
    {
        "content": "<p>I pushed a branch called DrLSimon_JordanSub if that's more convenient.</p>",
        "id": 509247325,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743437630
    },
    {
        "content": "<p>So just to be sure, the good practice is to:</p>\n<ul>\n<li>squeeze non terminal simps</li>\n<li>not squeeze terminal ones<br>\nAlso a simp is considered terminal if it's the last line or is followed by exact, right?</li>\n</ul>",
        "id": 509248179,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743437802
    },
    {
        "content": "<p>it's not terminal when it's followed by exact</p>",
        "id": 509250402,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743438255
    },
    {
        "content": "<p>as <a href=\"https://leanprover-community.github.io/contribute/style.html#squeezing-simp-calls\">#style</a> says, it's terminal when it closes the goal or is only followed by \"flexible\" tactics, but <code>exact</code> is not a flexible tactic</p>",
        "id": 509250878,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743438375
    },
    {
        "content": "<p>Ok, thanks,  I may have read the guidelines backward. I'll check that more carefully tomorrow.</p>",
        "id": 509251939,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743438675
    },
    {
        "content": "<p>Back to the squeeze issue. I think I get the point now, but just to be sure I'd like to check on a couple of examples.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sub_zero</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_def</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">le_antisymm</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_zero</span><span class=\"o\">]</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">sInf_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_zero</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Should be changed to (by squeezing the first simp, but not the second one)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">sub_zero</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sub_def</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">le_antisymm</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_zero</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">--squeeze</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">sInf_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">add_zero</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- should remain unsqueezed</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">toSignedMeasure_le_iff</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">toSignedMeasure</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"bp\">.</span><span class=\"n\">toSignedMeasure</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">hA</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">toSignedMeasure_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hA</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">measure_ne_top</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"bp\">.</span><span class=\"n\">toReal_le_toReal</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<p>Should be changed to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">toSignedMeasure_le_iff</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">μ</span><span class=\"bp\">.</span><span class=\"n\">toSignedMeasure</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ν</span><span class=\"bp\">.</span><span class=\"n\">toSignedMeasure</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">hA</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">toSignedMeasure_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hA</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">↓</span><span class=\"n\">reduceIte</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ne_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">measure_ne_top</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">not_false_eq_true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"bp\">.</span><span class=\"n\">toReal_le_toReal</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- squeezed</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">A</span>\n</code></pre></div>\n<p>The next one is less clear to me:</p>\n<div class=\"codehilite\" data-code-language=\"lemma\"><pre><span></span><code>    ∃ s : Set α, SignedMeasure.SetWhereGe μ ν s := by\n  obtain ⟨s, hs, h₂, h₃⟩ := (μ.toSignedMeasure - ν.toSignedMeasure).exists_compl_positive_negative\n  simp at h₂ h₃ -- should this one be squeezed ?\n  exact ⟨s, hs, h₂, h₃⟩\n</code></pre></div>\n<p>BTW, I read the guidelines again but it's mainly focusing on \"not squeezing\" terminal simps.  I can't find any recommendation to squeeze non terminal ones. I guess, it's going to become part of the guidelines soon, but just in case, I preferred to report it.</p>",
        "id": 509386266,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743495029
    },
    {
        "content": "<p>Often simp followed by <code>exact mylemma</code> can be turned into <code>simpa using mylemma</code>: that's another option here.</p>",
        "id": 509528282,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743534500
    },
    {
        "content": "<p>I agree with your assessment if the first two examples.</p>",
        "id": 509528374,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743534542
    },
    {
        "content": "<p>The third question: a <code>simp at foo</code> can be non-terminal also. I'm not 100% sure about this particular case. What does mathlib's flexible linter say? Write <code>set_option linter.flexible true</code> before the theorem to enable it.</p>",
        "id": 509529165,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743534837
    },
    {
        "content": "<p>(That linter is not enabled in mathlib as there were about 200 instances in mathlib which didn't have a nice obvious fix. So mathlib may be slightly inconsistent about such non-terminal simps.)</p>",
        "id": 509529510,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743534947
    },
    {
        "content": "<p>Non-terminal simps not mentioned: in my opinion, that's a bug. Can you share which particular document you were looking at? Then we can fix that :-)</p>",
        "id": 509529728,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743535038
    },
    {
        "content": "<p>Thanks, </p>\n<p>Concerning the guidelines, I was referring to <a href=\"https://leanprover-community.github.io/contribute/style.html#squeezing-simp-calls\">https://leanprover-community.github.io/contribute/style.html#squeezing-simp-calls</a>. As far as I understood when reading the relevant part, it clearly implied that terminal simps should not be squeeze. But I can't see any guidelines to make sure that non-terminal simps are squeezed.</p>\n<p>W.r.t the <code>simp at foo</code> matter the flexible linter reports:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">'</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h₂</span><span class=\"w\"> </span><span class=\"n\">h₃'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">flexible</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">modifying</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">h₃'</span><span class=\"bp\">…</span>\n<span class=\"n\">note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">disabled</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">flexible</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>If I squeeze it the warning disappears, so I guess, it should be squeezed.</p>",
        "id": 509541151,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743538997
    },
    {
        "content": "<p>Yes, it's discussed <a href=\"https://leanprover-community.github.io/extras/simp.html#non-terminal-simps\">here</a> on the Simplifier page</p>",
        "id": 509646356,
        "sender_full_name": "Vlad Tsyrklevich",
        "timestamp": 1743586378
    },
    {
        "content": "<p>May be that needs to be touched on, in the style guidelines as well.</p>",
        "id": 509782404,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743623800
    },
    {
        "content": "<p>The statement for the simp lemma <code>toSignedMeasure_le_iff</code> should be swapped to <code>μ.toSignedMeasure ≤ ν.toSignedMeasure ↔ μ ≤ ν</code> since simp will change the LHS to the RHS.</p>",
        "id": 509891436,
        "sender_full_name": "Kexing Ying",
        "timestamp": 1743673598
    },
    {
        "content": "<p>Ok, I'll fix that. Thank you.</p>",
        "id": 509970277,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1743693617
    },
    {
        "content": "<p>Dear all,</p>\n<p>Not sure if it's temporary or not, but I don't seem to have write access on my branch anymore. The branch is named <a href=\"https://github.com/leanprover-community/mathlib4/tree/DrLSimon_JordanSub\">DrLSimon_JordanSub</a> and I have an ongoing PR on it <a href=\"https://github.com/leanprover-community/mathlib4/pull/23500\">#23500</a>. </p>\n<p>Best,<br>\nLoïc</p>",
        "id": 523732373,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1749726349
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"893748\">Loïc Simon</span> <a href=\"#narrow/stream/287929-mathlib4/topic/First.20contribution.3A.20MeasureTheory.2FDecomposition.2FJordanSub/near/523732373\">said</a>:</p>\n<blockquote>\n<p>Dear all,</p>\n<p>Not sure if it's temporary or not, but I don't seem to have write access on my branch anymore. The branch is named <a href=\"https://github.com/leanprover-community/mathlib4/tree/DrLSimon_JordanSub\">DrLSimon_JordanSub</a> and I have an ongoing PR on it <a href=\"https://github.com/leanprover-community/mathlib4/pull/23500\">#23500</a>. </p>\n<p>Best,<br>\nLoïc</p>\n</blockquote>\n<p>Please read <a href=\"#narrow/stream/287929-mathlib4/topic/all.20future.20PRs.20should.20be.20made.20from.20forks\">https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/all.20future.20PRs.20should.20be.20made.20from.20forks</a> that explains the situation.</p>",
        "id": 523733984,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1749726977
    },
    {
        "content": "<p>I don't think that is intended to apply here, that's about <strong>future</strong> PRs</p>",
        "id": 523756839,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749734731
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/First.20contribution.3A.20MeasureTheory.2FDecomposition.2FJordanSub/near/523756839\">said</a>:</p>\n<blockquote>\n<p>I don't think that is intended to apply here, that's about <strong>future</strong> PRs</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/all.20future.20PRs.20should.20be.20made.20from.20forks/near/523670016\">said</a>:</p>\n<blockquote>\n<p>We will shortly begin removing write access to the repository from contributors.</p>\n</blockquote>",
        "id": 523757003,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749734782
    },
    {
        "content": "<p>We are discussing this; indeed some access was removed (e.g. users who asked access and never committed), but this removal may be accidental</p>",
        "id": 523758635,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749735290
    },
    {
        "content": "<p>I think it accidental but not sure yet.</p>",
        "id": 523758995,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1749735407
    },
    {
        "content": "<p>I hope it's accidental. The PR was very close to being merged (at least to my understanding). </p>\n<p>I don't mean to argue but it's a bit ironic that the <a href=\"https://leanprover-community.github.io/contribute/index.html\">official guidelines</a> still recommends to contribute directly on the official repo instead of relying on a fork. I guess the guideline will be updated, but still.</p>",
        "id": 523760869,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1749735962
    },
    {
        "content": "<p>I've received a new invitation to get the write access back. Thank you !</p>",
        "id": 523792480,
        "sender_full_name": "Loïc Simon",
        "timestamp": 1749745494
    }
]