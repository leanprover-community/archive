[
    {
        "content": "<p>I think that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">push_neg</span><span class=\"bp\">.</span><span class=\"n\">use_distrib</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"n\">push_neg</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>is an unintended corner case where the <code>use_distrib</code> option should not have any effect. This didn’t happen in Lean 3 because bounded existential were encoded differently. I suspect not many people care about this option. Maybe <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span>? But I thought I would ask here before working on a fix anyway.</p>",
        "id": 491447937,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735684529
    },
    {
        "content": "<p>What would you expect the effect on <code> ∃ x, x ∈ s ∧ x ∈ t</code> to be? I think for the effect you want, we need the <code>exists</code> elaborator to record using <code>Expr.mdata</code> when an <code>And</code> was generated from a binder</p>",
        "id": 491461956,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735698432
    },
    {
        "content": "<p>... or revert to the lean 3 design that encoded this by using an inner <code>Exists</code></p>",
        "id": 491462033,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735698504
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/push_neg.2Euse_distrib.20in.20bounded.20existential/near/491461956\">said</a>:</p>\n<blockquote>\n<p>What would you expect the effect on <code> ∃ x, x ∈ s ∧ x ∈ t</code> to be? I think for the effect you want, we need the <code>exists</code> elaborator to record using <code>Expr.mdata</code> when an <code>And</code> was generated from a binder</p>\n</blockquote>\n<p>I’ll be happy with negating it to <code>∀ x ∈ s, x ∉ t</code>. And really I’m not looking a super tight answer, this is purely for teaching purposes where the situation that arise are almost entirely under my control.</p>",
        "id": 491505882,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735743399
    },
    {
        "content": "<p>One thing I noticed again recently is how <code>push_neg</code> handles negations of <code>And</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">push_neg</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"c1\">-- `P → ¬ Q` instead of `¬ P ∨ ¬ Q`</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>\n<p>Which is not what my students were expecting after I taught them De Morgan.</p>\n<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> Do you have a particular reason for moving to the implication (and breaking symmetry a bit)?</p>",
        "id": 491582352,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735809380
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>, that behavior is what <code>set_option push_neg.use_distrib true</code> changes</p>",
        "id": 491585590,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735811184
    },
    {
        "content": "<p>Yes, this is precisely the topic of this discussion. And I didn’t change that. I think Yury did, if I remember correctly.</p>",
        "id": 491587252,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735812146
    },
    {
        "content": "<p><code>push_neg</code> started as a teaching tactic and was clearly implementing de Morgan laws. But then people started to find it useful for Mathlib itself and switched to the new behavior. Then I protested that it made it less useful for teaching and the option was introduced.</p>",
        "id": 491587341,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735812218
    },
    {
        "content": "<p>Aaah, I didn't realize that this was also in scope of <code>use_distrib</code>!<br>\nAll the talk about existentials made me think it was only about that.</p>",
        "id": 491590604,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735813960
    },
    {
        "content": "<p>Do you think we could have <code>push_neg +distrib</code>?</p>",
        "id": 491590684,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735814005
    },
    {
        "content": "<p>It’s exactly the same thing. Negating <code>∃ x &gt; 0, P x</code> brings you to negating <code>x &gt; 0 ∧ P x</code>.</p>",
        "id": 491591382,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735814344
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/push_neg.2Euse_distrib.20in.20bounded.20existential/near/491590684\">said</a>:</p>\n<blockquote>\n<p>Do you think we could have <code>push_neg +distrib</code>?</p>\n</blockquote>\n<p>Yes, we could definitely have that. But I don’t really care because I want to take that decision on behalf of my students, and hide it (it’s obviously hidden in Verbose Lean, but you can also choose to hide it using almost vanilla tactics).</p>",
        "id": 491591569,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735814447
    }
]