[
    {
        "content": "<p>I'm getting the following deprecation warning in FLT:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>`Submodule.Quotient.nontrivial_of_lt_top` has been deprecated: Use `Submodule.nontrivial_iff` instead\n\nNote: The updated constant has a different type:\n  âˆ€ (R : Type u_1) {M : Type u_3} [inst : Semiring R] [inst_1 : AddCommMonoid M] [inst_2 : Module R M],\n    Nontrivial (Submodule R M) â†” Nontrivial M\ninstead of\n  âˆ€ {R : Type u_1} {M : Type u_2} [inst : Ring R] [inst_1 : AddCommGroup M] [inst_2 : Module R M] {p : Submodule R M},\n    p &lt; âŠ¤ â†’ Nontrivial (M â§¸ p)\n</code></pre></div>\n<p>That result seems to be rather different -- how exactly am I supposed to say <code>apply Submodule.Quotient.nontrivial_of_lt_top</code> now? If my goal is <code>Nontrivial (M â§¸ p)</code> and I <code>rw [\\l Submodule.nontrivial_iff]</code> then I have <code>Nontrivial (Submodule R (M / p))</code><br>\nand in some sense I feel further away from <code>p &lt; âŠ¤</code> not nearer. Am I missing a trick? Why was this deprecated? Can I petition for adding it back?</p>",
        "id": 560379280,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764160556
    },
    {
        "content": "<p>I am also confused about this, since the lemma <code>Submodule.Quotient.nontrivial_of_ne_top</code> I added has also been deprecated.</p>",
        "id": 560381387,
        "sender_full_name": "Nailin Guan",
        "timestamp": 1764161190
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/0fecc98248f62972b3fc32f83e1966c657fbb658/Mathlib/LinearAlgebra/Quotient/Basic.lean#L86-L90\">https://github.com/leanprover-community/mathlib4/blob/0fecc98248f62972b3fc32f83e1966c657fbb658/Mathlib/LinearAlgebra/Quotient/Basic.lean#L86-L90</a></p>",
        "id": 560381687,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764161281
    },
    {
        "content": "<p>The lemma still has a 3 line proof in Mathlib. So I'm not sure it should have been deprecated.</p>",
        "id": 560381748,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764161302
    },
    {
        "content": "<p>Aha! <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> try <code>Submodule.Quotient.nontrivial_iff</code></p>",
        "id": 560381917,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764161361
    },
    {
        "content": "<p>I think <code>@[deprecated]</code> is not picking up the correct <code>nontrivial_iff</code>.<br>\ncc <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span></p>",
        "id": 560382015,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764161391
    },
    {
        "content": "<p>Thanks for the ping!  I'm not really sure what else to do, other than qualifying fully the lemma.  Also, I think that <code>deprecated</code> is in core, so any possible warning would likely come from there.</p>",
        "id": 560382599,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1764161600
    },
    {
        "content": "<p>It seems like <code>nontrivial_iff</code> might be ambiguous at the file location. If so, I think Lean should warn about that.</p>",
        "id": 560383204,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764161768
    },
    {
        "content": "<p>Aha! Let me add this to <a href=\"https://github.com/leanprover-community/mathlib4/pull/32137\">#32137</a> ! It's another deprecation glitch in <a href=\"https://github.com/leanprover-community/mathlib4/pull/31198\">#31198</a> .</p>",
        "id": 560383382,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764161816
    },
    {
        "content": "<p><del>@<strong>Kim Morrison</strong> Is this worth an issue on the core repo?</del></p>\n<p>Edit: nope, see <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Submodule.2EQuotient.2Enontrivial_of_lt_top/near/560403991\">#mathlib4 &gt; Submodule.Quotient.nontrivial_of_lt_top @ ðŸ’¬</a></p>",
        "id": 560383496,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764161840
    },
    {
        "content": "<p>Ah, sorry, I only realised now that the deprecations were generated by my script!  <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>\n<p>I'll have a think of how to improve this, but it probably involves a rewriting of the script in lean.</p>",
        "id": 560384114,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1764161993
    },
    {
        "content": "<p>Ok so in total I found three deprecation issues in <a href=\"https://github.com/leanprover-community/mathlib4/pull/31198\">#31198</a> and I think I've fixed them all in <a href=\"https://github.com/leanprover-community/mathlib4/pull/32137\">#32137</a>.</p>",
        "id": 560385794,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764162452
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>, the deprecation is indeed broken, but you could have spared yourself going on Zulip by reviewing <a href=\"https://github.com/leanprover-community/CFT/pull/119\">CFT#119</a> instead</p>",
        "id": 560391061,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764163994
    },
    {
        "content": "<p>But then we wouldn't have learned about this bug in <code>@[deprecated]</code></p>",
        "id": 560391709,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764164162
    },
    {
        "content": "<p>Yes, I'm just afraid that Kevin is once again trying to fix issues I've already solved for him <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 560392163,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764164298
    },
    {
        "content": "<p>Is <code>deprecated</code> just using the same routine that Lean normally resolves name(space)s? Does <code>#check nontrivial_iff</code> return <code>Submodule.nontrivial_iff</code>? Why not <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=nontrivial_iff%3F#doc\">docs#nontrivial_iff?</a></p>",
        "id": 560392747,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764164445
    },
    {
        "content": "<p>Yes I did things in a suboptimal order -- I just reviewed your (Yael's) class field theory bump (which showed how to deal with precisely the changes which had confused me in the FLT bump) and smiled to myself when I realised what had happened :-)</p>\n<p>But how come you didn't notice the errors with deprecations yourself?</p>",
        "id": 560401275,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764166612
    },
    {
        "content": "<p>Oh, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/LinearAlgebra/Quotient/Basic.html#Submodule.Quotient.nontrivial_iff\">Submodule.Quotient.nontrivial_iff</a> is protected, so it's correct behavior that it doesn't get picked up. <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Module/Submodule/Lattice.html#Submodule.nontrivial_iff\">Submodule.nontrivial_iff</a> is not protected (it should probably be) so it gets picked up. So there's no Lean bug, only human error adding the deprecation.</p>",
        "id": 560403991,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764167239
    },
    {
        "content": "<p>Wow, thanks for investigating! Good to know</p>",
        "id": 560404885,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764167425
    },
    {
        "content": "<p>I should say that these errors are pretty hard to pick up in e.g. review. This is not the first one I've fixed when I've bumped FLT and found that something which was supposed to be deprecated hadn't been. Both times my first reaction was \"grr, someone forgot to deprecate\" but on both occasions the truth was that someone had tried and failed to deprecate (or had deprecated incorrectly) because of a namespace issue. We saw both instances of what can go wrong in <a href=\"https://github.com/leanprover-community/mathlib4/pull/32137\">#32137</a> : if you do the deprecation at the site of the new lemma then you might get the namespace of the old lemma wrong, and if you do it at the site of the old lemma then you might get the namespace of the new lemma wrong (although in this case it was because of a <code>protected</code> issue).</p>",
        "id": 560404978,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764167450
    },
    {
        "content": "<p>It seems also pretty tricky to think of what test could be performed automatically, as often, the deprecation points to a lemma that is different from the one being deprecated.</p>",
        "id": 560406070,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1764167724
    },
    {
        "content": "<p>Maybe within mathlib, we can enforce that the lemma to which the deprecation points is always fully qualified and in the same file?</p>",
        "id": 560406604,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1764167870
    },
    {
        "content": "<p>I think this is where better declaration diff can help in review <a href=\"#narrow/channel/287929-mathlib4/topic/.22Declarations.20diff.22.20for.20PR.20emails.20misses.20namespaces.3F/with/537749453\">https://leanprover.zulipchat.com/#narrow/channel/287929-mathlib4/topic/.22Declarations.20diff.22.20for.20PR.20emails.20misses.20namespaces.3F/with/537749453</a></p>",
        "id": 560409068,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1764168547
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Submodule.2EQuotient.2Enontrivial_of_lt_top/near/560406070\">said</a>:</p>\n<blockquote>\n<p>It seems also pretty tricky to think of what test could be performed automatically, as often, the deprecation points to a lemma that is different from the one being deprecated.</p>\n</blockquote>\n<p>Well, if we had type-aware diffs, presumably we'd see that the type of deprecated lemma changed unexpectedly</p>",
        "id": 560427705,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1764173174
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873350\">Weiyi Wang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Submodule.2EQuotient.2Enontrivial_of_lt_top/near/560409068\">said</a>:</p>\n<blockquote>\n<p>I think this is where better declaration diff can help in review <a href=\"#narrow/channel/287929-mathlib4/topic/.22Declarations.20diff.22.20for.20PR.20emails.20misses.20namespaces.3F/with/537749453\">https://leanprover.zulipchat.com/#narrow/channel/287929-mathlib4/topic/.22Declarations.20diff.22.20for.20PR.20emails.20misses.20namespaces.3F/with/537749453</a></p>\n</blockquote>\n<p>My understanding is that this tool (because it's not written in Lean) doesn't know which namespace you're in, so might struggle to flag these issues. For example the declaration diff in <a href=\"https://github.com/leanprover-community/mathlib4/pull/31198\">#31198</a> doesn't report that <code>Submodule.subsingleton_quotient_iff_eq_top</code> was removed and <code>Submodule.Quotient.subsingleton_quotient_iff_eq_top</code> was added (and immediately deprecated), because it didn't notice.</p>",
        "id": 560439190,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764176361
    }
]