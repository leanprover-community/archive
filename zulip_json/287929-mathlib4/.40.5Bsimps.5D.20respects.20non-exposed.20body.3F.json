[
    {
        "content": "<p>Currently if you use <code>@[simps]</code> on a definition that is not already <code>@[expose]</code>d, you get an error message like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Theorem</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">leftDualFunctor_obj</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"ss\">`rfl</span><span class=\"bp\">`-</span><span class=\"n\">proof</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">thus</span><span class=\"w\"> </span><span class=\"n\">inferred</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"kd\">@[</span><span class=\"n\">defeq</span><span class=\"kd\">]</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">validating</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Not</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">definitional</span><span class=\"w\"> </span><span class=\"n\">equality</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">leftDualFunctor</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"w\">  </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">definitionally</span><span class=\"w\"> </span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">unmop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"bp\">ᘁ</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"w\">  </span><span class=\"n\">Note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">exported</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">requires</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">definitions</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">prove</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">must</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">exposed</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>How about we change the behaviour of <code>simps</code>, so it checks if the body is not exposed, and if so, uses <code>(rfl)</code> proofs instead of <code>rfl</code>, to avoid the <code>@[defeq]</code> label?</p>",
        "id": 564163123,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765938621
    },
    {
        "content": "<p>I've implemented this: <a href=\"https://github.com/leanprover-community/mathlib4/pull/32989\">https://github.com/leanprover-community/mathlib4/pull/32989</a></p>\n<p>The fix checks whether the source definition's body is exposed before calling <code>inferDefEqAttr</code>. If not exposed, we skip the <code>@[defeq]</code> inference entirely.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">bodyExposed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">setExporting</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">find</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"n\">cfg.srcDeclName</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">hasValue</span><span class=\"o\">)</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">bodyExposed</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"n\">inferDefEqAttr</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n</code></pre></div>",
        "id": 564167192,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765942445
    },
    {
        "content": "<p>I'm not entirely sure we <em>want</em> to do this, but it's at least nice to know that it is straightforward to implement.</p>",
        "id": 564167271,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1765942502
    }
]