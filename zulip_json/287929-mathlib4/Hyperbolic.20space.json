[
    {
        "content": "<p>In an experiment to see if I could use the lovely work of <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> <span class=\"user-mention\" data-user-id=\"110050\">@S√©bastien Gou√´zel</span> and others to say something about hyperbolic space, I came up with the following (for the two-dimensional case):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Analysis.Complex.UpperhalfPlane.Metric</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Geometry.Manifold.Riemannian.Basic</span>\n<span class=\"c1\">-- import Mathlib.Geometry.Manifold.Riemannian.PathELength</span>\n<span class=\"c1\">-- import Mathlib.Geometry.Manifold.VectorBundle.Tangent</span>\n\n<span class=\"kd\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Bundle</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">scoped</span><span class=\"w\"> </span><span class=\"n\">ContDiff</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kd\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"ùìò‚Ñç\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">modelWithCornersSelf</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kd\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"T‚Ñç\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">TangentSpace</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ChartedSpace</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isOpenEmbedding_coe.toPartialHomeomorph.singletonChartedSpace</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsManifold</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isOpenEmbedding_coe.toPartialHomeomorph.isManifold_singleton</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">riemannianMetric</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RiemannianMetric</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">x.im</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">innerSL</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- TODO Do this without defeq abuse</span>\n<span class=\"w\">  </span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">continuousAt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">isVonNBounded</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RiemannianBundle</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">‚ü®</span><span class=\"n\">riemannianMetric</span><span class=\"o\">‚ü©</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsRiemannianManifold</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"o\">‚ü®</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">_</span><span class=\"o\">‚ü©</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">edist_dist</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dist_eq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Argue that length-minimising arcs are subsets of lines / circles perpendicular to real line.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Should be possible by arguing these are preserved by `SL(2, ‚Ñù)` action which we know is</span>\n<span class=\"w\">  </span><span class=\"c1\">-- isometric thanks to `UpperHalfPlane.instIsIsometricSMulSpecialLinearGroupFinOfNatNatReal`</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- After a long wait (~105 seconds on my fast MacBook) this says `(kernel) deterministic timeout`</span>\n<span class=\"c1\">-- instance : IsContMDiffRiemannianBundle ùìò‚Ñç ‚àû ‚ÑÇ T‚Ñç := sorry</span>\n\n<span class=\"kd\">end</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n</code></pre></div>",
        "id": 533293287,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1754573310
    },
    {
        "content": "<p>I have three questions:</p>\n<ol>\n<li>What is the right way to avoid the defeq abuse in <code>riemannianMetric</code>. I was quite surprised that I could not find (the general version of) <code>example (x : ‚Ñç) : T‚Ñç x ‚âÉL[‚Ñù] ‚ÑÇ := sorry</code> in the library.</li>\n<li>If I uncomment the last statement <code>instance : IsContMDiffRiemannianBundle ùìò‚Ñç ‚àû ‚ÑÇ T‚Ñç := sorry</code> then as I remark in the comment, Lean pegs a CPU at 100% for nearly two minutes and then just says <code>(kernel) deterministic timeout</code>. Am I doing something wrong?</li>\n<li>Does anyone want to try to prove the non-trivial <code>sorry</code>?</li>\n</ol>",
        "id": 533293805,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1754573465
    },
    {
        "content": "<p>I may be interested in some of (3) --- but let me finish proving the existence of Riemannian metrics first. :-)</p>",
        "id": 533294787,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754573769
    },
    {
        "content": "<p>For (1), I suspect the proper generality is proving</p>\n<ul>\n<li><code>‚Ñç</code> is an open subset of <code>‚ÑÇ</code>, hence <code>T‚Ñç‚âÉL[‚Ñù] T‚ÑÇ</code></li>\n<li>there's an isomorphism <code>Tùïú ‚âÉL[ùïú] ùïú</code> for any nontrivially normed field <code>ùïú</code></li>\n</ul>\n<p>and then composing these isomorphisms.<br>\nPatrick and I have the second one on our big branch; I could PR that soon. I'm really surprised that the first one is missing.</p>",
        "id": 533416185,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754640197
    },
    {
        "content": "<p>For (2): what happens when you upgrade your sorry about to a <code>ContMDiffRiemannianMetric</code>?</p>",
        "id": 533417101,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754640575
    },
    {
        "content": "<p>Update: that helps; here's my version</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">UpperHalfPlane</span><span class=\"bp\">.</span><span class=\"n\">Metric</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Geometry</span><span class=\"bp\">.</span><span class=\"n\">Manifold</span><span class=\"bp\">.</span><span class=\"n\">Riemannian</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Geometry</span><span class=\"bp\">.</span><span class=\"n\">Manifold</span><span class=\"bp\">.</span><span class=\"n\">VectorBundle</span><span class=\"bp\">.</span><span class=\"n\">Riemannian</span>\n<span class=\"c1\">-- import Mathlib.Geometry.Manifold.Riemannian.PathELength</span>\n<span class=\"c1\">-- import Mathlib.Geometry.Manifold.VectorBundle.Tangent</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Bundle</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">ContDiff</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"ùìò‚Ñç\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">modelWithCornersSelf</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"T‚Ñç\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">TangentSpace</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ChartedSpace</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isOpenEmbedding_coe</span><span class=\"bp\">.</span><span class=\"n\">toPartialHomeomorph</span><span class=\"bp\">.</span><span class=\"n\">singletonChartedSpace</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsManifold</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isOpenEmbedding_coe</span><span class=\"bp\">.</span><span class=\"n\">toPartialHomeomorph</span><span class=\"bp\">.</span><span class=\"n\">isManifold_singleton</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">riemannianMetric</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ContMDiffRiemannianMetric</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">inner</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">im</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">innerSL</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- TODO Do this without defeq abuse</span>\n<span class=\"w\">  </span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">pos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">isVonNBounded</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">contMDiff</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RiemannianBundle</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">riemannianMetric</span><span class=\"bp\">.</span><span class=\"n\">toRiemannianMetric</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsRiemannianManifold</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">?_‚ü©</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">edist_dist</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">dist_eq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Argue that length-minimising arcs are subsets of lines / circles perpendicular to real line.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Should be possible by arguing these are preserved by `SL(2, ‚Ñù)` action which we know is</span>\n<span class=\"w\">  </span><span class=\"c1\">-- isometric thanks to `UpperHalfPlane.instIsIsometricSMulSpecialLinearGroupFinOfNatNatReal`</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">IsContMDiffRiemannianBundle</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"c1\">-- is really fast</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsContMDiffRiemannianBundle</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span><span class=\"w\"> </span><span class=\"c1\">-- is slow</span>\n<span class=\"c1\">-- After a long wait (~105 seconds on my fast MacBook) this says `(kernel) deterministic timeout`</span>\n<span class=\"c1\">--instance : IsContMDiffRiemannianBundle ùìò‚Ñç ‚àû ‚ÑÇ T‚Ñç := sorry</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n</code></pre></div>",
        "id": 533418264,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754640988
    },
    {
        "content": "<p>So, Lean can infer the instance just fine --- but putting a new instance is really slow. I have no idea why, but would be very interested in explanations!</p>",
        "id": 533418325,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754641015
    },
    {
        "content": "<p>For 1, I'd say the defeq abuse is here to be abused -- in paper maths, you would write things exactly as you did here.</p>\n<p>For 2, you are doing things perfectly right, and there is something fishy going on. I tried to investigate a little bit, but I couldn't understand what is wrong for now.</p>",
        "id": 533428959,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1754644940
    },
    {
        "content": "<p>About (2): since you're never stating continuity/smoothness of your metric, there's no way <code>#synth IsContMDiffRiemannianBundle ùìò‚Ñç ‚àû ‚ÑÇ T‚Ñç</code> can succeed. So, strengthening the statement still feels right to me.</p>",
        "id": 533433471,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754646840
    },
    {
        "content": "<p>I don't think Lean should take so long to fail, though: that is definitely not good.</p>",
        "id": 533433500,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754646851
    },
    {
        "content": "<p>Yes, for (2) I was talking about <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span>'s version, where the metric is defined as a <code>ContMDiffRiemannianMetric</code>.</p>",
        "id": 533435961,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1754647962
    },
    {
        "content": "<p>Somewhat minimized, still not there:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Bundle</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">ContDiff</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"ùìò‚Ñç\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">modelWithCornersSelf</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span>\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"T‚Ñç\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">TangentSpace</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsManifold</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isOpenEmbedding_coe</span><span class=\"bp\">.</span><span class=\"n\">toPartialHomeomorph</span><span class=\"bp\">.</span><span class=\"n\">isManifold_singleton</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"n\">irreducible_def</span><span class=\"w\"> </span><span class=\"n\">riemannianMetric</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ContMDiffRiemannianMetric</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"bp\">‚àû</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">works</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorBundle</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">TangentSpace</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RiemannianBundle</span><span class=\"w\"> </span><span class=\"n\">T‚Ñç</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">riemannianMetric</span><span class=\"bp\">.</span><span class=\"n\">toRiemannianMetric</span><span class=\"bp\">‚ü©</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">doesntwork</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">VectorBundle</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">TangentSpace</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 533464131,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1754659576
    },
    {
        "content": "<p>Interesting, thanks for minimising! Is the upper half plane important for this example (or would e.g. working with C itself also work)?</p>",
        "id": 533464652,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754659759
    },
    {
        "content": "<p>Thank you both for corrections and investigations!</p>",
        "id": 533490502,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1754669268
    },
    {
        "content": "<p>ok, I found it.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Bundle</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">ContDiff</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"w\"> </span><span class=\"n\">UpperHalfPlane</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"ùìò‚Ñç\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">modelWithCornersSelf</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñç</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TangentSpace</span><span class=\"w\"> </span><span class=\"n\">ùìò‚Ñç</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n<span class=\"c\">/-</span><span class=\"cm\"> NormedAddCommGroup.toENormedAddCommMonoid.toAddCommMonoid : AddCommMonoid (TangentSpace ùìò‚Ñç x) -/</span>\n</code></pre></div>\n<p>Before any Riemannian stuff, the <code>AddCommMonoid</code> instance on the tangent space to <code>‚Ñç</code> is inferred from a normed space structure. So when one registers another normed space structure on the tangent space through the Riemannian bundle business, we have two conflicting instances, and boom. The thing is that, initially, there shouldn't be any normed space structure on the tangent space. And in fact there isn't: if you ask for <code>NormedAddCommGroup (TangentSpace ùìò‚Ñç x)</code>, it fails as it should. But still this non-existing instance is summoned out of nowhere to construct the <code>AddCommMonoid</code> instance. This is a bug in Lean4, <a href=\"https://github.com/leanprover/lean4/pull/9077\">lean4#9077</a> striking again.</p>\n<p>I could try to work around it by tweaking instances and so on, but I am afraid we will see it again and again, so I'm not sure it's worth it. Better fix it upstream, but <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> said on the issue that the bug won't be fixed. So I don't really know what to do, because I feel this bug should be really high-priority from the point of view of mathlib. Also, I don't know how much this is related to recent PRs by <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> to fix some issue in typeclass inference (where the implementation doesn't really match the specs). <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>, do you have an idea of how we could move forward on this?</p>",
        "id": 533494533,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1754670928
    },
    {
        "content": "<p>Another example of boom, more minimal than the one reported in the issue, but still depending on mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">myFoo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENormedAddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">myFoo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n</code></pre></div>\n<p><code>myFoo</code> is only endowed with a topological space instance, but it inherits the enormed structure from <code>‚ÑÇ</code>. </p>\n<p>Note that things are a little bit subtle here (and therefore hard to minimize) because, with <code>‚Ñù</code> instead of <code>‚ÑÇ</code>, the issue disappears.</p>",
        "id": 533502391,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1754674291
    },
    {
        "content": "<p>Has this been observed?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFoo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">myFoo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c1\">-- uncomment below to get a failing #synth</span>\n<span class=\"c1\">-- noncomputable instance : NormedAddCommGroup myFoo := by infer_instance</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">ENormedAddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">myFoo</span><span class=\"w\"> </span><span class=\"c1\">-- NormedAddCommGroup.toENormedAddCommMonoid</span>\n</code></pre></div>\n<p>I can guess why but this is not ideal behavior.</p>",
        "id": 533507341,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1754676569
    },
    {
        "content": "<p>is this <a href=\"https://github.com/leanprover/lean4/pull/9077\">lean4#9077</a> ?</p>",
        "id": 533510099,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1754678051
    },
    {
        "content": "<p>Another incarnation, yes</p>",
        "id": 533510159,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1754678083
    },
    {
        "content": "<p>I think a reasonable invariant of typeclass synthesis is that if it succeeds returning X.toY to get Y then it should also succeed for X.</p>",
        "id": 533510252,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1754678154
    },
    {
        "content": "<p>We want to take another look at this issue but until that has concluded, I can't speculate on the outcome</p>",
        "id": 533511221,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1754678709
    }
]