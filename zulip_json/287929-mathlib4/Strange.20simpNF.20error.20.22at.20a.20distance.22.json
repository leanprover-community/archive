[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21422\">#21422</a> adds two new classes to mathlib - and causes the simpNF linter to <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/13136630593/job/36653412322?pr=21422\">error</a> in a file far downstream, that is seemingly unrelated. The logs seem to indicate that simplifying the LHS of some lemma now times out, which makes the simpNF fail. That lemma looks completely unrelated to the area I'm modifying, though.</p>\n<p>Can anybody help me to even approach this problem - how would I even <em>start</em> to investigate?</p>",
        "id": 497687170,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1738681240
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LHS_of_the_lemma_that_simp_nf_times_out_on</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>",
        "id": 497687575,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1738681335
    },
    {
        "content": "<p>Thanks for the pointer! I tried this (on the relevant branch); it does not seem to yield useful information: putting </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">vanishingIdeal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">zeroLocus</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>at the end of <code>Mathlib/RingTheory/Nullstellensatz.lean</code> (i.e., the LHS of the lemma that times out in CI) yields</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">diag</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Diagnostics</span><span class=\"w\"> </span><span class=\"bp\">▼</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">reduction</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">156</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">reduction</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">instances</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">975</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">38</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">▼</span>\n<span class=\"w\">    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">toCommRing</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">975</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"bp\">.</span><span class=\"n\">toRing</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">912</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">toSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">717</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">CommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">657</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">EuclideanDomain</span><span class=\"bp\">.</span><span class=\"n\">toCommRing</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">550</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">toEuclideanDomain</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">550</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">484</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">NonUnitalSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">444</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"bp\">.</span><span class=\"n\">toNonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">404</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">NonAssocSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">400</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">NonUnitalNonAssocSemiring</span><span class=\"bp\">.</span><span class=\"n\">toAddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">366</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"bp\">.</span><span class=\"n\">toCommSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">349</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">toSemifield</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">342</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Semifield</span><span class=\"bp\">.</span><span class=\"n\">toCommSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">342</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">318</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">DivisionRing</span><span class=\"bp\">.</span><span class=\"n\">toRing</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">269</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">toAddZeroClass</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">88</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toZero</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">MulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toZero</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">NonUnitalNonAssocSemiring</span><span class=\"bp\">.</span><span class=\"n\">toMulZeroClass</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span><span class=\"bp\">.</span><span class=\"n\">toPreorder</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">84</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Preorder</span><span class=\"bp\">.</span><span class=\"n\">toLT</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">instUnion</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">toAddSemigroup</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddMonoidAlgebra</span><span class=\"bp\">.</span><span class=\"n\">commRing</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">35</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">instCommRingMvPolynomial</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">35</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddMonoidAlgebra</span><span class=\"bp\">.</span><span class=\"n\">nonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">34</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddMonoidAlgebra</span><span class=\"bp\">.</span><span class=\"n\">nonUnitalSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">34</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddMonoidAlgebra</span><span class=\"bp\">.</span><span class=\"n\">nonUnitalCommSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Lattice</span><span class=\"bp\">.</span><span class=\"n\">toSemilatticeSup</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">NonUnitalCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalSemiring</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">SemilatticeSup</span><span class=\"bp\">.</span><span class=\"n\">toPartialOrder</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">instAddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">instAddMonoid</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toAddGroup</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">AddGroup</span><span class=\"bp\">.</span><span class=\"n\">toSubNegMonoid</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"w\">     </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">SubNegMonoid</span><span class=\"bp\">.</span><span class=\"n\">toAddMonoid</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">22</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">reduction</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">unfolded</span><span class=\"w\"> </span><span class=\"n\">reducible</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">96</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">def_eq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">heuristic</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">solving</span><span class=\"w\"> </span><span class=\"ss\">`f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">60</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">):</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n</code></pre></div>\n<p>The instance searches do not traverse anything related to ENorm. (In fact, reverting the ENorm change does not change anything in the output.)</p>",
        "id": 497693568,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1738682853
    },
    {
        "content": "<p>I can see that the following is attempted in the <code>simp</code>, and it is very close to a heartbeat error, because adding <code>set_option trace.Meta.synthInstance true</code> makes it get a heartbeat error.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsAlgClosed</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">))</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"bp\">.</span><span class=\"n\">IsPrime</span>\n</code></pre></div>\n<p>So I'm guessing your PR somehow managed to barely push it over the heartbeat limit.</p>",
        "id": 497801360,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738726120
    },
    {
        "content": "<p>fix: change the order of the arguments in <code>IsArtinianRing.isMaximal_of_isPrime</code> so that <code>[IsArtinianRing R]</code> comes after <code>[p.IsPrime]</code>. (<a href=\"https://github.com/leanprover-community/mathlib4/pull/21449\">#21449</a>)</p>",
        "id": 497802154,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738726687
    },
    {
        "content": "<p>Because in this case all the computation is wasted on trying to synthesize the <code>IsArtinianRing</code>, while the <code>IsPrime</code> instance is just not available.</p>",
        "id": 497802270,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738726774
    },
    {
        "content": "<p>Thanks a lot for diagnosing this. You're my hero!</p>",
        "id": 497830550,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1738742841
    }
]