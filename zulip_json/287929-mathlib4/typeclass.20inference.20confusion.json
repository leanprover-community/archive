[
    {
        "content": "<p>In the below snippet I have a ring R and a field K and I ask typeclass inference a question involving R and K. I also have a K-module V which is completely irrelevant to the question. To my surprise, typeclass inference's answer to the question involves V, and indeed one of the questions which typeclass inference spends the longest on involves V. My question is: how does typeclass inference even notice V? Note: my question is <em>not</em> \"why oh why oh why does typeclass inference do this mathematically stupid thing\" (the answer usually being \"because this instance is being tried\"), it is literally \"how does typeclass inference even notice V's existence?\" (i.e. \"which instance is triggering this?\"). I have unfolded everything and I cannot see what instance is triggering typeclass inference to even notice V. Should I be putting some other trace options on?</p>\n<p>I ask because in my actual application typeclass inference gets totally bogged down in a completely irrelevant question of this nature and I would like to stop it doing this, but I cannot work out the underlying cause.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">uR</span><span class=\"w\"> </span><span class=\"n\">uK</span><span class=\"w\"> </span><span class=\"n\">uV</span>\n\n<span class=\"c1\">-- needed for `IsDedekindDomain.FiniteAdeleRing R K`</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">uR</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsDedekindDomain</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">uK</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsFractionRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- totally irrelevant</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">uV</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">IsDedekindDomain</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">[Elab.command] [3971649.000000] #synth Module (FiniteAdeleRing R K) (FiniteAdeleRing R K) ▼</span>\n<span class=\"cm\">  [step] [47.000000] expected type: Sort ?u.1038, term</span>\n<span class=\"cm\">      Type uR</span>\n<span class=\"cm\">  [step] [927.000000] expected type: Type uR, term</span>\n<span class=\"cm\">      CommRing R ▶</span>\n<span class=\"cm\">  [Meta.whnf] [21.000000] Non-easy whnf: CommRing R</span>\n<span class=\"cm\">  [step] [3073.000000] expected type: Prop, term</span>\n<span class=\"cm\">      IsDedekindDomain R ▶</span>\n<span class=\"cm\">  [Meta.whnf] [21.000000] Non-easy whnf: IsDedekindDomain R</span>\n<span class=\"cm\">  [step] [47.000000] expected type: Sort ?u.1055, term</span>\n<span class=\"cm\">      Type uK</span>\n<span class=\"cm\">  [step] [928.000000] expected type: Type uK, term</span>\n<span class=\"cm\">      Field K ▶</span>\n<span class=\"cm\">  [Meta.whnf] [21.000000] Non-easy whnf: Field K</span>\n<span class=\"cm\">  [step] [41214.000000] expected type: Type (max uK uR), term</span>\n<span class=\"cm\">      Algebra R K ▶</span>\n<span class=\"cm\">  [Meta.whnf] [21.000000] Non-easy whnf: Algebra R K</span>\n<span class=\"cm\">  [step] [42259.000000] expected type: Prop, term</span>\n<span class=\"cm\">      IsFractionRing R K ▶</span>\n<span class=\"cm\">  [Meta.whnf] [241.000000] Non-easy whnf: IsFractionRing R K ▶</span>\n<span class=\"cm\">  [Meta.whnf] [157.000000] Non-easy whnf: IsFractionRing R K ▶</span>\n<span class=\"cm\">  [Meta.whnf] [157.000000] Non-easy whnf: IsFractionRing R K ▶</span>\n<span class=\"cm\">  [step] [47.000000] expected type: Sort ?u.1252, term</span>\n<span class=\"cm\">      Type uV</span>\n<span class=\"cm\">  [step] [936.000000] expected type: Type uV, term</span>\n<span class=\"cm\">      AddCommGroup V ▶</span>\n<span class=\"cm\">  [Meta.whnf] [21.000000] Non-easy whnf: AddCommGroup V</span>\n<span class=\"cm\">  [step] [264769.000000] expected type: Type (max uV uK), term</span>\n<span class=\"cm\">      Module K V ▶</span>\n<span class=\"cm\">  [Meta.whnf] [21.000000] Non-easy whnf: Module K V</span>\n<span class=\"cm\">  [step] [219137.000000] expected type: &lt;not-available&gt;, term</span>\n<span class=\"cm\">      Module (FiniteAdeleRing R K) (FiniteAdeleRing R K) ▶</span>\n<span class=\"cm\">  [Meta.synthInstance] [3395634.000000] ✅️ Module (FiniteAdeleRing R K) (FiniteAdeleRing R K) ▶</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>The thing that is bamboozling me is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">step</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">264769.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">uV</span><span class=\"w\"> </span><span class=\"n\">uK</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"w\">      </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n</code></pre></div>\n<p>-- note that <code>264769.000000</code> is one of the biggest numbers in the trace.</p>",
        "id": 566223109,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1767533545
    },
    {
        "content": "<p>Curious. Can you then easily work around it with <code>omit V in</code> or similar?</p>",
        "id": 566224063,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1767534634
    },
    {
        "content": "<p>No because it's happening in the middle of something else.</p>",
        "id": 566224140,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1767534691
    },
    {
        "content": "<p>I think that in <code>#synth</code> it first resynthetizes everything in the <code>variable</code> lines before starting the real job. So I'm not sure what you see here is really relevant. Do you have a less minimal example?</p>",
        "id": 566229030,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1767539843
    },
    {
        "content": "<p>As <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> says, the Elab.step trace node that you are pointing out is that of elaborating the <code>[Module K V]</code> from the <code>variable</code> command, and is not part of the synthesis from the <code>#synth</code> command.</p>",
        "id": 566251643,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1767562258
    },
    {
        "content": "<p>Does</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>avoid the issue?</p>",
        "id": 566252355,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767563117
    },
    {
        "content": "<p>(note that you want to turn the profiler on last to prevent it profiling the <code>set_option</code> commands)</p>",
        "id": 566252370,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767563135
    },
    {
        "content": "<p>Oh I remember seeing this before now! I think Sebastien even opened an issue about it. Thanks! I'll go back to my original problem with this in mind.</p>",
        "id": 566252789,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1767563643
    }
]