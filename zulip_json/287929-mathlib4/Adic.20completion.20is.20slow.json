[
    {
        "content": "<p>In PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/14358\">#14358</a> the map <code>(AdicCompletion I R) ⊗[R] M →ₗ[AdicCompletion I R] AdicCompletion I M</code> is constructed and shown to be surjective if <code>M</code> is <code>R</code>-finite. During review, <span class=\"user-mention\" data-user-id=\"130384\">@Riccardo Brasca</span> voiced concerns that the file is quite slow, which I agree with. Apart from some slow <code>simp</code> calls that I now squeezed (at the cost of up to 6 lines of <code>simp only [...]</code>), a few <code>rw</code>s are quite slow, but I have no idea how to make this faster.</p>\n<p>If anyone has ideas how to speed things up, I'd be very happy to hear suggestions. If it helps, this is the output from <code>trace.profiler true</code>: <a href=\"https://share.firefox.dev/4cMVnSA\">https://share.firefox.dev/4cMVnSA</a></p>",
        "id": 449909888,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720453905
    },
    {
        "content": "<p>The file is not <em>horribly</em> slow, but maybe it's better to understand now if there is something wrong.</p>",
        "id": 449913703,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1720454487
    },
    {
        "content": "<p>I think one of my local copies of mathlib is unoccupied atm</p>",
        "id": 449913953,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720454520
    },
    {
        "content": "<p>My guess: </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AdicCompletion</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">submodule</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span>\n\n<span class=\"kd\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AdicCompletion</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">inferInstanceAs</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">submodule</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 449920623,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720455941
    },
    {
        "content": "<p>I see that those two instances appear quite often in the <code>Meta.isDefEq</code> checks for <code>M = R</code>. Could you explain a bit more why these are problematic and what I could try to make it better?</p>",
        "id": 449922551,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720456422
    },
    {
        "content": "<p>Too many instances on <code>Submodule</code>'s</p>",
        "id": 449922904,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720456529
    },
    {
        "content": "<p>Do you think that explicitly spelling out the <code>AddCommGroup</code> and <code>Module</code> instances might make it faster?</p>",
        "id": 449923506,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720456691
    },
    {
        "content": "<p>It could. I had to step away from the computer</p>",
        "id": 449923859,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720456785
    },
    {
        "content": "<p>I'll try it out, thanks!</p>",
        "id": 449924028,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720456821
    },
    {
        "content": "<p>The build time is down from ~30 seconds to ~5 seconds! Thanks a lot <span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span></p>",
        "id": 449932277,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720458864
    },
    {
        "content": "<p>So <a href=\"https://github.com/leanprover-community/mathlib4/pull/14534\">#14534</a> improves the situation in the <code>AsTensorProduct</code> file, as this benchmark shows: <a href=\"http://speed.lean-fro.org/mathlib4/compare/5f4b267e-9678-4a5a-962b-48ce7e897ba0/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=b134ed19aefe23e70c97e512b219dabce25824d7\">http://speed.lean-fro.org/mathlib4/compare/5f4b267e-9678-4a5a-962b-48ce7e897ba0/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=b134ed19aefe23e70c97e512b219dabce25824d7</a>.</p>\n<p>The increased instructions in the <code>Basic</code> and <code>Algebra</code> files are probably acceptable?</p>\n<p>(The reduced instruction count in the <code>Functoriality</code> file are due to some added <code>noncomputable</code>s)</p>",
        "id": 449986792,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720474580
    },
    {
        "content": "<p>I left some comments</p>",
        "id": 449988973,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720475441
    },
    {
        "content": "<p>The overall slowdown on master seems very small compared the eventual gains</p>",
        "id": 449989782,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720475664
    },
    {
        "content": "<p>I just did another benchmark comparing two versions of setting up the instances:</p>\n<ul>\n<li>completely manual, i.e. writing out the full instance definition (commit: <a href=\"https://github.com/leanprover-community/mathlib4/pull/14358/commits/55cf90705c3509ab5da127b7ecd4db0e147af667\">https://github.com/leanprover-community/mathlib4/pull/14358/commits/55cf90705c3509ab5da127b7ecd4db0e147af667</a>)</li>\n<li>using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Function.Injective.commRing#doc\">docs#Function.Injective.commRing</a> and friends (commit: <a href=\"https://github.com/leanprover-community/mathlib4/pull/14358/commits/00f96b96084f0a3e14793105fdda6a08a378c266\">https://github.com/leanprover-community/mathlib4/pull/14358/commits/00f96b96084f0a3e14793105fdda6a08a378c266</a>)</li>\n</ul>\n<p>While both are an improvement to the current status, the first version significantly outperforms the second one as this comparison shows:<br>\n<a href=\"http://speed.lean-fro.org/mathlib4/compare/04e26275-26be-4d08-8dd1-ffeb4e23bd0e/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=55cf90705c3509ab5da127b7ecd4db0e147af667\">http://speed.lean-fro.org/mathlib4/compare/04e26275-26be-4d08-8dd1-ffeb4e23bd0e/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=55cf90705c3509ab5da127b7ecd4db0e147af667</a></p>",
        "id": 450102943,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720514790
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Function.Injective.commRing#doc\">docs#Function.Injective.commRing</a> and friends used to be the cause of huge slowdowns because they would cause typeclass inference to take everything apart (TC inference had to solve lots of \"this commring instance equals that one\" goals, and it would solve them by destructing everything creating 10+ other problems). Is this still happening?</p>",
        "id": 450202086,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720539018
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Adic.20completion.20is.20slow/near/450202086\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Function.Injective.commRing#doc\">docs#Function.Injective.commRing</a> and friends used to be the cause of huge slowdowns because they would cause typeclass inference to take everything apart (TC inference had to solve lots of \"this commring instance equals that one\" goals, and it would solve them by destructing everything creating 10+ other problems). Is this still happening?</p>\n</blockquote>\n<p>I don't have a trace of the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Function.Injective.commRing#doc\">docs#Function.Injective.commRing</a> version, but the original version with <code>inferInstanceAs &lt;| CommRing (subring I)</code> caused precisely what you describe.</p>",
        "id": 450218778,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720542398
    },
    {
        "content": "<p>It is doing a lot of compiling now!</p>",
        "id": 450244529,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720548207
    },
    {
        "content": "<p>Oh I guess it was before also. But not it is doubled.</p>",
        "id": 450245515,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720548445
    },
    {
        "content": "<p>Not in the <code>AsTensorProduct</code> file though, right? (everything is <code>noncomputable</code> there).</p>",
        "id": 450246209,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720548620
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Adic.20completion.20is.20slow/near/450244529\">said</a>:</p>\n<blockquote>\n<p>It is doing a lot of compiling now!</p>\n</blockquote>\n<p>Where do you see this? In the benchmark?</p>",
        "id": 450246547,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720548723
    },
    {
        "content": "<p>Ah, found it. Its both in the <code>Basic</code> and in the <code>Algebra</code> file. Should I just put a <code>noncomputable section</code> at the top?</p>",
        "id": 450247079,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720548851
    },
    {
        "content": "<p><code>noncomputable section</code> means \"try to compile and give up if you can't\"</p>",
        "id": 450247865,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720549066
    },
    {
        "content": "<p>Ah, so mark everything with <code>noncomputable</code> instead?</p>",
        "id": 450247963,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720549087
    },
    {
        "content": "<p><code>suppress_compilation</code></p>",
        "id": 450248001,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720549098
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=commandSuppress_compilation#doc\">docs#commandSuppress_compilation</a></p>",
        "id": 450248239,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720549166
    },
    {
        "content": "<p>The increase is compilation and the increase in typeclass inference are the two main drivers of the regression</p>",
        "id": 450248736,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720549312
    },
    {
        "content": "<p><code>irreducible</code> isn't really doing you many favors in these files. Not sure about downstream</p>",
        "id": 450249240,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720549444
    },
    {
        "content": "<p>With <code>suppress_compilation</code> at the top and the <code>irreducible</code> attributes removed, I get an improvement overall. </p>\n<p>Though I am not a big fan of the repeated <code>Subtype.ext &lt;| proof</code> pattern</p>",
        "id": 450249438,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720549512
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Adic.20completion.20is.20slow/near/450249438\">said</a>:</p>\n<blockquote>\n<p>With <code>suppress_compilation</code> at the top and the <code>irreducible</code> attributes removed, I get an improvement overall. </p>\n<p>Though I am not a big fan of the repeated <code>Subtype.ext &lt;| proof</code> pattern</p>\n</blockquote>\n<p>I'd be happy to get rid of the <code>Subtype.ext &lt;| proof</code> pattern, but the alternatives don't seem to provide the same performance gains.</p>",
        "id": 450250003,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720549672
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Adic.20completion.20is.20slow/near/450249438\">said</a>:</p>\n<blockquote>\n<p>With <code>suppress_compilation</code> at the top and the <code>irreducible</code> attributes removed, I get an improvement overall. </p>\n<p>Though I am not a big fan of the repeated <code>Subtype.ext &lt;| proof</code> pattern</p>\n</blockquote>\n<p>Should I only remove the two problematic <code>irreducible</code>s (for <code>mul</code> and <code>smul'</code>)? Or do you think it's better to get rid of all of them?</p>",
        "id": 450250353,
        "sender_full_name": "Christian Merten",
        "timestamp": 1720549759
    },
    {
        "content": "<p>I really don't want Lean peeking in these too much because the definition are pretty intense. But it doesn't seem to be a problem (yet). </p>\n<p>I would hold off on using <code>@[irreducible]</code> until there is a demonstrated need. </p>\n<p>When <a href=\"https://github.com/leanprover-community/mathlib4/pull/11521\">#11521</a> lands, using <code>Function.Injective.commRing</code> etc should be much better</p>",
        "id": 450251119,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720550005
    },
    {
        "content": "<p>What needs to happen to get that PR landed?</p>",
        "id": 450308981,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720567766
    },
    {
        "content": "<p>I guess we need to lock Eric and Kyle in a room for 1 day...</p>",
        "id": 450401948,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720605450
    },
    {
        "content": "<p>It would be nice to see if <a href=\"https://github.com/leanprover-community/mathlib4/pull/11521\">#11521</a> does help. Assuming yes, then we can use the injective/surjective constructors now and improve later.</p>",
        "id": 450462986,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720620644
    }
]