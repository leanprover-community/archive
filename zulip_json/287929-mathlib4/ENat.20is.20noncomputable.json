[
    {
        "content": "<p>I'm doing some verified computations with power series approximations (<a href=\"https://github.com/girving/series\">https://github.com/girving/series</a>). I want my <code>Series α</code> to have a finite list of known, explicit coefficients, followed by a zero to infinite number of known zeros. This is nicely representable if <code>Series</code> has an <code>order : ℕ∞</code> field. For intuition, the most important application of an infinite number of known series is so that constants cleanly embed as series, without knowing the order one eventually needs them to.</p>\n<p>Unfortunately, the <code>ℕ∞</code> ordering is noncomputable:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ENat</span><span class=\"bp\">.</span><span class=\"n\">Lattice</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"sd\">/-- `min` on `WithTop α` and `α` produces `α` -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">WithTop</span><span class=\"bp\">.</span><span class=\"n\">min_coe</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithTop</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⊤</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"sd\">/--- The size of the explicit coefficient array after a binary componentwise operation like add or sub.</span>\n\n<span class=\"sd\">Fails with failed to compile definition, compiler IR check failed at `binary_n._closed_0`. Error: depends on declaration 'instCompleteLinearOrderENat', which has no executable code; consider marking definition as 'noncomputable' -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">binary_n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"bp\">∞</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b0</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"n\">a1</span>\n<span class=\"w\">  </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithTop</span><span class=\"bp\">.</span><span class=\"n\">min_coe</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithTop</span><span class=\"bp\">.</span><span class=\"n\">min_coe</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>so I am following the <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Nat/PartENat.html#PartENat\">instructions given here</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Deprecation</span><span class=\"w\"> </span><span class=\"bp\">#</span>\n<span class=\"n\">As</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">appears</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">unused</span><span class=\"w\"> </span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"mi\">2018</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"n\">deprecating</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">ENat</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">serve</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">purposes</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">please</span><span class=\"w\"> </span><span class=\"n\">raise</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">community</span><span class=\"w\"> </span><span class=\"n\">Zulip</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>What's the best way to proceed? For now I'll define my own computable version of <code>min</code> and it should be fine, just a bit clunky.</p>",
        "id": 540098389,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1758141201
    },
    {
        "content": "<p>It's not that the ordering on <code>ℕ∞</code> is noncomputable but that it took the wrong turn in instance synthesis, take:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ENat</span><span class=\"bp\">.</span><span class=\"n\">Lattice</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">explicit</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: @SemilatticeInf.toMin ENat</span>\n<span class=\"sd\">  (@Lattice.toSemilatticeInf ENat</span>\n<span class=\"sd\">    (@ConditionallyCompleteLattice.toLattice ENat</span>\n<span class=\"sd\">      (@ConditionallyCompleteLinearOrder.toConditionallyCompleteLattice ENat</span>\n<span class=\"sd\">        (@ConditionallyCompleteLinearOrderBot.toConditionallyCompleteLinearOrder ENat</span>\n<span class=\"sd\">          (@CompleteLinearOrder.toConditionallyCompleteLinearOrderBot ENat instCompleteLinearOrderENat)))))</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"bp\">∞</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">instCompleteLinearOrderENat</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">explicit</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: @SemilatticeInf.toMin ENat</span>\n<span class=\"sd\">  (@Lattice.toSemilatticeInf ENat</span>\n<span class=\"sd\">    (@DistribLattice.toLattice ENat (@instDistribLatticeOfLinearOrder ENat instLinearOrderENat)))</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"bp\">∞</span>\n</code></pre></div>",
        "id": 540105109,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758144284
    },
    {
        "content": "<p>What you'd really hope to see is <code>@LinearOrder.toMin ENat instLinearOrderENat</code> but well, instance search takes detours quite often</p>",
        "id": 540105354,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758144424
    },
    {
        "content": "<p>maybe the solution is instead to lower the priority of <code>ConditionallyCompleteLattice.toLattice</code> compared to <code>DistribLattice.toLattice</code>?</p>",
        "id": 540105626,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758144572
    },
    {
        "content": "<p>Hmm or maybe even also reduce the priority of <code>SemilatticeInf.toMin</code> in comparison to <code>LinearOrder.toMin</code>?</p>",
        "id": 540106146,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758144873
    },
    {
        "content": "<p>Maybe we could make this a more general rule: When class <code>A</code> implies class <code>B</code> and both class <code>A</code> and class <code>B</code> provide an instance to <code>C</code> then <code>B.toC</code> should have lower priority in comparison to <code>A.toC</code></p>",
        "id": 540106270,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758144946
    },
    {
        "content": "<p>Nrmally we just make a computable shortcut when this happens</p>",
        "id": 540108083,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758145974
    },
    {
        "content": "<p>So in this case, just add <code>instance : Lattice ENat := inferInstance</code> before the complete lattice is set up</p>",
        "id": 540108152,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758146020
    },
    {
        "content": "<p>Or without a mathlib change, if you don't want to wait</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ENat</span><span class=\"bp\">.</span><span class=\"n\">Lattice</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"c1\">-- this should be upstreamed as a \"computable shortcut instance\"</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lattice</span><span class=\"w\"> </span><span class=\"n\">ENat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"bp\">.</span><span class=\"n\">toLattice</span>\n\n<span class=\"sd\">/-- `min` on `WithTop α` and `α` produces `α` -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">WithTop</span><span class=\"bp\">.</span><span class=\"n\">min_coe</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithTop</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">⊤</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"sd\">/--- The size of the explicit coefficient array after a binary componentwise operation like add or sub. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">binary_n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"n\">a1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"bp\">∞</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b0</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">a0</span><span class=\"w\"> </span><span class=\"n\">a1</span>\n<span class=\"w\">  </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithTop</span><span class=\"bp\">.</span><span class=\"n\">min_coe</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithTop</span><span class=\"bp\">.</span><span class=\"n\">min_coe</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b1</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540108227,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758146085
    },
    {
        "content": "<p>I guess maybe we could do that but it would probably be nice to reduce the amount of detours instance search takes in general</p>",
        "id": 540108328,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758146154
    },
    {
        "content": "<p>Again, we want to use <code>LinearOrder.toMin</code> here, really</p>",
        "id": 540108350,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758146166
    },
    {
        "content": "<p>We do this shortcut pattern pretty extensively already</p>",
        "id": 540109797,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758147056
    },
    {
        "content": "<p>Another solution would be to do search in two stages, using one that skips <code>noncomputable</code> instances the first time</p>",
        "id": 540109961,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758147138
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/stream/287929-mathlib4/topic/ENat.20is.20noncomputable/near/540106270\">said</a>:</p>\n<blockquote>\n<p>Maybe we could make this a more general rule: When class <code>A</code> implies class <code>B</code> and both class <code>A</code> and class <code>B</code> provide an instance to <code>C</code> then <code>B.toC</code> should have lower priority in comparison to <code>A.toC</code></p>\n</blockquote>\n<p>I'd make the stronger claim that A.toC should not exist at all</p>",
        "id": 540110054,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758147181
    },
    {
        "content": "<p>You mean <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearOrder.toMin#doc\">docs#LinearOrder.toMin</a> should not exist and we should use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SemilatticeInf.toMin#doc\">docs#SemilatticeInf.toMin</a> instead..?</p>",
        "id": 540110173,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758147236
    },
    {
        "content": "<p>Or at least the former should not be an instance</p>",
        "id": 540110227,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758147261
    },
    {
        "content": "<p>I think we start to get close to import considerations here though, where we want linear orders available before lattices</p>",
        "id": 540110280,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758147295
    },
    {
        "content": "<p>Well, I quickly threw together a little</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Triangle detector</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">traverseStar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">DiscrTree</span><span class=\"bp\">.</span><span class=\"n\">Trie</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">star</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">traverseStar</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">snd</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">triangleDetector</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">insts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instanceExtension</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">key</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">insts</span><span class=\"bp\">.</span><span class=\"n\">discrTree</span><span class=\"bp\">.</span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">traverseStar</span><span class=\"w\"> </span><span class=\"n\">tree</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"bp\">.</span><span class=\"n\">filterMapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">entry</span><span class=\"bp\">.</span><span class=\"n\">val</span>\n<span class=\"w\">      </span><span class=\"n\">forallTelescope</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">.</span><span class=\"n\">fvarId!</span><span class=\"bp\">.</span><span class=\"n\">getBinderInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">matches</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">instImplicit</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">param</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">nm</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">quickLt</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">continue</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">synth1</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">          </span><span class=\"n\">withLocalDeclD</span><span class=\"w\"> </span><span class=\"ss\">`α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"n\">withLocalDeclD</span><span class=\"w\"> </span><span class=\"ss\">`h</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">synthInstance?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">synth2</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">          </span><span class=\"n\">withLocalDeclD</span><span class=\"w\"> </span><span class=\"ss\">`α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">          </span><span class=\"n\">withLocalDeclD</span><span class=\"w\"> </span><span class=\"ss\">`h</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">            </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">synthInstance?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">isSome</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">synth1</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">synth2</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{a} -&gt; {b} -&gt; {nm}\"</span>\n<span class=\"w\">        </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">synth2</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">synth1</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{b} -&gt; {a} -&gt; {nm}\"</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"bp\">.</span><span class=\"n\">intercalate</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">triangleDetector</span>\n</code></pre></div>\n</div></div>\n<p>which gives you <a href=\"/user_uploads/3121/Vk42YSu9It4n14-6KdOWoFhD/PastedText.txt\">this list</a>. So those are the ones we need to consider at least.</p>",
        "id": 540110640,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758147513
    },
    {
        "content": "<p>I've tried multiple times to fix this for the normed hierarchy :)</p>",
        "id": 540110750,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1758147598
    },
    {
        "content": "<p>There also some of these interesting four-sided shapes like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">SemilatticeSup</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span>\n<span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">SemilatticeInf</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">PartialOrder</span>\n</code></pre></div>\n<p>where I don't believe we can remove the <code>A.toC</code> connection without causing asymmetry</p>",
        "id": 540110785,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1758147617
    }
]