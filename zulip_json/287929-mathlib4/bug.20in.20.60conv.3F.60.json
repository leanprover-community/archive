[
    {
        "content": "<p><code>conv?</code> usually works great for me but I ran into a bug yesterday which I have taken some time to minimise because I thought <span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> might be interested. I explain it all in the MWE below but basically <code>conv?</code> seems to have<br>\nan off-by-one error when faced with a goal which has a typeclass instance in it. I'm sure it can be minimised much further but when I started on this an hour ago<br>\n<code>myClass</code> was <code>IsHaarMeasure</code> and it took me a long time to get rid of the<br>\nmeasure theory import whilst preserving the bug, so hopefully I've done enough.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">Conv</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">myType</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mymap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myType</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Î±</span>\n\n<span class=\"c1\">-- this class plays a key role</span>\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">myClass</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î¼</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"c1\">-- let's make it always true</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î¼</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myClass</span><span class=\"w\"> </span><span class=\"n\">Î¼</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n\n<span class=\"c1\">-- the `[myClass Î¼]` instance in hSF is essential for the bug</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">hSF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î¼'</span><span class=\"w\"> </span><span class=\"n\">Î¼</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">myClass</span><span class=\"w\"> </span><span class=\"n\">Î¼</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bug_in_conv_questionmark</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î¼</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">hSF</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mymap</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">hSF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mymap</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"n\">Î¼</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Î¼</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- the goal is some statement with two `Î±`s.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- I want to rewrite the second one with a `Î²`.</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"c1\">-- here's the goal with the second `Î±` replaced by a `Î²`.</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">hSF</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mymap</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">hSF</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mymap</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"w\"> </span><span class=\"n\">Î¼</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">Î¼</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  The goal is currently</span>\n\n<span class=\"cm\">  âŠ¢ hSF Î± (mymap Ï† Î±) = hSF (mycomap Ï† Î¼) Î¼</span>\n\n<span class=\"cm\">  so it has two `Î±`s in. I would like to `rw [smul]` at the second `Î±`</span>\n<span class=\"cm\">  using `conv` (in my application things are much more complicated and I can't</span>\n<span class=\"cm\">  use `rw` or `simp only` for reasons I won't go into (`Î²` depends on `Î±`,</span>\n<span class=\"cm\">  motive is not type correct etc), but `conv?` is perfect for this (indeed when</span>\n<span class=\"cm\">  I fix the bug manually in my application `conv` is working fine).</span>\n\n<span class=\"cm\">  But `conv?` fails to highlight the correct term. During the minimisation</span>\n<span class=\"cm\">  process, sometimes `conv?` succeeded and highlighted a different term (typically `Ï†`),</span>\n<span class=\"cm\">  and sometimes it just failed completely with error `Error: Not a valid conv target`.</span>\n<span class=\"cm\">  Right now, it's focussing on the `Ï†` just before `Î±`.</span>\n<span class=\"cm\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">conv?</span><span class=\"w\"> </span><span class=\"c1\">-- try clicking on the second `Î±` in the goal -- you'll end up</span>\n<span class=\"w\">        </span><span class=\"c1\">-- focussed on the `Ï†` which is just before it.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- The code I want `conv?` to generate:</span>\n<span class=\"w\">  </span><span class=\"n\">conv</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">enter</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- currently `conv?` produces `enter [1, 2, 1]`.</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">smul</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- this just checks that it worked:</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">foo</span>\n</code></pre></div>",
        "id": 519568169,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747820630
    },
    {
        "content": "<p>Iâ€™ll try to find time to investigate this, but most of the work on this widget is not due to me. I mostly took it from the ProofWidget example folder. See <a href=\"https://github.com/leanprover-community/ProofWidgets4/blob/main/ProofWidgets/Demos/Conv.lean\">https://github.com/leanprover-community/ProofWidgets4/blob/main/ProofWidgets/Demos/Conv.lean</a></p>",
        "id": 519610971,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1747833627
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128280\">@ğš ğš˜ğš“ğšŒğš’ğšğšŒğš‘ ğš—ğšŠğš ğš›ğš˜ğšŒğš”ğš’</span> may know more about this issue.</p>",
        "id": 519611032,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1747833642
    },
    {
        "content": "<p><code>conv?</code> is very broken</p>",
        "id": 519611215,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747833692
    },
    {
        "content": "<p>I tried some simple tests and it failed most of them</p>",
        "id": 519611268,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747833711
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> could you create an issue in the Mathlib repo with examples of things that fail?</p>",
        "id": 520000772,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1747990253
    },
    {
        "content": "<p>Yes, if you can easily make it fail then a much simpler example than mine would definitely be helpful! Do all your failures involve typeclasses? For me that was what triggered the problem.</p>",
        "id": 520021860,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747996784
    },
    {
        "content": "<p>The following is generated by <code>conv?</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">âˆƒ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">conv</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">enter</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>But what works is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">âˆƒ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">conv</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">enter</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 520220546,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1748111521
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/bug.20in.20.60conv.3F.60/near/520000772\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> could you create an issue in the Mathlib repo with examples of things that fail?</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/25162\">#25162</a></p>",
        "id": 520221404,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1748112256
    },
    {
        "content": "<p>I fixed this in <a href=\"https://github.com/leanprover-community/mathlib4/pull/25889\">#25889</a></p>",
        "id": 524280491,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750087375
    }
]