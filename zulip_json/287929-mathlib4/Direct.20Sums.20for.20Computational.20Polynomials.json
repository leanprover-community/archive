[
    {
        "content": "<p>As per <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Computation-models-for-polynomials-and-finitely-supported-functions\">this link</a>, I decided to try using direct sums to model computational polynomials. One of the examples there shows, using <code>decide</code>, that a certain <code>Finset (CPolynomial Int)</code> contains elements that are all not equal to 0. </p>\n<p>However, when I changed <code>Int</code> to <code>Rat</code>,  I get a weird instance error.  Consider the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">DirectSum</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">CPolynomial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">â¨</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">CPolynomial</span><span class=\"bp\">.</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CPolynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">CPolynomial</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">reprPrec</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">support'</span><span class=\"bp\">.</span><span class=\"n\">unquot</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Â·</span><span class=\"w\"> </span><span class=\"bp\">â‰¤</span><span class=\"w\"> </span><span class=\"bp\">Â·</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Format</span><span class=\"bp\">.</span><span class=\"n\">joinSep</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f!</span><span class=\"s2\">\"{repr (x 1)}*X\"</span>\n<span class=\"w\">      </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f!</span><span class=\"s2\">\"{repr (x i)}*X^{i}\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">f!</span><span class=\"s2\">\" + \"</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CPolynomial</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CPolynomial</span><span class=\"w\"> </span><span class=\"n\">â„š</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CPolynomial</span><span class=\"w\"> </span><span class=\"n\">â„š</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">CPolynomial</span><span class=\"w\"> </span><span class=\"n\">â„š</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Can anyone explain why the eval and the synth commands work, but the example doesn't? Thanks!</p>",
        "id": 561791740,
        "sender_full_name": "Dhruv Bhatia",
        "timestamp": 1764821684
    },
    {
        "content": "<p>Opening in lean playground, it looks like the eval shows <code>false</code> as the result in the infoview. So thats good</p>",
        "id": 561791908,
        "sender_full_name": "Yan Yablonovskiy ğŸ‡ºğŸ‡¦",
        "timestamp": 1764821817
    },
    {
        "content": "<p>yes, false is the correct output</p>",
        "id": 561791943,
        "sender_full_name": "Dhruv Bhatia",
        "timestamp": 1764821840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"452188\">Dhruv Bhatia</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Direct.20Sums.20for.20Computational.20Polynomials/near/561791943\">said</a>:</p>\n<blockquote>\n<p>yes, false is the correct output</p>\n</blockquote>\n<p>Yea i realised that it should still decide regardless</p>",
        "id": 561792016,
        "sender_full_name": "Yan Yablonovskiy ğŸ‡ºğŸ‡¦",
        "timestamp": 1764821909
    },
    {
        "content": "<p>are you getting the same long instance unfolding error when using decide? It seems to not be able to find an instance of Decidable for the prop <code>2 * X ^ 3 + 1 = 0</code></p>",
        "id": 561792134,
        "sender_full_name": "Dhruv Bhatia",
        "timestamp": 1764822032
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"452188\">Dhruv Bhatia</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Direct.20Sums.20for.20Computational.20Polynomials/near/561792134\">said</a>:</p>\n<blockquote>\n<p>are you getting the same long instance unfolding error when using decide? It seems to not be able to find an instance of Decidable for the prop <code>2 * X ^ 3 + 1 = 0</code></p>\n</blockquote>\n<p>Yea i get a stuck at reduction error when unfolding instances</p>",
        "id": 561792405,
        "sender_full_name": "Yan Yablonovskiy ğŸ‡ºğŸ‡¦",
        "timestamp": 1764822275
    },
    {
        "content": "<p>Note if you use native_decide you get </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"ss\">`native_decide</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">evaluated</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">proposition</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>which i guess means the eval fits the goal statement at least</p>",
        "id": 561792546,
        "sender_full_name": "Yan Yablonovskiy ğŸ‡ºğŸ‡¦",
        "timestamp": 1764822396
    },
    {
        "content": "<p>makes sense, we did see that #eval was already working</p>",
        "id": 561793274,
        "sender_full_name": "Dhruv Bhatia",
        "timestamp": 1764822768
    },
    {
        "content": "<p>it only gets more confusing, you can use </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">instDecidableEqDirectSum</span><span class=\"w\"> </span><span class=\"n\">â„•</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">â„š</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>to end up seeing isFalse . It might  also be something specifically to do with the tactic, looking at the <a href=\"https://lean-lang.org/doc/reference/latest/Tactic-Proofs/Tactic-Reference/#decide\">docs</a>:</p>\n<blockquote>\n<p>Limitation: In the default mode orÂ <code>+kernel</code>Â mode, sinceÂ <a href=\"https://lean-lang.org/doc/reference/latest/Type-Classes/Basic-Classes/#Decidable___decide\">decide</a>Â uses reduction to evaluate the term,Â <a href=\"https://lean-lang.org/doc/reference/latest/Type-Classes/Basic-Classes/#Decidable___isFalse\">Decidable</a>Â instances defined by well-founded recursion might not work because evaluating them requires reducing proofs. Reduction can also get stuck onÂ <a href=\"https://lean-lang.org/doc/reference/latest/Type-Classes/Basic-Classes/#Decidable___isFalse\">Decidable</a>Â instances withÂ <code>Eq.rec</code>Â terms. These can appear in instances defined using tactics (such asÂ <a href=\"https://lean-lang.org/doc/reference/latest/Tactic-Proofs/Tactic-Reference/#rw\">rw</a>Â andÂ <a href=\"https://lean-lang.org/doc/reference/latest/Tactic-Proofs/Tactic-Reference/#simp\">simp</a>). To avoid this, create such instances using definitions such asÂ <code>decidable_of_iff</code>Â instead.</p>\n</blockquote>",
        "id": 561794682,
        "sender_full_name": "Yan Yablonovskiy ğŸ‡ºğŸ‡¦",
        "timestamp": 1764823929
    },
    {
        "content": "<p>Looks like this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CPolynomial</span><span class=\"w\"> </span><span class=\"n\">â„š</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">   </span><span class=\"n\">with_unfolding_all</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 561797645,
        "sender_full_name": "Yan Yablonovskiy ğŸ‡ºğŸ‡¦",
        "timestamp": 1764826262
    }
]