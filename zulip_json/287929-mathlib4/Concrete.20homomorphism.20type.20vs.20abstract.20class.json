[
    {
        "content": "<p>Should definitions like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Subring</span><span class=\"bp\">.</span><span class=\"n\">comap</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"n\">Subring</span><span class=\"w\"> </span><span class=\"n\">R</span>\n</code></pre></div>\n<p>be using <code>[RingHomClass F R S] (f : F) </code> instead of <code>f : R →+* S</code>?</p>",
        "id": 492398775,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736288902
    },
    {
        "content": "<p>Possibly spicy take: No, and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearMap.ker#doc\">docs#LinearMap.ker</a> and alike is the one to be wrong</p>",
        "id": 492412494,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736296016
    },
    {
        "content": "<p>My reasoning: If you have a bundled blah <code>blah</code> (where a blah is something stronger than a linear map), then you can either talk about <code>LinearMap.ker blah</code> or <code>LinearMap.ker blah.toLinearMap</code>. Because <code>Blah</code> is niche, nobody has written API for <code>LinearMap.ker blah</code>, but at the same time it's the nicer to read spelling, so you are willing to use it anyway.</p>",
        "id": 492412801,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736296199
    },
    {
        "content": "<p>Sorry, I don't follow your argument. What is the reason to avoid the nice spelling?</p>",
        "id": 492436320,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1736313338
    },
    {
        "content": "<p>The reason is that it has no API</p>",
        "id": 492457329,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736325789
    },
    {
        "content": "<p>And why would <code>LinearMap.ker blah.toLinearMap</code> have API, if <code>Blah</code> is niche?</p>",
        "id": 492458442,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1736326231
    },
    {
        "content": "<p>because <code>LinearMap.ker</code> and <code>Blah.toLinearMap</code> will both have API. I'm not making this situation up. It keeps on happening to me</p>",
        "id": 492461422,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736327297
    },
    {
        "content": "<p>Let's put it another way. Currently, for every <code>Blah</code>, one needs to write the lemma <code>LinearMap.ker_blahZero : ker (0 : blah) = univ</code>, and similarly for other lemmas. So one needs to write quadratically many lemmas. With my suggestion, one needs only one <code>LinearMap.ker</code> lemma, namely <code>LinearMap.ker_zero</code>, and a lemma about <code>Blah</code>, namely <code>Blah.toLinearMap_zero : Blah.toLinearMap 0 = 0</code>, which we should have anyway</p>",
        "id": 492461922,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736327493
    },
    {
        "content": "<p>I really don't like the looks of <code>blah.toLinearMap</code>.<br>\nShouldn't <code>LinearMap.ker_zero</code> be a lemma about <code>LinearMapClass F</code> and <code>Zero F</code>, with a suitable mixin, or extension, so that <code>toLinearMap (0 : F) = 0</code>.</p>",
        "id": 492466937,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1736329161
    },
    {
        "content": "<p>I am not convinced there is a sensible finite set of axiomatisations that covers everything we need</p>",
        "id": 492467454,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736329345
    },
    {
        "content": "<p>But we might still be able to cover 98%</p>",
        "id": 492467961,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1736329518
    },
    {
        "content": "<p>Another issue with the <code>FooHomClass</code> design is the duplication caused by lemmas involving compositions, e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.map_map#doc\">docs#Ideal.map_map</a> and <del>docs#Ideal.map_mapₐ</del> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/RingTheory/Ideal/Maps.html#Ideal.map_map%E2%82%90\">Ideal.map_mapₐ</a></p>",
        "id": 492468908,
        "sender_full_name": "Christian Merten",
        "timestamp": 1736329868
    },
    {
        "content": "<p>[ooh I thought we'd fixed that linker bug]</p>",
        "id": 492469163,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1736329956
    },
    {
        "content": "<p>In the same vein, arguably even the coercions from FooHomClass-satisfying types to FooHom are bad, because they also amount to definitions that end up called on a type with no API</p>",
        "id": 492480506,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736334060
    },
    {
        "content": "<p>Yes, exactly. <a href=\"https://github.com/leanprover-community/mathlib4/pull/21031\">#21031</a> gets rid of those</p>",
        "id": 492484719,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736335769
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Concrete.20homomorphism.20type.20vs.20abstract.20class/near/492466937\">said</a>:</p>\n<blockquote>\n<p>I really don't like the looks of <code>blah.toLinearMap</code>.<br>\nShouldn't <code>LinearMap.ker_zero</code> be a lemma about <code>LinearMapClass F</code> and <code>Zero F</code>, with a suitable mixin, or extension, so that <code>toLinearMap (0 : F) = 0</code>.</p>\n</blockquote>\n<p>Why can't <code>toLinearMap</code> be a coercion, so you could still just write <code>LinearMap.ker blah</code>?</p>",
        "id": 492524373,
        "sender_full_name": "Mitchell Lee",
        "timestamp": 1736348946
    },
    {
        "content": "<p>Yes, Mitchell's suggestion is part of what I am implementing in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21031\">#21031</a></p>",
        "id": 492531547,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736351131
    },
    {
        "content": "<p>I don't have a strong opinion, but I remember being annoyed by ker (or something like that) asking for a linear map and being happy with the new solution. The problems described above surely exist, but I have the impression we notice weaknesses much more than strengths (just because we get very quickly used to something that works).</p>",
        "id": 492538277,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1736353250
    },
    {
        "content": "<p>Indeed. I think we should strive to obliterate hom class coercions in <em>statements</em> as much as possible, which would mean keeping <code>LinearMap.ker</code> as is.</p>",
        "id": 492549157,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736356103
    },
    {
        "content": "<p>I would make a different claim that we should eliminate <code>[HomClass _]</code> in <code>def</code>s, and only use them in theorems</p>",
        "id": 492550195,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736356388
    },
    {
        "content": "<p>It seems to me that (in the case of <code>ker</code>), this is the only lemma we're actually missing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">Ker</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R₂</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">M₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">M₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R₂</span><span class=\"w\"> </span><span class=\"n\">M₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">τ₁₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">R₂</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_11</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FunLike</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">M₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SemilinearMapClass</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">τ₁₂</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">M₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">ker_coe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">ker</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">LinearMap</span><span class=\"bp\">.</span><span class=\"n\">ker</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">→ₛₗ</span><span class=\"o\">[</span><span class=\"n\">τ₁₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">M₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>If we want to use APIs that are only available for <code>ker</code> of a <code>LinearMap</code>, we can rewrite by this to use them.</p>",
        "id": 492557175,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1736358873
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"695266\">Mitchell Lee</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Concrete.20homomorphism.20type.20vs.20abstract.20class/near/492524373\">said</a>:</p>\n<blockquote>\n<p>Why can't <code>toLinearMap</code> be a coercion, so you could still just write <code>LinearMap.ker blah</code>?</p>\n</blockquote>\n<p>It is a coercion, but Lean usually need to know all three of <code>M, τ₁₂, M₂</code> for the coercion to work. I encounter this a lot when trying to compose (<code>∘ₗ</code>) LinearMap with LinearEquiv; I frequently need to use LinearEquiv.toLinearMap.</p>\n<p>(Update: Actually, not all three. If you replace <code>τ₁₂</code> or <code>M₂</code> in <code>M →ₛₗ[τ₁₂] M₂</code> by <code>_</code> it will fail, but if you replace <code>M</code> by <code>_</code> it's okay.)</p>",
        "id": 492557812,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1736359116
    },
    {
        "content": "<p>But then we also need lemmas about <code>(f : M →ₛₗ[τ₁₂] M₂)</code> for particular choices of <code>F</code> and <code>f</code>, which I think are also absent</p>",
        "id": 492558280,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736359303
    },
    {
        "content": "<blockquote>\n<p>lemmas about <code>(f : M →ₛₗ[τ₁₂] M₂)</code></p>\n</blockquote>\n<p>I think those lemmas need to exist anyway? According to Yaël:</p>\n<blockquote>\n<p>a lemma about <code>Blah</code>, namely <code>Blah.toLinearMap_zero : Blah.toLinearMap 0 = 0</code></p>\n</blockquote>",
        "id": 492559013,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1736359599
    },
    {
        "content": "<p>I'm really confused <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span>. Is there any consensus on how to proceed in my specific case?</p>",
        "id": 492576273,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736366746
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Concrete.20homomorphism.20type.20vs.20abstract.20class/near/492559013\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>lemmas about <code>(f : M →ₛₗ[τ₁₂] M₂)</code></p>\n</blockquote>\n<p>I think those lemmas need to exist anyway? According to Yaël:</p>\n<blockquote>\n<p>a lemma about <code>Blah</code>, namely <code>Blah.toLinearMap_zero : Blah.toLinearMap 0 = 0</code></p>\n</blockquote>\n</blockquote>\n<p>For <code>toLinearMap</code>, we only need a lemma for every edge of the graph. For the <code>FooHomClass</code> versions, we need a lemma for every <em>path</em> through the graph</p>",
        "id": 492578765,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736367759
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"400289\">@Artie Khovanov</span> not yet, this is an active point of discussion. Give it some more time for the dust to settle.</p>",
        "id": 492579283,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736367983
    },
    {
        "content": "<p>Yeah, no worries -- I just couldn't parse a lot of what people were saying! I guess I'm not familiar enough with the existing design patterns.</p>",
        "id": 492579336,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736368006
    },
    {
        "content": "<p>once we figure out the correct approach, we'll be sure to distill it down into something manageable.</p>",
        "id": 492579416,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736368040
    }
]