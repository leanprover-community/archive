[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/16317\">#16317</a>, I redefine adjunction so that the only data contained in an adjunction is that of the unit and counit. Then <code>homEquiv</code> is defined in terms of the unit and counit. </p>\n<p>The constructor <code>mkOfHomEquiv</code> to to create an adjunction from a natural hom set equivalence remains, and a new constructor <code>Adjunction.mk'</code> which is the old definition of an adjunction, containing the data of a unit, counit and hom set equivalence, together with proofs of the equalities <code>homEquiv_unit</code> and <code>homEquiv_counit</code> relating them. </p>\n<p>This change makes the lemmas <code>homEquiv_unit</code> and <code>homEquiv_counit</code> definitional equalities, which seems to make it slightly easier for automation to apply them.</p>\n<p>It's not a huge improvement, but I think it's a more natural definition. I'm not entirely convinved it's a good change and I'd be happy to hear others' opinion about this, arguments against this change and what was the original motivation for the current definition of <code>Adjunction</code> in mathlib</p>",
        "id": 466967120,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1725286817
    },
    {
        "content": "<p>Seems like a good win in terms of reducing use of <code>erw</code> and <code>change</code>.</p>\n<p>I think <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> may have originally introduced this definition, so hopefully can comment if we're missing something.</p>",
        "id": 467089184,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725330266
    },
    {
        "content": "<p>The original design was because my intuition told me that we would care about getting good defeqs for <code>homEquiv</code>.</p>",
        "id": 467111035,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725338493
    },
    {
        "content": "<p>You've dropped <code>homEquiv</code> in a number of places. In other places you used <code>Adjunction.mk'</code>. How did you choose which option to use?</p>",
        "id": 467112313,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725338942
    },
    {
        "content": "<p>The reduction of <code>erw</code> make me happy <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 467112352,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725338962
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Refactoring.20adjunctions/near/467111035\">said</a>:</p>\n<blockquote>\n<p>The original design was because my intuition told me that we would care about getting good defeqs for <code>homEquiv</code>.</p>\n</blockquote>\n<p>Indeed, the regressions I'm seeing is that some lemmas about <code>homEquiv</code>s that were proved by <code>rfl</code> before now have more complicated proofs. But you always the propeqs.</p>",
        "id": 467225579,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1725364296
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Refactoring.20adjunctions/near/467112313\">said</a>:</p>\n<blockquote>\n<p>You've dropped <code>homEquiv</code> in a number of places. In other places you used <code>Adjunction.mk'</code>. How did you choose which option to use?</p>\n</blockquote>\n<p>I just dropped <code>homEquiv</code> if it didn't break anything. Using <code>Adjunction.mk'</code> makes the old proofs work. But I'm sure some of them could be refactored if desired.</p>",
        "id": 467225776,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1725364354
    },
    {
        "content": "<p>Part of me wants to keep the <code>homEquiv</code>'s around, if we have them anyway. And I guess you an still get rid of the <code>erw</code>s even if you keep them.</p>",
        "id": 467300431,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725379249
    },
    {
        "content": "<p>But I also understand the desire to have diffs that drop code <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 467300555,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725379270
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Refactoring.20adjunctions/near/467300431\">said</a>:</p>\n<blockquote>\n<p>And I guess you an still get rid of the <code>erw</code>s even if you keep them.</p>\n</blockquote>\n<p>Not all of them, like in the mysterious file <code>Adjunction.Opposites</code>. But I'm sure I can get rid of many without this change</p>",
        "id": 467320171,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1725384470
    },
    {
        "content": "<p>Maybe wasn't clear: I meant that you change the definition, like you do in the PR. But you use <code>Adjunction.mk'</code> in all places where <code>homEquiv</code> used to be part of the defn.</p>",
        "id": 467321711,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725384932
    },
    {
        "content": "<p>If you do that, you should still be able to get rid of all <code>erw</code>'s, right?</p>",
        "id": 467321754,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725384949
    },
    {
        "content": "<p>If not, then that is a good reason to drop the <code>homEquiv</code>'s</p>",
        "id": 467321796,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725384961
    },
    {
        "content": "<p>Ah, I see! I'll try it</p>",
        "id": 467321860,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1725384974
    },
    {
        "content": "<p>I added back all the <code>homEquiv</code>s, except one in <code>Topology.Sheaves.Skyscraper</code>. There the previous definition relied on defeqs of <code>homEquiv</code>s, so I refactored the whole file using the new definition (removing a few more <code>erw</code>s in the process). </p>\n<p><span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span> and <span class=\"user-mention\" data-user-id=\"252627\">@Jujian Zhang</span> are listed as authors and might have opinons about this change</p>",
        "id": 467333155,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1725388024
    },
    {
        "content": "<p>Sorry for the delay. I just kicked this on the queue</p>",
        "id": 469081849,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725972697
    },
    {
        "content": "<p>I noticed the following, which is somewhat related to this PR, but perhaps should be discussed elsewhere.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Composition of adjunctions.</span>\n\n<span class=\"sd\">See &lt;https://stacks.math.columbia.edu/tag/0DV0&gt;.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"bp\">⊣</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">mk'</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">homEquiv</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adj₂</span><span class=\"bp\">.</span><span class=\"n\">homEquiv</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">adj₁</span><span class=\"bp\">.</span><span class=\"n\">homEquiv</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">adj₁</span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">whiskerLeft</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whiskerRight</span><span class=\"w\"> </span><span class=\"n\">adj₂</span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">associator</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">inv</span>\n<span class=\"w\">    </span><span class=\"n\">counit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">associator</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">hom</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">whiskerLeft</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">whiskerRight</span><span class=\"w\"> </span><span class=\"n\">adj₁</span><span class=\"bp\">.</span><span class=\"n\">counit</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">adj₂</span><span class=\"bp\">.</span><span class=\"n\">counit</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>It looks the last <code>(Functor.associator _ _ _).inv</code> in the unit expression is put to avoid defeq abuse, but actually it fails to do that.</p>\n<p>The expected type here is <code> F ⋙ (H ⋙ I) ⋙ G ⟶ (F ⋙ H) ⋙ I ⋙ G</code>, but the type of <code>(Functor.associator _ _ _).inv</code> (actually <code>(Functor.associator F (H ⋙ I) G).inv</code>) is <code>F ⋙ (H ⋙ I) ⋙ G ⟶ (F ⋙ H ⋙ I) ⋙ G</code>. The correct expression with the expected type is slightly more involved like <code>whiskerLeft F (Functor.associator H I G).hom ≫ (Functor.associator F H (I ⋙ G)).inv</code>.</p>",
        "id": 469093897,
        "sender_full_name": "Yuma Mizuno",
        "timestamp": 1725975432
    },
    {
        "content": "<p>Is this still a concern (causing slowdown)? If not we should feel free to remove the associators.</p>",
        "id": 469143420,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1725984842
    }
]