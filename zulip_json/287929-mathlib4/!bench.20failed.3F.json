[
    {
        "content": "<p>I tried to run the <code>!bench</code> speed test on <a href=\"https://github.com/leanprover-community/mathlib4/pull/18385\">#18385</a> and it failed with a weird error that seems totally unrelated to the PR at hand:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"kn\">prefix</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Batteries'</span>\n</code></pre></div>\n<p>Did I do something wrong, or is the speed test system broken somehow? </p>\n<p>The benchmark log is <a href=\"http://speed.lean-fro.org/mathlib4/run-detail/113caf2c-5959-49cc-bd8a-6c4039bc0889\">here</a>.</p>",
        "id": 479753878,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730317851
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> might have an idea what could cause that.</p>",
        "id": 479754428,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1730318061
    },
    {
        "content": "<p>I just did a !bench run on <a href=\"https://github.com/leanprover-community/mathlib4/pull/12778\">#12778</a>, and it worked fine.</p>",
        "id": 479767576,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1730323768
    },
    {
        "content": "<p>Looks like my PR branch was quite old, I'll merge master and see if that fixes it</p>",
        "id": 479768219,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730324062
    },
    {
        "content": "<p>I think that is relevant, yes.</p>",
        "id": 479775449,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1730328355
    },
    {
        "content": "<p>And bench has indeed succeeded on the second try.</p>",
        "id": 479775522,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1730328381
    },
    {
        "content": "<p>I think you can ignore the first 2 \"build\" improvements as noise, but the other 2 seem to be very nice (non-noise) improvements!</p>",
        "id": 479775668,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1730328487
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/!bench.20failed.3F/near/479775668\">said</a>:</p>\n<blockquote>\n<p>I think you can ignore the first 2 \"build\" improvements as noise, but the other 2 seem to be very nice (non-noise) improvements!</p>\n</blockquote>\n<p>Indeed, I'm startled by the extent of the speedup; but it is tinged with regret, because I suspect most of that 71.6% decrease in <code>NumberTheory.ModularForms.SlashActions</code> comes from the replacement of a single extremely slow <code>field_simp</code> step with a longer and more explicit manual argument. It would be nice if we could get speedups by improving the automation, rather than removing it, but that's not a task I'm competent to take on.</p>",
        "id": 479813880,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730356908
    },
    {
        "content": "<p><code>field_simp</code> is known to be pretty borked at the moment.</p>",
        "id": 479816922,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730358819
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/!bench.20failed.3F/near/479816922\">said</a>:</p>\n<blockquote>\n<p><code>field_simp</code> is known to be pretty borked at the moment.</p>\n</blockquote>\n<p>I'm amused to see you in particular posting this, Kim; since I asked about the same issue on zulip before, 6 months ago, <a href=\"#narrow/channel/287929-mathlib4/topic/To.20automate.20or.20not.20to.20automate.3F/near/429427778\">here</a> and at the time, you wrote</p>\n<blockquote>\n<p>No one should be removing uses of <code>field_simp</code> because they are slow. We need to fix <code>field_simp</code>!</p>\n</blockquote>\n<p>Is there any realistic prospect of <code>field_simp</code> getting un-borked again?</p>",
        "id": 479825071,
        "sender_full_name": "David Loeffler",
        "timestamp": 1730362798
    },
    {
        "content": "<p>I guess that was my failed attempt to get someone to fix it...</p>",
        "id": 479827954,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730363858
    },
    {
        "content": "<p>Having a clear spec of what it is meant to do might help. The current implementation is \"try stuff, and keep trying if it's not going well\".</p>",
        "id": 479828110,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730363909
    },
    {
        "content": "<p>My medium-term list of \"tactic projects to try\" includes looking at field_simp. Having a clear description what it should do, could do and currently does (not) do helps.  <a href=\"#narrow/channel/287929-mathlib4/topic/Rewriting.20field_simp.20-.20how.3F\">This thread</a> was my attempt to collect such information. Please add missing bits there!</p>",
        "id": 479838289,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1730367706
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/18508\">#18508</a>, I left a <code>!bench</code> comment, it got a <span aria-label=\"rocket\" class=\"emoji emoji-1f680\" role=\"img\" title=\"rocket\">:rocket:</span> emoji but no results were posted.</p>",
        "id": 480585957,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1730788305
    },
    {
        "content": "<p>Unfortunately the growth of Mathlib has brought the speedcenter software to its limits. I restarted it once more but it's not clear who could implement a more robust fix.</p>",
        "id": 480740068,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1730818740
    },
    {
        "content": "<p>I'm not sure if I should be happy or sad about your message.</p>",
        "id": 480744413,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730819790
    },
    {
        "content": "<p>There are a few aspects of our use of the speedcenter that seem a bit abusive and which we could maybe scale back. The ones that come to mind are: running it on every single commit (so it is often fighting a long backlog) and having one benchmark metric per file (resulting in quadratic growth of metric values on the interface over time). The per file benchmark in particular has long been something which makes it difficult for me to read benchmark results, I would much rather this was more selective and only tracked files that are \"interesting\" in some sense (largest file, longest compile, most typeclasses), maybe with a few random samples sprinkled in</p>",
        "id": 480750649,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730821557
    },
    {
        "content": "<p>I think the filewise metrics are useful when benching PRs? Maybe not so useful when benching master though</p>",
        "id": 480755687,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1730823024
    },
    {
        "content": "<p>I don't think that amount of data should necessarily make the server run out of memory. But if we can't fix the software, reducing the data certainly would be an alternative. It might be interesting to look at a histogram of the per-file times to see whether there is some cut-off with many files below it that are fast enough not to be that interesting for the diff unless they regress above the cut-off.</p>",
        "id": 480756585,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1730823295
    },
    {
        "content": "<p>what exactly went wrong? From your description I guess some kind of implementation limit or resource was exhausted, but not more than that</p>",
        "id": 480785450,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730834257
    },
    {
        "content": "<p>Is it possible to test the speedcenter locally? Is the code hosted publicly?</p>",
        "id": 480785568,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730834304
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/!bench.20failed.3F/near/480785568\">said</a>:</p>\n<blockquote>\n<p>Is it possible to test the speedcenter locally? Is the code hosted publicly?</p>\n</blockquote>\n<p><a href=\"https://github.com/IPDSnelting/velcom\">https://github.com/IPDSnelting/velcom</a></p>",
        "id": 480799504,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1730840550
    },
    {
        "content": "<p>I thought that lean was running a fork of this repo</p>",
        "id": 480799678,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730840637
    },
    {
        "content": "<p>It isn't, see my Mathlib-specific fixes on master</p>",
        "id": 480875581,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1730884699
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/!bench.20failed.3F/near/480785450\">said</a>:</p>\n<blockquote>\n<p>what exactly went wrong? From your description I guess some kind of implementation limit or resource was exhausted, but not more than that</p>\n</blockquote>\n<p>Java ran out of memory. It looks like it defaults to 1/4 of physical RAM so doubling that setting may or may not give us some years of breathing room. But it seems problematic that it balloons to 16GB in the first place. The worst part is that only some threads abort and not the whole process, otherwise we could have systemd restart it.</p>",
        "id": 480876484,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1730885027
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/!bench.20failed.3F/near/480785568\">said</a>:</p>\n<blockquote>\n<p>Is it possible to test the speedcenter locally?</p>\n</blockquote>\n<p>Yes, you can even point your local build at the live instance's API endpoint for read-only operations. See <code>.env.development-remote</code>.</p>",
        "id": 480876920,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1730885156
    }
]