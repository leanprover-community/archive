[
    {
        "content": "<p>Sometimes, when using <code>gcongr</code> for sums or products, I end up with side goals of the form <code>∀ i, 0 ≤ ‖f i‖</code> or <code>∀ i ∈ s, 0 ≤ ‖f i‖</code>. They are shown to me because <code>positivity</code> can not solve them (it's not really in its scope), but still I find it a little bit sad. Should this be special-cased in <code>gcongr</code> or <code>positivity</code>?</p>",
        "id": 469424238,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1726065957
    },
    {
        "content": "<p>I would personally be very much in favour of that</p>",
        "id": 469426038,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1726066193
    },
    {
        "content": "<p><code>bound</code> should work for some of them already, but +1 to extending gcongr.</p>",
        "id": 469501660,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1726086364
    },
    {
        "content": "<p>(aesop by default does intros, if I’m remembering correctly)</p>",
        "id": 469501713,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1726086392
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"127136\">@Alex J. Best</span> wrote positivity extensions for sums and products for Terry Tao's symmetric polynomials project:<br>\n<a href=\"https://github.com/teorth/symmetric_project/blob/master/SymmetricProject/positivity_ext.lean\">https://github.com/teorth/symmetric_project/blob/master/SymmetricProject/positivity_ext.lean</a><br>\nI don't know if they ever made it to Mathlib, but they should!</p>",
        "id": 469510069,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1726090355
    },
    {
        "content": "<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‖</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">‖</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">positivity</span>\n</code></pre></div>",
        "id": 469513403,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1726092133
    },
    {
        "content": "<p>Ah indeed: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.Positivity.evalFinsetSum#doc\">docs#Mathlib.Meta.Positivity.evalFinsetSum</a>, from <a href=\"https://github.com/leanprover-community/mathlib4/pull/10538\">#10538</a>.</p>",
        "id": 469514056,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1726092448
    },
    {
        "content": "<p>Given that that's there, I wonder why Sébastien is encountering side goals like</p>\n<blockquote>\n<p><code>∀ i, 0 ≤ ‖f i‖</code> or <code>∀ i ∈ s, 0 ≤ ‖f i‖</code>.</p>\n</blockquote>\n<p>?</p>",
        "id": 469514176,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1726092499
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 469515039,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1726093015
    },
    {
        "content": "<p>He could be working over finsums and Finite as opposed to finset sum. Or the TODO in the docstring of the extension</p>",
        "id": 469515190,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1726093106
    },
    {
        "content": "<p>MWE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‖</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">‖</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">‖</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">‖</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∏</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‖</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">‖</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">∏</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‖</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">‖</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">gcongr</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">hi</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">hj</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">positivity</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">i</span>\n</code></pre></div>\n<p>Here the side goal is not discharged automatically.</p>",
        "id": 469629638,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1726137000
    },
    {
        "content": "<p>It looks like <code>gcongr</code> is doing too much here, so <code>positivity</code> doesn't fire: rather than producing the side goal <code>0 ≤ ∏ i : Fin n, ‖f i‖</code> (as I would expect) it is producing the side goal <code>∀ i ∈ Finset.univ, 0 ≤ ‖f i‖</code>.</p>",
        "id": 469686150,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1726149962
    },
    {
        "content": "<p>I'm a little surprised by this!  I'll dig into the code.</p>",
        "id": 469686279,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1726149992
    },
    {
        "content": "<p>Heather, I think you are forgetting that some boundedness/nonemptiness condition is needed for <code>⨅ i, f i</code> to be monotone in <code>f</code>.</p>",
        "id": 469697830,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1726152626
    },
    {
        "content": "<p>... or are you saying it should use the fact that <code>Fin n</code> is finite in a more fundamental way?</p>",
        "id": 469698129,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1726152702
    },
    {
        "content": "<p>In fact I was overthinking this: in my head the side condition for the <code>@[gcongr]</code> lemma was <code>0 ≤ ∏ i, ‖f i‖</code> (which indeed would have required the positivity extension for products), whereas it actually is <code>∀ i, 0 ≤ ‖f i‖</code> (which is solved by <code>intros</code> plus OG positivity.)</p>\n<p>I also remembered that this feature had been requested <a href=\"#narrow/stream/287929-mathlib4/topic/Could.20positivity.20handle.20sums.20of.20squares.3F/near/398115516\">before</a>.  I tried it out on mathlib and it seems harmless and mildly useful, so I have PR'd it! <a href=\"https://github.com/leanprover-community/mathlib4/pull/16747\">#16747</a></p>",
        "id": 469812817,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1726190556
    },
    {
        "content": "<p>Can't wait for the proofs in APAP to lose many lines <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 469857478,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1726206325
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 469873661,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1726211310
    }
]