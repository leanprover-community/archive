[
    {
        "content": "<p><a href=\"/user_uploads/3121/U_8JeMGKEm5VNDljvoefU7w8/buildtimes.png\">buildtimes.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/U_8JeMGKEm5VNDljvoefU7w8/buildtimes.png\" title=\"buildtimes.png\"><img data-original-dimensions=\"1678x1434\" src=\"/user_uploads/thumbnail/3121/U_8JeMGKEm5VNDljvoefU7w8/buildtimes.png/840x560.webp\"></a></div><p>I was looking over <a href=\"https://github.com/leanprover-community/mathlib4_docs/actions/workflows/docs.yaml\">mathlib4_docs</a> workflow runs and noticed that after Jan 3 the build times went from &lt;20m to &gt;45m. Is this expected?</p>\n<p>Looking over <a href=\"https://github.com/leanprover/doc-gen4/commits/main/\">recent <code>doc-gen4</code> commits</a>, it seems that the only changes in the relevant time period are <a href=\"https://github.com/leanprover/doc-gen4/pull/255\">a bump to v4.16.0-rc1</a> and <a href=\"https://github.com/leanprover/doc-gen4/pull/258\">switching to a fork of md4lean</a>.</p>",
        "id": 492798394,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1736449913
    },
    {
        "content": "<p>Looking at a <a href=\"https://github.com/leanprover-community/mathlib4_docs/actions/runs/12585251751/job/35076624969\">previous</a> and <a href=\"https://github.com/leanprover-community/mathlib4_docs/actions/runs/12642752038/job/35227619049\">current</a> build log, the step taking <strong>much</strong> longer is indeed the \"generate docs\" step.</p>",
        "id": 492800746,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1736450671
    },
    {
        "content": "<p>Looking at the commit log, I wonder about <code>https://github.com/leanprover/doc-gen4/commit/4d618d6b49d145f67ae63b56238adec41b7e53b4</code> (i.e. adapting doc-gen for <a href=\"https://github.com/leanprover/lean4/pull/6388\">lean4#6388</a> --- the diff is a significant change.</p>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Do you have an idea if this change could have caused doc-gen4 to slow down by a factor of 3 or 4?</p>",
        "id": 492806136,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1736452518
    },
    {
        "content": "<p>No</p>",
        "id": 492806484,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736452650
    },
    {
        "content": "<p>You need to read the log more carefully</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">753</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">754</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">755</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">756</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">Notation</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">757</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">BinaryRec</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">758</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">BinaryRec</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">759</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">760</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Notation</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">761</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">762</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">763</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">764</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">765</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">MemoFix</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">766</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">MemoFix</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">767</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">ReplaceRec</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">768</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">ReplaceRec</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">769</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">EnvExtension</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">770</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">EnvExtension</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">771</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Simp</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">772</span><span class=\"bp\">/</span><span class=\"mi\">12035</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Simp</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n</code></pre></div>\n<p>As you can see here it is building both mathlib and the documentation, the issue is that the mathlib cache is broken with the 4.16.0-rc1 so it has to rebuild that as well, the extra time here is just compiling mathlib, doc-gen is as fast as ever</p>",
        "id": 492806637,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1736452693
    },
    {
        "content": "<p>Aha, I think that explains it then. Thanks!</p>",
        "id": 492806919,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1736452798
    }
]