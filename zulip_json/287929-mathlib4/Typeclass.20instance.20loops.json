[
    {
        "content": "<p>The predicate <code>IsOrderedRing R</code> is strictly weaker than <code>IsStrictOrderedRing R</code> (e.g. <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Z</mi><mo stretchy=\"false\">[</mo><mi>ε</mi><mo stretchy=\"false\">]</mo><mi mathvariant=\"normal\">/</mi><mo stretchy=\"false\">⟨</mo><msup><mi>ε</mi><mn>2</mn></msup><mo stretchy=\"false\">⟩</mo></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Z}[\\varepsilon]/\\langle\\varepsilon^2\\rangle</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord mathbb\">Z</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">ε</span><span class=\"mclose\">]</span><span class=\"mord\">/</span><span class=\"mopen\">⟨</span><span class=\"mord\"><span class=\"mord mathnormal\">ε</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span><span class=\"mclose\">⟩</span></span></span></span>).  However, over a field, the two are equivalent, and the content of <code>IsOrderedRing</code> is the standard definition.</p>\n<p>Since mathlib4 allows instance loops, I tried to make this into an instance in <a href=\"https://github.com/leanprover-community/mathlib4/pull/27178\">#27178</a>, incurring a mild performance hit. However, <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> told me that the right spelling of \"ordered field\" should be <code>[Field F] [LinearOrder F] [IsStrictOrderedRing F]</code> in order to avoid the instance loop and to make it consistent with the spelling when not over a field.</p>\n<p>Two questions<br>\n(1) Is there anywhere else in the library that we have this pattern? That is, where the mathlib definition uses a stronger class instance than the \"standard\" textbook definition would suggest due to how the instances line up in a weaker context?<br>\n(2) I have a similar problem with the existing <code>IsSemireal</code> class and my proposed <code>IsFormallyReal</code> class. Over a ring, <code>IsFormallyReal</code> is strictly stronger (e.g. <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Q</mi><mo stretchy=\"false\">[</mo><mi>X</mi><mo separator=\"true\">,</mo><mi>i</mi><mi>X</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Q}[X,iX]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathbb\">Q</span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"mclose\">]</span></span></span></span>). Over a field, they are equivalent. Again, the content of <code>IsSemireal</code> is the standard definition. By the same logic, I understand the should be <code>[Field F] [IsFormallyReal F]</code>, with no instance from <code>IsSemireal</code> to <code>IsFormallyReal</code> over a <code>Field</code>?</p>",
        "id": 534238064,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755093939
    },
    {
        "content": "<p>I would like to say that we assume compact Hausdorff spaces as <code>[CompactSpace X] [T2Space X]</code> 97 times according to <a href=\"https://loogle.lean-lang.org/\">#loogle</a>, but the equivalent spelling <code>[CompactSpace X] [T4Space X]</code> with stronger typeclasses gets zero results.</p>",
        "id": 534238771,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755094134
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> CompactSpace ?X → T2Space ?X → _</p>",
        "id": 534239112,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755094237
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/Separation/Hausdorff.html#Ultrafilter.lim_eq_iff_le_nhds\">Ultrafilter.lim_eq_iff_le_nhds</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/Separation/Hausdorff.html#isOpen_iff_ultrafilter%27\">isOpen_iff_ultrafilter'</a>, and <a href=\"https://loogle.lean-lang.org/?q=CompactSpace%20%3FX%20%E2%86%92%20T2Space%20%3FX%20%E2%86%92%20_\">95 more</a></p>",
        "id": 534239118,
        "sender_full_name": "loogle",
        "timestamp": 1755094238
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> CompactSpace, T4Space</p>",
        "id": 534239146,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755094247
    },
    {
        "content": "<p><span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span> nothing found</p>",
        "id": 534239148,
        "sender_full_name": "loogle",
        "timestamp": 1755094248
    },
    {
        "content": "<p>Interesting <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> - is there an instance <code>[CompactSpace X] [T2Space X]</code> -&gt; <code>[T4Space X]</code> (\"compact Hausdorff spaces are normal\")? The crucial property in my examples is there there's theory on the <code>T4</code> / <code>IsStrictOrderedRing</code> / <code>IsFormallyReal</code> class (in the absence of <code>CompactSpace</code> / <code>Field</code>) that I'd like to be able to use automatically.</p>",
        "id": 534239257,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755094279
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">CompactSpace</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">T2Space</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- T4Space.of_paracompactSpace_t2Space</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">T4Space</span><span class=\"w\"> </span><span class=\"n\">X</span>\n</code></pre></div>",
        "id": 534239463,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755094344
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Typeclass.20instance.20loops/near/534238064\">said</a>:</p>\n<blockquote>\n<p>Since mathlib4 allows instance loops</p>\n</blockquote>\n<p>is that true? i've not been informed of that?</p>",
        "id": 534239950,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755094476
    },
    {
        "content": "<p>hm right thanks <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> <br>\nseems like both design patterns are present in the library<br>\nI would strongly push to have the \"right\" typeclass to use in Mathlib be the one that's intuitive from the literature, where possible<br>\neven if this results in a mild performance hit due to the instance loop<br>\neg if somebody writes <code>[Field F] [LinearOrder F] [IsOrderedRing F]</code> it will all look correct except now linarith, positivity etc doesn't work and it's very non obvious why</p>",
        "id": 534240019,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755094499
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Typeclass.20instance.20loops/near/534239950\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Typeclass.20instance.20loops/near/534238064\">said</a>:</p>\n<blockquote>\n<p>Since mathlib4 allows instance loops</p>\n</blockquote>\n<p>is that true? i've not been informed of that?</p>\n</blockquote>\n<p>the code snippet Aaron posted above implies they must be allowed</p>",
        "id": 534240178,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755094538
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Typeclass.20instance.20loops/near/534238771\">said</a>:</p>\n<blockquote>\n<p>I would like to say that we assume compact Hausdorff spaces as <code>[CompactSpace X] [T2Space X]</code> 97 times according to <a href=\"https://loogle.lean-lang.org/\">#loogle</a>, but the equivalent spelling <code>[CompactSpace X] [T4Space X]</code> with stronger typeclasses gets zero results.</p>\n</blockquote>\n<p>I think this is mostly because of how obscure T₄ is. I am an analyst and I can't even tell you what it means off-hand!</p>",
        "id": 534241097,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1755094817
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Typeclass.20instance.20loops/near/534238064\">said</a>:</p>\n<blockquote>\n<p>Is there anywhere else in the library that we have this pattern? That is, where the mathlib definition uses a stronger class instance than the \"standard\" textbook definition would suggest due to how the instances line up in a weaker context?</p>\n</blockquote>\n<p>Yes, between</p>\n<ul>\n<li><code>[NormedDivisionRing K] [NormedAddCommGroup V] [Module K V] [NormSMulClass K V]</code> (what we use)</li>\n<li><code>[NormedDivisionRing K] [NormedAddCommGroup V] [Module K V] [IsBoundedSMul K V]</code> (\"weaker\" assumptions, but provably equivalent via <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormedDivisionRing.toNormSMulClass#doc\">docs#NormedDivisionRing.toNormSMulClass</a>)</li>\n</ul>",
        "id": 534241170,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755094836
    },
    {
        "content": "<p>This example came up in a refactor by <span class=\"user-mention\" data-user-id=\"481963\">@David Loeffler</span> which introduced <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormSMulClass#doc\">docs#NormSMulClass</a>, and I think he initially built 2. but I argued for 1.</p>",
        "id": 534241420,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755094905
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>  This was the example you gave in the PR, right? I think that's a bit different, because surely the standard definition of a normed module is that norm is multiplicative?</p>",
        "id": 534241832,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755095022
    },
    {
        "content": "<p>Like, if we always want to go with the weaker class and remove loops, then that's fine, but I'd personally prefer loops where they yield more intuitive definitions.</p>",
        "id": 534242059,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755095087
    },
    {
        "content": "<p>Just coming late to this thread: I disagree with <span class=\"user-mention\" data-user-id=\"400289\">@Artie Khovanov</span> about what is the \"standard definition\"; when you look at modules over normed <em>rings</em>, not fields – modules over Banach algebras, etc – it starts to seem very unnatural and inconvenient to require precise multiplicativity of the norm, and sub-multiplicativity is the much more natural concept. That was the whole point of my refactor: to make it possible to state theorems about Banach modules over Banach algebras in a natural way.</p>",
        "id": 534742557,
        "sender_full_name": "David Loeffler",
        "timestamp": 1755325550
    },
    {
        "content": "<p>hmm, fair enough - looks like it <em>is</em> a similar example</p>",
        "id": 534743271,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755326372
    },
    {
        "content": "<p>The combination <code>[Field R] [IsOrderedRing R]</code> is also being added at <a href=\"https://github.com/leanprover-community/mathlib4/pull/28179/files#diff-992879dba2aba59569a7f9927753bfac51b97ec097d9868083b355cbb93fa772R140-R145\">https://github.com/leanprover-community/mathlib4/pull/28179/files#diff-992879dba2aba59569a7f9927753bfac51b97ec097d9868083b355cbb93fa772R140-R145</a> and I personally prefer it.</p>",
        "id": 534773039,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755362552
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span> indeed, in that PR, the instance is added back manually within the proof<br>\nI think in either case that PR has the wrong design - either we should make .toStrictOrderedRing an instance, or (much as I dislike this) we should use the stronger instance in the hypotheses</p>",
        "id": 534773525,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755363187
    },
    {
        "content": "<p>We also use <code>[Ring R] [IsTopologicalRing R]</code> in hypotheses instead of <code>IsTopologicalSemiring R</code>, even though these are equivalent.</p>",
        "id": 534923431,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1755514694
    },
    {
        "content": "<p><del>I think it's clear we should have a linter against these \"weaker\" spellings if we want to discourage them.</del> Although actually, the instance not existing already works</p>",
        "id": 534924720,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755515177
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Typeclass.20instance.20loops/near/534924720\">said</a>:</p>\n<blockquote>\n<p>Although actually, the instance not existing already works</p>\n</blockquote>\n<p>This is my point -- I don't think it does! It does in the examples where you can weaken the standard definition, but not in my example or the module over Banach algebra example. You write the obvious thing, and tactics, <code>exact</code> etc. just fail silently. I think a linter would be a good idea if we indeed want to avoid these sorts of threads every so often.</p>",
        "id": 534926407,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755515740
    },
    {
        "content": "<p>Secondary consideration: we should formally write the preferred spelling down somewhere in the documentation.</p>",
        "id": 534932093,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755517655
    },
    {
        "content": "<p>I think if we have a correct linter we shouldn't do that</p>",
        "id": 534938466,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755519337
    },
    {
        "content": "<p>No we definitely should write the preferred spelling somewhere</p>",
        "id": 534938743,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755519401
    },
    {
        "content": "<p>I would even push for library note with <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>'s rationale + common preferred spellings somewhere (else?)</p>",
        "id": 534939051,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1755519488
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Typeclass.20instance.20loops/near/534938743\">said</a>:</p>\n<blockquote>\n<p>No we definitely should write the preferred spelling somewhere</p>\n</blockquote>\n<p>Sounds like a recipe for having it go out of sync with the linter</p>",
        "id": 534942631,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755520519
    },
    {
        "content": "<p>Things go out of sync all the time</p>",
        "id": 534942707,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755520545
    },
    {
        "content": "<p>Just yesterday I saw <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ModelWithCorners.toFun%27#doc\">docs#ModelWithCorners.toFun'</a> docstring saying something about how the port is still happening</p>\n<blockquote>\n<p>Coercion of a model with corners to a function. We don't use <code>e.toFun</code> because it is actually <code>e.toPartialEquiv.toFun</code>, so <code>simp</code> will apply lemmas about <code>toPartialEquiv</code>. While we may want to switch to this behavior later, doing it mid-port will break a lot of proofs.</p>\n</blockquote>",
        "id": 534943191,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755520717
    }
]