[
    {
        "content": "<p>The following example (minimisation due to Eric Wieser) fails on master. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">HasPullbacks</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">OrderBot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Subobject</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>The error message is</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>failed to synthesize\n  OrderBot (CategoryTheory.Subobject A)\n(deterministic) timeout at `typeclass`, maximum number of heartbeats (20000) has been reached\n</code></pre></div>\n<p>This came up in <a href=\"https://github.com/leanprover-community/mathlib4/pull/23371\">#23371</a>. I don't understand what's happening here. Any ideas are appreciated.</p>",
        "id": 509729356,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743607708
    },
    {
        "content": "<p>It seems to be going through the algebraic hierarchy..</p>",
        "id": 509730415,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743607949
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CanonicallyOrderedAdd.toOrderBot#doc\">docs#CanonicallyOrderedAdd.toOrderBot</a> introduces the algebraic hierarchy</p>",
        "id": 509731082,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743608104
    },
    {
        "content": "<p>I am confused. Do you expect this to succeed?</p>",
        "id": 509732252,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743608387
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Subobject.orderBot#doc\">docs#CategoryTheory.Subobject.orderBot</a> is what should be found?</p>",
        "id": 509732463,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1743608425
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">HasInitial</span><span class=\"w\"> </span><span class=\"n\">C</span>\n</code></pre></div>",
        "id": 509733131,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743608590
    },
    {
        "content": "<p>The problem seems to be the algebraic hierarchy being very slow to fail with 170 typeclasses, which gets traversed 4 times here (for <code>CategoryTheory.Subobject A</code>, for <code>PEmpty.{1}</code>, for <code>∀ (J : Type ?u)</code>, and for <code>∀ (J : Type)</code>)</p>",
        "id": 509733551,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743608704
    },
    {
        "content": "<p>I would expect <a href=\"https://github.com/leanprover-community/mathlib4/pull/23371\">#23371</a> to pass CI - but the simpNF linter times out; the time-out can be reduced to the above.</p>",
        "id": 509733863,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743608786
    },
    {
        "content": "<p>To be clear, this is expected to fail, but it should do so without timing out</p>",
        "id": 509734524,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743608988
    },
    {
        "content": "<p>Rationale: synthesis failures cause <code>simp</code> to ignore the lemma that requested them. Synthesis <em>timeouts</em> cause <code>simp</code> to crash, because the alternative would be a nondeterministic <code>simp</code>.</p>",
        "id": 509734763,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743609043
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/SimpNF.20time-out.20involving.20subobjects.20and.20HasPulbacks/near/509731082\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CanonicallyOrderedAdd.toOrderBot#doc\">docs#CanonicallyOrderedAdd.toOrderBot</a> introduces the algebraic hierarchy</p>\n</blockquote>\n<p>What is the default type-class inference synthesis ordering of lemma arguments? I hope that if we synthesize the last argument (<code>CanonicallyOrderedAdd</code>) first, then it doesn't have to traverse (much of) the algebraic hierarchy?<br>\nMaybe this will also be fixed by <a href=\"https://github.com/leanprover-community/mathlib4/pull/20676\">#20676</a>?</p>",
        "id": 509754706,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1743614755
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/SimpNF.20time-out.20involving.20subobjects.20and.20HasPulbacks/near/509734524\">said</a>:</p>\n<blockquote>\n<p>To be clear, this is expected to fail, but it should do so without timing out</p>\n</blockquote>\n<p>(so <code>set_option synthInstance.maxHeartbeats 40000</code> is a fix)</p>",
        "id": 509766857,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743618609
    },
    {
        "content": "<p>(I don't think we can set that for the simpNF linter)</p>",
        "id": 509768815,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743619237
    },
    {
        "content": "<p>Looking at the trace led me to two problematic type classes:<br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=UnivLE#doc\">docs#UnivLE</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">UnivLE</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Small</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.HasProducts#doc\">docs#CategoryTheory.Limits.HasProducts</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">HasProducts</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">J</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">HasLimitsOfShape</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Discrete</span><span class=\"w\"> </span><span class=\"n\">J</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">C</span>\n</code></pre></div>\n<p>I think they should not be <code>abbrev</code>. Lean has special support for <code>∀</code> binders in type classes, essentially introducing the variable. In this case, it ends up searching the algebraic hierarchy not only for <code>CategoryTheory.Subobject A</code>, but also for <code>∀ α : Type u</code> and for <code>∀ J : Type w</code>. I would suggest to define these type classes as structures, and hopefully not too many instances need to be modified to fix any breakages.</p>\n<p>There's also <code>HasCoProducts</code>, <del><code>Has(Co)Limits</code>, <code>HasPushouts</code> and <code>HasPullbacks</code></del> that are <code>abbrev</code>s for foralls.</p>",
        "id": 509809457,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743635429
    },
    {
        "content": "<p>I don't buy that argument that this is an issue, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=DecidablePred#doc\">docs#DecidablePred</a> is defined in this way (and therefore there is surely native support for this)</p>",
        "id": 509810442,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743635969
    },
    {
        "content": "<p>Unless of course there is some universe complication</p>",
        "id": 509810521,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743636018
    },
    {
        "content": "<p>I was testing this out on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Quiver.IsThin#doc\">docs#Quiver.IsThin</a> <a href=\"https://github.com/leanprover-community/mathlib4/pull/23600\">#23600</a></p>",
        "id": 509811614,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1743636701
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/SimpNF.20time-out.20involving.20subobjects.20and.20HasPulbacks/near/509810442\">said</a>:</p>\n<blockquote>\n<p>I don't buy that argument that this is an issue, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=DecidablePred#doc\">docs#DecidablePred</a> is defined in this way (and therefore there is surely native support for this)</p>\n</blockquote>\n<p>In DecidablePred</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">DecidablePred</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>As long as <code>r</code> is a reasonable term, <code>Decidable (r a)</code> will be a reasonable type class goal. However, I don't think <code>∀ α : Type u, Small.{v} α</code> is much of a reasonable goal.</p>\n<p>In fact, the following searches the entire hierarchy:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">CategoryTheory</span><span class=\"w\"> </span><span class=\"n\">Limits</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">UnivLE</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"n\">v</span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 509812382,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743637143
    },
    {
        "content": "<p>Wow!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"mi\">420</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"bp\">▼</span>\n<span class=\"w\">      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">✅️</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">littleWedderburn</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">▼</span>\n<span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 509812970,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743637543
    },
    {
        "content": "<p>Agreed that that makes <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=UnivLE#doc\">docs#UnivLE</a> very suspect</p>",
        "id": 509813230,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743637721
    },
    {
        "content": "<p>Is <code>HasProducts</code> problematic in the same way though?</p>",
        "id": 509813236,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743637729
    },
    {
        "content": "<p>Maybe not, it could be a matter of reordering the arguments in some instances.</p>",
        "id": 509813271,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743637757
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/SimpNF.20time-out.20involving.20subobjects.20and.20HasPulbacks/near/509813230\">said</a>:</p>\n<blockquote>\n<p>Agreed that that makes <code>UnivLE</code> very suspect</p>\n</blockquote>\n<p>Does this make <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Countable#doc\">docs#Countable</a> suspect too?</p>",
        "id": 509813576,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1743637957
    },
    {
        "content": "<p>No, because it's a structure</p>",
        "id": 509813819,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743638125
    },
    {
        "content": "<p><code>Countable.toSmall</code> in combination with <code>UnivLE</code> creates the nasty goal <code>∀ α : Type u, Countable α</code>.</p>\n<p><code>Countable</code> itself is in some sense suspect, because there are simply a LOT of things that are countable <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> (Similar to <code>Nonempty</code>)</p>",
        "id": 509813925,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743638194
    },
    {
        "content": "<p>I'll make a PR for univLE (edit: <a href=\"https://github.com/leanprover-community/mathlib4/pull/23611\">#23611</a>)</p>",
        "id": 509814723,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743638635
    },
    {
        "content": "<p>A few weeks ago in <a href=\"https://github.com/leanprover-community/mathlib4/pull/22968\">#22968</a> I reordered some instances to avoid \"leaking\" a type class search from category theory into the algebraic hierarchy. But it seems there are a few more bad ones:</p>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.instHasProductsOfShapeOfHasCountableProducts#doc\">docs#CategoryTheory.Limits.instHasProductsOfShapeOfHasCountableProducts</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.instHasLimitsOfShapeOfCountableCategoryOfHasCountableLimits#doc\">docs#CategoryTheory.Limits.instHasLimitsOfShapeOfCountableCategoryOfHasCountableLimits</a><br>\n<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.hasLimitsOfShape_of_hasFiniteLimits#doc\">docs#CategoryTheory.Limits.hasLimitsOfShape_of_hasFiniteLimits</a></p>",
        "id": 509814974,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743638767
    },
    {
        "content": "<p>From the above mentioned, it's actually only <code>Has(Co)Products</code> that is problematic, not the other Limit classes. The particular problem at hand can be solved by adjusting the 3 instances I wrote here. However, I think it would be a more principled solution to make these into structures.</p>",
        "id": 509817279,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743640286
    },
    {
        "content": "<p>All right, I've made a PR for these (<a href=\"https://github.com/leanprover-community/mathlib4/pull/23612\">#23612</a>). It turns out to be the exact same change as <a href=\"https://github.com/leanprover-community/mathlib4/pull/22968\">#22968</a>, but for limits/products instead of colimits/coproducts <span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span></p>\n<p>Edit: yay, it gives a speedup:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">build</span><span class=\"w\">   </span><span class=\"bp\">-</span><span class=\"mf\">97.179</span><span class=\"bp\">⬝</span><span class=\"mi\">10</span><span class=\"bp\">⁹</span><span class=\"w\">     </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mf\">0.05</span><span class=\"bp\">%</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 509819430,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743641698
    },
    {
        "content": "<p>This thread is the mathlib community at its best: I'm posting about a place where I'm stuck, and when I get up the next morning, several people have diagnosed (parts of) the failure and two PRs spawned by this were merged. Thanks a lot!<br>\nI'm incredibly grateful to be part of this community.</p>",
        "id": 509914761,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1743680582
    },
    {
        "content": "<p>It looks like the titular issue is now fixed</p>",
        "id": 509916618,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1743681012
    }
]