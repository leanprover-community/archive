[
    {
        "content": "<p>Hi! I've written a simple wrapper around <code>omega</code> that can solve goals involving <code>PNat</code>s:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">sub_coe'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">mk_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">sub_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">coe_lt_coe</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">split_ifs</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">omega</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Qq</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"omega_preprocess_pnat\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MonadLCtx</span><span class=\"bp\">.</span><span class=\"n\">getLCtx</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MVarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">foldlM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">init</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">declType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">declExpr</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isPNat</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isExprDefEq</span><span class=\"w\"> </span><span class=\"n\">declType</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">PNat</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isPNat</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">pos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">declExpr</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarIdNew</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mvarIdNew</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarIdNew</span><span class=\"bp\">.</span><span class=\"n\">intro1P</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">mvarIdNew</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">g</span>\n<span class=\"w\">    </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">setGoals</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">result</span><span class=\"o\">]</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"omega_pnat\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span>\n\n<span class=\"kn\">macro_rules</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">omega_pnat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">  </span><span class=\"n\">omega_preprocess_pnat</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">coe_inj</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">coe_le_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">coe_lt_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">sub_coe'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">add_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">mul_coe</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"bp\">.</span><span class=\"n\">val_ofNat</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*;</span>\n<span class=\"w\">  </span><span class=\"n\">omega</span>\n<span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PNat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">omega_pnat</span>\n</code></pre></div>\n<p>Would it be worth PRing it in some form?</p>",
        "id": 497154837,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1738407754
    },
    {
        "content": "<p>It just translates <code>PNat</code> arithmetic (<code>+</code>, <code>-</code>, <code>*</code>) into <code>Nat</code>.</p>",
        "id": 497154902,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1738407828
    },
    {
        "content": "<p>Definitely! I don't see any harm in a tactic with a niche but genuine use case.</p>\n<p>Is another perhaps more useful approch to write a <code>nify</code> tactic, which takes goals or hypotheses involving pnats and changes them into equivalent goals involving nats? We have <code>zify</code>, <code>qify</code> etc, so that would fit into the general mathlib pattern. And then maybe <code>nify; omega</code> would be the way to solve many pnat goals.</p>",
        "id": 497155047,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738407937
    },
    {
        "content": "<p>Yes, both routes are great.</p>",
        "id": 497307327,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738542656
    },
    {
        "content": "<p>Maybe something similar can be done for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ENat#doc\">docs#ENat</a>, <code>WithBot Nat</code> (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.degree#doc\">docs#Polynomial.degree</a>), <code>WithBot ENat</code> (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Order.krullDim#doc\">docs#Order.krullDim</a>) ...</p>",
        "id": 497310405,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1738545090
    },
    {
        "content": "<p>Yes, I am working on this.</p>",
        "id": 497373695,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1738574395
    },
    {
        "content": "<p>The PR for <code>ENat</code> and <code>PNat</code> is ready: <a href=\"https://github.com/leanprover-community/mathlib4/pull/21602\">#21602</a></p>",
        "id": 498630790,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1739132466
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"552388\">@Vasily Nesterov</span>, would it be possible to refactor this to provide a <code>enat_to_nat</code> tactic (cases, simplify inequalities, translate), and then <code>enat_omega</code> is just <code>enat_to_nat; omega</code>? I think there would also be independent uses for <code>enat_to_nat</code>.</p>",
        "id": 498651164,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739148946
    },
    {
        "content": "<p>(Similarly for <code>pnat</code>.)</p>",
        "id": 498651168,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739148951
    },
    {
        "content": "<p>How about <code>pnat_to_nat x y z</code> syntax for a tactic that translates variables <code>x</code>, <code>y</code>, <code>z</code> from the context from <code>PNat</code> to <code>Nat</code> and pushes the translation as far as possible?</p>",
        "id": 498819480,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1739208184
    },
    {
        "content": "<p>And similar tactic for <code>ENat</code> (in which case multiple goals might be created).</p>",
        "id": 498822177,
        "sender_full_name": "Vasilii Nesterov",
        "timestamp": 1739208957
    },
    {
        "content": "<p><code>zify</code>, <code>qify</code> and <code>rify</code> don't use this approach and people don't seem to be complaining that they want this fine-grained control.</p>",
        "id": 498832796,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739212102
    },
    {
        "content": "<p>I'd be content with one that just aggressively translates all relevant hypotheses. I think an optional <code>at x y z</code> syntax can't hurt if you want to implement it.</p>",
        "id": 498887779,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739230585
    }
]