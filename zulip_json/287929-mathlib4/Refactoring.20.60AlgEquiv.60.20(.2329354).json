[
    {
        "content": "<p>I'm trying to revive my refactoring PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/29354\">#29354</a> (refactoring <code>AlgEquiv</code> to also work for non-unital - see previous thread <a href=\"#narrow/channel/287929-mathlib4/topic/refactor.20.60StarAlgEquiv.60.20to.20extend.20.60StarRingEquiv.60\">#mathlib4 &gt; refactor &#96;StarAlgEquiv&#96; to extend &#96;StarRingEquiv&#96;</a>), but I came across an error that's beyond me and I can't be bothered anymore (I've tried everything, but I can't figure it out).<br>\nIt's the last error left, it's in the <code>RingTheory/Etale/QuasiFinite</code> file. I would really appreciate it if someone can help me figure out a fix for this <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span><br>\n(<span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span>, because you authored the file, so you might be the best for the job)</p>",
        "id": 575365792,
        "sender_full_name": "Monica Omar",
        "timestamp": 1771870829
    },
    {
        "content": "<p>You need to add </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">integralClosure</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Localization</span><span class=\"bp\">.</span><span class=\"n\">Away</span><span class=\"w\"> </span><span class=\"n\">sâ‚‚</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span>\n</code></pre></div>\n<p>after the <code>let : Algebra</code> line because there's a diamond.</p>",
        "id": 575368941,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1771871715
    },
    {
        "content": "<p>Thank youuu!</p>",
        "id": 575369373,
        "sender_full_name": "Monica Omar",
        "timestamp": 1771871774
    },
    {
        "content": "<p>Why is there a diamond? Is it pre-existing?</p>",
        "id": 575372399,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1771872235
    },
    {
        "content": "<p>Yes it is pre-existing. If <code>S</code> is a subalgebra of <code>R</code>, then <code>S</code> has two algebra instances on <code>R[1/M]</code>: One through <code>S</code> being a subalgebra and another through <code>R[1/M]</code> being a localization.</p>",
        "id": 575373527,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1771872399
    },
    {
        "content": "<p>I see, gross.</p>",
        "id": 575375038,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1771872668
    },
    {
        "content": "<p>benchmark results are still bad: instructions are up +850G (+0.49%)<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/pull/29354#issuecomment-3946596500\">https://github.com/leanprover-community/mathlib4/pull/29354#issuecomment-3946596500</a></p>",
        "id": 575378250,
        "sender_full_name": "Monica Omar",
        "timestamp": 1771873685
    },
    {
        "content": "<p>I'm thinking of a different refactor now for this (<a href=\"https://github.com/leanprover-community/mathlib4/pull/29354\">#29354</a>) which <em>could</em> be better performance wise (but with a con):<br>\nSo the current refactor changes the type classes from <code>Algebra</code> to <code>Mul</code> <code>SMul</code> and <code>Add</code>, but it could be better to instead have <code>NonUnitalSemiring</code> and <code>Module</code> (or even <code>NonUnitalNonAssocSemiring</code> and <code>DistribMulAction</code> like what <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NonUnitalAlgHom#doc\">docs#NonUnitalAlgHom</a> uses).<br>\nThe con is that <code>StarAlgEquiv</code> won't be able to extend <code>AlgEquiv</code>.</p>\n<p>I don't want to waste time and do it without asking if people think this is a good idea or not. So what do we all think?</p>",
        "id": 575585275,
        "sender_full_name": "Monica Omar",
        "timestamp": 1771949648
    },
    {
        "content": "<p><code>StarAlgEquiv</code> could also be made to match.</p>",
        "id": 575981603,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1772100287
    },
    {
        "content": "<p>Changing to <code>NonUnitalNonAssocSemiring</code> and <code>DistribMulAction</code> gives so many unwanted problems. For some reason, type ascriptions are needed almost everywhere.<br>\nSo I strengthened the hypotheses to <code>NonUnitalNonAssocSemiring</code> and <code>Module</code>, which solved those issues. The performance is so much worse than before though.<br>\nI'll try adding <code>SMulCommClass</code> and <code>IsScalarTower</code> so that it's literally just an algebra without a unit. Maybe that would perform better <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 576081601,
        "sender_full_name": "Monica Omar",
        "timestamp": 1772126480
    }
]