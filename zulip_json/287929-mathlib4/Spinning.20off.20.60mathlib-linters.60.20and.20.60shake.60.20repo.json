[
    {
        "content": "<p>I've been working on CI for non-Mathlib projects, and as part of that I would like to spin off the linters and the <code>shake</code> command into their own repositories (let's say <code>leanprover-community/mathlib-linters</code> and <code>leanprover-community/shake</code>), so they can be used by other projects too. What do you think, anything I should keep in mind (e.g. linter PRs that still need reviewing)?</p>",
        "id": 510627331,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744022477
    },
    {
        "content": "<p>i imagine it's good to make sure it <em>does not lint files that are from another project</em>. I.e. it won't shake mathlib when the project depends on mathlib, for example</p>",
        "id": 510627756,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744022584
    },
    {
        "content": "<p>True! Thankfully, this should already be the case. The linters are already disabled by default but can be opted into (see also <a href=\"https://github.com/leanprover-community/mathlib4/pull/23670\">#23670</a>). And <code>shake</code> only runs on files in the same package:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"w\">  </span><span class=\"c1\">-- Only submodules of `pkg` will be edited or have info reported on them</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mods</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!.</span><span class=\"n\">components.head</span><span class=\"bp\">!</span>\n</code></pre></div>\n<p>(Although <code>shake</code> still defaults to running on <code>Mathlib</code>, we should probably use the <code>default_target</code> from the Lakefile instead.)</p>",
        "id": 510629463,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744023066
    },
    {
        "content": "<p>Does your proposal mean \"I'll manually copy the mathlib files\" or \"I propose moving those linters into a shared repository\"?</p>",
        "id": 510647540,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744027402
    },
    {
        "content": "<p>I see no real downside to the former --- if e.g. the mathlib version is the reference copy and you manually sync over things. (Perhaps stick a comment to make changes in mathlib first, then it's good enough.)</p>",
        "id": 510647564,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744027408
    },
    {
        "content": "<p>For the latter, I worry to what extent this would make development of linters harder or slower. At the same time, re-using mathlib infrastructure more widely is certainly nice, so solving these problems could be nice. My worries would be fully assuaged by:</p>\n<ul>\n<li>ensuring changes to the linters repository hit mathlib quickly: perhaps the batteries infrastructure could be re-used here? (Developing linters which require mathlib changes will be annoying; I know core/batteries changes have adaptation branches and so on. This is definite overhead, and would e.g. slow me down slightly.)</li>\n<li>figuring out how to deal with in-flight linter PRs. (One possible policy: files with no open PRs are fine to move up the mathlib-linters repository; for the others, open PRs are merged first. That's also an incentive to review those PRs quickly :-))</li>\n<li>ensuring some visibility into mathlib-linter PRs: such as, hooking up the maintainer merge infrastructure or beefing up the queueboard to include this. </li>\n</ul>\n<p>To be honest, I'm the least sure how to address the last point (and it should certainly not be a blocker to experimenting). But I care quite a bit about this; mathlib reviewers for linters are already missing/stretched thin --- changing to a future where such PRs languish because it's a separate repository is something I'd rather avoid.</p>",
        "id": 510649353,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744027820
    },
    {
        "content": "<p>To emphasize: these are good questions to ask, thanks for starting this discussion! But I am wondering about some bigger-picture questions, that could be good to discuss first.</p>",
        "id": 510649481,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744027852
    },
    {
        "content": "<p>Taking a step back: it's not an option that your projects depend on mathlib, right?</p>",
        "id": 510649572,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744027876
    },
    {
        "content": "<p>Yes, it would be the latter option of moving the files, not copying them.</p>\n<ol>\n<li>Updating the linters should use the same <code>update</code> machinery that we use for other dependencies. One goal of mine in the coming weeks is to make automatic updates like this available everywhere.</li>\n<li>I would be happy to be assigned to review all the linter PRs for the coming time. I think the time between PRs is low enough that we can declare a one-day moratorium to move everything over, and otherwise we can follow the rule you proposed about only moving untouched files. (I see quite a few linter PRs but only two of them are on the review queue.)</li>\n<li>Making sure everything stays on the radar would indeed be a key step. Do you/<span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> have an indication how hard it is to hook up extra repositories to the queueboard? The <code>maintainer merge</code> workflow seems easy enough to copy from the mathlib repo.</li>\n</ol>",
        "id": 510656181,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744029359
    },
    {
        "content": "<p>Maybe it makes sense to put the \"shake\" discussion in a separate thread?</p>",
        "id": 510658226,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744029798
    },
    {
        "content": "<p>My impression is that shake is mostly \"finished\", hence doesn't see much churn. I don't see real downsides to moving that to a separate repository.</p>",
        "id": 510658397,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744029837
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span> Thanks for clarifying. What you're saying sounds very reasonable. You raise a good question about the queueboard.</p>",
        "id": 510658631,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744029885
    },
    {
        "content": "<p>If the aim is to \"have a separate dashboard for separate repositories\", that is definitely on the roadmap (but will require some refactoring - which so far was not-to-high priority). However, we probably want to merge the data from the different repositories (i.e., show one review queue for all repositories together).</p>\n<p>That will require some refactoring, but not too painful. I would estimate that one or two days of work should suffice. (Perhaps less, perhaps more: with CI, it's hard to be sure - and the queueboard is complex enough that unforeseen events do and will happen.)</p>",
        "id": 510659446,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744030063
    },
    {
        "content": "<p>A side comment: when writing a new linter, it is <em>very</em> useful to run it on all of mathlib, fixing bugs and modifying it.  Thus, I am in favour of moving \"established\" linters to a separate repository, but I would rather keep the development of \"new\" linters into mathlib first and then upstream.</p>",
        "id": 510669592,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744032278
    },
    {
        "content": "<p>This also helps making the compliance of mathlib with the linter a non-issue.</p>",
        "id": 510669661,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744032295
    },
    {
        "content": "<p>Good point, we might want to keep a few linters in Mathlib until they are more stable. (The opposite argument for <code>shake</code>, essentially!)</p>",
        "id": 510669879,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744032360
    },
    {
        "content": "<p>Maybe shake should go into the import graph repo?</p>",
        "id": 510711297,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1744041802
    },
    {
        "content": "<p>Shake is in principle independent of import-graph, but I agree both could also be usefully combined into one repo.</p>",
        "id": 510712021,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744041995
    },
    {
        "content": "<p>aren't the linters already in another repo, namely batteries?</p>",
        "id": 510746558,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744052651
    },
    {
        "content": "<p>Many, but not all: mathlib's environment linters and all of its syntax linters are in mathlib</p>",
        "id": 510772040,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744062069
    },
    {
        "content": "<p>Speaking of <code>import-graph</code>, from my experience extracting that script into it's own repository there is the question about maintenance and code review standards.<br>\nFor import-graph I'd say the current state is:</p>\n<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> needs to bump the repo frequently as part of the entire update-routine, but otherwise the repo has very little activity besides me and Kim occasionally pushing a feature without much of a reviewing process. </p>\n<p>For import-graph that's fine because the script isn't really used by any parts of the mathlib workflow. For linters that might not be desirable and you'd probably want more reviewing infrastructure (&amp; people actually looking at the open PRs). I'd probably give Mario's suggestion of upstreaming linters to <code>batteries</code> a thought.</p>",
        "id": 510780166,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1744066324
    },
    {
        "content": "<p>I don't think we should combine <code>shake</code> and <code>import-graph</code> unless there is some positive reason to do so (e.g. an modification to one or the other would require a dependency, <em>and</em> there is some pressure to flatten the dependency structure --- seems very unlikely to me).</p>",
        "id": 510839142,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744089127
    },
    {
        "content": "<p>I think <code>shake</code> is pretty safe, it has barely needed touching since Mario first wrote it. I don't recall if/when we've previously discussed moving <code>shake</code> to a separate repo, so it would be good to get a +1 from Mario on the general principle!</p>",
        "id": 510839204,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744089185
    },
    {
        "content": "<p>I agree that some linters could go in Batteries (and indeed to Lean), but only linters that <em>all</em> Lean users would agree they likely want turned on or available. Anything that is mathematics specific, or part of the opinionated style of Mathlib, should go into <code>mathlib-linters</code>.</p>",
        "id": 510839331,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744089259
    },
    {
        "content": "<p>What's wrong with having disabled opinionated linters in Batteries?</p>",
        "id": 510841139,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744090357
    },
    {
        "content": "<p>How would mathlib enable these? IIUC, there is no good solution for these.</p>",
        "id": 510841599,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744090612
    },
    {
        "content": "<p>(The other reason: batteries doesn't have any syntax linters so far. Though I don't know if that is deliberate.)</p>",
        "id": 510841774,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744090690
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Spinning.20off.20.60mathlib-linters.60.20and.20.60shake.60.20repo/near/510841599\">said</a>:</p>\n<blockquote>\n<p>How would mathlib enable these? IIUC, there is no good solution for these.</p>\n</blockquote>\n<p>If we can't do this then the linter framework isn't ready for use. That's literally how they are supposed to be used</p>",
        "id": 510855977,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744096688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Spinning.20off.20.60mathlib-linters.60.20and.20.60shake.60.20repo/near/510841774\">said</a>:</p>\n<blockquote>\n<p>(The other reason: batteries doesn't have any syntax linters so far. Though I don't know if that is deliberate.)</p>\n</blockquote>\n<p>Batteries has two syntax linters rn IIRC, <code>unreachableTactic</code> and <code>unnecessarySeqFocus</code></p>",
        "id": 510856230,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744096785
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Spinning.20off.20.60mathlib-linters.60.20and.20.60shake.60.20repo/near/510855977\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Spinning.20off.20.60mathlib-linters.60.20and.20.60shake.60.20repo/near/510841599\">said</a>:</p>\n<blockquote>\n<p>How would mathlib enable these? IIUC, there is no good solution for these.</p>\n</blockquote>\n<p>If we can't do this then the linter framework isn't ready for use. That's literally how they are supposed to be used</p>\n</blockquote>\n<p>I don't see why the current approach is broken, having the linter's option disabled by default but enabled in Mathlib's Lakefile. (Ideally we'd add the possibility to declare one option for turning on/off multiple linters at once, but that would require some changes to core Lean afaict; see also <a href=\"https://github.com/leanprover-community/mathlib4/pull/23670\">#23670</a>.)</p>",
        "id": 510892802,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744107405
    },
    {
        "content": "<p>Can the lakefile also be used to control the default setting of <em>environment</em> linters? (So batteries could gain some stable mathlib environment linters, off by default, with mathlib activating them: but it'd be really nice if writing #lint in mathlib also ran the linters mathlib wants.)</p>",
        "id": 510911079,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744113148
    },
    {
        "content": "<p>I had a discussion with <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> on enabling/disabling all linters, and I think we've come up with something useful: we would replace the current <code>set_option linter.all</code> mechanism. There would be a new option, let's call it <code>linter_set</code> that can take multiple values including <code>all</code>, <code>none</code> and <code>default</code>. Depending on which <code>linter_set</code> option we choose, different linters will be enabled by default.</p>\n<p>So in the lakefile we'd write <code>leanOptions := [⟨</code>linter_set, <code>mathlib⟩]</code> and somewhere early on in Mathlib we'd write something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">declare_linter_set</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.hashCommand</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.oldObtain</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.cases</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.cdot</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.docString</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.longFile</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">1500</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n<span class=\"o\">]</span>\n</code></pre></div>\n<p>(syntax is of course bikesheddable!).</p>\n<p>We can also have a <code>recommended</code> linter set for downstream projects, which might be somewhat stronger than <code>default</code> but not as pedantic as <code>mathlib</code>.</p>",
        "id": 510926633,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744117363
    },
    {
        "content": "<p>For environment linters, as long as they use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Linter.getLinterValue#doc\">docs#Lean.Linter.getLinterValue</a> to check if they should be enabled, the same would work.</p>",
        "id": 510926736,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744117388
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Spinning.20off.20.60mathlib-linters.60.20and.20.60shake.60.20repo/near/510926736\">said</a>:</p>\n<blockquote>\n<p>For environment linters, as long as they use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Linter.getLinterValue#doc\">docs#Lean.Linter.getLinterValue</a> to check if they should be enabled, the same would work.</p>\n</blockquote>\n<p>they don't; environment linters use a completely independent framework from regular linters.</p>",
        "id": 510933189,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744118750
    },
    {
        "content": "<p>Oh, is this why sometimes we have to write <code>@[nolint foo]</code> and sometimes <code>set_option linter.foo false in ...</code>?</p>",
        "id": 510936022,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744119321
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Spinning.20off.20.60mathlib-linters.60.20and.20.60shake.60.20repo/near/510839204\">said</a>:</p>\n<blockquote>\n<p>I think <code>shake</code> is pretty safe, it has barely needed touching since Mario first wrote it. I don't recall if/when we've previously discussed moving <code>shake</code> to a separate repo, so it would be good to get a +1 from Mario on the general principle!</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>, can I ask you directly if you think a separate <code>shake</code> repo is a good idea?</p>",
        "id": 510945208,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744121342
    },
    {
        "content": "<p>I'm generally dubious of making new repos, I think they add more maintenance burden and possibility for version mismatches compared to the benefits one gets from them</p>",
        "id": 510945542,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744121420
    },
    {
        "content": "<p>I think the considerations for <code>shake</code> are similar for any other tool that is not very large in terms of metaprogramming code</p>",
        "id": 510945665,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744121461
    },
    {
        "content": "<p>But depending on the whole of mathlib just to be able to run shake would also cause maintenance burden downstream, no?</p>",
        "id": 510946276,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744121614
    },
    {
        "content": "<p>but moving it to batteries would largely mitigate that concern I think?</p>",
        "id": 510946420,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744121644
    },
    {
        "content": "<p>Yes, that should reduce the update burden by quite a lot. Still, <code>shake</code> right now only imports <code>Lean</code> itself, no batteries. So it would still bring in unnecessary dependencies.</p>",
        "id": 510946804,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744121751
    },
    {
        "content": "<p>? Shake would still not import batteries</p>",
        "id": 510947721,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744121961
    },
    {
        "content": "<p>batteries would include shake</p>",
        "id": 510947758,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744121969
    },
    {
        "content": "<p>and this seems to be an argument against any grouping of code</p>",
        "id": 510947857,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744121992
    },
    {
        "content": "<p>I think lake just needs to get gud, I don't like that lake limitations are being used to justify fracturing the ecosystem</p>",
        "id": 510947980,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744122011
    },
    {
        "content": "<p>Okay, let's say we have project A that uses shake and project B that uses A, shake and batteries. Now we add a new feature to shake, so A wants to update. If shake is an independent repo, A and B can do an easy update (which can be entirely automatic using e.g. the <code>lean-update</code> action).</p>\n<p>If shake is part of Batteries, then A can do an easy update (since they don't actually import anything from that library), but B now needs to make fixes to update their Batteries dependency or have a mismatching dependency compared to A.</p>\n<p>Version mismatch is much more of an issue with a language like Lean where implementation details absolutely matter (since e.g. definitional equality is very easy to break). I don't think it's a matter of telling Lake to \"git gud\" to solve that.</p>",
        "id": 510950536,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744122648
    },
    {
        "content": "<p>Regardless, looks like we agree that moving shake to batteries would be an improvement over the status quo.</p>",
        "id": 510951046,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744122781
    },
    {
        "content": "<p>Also shake is what I would call a \"dev dependency\", whether it is used in A should not affect its use in B or A's versioning</p>",
        "id": 510951499,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744122899
    },
    {
        "content": "<p>So I made PRs upstreaming shake to batteries:</p>\n<ul>\n<li><a href=\"https://github.com/leanprover-community/batteries/pull/1204\">batteries#1204</a></li>\n<li>Mathlib adaptation: <a href=\"https://github.com/leanprover-community/mathlib4/pull/23916\">#23916</a></li>\n</ul>",
        "id": 511391566,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1744287024
    },
    {
        "content": "<p>The batteries PR basically looks good to me. (In mathlib, I'd maintainer delegate it, which I cannot do in batteries.)</p>",
        "id": 511407078,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744290883
    },
    {
        "content": "<p>(You can still review batteries PRs using the github interface)</p>",
        "id": 511437395,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744297752
    },
    {
        "content": "<p>I disagree here, and think <code>shake</code> should just be its own repo. There's no positive reason to put in the Batteries, and it's such stable code that there's very little cost to having it in a new repo.</p>\n<p>The positive reason for having it in its own repo is of course that projects which don't otherwise depend on Batteries can more easily use it (e.g. <code>quote4</code>, <code>lean4checker</code>, <code>doc-gen4</code>, <code>verso</code>, <code>lean4-cli</code>, <code>plausible</code>, just naming those in the upstream-of-Mathlib ecosystem).</p>\n<p>(The secondary positive reason is just as an examplar that small modular tools can be independent repositories, just like in the rest of the software universe. :-)</p>",
        "id": 511528193,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744328519
    },
    {
        "content": "<p>What's the status here? <a href=\"https://github.com/leanprover-community/batteries/pull/1204\">batteries#1204</a> and <a href=\"https://github.com/leanprover-community/batteries/pull/1205\">batteries#1205</a> have been lingering for a long while!</p>\n<p>IMHO it makes sense to update and merge these asap and then spinoff to a new repo from batteries when the time is right.</p>\n<p>Many repos could use shake, especially batteries!</p>",
        "id": 530623429,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1753381870
    },
    {
        "content": "<p>Let's proceed. Moving to Batteries is an improvement.</p>",
        "id": 530683227,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753412725
    },
    {
        "content": "<p>I've hit merge on <a href=\"https://github.com/leanprover-community/batteries/pull/1204\">batteries#1204</a>.</p>",
        "id": 530683237,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753412733
    },
    {
        "content": "<p>Thanks! I look forward to seeing what this will bring.<br>\nOne practical detail though: right now, the mathlib and batteries versions of shake have diverged: <a href=\"https://github.com/leanprover-community/mathlib4/pull/24255\">#24255</a> (auto-detecting which modules to shake) is in mathlib, but the batteries analogue <a href=\"https://github.com/leanprover-community/mathlib4/pull/1205\">#1205</a> is not merged --- it would be good to land that PR (and double-check things coincide) before merging the mathlib adaptation.</p>",
        "id": 530706609,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1753427079
    },
    {
        "content": "<p>Ah, okay. I will just reset it to the Mathlib state, I think.</p>",
        "id": 530718151,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753431251
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/1205\">batteries#1205</a> now has merge conflicts that I don't want to fix.</p>",
        "id": 530718187,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753431264
    },
    {
        "content": "<p>I think at one point we discussed putting shake in importgraph instead. Did this turn out to be impractical?</p>",
        "id": 530718662,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753431410
    },
    {
        "content": "<p>Why would we want to do that? It's downstream of Batteries, so while it's better than leaving it in Mathlib, it's worse than putting it in Batteries or a standalone repo.</p>",
        "id": 530720789,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753432030
    },
    {
        "content": "<p>In any case, I've updated <a href=\"https://github.com/leanprover-community/batteries/pull/1205\">batteries#1205</a>, including shaking batteries.</p>",
        "id": 530721058,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753432117
    },
    {
        "content": "<p>Ah, I forgot that depends on batteries. The motivation was that pruning an import graph sounds very related to analyzing it for other tasks.</p>",
        "id": 530721961,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753432432
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Spinning.20off.20.60mathlib-linters.60.20and.20.60shake.60.20repo/near/530721058\">said</a>:</p>\n<blockquote>\n<p>In any case, I've updated <a href=\"https://github.com/leanprover-community/batteries/pull/1205\">batteries#1205</a>, including shaking batteries.</p>\n</blockquote>\n<p>The \"shaking batteries\" portion of the PR looks good to me.</p>",
        "id": 530858031,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1753482546
    }
]