[
    {
        "content": "<p>In the following example I define a class <code>foo a</code> which I assume can be proven given some (variable) predicate <code>P</code> holds on <code>a</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span><span class=\"w\"> </span><span class=\"c1\">-- failed to synthesize</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×'</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">×'</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>\n<p>Lean fails to infer that <code>foo a</code> given <code>P a</code> after I have established this fact already. The second way I phrased it works, but maybe will lead to class inference problems later on?</p>",
        "id": 540624245,
        "sender_full_name": "joseph hua",
        "timestamp": 1758418514
    },
    {
        "content": "<p>Typeclass instance isn't able to just pull stuff out of the context</p>",
        "id": 540624758,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758419383
    },
    {
        "content": "<p>in the first part it doesn't know about <code>ha : P a</code></p>",
        "id": 540624764,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758419397
    },
    {
        "content": "<p>but in the second part it's looking for a <code>foo x.1</code> so it can unify <code>x</code></p>",
        "id": 540624781,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758419423
    },
    {
        "content": "<p>if you're really sure you want to use typeclass you might want to try out <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fact#doc\">docs#Fact</a></p>",
        "id": 540624818,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758419499
    },
    {
        "content": "<p>so basically typeclass doesn't know about <code>ha</code> and it can't find it, and it doesn't know about <code>x</code> but it <em>can</em> find it because the typeclass goal contains an <code>x</code></p>",
        "id": 540624892,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758419612
    },
    {
        "content": "<p>Ooh, I forgot out <code>Fact</code>. I will experiment and see how well it works. Thanks!</p>",
        "id": 540625242,
        "sender_full_name": "joseph hua",
        "timestamp": 1758420100
    },
    {
        "content": "<p>I think using <code>Fact</code> is strongly discouraged outside of a few \"standard\" usages. Can you instead make <code>P</code> into its own typeclass? Can you somehow tweak your junk values or whatnot to not require the usage of <code>P</code>? It's hard to say what the best solution is without knowing what exactly you're trying to do.</p>",
        "id": 540638964,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1758439930
    },
    {
        "content": "<p>Sorry yes, here is the use case</p>\n<p>I would  like that any <code>CategoryTheory.MorphismProperty</code> satisfying <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/CategoryTheory/MorphismProperty/Limits.html#CategoryTheory.MorphismProperty.HasPullbacks\"><code>CategoryTheory.MorphismProperty.HasPullbacks</code></a> to have some inference support such as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- `P` has pullbacks if for every `f` satisfying `P`, pullbacks of arbitrary morphisms along `f`</span>\n<span class=\"sd\">exist. -/</span>\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">HasPullbacks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hasPullback</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">HasPullback</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">HasPullbacks</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasPullback</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">HasPullbacks</span><span class=\"bp\">.</span><span class=\"n\">hasPullback</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"c1\">-- error cannot find synthesization order for instances</span>\n\n<span class=\"c1\">-- The following works though</span>\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"s2\">\" ⟶(\"</span><span class=\"n\">P</span><span class=\"s2\">\") \"</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">HasPullbacks'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">hasPullback</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasPullback</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">HasPullbacks'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HasPullback</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">HasPullbacks'</span><span class=\"bp\">.</span><span class=\"n\">hasPullback</span><span class=\"w\"> </span><span class=\"n\">g</span>\n</code></pre></div>",
        "id": 540653630,
        "sender_full_name": "joseph hua",
        "timestamp": 1758456788
    },
    {
        "content": "<p>what kind of <code>P</code> are you intending to use it with</p>",
        "id": 540653699,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758456862
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Class.20inference.20inferring.20propositional.20arguments/near/540653699\">said</a>:</p>\n<blockquote>\n<p>what kind of <code>P</code> are you intending to use it with</p>\n</blockquote>\n<p>Eventually, isofibrations in the category of groupoids, but I would like to reason about a general variable <code>P</code> to develop some theory</p>",
        "id": 540653809,
        "sender_full_name": "joseph hua",
        "timestamp": 1758456934
    },
    {
        "content": "<p><del>could you perhaps</del> no that doesn't work</p>",
        "id": 540653849,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758456971
    },
    {
        "content": "<p>hmm</p>",
        "id": 540653860,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758456974
    },
    {
        "content": "<p>how many pullbacks do you expect to see</p>",
        "id": 540653886,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758457013
    },
    {
        "content": "<p>if it's not too much then you could just assume the necessary pullbacks for each theorem</p>",
        "id": 540653918,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758457043
    },
    {
        "content": "<p>I'm not too sure how many pullbacks I will need, but I feel like we shouldn't be using <code>HasPullback f g</code> if we cannot infer it</p>",
        "id": 540655892,
        "sender_full_name": "joseph hua",
        "timestamp": 1758459031
    },
    {
        "content": "<p>you can infer it if <code>P</code> is a typeclass</p>",
        "id": 540656061,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758459221
    },
    {
        "content": "<p>but free variables are not typeclasses so...</p>",
        "id": 540656072,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1758459236
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133584\">joseph hua</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Class.20inference.20inferring.20propositional.20arguments/near/540653809\">said</a>:</p>\n<blockquote>\n<p>I would like to reason about a general variable <code>P</code></p>\n</blockquote>\n<p>I'm afraid you might have to insert <code>let := pullbackOfP hp</code> in each theorem</p>",
        "id": 540754788,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758534415
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/432a037a7f67dfd6d390629429706ca5180ade56/Mathlib/Analysis/Seminorm.lean#L1087\">https://github.com/leanprover-community/mathlib4/blob/432a037a7f67dfd6d390629429706ca5180ade56/Mathlib/Analysis/Seminorm.lean#L1087</a></p>",
        "id": 540755022,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1758534488
    }
]