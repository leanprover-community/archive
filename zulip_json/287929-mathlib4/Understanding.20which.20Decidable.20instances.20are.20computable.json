[
    {
        "content": "<p>I was frustrated that the <code>decide</code> tactic couldn't handle <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Multiset.decidableForallMultiset#doc\">docs#Multiset.decidableForallMultiset</a>, or most decidability instances involving Multisets -- and a result, anything about Finset, Fintype, etc. It's built on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Quot.recOnSubsingleton#doc\">docs#Quot.recOnSubsingleton</a> , which uses Eq.ndrec. I wanted to try to write a better decidability instance, but I kept running into the same problem.</p>\n<p>Ultimately everything ends with having something like <code>Decidable (p (q : @Quotient T s))</code> and I know it's equivalent to <code>Decidable (p' q.unquot)</code>. But, I can't write that of course. The only thing I can figure out how to write is using some kind of <code>Quotient.lift.decidablePred</code>, but then that all ultimately boils down to Quot.ind giving some proof and Eq.rec.</p>\n<p>I would like to be able to Quot.lift a DecidablePred up, but <code>Decidable</code> has data, so Quot.lift doesn't actually apply here.</p>\n<p>Of course, this is all fine for <code>native_decide</code>, because it just looks at the VM internal representation. But I can't for the life of me find a way to make this work.... is there a way to make decide works with quotients, at all?</p>",
        "id": 482430599,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1731601014
    },
    {
        "content": "<p>I think we can write a <code>Bool</code> value decision function using <code>Quot.lift</code> first.</p>",
        "id": 482435091,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1731602251
    },
    {
        "content": "<p>I dispute the use of \"bad\" to describe decidable instances like this. Decidable instances are useful both for computation and for reduction, and supporting just one of these doesn't make the instance bad.</p>",
        "id": 482437410,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731602901
    },
    {
        "content": "<p>(supporting <em>neither</em> is probably a good candidate for the label \"bad\")</p>",
        "id": 482437469,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731602921
    },
    {
        "content": "<p>Are there any examples that <code>decide</code> failed?</p>",
        "id": 482437586,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1731602955
    },
    {
        "content": "<p>Yeah, this works fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Multiset</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 482437929,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731603054
    },
    {
        "content": "<p>Oh, I made a very silly mistake. That is a computable (\"good\", with apologies to Eric) decidability instance. I was reading the logs wrong. The issue was with a different instance, one I had defined locally that was also getting mixed up in there. I was thrown off because (1) the Multiset instance was at the end, and (2)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">decidableForallMultiset</span>\n</code></pre></div>\n<p>prints</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">  </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"bp\">▸</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">lift</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">          </span><span class=\"bp\">⟨</span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">,</span>\n<span class=\"w\">            </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"bp\">.</span><span class=\"n\">unit</span><span class=\"bp\">⟩</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"w\"> </span><span class=\"n\">tail_ih</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">                    </span><span class=\"bp\">⟨</span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">)</span>\n<span class=\"w\">                        </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">isFalse</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h_1</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">isTrue</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">tail_ih</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"o\">),</span>\n<span class=\"w\">                      </span><span class=\"n\">tail_ih</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n<span class=\"w\">                  </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n</code></pre></div>\n<p>so, that looked to me like it was starting right off with Eq.rec. Why _is_ that a computable instance, then, when it reduces to that?</p>",
        "id": 482443873,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1731604738
    },
    {
        "content": "<p>(My original question is moot -- I'll change the topic and, if anyone can answer my sillier follow-up question which is purely out of curiosity, I'll close the topic)</p>",
        "id": 482443992,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1731604775
    },
    {
        "content": "<p>I claim that <code>#reduce</code> and <code>decide</code> are nothing to do with whether a <code>Decidable</code> instance is computable</p>",
        "id": 482446276,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731605453
    },
    {
        "content": "<p>You're probably right and I'm probably using the words wrong then. :) So I'll try to ask more questions.<br>\n(1) What is the word for \"this Decidable instance plays nicely with <code>decide</code>\"? I guess it's not \"computable\".<br>\n(2) How do I recognize if a Decidable instance will play nicely with <code>decide</code>? I thought (part of) it is that if you end up at an <code>Eq.rec</code> at the head, then you're in trouble, because this won't reduce any more to either True or False. And this is why we should avoid <code>rw</code> in Decidable instances. And so I thought <code>#reduce</code> was a good check to see if this was the case or not.</p>",
        "id": 482447258,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1731605791
    },
    {
        "content": "<p>1) Kernel-reducible<br>\n2) Eq.rec is fine if the equality passed to it is <code>rfl</code> (aka the two sides of the equality are defeq)</p>",
        "id": 482448133,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731606087
    },
    {
        "content": "<p>Try using <code>native_decide</code> to see whether the instance is computable. If that fails, then <code>decide</code> almost surely can't work.</p>",
        "id": 482448819,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731606316
    },
    {
        "content": "<p>There's also <code>decide +kernel</code> for using kernel reduction (or maybe it's still <code>decide!</code> in this release). <code>decide</code> by itself uses elaborator reduction, which can get stuck for various additional reasons.</p>",
        "id": 482449042,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731606392
    },
    {
        "content": "<p>The issue with <code>Eq.rec</code> at the head is that reduction doesn't usually reduce types, which is necessary to detect whether the proof is defeq to <code>rfl</code>. To get reduction to work with <code>decide</code>, yes, it's bets to avoid <code>rw</code>/<code>simp</code>/etc. in the \"data part\" of a Decidable instance. The <code>decide</code> tactic gives hints about how to do rewrites instead: use one of the <code>iff</code> theorems that transform the proposition into another one. These push the <code>Eq.rec</code> into the proof, so reduction can't get stuck.</p>",
        "id": 482449450,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731606529
    },
    {
        "content": "<p>I don't think that's quite right; the issue is that the <code>Eq.rec</code> is usually over propositions that are not defeq (or otherwise the rewrite wouldn't have been necessary), and the proof is not <code>rfl</code>, it is <code>propext</code> applied to some proof term. This is genuinely a stuck term in the type theory</p>",
        "id": 482450796,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731606964
    },
    {
        "content": "<p>axioms in general break \"canonicity\"</p>",
        "id": 482450844,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731606978
    },
    {
        "content": "<p>To restore canonicity, you need a type theory that can compute <code>propext</code> (aka univalence for Prop), i.e. cubical type theory</p>",
        "id": 482451127,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731607067
    },
    {
        "content": "<p>or just follow the instructions and use <code>decidable_of_iff</code> instead of <code>rw</code> on <code>Decidable</code> values</p>",
        "id": 482451273,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731607100
    },
    {
        "content": "<p>(Thanks, when it comes to this theory I don't really know what I'm talking about. Someone once told me that for closed terms, the Eq.recs <em>should</em> all be reducible, but surely that can't be true when there are axioms.)</p>",
        "id": 482452015,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731607328
    },
    {
        "content": "<p>If rw/simp was better at using <code>iff</code> directly instead of just applying <code>propext</code> then they could generate terms that reduce</p>",
        "id": 482452263,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731607407
    },
    {
        "content": "<p>(this is related to \"generalized rewrite\")</p>",
        "id": 482452423,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1731607445
    },
    {
        "content": "<p>ohboyohboy this is rapidly going over my head.<br>\nWell in this case I just brainfarted last night and accidentally used <code>simp_rw</code> even when I should have known I wasn't supposed to. And not doing that and using decidable_of_iff (like I knew I should) fixed everything just fine.</p>\n<p>But I would still like to understand, maybe, why <code>Multiset.decidableForallMultiset</code> works when it \"looks\" to my naive eye like it shouldn't. The <code>Eq</code> that it's <code>rec</code>ing on is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">liftIndepPr1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">decidable_of_iff</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">decidableForallMultiset</span><span class=\"bp\">.</span><span class=\"n\">proof_2</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">recOnSubsingleton</span><span class=\"bp\">.</span><span class=\"n\">proof_1</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">decidable_of_iff</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">decidableForallMultiset</span><span class=\"bp\">.</span><span class=\"n\">proof_2</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">m</span>\n<span class=\"o\">:</span>\n<span class=\"o\">(</span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Quot</span><span class=\"bp\">.</span><span class=\"n\">indep</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">decidable_of_iff</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⋯</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>\n<p>That <code>proof_2</code> in turn uses propext and Quot.sound. And these use <code>Quot.ind</code> and <code>Quot.lift</code>, which I know aren't axioms per-se but also don't seem like something that should be reducible exactly? Or is that somehow special here?</p>",
        "id": 482452851,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1731607601
    },
    {
        "content": "<p>Where are you seeing the Eq.rec? I was just looking at <code>Multiset.decidableForallMultiset</code>, and what I'm seeing is that <code>Quotient.recOnSubsingleton</code> extracts the underlying List <code>l</code> out of the Multiset and then evaluates the decidable instance for <code>∀ a ∈ l, p a</code>, with all the proofs safely tucked away using <code>decidable_of_iff</code></p>",
        "id": 482453544,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731607837
    },
    {
        "content": "<p><code>Quotient.recOnSubsingleton</code> is also \"reduction-safe\" because in the end it's <code>Quot.rec</code>, and the proof doesn't need to reduce to reduce <code>Quot.rec</code>.</p>",
        "id": 482453682,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731607896
    },
    {
        "content": "<p>That's just what I got from <code>#reduce @Multiset.decidableForallMultiset</code>. The result started with Eq.rec. I thought this output would reflect what <code>decide</code> would end up with. I guess I was wrong. I don't understand your comment about <code>Quot.rec</code> being \"safe\", or what the proof needs to reduce or not.</p>\n<p>(If I'm asking questions that are too far afield and there's somewhere I should go to read up on this better without bothering y'all, do let me know!)</p>",
        "id": 482458882,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1731609886
    },
    {
        "content": "<p>Oh, so it does. It looks like <code>Quot.rec</code> starts with a rewrite, huh. I was misremembering, thinking that <code>Quot.rec</code> was more low-level.</p>",
        "id": 482459835,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1731610253
    }
]