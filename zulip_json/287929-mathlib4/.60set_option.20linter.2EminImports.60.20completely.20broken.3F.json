[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, it now gives me completely garbage output. Could you take a look?</p>\n<p>e.g. saying \"import increased by &gt;2000\" on multiple consecutive lines, part way through the file reverting to thinking there are very few imports, etc.</p>",
        "id": 493504512,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736826334
    },
    {
        "content": "<p>e.g. in Mathlib.Analysis.Asymptotics.Asymptotics</p>",
        "id": 493504902,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736826507
    },
    {
        "content": "<p>Has parsing of the file become non-linear?</p>",
        "id": 493524541,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736838991
    },
    {
        "content": "<p>I won't have time to look at this until the late afternoon today, but when I opened the file it takes forever to even start doing anything and then every message appears at once.</p>",
        "id": 493524616,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736839037
    },
    {
        "content": "<p>The linter stores the information about what the accumulated imports are in an IO.Ref and uses that to figure out whether they increased or not.</p>",
        "id": 493524672,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736839077
    },
    {
        "content": "<p>So, if the file is parsed linearly, it does what it is expected to do, but otherwise, it will be reading unreliable information from the IO.Ref.</p>",
        "id": 493524773,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736839110
    },
    {
        "content": "<p>I am investigating this now and I think that the culprit is <code>Elab.async</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">MinImports</span>\n\n<span class=\"c1\">--set_option Elab.async false  -- with this line commented, all examples below trigger</span>\n<span class=\"w\">                               </span><span class=\"c1\">-- an import bump, otherwise, only the first one does</span>\n\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">minImports</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 493672535,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736889589
    },
    {
        "content": "<p>I propose \"linking\" the <code>minImport</code> option and the <code>Elab.sync</code> option: setting the <code>minImport</code> option to <code>true</code> should also set the <code>Elab.sync</code> to <code>false</code>.</p>",
        "id": 493672691,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736889644
    },
    {
        "content": "<p>For instance, there could be a <code>#import_bumps</code> macro that expands to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">minImports</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>",
        "id": 493673279,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736889871
    },
    {
        "content": "<p>Alternatively, there could simply be a message that <code>set_option linter.minImports true</code> emits that tells you to also use <code>set_option Elab.async false</code> for usability.</p>",
        "id": 493673465,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736889960
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20755\">#20755</a></p>",
        "id": 493679528,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736892503
    }
]