[
    {
        "content": "<p>Please can someone advise why the following mwe doesn't work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Normed</span><span class=\"bp\">.</span><span class=\"n\">Lp</span><span class=\"bp\">.</span><span class=\"n\">ProdLp</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">NormedSpace</span><span class=\"bp\">.</span><span class=\"n\">MStructure</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">WithL1</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Filter</span><span class=\"w\"> </span><span class=\"n\">RCLike</span><span class=\"w\"> </span><span class=\"n\">Bornology</span><span class=\"w\"> </span><span class=\"n\">Uniformity</span><span class=\"w\"> </span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"bp\">‚àû</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">]</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">End</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">P2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">End</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">P1_idempotent</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsIdempotentElem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">End</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsIdempotentElem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">P1</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)]</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instProdNormedAddCommGroup</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">       </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">instProdNormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">P1_Lprojection</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsLprojection</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">End</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">WithL1</span>\n</code></pre></div>\n<p>Lemma <code>P1_Lprojection</code> (which I know is only true with the current def with p=1) produces the error message:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>What am missing?</p>\n<p>Thanks and Happy New Year!</p>\n<p>Christopher</p>",
        "id": 491502862,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735740738
    },
    {
        "content": "<p>i think you're looking for this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">P1_Lprojection</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsLprojection</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">End</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 491503148,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735741012
    },
    {
        "content": "<p>This works as a statement:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">P1lproj</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">letI</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">instProdNormedAddCommGroup</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">IsLprojection</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">instProdNormedAddCommGroup</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">End</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>But then I get the same <code>failed to synthesize  NormedAddCommGroup (WithLp p Œ± √ó Œ≤)</code> message when trying to fill in the proof.</p>",
        "id": 491503180,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735741039
    },
    {
        "content": "<p>i'm not sure why you're using <code>WithLp p </code> without the brackets... you do realise that it only does things when the argument is a pi type or product?</p>",
        "id": 491503266,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735741099
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/NormedAddCommGroup.20.28WithLp.20p.20.CE.B1.20.C3.97.20.CE.B2.29/near/491503148\">said</a>:</p>\n<blockquote>\n<p>i think you're looking for this:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">P1_Lprojection</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">IsLprojection</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">End</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Thanks - thought I'd tried that, but obviously not. It looks like it works!</p>",
        "id": 491503408,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735741244
    },
    {
        "content": "<p>i.e. <code>WithLp p Œ± √ó Œ≤</code>(which gets bracketed as <code>(WithLp p Œ±) √ó Œ≤</code>)  means \"put the Lp norm on <code>Œ±</code>, then use the maximum of the norms on the product\", which i'm guessing doesn't respect addition?</p>",
        "id": 491503436,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735741271
    },
    {
        "content": "<p>Ah, it should be <code>WithLp p (Œ± √ó Œ≤)</code>  not <code>WithLp p Œ± √ó Œ≤</code> - that was my typo.</p>",
        "id": 491503528,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735741333
    },
    {
        "content": "<p>I've drafted a PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/20380\">#20380</a> - needs work though. Showing:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"bp\">‚Äñ</span>\n</code></pre></div>\n<p>for <code>(x : WithLp p (Œ± √ó Œ≤))</code> <code>0 &lt; p &lt; ‚àû</code> seems surprisingly difficult.</p>",
        "id": 491519119,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735755880
    },
    {
        "content": "<p>do you mean <code>‚Äñ(WithLp.equiv p (Œ± √ó Œ≤)).symm (x.1,0)‚Äñ</code>, btw?</p>",
        "id": 491520304,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735757128
    },
    {
        "content": "<p>otherwise lean might think you mean the maximum norm of <code>Œ± √ó Œ≤</code></p>",
        "id": 491520320,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735757153
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> it's here: <a href=\"https://github.com/leanprover-community/mathlib4/pull/20380/files#diff-cb790f5ea1d9fce79724cd8acc3c53dab6d56b3c3e5f1d3b8844a0f9ad8ec162R356\">https://github.com/leanprover-community/mathlib4/pull/20380/files#diff-cb790f5ea1d9fce79724cd8acc3c53dab6d56b3c3e5f1d3b8844a0f9ad8ec162R356</a></p>\n<p>on the left, <code>@norm Œ± NormedAddCommGroup.toNorm x.1 : ‚Ñù</code> and on the right <code>@norm (WithLp p (Œ± √ó Œ≤)) (WithLp.instProdNorm p Œ± Œ≤) (x.1, 0) : ‚Ñù</code>.</p>",
        "id": 491521022,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735757861
    },
    {
        "content": "<p>right.... my main concern here is that(from the snippets you send) you are abusing the fact that <code>WithLp p</code> is the identity. this is bad from a lemma application pov</p>",
        "id": 491521205,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735758023
    },
    {
        "content": "<p>i think this file might benefit from the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">equiv</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">fst</span>\n<span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">equiv</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">snd</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">prod_fst</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">prod_snd</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>with this, the simp normal form at least is immediately type correct.</p>",
        "id": 491525264,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735761958
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> isn't that essentially what <code>WithLp.equiv_fst</code> and <code>WithLp.equiv_snd</code> do?</p>\n<p>Did you mean for this to be added to <code>Analysis/Normed/Lp/ProdLp</code>?</p>",
        "id": 491528174,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735765062
    },
    {
        "content": "<p>no. currently, the normal form uses <code>Prod.fst</code> and <code>Prod.snd</code>, which forces defeq abuse</p>",
        "id": 491528234,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765095
    },
    {
        "content": "<p>making <code>WithLp.fst</code> and -<code>snd</code> available in the file makes it automagically use this version tho, so the fix is <em>very</em> light</p>",
        "id": 491528277,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765149
    },
    {
        "content": "<p>aamof, the change really only needs 3 lines of code on all of mathlib, imma PR this in a minute</p>",
        "id": 491528304,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765179
    },
    {
        "content": "<p>I'm not sure this is actually a good idea</p>",
        "id": 491528386,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735765222
    },
    {
        "content": "<p>how so? this removes defeq abuse?</p>",
        "id": 491528410,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765240
    },
    {
        "content": "<p>Certainly I don't like the strategy of having simp lemmas that use defeq abuse to try and avoid later defeq abuse</p>",
        "id": 491528418,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735765250
    },
    {
        "content": "<p>those simp lemmas i posted actually aren't necessary, i think...</p>",
        "id": 491528444,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765292
    },
    {
        "content": "<p>i compiled mathlib without them</p>",
        "id": 491528447,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765301
    },
    {
        "content": "<p>From my perspective, the main difficulty I was having was showing that:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">toReal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">toReal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>\n<p>This is almost <code>NNReal.rpow_inv_rpow_self</code> but not quite.</p>",
        "id": 491528523,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735765361
    },
    {
        "content": "<p>As for <code>x.1</code> vs <code>(WithLp.equiv p (Œ± √ó Œ≤) x).fst</code> when <code>x : WithLp p (Œ± √ó Œ≤)</code>, I think the latter is indeed the more principled, but in practice I think it just creates boilerplate. We already have something similar with <code>x : WithLp p (Œ± ‚ÜíŒ≤)</code>and <code>x i</code>, and seem to largely get away with it</p>",
        "id": 491528537,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735765383
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"373192\">Christopher Hoskin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/NormedAddCommGroup.20.28WithLp.20p.20.CE.B1.20.C3.97.20.CE.B2.29/near/491528523\">said</a>:</p>\n<blockquote>\n<p>This is almost <code>NNReal.rpow_inv_rpow_self</code> but not quite.</p>\n</blockquote>\n<p>It would certainly help if we were consistent in choosing between <code>x ^ (1 / p)</code> and <code>x ^ (p‚Åª¬π)</code>. My preference would be for the latter...</p>",
        "id": 491528578,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735765437
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/NormedAddCommGroup.20.28WithLp.20p.20.CE.B1.20.C3.97.20.CE.B2.29/near/491528537\">said</a>:</p>\n<blockquote>\n<p>but in practice I think it just creates boilerplate</p>\n</blockquote>\n<p>from my local build run, it looks like the boilerplate already exists, but just using the wrong function <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 491528653,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765491
    },
    {
        "content": "<p>no added simp lemmas needed, sheer existance of these functions seems to make all defeq abuse fly away</p>",
        "id": 491528747,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765569
    },
    {
        "content": "<p>A little more precisely, I think the issue with <a href=\"https://github.com/leanprover-community/mathlib4/pull/20380\">#20380</a> is not defeq abuse of <code>fst</code> and <code>snd</code>, but defeq abuse of <code>Prod.mk</code></p>",
        "id": 491528828,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735765669
    },
    {
        "content": "<p>all that aside, i am of the opinion that <code>WithLp.equiv</code> is the wrong way around (or should come in the opposite flavour too)</p>",
        "id": 491528914,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735765747
    },
    {
        "content": "<p>Regarding the original topic, does <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WihLp.norm_equiv_symm_fst#doc\">docs#WihLp.norm_equiv_symm_fst</a> make the proof any easier?</p>",
        "id": 491529558,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735766464
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20385\">#20385</a></p>",
        "id": 491529690,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735766640
    },
    {
        "content": "<p>Indeed,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">prod_norm_eq_add_P1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">toReal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Äñ</span><span class=\"n\">P1</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">toReal</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">P1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">toReal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">toReal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">prod_norm_eq_add</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">norm_equiv_symm_fst</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">WithLp</span><span class=\"bp\">.</span><span class=\"n\">norm_equiv_symm_snd</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">P1_compl</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>works</p>",
        "id": 491529781,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735766740
    },
    {
        "content": "<p>Generally much of the LP library unecessarily assumes <code>[Fact (1 ‚â§ p)] </code> when it doesn't need it; I tried to fix this last year in <a href=\"https://github.com/leanprover-community/mathlib4/pull/20389\">#20389</a> (which I just promoted from a branch to a draft PR)</p>",
        "id": 491529789,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735766756
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"684366\">@Edward van de Meent</span> <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> thanks very much for your help. I've updated <a href=\"https://github.com/leanprover-community/mathlib4/pull/20380\">#20380</a> to use <code>WithLp.norm_equiv_symm_fst</code> and <code>WithLp.norm_equiv_symm_snd</code> with <code>[Fact (1 ‚â§ p)]</code> for now.</p>",
        "id": 491578188,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1735807033
    }
]