[
    {
        "content": "<p>I can't recall if I've asked this before but it is an issue.</p>\n<p>Suppose one has a <code>def</code> which defines a synonym to a structure for some special case. I would like to avoid using <code>abbrev</code> because I don't want this definition to be transparent, but it would be convenient to still generate projections - I want to do this using projection functions defined on my <code>def</code>, though, not the original projection functions defined on the more general type.</p>\n<p>I would like to be able to use <code>simps</code> to generate these automatically... and I can: but actually it generates the latter, simps projections using the original (despite using <code>def</code>).</p>\n<p>However, I cannot initialize_simps_projections because my def isn't recognised as a struct.</p>\n<p>Here's what I think is an MWE.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">myStruct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mySpecificStruct</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myStruct</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps!</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMyStructThree</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myStruct</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">myMyStructThree_foo_val</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">myMyStructThree_bar</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps!</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMyStructTwo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myStruct</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">myMyStructTwo_foo_val</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">myMyStructTwo_bar_val</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps!</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myMySpecificStruct</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">mySpecificStruct</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"w\">  </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">myMySpecificStruct_foo_val</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">myMySpecificStruct_bar_val</span>\n\n<span class=\"c1\">-- initialize_simps_projections myMySpecificStruct (PANIC)</span>\n</code></pre></div>\n<p>As you can see, in fact attempting to run <code> initialize_simps_projections myMySpecificStruct</code> causes Lean to crash. But I would still like to use <code>simps</code> in this way! It is causing an actual issue in practice, because when, say, there is an instance of <code>FunLike</code> on both <code>mySpecificStruct</code> and <code>myStruct</code>, the simps projections generated use the latter but you will generally be in the former case when actually applying it - and simps can't see through the def so it gets stuck - i.e. the simps lemmas generated are not useful! It would be alright if one was forbidden from using <code>simps</code> at all here because then it would at least force you to create lemmas manually - it is unintuitive that it silently creates non-useful simps lemmas.</p>",
        "id": 560586075,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1764246817
    },
    {
        "content": "<p>I agree that this would be useful to implement.</p>",
        "id": 560625104,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1764257719
    },
    {
        "content": "<p>One way I guess would be to use an empty \"extends\"?</p>",
        "id": 560626617,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1764258129
    },
    {
        "content": "<p>But that seems a bit funny</p>",
        "id": 560626643,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1764258139
    }
]