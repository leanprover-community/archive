[
    {
        "content": "<p>In a <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/11900917375/job/33162792105?pr=14986\">recent CI run</a>, I noticed this output from the \"test mathlib\" stage:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>⚠ [5831/5840] Built MathlibTest.AssertImported\nwarning: ././././MathlibTest/AssertImported.lean:9:0: ❌️ 'CStarAlgebra.star' (declaration) asserted in 'Mathlib.Topology.ContinuousMap.Bounded.Basic'.\n---\n✅️ means the declaration or import exists.\n❌️ means the declaration or import does not exist.\n</code></pre></div>\n<p>This does not lead to a CI failure, but out of curiosity: is this intended?</p>",
        "id": 483123791,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1731964144
    },
    {
        "content": "<p>I assume not</p>",
        "id": 483124257,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1731964329
    },
    {
        "content": "<p>I agree that this is not as intended.  The test reports a warning, but maybe the setting used to run the tests is not \"warning as failures\".</p>",
        "id": 483124951,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731964602
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span></p>",
        "id": 483125992,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1731964979
    },
    {
        "content": "<p>Seems to have been introduced in <a href=\"https://github.com/leanprover-community/mathlib4/pull/19187\">#19187</a>.</p>",
        "id": 483125993,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731964980
    },
    {
        "content": "<p>At <a href=\"https://github.com/leanprover-community/mathlib4/commit/54d12203eb2afd003111899bd0a35c3ee74bb6af\">54d12203eb</a> as a commit to master.</p>",
        "id": 483126134,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731965032
    },
    {
        "content": "<p>I wonder if the issue is that the <code>test</code> step is contained in <a href=\"https://github.com/liskin/gh-problem-matcher-wrap?tab=readme-ov-file\">this action</a> and it hides the error.</p>",
        "id": 483126955,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731965356
    },
    {
        "content": "<p>The other issue is probably that the assert not exist should be on <del>docs#StarRing.star</del>, rather than on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CStarAlgebra.star#doc\">docs#CStarAlgebra.star</a>.</p>",
        "id": 483129296,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966179
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CStarRing#doc\">docs#CStarRing</a>, maybe?</p>",
        "id": 483129665,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966308
    },
    {
        "content": "<p>I am hoping that <a href=\"https://github.com/leanprover-community/mathlib4/pull/19226\">#19226</a> is what Kim had in mind.</p>",
        "id": 483130195,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966511
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483126955\">said</a>:</p>\n<blockquote>\n<p>I wonder if the issue is that the <code>test</code> step is contained in <a href=\"https://github.com/liskin/gh-problem-matcher-wrap?tab=readme-ov-file\">this action</a> and it hides the error.</p>\n</blockquote>\n<p>I didn't look into the problem matcher action carefully but it didn't seem like it had any config options on this front, so I wonder if we need to run the tests in a separate step and then feed the output to the action afterwards. </p>\n<p>In the mathlib3 days we had <a href=\"https://github.com/leanprover-community/mathlib3/blob/master/scripts/detect_errors.py\">a python script</a> which complained if there were noisy files, but I guess that went away at some point.</p>",
        "id": 483130337,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1731966570
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/19227\">#19227</a></p>",
        "id": 483130583,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966672
    },
    {
        "content": "<p>I propose to just remove the wrapper: it is unclear what suggestions would be reasonable for a failed test.</p>",
        "id": 483130627,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966697
    },
    {
        "content": "<p>Supposedly, <code>lake test</code> already fails on noisy tests, so I am hoping that this will be enough.</p>",
        "id": 483130747,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966733
    },
    {
        "content": "<p>Since <code>master</code> still has the failure above, we will see if unwrapping make CI complain about the PR.</p>",
        "id": 483130799,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966759
    },
    {
        "content": "<p>Oh, even without the wrapping action it still passes the tests.</p>",
        "id": 483130955,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966831
    },
    {
        "content": "<p>I am still hoping that there is a way to make the tests fail so that CI does not continue, rather the inspecting the output of the <code>lake test</code> step.</p>",
        "id": 483131198,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731966918
    },
    {
        "content": "<p>I made the test fail less gracefully and now the exit code is 1.</p>",
        "id": 483134030,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731968045
    },
    {
        "content": "<p>I do not know if there is any point in keeping the action wrapper on this step, though.</p>",
        "id": 483134097,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731968074
    },
    {
        "content": "<p>With <a href=\"https://github.com/leanprover-community/mathlib4/pull/19226\">#19226</a> merged, mathlib's tests are silent again!</p>",
        "id": 483336667,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732043983
    },
    {
        "content": "<p>There is still the issue of making sure that they stay silent, even if future changes will make them fail.</p>",
        "id": 483336960,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732044094
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/19227\">#19227</a> makes sure that this particular test will produce an error, instead of a warning and therefore make CI fail.</p>",
        "id": 483336978,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732044099
    },
    {
        "content": "<p>However, maybe <code>lake test</code> should be responsible for making sure that the tests are not noisy?</p>",
        "id": 483336989,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732044101
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483336989\">said</a>:</p>\n<blockquote>\n<p>However, maybe <code>lake test</code> should be responsible for making sure that the tests are not noisy?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, can we make use of existing <code>--wfail</code> (I forget if there is a version for info messages, and the Lake README doesn't even mention <code>--wfail</code>.) machinery here?</p>",
        "id": 483366181,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732056032
    },
    {
        "content": "<p>Yes you can! <code>lake --iofail test</code> will fail if the test library produces any output.</p>",
        "id": 483367292,
        "sender_full_name": "Mac Malone",
        "timestamp": 1732056341
    },
    {
        "content": "<p>Any message would be good.  The earlier issue that was noted was that also <code>logWarning</code> did not cause <code>lake test</code> to fail.</p>",
        "id": 483367335,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732056362
    },
    {
        "content": "<p>(As for documentation, CLI options appear in the <code>lake --help</code> ouptut, not currently the  README.)</p>",
        "id": 483367404,
        "sender_full_name": "Mac Malone",
        "timestamp": 1732056380
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483367292\">said</a>:</p>\n<blockquote>\n<p>Yes you can! <code>lake --iofail test</code> will fail if the test library produces any output.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> can I take your octopus to mean you will make the PR for this? :-)</p>",
        "id": 483367757,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732056559
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483367757\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483367292\">said</a>:</p>\n<blockquote>\n<p>Yes you can! <code>lake --iofail test</code> will fail if the test library produces any output.</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> can I take your octopus to mean you will make the PR for this? :-)</p>\n</blockquote>\n<p>Sure!  This would be to Batteries, right?  Where <code>lake test</code> is defined?</p>",
        "id": 483367890,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732056620
    },
    {
        "content": "<p>No, this Mathlib CI</p>",
        "id": 483368076,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732056676
    },
    {
        "content": "<p>Literally replacing <code>lake test</code> with <code>lake --iofail test</code> in build.in.yml</p>",
        "id": 483368254,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732056722
    },
    {
        "content": "<p>(and then checking it works :-)</p>",
        "id": 483368287,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732056729
    },
    {
        "content": "<p>Ok, let me take care of this!</p>",
        "id": 483368337,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732056768
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/19268\">#19268</a> adds the option to <code>lake test</code> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/19269\">#19269</a> failed with a test that just had <code>#eval \"\"</code>.</p>",
        "id": 483370881,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732058136
    },
    {
        "content": "<p>Btw, does this mean that the <code>lake build</code> step could also be using <code>lake --iofail build</code>, instead of <code>bash -o pipefail -c \"env LEAN_ABORT_ON_PANIC=1 lake build --wfail -KCI\"</code>?</p>",
        "id": 483371808,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732058673
    },
    {
        "content": "<p>Probably.</p>",
        "id": 483401253,
        "sender_full_name": "Mac Malone",
        "timestamp": 1732074786
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483367890\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483367757\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483367292\">said</a>:</p>\n<blockquote>\n<p>Yes you can! <code>lake --iofail test</code> will fail if the test library produces any output.</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> can I take your octopus to mean you will make the PR for this? :-)</p>\n</blockquote>\n<p>Sure!  This would be to Batteries, right?  Where <code>lake test</code> is defined?</p>\n</blockquote>\n<p>Ever since mathlib tests became their own library, <code>lake test</code> didn't use the batteries tool anymore. Aamof, even batteries doesn't use its own testing tool for testing!</p>",
        "id": 483425190,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732089971
    },
    {
        "content": "<p>It still exists, just doesn't get used by either Batteries or Mathlib</p>",
        "id": 483425311,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732090027
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.3A.20noisy.20.22test.20mathlib.22/near/483371808\">said</a>:</p>\n<blockquote>\n<p>Btw, does this mean that the <code>lake build</code> step could also be using <code>lake --iofail build</code>, instead of <code>bash -o pipefail -c \"env LEAN_ABORT_ON_PANIC=1 lake build --wfail -KCI\"</code>?</p>\n</blockquote>\n<p>(How) would this set <code>LEAN_ABORT_ON_PANIC=1</code>? (Is that still needed?)</p>",
        "id": 483475407,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1732106738
    },
    {
        "content": "<p>You can try it on a file</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">ls</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">!</span>\n</code></pre></div>\n<p>It is both noisy and <code>lake --iofail build &lt;thatFile&gt;</code> fails.</p>",
        "id": 483476648,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732107105
    }
]