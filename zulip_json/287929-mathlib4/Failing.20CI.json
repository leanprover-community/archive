[
    {
        "content": "<p>CI fails on both <a href=\"https://github.com/leanprover-community/mathlib4/pull/26264\">#26264</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/26320\">#26320</a> with the same error at the \"verify that everything was available in the cache\" step. I tried merging master and then rerunning CI in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26320\">#26320</a> but it didn't work.</p>",
        "id": 525466176,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750753659
    },
    {
        "content": "<p>I don't have time to investigate further, but some of the previous steps (e.g. getting the cache) have the following warning:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Removing<span class=\"w\"> </span>old<span class=\"w\"> </span>Mathlib<span class=\"w\"> </span>build<span class=\"w\"> </span>directories<span class=\"w\"> </span>prior<span class=\"w\"> </span>to<span class=\"w\"> </span>cache<span class=\"w\"> </span>fetch...\nAttempting<span class=\"w\"> </span>to<span class=\"w\"> </span>fetch<span class=\"w\"> </span>olean<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>Mathlib/Init.lean<span class=\"w\"> </span>from<span class=\"w\"> </span>cache...\nWarning:<span class=\"w\"> </span>Some<span class=\"w\"> </span>Mathlib<span class=\"w\"> </span>ecosystem<span class=\"w\"> </span>tools<span class=\"w\"> </span>assume<span class=\"w\"> </span>that<span class=\"w\"> </span>the<span class=\"w\"> </span>git<span class=\"w\"> </span>remote<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"sb\">`</span>leanprover-community/mathlib4<span class=\"sb\">`</span><span class=\"w\"> </span>is<span class=\"w\"> </span>named<span class=\"w\"> </span><span class=\"sb\">`</span>upstream<span class=\"sb\">`</span>.<span class=\"w\"> </span>You<span class=\"w\"> </span>have<span class=\"w\"> </span>named<span class=\"w\"> </span>it<span class=\"w\"> </span><span class=\"sb\">`</span>origin<span class=\"sb\">`</span><span class=\"w\"> </span>instead.<span class=\"w\"> </span>We<span class=\"w\"> </span>recommend<span class=\"w\"> </span>changing<span class=\"w\"> </span>the<span class=\"w\"> </span>name<span class=\"w\"> </span>to<span class=\"w\"> </span><span class=\"sb\">`</span>upstream<span class=\"sb\">`</span>.<span class=\"w\"> </span>Moreover,<span class=\"w\"> </span><span class=\"sb\">`</span>origin<span class=\"sb\">`</span><span class=\"w\"> </span>should<span class=\"w\"> </span>point<span class=\"w\"> </span>to<span class=\"w\"> </span>your<span class=\"w\"> </span>own<span class=\"w\"> </span>fork<span class=\"w\"> </span>of<span class=\"w\"> </span>the<span class=\"w\"> </span>mathlib4<span class=\"w\"> </span>repository.<span class=\"w\"> </span>You<span class=\"w\"> </span>can<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>this<span class=\"w\"> </span>up<span class=\"w\"> </span>with<span class=\"w\"> </span><span class=\"sb\">`</span>git<span class=\"w\"> </span>remote<span class=\"w\"> </span>add<span class=\"w\"> </span>upstream<span class=\"w\"> </span>https://github.com/leanprover-community/mathlib4.git<span class=\"sb\">`</span>.\n</code></pre></div>",
        "id": 525467176,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754025
    },
    {
        "content": "<p>The fact that the main CI build uses a setup that is not standard for the \"Mathlib ecosystem\" seems sub-optimal.</p>",
        "id": 525467350,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754074
    },
    {
        "content": "<p>Oh interesting, thanks! It's strange because I'm pretty sure I did the renaming... I'll check it.</p>",
        "id": 525467413,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750754093
    },
    {
        "content": "<p>Ah, sorry, I had missed that this was the setup in the fork!  I did not mean to criticise your setup, I thought that it was a fault purely on the CI side!</p>",
        "id": 525467798,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754179
    },
    {
        "content": "<p>Anyway, if this really is the issue, then</p>\n<ul>\n<li>either the error message should be clearer about this;</li>\n<li>or (better) CI should be able to deal with unusual names for upstream and <del>master</del>origin.</li>\n</ul>",
        "id": 525467923,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754217
    },
    {
        "content": "<p>Well in fact it's probably an issue with CI, my git remote for leanprover-community/mathlib4 is indeed called <code>upstream</code> and the one for my fork <code>origin</code>.</p>",
        "id": 525468091,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750754280
    },
    {
        "content": "<p>Ok, unfortunately, I cannot debug this further, but hopefully someone else can assist!</p>",
        "id": 525468199,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754319
    },
    {
        "content": "<p>No problem, thanks!</p>",
        "id": 525468272,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750754344
    },
    {
        "content": "<p>I have the same issue on <a href=\"https://github.com/leanprover-community/mathlib4/pull/26041\">#26041</a></p>",
        "id": 525468672,
        "sender_full_name": "Anatole Dedecker",
        "timestamp": 1750754489
    },
    {
        "content": "<p>I did do some little more debugging: it seems that the <code>Configure Lean</code> step tries to fetch the Mathlib cache and is only 99% successful.</p>",
        "id": 525469324,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754717
    },
    {
        "content": "<p>Perhaps we could add a <code>--no-warn-remote</code>flag to cache that CI can use?</p>",
        "id": 525469364,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1750754732
    },
    {
        "content": "<p>I wonder if it is able to download the cache that is on the main repo, but not the one that has just been built and uploaded to your fork.</p>",
        "id": 525469407,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754747
    },
    {
        "content": "<p>There has been some CI movement in this direction between yesterday and today: every time that it looked like it was fixed, another problem came up.  This could be the latest.  Surely, everything will work once this is fixed.</p>",
        "id": 525469622,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750754821
    },
    {
        "content": "<p>Same issue on <a href=\"https://github.com/leanprover-community/mathlib4/pull/26238\">#26238</a>.</p>",
        "id": 525473459,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750756094
    },
    {
        "content": "<p>Does the error go away if you merge <code>master</code> again? It could be related to the fix in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26335\">#26335</a>.</p>",
        "id": 525510090,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1750769160
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26320\">#26320</a> still fails.</p>",
        "id": 525513890,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750770266
    },
    {
        "content": "<p>Thanks for testing! I think getting to the bottom of Damiano's comment here may be the key (this is a job for someone willing to dig into the workings of Cache+our CI, not necessarily you) :<br>\n<span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525469324\">said</a>:</p>\n<blockquote>\n<p>I did do some little more debugging: it seems that the <code>Configure Lean</code> step tries to fetch the Mathlib cache and is only 99% successful.</p>\n</blockquote>\n<p>Here's the relevant line in the latest build log of yours: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/15850954631/job/44684495163?pr=26320#step:3:174\">https://github.com/leanprover-community/mathlib4/actions/runs/15850954631/job/44684495163?pr=26320#step:3:174</a></p>\n<p>In any case the warning message given there doesn't apply.</p>",
        "id": 525515449,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1750770718
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26351\">#26351</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/26353\">#26353</a> have similar errors to <a href=\"https://github.com/leanprover-community/mathlib4/pull/26320\">#26320</a></p>",
        "id": 525515755,
        "sender_full_name": "Rémy Degenne",
        "timestamp": 1750770800
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26364\">#26364</a> has the same problem</p>",
        "id": 525558299,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1750783581
    },
    {
        "content": "<p>I got pulled away from the computer when I started looking at this. </p>\n<p>I would be nice if cache spat out like 5 modules it failed on for debugging.</p>",
        "id": 525558483,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750783653
    },
    {
        "content": "<p>I think that consistently</p>\n<ul>\n<li>in <code>Build</code>, <code>upload cache</code>, lake reports a number of files it should upload, presumably the modified ones and the files depending on those;</li>\n<li><code>Post-Build</code>, <code>Configure Lean</code> has a \"Mathlib cache\" clickable tab and it says \"Attempting to download [some number of files]\", but misses the download of the same number that is should have uploaded.</li>\n</ul>",
        "id": 525559371,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750783930
    },
    {
        "content": "<p>So, I think that while it would be good if lake reported which files it failed to download, I think that in this case it is \"all the modified files and the ones that depend on them\".</p>",
        "id": 525559463,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750783963
    },
    {
        "content": "<p>I wonder whether it fails to download them, because they were not stored correctly.</p>",
        "id": 525559578,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750784002
    },
    {
        "content": "<p>Yes. This was my suspicion but I only looked at one example very briefly. I only saw it pulling from the central cache and not user cache.</p>",
        "id": 525563095,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750785410
    },
    {
        "content": "<p>I think I'm also seeing this in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26272\">#26272</a>.</p>",
        "id": 525579936,
        "sender_full_name": "Alastair Irving",
        "timestamp": 1750792303
    },
    {
        "content": "<p>Are we seeing trouble pulling the cache in the fork directly?</p>",
        "id": 525591208,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750797354
    },
    {
        "content": "<p>You mean running <code>lake exe cache get!</code> on my local branch?</p>",
        "id": 525591426,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1750797461
    },
    {
        "content": "<p>If you create a new clone of your fork and switch the branch where you should have a cache of changes, what happens when you <code>lake exe cache get</code> there</p>",
        "id": 525591608,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750797535
    },
    {
        "content": "<p>I can test this myself (at some point...) but it would be easier if someone is quickly in position to check</p>",
        "id": 525592050,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750797725
    },
    {
        "content": "<p>Pulling from the cache when I'm on my fork works fine, for instance for <a href=\"https://github.com/leanprover-community/mathlib4/pull/26361\">#26361</a>: all files are downloaded (most of them from the <code>mathlib-community</code> cache, corresponding to files the PR hasn't changed, and 11 of them from the fork's cache). So, the files have definitely been uploaded.</p>\n<p>However, if I'm not on my fork, i.e., if I'm on the main <code>mathlib4</code>, then the result is not the same: it does not download the files from my fork. The output is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PS</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">sebas</span><span class=\"bp\">\\</span><span class=\"n\">Desktop</span><span class=\"bp\">\\</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">gh</span><span class=\"w\"> </span><span class=\"n\">pr</span><span class=\"w\"> </span><span class=\"n\">checkout</span><span class=\"w\"> </span><span class=\"mi\">26361</span>\n<span class=\"n\">PS</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">sebas</span><span class=\"bp\">\\</span><span class=\"n\">Desktop</span><span class=\"bp\">\\</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">Warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">ecosystem</span><span class=\"w\"> </span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"k\">assume</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">remote</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"ss\">`leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"ss\">`upstream</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">You</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">named</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"ss\">`origin</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">instead</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">We</span><span class=\"w\"> </span><span class=\"n\">recommend</span><span class=\"w\"> </span><span class=\"n\">changing</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"ss\">`upstream</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">Moreover</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`origin</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">point</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">own</span><span class=\"w\"> </span><span class=\"n\">fork</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">repository</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">You</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">up</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`git</span><span class=\"w\"> </span><span class=\"n\">remote</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">upstream</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">.</span><span class=\"n\">git</span><span class=\"bp\">`.</span>\n<span class=\"n\">Using</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">origin</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span>\n<span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">6878</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">6867</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">attempted</span><span class=\"w\"> </span><span class=\"mi\">6878</span><span class=\"bp\">/</span><span class=\"mi\">6878</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">99</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 525592489,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1750797899
    },
    {
        "content": "<p>Ah that is very helpful. Thank you!</p>",
        "id": 525592574,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750797931
    },
    {
        "content": "<p>So it looks like the issue is not the uploading phase, but rather the downloading one where it does not identify the fork correctly.</p>",
        "id": 525592644,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1750797965
    },
    {
        "content": "<p>Yes and that is the logic that has changed recently</p>",
        "id": 525592691,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750797983
    },
    {
        "content": "<p>\"We are not in a fork so we don't need to check the user cache\"</p>",
        "id": 525592937,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750798102
    },
    {
        "content": "<p>No, it is that the cache was getting put in the wrong place and <code>get</code> relied on that not to miss.</p>",
        "id": 525593796,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750798449
    },
    {
        "content": "<p>Another example where the logic is still broken: on my fork, after</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PS</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">sebas</span><span class=\"bp\">\\</span><span class=\"n\">Desktop</span><span class=\"bp\">\\</span><span class=\"n\">mathlib4SG</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">gh</span><span class=\"w\"> </span><span class=\"n\">pr</span><span class=\"w\"> </span><span class=\"n\">checkout</span><span class=\"w\"> </span><span class=\"mi\">26366</span>\n</code></pre></div>\n<p>(which is not one of my PRs), then <code>lake exe cache get</code> still tries to download from the main cache and from my fork's cache, but not from the PR's author cache.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PS</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">sebas</span><span class=\"bp\">\\</span><span class=\"n\">Desktop</span><span class=\"bp\">\\</span><span class=\"n\">mathlib4SG</span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">Using</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">origin</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sgouezel</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span>\n<span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">924</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">722</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">attempted</span><span class=\"w\"> </span><span class=\"mi\">924</span><span class=\"bp\">/</span><span class=\"mi\">924</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">78</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"o\">)</span>\n<span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">202</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">sgouezel</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">attempted</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"bp\">/</span><span class=\"mi\">202</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"bp\">%</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- I interrupted it</span>\n</code></pre></div>",
        "id": 525593921,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1750798501
    },
    {
        "content": "<p><del>Ok L109 in <code>Cache.Requests</code> looks like the problem. \"@{upstream}\" is a just plain ole string. (Your lines may vary)</del> Well, that is actual syntax. But it errors out here and the fallback looks off.</p>",
        "id": 525595598,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750799287
    },
    {
        "content": "<p>Ok, I think the following is the start of a fix: <a href=\"https://github.com/leanprover-community/mathlib4/blob/97a13d0d0981dd42a088436ad84cd495eec51aaa/Cache/Requests.lean#L185\">https://github.com/leanprover-community/mathlib4/blob/97a13d0d0981dd42a088436ad84cd495eec51aaa/Cache/Requests.lean#L185</a> fails in <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> 's situation but <code>git for-each-ref --points-at COMMITNUM</code> succeeds</p>",
        "id": 525599141,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750800972
    },
    {
        "content": "<p>I am pulled away again</p>",
        "id": 525599197,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750801000
    },
    {
        "content": "<p>Maybe we should add a <code>--repo</code> flag to <code>exe cache get</code>, so that we can explicitly pull from the right cache in CI?</p>",
        "id": 525682097,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1750847564
    },
    {
        "content": "<p>Doesn't the flag already exist?</p>",
        "id": 525684012,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750848353
    },
    {
        "content": "<p>One thing I don't understand yet is why this only affects a subset of PRs. Is there something common to the cases where this pops up?</p>",
        "id": 525684912,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1750848651
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525684012\">said</a>:</p>\n<blockquote>\n<p>Doesn't the flag already exist?</p>\n</blockquote>\n<p>For <code>put</code> it does... not sure about <code>get</code></p>",
        "id": 525685169,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1750848723
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525684912\">said</a>:</p>\n<blockquote>\n<p>One thing I don't understand yet is why this only affects a subset of PRs. Is there something common to the cases where this pops up?</p>\n</blockquote>\n<p>Doesn't it affect all PRs?</p>",
        "id": 525686667,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1750849233
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525685169\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525684012\">said</a>:</p>\n<blockquote>\n<p>Doesn't the flag already exist?</p>\n</blockquote>\n<p>For <code>put</code> it does... not sure about <code>get</code></p>\n</blockquote>\n<p>The flag exists for get (and is undocumented <span aria-label=\"melting\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melting\">:melting:</span> ) but the catch is that you have to use a <code>--repo=...</code> syntax (<code>--repo ...</code> doesn’t work) and you need to put it before the <code>get</code>, not after, so <br>\n<code>lake exe cache --repo=leanprover-community/mathlib4 get</code>).</p>",
        "id": 525687156,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1750849390
    },
    {
        "content": "<p>I think we should try to use that in CI</p>",
        "id": 525687779,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1750849629
    },
    {
        "content": "<p>But I don't have time to implement it in the next 3 hrs</p>",
        "id": 525687804,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1750849642
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">Sébastien Gouëzel</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525686667\">said</a>:</p>\n<blockquote>\n<p>Doesn't it affect all PRs?</p>\n</blockquote>\n<p>We're still managing to merge some PRs into <code>master</code>, so at least those are getting through without throwing errors in the Post-Build step.</p>",
        "id": 525688577,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1750849966
    },
    {
        "content": "<p>I think that's because <code>bors</code> doesn't run the same setup as PR-CI. And I think that is a usability bug. We should probably fix it.</p>",
        "id": 525689337,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1750850249
    },
    {
        "content": "<p>PRs which exhibit the Post-Build step error can still be sent to bors and be successfully merged there, because merging on master only needs to fetch from the main cache. I have the impression that all PRs on forks fail this step.</p>",
        "id": 525690008,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1750850522
    },
    {
        "content": "<p>I could be missing something, but I don't see anything in the Post-Build step that should lead to a difference here between build_fork.yml and bors.yml though.</p>",
        "id": 525690060,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1750850544
    },
    {
        "content": "<p>As <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> pointed out, it causes problems outside of CI with particular git states. I think the logic for finding the repo is a little off. If I can ever get a solid block, it should be straightforward to fix. If someone gets to it first, I can share what I know.</p>",
        "id": 525690249,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750850618
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">Sébastien Gouëzel</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525690008\">said</a>:</p>\n<blockquote>\n<p>PRs which exhibit the Post-Build step error can still be sent to bors and be successfully merged there, because merging on master only needs to fetch from the main cache. I have the impression that all PRs on forks fail this step.</p>\n</blockquote>\n<p>That's what I was missing, thanks!</p>",
        "id": 525690281,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1750850633
    },
    {
        "content": "<p>Regardless, passing the repo in CI is probably the best practice. Anything that tries to cover many cases in cache will have some edge cases.</p>",
        "id": 525690571,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750850758
    },
    {
        "content": "<p>Here you would need to update lean-action</p>",
        "id": 525690683,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750850800
    },
    {
        "content": "<p>Do we have a short term solution here? Should maintainers just check what the CI error is and borsify if it's just this one? Or is that not safe?</p>",
        "id": 525707656,
        "sender_full_name": "Anatole Dedecker",
        "timestamp": 1750856461
    },
    {
        "content": "<p>This line <a href=\"https://github.com/leanprover/lean-action/blob/7bd4de6ed238b1e48a311cb641e06b34fb96f1f2/action.yml#L175\">https://github.com/leanprover/lean-action/blob/7bd4de6ed238b1e48a311cb641e06b34fb96f1f2/action.yml#L175</a> should have the fix like <a href=\"https://github.com/leanprover-community/mathlib4/pull/26233\">#26233</a></p>",
        "id": 525708108,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750856609
    },
    {
        "content": "<p>I am sitting down and thinking about the current logic now. Who knows how long that state will last...</p>",
        "id": 525708329,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750856678
    },
    {
        "content": "<p>But if someone else can update lean-action and then the lakefile in the interim, CI should be ok <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 525709083,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750856906
    },
    {
        "content": "<p>There is a temporary hacky fix up at # chore: temporary fix retrieving the cache in CI <a href=\"https://github.com/leanprover-community/mathlib4/pull/26417\">#26417</a>, co-authored with <span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> live during office hours. :-)</p>",
        "id": 525803244,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750894053
    },
    {
        "content": "<p>The <em>correct</em> fix is to improve the existing logic in <code>lake exe cache get</code>, so that when it wakes up during CI it correctly identifies the source repository it should be retrieving from.</p>",
        "id": 525803286,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750894093
    },
    {
        "content": "<p>Note also that the <code>lake exe cache get</code> step <em>before</em> the build is not even attempting to retrieve oleans from the PR fork, so it is unnecessarily rebuilding these on every run. We really need to fix this.</p>",
        "id": 525803331,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750894125
    },
    {
        "content": "<p>Help very much appreciated, as I am swamped today. :-)</p>",
        "id": 525803336,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750894135
    },
    {
        "content": "<p>Just to confirm that the hacky fix works: <a href=\"https://github.com/leanprover-community/mathlib4/pull/26415\">#26415</a>, on which CI was previously failing for this reason, is now green :)</p>",
        "id": 525807165,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1750897810
    },
    {
        "content": "<p>Thanks to both you and Kim for the fix!</p>",
        "id": 525812199,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1750902630
    },
    {
        "content": "<p>I just open <a href=\"https://github.com/leanprover-community/mathlib4/pull/26425\">#26425</a> and I'm getting the error, so for some reason hacky fix is not working in this case</p>",
        "id": 525834322,
        "sender_full_name": "Iván Renison",
        "timestamp": 1750920948
    },
    {
        "content": "<p>Is your PRs master branch new enough? (Or does that not matter any more?)</p>",
        "id": 525835630,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1750921445
    },
    {
        "content": "<p>Ah, I think that no</p>",
        "id": 525835866,
        "sender_full_name": "Iván Renison",
        "timestamp": 1750921546
    },
    {
        "content": "<p>I will try updating it</p>",
        "id": 525835888,
        "sender_full_name": "Iván Renison",
        "timestamp": 1750921553
    },
    {
        "content": "<p>What I don't find is the button for re-running the job</p>",
        "id": 525836046,
        "sender_full_name": "Iván Renison",
        "timestamp": 1750921611
    },
    {
        "content": "<p>I just merged master into <a href=\"https://github.com/leanprover-community/mathlib4/pull/26351\">#26351</a> and the CI error at the post-build step is still there.</p>",
        "id": 525836827,
        "sender_full_name": "Rémy Degenne",
        "timestamp": 1750921888
    },
    {
        "content": "<p>Yeah, this is still fallout from Matthew's PR, I think.</p>",
        "id": 525840896,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923404
    },
    {
        "content": "<p>Trying to debug this, I am wondering about the <code>check the cache step</code>: it tries to get the cache, but reports that there is nothing to download.  Presumably, this is because it uses the cache that was just built.  Would it make sense to delete the cache and check that the cache can be <em>donwloaded</em> instead?</p>",
        "id": 525841075,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750923461
    },
    {
        "content": "<p>The logic I had written yesterday would have compared the checked out commit to all the PR refs, and used that to locate the relevant fork (i.e. to match what we put in <code>--repo</code> during <code>lake exe cache put</code>). That logic was deleted without anything replacing it ...</p>",
        "id": 525841096,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923469
    },
    {
        "content": "<p>No.</p>",
        "id": 525841129,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923479
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525841075\">said</a>:</p>\n<blockquote>\n<p>Trying to debug this, I am wondering about the <code>check the cache step</code>: it tries to get the cache, but reports that there is nothing to download.  Presumably, this is because it uses the cache that was just built.  Would it make sense to delete the cache and check that the cache can be <em>donwloaded</em> instead?</p>\n</blockquote>\n<p>That's not what is happening.</p>",
        "id": 525841269,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923521
    },
    {
        "content": "<p>You can see from the log <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/15895172477/job/44825416890?pr=26351#step:3:130\">https://github.com/leanprover-community/mathlib4/actions/runs/15895172477/job/44825416890?pr=26351#step:3:130</a> that it is failing to download olean</p>",
        "id": 525841290,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923529
    },
    {
        "content": "<p>Because <code>git rev-parse</code> is returning just HEAD, and (after the change last night), <code>lake exe cache get</code> doesn't know what to do with that.</p>",
        "id": 525841421,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923578
    },
    {
        "content": "<p>That is in <code>Configure Lean</code>, I was wondering about <code>check the cache</code> in the <code>Build (fork)</code> step: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/15895172477/job/44825075239?pr=26351\">https://github.com/leanprover-community/mathlib4/actions/runs/15895172477/job/44825075239?pr=26351</a>.</p>",
        "id": 525841492,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750923593
    },
    {
        "content": "<blockquote>\n<p>Would it make sense to delete the cache and check that the cache can be <em>donwloaded</em> instead?</p>\n</blockquote>\n<p>This is already tested in the post-build step.</p>",
        "id": 525841599,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923629
    },
    {
        "content": "<p>Please don't move this test into the main build step. We are trying to move things <em>out</em>.</p>",
        "id": 525841666,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923644
    },
    {
        "content": "<p>Ok, fine.</p>",
        "id": 525841688,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750923652
    },
    {
        "content": "<p>If anything, we should just drop the \"test the cache\" step in the main build step.</p>",
        "id": 525841698,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923657
    },
    {
        "content": "<p>OK, and do you think that the cache has been uploaded then and the later steps are just failing to retrieve it, or that the cache has actually not been uploaded?</p>",
        "id": 525841870,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750923703
    },
    {
        "content": "<p>Yes, the cache has been uploaded, we're just trying to retrieve it from the wrong place.</p>",
        "id": 525841976,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923731
    },
    {
        "content": "<p>Ok, I am understanding better now!</p>",
        "id": 525842022,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750923747
    },
    {
        "content": "<p>See the output that I linked above:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">Current</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HEAD</span>\n<span class=\"w\">  </span><span class=\"n\">Using</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">origin</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span>\n<span class=\"w\">  </span><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">6884</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>",
        "id": 525842152,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923773
    },
    {
        "content": "<p>This is wrong, we need to identify at this point that we are looking at a commit coming from a fork.</p>",
        "id": 525842228,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923800
    },
    {
        "content": "<p>Ok, thanks!  I am starting to be able to read these messages better!</p>",
        "id": 525842406,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750923832
    },
    {
        "content": "<p>What I am surprised by is that there is no tracking information. This code from <code>Requests.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"c1\">-- Fall back to using the remote that the current branch is tracking</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">trackingRemote</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">output</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"git\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"config\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--get\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"branch.{currentBranch.stdout.trim}.remote\"</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">cwd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mathlibDepPath</span><span class=\"o\">}</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">remoteName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">trackingRemote</span><span class=\"bp\">.</span><span class=\"n\">exitCode</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">trackingRemote</span><span class=\"bp\">.</span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">trim</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"c1\">-- If no tracking remote is configured, fall back to origin</span>\n<span class=\"w\">    </span><span class=\"s2\">\"origin\"</span>\n</code></pre></div>\n<p>was intended to try and work out the remote associated to the current branch.</p>\n<p>But given that <code>currentBranch</code> is apparently <code>HEAD</code> in this situation, that's not going to work.</p>",
        "id": 525842651,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750923913
    },
    {
        "content": "<p>The problem is when we run</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">      </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">uses</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">actions</span><span class=\"bp\">/</span><span class=\"n\">checkout</span><span class=\"bp\">@</span><span class=\"mi\">11</span><span class=\"n\">bd71901bbe5b1630ceea73d27597364c9af683</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"w\"> </span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">        </span><span class=\"k\">with</span><span class=\"o\">:</span>\n<span class=\"w\">          </span><span class=\"n\">ref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"${{ PR_BRANCH_REF }}\"</span>\n</code></pre></div>\n<p>in the post build step, we end up in a detached state:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">checkout</span><span class=\"w\"> </span><span class=\"c1\">--progress --force d7f45861e9b66c8b6456a5c9d2ea199b933fdd92</span>\n<span class=\"w\">  </span><span class=\"n\">Note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">switching</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">d7f45861e9b66c8b6456a5c9d2ea199b933fdd92'</span><span class=\"bp\">.</span>\n\n<span class=\"w\">  </span><span class=\"n\">You</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">detached</span><span class=\"w\"> </span><span class=\"n\">HEAD'</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">You</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">look</span><span class=\"w\"> </span><span class=\"n\">around</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"n\">experimental</span>\n<span class=\"w\">  </span><span class=\"n\">changes</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"n\">them</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">discard</span><span class=\"w\"> </span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">commits</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">make</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"w\">  </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"n\">without</span><span class=\"w\"> </span><span class=\"n\">impacting</span><span class=\"w\"> </span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"n\">branches</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">switching</span><span class=\"w\"> </span><span class=\"n\">back</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"bp\">.</span>\n\n<span class=\"w\">  </span><span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">want</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">create</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">retain</span><span class=\"w\"> </span><span class=\"n\">commits</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">create</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">may</span>\n<span class=\"w\">  </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">later</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">switch</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Example</span><span class=\"o\">:</span>\n\n<span class=\"w\">    </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">switch</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">new</span><span class=\"bp\">-</span><span class=\"n\">branch</span><span class=\"bp\">-</span><span class=\"n\">name</span><span class=\"bp\">&gt;</span>\n\n<span class=\"w\">  </span><span class=\"n\">Or</span><span class=\"w\"> </span><span class=\"n\">undo</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"o\">:</span>\n\n<span class=\"w\">    </span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">switch</span><span class=\"w\"> </span><span class=\"bp\">-</span>\n\n<span class=\"w\">  </span><span class=\"n\">Turn</span><span class=\"w\"> </span><span class=\"n\">off</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">advice</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">setting</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"n\">advice</span><span class=\"bp\">.</span><span class=\"n\">detachedHead</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"w\">  </span><span class=\"n\">HEAD</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">now</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">d7f4586</span><span class=\"w\"> </span><span class=\"n\">Merge</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">master'</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">coveringNumbers</span>\n</code></pre></div>",
        "id": 525842977,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924028
    },
    {
        "content": "<p>Prior to <a href=\"https://github.com/leanprover-community/mathlib4/pull/26407\">#26407</a> deleting my \"match against all PR refs\" logic, I think this would have worked.</p>",
        "id": 525843080,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924059
    },
    {
        "content": "<p>I think that this is another situation where I would have used the \"checkout dance\" hack.</p>",
        "id": 525843102,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750924066
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/525843080\">said</a>:</p>\n<blockquote>\n<p>Prior to <a href=\"https://github.com/leanprover-community/mathlib4/pull/26407\">#26407</a> deleting my \"match against all PR refs\" logic, I think this would have worked.</p>\n</blockquote>\n<p>Do you want to revert this, then?</p>",
        "id": 525843269,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750924120
    },
    {
        "content": "<p>(I am going to be unavailable soon, and for a couple of hours.)</p>",
        "id": 525843442,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750924188
    },
    {
        "content": "<p>Here are our options:</p>\n<ol>\n<li>work out how to checkout the branch in such a way that there is a branch name and tracking information available</li>\n<li>revert <a href=\"https://github.com/leanprover-community/mathlib4/pull/26407\">#26407</a> --- it won't revert cleanly, as today we've changed a bunch of stuff on top</li>\n<li>use <code>--repo</code> everywhere, as I did in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26417\">#26417</a> and then reverted in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26421\">#26421</a>, when I thought it was fixed. :-(</li>\n</ol>",
        "id": 525843464,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924196
    },
    {
        "content": "<p>my preference is 1 then 2 then 3</p>",
        "id": 525843484,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924203
    },
    {
        "content": "<p>but I am about to be offline for a few hours to watch my kids stage \"Into the Woods\". :-)</p>",
        "id": 525843542,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924227
    },
    {
        "content": "<p>My complaint against option 3 is that it is putting the logic in multiple places: sometimes cache is working out where to retrieve from, sometimes we are overriding it. I'd prefer to keep the logic in one place.</p>",
        "id": 525843716,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924290
    },
    {
        "content": "<p>My complaint against 2 is that the old logic for comparing against all PR refs was pretty janky and complicated.</p>",
        "id": 525843781,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924308
    },
    {
        "content": "<p>But maybe 3 is okay after all...</p>",
        "id": 525843900,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924357
    },
    {
        "content": "<p>re: 1. Claude is claiming to me that replacing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">ref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"s2\">\"${{ PR_BRANCH_REF }}\"</span>\n</code></pre></div>\n<p>with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">ref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">{{</span><span class=\"w\"> </span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">head_ref</span><span class=\"w\"> </span><span class=\"o\">}}</span>\n</code></pre></div>\n<p>would suffice...</p>",
        "id": 525844457,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924550
    },
    {
        "content": "<p>(This would have to happen in both the main step and the post-build step)</p>",
        "id": 525844853,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924632
    },
    {
        "content": "<p>I can try that this evening if no one else has got there yet. :-)</p>",
        "id": 525844889,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924647
    },
    {
        "content": "<p>I won't do it right now, since I am about to see a student, but can try it later, when I may also be able to fix follow-up errors.</p>",
        "id": 525844988,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750924681
    },
    {
        "content": "<p>Or maybe <code>ref: ${{ github.head_ref || github.ref }}</code> is better.</p>",
        "id": 525845046,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924702
    },
    {
        "content": "<p>but double checking those are not hallucinations will be helpful. :-)</p>",
        "id": 525845092,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750924720
    },
    {
        "content": "<p>Okay, I am attempting this in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26434\">#26434</a>.</p>",
        "id": 525883355,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750937702
    },
    {
        "content": "<p>Uh, I think this may not have worked as intended: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/15901467227/job/44847564695#step:5:63\">https://github.com/leanprover-community/mathlib4/actions/runs/15901467227/job/44847564695#step:5:63</a></p>",
        "id": 525896287,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1750941991
    },
    {
        "content": "<p>yeah, <a href=\"https://github.com/leanprover-community/mathlib4/pull/26438\">#26438</a> reverts it.</p>",
        "id": 525897454,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750942354
    },
    {
        "content": "<p>It's frustrating, as <a href=\"https://github.com/leanprover-community/mathlib4/pull/26434\">#26434</a> was following the example given on the actions/checkout README for when you don't want a detached HEAD. :-(</p>",
        "id": 525897620,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750942393
    },
    {
        "content": "<p>Okay, time for 2. above, I think, attempting the restore some the functionality dropped in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26407\">#26407</a>. I'll see if I can slim it down.</p>",
        "id": 525897854,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750942440
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26407\">#26407</a> was already trying to fix some failures, it was failing before it and <a href=\"https://github.com/leanprover-community/mathlib4/pull/26407\">#26407</a> was an attempt to fix it. So reverting it won't fix anything.</p>",
        "id": 525898475,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1750942605
    },
    {
        "content": "<p>Well, in the good old CS tradition, it <em>may</em> fix something... <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 525898667,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750942668
    },
    {
        "content": "<p>I don't mean revert it, I mean the revert that part of it that with no explanation deleted the logic I'd written to handle exactly this case :-)</p>",
        "id": 525898792,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750942709
    },
    {
        "content": "<p>That logic looked very broken in all the tests I ran. You probably want <code>--points-at</code> to find the target branch in the detached head state. I had thought but not communciated clearly that there would be more testing to see if this was needed. It is hard to know what is wanted when no one writes any behavioral tests or issues with comments in the code.</p>",
        "id": 525899804,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750942982
    },
    {
        "content": "<p>Okay, here's another attempt at it: <a href=\"https://github.com/leanprover-community/mathlib4/pull/26439\">#26439</a></p>",
        "id": 525900984,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750943348
    },
    {
        "content": "<p>I've tested on master, nightly-testing and my testing PR in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26435\">#26435</a>. Running on that locally gives the promising looking:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Current</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ci_test</span>\n<span class=\"n\">Using</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">PR</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">26435</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">kim</span><span class=\"bp\">-</span><span class=\"n\">em</span><span class=\"bp\">/</span><span class=\"n\">ci_test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"mi\">230</span><span class=\"n\">ee37c</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">PR</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"o\">)</span>\n<span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">kim</span><span class=\"bp\">-</span><span class=\"n\">em</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">cache</span>\n</code></pre></div>",
        "id": 525901124,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750943391
    },
    {
        "content": "<p>My apologies, Matthew, for the snarky criticism. I regret the way I stated it: I've had a very tiring day, and I very much appreciate everyone's help and encouragement getting our CI working again.</p>",
        "id": 525901316,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1750943453
    },
    {
        "content": "<p>No worries. I know you have an exceptionally large plate and appreciate all your efforts to keep us alive day to day</p>",
        "id": 525908742,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750945546
    },
    {
        "content": "<p>Kim's last PR has us green in CI. As you go about your daily business, please report back issues with the cache so we can attempt to address them.</p>",
        "id": 525928746,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750950978
    },
    {
        "content": "<p>I've opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/27315\">#27315</a>, and it failed post-build CI Post-Build Step (fork). Is it related to the Failing CI  issues discussed in this post? I am confused on what I should do with this error. Thanks in advance </p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/27315\">https://github.com/leanprover-community/mathlib4/pull/27315</a></p>",
        "id": 529811363,
        "sender_full_name": "Matteo Cipollina",
        "timestamp": 1753088192
    },
    {
        "content": "<p>Looks like a network issue, I restarted the job</p>",
        "id": 529812352,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1753088361
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/529812352\">ha scritto</a>:</p>\n<blockquote>\n<p>Looks like a network issue, I restarted the job</p>\n</blockquote>\n<p>it's all all green now, thank you!</p>",
        "id": 529813807,
        "sender_full_name": "Matteo Cipollina",
        "timestamp": 1753088586
    },
    {
        "content": "<p>My PR(<a href=\"https://github.com/leanprover-community/mathlib4/pull/27498\">#27498</a>) is failed post-bulid CI. Is it error of the server?</p>",
        "id": 530878203,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1753496114
    },
    {
        "content": "<p>Weird. Let's try again</p>",
        "id": 530903268,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1753512119
    },
    {
        "content": "<p>This is strange. <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16535993687/job/46773222212\">Here's the link</a> to the latest failing run. I don't see anything suspicious in the earlier steps and it looks like this has been re-run several times so I don't think it's a network error.</p>\n<p>I tried reproducing this locally and I'm not sure if I got my mathlib4 in the same state, but after running:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>lake exe cache clean!\ngh pr checkout 27498\nlake exe cache --repo=Komyyy/mathlib4 get\nlake build --no-build -v Mathlib\n</code></pre></div>\n<p>I also get an exit code of 3, with the last line of log output being:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>⣟ [7002/7003] Running mathlib/Mathlib:default\n</code></pre></div>\n<p>Anyone recognize what might be going on here?</p>",
        "id": 530948387,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1753537191
    },
    {
        "content": "<p>Could it be that the error was maybe in the uploading the cache step, <em>before</em> the failing step,   so that re-running did not redo the step that actually had a problem, but just the check?</p>",
        "id": 530953250,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1753539553
    },
    {
        "content": "<p>Hmm, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16535993687/job/46773222222#step:22:3432\">here's the \"Upload cache\" step</a>. I downloaded the raw log and checked with a regex that the only errors in the upload steps are the \"The specified blob already exists.\" which is expected, since I guess the files were uploaded in a previous try.</p>",
        "id": 530955409,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1753540512
    },
    {
        "content": "<p>I pushed a merge commit to the branch, in the hopes that the issue is just that some random file in the cache is corrupted and rebuilding it will fix things somehow. It'd be nice if we could have better diagnostics for what's going on in cases like this, maybe I'm missing some command line options.</p>\n<p><strong>edit</strong>: seems to have worked!</p>",
        "id": 530973773,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1753549218
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span> <span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> <br>\nThank you to fix my PR!</p>",
        "id": 531036526,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1753579829
    },
    {
        "content": "<p>\"Post-Build Step (fork): verify that everything was available in the cache\" also failed at <a href=\"https://github.com/leanprover-community/mathlib4/pull/27482\">#27482</a> and was fixed by merging master.</p>",
        "id": 531139007,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1753622379
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/27676\">#27676</a> seems to be suffering from a similar issue, which didn't go away even after merging <code>master</code> once.</p>",
        "id": 531839964,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1753881213
    },
    {
        "content": "<p>I've created <a href=\"https://github.com/leanprover-community/mathlib4/pull/27691\">#27691</a> to hopefully help with this issue; I still don't understand the root cause though.</p>",
        "id": 531890225,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1753895202
    },
    {
        "content": "<p>Unfortunately, this still seems to be an issue: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16766739009/job/47473800135\">https://github.com/leanprover-community/mathlib4/actions/runs/16766739009/job/47473800135</a></p>\n<p>In the log above, note that <code>lake build --no-build</code> passed <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16766739009/job/47473184764#step:19:842\">on the first try</a> after building mathlib in the \"Build\" job, but then failed <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16766739009/job/47473800135#step:6:7057\">in the \"Post-Build Step\" job</a>.</p>",
        "id": 533022248,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754454371
    },
    {
        "content": "<p>Assuming <code>lake build --no-build</code> is deterministic, we must not be running it on the same set of olean files, which then suggests something is going wrong in the upload step. However, I don't see anything suspicious in the logs there. Anyone have any ideas?</p>",
        "id": 533023398,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754455164
    },
    {
        "content": "<p>FTR, <a href=\"https://github.com/leanprover-community/mathlib4/pull/27284\">#27284</a> seems to have the same issue. (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16772799598/job/47495772115\">https://github.com/leanprover-community/mathlib4/actions/runs/16772799598/job/47495772115</a>)</p>",
        "id": 533091535,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1754483343
    },
    {
        "content": "<p>Now this step seems to be printing more diagnostic info:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">ℹ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">129</span><span class=\"bp\">/</span><span class=\"mi\">604</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">ℹ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">456</span><span class=\"bp\">/</span><span class=\"mi\">604</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">proofwidgets</span><span class=\"bp\">/</span><span class=\"n\">widgetPackageLock</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">ℹ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">6761</span><span class=\"bp\">/</span><span class=\"mi\">7030</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">Match</span>\n<span class=\"bp\">...</span>\n<span class=\"n\">ℹ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">6762</span><span class=\"bp\">/</span><span class=\"mi\">7030</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Replayed</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Matcher</span>\n<span class=\"bp\">...</span>\n<span class=\"bp\">##</span><span class=\"o\">[</span><span class=\"n\">error</span><span class=\"o\">]</span><span class=\"n\">Process</span><span class=\"w\"> </span><span class=\"n\">completed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mf\">3.</span>\n</code></pre></div>",
        "id": 533188831,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1754520197
    },
    {
        "content": "<p>log <a href=\"/user_uploads/3121/yK43F37ksf96u7eULZQ4SIBC/6_verify-that-everything-was-available-in-the-cache.txt\">6_verify that everything was available in the cache.txt</a> from <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16789745255/job/47550209682\">this run</a></p>",
        "id": 533188928,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1754520264
    },
    {
        "content": "<p>That was added in <a href=\"https://github.com/leanprover-community/mathlib4/pull/27691\">#27691</a> (adding the <code>-v</code> command line flag to the <code>lake build</code> commands). I think we may need to add logging to cache somehow to make sure that everything uploaded is what we want though.</p>",
        "id": 533189131,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754520429
    },
    {
        "content": "<p>I've opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/28062\">#28062</a> which will upload the contents of mathlib4 after <code>lake build</code> and <code>lake build --no-build</code> to a workflow artifact. After this gets merged, the next time this error occurs, hopefully comparing what's in that artifact with what's in the cloud cache will let us figure out what's happening.</p>",
        "id": 533198481,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754527548
    },
    {
        "content": "<p>PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/28063\">#28063</a> adds some module deprecation tags, and idk if I'm doing something wrong because I simply get an <code>exit 1</code> code in the logs.<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16794175516/job/47561452811?pr=28063\">https://github.com/leanprover-community/mathlib4/actions/runs/16794175516/job/47561452811?pr=28063</a></p>",
        "id": 533210555,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1754537380
    },
    {
        "content": "<p>Ah, it's a little confusing, but that step just combines the results of the previous two steps. There's a warning in the Counterexamples folder that you'll need to suppress: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16794175516/job/47561452811?pr=28063#step:25:16\">https://github.com/leanprover-community/mathlib4/actions/runs/16794175516/job/47561452811?pr=28063#step:25:16</a></p>",
        "id": 533210658,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754537473
    },
    {
        "content": "<p>Let me add a more sensible message there to one of my PRs.</p>",
        "id": 533210708,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754537525
    },
    {
        "content": "<p>Oh thanks! I forgot to deprecate that one file.</p>",
        "id": 533211159,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1754537903
    },
    {
        "content": "<p>BTW I recently found that if <code>shake</code> suggests removing some import from a Mathlib file, it doesn't seem to suggest adding it back in Archive/Counterexample files where it's necessary.</p>",
        "id": 533233618,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1754551852
    },
    {
        "content": "<p>This is by design: Mathlib and Archive are different libraries, and shake only works within the scope of a single library`</p>",
        "id": 533236702,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1754553073
    },
    {
        "content": "<p>I won't have time to look into this until later, but Claude wrote me <a href=\"https://gist.github.com/bryangingechen/3b6dcfd442ca1293a8159f2d0f516220\">a script</a> that helped me find the following examples where the cache verification is failing; if someone would like to dig through the workflow artifacts and see if they match the oleans in the cache, that'd be greatly appreciated!</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>Searching for workflow runs where job 'Post-Build Step (fork)' failed...<br>\nFiltering by workflow: build_fork.yml<br>\nOnly including runs after: 2025-08-07 02:01:00<br>\nChecking last 100 runs...</p>\n<hr>\n<p>Found 45 failed runs to check for job 'Post-Build Step (fork)'...<br>\n<span aria-label=\"cross mark\" class=\"emoji emoji-274c\" role=\"img\" title=\"cross mark\">:cross_mark:</span> FOUND: Run 16803207487 failed<br>\n   Title: chore: replace <code>norm_num</code> with <code>simp</code> where applicable<br>\n   Branch: replace-norm_num-with-simp<br>\n   Date: 2025-08-07 07:29:16<br>\n   Job 'Post-Build Step (fork)' status: FAILED<br>\n   URL: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16803207487\">https://github.com/leanprover-community/mathlib4/actions/runs/16803207487</a></p>\n<p><span aria-label=\"cross mark\" class=\"emoji emoji-274c\" role=\"img\" title=\"cross mark\">:cross_mark:</span> FOUND: Run 16799992064 failed<br>\n   Title: [Merged by Bors] - chore(Algebra/Notation): move <code>Function.support</code> earlier<br>\n   Branch: algebra_notation_function_support<br>\n   Date: 2025-08-07 05:01:19<br>\n   Job 'Post-Build Step (fork)' status: FAILED<br>\n   URL: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16799992064\">https://github.com/leanprover-community/mathlib4/actions/runs/16799992064</a></p>\n<p><span aria-label=\"cross mark\" class=\"emoji emoji-274c\" role=\"img\" title=\"cross mark\">:cross_mark:</span> FOUND: Run 16797241122 failed<br>\n   Title: feat: filtering lists and bounded quantifiers are primitive recursive<br>\n   Branch: PrimRec-Filter<br>\n   Date: 2025-08-07 02:49:13<br>\n   Job 'Post-Build Step (fork)' status: FAILED<br>\n   URL: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16797241122\">https://github.com/leanprover-community/mathlib4/actions/runs/16797241122</a></p>\n<p><span aria-label=\"cross mark\" class=\"emoji emoji-274c\" role=\"img\" title=\"cross mark\">:cross_mark:</span> FOUND: Run 16797235918 failed<br>\n   Title: feat: filtering lists and bounded quantifiers are primitive recursive<br>\n   Branch: PrimRec-Filter<br>\n   Date: 2025-08-07 02:48:55<br>\n   Job 'Post-Build Step (fork)' status: FAILED<br>\n   URL: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16797235918\">https://github.com/leanprover-community/mathlib4/actions/runs/16797235918</a></p>\n<p><span aria-label=\"cross mark\" class=\"emoji emoji-274c\" role=\"img\" title=\"cross mark\">:cross_mark:</span> FOUND: Run 16797176102 failed<br>\n   Title: feat(AlgebraicTopology): the type of simplices of a simplicial set<br>\n   Branch: sset-simplices<br>\n   Date: 2025-08-07 02:45:31<br>\n   Job 'Post-Build Step (fork)' status: FAILED<br>\n   URL: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16797176102\">https://github.com/leanprover-community/mathlib4/actions/runs/16797176102</a></p>\n<p><span aria-label=\"cross mark\" class=\"emoji emoji-274c\" role=\"img\" title=\"cross mark\">:cross_mark:</span> FOUND: Run 16797116861 failed<br>\n   Title: feat(AlgebraicTopology): the type of simplices of a simplicial set<br>\n   Branch: sset-simplices<br>\n   Date: 2025-08-07 02:42:17<br>\n   Job 'Post-Build Step (fork)' status: FAILED<br>\n   URL: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16797116861\">https://github.com/leanprover-community/mathlib4/actions/runs/16797116861</a></p>\n<p>=== SUMMARY REPORT ===<br>\nTotal runs with job 'Post-Build Step (fork)' failures: 6</p>\n</div></div>",
        "id": 533332427,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754586438
    },
    {
        "content": "<p>Oh wait, these artifacts don't contain oleans. I forgot that they're saved somewhere else now... <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 533332976,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754586691
    },
    {
        "content": "<p>The artifacts should be more useful after <a href=\"https://github.com/leanprover-community/mathlib4/pull/28092\">#28092</a> is merged.</p>",
        "id": 533335877,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754587938
    },
    {
        "content": "<p>Just encountered this on <a href=\"https://github.com/leanprover-community/mathlib4/pull/28096\">#28096</a> :(</p>",
        "id": 533370193,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754604854
    },
    {
        "content": "<p>To add another case, I’m hitting this on <a href=\"https://github.com/leanprover-community/mathlib4/pull/28066\">#28066</a> (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16819070220/job/47644057771#step:6:1\">logs</a>). (I tried adding an empty commit, then tried merging master, with no luck.)</p>",
        "id": 533384795,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754617425
    },
    {
        "content": "<p>Thanks for the report and log link! Unfortunately you may have to try merging <code>master</code> again after some more commits land. Since we don't know the root cause yet, I unfortunately don't have a better suggestion at the moment.</p>\n<p>However, we might be able to learn something from <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16819070220/artifacts/3715973789\">the workflow artifact</a> (1.53GB) from the run you linked; I'm going to take a look now.</p>",
        "id": 533385366,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754617945
    },
    {
        "content": "<p>OK, I can confirm that running <code>lake build --no-build</code> on the copy of mathlib contained in the artifact succeeds, but it fails if I checkout and get the cache corresponding to the commit on your branch using:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>gh pr checkout 28066\ngit checkout 57bf93cd4cd19c879e704a22a308d0bd69921a55\nrm -rf .lake/ # to wipe out anything I had in my copy of mathlib previously\nlake exe cache --repo=thorimur/mathlib4 get\n</code></pre></div>\n<p>Here's a <a href=\"https://gist.github.com/bryangingechen/97abd845df2d83f2be109a9020068cfd\">gist</a> containing the results of <code>diff -r --brief mathlib4-from-artifact/.lake/ mathlib4-from-cache/.lake/ &gt; diff.txt</code>. There seem to be tons of differences between the contents of the two directories, but probably most of them aren't important. </p>\n<p>Here are the lines involving <code>.olean*</code> files; I suspect only these are relevant:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Files mathlib4-from-artifact/.lake/build/lib/lean/Mathlib/Algebra/ContinuedFractions/Computation/CorrectnessTerminating.olean and mathlib4-from-cache/.lake/build/lib/lean/Mathlib/Algebra/ContinuedFractions/Computation/CorrectnessTerminating.olean differ\nFiles mathlib4-from-artifact/.lake/build/lib/lean/Mathlib/Algebra/ContinuedFractions/Computation/CorrectnessTerminating.olean.hash and mathlib4-from-cache/.lake/build/lib/lean/Mathlib/Algebra/ContinuedFractions/Computation/CorrectnessTerminating.olean.hash differ\nOnly in mathlib4-from-artifact/.lake/build/lib/lean: mk_all.olean\nOnly in mathlib4-from-artifact/.lake/build/lib/lean: mk_all.olean.hash\nOnly in mathlib4-from-artifact/.lake: lakefile.olean.lock\nOnly in mathlib4-from-artifact/.lake/packages/proofwidgets/.lake: lakefile.olean.lock\n</code></pre></div>\n<p>Since the workflow upload step (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16819070220/job/47642302002#step:22:16\">log</a>) is right before the upload cache step (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16819070220/job/47642302002#step:23:19\">log</a>), it seems something in the upload cache step must be rebuilding olean files (?)</p>",
        "id": 533388792,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754621383
    },
    {
        "content": "<p>(I'm out of ideas here; if someone with more knowledge of Cache could take a look, I'd appreciate it!)</p>",
        "id": 533432669,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754646479
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28070\">#28070</a> also seems to have had such an issue; I've retried the build job now.</p>",
        "id": 533457145,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754657059
    },
    {
        "content": "<p>Unfortunately, I don't retrying the build will help since at this point the cache is already poisoned with non-working oleans... I think you'll have to merge <code>master</code>, but even that doesn't always work.</p>",
        "id": 533458393,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754657531
    },
    {
        "content": "<p>Never mind: that job actually had a genuine failure, except that is was hidden:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16825118998/job/47659660170?pr=28070\">here</a> is the new log: the \"build archive step\" failed (one line was too long) --- but only the next step errorred. Is there a way this error can be surfaced earlier? I was a bit puzzled at first (but could certainly adjust).</p>",
        "id": 533458777,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1754657667
    },
    {
        "content": "<p>Yes, that's an unfortunate side-effect of trying to ensure that both Archive and Counterexamples are built even if one or the other fails. Maybe there's a way of doing this which makes it more obvious, but this way seemed simplest.</p>",
        "id": 533459449,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754657917
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16831532797/job/47683157084\">another failed run</a></p>",
        "id": 533479210,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1754664842
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> we're having a problem in CI where several times a day, <code>lake build --no-build</code> on Mathlib succeeds before uploading the cache, but then fails in a job that downloads the cache and tries to verify that <code>lake build --no-build</code> succeeds. Is it possible that <code>leantar</code> (or the way that <code>Cache</code> is using it) is compressing an <code>olean</code> into something that forces a rebuild after decompressing? </p>\n<p>See these two messages: <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533385366\">#mathlib4 &gt; Failing CI @ 💬</a> for a link to a workflow artifact from right before uploading the cache (where <code>lake build --no-build</code> succeeds) and some commands to grab the cache that was uploaded for the corresponding commit (where <code>lake build --no-build</code> fails).</p>\n<p>Apologies for bugging you if it's not <code>leantar</code>, but I'm near my wit's end trying to figure this out. Let me know if there's anything I can provide to help here.</p>",
        "id": 533547293,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754705171
    },
    {
        "content": "<p>I am unsure if this is related, but since it involves the cache, just in case:</p>\n<p>I added <a href=\"https://github.com/leanprover-community/mathlib4/pull/28133/commits/de44587d13f83e30bc7ca96ff6eaef67caa1337a\">a commit</a> to <a href=\"https://github.com/leanprover-community/mathlib4/pull/28133\">#28133</a> (which had never hit this issue) which only modified a test in <code>MathlibTest</code>. However, although CI was green before this commit, it <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16844329549/job/47721185603?pr=28133\">rebuilt Mathlib from the PR's starting point anyway</a> after finding 0% of files in the cache. I would have expected it to find all files in the cache and just build the modified file in <code>MathlibTest</code>.</p>",
        "id": 533548374,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1754706758
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Is the new lake cache feature enabled?</p>",
        "id": 533567855,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754732482
    },
    {
        "content": "<p>I think part of the issue is that <code>grind</code> is generating nondeterministic proofs. Working on the above branch, I can't get two versions of <code>.lake/build/lib/lean/Mathlib/Algebra/ContinuedFractions/Computation/CorrectnessTerminating.olean</code> that agree</p>",
        "id": 533571053,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754736459
    },
    {
        "content": "<p>Here's a MWE: Try running this file from a fresh state (after Restart File). I observe several possible hashes at the end: <code>830471404</code>, <code>2267473999</code>, <code>1107825591</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">ContinuedFractions</span><span class=\"bp\">.</span><span class=\"n\">Computation</span><span class=\"bp\">.</span><span class=\"n\">Translations</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">ContinuedFractions</span><span class=\"bp\">.</span><span class=\"n\">TerminatedStable</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">ContinuedFractions</span><span class=\"bp\">.</span><span class=\"n\">ContinuantsRecurrence</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Filter</span><span class=\"bp\">.</span><span class=\"n\">AtTopBot</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">FieldSimp</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Ring</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">GenContFract</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">GenContFract</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">of</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">compExactValue_correctness_of_stream_eq_some</span><span class=\"bp\">.</span><span class=\"n\">extracted_1_3</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FloorRing</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ifp_n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IntFractPair</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">),</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pconts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ppconts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">;</span>\n<span class=\"w\">    </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ppA</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ppconts</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ppB</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ppconts</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pA</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pconts</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pB</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pconts</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">fract</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">)</span><span class=\"bp\">;</span>\n<span class=\"w\">      </span><span class=\"bp\">↑⌊</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"bp\">⌋</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">pA</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">ppA</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pA</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pA</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">ppA</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">        </span><span class=\"bp\">↑⌊</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"bp\">⌋</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">pB</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">ppB</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pB</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">pB</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">ppB</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">IntFractPair</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"n\">ppA</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pA</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ppB</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">pB</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">              </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IntFractPair</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"bp\">↑⌊</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"bp\">⌋</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"bp\">↑⌊</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"bp\">⌋</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">              </span><span class=\"k\">else</span>\n<span class=\"w\">                </span><span class=\"o\">(</span><span class=\"bp\">↑⌊</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"bp\">⌋</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">                    </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IntFractPair</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span>\n<span class=\"w\">                  </span><span class=\"o\">(</span><span class=\"bp\">↑⌊</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"bp\">⌋</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">                    </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"n\">contsAux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IntFractPair</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">ifp_n</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">fr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">thmInfo</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"ss\">``GenContFract.compExactValue_correctness_of_stream_eq_some.extracted_1_3._proof_1_1</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">ci</span><span class=\"bp\">.</span><span class=\"n\">value</span><span class=\"bp\">.</span><span class=\"n\">hash</span>\n</code></pre></div>",
        "id": 533572915,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754738820
    },
    {
        "content": "<p>It makes sense that this started showing up when we started using <code>grind</code> then.</p>",
        "id": 533574018,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754740014
    },
    {
        "content": "<p>I think it's not a full explanation though, as the <code>lake build --no-build</code> issue does not depend on lean being deterministic as long as the hashing process is deterministic. (I will leave it to someone else to de-mathlibify the MWE and report the nondeterminism issue to lean)</p>",
        "id": 533574102,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754740138
    },
    {
        "content": "<p>but it does make double checking the results more difficult</p>",
        "id": 533574170,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754740201
    },
    {
        "content": "<p>Oh I see why this is happening. We currently reuse oleans from previous partial runs, but in the example run, nothing was found in the cache and therefore all the files were rebuilt, and because of this nondeterminism issue the new oleans no longer match the upstream oleans. When we later try to clear the build directory and retrieve the cache, we get a mixture of files uploaded from the fresh run and files from the old run, which disagree about the olean that should have been produced on a given input, so lake detects the inconsistency and rebuilds</p>",
        "id": 533575058,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754741252
    },
    {
        "content": "<p>So now the question is: why isn't the cache hitting? <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533548374\">#mathlib4 &gt; Failing CI @ 💬</a> seems to be the root cause. (Well, lean nondeterminism is very bad, I don't think we can tolerate it in mathlib. That's also a root cause.)</p>",
        "id": 533575200,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754741423
    },
    {
        "content": "<p>I wonder if the reason for the rebuilding is because sometimes files are first built on a fork, and then later added to mathlib, meaning that the same file hash can end up in a fork cache and then on mathlib's cache. Since mathlib doesn't copy cache files from forks, that means we can't avoid rebuilding the lean file in this situation, resulting in inconsistencies when the fork later tries to mix and match</p>",
        "id": 533575575,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1754741853
    },
    {
        "content": "<p>I think the issue with the cache not hitting started when we moved to the fork-based contribution model and started uploading to caches associated to each fork repo — I think <span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> was working on this? (I wasn’t following all the details at the time so I could be thinking of something else…)</p>",
        "id": 533575603,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754741900
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533567855\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> Is the new lake cache feature enabled?</p>\n</blockquote>\n<p>No.</p>",
        "id": 533581661,
        "sender_full_name": "Mac Malone",
        "timestamp": 1754749080
    },
    {
        "content": "<p>Just linking another thread related to the cache not hitting: <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Mathlib.20CI.20doesn.27t.20get.20all.20available.20cache/with/532612398\">#mathlib4 &gt; Mathlib CI doesn't get all available cache</a></p>",
        "id": 533598443,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754769355
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533574102\">said</a>:</p>\n<blockquote>\n<p>(I will leave it to someone else to de-mathlibify the MWE and report the nondeterminism issue to lean)</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/9825\">lean#9825</a></p>",
        "id": 533672788,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754855425
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28198\">my PR also has this issue</a></p>",
        "id": 533679473,
        "sender_full_name": "Sebastian Kumar",
        "timestamp": 1754863537
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533479210\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16831532797/job/47683157084\">another failed run</a></p>\n</blockquote>\n<p>The immediate culprit here is the lemma <code>RootPairing.InvariantForm.exists_apply_eq_or</code> in <code>LinearAlgebra.RootSystem.Finite.Lemmas</code>, which uses <code>grind</code>, in particular <code>exists_apply_eq_or._proof_1_4</code> turns out to be nondeterministic.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"936817\">Sebastian Kumar</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533679473\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28198\">my PR also has this issue</a></p>\n</blockquote>\n<p>Here the issue is the lemma <code>preCantorSet_antitone</code> in <code>Topology.Instances.CantorSet</code>, which uses <code>grind</code>, in particular <code>preCantorSet_antitone._proof_1_6</code> turns out to be nondeterministic.</p>",
        "id": 533684295,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754869850
    },
    {
        "content": "<p>I'm going to open a PR to revert the <code>grind</code> proofs in these examples so at least they won't cause future issues. (We can add back <code>grind</code> after <a href=\"https://github.com/leanprover/lean4/pull/9825\">lean#9825</a> is fixed and / or the behavior of Cache is fixed.)</p>\n<p><strong>Edit</strong>: I've created the branch, but as it seems there's a fix in the works, I'll hold off on the PR for now.</p>",
        "id": 533684354,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754869949
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28148\">#28148</a> is now failing the same step in the CI, is this the same error?</p>",
        "id": 533854267,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754940581
    },
    {
        "content": "<p>The logs show errors in <code>Batteries</code> and warning for circular imports that appear to be from the new module system?</p>",
        "id": 533861543,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754943759
    },
    {
        "content": "<p>is that in like a log only the maintainers can see</p>",
        "id": 533861737,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754943868
    },
    {
        "content": "<p>hmm now i also see it for some reason</p>",
        "id": 533861891,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754943953
    },
    {
        "content": "<p>I don't think that only the maintainers can see it: if you click the triangle in the failing log, you see <em>all</em> the output.</p>",
        "id": 533861916,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754943968
    },
    {
        "content": "<p>what should I do?</p>",
        "id": 533861975,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754944005
    },
    {
        "content": "<p>I don't think that this is something that you can change, except possibly by merging master and retrying.</p>",
        "id": 533862171,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754944091
    },
    {
        "content": "<p>One of the CI steps that involve the cache has been changed some time today: that would be the first place I would look for issues, but I am no longer at a computer for the day...</p>",
        "id": 533862246,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754944134
    },
    {
        "content": "<p>Pinging <span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span>, since I think that he made the change.</p>",
        "id": 533862271,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754944147
    },
    {
        "content": "<p>It might also just be some unrelated quantum behaviour of <code>grind</code>.</p>",
        "id": 533862456,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1754944229
    },
    {
        "content": "<p>I didn't see errors in <code>Batteries</code> in <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16888055052/job/47842494197?pr=28148\">the log I was looking at</a>, but when I downloaded the artifact and checked for discrepancies in oleans per <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533388792\">#mathlib4 &gt; Failing CI @ 💬</a>, it looks like the failure here was due to  <code>RootPairing.InvariantForm.exists_apply_eq_or</code> in <code>LinearAlgebra.RootSystem.Finite.Lemmas</code> again (cf. <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533684295\">#mathlib4 &gt; Failing CI @ 💬</a> )</p>",
        "id": 533862939,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754944448
    },
    {
        "content": "<p>why doesn't the CI tell you where the inconsistency was?</p>",
        "id": 533863036,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754944506
    },
    {
        "content": "<p>We haven't made it that smart yet, and I'm hoping things will be fixed upstream so quickly we won't have to...</p>",
        "id": 533863134,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754944566
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Failing.20CI/near/533684354\">said</a>:</p>\n<blockquote>\n<p>I'm going to open a PR to revert the <code>grind</code> proofs in these examples so at least they won't cause future issues. (We can add back <code>grind</code> after <a href=\"https://github.com/leanprover/lean4/pull/9825\">lean#9825</a> is fixed and / or the behavior of Cache is fixed.)</p>\n<p><strong>Edit</strong>: I've created the branch, but as it seems there's a fix in the works, I'll hold off on the PR for now.</p>\n</blockquote>\n<p>I've opened the PR now: <a href=\"https://github.com/leanprover-community/mathlib4/pull/28272\">#28272</a> Hope I'm using <code>adaptation_note</code> correctly!</p>",
        "id": 533863429,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1754944700
    },
    {
        "content": "<p>The nondeterminism issue has been solved in <a href=\"https://github.com/leanprover/lean4/pull/9867\">lean#9867</a></p>",
        "id": 533918482,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754981706
    },
    {
        "content": "<p>I am planning on cutting v4.23.0-rc1 in two days time; are we okay to wait until then? There's no particular reason I couldn't just pull the release forward if this issue is sufficiently annoying right now.</p>",
        "id": 533918558,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754981757
    },
    {
        "content": "<p>2 days is probably fine - when the fix makes it to nightly, I'd like to confirm that the examples above are fixed.</p>",
        "id": 533990437,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1755007842
    },
    {
        "content": "<p>Possibly unrelated to the previous issue. CI for PRs seems to fail in a new way now:  <a href=\"https://github.com/leanprover-community/mathlib4/pull/27282\">#27282</a> <a href=\"https://github.com/leanprover-community/mathlib4/pull/27885\">#27885</a></p>",
        "id": 533993637,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1755008793
    },
    {
        "content": "<p>Same here: <a href=\"https://github.com/leanprover-community/mathlib4/pull/27668\">#27668</a> <a href=\"https://github.com/leanprover-community/mathlib4/pull/27464\">#27464</a></p>",
        "id": 533994154,
        "sender_full_name": "Iván Renison",
        "timestamp": 1755008926
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/NkHh4ZQHVAB5pWYDehluAIOT/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/NkHh4ZQHVAB5pWYDehluAIOT/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1109x832\" src=\"/user_uploads/thumbnail/3121/NkHh4ZQHVAB5pWYDehluAIOT/image.png/840x560.webp\"></a></div>",
        "id": 533994731,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755009082
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/D1V0_Ats98jPMuHtx_WE95cL/image.png\">image.png</a><br>\nVisiting <a href=\"http://github.com/leanprover/elan/releases/latest/\">github.com/leanprover/elan/releases/latest/</a> now shows there are no releases.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/D1V0_Ats98jPMuHtx_WE95cL/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"990x237\" src=\"/user_uploads/thumbnail/3121/D1V0_Ats98jPMuHtx_WE95cL/image.png/840x560.webp\"></a></div>",
        "id": 533995007,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755009161
    },
    {
        "content": "<p><span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span> Github says no mathing today</p>",
        "id": 533995202,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1755009222
    },
    {
        "content": "<p>Seems to be working again, could someone rerun the CI for <a href=\"https://github.com/leanprover-community/mathlib4/pull/25966\">#25966</a> ?</p>",
        "id": 534047169,
        "sender_full_name": "Bernhard Reinke",
        "timestamp": 1755028819
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> ! It seems like the \"lint and suggest\" job still has a spurious failure, could someone please rerun that job as well?</p>",
        "id": 534166299,
        "sender_full_name": "Bernhard Reinke",
        "timestamp": 1755067010
    },
    {
        "content": "<p>I have another PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/28085\">#28085</a> that's ready to merge but is failing CI for perhaps the same reason discussed above. Is there anything an author can do to fix it?</p>",
        "id": 534271290,
        "sender_full_name": "Emily Riehl",
        "timestamp": 1755105036
    },
    {
        "content": "<p>It looks like it's already on the bors queue, so I think there's nothing you need to do at the moment.</p>",
        "id": 534271391,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1755105083
    },
    {
        "content": "<p>(The standard fix for this issue has been to merge <code>master</code> and hope it goes away, but if you do that now, that will take the PR off the bors queue and someone will have to approve it again.)</p>",
        "id": 534271657,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1755105214
    },
    {
        "content": "<p>I didn't realize the bors queue could overcome errors like this. I'll just sit tight then. Thanks.</p>",
        "id": 534279152,
        "sender_full_name": "Emily Riehl",
        "timestamp": 1755108301
    },
    {
        "content": "<p>CI is failing on my PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/27562\">#27562</a> at the \"verify that everything was available in the cache\" step, does anyone know how to fix this?</p>",
        "id": 534322668,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755130791
    },
    {
        "content": "<p>Until we move to the next release of Lean (tonight / tomorrow morning, I think?) the only recourse is to merge <code>master</code> or push more commits that force rebuilds and hope it doesn't show up again.</p>",
        "id": 534325423,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1755133300
    },
    {
        "content": "<p>Just a heads up: we've switched over to a new cache host recently and have been seeing some download failures, e.g. at <a href=\"https://github.com/leanprover-community/mathlib4/pull/26074\">#26074</a> and in <a href=\"#narrow/channel/428973-nightly-testing/topic/Mathlib.20.60lake.20update.60.20failure/near/534764784\">#nightly-testing &gt; Mathlib &#96;lake update&#96; failure @ 💬</a> </p>\n<p>Please post here if you see this happen to your PR and let us know if your PR needs to be put back on the bors queue.</p>",
        "id": 534859237,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1755480729
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/17054887472/job/48350503838?pr=27215\">27215</a> is failing because the server was down, could someone please rerun this</p>",
        "id": 535034067,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755559811
    },
    {
        "content": "<p>3 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.22verify.20that.20everything.20was.20available.20in.20the.20cache.22.20fails.20CI/with/553615569\">#mathlib4 &gt; \"verify that everything was available in the cache\" fails CI</a> by <span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span>.</p>",
        "id": 553615573,
        "sender_full_name": "Notification Bot",
        "timestamp": 1762263546
    },
    {
        "content": "<p>Is anyone else hitting reviewdog failures? <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/19636763847/job/56229287309?pr=31883\">https://github.com/leanprover-community/mathlib4/actions/runs/19636763847/job/56229287309?pr=31883</a></p>",
        "id": 559056944,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1763993907
    },
    {
        "content": "<p>Yes! See e.g. <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.22lint.20and.20suggest.22.20CI.20step.20failing/with/559053464\">#mathlib4 &gt; \"lint and suggest\" CI step failing</a>  - hopefully, things are resolved again</p>",
        "id": 559057194,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763993962
    }
]