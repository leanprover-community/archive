[
    {
        "content": "<p>It seems that <code>fun_prop</code> does not play nice with <code>grind</code> as its discharger:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"n\">Set</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">bob</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ContinuousOn</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">sin</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ioo</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">π</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">disch</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">grind</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sin_pos_of_mem_Ioo</span><span class=\"o\">])</span>\n<span class=\"w\">  </span><span class=\"c1\">-- error: Unknown constant `bob._proof_1_1`</span>\n</code></pre></div>\n<p>I've also seen this happen with <code>aesop</code>, I think, but don't have an example on hand.</p>",
        "id": 561125675,
        "sender_full_name": "Albert Smith",
        "timestamp": 1764586496
    },
    {
        "content": "<p>I've seen this before! <code>grind</code> modifies the environment by adding the proof as an auxiliary definition (called <code>bob._proof_1_1</code> in this case). So it seems <code>fun_prop</code> doesn't save the environment changes made by <code>grind</code>.</p>",
        "id": 561127128,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1764586869
    },
    {
        "content": "<p>Yep, it seems like the culprit is <a href=\"https://github.com/leanprover-community/mathlib4/blob/6a263ebffc52b615a6cda0fc9a15d3879d674d10/Mathlib/Tactic/FunProp/Decl.lean#L141\">this line</a> in the definition of <code>Mathlib.Meta.FunProp.tacticToDischarge</code>, which indeed reverts the environment, so the returned expr is meaningless</p>",
        "id": 561127772,
        "sender_full_name": "Albert Smith",
        "timestamp": 1764587024
    },
    {
        "content": "<p>What's the rationale behind this — is there a reason it isn't sufficient to be running in the context of a fresh mvar? I guess it's modelled after <a href=\"https://github.com/leanprover/lean4/blob/9d4ad1273f6cea397c3066c2c83062a4410d16bf/src/Lean/Elab/Tactic/Simp.lean#L30-L62\"><code>Lean.Elab.Tactic.tacticToDischarge</code></a>, but the stated rationale is that <code>simp</code> increases mctx depth, which <code>fun_prop</code> doesn't seem to do (at least currently?), so maybe it's fine to get rid of?</p>",
        "id": 561129003,
        "sender_full_name": "Albert Smith",
        "timestamp": 1764587302
    },
    {
        "content": "<p>Looks like <code>withoutModifyingStateWithInfoAndMessages</code> is indeed a remnant of <a href=\"https://github.com/leanprover-community/mathlib4/commit/719922caa427ca291a1cad0be8cd47ae18196362\">copied code</a>. So I am in favour of removing it and seeing what happens.</p>",
        "id": 561130323,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1764587715
    },
    {
        "content": "<p>I went ahead and made a PR (<a href=\"https://github.com/leanprover-community/mathlib4/pull/32302\">#32302</a>) (my first! how exciting!). Let's see if it passes CI at least</p>",
        "id": 561140927,
        "sender_full_name": "Albert Smith",
        "timestamp": 1764590950
    },
    {
        "content": "<p>Yeah the <code>tacricToDischarge</code> is copy pasted code of which I had very little understanding of. Fixing it is very much appreciated!</p>",
        "id": 561149643,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1764593381
    }
]