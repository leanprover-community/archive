[
    {
        "content": "<p>What do you think about adding customizable postprocessing step to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/Lift.html#Mathlib.Tactic.lift\">lift</a> tactic (via <code>[lift_postprocess]</code> attribute and/or custom procs)?</p>\n<p>For example, by appropriately tagging <code>Int.ofNat_add_ofNat</code>, <code>Int.cast_ofNat_Int</code>, and <code>Int.ofNat_inj</code> we could have the following rewrites done automatically:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This should be done automatically by `lift` tactic.</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat_add_ofNat</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">cast_ofNat_Int</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">ofNat_inj</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 568045912,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768412705
    },
    {
        "content": "<p>Note that we can't really use <code>simp</code> for that, as usually the simp-normal form is with coercions pushed downwards, while for <code>lift_postprocess</code> we want to push coercions upwards with the hope of eventually eliminating them.</p>",
        "id": 568046482,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768412903
    },
    {
        "content": "<p>Is this different to what <code>norm_cast</code> does?</p>",
        "id": 568048354,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1768413519
    },
    {
        "content": "<p>Oh, I didn't know about <code>norm_cast</code>. I think that's what I wanted.<br>\nCan we make this tactic more discoverable? By e.g. mentioning it in <code>lift</code> description or adding it to <code>hint</code>?</p>",
        "id": 568050774,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768414232
    },
    {
        "content": "<p>Maybe we can make <code>lift</code> call <code>norm_cast</code> automatically by default?</p>",
        "id": 568050991,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768414309
    },
    {
        "content": "<p>You might be interested in the <em>tactic cheatsheet</em> on the <a href=\"https://leanprover-community.github.io/learn.html\">learn page</a> of the community website</p>",
        "id": 568089350,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1768428665
    },
    {
        "content": "<p>I don't think that it is a good idea to make <code>lift</code> call <code>norm_cast</code> by default. But of course, nothing is preventing you from defining a macro <code>my_lift</code> that does <code>lift</code> and then calls <code>norm_cast</code>.</p>",
        "id": 568089690,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1768428811
    },
    {
        "content": "<p>I'm not sure automatically combining tactics is a good idea, since then it just makes it harder to reason about what each tactic does</p>",
        "id": 568089694,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1768428815
    },
    {
        "content": "<p>I think that's a strange view considering many existing tactics do this, e.g. <code>rw = rewrite+rfl</code>, <code>obtain = have+rintro</code>, <code>norm_num</code> calls <code>simp only</code> I think, etc<br>\nDo you feel the same way about these or do they differ in some sense from <code>lift</code> calling <code>norm_cast</code>?</p>",
        "id": 568093658,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768430570
    },
    {
        "content": "<p>I see your point about <code>rw</code>; though note in that case we also have the uncombined version still; similarly for <code>norm_num</code> and <code>norm_num1</code>. <code>obtain</code> can't be expanded using <code>rintro</code> + <code>have</code> as far as I known.</p>",
        "id": 568093883,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1768430699
    },
    {
        "content": "<p>rintro := intro + rcases, obtain := have + rcases</p>",
        "id": 568093951,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1768430743
    },
    {
        "content": "<p>The suggestion for <code>lift</code> + <code>norm_cast</code> is a bit different, because it's basically asking for <code>lift</code> to become <code>lift &lt;;&gt; norm_cast at *</code>, which would affect the entire context.</p>",
        "id": 568093957,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1768430746
    },
    {
        "content": "<p>Oh sorry I meant <code>rcases</code></p>",
        "id": 568093960,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768430747
    },
    {
        "content": "<p>That global effect is the biggest reason I wouldn't want it to be combined.</p>",
        "id": 568094090,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1768430830
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/RFC.3A.20.60lift.60.20tactic.20postprocessing/near/568094090\">said</a>:</p>\n<blockquote>\n<p>That global effect is the biggest reason I wouldn't want it to be combined.</p>\n</blockquote>\n<p>I was thinking about it too. Maybe we could implement a smarter version of <code>norm_cast</code> that goes upwards from the given starting subexpression/subexpressions (i.e. where the <code>lift</code> was applied) and only applies cast normalization on these (without going downwards into subexpressions)?</p>",
        "id": 568111620,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768441193
    },
    {
        "content": "<p>I've made PR that adds <code>norm_cast</code> to documentation of <code>lift</code>: <a href=\"https://github.com/leanprover-community/mathlib4/pull/33987\">#33987</a></p>",
        "id": 568113725,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768442758
    },
    {
        "content": "<p>Does it make sense to add <code>lift +normalize</code> option?</p>",
        "id": 568116929,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768445751
    },
    {
        "content": "<p>I don't know; for me, <code>lift; norm_cast at *</code> is good enough.</p>",
        "id": 568116975,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768445783
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/RFC.3A.20.60lift.60.20tactic.20postprocessing/near/568116929\">said</a>:</p>\n<blockquote>\n<p>Does it make sense to add <code>lift +normalize</code> option?</p>\n</blockquote>\n<p>If it's just the same as <code>lift ..; norm_cast at *</code> then I guess not, and certainly it shouldn't be the default.</p>",
        "id": 568117171,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768445971
    }
]