[
    {
        "content": "<p>Motivated by recent threads about notation scopes, I wrote the below code to check how many unscoped notations Mathlib introduces. Let me know if there are any flaws in this logic, but by this count it is 147. (The code prints each notation name and the module that defines it.)</p>\n<p>My questions on this:</p>\n<ul>\n<li>Previous discussion has seemed to converge on placing notations in appropriately narrow scopes to avoid conflicts. Are there any exceptions that <em>should</em> remain in the top-level namespace?</li>\n<li>Would PRs scoping some of these (for me motivated by notation conflicts in CSlib) be welcome?</li>\n<li>If consensus is that usually scoped notations are best, could this be included in the technical debt metrics script?</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">unscopedNotations</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">filterMap</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"n\">cinfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isNotation</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">cinfo</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"bp\">.</span><span class=\"n\">isConstOf</span><span class=\"w\"> </span><span class=\"ss\">``Lean.TrailingParserDescr</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isAnon</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"bp\">.</span><span class=\"n\">getPrefix</span><span class=\"bp\">.</span><span class=\"n\">isAnonymous</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isNotation</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">isAnon</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">getModuleIdxFor?</span><span class=\"w\"> </span><span class=\"n\">name</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span><span class=\"o\">[</span><span class=\"n\">idx</span><span class=\"o\">]</span><span class=\"bp\">?</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"bp\">.</span><span class=\"n\">getRoot</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">          </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">else</span>\n<span class=\"w\">          </span><span class=\"n\">none</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">unscopedNotations</span><span class=\"bp\">.</span><span class=\"n\">length</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">unscopedNotations</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 553769770,
        "sender_full_name": "Chris Henson",
        "timestamp": 1762322234
    },
    {
        "content": "<p>As long as docgen does not use scoped notations, we should not generally scope all notations. Prominent examples include set notation (image, preimage etc.) and big operators (which were intentionally unscoped some time ago).</p>",
        "id": 553779942,
        "sender_full_name": "Christian Merten",
        "timestamp": 1762327055
    },
    {
        "content": "<p>How difficult is it to make docgen use scoped notations (for instance, looking for the list of <code>open</code>s in a file and using those)?</p>",
        "id": 553780804,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1762327439
    },
    {
        "content": "<p>There exists a thread for this on Zulip (on mobile right now, so can’t find the link). IIRC, it depends on a core RFC.</p>",
        "id": 553781223,
        "sender_full_name": "Christian Merten",
        "timestamp": 1762327649
    },
    {
        "content": "<p>Here is a previous thread: <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/docgen.20scoped.20notations/with/510102778\">#general &gt; docgen scoped notations</a></p>\n<p><a href=\"https://github.com/leanprover/lean4/pull/6050\">lean4#6050</a> is the RFC to keep track of what namespaces are open when a declaration is added</p>",
        "id": 553782531,
        "sender_full_name": "Chris Henson",
        "timestamp": 1762328201
    },
    {
        "content": "<p>I had seen that thread before and it slipped my mind while writing this, sorry! I suppose with that context, there is not much that can be done at the moment (except reacting to that RFC for visibility!). Every scoping of notation is at the moment forced to be a tradeoff between documentation readability and downstream conflicts.</p>",
        "id": 553788466,
        "sender_full_name": "Chris Henson",
        "timestamp": 1762330411
    },
    {
        "content": "<p>Maybe this portion is more relevant to another channel, but note how this especially conflicts with the advice given to downstream libraries. In CSlib for instance we have taken seriously the idea that all new declarations should be namespaced to the extent that I have written an environment linter to enforce that we not not create <em>any</em> new top-level declarations or namespaces (besides <code>Cslib</code>). This means that almost all of our notations are scoped and not printed in our docs.</p>",
        "id": 553789290,
        "sender_full_name": "Chris Henson",
        "timestamp": 1762330670
    }
]