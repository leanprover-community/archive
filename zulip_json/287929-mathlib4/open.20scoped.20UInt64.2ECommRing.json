[
    {
        "content": "<p>One used to be able to do <code>open scoped UInt64.CommRing</code> to be able to use <code>ring</code> with <code>UInt64</code>. Is this gone now? I can't find the commit that removed it, so I'm not sure what replaces the functionality.</p>",
        "id": 531000387,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1753562348
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"514145\">@Geoffrey Irving</span>, this is a Mathlib question (as <code>CommRing</code> is defined there). I removed these instances back at <code>v4.20</code>. Are you able to just use <code>grind</code> instead of <code>ring</code> for this? It should work with <code>UInt64</code> out of the box.</p>",
        "id": 531020174,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753572017
    },
    {
        "content": "<p>Why were these instances removed from mathlib?</p>",
        "id": 531119964,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753615181
    },
    {
        "content": "<p>Looking at <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Data/UInt.lean\">https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Data/UInt.lean</a> it seems that the docstring still promises the instances exist</p>",
        "id": 531120507,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753615392
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"514145\">Geoffrey Irving</span> <a href=\"#narrow/channel/270676-lean4/topic/open.20scoped.20UInt64.2ECommRing/near/531000387\">said</a>:</p>\n<blockquote>\n<p>I can't find the commit that removed it</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/commit/7d6781bab0100467855789de1053ccabeed34520\">https://github.com/leanprover-community/mathlib4/commit/7d6781bab0100467855789de1053ccabeed34520</a></p>",
        "id": 531121042,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753615599
    },
    {
        "content": "<p>I'm disinclined to have material about UIntX in Mathlib, as it's not particularly germane to mathematics. Downstream users who need <code>ring</code> for <code>UIntX</code> (but for whom <code>grind</code> doesn't suffice), if such exist, can let us know! Geoffrey's question indicates such users <em>may</em> exist, but let's wait to see if <code>grind</code> works for them.</p>",
        "id": 531124946,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753617047
    },
    {
        "content": "<p>(For the usual reasons; stuff that breaks on upgrades, but it not relevant to the scope of Mathlib, should not be in Mathlib, because it creates real maintenance costs.)</p>",
        "id": 531125077,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753617096
    },
    {
        "content": "<p>I've attempted to restore the missing instances, which identified a bunch of missing theorems in core in the process</p>",
        "id": 531125934,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753617430
    },
    {
        "content": "<p>This isn't just about grind, without these instanecs you can't work with <code>Matrix _ _ UInt8</code> etc</p>",
        "id": 531126024,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753617462
    },
    {
        "content": "<p>I assume you're supposed to use <code>ZMod 256</code> etc. instead?</p>",
        "id": 531129204,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753618639
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/27540\">#27540</a></p>",
        "id": 531129268,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753618662
    },
    {
        "content": "<p>One other argument for having these instances is that lemmas like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=pow_succ#doc\">docs#pow_succ</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=pow_mul#doc\">docs#pow_mul</a> can be used</p>",
        "id": 531130076,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753618972
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> I’m happy to review this, but good to get to agreement between you and <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> before I do that.</p>\n<p>As some context, I’m using these as part of <a href=\"https://github.com/girving/interval\">https://github.com/girving/interval</a>. It’s certainly possible that grind will work (might take a few days to find time to try), but as you there are a ton of downstream lemmas that require the instances and currently won’t work.</p>",
        "id": 531131076,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1753619362
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/open.20scoped.20UInt64.2ECommRing/near/531124946\">said</a>:</p>\n<blockquote>\n<p>as it's not particularly germane to mathematics</p>\n</blockquote>\n<p>I would argue that mathlib should strive to instantiate every typeclass it defines for every possible type in its dependencies, at least in cases where those instances are obviously canonical, as they are for <code>CommMonoid UInt8</code> for instance.</p>",
        "id": 531147325,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753625558
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/open.20scoped.20UInt64.2ECommRing\">#lean4 &gt; open scoped UInt64.CommRing</a> by <span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span>.</p>",
        "id": 531192289,
        "sender_full_name": "Notification Bot",
        "timestamp": 1753642055
    },
    {
        "content": "<p>(since <span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/open.20scoped.20UInt64.2ECommRing/near/531020174\">said</a> \"this is a Mathlib question\")</p>",
        "id": 531192335,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753642075
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/open.20scoped.20UInt64.2ECommRing/near/531147325\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/270676-lean4/topic/open.20scoped.20UInt64.2ECommRing/near/531124946\">said</a>:</p>\n<blockquote>\n<p>as it's not particularly germane to mathematics</p>\n</blockquote>\n<p>I would argue that mathlib should strive to instantiate every typeclass it defines for every possible type in its dependencies, at least in cases where those instances are obviously canonical, as they are for <code>CommMonoid UInt8</code> for instance.</p>\n</blockquote>\n<p>I disagree; I think Mathlib shouldn't mention BitVec, IntX, or UIntX at all. It just causes pain all round to have unnecessary instances/lemmas in Mathlib about these things. (We've already been through several rounds of this, when upgrading the theory in core and having to deal with unused but broken code in Mathlib.)</p>",
        "id": 531232104,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753658569
    },
    {
        "content": "<p>What does \"unused\" / \"unecessary\" mean here? We have a user in this thread, and we have theorems in mathlib that need these instances to apply. If <code>AddCommGroup UInt8</code> doesn't live in mathlib, where should it live?</p>",
        "id": 531233851,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753659311
    },
    {
        "content": "<p>I understand that bumping is hard work, and sometimes commenting out barely-used code is a necessary evil to get new Lean versions released; but I don't think that process should be used to argue against un-commenting it after fixing it.</p>",
        "id": 531234328,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753659521
    },
    {
        "content": "<p>I'm still not convinced we have a user who needs this. <code>grind</code> should handle whatever <code>ring</code> can do with <code>UIntX</code> (I pre-emptively agree it can't yet do what <code>ring_nf</code> can!)</p>",
        "id": 531236392,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753660400
    },
    {
        "content": "<p>Here's a theorem that can only be solved by <code>grind</code> with <a href=\"https://github.com/leanprover-community/mathlib4/pull/27540\">#27540</a> (and probably  <code>open scoped UInt64.CommRing</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Coord</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">UInt8</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">UInt8</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coord</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">grind</span>\n</code></pre></div>",
        "id": 531237517,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753660862
    },
    {
        "content": "<p>Admittedly this particular one can be fixed in a different way in core as well, but only while we're using core types throughout</p>",
        "id": 531237674,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753660915
    },
    {
        "content": "<p>I don't object <a href=\"https://github.com/leanprover-community/mathlib4/pull/27540\">#27540</a> strongly enough to want to block it being merged. I just want us to be cautious here about adding material that we might later regret having in Mathlib.</p>",
        "id": 531239646,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753661696
    },
    {
        "content": "<p>It turns out I did miss something, and in the process identified an instance diamond in BitVec</p>",
        "id": 531244307,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753663596
    },
    {
        "content": "<p>Here it turns out that the definition in core has a worse defeq, and no API was provided to convert it to the good one!</p>",
        "id": 531244888,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753663845
    },
    {
        "content": "<p>Aside: Is there <code>grind_nf</code>,  by analogy to <code>ring_nf</code>?</p>",
        "id": 531581489,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1753787972
    },
    {
        "content": "<p>No. We're thinking about it, but it won't happen immediately.</p>",
        "id": 531951765,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753919200
    },
    {
        "content": "<p>I've now update all of my <code>UInt64</code>-related proofs. <code>grind</code> worked to replace <code>ring</code> exactly 0 times, and indeed I basically never got it to work for anything <code>UInt64</code>-related. But fortunately the modifications required to fix stuff wasn't too bad (replacing <code>sub_zero</code> with <code>UInt64.sub_zero</code> and such in lots and lots of places). Overall a solid mid result. :)</p>\n<p>Mostly what I did instead of <code>ring</code> where something complicated was going on was to write some custom simp sets to turn <code>UInt64</code> and <code>Int64</code> related expressions into expressions over either <code>BitVec</code> (to be dispatched with <code>bv_decide</code>) or Int/Nat (to be dispatched with <code>omega</code>). This provided some nice simplifications in a few places: <code>bv_decide</code> is great.</p>",
        "id": 532476256,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754158341
    },
    {
        "content": "<p>Could I ping for a review on <a href=\"https://github.com/leanprover-community/mathlib4/pull/27581\">#27581</a> to fix <code>ring</code>?</p>",
        "id": 532482191,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754163511
    },
    {
        "content": "<p>I think it was already approved transitively by Kim via a dependent PR</p>",
        "id": 532482214,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754163530
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"514145\">Geoffrey Irving</span> <a href=\"#narrow/channel/287929-mathlib4/topic/open.20scoped.20UInt64.2ECommRing/near/532476256\">said</a>:</p>\n<blockquote>\n<p>Mostly what I did instead of <code>ring</code> where something complicated was going on was to write some custom simp sets to turn <code>UInt64</code> and <code>Int64</code> related expressions into expressions over either <code>BitVec</code> (to be dispatched with <code>bv_decide</code>) or Int/Nat (to be dispatched with <code>omega</code>). This provided some nice simplifications in a few places: <code>bv_decide</code> is great.</p>\n</blockquote>\n<p>bv_decide should be capable to solve UInt64 and Int64 builtin operations on its own, do you have an example of where you needed more simplifications?</p>",
        "id": 532482646,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754163922
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/open.20scoped.20UInt64.2ECommRing/near/532482191\">said</a>:</p>\n<blockquote>\n<p>Could I ping for a review on <a href=\"https://github.com/leanprover-community/mathlib4/pull/27581\">#27581</a> to fix <code>ring</code>?</p>\n</blockquote>\n<p>Looks good, approved! Sorry for delay.</p>",
        "id": 532485505,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754166467
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> Here are two different <code>bv_decide</code> error messages depending on which imports I use:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">BVDecide</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span>\n\n<span class=\"sd\">/-- None of the hypotheses are in the supported BitVec fragment after applying preprocessing.</span>\n<span class=\"sd\">There are three potential reasons for this:</span>\n<span class=\"sd\">1. If you are using custom BitVec constructs simplify them to built-in ones.</span>\n<span class=\"sd\">2. If your problem is using only built-in ones it might currently be out of reach.</span>\n<span class=\"sd\">   Consider expressing it in terms of different operations that are better supported.</span>\n<span class=\"sd\">3. The original goal was reduced to False and is thus invalid. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">basic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">toInt64</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_decide</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/-- The prover found a potentially spurious counterexample:</span>\n<span class=\"sd\">- It abstracted the following unsupported expressions as opaque variables: [n.toInt64.toUInt64]</span>\n<span class=\"sd\">Consider the following assignment:</span>\n<span class=\"sd\">n.toInt64.toUInt64 = 18446744073709551615</span>\n<span class=\"sd\">n = 9223372036854775807 -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">basic</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">toInt64</span><span class=\"bp\">.</span><span class=\"n\">toUInt64</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">bv_decide</span>\n</code></pre></div>",
        "id": 532485974,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754166908
    },
    {
        "content": "<p>Any way to get rid of <code>Lean.ofReduceBool</code> for <code>bv_decide</code>, by the way? I ended up only using it &lt;10 times, which is fortunate since I forgot it introduces a compiler dependency. If it's unavoidable I'll try to replace the <code>bv_decide</code>s with <code>omega</code>s.</p>",
        "id": 532486164,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754167107
    },
    {
        "content": "<p>You're not supposed to import <code>.Syntax</code> but the whole module, if you do that you get the same error message. The reason here is that we forgot to tag some lemmas in core, I'll see it fixed on Tuesday</p>",
        "id": 532486177,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754167125
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"514145\">Geoffrey Irving</span> <a href=\"#narrow/channel/287929-mathlib4/topic/open.20scoped.20UInt64.2ECommRing/near/532486164\">said</a>:</p>\n<blockquote>\n<p>Any way to get rid of <code>Lean.ofReduceBool</code> for <code>bv_decide</code>, by the way? I ended up only using it &lt;10 times, which is fortunate since I forgot it introduces a compiler dependency. If it's unavoidable I'll try to replace the <code>bv_decide</code>s with <code>omega</code>s.</p>\n</blockquote>\n<p>No</p>",
        "id": 532486182,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754167129
    },
    {
        "content": "<p>Fixed at <a href=\"https://github.com/leanprover/lean4/pull/9721\">https://github.com/leanprover/lean4/pull/9721</a></p>",
        "id": 532860394,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1754381767
    },
    {
        "content": "<p>Can I get a delegation on <a href=\"https://github.com/leanprover-community/mathlib4/pull/27540\">#27540</a>? It was previously bors merged, but that was before the dependencies landed so I'm not sure if I should just merge it myself.</p>",
        "id": 533415626,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754639996
    },
    {
        "content": "<p>If delegation is something I can do, can you refresh my memory on what it means and how I would do it?</p>",
        "id": 533418639,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1754641113
    },
    {
        "content": "<p>It is not</p>",
        "id": 533418873,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754641211
    }
]