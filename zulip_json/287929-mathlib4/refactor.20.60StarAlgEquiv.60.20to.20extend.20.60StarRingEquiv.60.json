[
    {
        "content": "<p>At the moment, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=StarAlgEquiv#doc\">docs#StarAlgEquiv</a> extends <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingEquiv#doc\">docs#RingEquiv</a> and has two additional properties: <code>map_star'</code> and <code>map_smul'</code>. Since we now have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=StarRingEquiv#doc\">docs#StarRingEquiv</a>, shouldn't we let <code>StarAlgEquiv</code> extend it? This wouldn't really change much (besides simplifying some proofs since we wouldn't need to provide <code>map_star'</code>), it would be a very minor refactoring.</p>",
        "id": 537689389,
        "sender_full_name": "Monica Omar",
        "timestamp": 1756996875
    },
    {
        "content": "<p>That's fine. At one point I had a plan to refactor <code>AlgEquiv</code> to allow for non-unital algebras, but I never finished it.</p>",
        "id": 537698780,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1756999423
    },
    {
        "content": "<p>That would be a good next step. Then <code>StarAlgEquiv</code> would literally just extend <code>StarRingEquiv</code> and <code>AlgEquiv</code>, which would be nice.</p>\n<p>I can try refactoring <code>AlgEquiv</code> sometime soon if you don't want to :)</p>",
        "id": 537700686,
        "sender_full_name": "Monica Omar",
        "timestamp": 1756999990
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"477483\">@Monica Omar</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/8686\">#8686</a></p>",
        "id": 537718830,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1757006139
    },
    {
        "content": "<p>ufft from 2 years ago. 35+ files have merge conflicts. Wouldn't it be better to just start over <span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span>?</p>",
        "id": 537727633,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757009849
    },
    {
        "content": "<p>I'm guessing it'd be roughly equal amount of work either way</p>",
        "id": 537728342,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1757010157
    },
    {
        "content": "<p><del>Wouldn't it confuse some users that there's <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NonUnitalAlgHom#doc\">docs#NonUnitalAlgHom</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgHom#doc\">docs#AlgHom</a>, but then (after a refactor) there would only be a non-unital <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgEquiv%3F#doc\">docs#AlgEquiv?</a> Wouldn't it make more sense to have <code>NonUnitalAlgEquiv</code> to match the homomorphisms?</del> forget what I said</p>",
        "id": 537730550,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757010994
    },
    {
        "content": "<p>we already have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NonUnitalAlgEquivClass#doc\">docs#NonUnitalAlgEquivClass</a>, but in the <code>/StarAlgHom</code> file (with a note that says that it's mostly an implementation detail for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=StarAlgEquivClass#doc\">docs#StarAlgEquivClass</a>, which no longer exists apparently?)</p>",
        "id": 537731276,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757011297
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"477483\">Monica Omar</span> <a href=\"#narrow/channel/287929-mathlib4/topic/refactor.20.60StarAlgEquiv.60.20to.20extend.20.60StarRingEquiv.60/near/537727633\">said</a>:</p>\n<blockquote>\n<p>ufft from 2 years ago. 35+ files have merge conflicts. Wouldn't it be better to just start over <span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span>?</p>\n</blockquote>\n<p>Yes, it might indeed be easier to start over, but you can look at that PR to see what I did / how I approached it. Some of the fixes may still work.</p>",
        "id": 537751241,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1757018800
    },
    {
        "content": "<p><code>StarAlgEquivClass</code> went away because we started unbundling some of the morphism classes for performance reasons, and that note about <code>NonUnitalAlgEquivClass</code> never got updated.</p>",
        "id": 537751731,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1757018963
    },
    {
        "content": "<p>Note that <code>NonUnitalAlgEquivClass</code> is a strict generalization of <code>AlgEquivClass</code> in the sense that the type class assumptions are more general, and in the narrower case (i.e., when you have <code>Algebra</code>s), <code>NonUnitalAlgEquivClass</code> implies <code>AlgEquivClass</code>.</p>",
        "id": 537751944,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1757019039
    },
    {
        "content": "<p>There's only one file left to fix for the refactoring of <code>AlgEquiv</code>: <a href=\"https://github.com/leanprover-community/mathlib4/pull/29354\">#29354</a></p>\n<p>The problem is with <code>Ideal.Quotient.stabilizerHom_surjective_of_profinite</code> in <code>RingTheory/Invariant/Profinite</code>, I don't know what's going on here. It's causing a timeout for some reason. If someone can help with this, I'd appreciate it :)</p>",
        "id": 539175473,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757718173
    },
    {
        "content": "<p><code>set_option maxHeartbeats 400000 in</code> fixes it, although this isn't ideal.</p>",
        "id": 539176858,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757719094
    },
    {
        "content": "<p>Definitely not ideal. Do you know what is happening here?</p>",
        "id": 539177122,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757719278
    },
    {
        "content": "<p>The trace is one of those annoying traces where the numbers don't add up:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>              [] [1.479886] obtain ⟨N, hN⟩ :=\n                    ProfiniteGrp.exist_openNormalSubgroup_sub_open_nhds_of_one (stabilizer_isOpen G x) (one_mem _) ▼\n                [Meta.check] [0.145134] ✅️ (∃ H, ↑H ⊆ ↑(MulAction.stabilizer G x)) → ((stabilizerHom Q P G) ⟨a, ⋯⟩) ((mk Q) x) = σ ((mk Q) x) ▶\n</code></pre></div>\n<p>The sum of the numbers in the more indented lines (0.145) is supposed to add up to the number in the less indented line (1.47) so there's a missing 1.3 seconds which is really hard to explain without running a debugger or something. I'm travelling right now but were I to be at home with a two screen setup I would be tempted to open two copies of mathlib on master and your branch and see if the numbers were very different or whether you've just pushed something over the edge.</p>",
        "id": 539177345,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757719432
    },
    {
        "content": "<p>Sometimes changes just cause things like this to happen but it's annoying not really understanding where the missing 1.3 seconds are.</p>",
        "id": 539177391,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757719465
    },
    {
        "content": "<p>maybe the time is disappearing into a function whose trace is not enabled</p>",
        "id": 539178112,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757719948
    },
    {
        "content": "<p>like death by a thousand <code>whnf</code>s</p>",
        "id": 539178201,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757720009
    },
    {
        "content": "<p>No idea why, but this fixes it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">mk_surjective</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hx</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ProfiniteGrp</span><span class=\"bp\">.</span><span class=\"n\">exist_openNormalSubgroup_sub_open_nhds_of_one</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">stabilizer_isOpen</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">one_mem</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hx</span>\n<span class=\"w\">    </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">B'</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"n\">toOpenSubgroup</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n</code></pre></div>\n<p>i.e. break up the two obtains into two steps, and then give a hint to the lift about what the type of g is <em>shrug</em></p>",
        "id": 539178841,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757720482
    },
    {
        "content": "<p>It's giving me a timeout with that. I'll try again tomorrow. Been on this branch for 8 hours straight <span aria-label=\"zzz\" class=\"emoji emoji-1f4a4\" role=\"img\" title=\"zzz\">:zzz:</span>.</p>",
        "id": 539179976,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757721248
    },
    {
        "content": "<p>I'm surprised we're having different experiences. Here's the entire proof, which isn't timing out for me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The stabilizer subgroup of `Q` surjects onto `Aut((B/Q)/(A/P))`. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">stabilizerHom_surjective_of_profinite</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">IsPrime</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">LiesOver</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsInvariant</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Surjective</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">stabilizerHom</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">σ</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">B'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FixedPoints</span><span class=\"bp\">.</span><span class=\"n\">subalgebra</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hs</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nonempty_sections_of_finite_cofiltered_system</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">stabilizerHomSurjectiveAuxFunctor</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"n\">σ</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ProfiniteGrp</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isoLimittoFiniteQuotientFunctor</span><span class=\"bp\">.</span><span class=\"n\">inv</span><span class=\"bp\">.</span><span class=\"n\">hom</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"n\">N'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">congr</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">hs</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">))</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OpenNormalSubgroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">QuotientGroup</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">congr_fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">congr_arg</span><span class=\"w\"> </span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ConcreteCategory</span><span class=\"bp\">.</span><span class=\"n\">congr_hom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ProfiniteGrp</span><span class=\"bp\">.</span><span class=\"n\">of</span>\n<span class=\"w\">      </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isoLimittoFiniteQuotientFunctor</span><span class=\"bp\">.</span><span class=\"n\">inv_hom_id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">  </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"bp\">⟨⟨</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">?_⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">?_⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ProfiniteGrp</span><span class=\"bp\">.</span><span class=\"n\">exist_openNormalSubgroup_sub_open_nhds_of_one</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">stabilizer_isOpen</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">one_mem</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">B'</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">    </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B'</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">under</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B'</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">comap_comap</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">pointwise_smul_eq_comap</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">comap_coe</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">RingEquiv</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)]</span>\n<span class=\"w\">    </span><span class=\"n\">congr!</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">rfl</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">mk_surjective</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hx</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ProfiniteGrp</span><span class=\"bp\">.</span><span class=\"n\">exist_openNormalSubgroup_sub_open_nhds_of_one</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">stabilizer_isOpen</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">one_mem</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hx</span>\n<span class=\"w\">    </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">B'</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"n\">N</span><span class=\"bp\">.</span><span class=\"n\">toOpenSubgroup</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">hN</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">    </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">QuotientGroup</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">    </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">DFunLike</span><span class=\"bp\">.</span><span class=\"n\">congr_fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Quotient</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 539181019,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757721869
    },
    {
        "content": "<p>It's a beautiful result, it shows the existence of Frobenius elements. It was first proved for G finite in FLT (perhaps modulo one or two intermediate sorries) and then ported over to mathlib by Thomas Browning and then generalised to profinite groups by Andrew Yang. I had no idea the theorem was true in this generality; Joel Riou pointed it out to me. I learnt the proof from Bourbaki.</p>",
        "id": 539181425,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757722077
    },
    {
        "content": "<p>Ahh. It does work. My bad. I forgot about the first <code>obtain</code> and only thought about the second one.</p>",
        "id": 539181690,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757722249
    },
    {
        "content": "<p>Yeah sorry, I should have posted the entire proof first rather than a random fragment.</p>",
        "id": 539182041,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757722485
    },
    {
        "content": "<p>The benchmark results on <a href=\"https://github.com/leanprover-community/mathlib4/pull/29354\">#29354</a> don't look great :/<br>\nDoes anyone have any thoughts on what to do to make things run smoother here?</p>",
        "id": 539272560,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757771066
    },
    {
        "content": "<p>I think that this is always the problem with these refactors. It does not surprise me that things are slower and I think that this might just be inevitable. It would be good if someone could prove me wrong!</p>",
        "id": 539363046,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757799015
    },
    {
        "content": "<p>I also think that whilst we traditionally look at the reds and greens in the output and go \"oh dear, more red than green this must be a step in the wrong direction\", these percentages are kind of meaningless in some sense because just knowing the percentage increase or decrease doesn't tell you too much about the absolute changes. Here's another way of looking at it: the total build has gone up 100 billion instructions but the total lint has gone <em>down</em> over 100 billion instructions and so actually there's a net win here.</p>",
        "id": 539363262,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757799281
    },
    {
        "content": "<p>but why is lint faster</p>",
        "id": 539363332,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757799347
    },
    {
        "content": "<p>It's no longer faster after I did some extra generalizations.</p>\n<p>So there's two things that I'm not sure what to do about:<br>\n1- <del><code>@[to_additive]</code> failing: see <a href=\"https://github.com/leanprover-community/mathlib4/pull/29354#discussion_r2344739259\">comment</a></del><br>\n2- a type mismatch error: see <a href=\"https://github.com/leanprover-community/mathlib4/pull/29354#discussion_r2460348015\">comment</a></p>\n<p>Besides that, there were 2 other things I've commented on where things were strange.</p>\n<p>If anyone wants to take a look and help out, that would be great :)</p>",
        "id": 539425629,
        "sender_full_name": "Monica Omar",
        "timestamp": 1757871177
    },
    {
        "content": "<p>There's a new problem with the refactor pr <a href=\"https://github.com/leanprover-community/mathlib4/pull/29354\">#29354</a> now, after the <code>Gal(_/_)</code> notation was pushed earlier today.<br>\nThe problem is with <code>MathlibTest/GalNotation</code>.<br>\n<span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> since you authored it, can you take a look?</p>\n<p>At the moment, it's printing <code>_ ≃ₐ[_] _</code> for everything.</p>",
        "id": 545286348,
        "sender_full_name": "Monica Omar",
        "timestamp": 1760615290
    },
    {
        "content": "<p>You changed the arity for <code>AlgEquiv</code> so you should change line 41 of <code>Galois/Notation.lean</code> to </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isAppOfArity</span><span class=\"w\"> </span><span class=\"ss\">``AlgEquiv</span><span class=\"w\"> </span><span class=\"mi\">9</span>\n</code></pre></div>\n<p>And line 43 to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">R</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExpr</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">getAppArgs</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">failure</span>\n</code></pre></div>",
        "id": 545287619,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1760615501
    },
    {
        "content": "<p>Merging master to <a href=\"https://github.com/leanprover-community/mathlib4/pull/29354\">#29354</a> today gave me another timeout error with the <code>RingTheory/Invariant/Profinite</code> file again, but this time with a definition: <code>Ideal.Quotient.stabilizerHomSurjectiveAuxFunctor</code>.<br>\n<code>set_option maxHeartbeats 201000 in</code> fixes it, but that's not really a good fix.<br>\nIf someone can help with this, I'd appreciate it :)</p>",
        "id": 548004376,
        "sender_full_name": "Monica Omar",
        "timestamp": 1761847960
    },
    {
        "content": "<p>I'm not sure what's going wrong that this file keeps timing out</p>",
        "id": 548004487,
        "sender_full_name": "Monica Omar",
        "timestamp": 1761847993
    },
    {
        "content": "<p>Can you try <code>!bench</code>ing the PR to see if your refactor slows down only that file or everything else and if so by how much?</p>",
        "id": 548004730,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1761848063
    },
    {
        "content": "<p>I am guessing this change is requiring lean to go through the <code>CommRing -&gt; CommSemiring -&gt; CommMonoid -&gt; Monoid -&gt; Semigroup -&gt; Mul</code> chain a lot more times and because there are multiple (reducibly defeq) such paths lean is spending more time to unify them.</p>",
        "id": 548005927,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1761848391
    },
    {
        "content": "<p>Yeah probably. Let's see. For reference, the last bench from 6 weeks ago:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">build</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"mf\">129.853</span><span class=\"bp\">⬝</span><span class=\"mi\">10</span><span class=\"bp\">⁹</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mf\">0.08</span><span class=\"bp\">%</span><span class=\"o\">)</span>\n<span class=\"n\">lint</span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"bp\">-</span><span class=\"mf\">120.806</span><span class=\"bp\">⬝</span><span class=\"mi\">10</span><span class=\"bp\">⁹</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mf\">1.72</span><span class=\"bp\">%</span><span class=\"o\">)</span>\n</code></pre></div>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/29354#issuecomment-3289623504\">https://github.com/leanprover-community/mathlib4/pull/29354#issuecomment-3289623504</a></p>",
        "id": 548006376,
        "sender_full_name": "Monica Omar",
        "timestamp": 1761848537
    },
    {
        "content": "<p>things are so much worse now than 6 weeks ago:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">build</span><span class=\"w\">   </span><span class=\"bp\">+</span><span class=\"mf\">758.462</span><span class=\"bp\">⬝</span><span class=\"mi\">10</span><span class=\"bp\">⁹</span><span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mf\">0.44</span><span class=\"bp\">%</span><span class=\"o\">)</span>\n<span class=\"n\">lint</span><span class=\"w\">    </span><span class=\"bp\">+</span><span class=\"mf\">22.396</span><span class=\"bp\">⬝</span><span class=\"mi\">10</span><span class=\"bp\">⁹</span><span class=\"w\">     </span><span class=\"o\">(</span><span class=\"bp\">+</span><span class=\"mf\">0.33</span><span class=\"bp\">%</span><span class=\"o\">)</span>\n</code></pre></div>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/29354#issuecomment-3469614397\">https://github.com/leanprover-community/mathlib4/pull/29354#issuecomment-3469614397</a></p>",
        "id": 548013245,
        "sender_full_name": "Monica Omar",
        "timestamp": 1761850824
    }
]