[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/14637\">#14637</a> I attempted to make <code>nonZeroDivisors.ne_zero</code> a <code>simp</code> lemma, and when running a benchmark it says that <code>Mathlib.NumberTheory.ModularForms.SlashActions</code> got slower by <code>24.0%</code>. How significant is that? Enough to make this change bad?</p>",
        "id": 450625814,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720676461
    },
    {
        "content": "<p>On individual modules, I'm not sure how interpretable the results are unless you go in and figure out what got slower. To me, it's somewhat significant that mathlib took 0.2% more instructions to build. That's not enough to say it's bad, but it's enough to think about whether this simp lemma is worth it.</p>",
        "id": 450626939,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720677380
    },
    {
        "content": "<p>I would suggest not having this simp lemma, because it means that whenever <code>x ≠ 0</code> is seen, then <code>simp</code> will try to synthesize a <code>MonoidWithZero M</code> instance, a <code>Nontrivial M</code> instance, and a proof of <code>x ∈ nonZeroDivisors M</code>. How often do we expect that third condition to hold?</p>",
        "id": 450627109,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720677509
    },
    {
        "content": "<p>I see, not very often. Making <code>nonZeroDivisors.coe_ne_zero</code> <code>simp</code> should be fine though, right?</p>",
        "id": 450634872,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720681648
    },
    {
        "content": "<p>Michael Stoll posted a script to summarize the bench output.  I have a branch where I would like to make it post the summary on every <code>!bench</code>.  I have not done that yet, but this is what it would say in your case:</p>\n<table>\n<thead>\n<tr>\n<th>File</th>\n<th style=\"text-align: right;\">Instructions</th>\n<th style=\"text-align: center;\">%</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Increase</code></td>\n<td style=\"text-align: right;\"></td>\n<td style=\"text-align: center;\"></td>\n</tr>\n<tr>\n<td>build</td>\n<td style=\"text-align: right;\">+250.764⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.20%)</td>\n</tr>\n<tr>\n<td>lint</td>\n<td style=\"text-align: right;\">+160.357⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.0%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.ModularForms.SlashActions</td>\n<td style=\"text-align: right;\">+18.499⬝10⁹</td>\n<td style=\"text-align: center;\">(+24.4%)</td>\n</tr>\n<tr>\n<td>Mathlib.Topology.ContinuousFunction.NonUnitalFunctionalCalculus</td>\n<td style=\"text-align: right;\">+7.876⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.14%)</td>\n</tr>\n<tr>\n<td>Mathlib.AlgebraicGeometry.EllipticCurve.Affine</td>\n<td style=\"text-align: right;\">+7.836⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.75%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.NumberField.CanonicalEmbedding.ConvexBody</td>\n<td style=\"text-align: right;\">+6.697⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.81%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Lie.Weights.Killing</td>\n<td style=\"text-align: right;\">+5.962⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.63%)</td>\n</tr>\n<tr>\n<td>Mathlib.AlgebraicGeometry.ProjectiveSpectrum.Scheme</td>\n<td style=\"text-align: right;\">+3.722⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.33%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.ArithmeticFunction</td>\n<td style=\"text-align: right;\">+3.595⬝10⁹</td>\n<td style=\"text-align: center;\">(+4.28%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.NumberField.Units.DirichletTheorem</td>\n<td style=\"text-align: right;\">+3.569⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.15%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Polynomial.Div</td>\n<td style=\"text-align: right;\">+3.19⬝10⁹</td>\n<td style=\"text-align: center;\">(+7.68%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.Zsqrtd.Basic</td>\n<td style=\"text-align: right;\">+2.746⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.42%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.AlgebraicIndependent</td>\n<td style=\"text-align: right;\">+2.706⬝10⁹</td>\n<td style=\"text-align: center;\">(+4.98%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.MeanInequalities</td>\n<td style=\"text-align: right;\">+2.671⬝10⁹</td>\n<td style=\"text-align: center;\">(+4.65%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Lie.Weights.Chain</td>\n<td style=\"text-align: right;\">+2.625⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.20%)</td>\n</tr>\n<tr>\n<td>Mathlib.LinearAlgebra.Dual</td>\n<td style=\"text-align: right;\">+2.617⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.67%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.MvPolynomial.Basic</td>\n<td style=\"text-align: right;\">+2.346⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.63%)</td>\n</tr>\n<tr>\n<td>Mathlib.MeasureTheory.Measure.Lebesgue.VolumeOfBalls</td>\n<td style=\"text-align: right;\">+2.293⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.59%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.Padics.PadicIntegers</td>\n<td style=\"text-align: right;\">+2.286⬝10⁹</td>\n<td style=\"text-align: center;\">(+4.64%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.UniqueFactorizationDomain</td>\n<td style=\"text-align: right;\">+2.273⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.64%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.MvPolynomial.Homogeneous</td>\n<td style=\"text-align: right;\">+2.261⬝10⁹</td>\n<td style=\"text-align: center;\">(+5.74%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.SpecialFunctions.Pow.NNReal</td>\n<td style=\"text-align: right;\">+2.257⬝10⁹</td>\n<td style=\"text-align: center;\">(+5.99%)</td>\n</tr>\n<tr>\n<td>Mathlib.Geometry.Euclidean.Angle.Oriented.Basic</td>\n<td style=\"text-align: right;\">+2.27⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.58%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.PowerSeries.Order</td>\n<td style=\"text-align: right;\">+1.974⬝10⁹</td>\n<td style=\"text-align: center;\">(+9.15%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Algebra.Quasispectrum</td>\n<td style=\"text-align: right;\">+1.925⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.26%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.Polynomial.Cyclotomic.Eval</td>\n<td style=\"text-align: right;\">+1.858⬝10⁹</td>\n<td style=\"text-align: center;\">(+5.92%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.LegendreSymbol.GaussEisensteinLemmas</td>\n<td style=\"text-align: right;\">+1.722⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.90%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.PowerSeries.Inverse</td>\n<td style=\"text-align: right;\">+1.616⬝10⁹</td>\n<td style=\"text-align: center;\">(+6.7%)</td>\n</tr>\n<tr>\n<td>Mathlib.Probability.Distributions.Gaussian</td>\n<td style=\"text-align: right;\">+1.600⬝10⁹</td>\n<td style=\"text-align: center;\">(+5.20%)</td>\n</tr>\n<tr>\n<td>Mathlib.MeasureTheory.Function.L1Space</td>\n<td style=\"text-align: right;\">+1.567⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.46%)</td>\n</tr>\n<tr>\n<td>Mathlib.MeasureTheory.Integral.CircleIntegral</td>\n<td style=\"text-align: right;\">+1.558⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.26%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.Polynomial.Basic</td>\n<td style=\"text-align: right;\">+1.545⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.91%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Polynomial.RingDivision</td>\n<td style=\"text-align: right;\">+1.512⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.7%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.Analytic.IsolatedZeros</td>\n<td style=\"text-align: right;\">+1.472⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.71%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Quaternion</td>\n<td style=\"text-align: right;\">+1.460⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.69%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.NormedSpace.lpSpace</td>\n<td style=\"text-align: right;\">+1.410⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.57%)</td>\n</tr>\n<tr>\n<td>Mathlib.AlgebraicGeometry.Morphisms.QuasiCompact</td>\n<td style=\"text-align: right;\">+1.388⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.84%)</td>\n</tr>\n<tr>\n<td>Mathlib.LinearAlgebra.Dimension.Finite</td>\n<td style=\"text-align: right;\">+1.341⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.2%)</td>\n</tr>\n<tr>\n<td>Mathlib.AlgebraicGeometry.Morphisms.QuasiSeparated</td>\n<td style=\"text-align: right;\">+1.324⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.96%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Lie.Weights.RootSystem</td>\n<td style=\"text-align: right;\">+1.315⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.68%)</td>\n</tr>\n<tr>\n<td>Mathlib.Topology.ContinuousFunction.FunctionalCalculus</td>\n<td style=\"text-align: right;\">+1.286⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.1%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.SpecialFunctions.Complex.LogBounds</td>\n<td style=\"text-align: right;\">+1.285⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.76%)</td>\n</tr>\n<tr>\n<td>Mathlib.MeasureTheory.Measure.Hausdorff</td>\n<td style=\"text-align: right;\">+1.251⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.3%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.Complex.UpperHalfPlane.Basic</td>\n<td style=\"text-align: right;\">+1.239⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.59%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.Convex.EGauge</td>\n<td style=\"text-align: right;\">+1.216⬝10⁹</td>\n<td style=\"text-align: center;\">(+6.42%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.LegendreSymbol.JacobiSymbol</td>\n<td style=\"text-align: right;\">+1.213⬝10⁹</td>\n<td style=\"text-align: center;\">(+4.73%)</td>\n</tr>\n<tr>\n<td>Mathlib.LinearAlgebra.Matrix.NonsingularInverse</td>\n<td style=\"text-align: right;\">+1.213⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.67%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.SumFourSquares</td>\n<td style=\"text-align: right;\">+1.200⬝10⁹</td>\n<td style=\"text-align: center;\">(+4.40%)</td>\n</tr>\n<tr>\n<td>Mathlib.NumberTheory.NumberField.CanonicalEmbedding.Basic</td>\n<td style=\"text-align: right;\">+1.192⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.77%)</td>\n</tr>\n<tr>\n<td>Mathlib.Combinatorics.Additive.AP.Three.Behrend</td>\n<td style=\"text-align: right;\">+1.191⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.4%)</td>\n</tr>\n<tr>\n<td>Mathlib.Geometry.Euclidean.Angle.Oriented.Rotation</td>\n<td style=\"text-align: right;\">+1.184⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.64%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.DedekindDomain.Ideal</td>\n<td style=\"text-align: right;\">+1.158⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.66%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.Flat.EquationalCriterion</td>\n<td style=\"text-align: right;\">+1.148⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.19%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.Convex.Between</td>\n<td style=\"text-align: right;\">+1.148⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.86%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.NormedSpace.Star.ContinuousFunctionalCalculus.Instances</td>\n<td style=\"text-align: right;\">+1.143⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.42%)</td>\n</tr>\n<tr>\n<td>Mathlib.MeasureTheory.Integral.TorusIntegral</td>\n<td style=\"text-align: right;\">+1.138⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.84%)</td>\n</tr>\n<tr>\n<td>Mathlib.LinearAlgebra.CliffordAlgebra.Prod</td>\n<td style=\"text-align: right;\">+1.111⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.9%)</td>\n</tr>\n<tr>\n<td>Mathlib.Probability.ProbabilityMassFunction.Constructions</td>\n<td style=\"text-align: right;\">+1.84⬝10⁹</td>\n<td style=\"text-align: center;\">(+5.41%)</td>\n</tr>\n<tr>\n<td>Mathlib.Probability.Integration</td>\n<td style=\"text-align: right;\">+1.81⬝10⁹</td>\n<td style=\"text-align: center;\">(+6.99%)</td>\n</tr>\n<tr>\n<td>Mathlib.Topology.MetricSpace.Perfect</td>\n<td style=\"text-align: right;\">+1.77⬝10⁹</td>\n<td style=\"text-align: center;\">(+4.4%)</td>\n</tr>\n<tr>\n<td>Mathlib.Algebra.Category.Ring.Constructions</td>\n<td style=\"text-align: right;\">+1.71⬝10⁹</td>\n<td style=\"text-align: center;\">(+3.6%)</td>\n</tr>\n<tr>\n<td>Mathlib.Geometry.Euclidean.MongePoint</td>\n<td style=\"text-align: right;\">+1.56⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.7%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.Calculus.ContDiff.Basic</td>\n<td style=\"text-align: right;\">+1.46⬝10⁹</td>\n<td style=\"text-align: center;\">(+0.24%)</td>\n</tr>\n<tr>\n<td>Mathlib.RingTheory.HahnSeries.Summable</td>\n<td style=\"text-align: right;\">+1.39⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.48%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.RCLike.Basic</td>\n<td style=\"text-align: right;\">+1.5⬝10⁹</td>\n<td style=\"text-align: center;\">(+1.9%)</td>\n</tr>\n<tr>\n<td>Mathlib.Analysis.Calculus.LineDeriv.IntegrationByParts</td>\n<td style=\"text-align: right;\">+1.1⬝10⁹</td>\n<td style=\"text-align: center;\">(+2.15%)</td>\n</tr>\n<tr>\n<td><code>Decrease</code></td>\n<td style=\"text-align: right;\"></td>\n<td style=\"text-align: center;\"></td>\n</tr>\n</tbody>\n</table>",
        "id": 450638116,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720682969
    },
    {
        "content": "<p>The problem is that Lean figures out which <code>simp</code> theorems to try to use by looking at the expression to be simplified itself only. The leaves a blindspot when there are <code>simp</code> theorems with \"simple\" statements, like <code>x ≠ 0</code>, but more \"complicated\" proofs and hence requirements (parameters). </p>\n<p>Since the conclusion <code>x ≠ 0</code> contains no information about needing a <code>MonoidWithZero</code> that is <code>Nontrivial</code>, Lean can't take this into account before trying to apply the theorem. The result is more failed attempts to apply it. The attempts to synthesize <code>MonoidWithZero</code> and <code>Nontrivial</code> come at a cost that, while seemingly small, can snowball over the whole of the library downstream from the declaration. </p>\n<p>Looking  at the benchmark results, the 0.2% that Kyle mentioned is pretty significant for a change to overall instructions. It is comparable (but in the opposite direction) to ripping out an older less efficient API, like <a href=\"http://speed.lean-fro.org/mathlib4/run-detail/0c9ad470-8806-4749-b395-b60b021bd402\">here</a>. </p>\n<p>Another data point from the benchmark that indicates that there are a lot of false positives with this as a <code>simp</code> theorem is the fact that linting instructions increased by 2% overall. Linting is dominated by the <code>simpNF</code> linter which tries to check normal forms for all <code>simp</code> theorems (in addition to other checks) by running <code>simp</code> on them. It needs to do a noticable amount more work (10s by wall clock but that tends to be more random than instructions) with <code>nonZeroDivisors.coe_ne_zero</code> marked as <code>simp</code>. </p>\n<p>For individual level files, a 25% change is not noise and should be something that is understood before making a decision. </p>\n<p>I think a good rule of thumb is to look at total changes in instructions for building and for linting both divided by lines of code touched.</p>",
        "id": 450639706,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720683525
    },
    {
        "content": "<p>Is there a particular use case in mind for marking this as <code>simp</code>?</p>",
        "id": 450639981,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720683628
    },
    {
        "content": "<p>Nothing that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=nonZeroDivisors.coe_ne_zero#doc\">docs#nonZeroDivisors.coe_ne_zero</a> couldn't also prove, I just didn't expect it to have a noticeable performance impact.</p>",
        "id": 450640608,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720683876
    },
    {
        "content": "<p>(Just to clarify, the summary above discards changes of &lt; 10^9 instructions in absolute value.)</p>",
        "id": 450640696,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720683912
    },
    {
        "content": "<p>It is hard to predict. Interactions are complex.</p>",
        "id": 450640717,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720683922
    },
    {
        "content": "<p>We probably have many existing <code>simp</code> theorems that are doing exactly this in <code>master</code> currently</p>",
        "id": 450640882,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720683974
    },
    {
        "content": "<p>It's good to benchmark anything that </p>\n<ul>\n<li>modifies the import graph </li>\n<li>adds global <code>simp</code> theorems or </li>\n<li>adds global <code>instance</code>s </li>\n</ul>\n<p>so one doesn't need to speculate and can just see the fallout directly. It is great to see this done before things are merged!</p>",
        "id": 450641339,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720684157
    },
    {
        "content": "<p>I moved the <code>@[simp]</code> to <code>coe_ne_zero</code> and now the benchmark seems fine</p>",
        "id": 450646069,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720685823
    },
    {
        "content": "<p><code>nonZeroDivisors.coe_ne_zero</code> is better as a simp lemma, since the conclusion contains the MonoidWithZero instance, which constrains it more, and also the lemma is not conditional on discharging another hypothesis. There's still a cost to needing to synthesize a Nontrivial instance, but it's likely to succeed given the conclusion.</p>",
        "id": 450650363,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720687207
    },
    {
        "content": "<p>In principle, I agree but what are the keys for these two declarations? </p>\n<p>For <code>ne_zero</code>, I get <code>#[*]</code>. </p>\n<p>For <code>coe_ne_zero</code>, I get <code>#[Subtype.0, *]</code>.</p>",
        "id": 450651428,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720687530
    },
    {
        "content": "<p>For reference, here is what I am using </p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">discrKey</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">DiscrTree.Key</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withReducible</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">forallMetaTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">whnfR</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type.eq</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">DiscrTree.mkPath</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">simpDtConfig</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type.iff</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">DiscrTree.mkPath</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">simpDtConfig</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type.ne</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">DiscrTree.mkPath</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">simpDtConfig</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">type.not</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">p.eq</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">DiscrTree.mkPath</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">simpDtConfig</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"unexpected kind of 'simp' theorem{indentExpr type}\"</span>\n<span class=\"w\">  </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"unexpected kind of 'simp' theorem{indentExpr type}\"</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#discr_tree_key\"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Command.liftTermElabM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">id.getId</span>\n<span class=\"w\">    </span><span class=\"n\">IO.println</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">discrKey</span><span class=\"w\"> </span><span class=\"n\">info.type</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">key.format</span><span class=\"o\">)</span>\n</code></pre></div>\n</div></div>",
        "id": 450654336,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720688251
    },
    {
        "content": "<p>Is it just because we don't index lambdas?</p>",
        "id": 450655984,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720688569
    }
]