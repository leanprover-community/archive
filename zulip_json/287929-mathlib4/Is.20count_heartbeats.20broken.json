[
    {
        "content": "<p>I have an impression that <code>#count_heartbeats in</code> is broken on <code>master</code>, probably because Lean now elaborates theorems in threads. I don't have a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> at the moment, but</p>\n<ul>\n<li>replacing <code>aesop</code> with a term proof didn't change the reported number;</li>\n<li>when I add <code>#count_heartbeats</code> to some definitions, the \"unused arguments\" linter starts complaining sometimes.</li>\n</ul>",
        "id": 512244598,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744701624
    },
    {
        "content": "<p><code>#count_heartbeats</code> is definitely broken <a href=\"https://github.com/leanprover-community/mathlib4/pull/23905\">#23905</a>, as it says in your title, but in your question you're asking about <code>#count_heartbeats in</code>.</p>",
        "id": 512245266,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744701852
    },
    {
        "content": "<p>I think that the function used by both of them is broken.</p>",
        "id": 512245397,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744701907
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- 71</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- 108</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- 81</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">tauto</span>\n</code></pre></div>\n<p>I can't reproduce what you're seeing (I used <code>#count_heartbeats in</code> a lot over the weekend)</p>",
        "id": 512246995,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744702329
    },
    {
        "content": "<p>I had a term mode proof with <code>by _</code> here and there. Sorry, I'm going to bed now. I'll try to make a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> tomorrow</p>",
        "id": 512247260,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744702392
    },
    {
        "content": "<p>It seems that <code>#count_heartbeats in</code> is currently broken:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">NumberField</span><span class=\"bp\">.</span><span class=\"n\">FinitePlaces</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">IsDedekindDomain</span><span class=\"bp\">.</span><span class=\"n\">HeightOneSpectrum</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NumberField</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">NumberField</span><span class=\"bp\">.</span><span class=\"n\">FinitePlace</span><span class=\"w\"> </span><span class=\"n\">NumberField</span><span class=\"bp\">.</span><span class=\"n\">RingOfIntegers</span>\n<span class=\"w\">  </span><span class=\"n\">NumberField</span><span class=\"bp\">.</span><span class=\"n\">RingOfIntegers</span><span class=\"bp\">.</span><span class=\"n\">HeightOneSpectrum</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">NumberField</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">tactic execution of Mathlib.Tactic.convert took 3.5s</span>\n<span class=\"cm\">type checking took 4.3s</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo‚ÇÅ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùìû</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">embedding</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">apply_symm_apply</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">norm_embedding_eq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 336 heartbeats</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùìû</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">embedding</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"c1\">-- this tactic is never executed</span>\n<span class=\"w\">    </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">apply_symm_apply</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n<span class=\"w\">  </span><span class=\"c1\">-- 'convert (norm_embedding_eq (equivHeightOneSpectrum.symm v) x).symm' tactic does nothing</span>\n<span class=\"w\">  </span><span class=\"c1\">-- this tactic is never executed</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">norm_embedding_eq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n</code></pre></div>\n<p>(This is an example that came up in <a href=\"https://github.com/leanprover-community/mathlib4/pull/28567\">#28567</a>.)</p>\n<p>The profiler output shows that the declaration is rather slow, but <code>#count_heartbeats in</code> gives a rather small number and also has the effect of the \"unused tactic\" linter triggering on two of the tactic invocations.<br>\nIf the effect really is that these tacticts do nothing, then this explains the small heartbeat count <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span>, but it makes <code>#count_heartbeats in</code> rather unusable.</p>",
        "id": 537436777,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1756892003
    },
    {
        "content": "<p>Might this be some kind of side-effect of parallelism?</p>",
        "id": 537437009,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1756892077
    },
    {
        "content": "<p>Does it give more realistic results with <code>set_option Elab.async false in</code>?</p>\n<p>Several linters have been affected by parallelism.</p>",
        "id": 537447319,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756895922
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Is.20count_heartbeats.20broken/near/537447319\">said</a>:</p>\n<blockquote>\n<p>Does it give more realistic results with <code>set_option Elab.async false in</code>?</p>\n<p>Several linters have been affected by parallelism.</p>\n</blockquote>\n<p>Yes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">async</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 126266 heartbeats</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HeightOneSpectrum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùìû</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">embedding</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">apply_symm_apply</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">norm_embedding_eq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">equivHeightOneSpectrum</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n</code></pre></div>\n<p>and no linter warnings.</p>\n<p>Should <code>#count_heartbeats</code> do <code>set_option Elab.async false</code> by default?</p>",
        "id": 537448768,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1756896540
    },
    {
        "content": "<p>Yes, I think so.  Unless there is a better way to get the actual timing without crippling parallelism.</p>",
        "id": 537448998,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756896627
    },
    {
        "content": "<p>Bandaid at <a href=\"https://github.com/leanprover-community/mathlib4/pull/29311\">#29311</a> (partly done in an attempt to provoke someone to do the actual fix, which unfortunately I am not competent to do). I am also tempted to open an issue. I sometimes find <code>#count_heartbeats</code> very useful when debugging but often find myself trawling through the Zulip trying to figure out how to make it work.</p>",
        "id": 537462096,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756901602
    },
    {
        "content": "<blockquote>\n<p>fix: add Elab.async false in #count_heartbeats¬†<a href=\"https://github.com/leanprover-community/mathlib4/pull/29335\">#29335</a></p>\n</blockquote>\n<p>I have not yet added an effective test. Could someone else please attempt that, either here or in a different PR? I'd prefer not to take that on.</p>\n<p>I did verify that it works as expected at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FractionalIdeal.quotientEquiv#doc\">docs#FractionIdeal.quotientEquiv</a>.</p>",
        "id": 537569496,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1756943866
    }
]