[
    {
        "content": "<p>I want to add that lemma to Mathlib but I don't know where I should put it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">lemma</span><span class=\"w\"> </span><span class=\"n\">AnalyticAt.re_ofReal</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AnalyticAt</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AnalyticAt</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">re</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Complex.reCLM.analyticAt</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf.restrictScalars.comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Complex.ofRealCLM.analyticAt</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>If I <code>import Mathlib</code> in a file and use <code>#find_home!</code> it suggests weird files that seem to import way too much. In order to understand why, I used <code>#min_imports</code>, and it believes that my lemma needs inner product spaces and C* algebras... probably because when you import those files some instances are generated through them instead of through other ways?</p>\n<p>By inspecting the proof, I can tell that it in fact needs only Mathlib.Analysis.Analytic.Constructions and Mathlib.Analysis.Complex.Basic (and I checked that it works with those imports). How do I find files that import both, but not much more?</p>",
        "id": 495852044,
        "sender_full_name": "Rémy Degenne",
        "timestamp": 1737795532
    },
    {
        "content": "<p>I have no current solution, but two comments.</p>\n<ol>\n<li>The various versions of <code>#min_imports</code> rely on the final version of the declaration, so, once typeclass search commits to a path, they do not see if other paths may yield smaller imports.</li>\n<li>I have observed as well that sometimes there are unnecessary imports reported by <code>#min_imports</code>, but did not get to the bottom of where/why they show up.</li>\n</ol>",
        "id": 495852934,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737796288
    },
    {
        "content": "<p>Thanks for those comments. I think that 1. is what is happening here.<br>\nI found a file by looking at \"imported by\" sections in the documentation and trying to guess a good path (which is not a very robust solution). For this lemma I found the file <code>Mathlib.Analysis.SpecialFunctions.Complex.Analytic</code>.</p>",
        "id": 495854564,
        "sender_full_name": "Rémy Degenne",
        "timestamp": 1737797750
    },
    {
        "content": "<p>Here is a quick implementation of a slow command that finds least upper bounds among imports:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: import Mathlib.Analysis.Analytic.Constructions</span>\n<span class=\"sd\">import Mathlib.Analysis.CStarAlgebra.Classes</span>\n<span class=\"sd\">import Mathlib.Analysis.InnerProductSpace.Basic</span>\n<span class=\"sd\">import Init.Data.List.Nat.Pairwise</span>\n<span class=\"sd\">import Init.Data.List.Sort.Lemmas</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">min_imports</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">AnalyticAt</span><span class=\"bp\">.</span><span class=\"n\">re_ofReal</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AnalyticAt</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">AnalyticAt</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">re</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">reCLM</span><span class=\"bp\">.</span><span class=\"n\">analyticAt</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"bp\">.</span><span class=\"n\">restrictScalars</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofRealCLM</span><span class=\"bp\">.</span><span class=\"n\">analyticAt</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">))</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Returns the `NameSet` of modules that</span>\n<span class=\"sd\">* import all entries of `required` and</span>\n<span class=\"sd\">* are minimal with respect to this property.</span>\n\n<span class=\"sd\">Note.</span>\n<span class=\"sd\">The imports must all be from `Mathlib`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"c1\">-- extracted from `Lean.Name.findHome`</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">findOverImports</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">importGraph</span><span class=\"bp\">.</span><span class=\"n\">transitiveClosure</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NameSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">candidates</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">candidates</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">candidates</span><span class=\"bp\">.</span><span class=\"n\">erase</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">candidates</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inherit_doc</span><span class=\"w\"> </span><span class=\"n\">findOverImports</span><span class=\"kd\">]</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#find_over_imports \"</span><span class=\"w\"> </span><span class=\"n\">ids</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ids</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">getId</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{(findOverImports (← getEnv) imports).toArray}\"</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: [Mathlib.MeasureTheory.Integral.FundThmCalculus,</span>\n<span class=\"sd\"> Mathlib.Analysis.Calculus.ParametricIntegral,</span>\n<span class=\"sd\"> Mathlib.Geometry.Manifold.Instances.Real,</span>\n<span class=\"sd\"> Mathlib.NumberTheory.Transcendental.Liouville.LiouvilleWith,</span>\n<span class=\"sd\"> Mathlib.Topology.MetricSpace.HausdorffDimension,</span>\n<span class=\"sd\"> Mathlib.Analysis.Complex.UpperHalfPlane.Manifold,</span>\n<span class=\"sd\"> Mathlib.Analysis.Calculus.ContDiff.WithLp,</span>\n<span class=\"sd\"> Mathlib.Analysis.Calculus.BumpFunction.Normed,</span>\n<span class=\"sd\"> Mathlib.Analysis.Complex.RealDeriv,</span>\n<span class=\"sd\"> Mathlib.Analysis.SpecialFunctions.Exponential]</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">find_over_imports</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Analytic</span><span class=\"bp\">.</span><span class=\"n\">Constructions</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: [Mathlib.Analysis.CStarAlgebra.ContinuousFunctionalCalculus.Instances, Mathlib.Analysis.CStarAlgebra.Spectrum]</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">find_over_imports</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Analytic</span><span class=\"bp\">.</span><span class=\"n\">Constructions</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">CStarAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Classes</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">InnerProductSpace</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"w\">  </span><span class=\"c1\">--Init.Data.List.Nat.Pairwise</span>\n<span class=\"w\">  </span><span class=\"c1\">--Init.Data.List.Sort.Lemmas</span>\n</code></pre></div>",
        "id": 495859596,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737802180
    },
    {
        "content": "<p>I have observed sometimes inconsistencies in how <code>importGraph</code> reports dependencies, so I would not trust the outcome of this command too much, since it is a quick implementation that certainly contains bugs, using something that I am not fully convinced is completely robust.</p>",
        "id": 495859700,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737802272
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> if you report these inconsistencies in an issue on the <code>importGraph</code> repo, I might take some time at some point to look at it. iirc this part of the code was a quick and dirty hack by Kim and the code even says that its not capturing everything.</p>",
        "id": 495875894,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1737815654
    },
    {
        "content": "<p>Sorry, I did not mean to blame anyone: it is great that code is available for doing this!</p>",
        "id": 495893473,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737829224
    },
    {
        "content": "<p>Sorry, I did not mean to blame anyone: it is great that code is available for doing this!</p>",
        "id": 495893500,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737829250
    },
    {
        "content": "<p>I don't have a clear bug report, but it looked now as if cross-repository dependencies might confuse import graph.  I'll keep an eye out for something concrete.</p>",
        "id": 495893503,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1737829250
    },
    {
        "content": "<p>I didnt perceive anything as blame, I just wanted to point out that I'd be interested in looking at such problems, but it's easier to start from something which isn't working even if it's vague or not fully reproducible :)</p>",
        "id": 495914250,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1737848082
    }
]