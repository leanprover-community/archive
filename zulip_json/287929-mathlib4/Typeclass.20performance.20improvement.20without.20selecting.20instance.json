[
    {
        "content": "<p>While waiting for other code to compile, I came across an interesting slowdown in the <a href=\"https://radar.lean-lang.org/repos/mathlib4/graph?m=build/module/Mathlib.CategoryTheory.Limits.Shapes.NormalMono.Equalizers//instructions&amp;s=instructions\">Radar graph for <code>Mathlib.CategoryTheory.Limits.Shapes.NormalMono.Equalizers</code></a>: <code>lake shake</code> actually made this file 20% slower. Doing some bisection of imports, it looks like adding either of the following imports to <code>Mathlib.CategoryTheory.Limits.Shapes.NormalMono.Equalizers</code> reduces build time by about 10% and adding both does so by 20% on my machine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">Types</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"w\"> </span><span class=\"c1\">-- shake: keep</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">Types</span><span class=\"bp\">.</span><span class=\"n\">Colimits</span><span class=\"w\"> </span><span class=\"c1\">-- shake: keep</span>\n</code></pre></div>\n<p>Some more minimization later, and in fact the speedup happens exactly when <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.Types.hasLimit#doc\">docs#CategoryTheory.Limits.Types.hasLimit</a> / <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CategoryTheory.Limits.Types.hasColimit#doc\">docs#CategoryTheory.Limits.Types.hasColimit</a> are made available. But this is weird, because we never take a limit in <code>Type u</code> anywhere in the file! They are only used in failing instance synthesis. But their existence interestingly means that they allow the synthesis to fail quickly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">HasBinaryProduct</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">417</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">418</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"n\">HasLimit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">417</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Types</span><span class=\"bp\">.</span><span class=\"n\">hasLimit</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">HasLimit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">417</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">HasLimit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pair</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">417</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">418</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">HasLimit</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">424</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>compared to 34 different instances being tried without the existence of <code>Types.hasLimit</code>.</p>\n<p>In other words, Lean tries to synthesize an instance before the required metavariables are assigned, but does not realize this is the case until it actually tries to apply a concrete instance. And this can take a long while if we have a complex instance hierarchy (like apparently we do for <code>Has(Co)Limit</code>.</p>\n<p>This behaviour surprised me, and would be worth sharing widely. Apart from that, I would be interested in knowing of an actionable suggestion. Making one file 20% faster is nice, but can we do this in a thousand more files?</p>",
        "id": 570523196,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1769597095
    }
]