[
    {
        "content": "<p>In the current staging workflow for bors (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/12071366218/job/33662964049\">https://github.com/leanprover-community/mathlib4/actions/runs/12071366218/job/33662964049</a>), the build has failed right away because an import is not good, with the message</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">✖</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">?/?</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Computing</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">jobs</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">/</span><span class=\"n\">Sites</span><span class=\"bp\">/</span><span class=\"n\">InducedTopology</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Computing</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">jobs</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n</code></pre></div>\n<p>In particular, the cache step has not uploaded anything. But now the lint step is building all of mathlib, and all this will be wasted because no file will be uploaded to the cache.</p>\n<p>I don't know anything about CI, so I have no idea if this can/should be fixed, but I wanted to point this out in case someone knows better.</p>",
        "id": 484944787,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1732807624
    },
    {
        "content": "<p>Thanks! I'm sure we can try to handle such a case better. For now I would just cancel the linting step, I think.</p>",
        "id": 484945195,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1732807753
    },
    {
        "content": "<p>Ooh, it is already done, it seems.</p>",
        "id": 484945252,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1732807775
    },
    {
        "content": "<p>Yeah, it just finished.</p>",
        "id": 484945411,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1732807814
    },
    {
        "content": "<p>It should be possible to make the linting only happen if <code>lake build --no-build</code> is successful.  I would have to check whether that lake option is working as intended now, though (and I won't be able to do this soon, either).</p>",
        "id": 484945633,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732807893
    },
    {
        "content": "<p>If someone can confirm whether <code>no-build</code> works, then simply changing the linting step to <code>if lake build --no-build; then [whatever it is now]; else exit 1; fi</code> may do the trick.</p>",
        "id": 484946369,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732808158
    },
    {
        "content": "<p>I find it very useful for linting to happen even the build failed, because it replays all the files that had an error. This makes them much easier to find, as compared to the build mathlib step which is a sea of the form</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5666</span><span class=\"bp\">/</span><span class=\"mi\">5675</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">EulerProduct</span><span class=\"bp\">.</span><span class=\"n\">DirichletLSeries</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5667</span><span class=\"bp\">/</span><span class=\"mi\">5675</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">Harmonic</span><span class=\"bp\">.</span><span class=\"n\">ZetaAsymp</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5668</span><span class=\"bp\">/</span><span class=\"mi\">5675</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">LSeries</span><span class=\"bp\">.</span><span class=\"n\">ZMod</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5669</span><span class=\"bp\">/</span><span class=\"mi\">5675</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">CStarAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"bp\">✔</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5670</span><span class=\"bp\">/</span><span class=\"mi\">5675</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Built</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">FLT</span><span class=\"bp\">.</span><span class=\"n\">Three</span>\n</code></pre></div>",
        "id": 484947638,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1732808600
    },
    {
        "content": "<p>... but I agree that my reliance on this is probably a hack. Would be great if we could just replay the build of the broken files in a separate CI step</p>",
        "id": 484947786,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1732808644
    },
    {
        "content": "<p>Replaying the files in the lint step looks definitely good to me. What is weird here is that the lint step builds more than the build step.</p>",
        "id": 484948296,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1732808824
    },
    {
        "content": "<p>i.e., <code>lake exe runLinter Mathlib</code> (the lint step command) fails later than the build step command <code>lake build --wfail -KCI</code>.</p>",
        "id": 484948608,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1732808934
    },
    {
        "content": "<p>Oh I see. Yes for sure one shouldn't outbuild the build</p>",
        "id": 484948663,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1732808964
    },
    {
        "content": "<p>In this case, it seems that there was a non-existing import that prevented the actual build step from running, but the failure settings of the lint step are different, so it still build the rest of mathlib anyway.  Is this correct?</p>",
        "id": 484949283,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732809196
    },
    {
        "content": "<p>I still think that if <code>no-build</code> works, then it is the way to go: it reports the issues, but does not go ahead to build anything new.</p>",
        "id": 484950082,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732809460
    }
]