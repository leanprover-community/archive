[
    {
        "content": "<p>How bad would it be to stuff <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Monoid.npow#doc\">docs#Monoid.npow</a> into <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MulOneClass#doc\">docs#MulOneClass</a> ?</p>",
        "id": 512595882,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744820807
    },
    {
        "content": "<p>With <code>MulOneClass</code> you don't have associativity so <code>a * (a * a)</code> is not necessarily the same as <code>(a * a) * a</code>.</p>",
        "id": 512596884,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744821053
    },
    {
        "content": "<p>Sure. From what I can see, that would complicate the <code>csimp</code> we have to do double and square powering. But am I missing anything else?</p>",
        "id": 512597159,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821123
    },
    {
        "content": "<p>I guess Matthew means \"Pick <code>a ^ n = a * (a * ...)</code>\"</p>",
        "id": 512597224,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744821134
    },
    {
        "content": "<p>But that will break eg <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MulOpposite.instMulOneClass#doc\">docs#MulOpposite.instMulOneClass</a></p>",
        "id": 512597296,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744821157
    },
    {
        "content": "<p>I mean <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Semiring#doc\">docs#Semiring</a> is the first time we see <code>npow</code> so unification for defeq paths here will have to check <code>npow</code></p>",
        "id": 512597590,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821239
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60npow.60.20for.20.60MulOneClass.60/near/512597590\">said</a>:</p>\n<blockquote>\n<p>I mean <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Semiring#doc\">docs#Semiring</a> is the first time we see <code>npow</code> so unification for defeq paths here will have to check <code>npow</code></p>\n</blockquote>\n<p>Can you explain what this means? I don't quite understand it.</p>",
        "id": 512597774,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744821273
    },
    {
        "content": "<p>If we wanted to keep that instance we could bundle it in</p>",
        "id": 512597780,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821277
    },
    {
        "content": "<p>What do you mean? The first time we \"see <code>npow</code>\" is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Monoid.npow#doc\">docs#Monoid.npow</a></p>",
        "id": 512597809,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744821284
    },
    {
        "content": "<p>When we build up from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NonUnitalNonAssocSemiring#doc\">docs#NonUnitalNonAssocSemiring</a> to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Semiring#doc\">docs#Semiring</a>, the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Monoid.npow#doc\">docs#Monoid.npow</a> field only appears at the last step. So when instances differ syntactically below Semiring, unification will have to pull apart npow (data) to make sure things are ok</p>",
        "id": 512598138,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821381
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60npow.60.20for.20.60MulOneClass.60/near/512597780\">said</a>:</p>\n<blockquote>\n<p>If we wanted to keep that instance we could bundle it in</p>\n</blockquote>\n<p>This would also keep the <code>csimp</code></p>",
        "id": 512598257,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821420
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60npow.60.20for.20.60MulOneClass.60/near/512598138\">said</a>:</p>\n<blockquote>\n<p>When we build up from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NonUnitalNonAssocSemiring#doc\">docs#NonUnitalNonAssocSemiring</a> to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Semiring#doc\">docs#Semiring</a>, the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Monoid.npow#doc\">docs#Monoid.npow</a> field only appears at the last step. So when instances differ syntactically below Semiring, unification will have to pull apart npow (data) to make sure things are ok</p>\n</blockquote>\n<p>I think this only happens if you are unifying the npow instance, but if you only want the mul, for example, the npow instances are not unified.</p>",
        "id": 512598677,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744821541
    },
    {
        "content": "<p>This came from experimenting with deprioritizing the <code>CommX.toX</code> projection instances. The result was that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Matrix.semiring#doc\">docs#Matrix.semiring</a> slowed down a lot depending on whether you did <code>CommRing.toRing Ring.toSemiring</code> or <code>CommRing.toCommSemiring CommSemiring.toSemiring</code> and spent the majority of its time on npow.</p>",
        "id": 512599020,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821634
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover/lean4/blob/045d07d2349b9989278991fbcd79a6430032930d/src/Lean/Meta/ExprDefEq.lean#L2103-L2137\">this comment</a> on the implementation of <code>isDefEq</code> for what I'm talking about.</p>",
        "id": 512599226,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744821703
    },
    {
        "content": "<p>I don't think that applies to my example but I could be wrong</p>",
        "id": 512599477,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821771
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60npow.60.20for.20.60MulOneClass.60/near/512597224\">said</a>:</p>\n<blockquote>\n<p>I guess Matthew means \"Pick <code>a ^ n = a * (a * ...)</code>\"</p>\n</blockquote>\n<p>I don't think we should pick something arbitrary just for performance reasons</p>",
        "id": 512599540,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744821793
    },
    {
        "content": "<p>Though arguably we did pick something arbitrary for <code>Field.qsmul</code> which is of course nonsense for <code>ZMod</code></p>",
        "id": 512599608,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744821818
    },
    {
        "content": "<p>I can appreciate the \"unless the operation is associative on singletons, it is silly\" argument</p>",
        "id": 512599978,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744821938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60npow.60.20for.20.60MulOneClass.60/near/512599608\">said</a>:</p>\n<blockquote>\n<p>Though arguably we did pick something arbitrary for <code>Field.qsmul</code> which is of course nonsense for <code>ZMod</code></p>\n</blockquote>\n<p>Elaborate on this?</p>",
        "id": 512600318,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744822019
    },
    {
        "content": "<p>The operator isn't particularly well behaved over a field unless the field is <code>CharZero</code></p>",
        "id": 512600577,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744822053
    },
    {
        "content": "<p>It's the division by zero convention</p>",
        "id": 512601206,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744822152
    },
    {
        "content": "<p>I guess I'm thinking of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Rat.cast_div#doc\">docs#Rat.cast_div</a></p>",
        "id": 512601900,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744822257
    },
    {
        "content": "<p>I think that one can be generalized</p>",
        "id": 512602232,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744822311
    },
    {
        "content": "<p>Indeed, see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Rat.cast_div_of_ne_zero#doc\">docs#Rat.cast_div_of_ne_zero</a></p>",
        "id": 512603376,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744822477
    },
    {
        "content": "<p>If I go by feelings also, I feel that I've seen a lot of <code>npow</code> unification drag. More so than I would expect. There are other ways around this too.</p>",
        "id": 512612642,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744823849
    }
]