[
    {
        "content": "<p>On <a href=\"https://github.com/leanprover-community/mathlib4/pull/6428\">#6428</a> commit 0e6a004, I get a CI failure with the following message:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Run reviewdog/action-suggester@v1\nRun set -euo pipefail\nüê∂ Installing reviewdog ... https://github.com/reviewdog/reviewdog\nRun set -euo pipefail\nüìñ reviewdog -h\nRun set -euo pipefail\nNo local changes to save\nreviewdog: GET https://api.github.com/repos/leanprover-community/mathlib4/pulls/6428/comments?per_page=100: 500  []\nError: Process completed with exit code 1.\n</code></pre></div>\n<p>What is reviewdog/what does this mean?</p>",
        "id": 390856912,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1694670270
    },
    {
        "content": "<p>Reviewdog is supposed to add suggestions on the pr to fix linter errors</p>",
        "id": 390860199,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1694672220
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"127136\">@Alex J. Best</span></p>",
        "id": 390860314,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1694672276
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/390860199\">said</a>:</p>\n<blockquote>\n<p>Reviewdog is supposed to add suggestions on the pr to fix linter errors</p>\n</blockquote>\n<p>That's awesome! For more context, I eventually got another error telling me I was missing a docstring for a <code>def</code>. Is reviewdog supposed to recommend anything in that case?</p>",
        "id": 390863025,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1694673718
    },
    {
        "content": "<p>AI isn't that smart yet - it's more for things where there's a simple and obvious fix</p>",
        "id": 390864260,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1694674288
    },
    {
        "content": "<p>No it won't recommend anything in this case indeed.<br>\nSorry for the trouble! I'll make another pr to fail more gracefully and another couple of tweaks (maybe skipping wip prs also or changing the rate somehow would help, I see the bot has been annoying <span class=\"user-mention\" data-user-id=\"459699\">@Jo√´l Riou</span> regarding <a href=\"https://github.com/leanprover-community/mathlib4/pull/4197\">#4197</a> also). I'll also try and understand why that failed that time but looking at the error code seems quite inscrutable.</p>",
        "id": 390915417,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1694693264
    },
    {
        "content": "<p>A couple more questions.</p>\n<ol>\n<li>Is there an example of a type of error that currently triggers reviewdog? </li>\n<li>Why haven't I  seen any reviewdog comments on my own PRs? </li>\n<li>Can we program our own reviewdog triggers?</li>\n</ol>",
        "id": 391607308,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1695006546
    },
    {
        "content": "<ol>\n<li>Currently only the style linter triggers it (plus the check all imports in mathlib.lean and the bibfile linters).</li>\n<li>If it has anything to say it should say it I believe, so maybe you just haven't made the type of errors it knows how to autofix (You can see instances of it at work by searching in <a href=\"https://github.com/leanprover-community/mathlib4/pulls?q=is%3Apr+reviewdog\">https://github.com/leanprover-community/mathlib4/pulls?q=is%3Apr+reviewdog</a>). Maybe very old PRs also have to merge master for it to start working im not sure?</li>\n<li>Yes you can modify how it works for all of mathlib fairly easily, the whole thing is based off of the automated linter fixes added in <a href=\"https://github.com/leanprover-community/mathlib4/pull/6568\">#6568</a>, this is a python script that reads in all the lines of lean files, looks at them and then outputs what it thinks the line should be, this can be used to add autofixes that, remove lines, modify them or add new lines entirely fairly easily. Unfortunately these scripts do not yet talk to lean itself so are limited at the moment to only fixing issues that could be seen from the source alone. I'd like it in the future if lean could also recommend such fixes via the same mechanism but a bit more work is needed to get that running</li>\n</ol>",
        "id": 391696962,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1695042782
    },
    {
        "content": "<p>Are you sure it is working correctly? <a href=\"https://github.com/leanprover-community/mathlib4/pull/7605\">#7605</a></p>",
        "id": 395819736,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1696921426
    },
    {
        "content": "<p>Seems it's telling you how to fix the extra whitespace you have that is unneeded and being caught by the linter?</p>",
        "id": 395820175,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696921624
    },
    {
        "content": "<p>Hmm, is it saying it wants to delete the line?</p>",
        "id": 395820382,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696921714
    },
    {
        "content": "<p>Does it also complain on the command line?</p>",
        "id": 395820466,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1696921760
    },
    {
        "content": "<p>The corresponding line in the linter <a href=\"https://github.com/leanprover-community/mathlib4/blob/3f4910debcdd03d6ca9f9063b698a36fd2e3c211/scripts/lint-style.py#L160\">https://github.com/leanprover-community/mathlib4/blob/3f4910debcdd03d6ca9f9063b698a36fd2e3c211/scripts/lint-style.py#L160</a></p>",
        "id": 395820945,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696921989
    },
    {
        "content": "<p>Maybe we can also have reviewdog display which linter failed? That would be easier to interpret.<br>\nAre you saying that the PR had a windows line ending Bolton?</p>",
        "id": 395821134,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1696922074
    },
    {
        "content": "<p>No, it had trailing whitespace. You can see the error by going to the linter output <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/6465820999/job/17552670437\">https://github.com/leanprover-community/mathlib4/actions/runs/6465820999/job/17552670437</a></p>",
        "id": 395821464,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696922242
    },
    {
        "content": "<p>And if you look at the raw file, indeed there was a space on line 471</p>",
        "id": 395821715,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696922356
    },
    {
        "content": "<p>Looking at the linter I can't see any reason why it would be deleting the line rather than just removing the whitespace. I'm tempted to think this is just how GitHub displays that change.</p>",
        "id": 395821886,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696922429
    },
    {
        "content": "<p>I'd be interested to see what happens if someone were to try applying the change</p>",
        "id": 395821941,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696922458
    },
    {
        "content": "<p>Unfortunately for my curiosity it's already been fixed here though. Let me try another PR</p>",
        "id": 395822097,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696922529
    },
    {
        "content": "<p><del>More concerning is that reviewdog keeps skipping the job</del> I think this has to do with the not-tagged for review status, this makes sense.</p>",
        "id": 395823963,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696923381
    },
    {
        "content": "<p>Ok I got it to work</p>",
        "id": 395824447,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696923600
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/7172\">https://github.com/leanprover-community/mathlib4/pull/7172</a><br>\nSeems that this is just how GitHub writes it, mystery solved</p>",
        "id": 395824539,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696923628
    },
    {
        "content": "<p>It's weird, I would have expected it to show a red - for deleting the line with the space and a green + for adding the line without the space.</p>",
        "id": 395824894,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1696923763
    },
    {
        "content": "<p>Yeah, I've noticed that when suggesting such changes manually on github as well</p>",
        "id": 395825234,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1696923898
    },
    {
        "content": "<p>I had the bright idea of writing a linter to break the lines too long errors in <a href=\"https://github.com/leanprover-community/mathlib4/pull/7580\">#7580</a>. Reviewdog went a little hard after I started using the Github  review function to make the changes, resuggesting all the other changes.</p>",
        "id": 396730979,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1697358193
    },
    {
        "content": "<p>Oops. I think \"Add suggestion to batch\" might have helped</p>",
        "id": 396734502,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1697360986
    },
    {
        "content": "<p>Does reviewdog allow doing that automatically?</p>",
        "id": 396735846,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1697361707
    },
    {
        "content": "<p>There should always be the option yes, if its greyed out you can hover over it in the github UI  to see why, iirc maybe you have to be in the \"files\" tab to batch things</p>",
        "id": 396767731,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1697387116
    },
    {
        "content": "<p>What are the conditions needed to get reviewdog to make suggestions? I was hoping to get a big list of suggestions on my linter PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/7496\">#7496</a> but CI has run and no suggestions.</p>",
        "id": 397642734,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1697784794
    },
    {
        "content": "<p>Does it need to be marked awaiting-review?</p>",
        "id": 397642771,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1697784809
    },
    {
        "content": "<p>Is reviewdog unwilling to make over 150 suggestions at a time perhaps?</p>",
        "id": 397645229,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1697785718
    },
    {
        "content": "<p>Oh huh, this is an issue with our CI configuration. <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/.github/workflows/lint_and_suggest_pr.yml\"><code>lint_and_suggest_pr.yml</code></a> (which runs reviewdog) seems to be triggered only when you create a PR, while the style linter that runs when you push to a branch is triggered from <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/.github/workflows/build.yml\">build.yml</a>, which doesn't run reviewdog</p>",
        "id": 397648296,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1697787111
    },
    {
        "content": "<p>I forked off a new PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/7795\">#7795</a> but I still get no reviewdog</p>",
        "id": 397648789,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1697787339
    },
    {
        "content": "<p>I think the reviewdog is only looking at files (or even on lines) changed in your pr? <br>\nI had the same thing happening here: <a href=\"https://github.com/leanprover-community/mathlib4/pull/7283\">#7283</a></p>",
        "id": 397665090,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1697792950
    },
    {
        "content": "<p>You can locally run <code>./scripts/lint-style.sh --fix</code> though</p>",
        "id": 397676621,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1697797022
    },
    {
        "content": "<p>That said I'm not sure these would be super useful suggestions for reviewdog, if this simply replaces <code>simp</code> by <code>simp?</code> but we have no suggester to replace things with the output of <code>Try this</code> for <code>simp?</code> then the user will have to open the files in Lean then anyway so the benefit of having reviewdog make the change suggestions on the PR is a bit limited</p>",
        "id": 397677239,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1697797208
    },
    {
        "content": "<p>I think there is benefit for new users who dont know about <code>simp?</code> still, but probably not for most mathlibers</p>",
        "id": 397677364,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1697797248
    },
    {
        "content": "<p>Yeah the optimal would be for it to actually replace with the \"Try This\" output (and have that always work). A downside is that suggestions can clog up the PR page. Still, making a <code>simp -&gt; simp?</code> suggestion seems <em>slightly</em> better to me than not doing so, because I no longer have to hunt through the file for the error, it gets highlighted in blue this way.</p>",
        "id": 397680352,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1697798072
    },
    {
        "content": "<p>Could someone please work out how to disable reviewdog on PRs touching more than 300 files? Currently it just fails all such PRs with an error like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>         <span class=\"n\">reviewdog</span><span class=\"o\">:</span> <span class=\"n\">fail</span> <span class=\"n\">to</span> <span class=\"n\">get</span> <span class=\"n\">diff</span><span class=\"o\">:</span> <span class=\"n\">GET</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">api.github.com</span><span class=\"bp\">/</span><span class=\"n\">repos</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">/</span><span class=\"n\">pulls</span><span class=\"bp\">/</span><span class=\"mi\">11997</span><span class=\"o\">:</span> <span class=\"mi\">406</span>\n         <span class=\"n\">Sorry</span><span class=\"o\">,</span> <span class=\"n\">the</span> <span class=\"n\">diff</span> <span class=\"n\">exceeded</span> <span class=\"n\">the</span> <span class=\"n\">maximum</span> <span class=\"n\">number</span> <span class=\"n\">of</span> <span class=\"n\">files</span> <span class=\"o\">(</span><span class=\"mi\">300</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 431855773,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1712551310
    },
    {
        "content": "<p>I'm happy to make a PR disabling reviewdog in the meantime. :-)</p>",
        "id": 431855830,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1712551328
    },
    {
        "content": "<p>cross posting from <a href=\"#narrow/stream/428973-nightly-testing/topic/.2311997.2C.20adaptations.20for.20nightly-2024-04-07/near/431907375\">https://leanprover.zulipchat.com/#narrow/stream/428973-nightly-testing/topic/.2311997.2C.20adaptations.20for.20nightly-2024-04-07/near/431907375</a> as likely many people are not subscribed over there (I wasn't)</p>\n<p>The¬†reviewdog¬†set up was made with this sort of situation in mind to some extent, and I don't think it's necessary to disable¬†reviewdog. The process is as follows: due to¬†<a href=\"https://github.com/leanprover-community/mathlib4/blob/b8145adda2a744f3a646ee93f5daa05a4855da73/bors.toml\">https://github.com/leanprover-community/mathlib4/blob/b8145adda2a744f3a646ee93f5daa05a4855da73/bors.toml</a>¬†bors should still merge even if review dog step fails, as long as the build steps work.¬†Reviewdog¬†will not run on draft PRs, so PRs where¬†reviewdog¬†failing is annoying (and we want a nice green tick) can be developed in draft mode, and then made non-draft and merged when ready to merge. Let me know if there is something I'm missing here (maybe the queue will ignore such PRs?).</p>",
        "id": 431908515,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1712568002
    },
    {
        "content": "<p>Does it actually block bors at this point, or just the overall <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> ?</p>",
        "id": 431947553,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1712576545
    },
    {
        "content": "<p>I'm not sure what you are asking. If someone \"bors merge\"s a PR for which the reviewdog step fails then the merge should go through. Its just that the bottom of the PR will still have 1 \"failed check\" (also worth noting that reviewdog runs on PRs not commits so iirc these checks won't even be run on master)</p>",
        "id": 431956722,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1712578862
    },
    {
        "content": "<p>Right, that's what I meant. So failing reviewdog is more annoying than a blocker</p>",
        "id": 431964277,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1712581062
    },
    {
        "content": "<p>Can we add a check that test if there are more than 300 files changed, and disables reviewdog in those cases. It's already hard enough to get a PR on the <a href=\"https://bit.ly/3cKk3ld\">#queue</a>, and it seems the workarounds above would prevent that?</p>",
        "id": 432107805,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1712631868
    },
    {
        "content": "<p>Sure we can do that, I'm sure its not hard and chatgpt can likely write the invocation instantly for us. I will say that not being on <a href=\"https://bit.ly/3cKk3ld\">#queue</a> is probably not the reason 300 files changed PRs are not getting reviewed though, any such thing is likely accompanied by discussion here anyway.</p>",
        "id": 432203956,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1712660957
    },
    {
        "content": "<p>Note that blocking the overall <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> messes with nightly-testing CI reporting.</p>",
        "id": 433447461,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713247476
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"127136\">@Alex J. Best</span>, do you have time to disable reviewdog when more than 300 files have changed? I've disabled it entirely on nightly-testing for a while, but this is now getting in the way of getting adaptation PRs ready.</p>",
        "id": 433447576,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713247535
    },
    {
        "content": "<p>I took a look but I couldn't find a dead simple way to do this (i.e. an existing action), like probably it will take 30minutes to get something that works but I unfortunately dont have that time right now. There are already actions to print the list of changed files so it should just be a case of combining those with some bash scripting to make the job skip if that list is long</p>",
        "id": 433498398,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1713266305
    },
    {
        "content": "<p>Okay, no problems, thanks for looking. I guess in the meantime I've got my adaptation PR down below 300 files, so all is well. :-)</p>",
        "id": 433640645,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713323629
    },
    {
        "content": "<p>Reviewdog made a total mess of a new contributor PR in <a href=\"https://github.com/leanprover-community/mathlib4/pull/11988\">https://github.com/leanprover-community/mathlib4/pull/11988</a></p>",
        "id": 433892923,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1713398209
    },
    {
        "content": "<p>It looks like its whitespace suggestions somehow got caught in a race condition, and so it suggested a bunch of nonsensical changes that reverted to a previous revision</p>",
        "id": 433892978,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1713398244
    },
    {
        "content": "<p>My general opinion is that <code>lint_style.sh --fix</code> is great, but reviewdog is on average noise and at worst super confusing. I think we could get just as much value by posting a comment telling the user to run <code>lint_style.sh --fix</code>, but maybe that command doesn't work on everyone's lean install...</p>",
        "id": 433893207,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1713398402
    },
    {
        "content": "<p>Regarding reviewdog: it is meant to make a suggestion for when Mathlib.lean needs an update? I thought that was the case, but at <a href=\"https://github.com/leanprover-community/mathlib4/pull/12058\">#12058</a> it did not. </p>\n<p>It would be good to know if this was never the case, or otherwise if something broke here.</p>",
        "id": 433893842,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713398762
    },
    {
        "content": "<p>(This PR was raised as a question in office hours, asking how to deal with the CI error, so clearly automatic assistance would have been useful!)</p>",
        "id": 433893902,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713398786
    },
    {
        "content": "<p>Reviewdog can only make suggestions on lines that the user changed, or those nearby, so unfortunately it can't suggest mathlib.lean updates most of the time. I don't know of any way around this and any suggestion based action will have the same problem.<br>\nIt's been suggested elsewhere that having a bot that pushes the mathlib.lean update to the branch for you would be a better interaction mode in this case, and I'm inclined to agree. But bots that push to branches need to be a lot more bulletproof than those that just make suggestions</p>",
        "id": 433895202,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1713399784
    },
    {
        "content": "<p>Idk about on average noise, I see it making many suggestions that users do apply. The main issues are with the mathlib.lean thing which has been around for long enough and nobody has been able to fix so maybe it's time to disable that part. Ofc it's behaviour is controlled by the linters themselves so if we have linters that are causing noise that's an independent problem.<br>\nIn the case of 11988 I guess one of those unusual merge commits confused it which is unfortunate, maybe there is a bug there that needs investigating and reporting upstream?</p>",
        "id": 433895504,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1713400023
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> it looks like your issue is already reported upstream <a href=\"https://github.com/reviewdog/reviewdog/issues/1696#issue-2206596164\">https://github.com/reviewdog/reviewdog/issues/1696#issue-2206596164</a></p>",
        "id": 433895737,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1713400199
    },
    {
        "content": "<p>My impression is also that reviewdog is actually quite useful, and in many cases the suggestions are applied. So I would be sad to see it go completely.</p>",
        "id": 433945915,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1713421452
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/433893902\">said</a>:</p>\n<blockquote>\n<p>(This PR was raised as a question in office hours, asking how to deal with the CI error, so clearly automatic assistance would have been useful!)</p>\n</blockquote>\n<p>Since actions cannot suggest this change, I suggest at least adding the <code>script/mk_all.sh</code> command somewhere in the \"how to contribute to mathlib\" article.</p>",
        "id": 433982891,
        "sender_full_name": "Rida Hamadani",
        "timestamp": 1713426146
    },
    {
        "content": "<p>In case that sounds like a good idea, <a href=\"https://github.com/leanprover-community/leanprover-community.github.io/pull/464\">here</a> is a small PR that does it.</p>",
        "id": 433986520,
        "sender_full_name": "Rida Hamadani",
        "timestamp": 1713427243
    },
    {
        "content": "<p>We should definitely have the CI error message say that!</p>",
        "id": 433995546,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713429415
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"580947\">Rida Hamadani</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/433986520\">said</a>:</p>\n<blockquote>\n<p>In case that sounds like a good idea, <a href=\"https://github.com/leanprover-community/leanprover-community.github.io/pull/464\">here</a> is a small PR that does it.</p>\n</blockquote>\n<p>Thanks <span class=\"user-mention\" data-user-id=\"580947\">@Rida Hamadani</span>, made a small suggestion, but yes, this is a good idea!</p>",
        "id": 433995975,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713429496
    },
    {
        "content": "<p>Merged!</p>",
        "id": 433998328,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713430132
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, we'll have to update the message once <a href=\"https://github.com/leanprover-community/mathlib4/pull/11853\">#11853</a> lands</p>",
        "id": 434010962,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1713434417
    },
    {
        "content": "<p>I'm also hitting the \"the diff exceeded the maximum number of files (300)\" thing in <a href=\"https://github.com/leanprover-community/mathlib4/pull/12274\">#12274</a></p>",
        "id": 434389568,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1713541667
    },
    {
        "content": "<p>Uhh.</p>",
        "id": 434390278,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1713541913
    },
    {
        "content": "<p>If you're going to do something like this, at the very least you should make sure that the big commits are completely autogenerated</p>",
        "id": 434390469,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1713541976
    },
    {
        "content": "<p>I think we've been waiting to do this until we have a better ability to do global replacement.</p>",
        "id": 434391253,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1713542229
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/434390469\">said</a>:</p>\n<blockquote>\n<p>If you're going to do something like this, at the very least you should make sure that the big commits are completely autogenerated</p>\n</blockquote>\n<p>I split them up in a few commits, each starts with a regular expression replacement followed by a manual replacement where the replacement went wrong. I suppose I can make each one of those into two commits a big completely autogenerated one and a small one with manual fixes. That should make it easy to review.</p>",
        "id": 434394417,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1713543173
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/434391253\">said</a>:</p>\n<blockquote>\n<p>I think we've been waiting to do this until we have a better ability to do global replacement.</p>\n</blockquote>\n<p>Ok, what the rationale behind this?</p>",
        "id": 434394692,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1713543251
    },
    {
        "content": "<p>The existing <code>refine'</code> isn't doing much harm as is. And also, such a replacement would be a good test bed for a new global replacement tool.</p>",
        "id": 434396921,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1713543989
    },
    {
        "content": "<p>And person-hours saved also.</p>",
        "id": 434396974,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1713544011
    },
    {
        "content": "<p>I have closed the pull request on the <code>refine'</code>, if you think it is better to postpone it. <br>\nNonetheless, while I was add it I looked into how to fix the \"the diff exceeded the maximum number of files (300)\" problem and <a href=\"https://github.com/leanprover-community/mathlib4/pull/12280\">#12280</a> contains a way to \"fix\" it, by disabling the reviewdog for pull request that touch more than 300 files. Of course an even better fix might be to find a way to run the reviewdog nonetheless, but I think this is something that would need to be fixed upstream at the reviewdog repo. <del>Perhaps it is worth reporting this as a bug/feature-request there?</del></p>",
        "id": 434479089,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1713598415
    },
    {
        "content": "<p>Alex noted above that there's already some discussion upstream at <a href=\"https://github.com/reviewdog/reviewdog/issues/1696#issue-2206596164\">https://github.com/reviewdog/reviewdog/issues/1696#issue-2206596164</a>.</p>",
        "id": 434479359,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713598489
    },
    {
        "content": "<p>Cool, I will add a comment with a link to this discussion in the temporary fix</p>",
        "id": 434479397,
        "sender_full_name": "Moritz Firsching",
        "timestamp": 1713598548
    },
    {
        "content": "<p>Is it possible, either to apply all of the comments suggested by <code>reviewdog</code>, or to discard them all. I have hundreds of them because of trailing spaces and it is a nuisance to have to check them one by one on the website.</p>",
        "id": 456815536,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1722938915
    },
    {
        "content": "<p>If it is just trailing spaces, this may fix them:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git<span class=\"w\"> </span>ls-files<span class=\"w\"> </span><span class=\"s1\">'*.lean'</span><span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>xargs<span class=\"w\"> </span>sed<span class=\"w\"> </span>-i<span class=\"w\"> </span><span class=\"s1\">'s=  *$=='</span>\n</code></pre></div>",
        "id": 456815821,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722939010
    },
    {
        "content": "<p>(I do not know if it is possible to accept in bulk all the suggestions by reviewdog.)</p>",
        "id": 456815987,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722939071
    },
    {
        "content": "<p>That shouldn't be necessary, you can just use <code>lint-style.sh --fix</code></p>",
        "id": 456816148,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722939133
    },
    {
        "content": "<p>Which is what reviewdog is using to generate the suggestions anyway</p>",
        "id": 456816167,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722939145
    },
    {
        "content": "<p>That doesn't help with discarding the comments though</p>",
        "id": 456816186,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722939155
    },
    {
        "content": "<p>So to discard the comments, the simplest seems to close the PR and to reopen another one?</p>",
        "id": 456816342,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1722939224
    },
    {
        "content": "<p>Maybe this is an argument for not using reviewdog in the first place</p>",
        "id": 456822192,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722941393
    },
    {
        "content": "<p>Do we have choice for that?</p>",
        "id": 456829493,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1722943730
    },
    {
        "content": "<p>I do not find <code>reviewdog</code> terrible: most of the times, I am grateful that I can click a couple of suggestions to merge them and get CI to pass.</p>\n<p>If it had a way of self-silencing when it would give more than some number of suggestions, that might be useful though.</p>",
        "id": 456833096,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722944592
    },
    {
        "content": "<p>I also remember that at some point, a PR touching over some number of files could not pass CI due to reviewdog.  In that case, Alex manage to work around the issue.</p>",
        "id": 456833266,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722944638
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"130609\">@Antoine Chambert-Loir</span> can you link to the pr in question so we can see how bad it looks. I would guess if you apply the linter on commandline and push all comments get marked as outdated already so hopefully aren't too distracting</p>",
        "id": 456845808,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1722947810
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/9315\">#9315</a></p>",
        "id": 456845856,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1722947824
    },
    {
        "content": "<p>That pr was closed 7 months ago, is that really the right one?</p>",
        "id": 456846031,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1722947880
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/9359\">#9359</a> maybe?</p>",
        "id": 456846109,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1722947894
    },
    {
        "content": "<p>Sorry, yes</p>",
        "id": 456846240,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1722947934
    },
    {
        "content": "<p>I see, that PR looks ok on my device, I don't see loads of outdated comments or anything, so it sounds to me like applying on the command line was a good resolution and the most constructive thing we can do here is to add some reminders somewhere that reviewdog suggestions can be applied manually on your own device. Either in the reviewdog comment or on a contributing page on the website.</p>",
        "id": 456847454,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1722948178
    },
    {
        "content": "<p>I think several users would be very happy if they can write a github comment <code>@reviewdog fix this for me</code> (or something like that). Would someone be willing to write a CI action for that?</p>",
        "id": 460017984,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1723448119
    },
    {
        "content": "<p>I like the idea! In terms of naming, <code>@reviewdog fix</code>sounds good. Perhaps reviewdog could mention this when posting comments, something like \"Type <code>@reviewdog fix</code> in a comment to apply all unresolved suggestions.\"</p>",
        "id": 460091889,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723472247
    },
    {
        "content": "<p>The downside of <code>@reviewdog &lt;some fix message&gt;</code> is that it creates the illusion that reviewdog is involved in the fixing. So maybe it should just be something like</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>bot fix style\n</code></pre></div>",
        "id": 460092703,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1723472482
    },
    {
        "content": "<p>I took a quick look but it looks like I'll need to spend some time figuring out how reviewdog works before I can put a workflow together. If no one else wants to work on it I'll try to come back to this within a few days. I'd of course be happy to review a PR as well.</p>",
        "id": 460101312,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1723475087
    },
    {
        "content": "<p>I don't think you need to know anything about review dog, you just need to run the lint --fix command and push the results</p>",
        "id": 460119728,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1723480696
    },
    {
        "content": "<p>This also means you need the dependencies of <code>lint --fix</code> installed, which used to include Python</p>",
        "id": 460119831,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723480747
    },
    {
        "content": "<p>Thanks, I think I can probably hack something together tonight then.</p>\n<p><strong>edit</strong>: something came up, but I should still be able to get to this before next week.</p>",
        "id": 460120875,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1723481177
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/460119831\">said</a>:</p>\n<blockquote>\n<p>This also means you need the dependencies of <code>lint --fix</code> installed, which used to include Python</p>\n</blockquote>\n<p>It still does - the Python rewrite is not complete yet.</p>",
        "id": 461927244,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723487396
    },
    {
        "content": "<p>I've created a PR at <a href=\"https://github.com/leanprover-community/mathlib4/pull/15781\">#15781</a>, but I haven't had a chance to test it out yet. I tried a few times to trigger the style linter and reviewdog by adding random spaces at the beginnings of lines in a leaf file but I couldn't get it to work (fail?). If someone wants to give it a shot please feel free!</p>\n<p><strong>edit</strong>: It looks like I may end up having to test this out in a fork, but still any commits to the branch would be appreciated!</p>",
        "id": 462217450,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1723585756
    },
    {
        "content": "<p>Thanks for starting on this. I left a comment</p>",
        "id": 462496185,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1723708036
    },
    {
        "content": "<p>This is finally ready for review. As I mention in the PR comment, you can test this out by going to <a href=\"https://github.com/bryangingechen/mathlib4\">my fork of mathlib4</a> and adding comments / PR reviews.</p>",
        "id": 464772036,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724463553
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> thanks for hacking on this. Atm it seems the github action isn't completely happy. But your experiments look like it did work in the past.</p>",
        "id": 465121790,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724661586
    },
    {
        "content": "<p>Or maybe I just ran into</p>\n<blockquote>\n<p>For starters, if someone would like to try commenting <code>bot fix style</code> on <a href=\"https://github.com/bryangingechen/mathlib4/pull/2\">bryangingechen#2</a> I can check if the permissions check is working properly. (Since no one other than me has write access at this time, hopefully the bot will ignore your comment.)</p>\n</blockquote>",
        "id": 465122035,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724661664
    },
    {
        "content": "<p>Yep, looks like it! <br>\n<a href=\"/user_uploads/3121/TpgWxW6hb5fUwZlbdba1FWQa/Screenshot-2024-08-26-at-06.17.11.png\">Screenshot-2024-08-26-at-06.17.11.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/TpgWxW6hb5fUwZlbdba1FWQa/Screenshot-2024-08-26-at-06.17.11.png\" title=\"Screenshot-2024-08-26-at-06.17.11.png\"><img data-original-dimensions=\"1624x836\" src=\"/user_uploads/thumbnail/3121/TpgWxW6hb5fUwZlbdba1FWQa/Screenshot-2024-08-26-at-06.17.11.png/840x560.webp\"></a></div><p>I've given you write access now so you can test it further if you wish.</p>",
        "id": 465141429,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724667555
    },
    {
        "content": "<p>Just did another test</p>",
        "id": 465142963,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724668251
    },
    {
        "content": "<p>It failed again, but I checked the settings and it looks to me like you have to manually accept the invite for your permissions to change.</p>",
        "id": 465143349,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724668416
    },
    {
        "content": "<p><a href=\"https://github.com/bryangingechen/mathlib4/invitations\">https://github.com/bryangingechen/mathlib4/invitations</a></p>",
        "id": 465143367,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724668429
    },
    {
        "content": "<p>good point, new attempt</p>",
        "id": 465148350,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724670316
    },
    {
        "content": "<p>The test seems to work</p>",
        "id": 465514261,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724779920
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> would you like to do more testing, or shall we merge your PR?</p>",
        "id": 465514379,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724779947
    },
    {
        "content": "<p>I've exhausted the tests that I could think of, so if everyone is happy with it we can merge. (I'm always afraid that there's something I've missed...)</p>",
        "id": 465518708,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724781087
    },
    {
        "content": "<p>Well, you aren't force pushing, so you can't do too much damage</p>",
        "id": 465536615,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724785738
    },
    {
        "content": "<p><img alt=\":merge:\" class=\"emoji\" src=\"https://avatars.zulip.com/3121/emoji/images/37577b95.png\" title=\"merge\"></p>",
        "id": 465537080,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724785819
    },
    {
        "content": "<p>Funny story, before I got the token set up properly, the first version of the script pushed to <code>master</code> instead of the PR branch...</p>",
        "id": 465539700,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724786342
    },
    {
        "content": "<p>Could we please: </p>\n<ol>\n<li>Make sure the new token/secret usage is documented in the usual place.</li>\n</ol>",
        "id": 465582023,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724798850
    },
    {
        "content": "<ol start=\"2\">\n<li>Ideally use a new token and secret; ideally everything is only used in one place.</li>\n</ol>",
        "id": 465582053,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724798874
    },
    {
        "content": "<p>Thanks for the reminder, I'll try to do both tomorrow!</p>",
        "id": 465600050,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724807507
    },
    {
        "content": "<p>Done now, hopefully! <a href=\"https://github.com/leanprover-community/mathlib4/pull/16232\">#16232</a></p>",
        "id": 465861084,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1724884988
    },
    {
        "content": "<p>It seems the new bot fix style command hasn't been used yet. I wonder if it's because people don't know it exists yet. </p>\n<p>One thought would be to have the <a href=\"https://github.com/reviewdog/action-suggester\">reviewdog action suggester</a> mention it somewhere, but it seems the only thing we can customize is the tool name. So, where the suggestions currently say <code>[lint-style] reported by reviewdog</code>, we could make them say something like <code>[lint-style (comment with \"bot fix style\" to have the bot commit all style suggestions)] reported by reviewdog</code>. </p>\n<p>Thoughts?</p>",
        "id": 466505584,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1725099678
    },
    {
        "content": "<p>Sounds like a good idea. It's a bit long though, but I don't have an immediate improvement in mind.</p>",
        "id": 466544937,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1725112925
    },
    {
        "content": "<p>Thanks! I've opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/16365\">#16365</a> for now.</p>",
        "id": 466546977,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1725113449
    },
    {
        "content": "<p>I think reviewdog doesn't post suggestions for fixing <code>Mathlib.lean</code> (by running <code>lake exe mk_all</code>) or does it?<br>\nCan we easily add that functionality?</p>",
        "id": 476908924,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728973721
    },
    {
        "content": "<p>Because then <code>bot fix style</code> would also auto-fix those problems.</p>",
        "id": 476908968,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728973740
    },
    {
        "content": "<p>I think that it was intended that it did, but I also think that it doesn't.</p>",
        "id": 476912619,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728974825
    },
    {
        "content": "<p>It definitely did for a long while. Doesn't seem like it does anymore</p>",
        "id": 476913945,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1728975208
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> Do you by any chance know some back story here?</p>",
        "id": 476925898,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728978334
    },
    {
        "content": "<p>I seem to recall that it made suggestions, but they were often wrong for some reason I never looked into</p>",
        "id": 476926463,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1728978510
    },
    {
        "content": "<p>But <code>lake exe mk_all</code> should just do the right thing, shouldn't it?</p>",
        "id": 476926939,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728978672
    },
    {
        "content": "<p>I still wish we could just get rid of that CI step completely. And <a href=\"#narrow/stream/287929-mathlib4/topic/generating.20Mathlib.2Elean/near/264350855\">https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/generating.20Mathlib.2Elean/near/264350855</a> suggests that maybe we can.</p>",
        "id": 476927865,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728978977
    },
    {
        "content": "<p>I just want CI to create the file just before it runs the bors build on <code>staging</code></p>",
        "id": 476928010,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728979023
    },
    {
        "content": "<p>The file could be not git-indexed and CI could generate it on the fly.  However, having the option of <code>import Mathlib</code> is really good.</p>",
        "id": 476928977,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728979319
    },
    {
        "content": "<p>After all, CI already generates it on the fly and uses the one it generates for its checks.</p>",
        "id": 476929128,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728979357
    },
    {
        "content": "<p>Right. So why can't the autogenerated one be committed when bors decides that a batch gets merged.</p>",
        "id": 476930013,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728979632
    },
    {
        "content": "<p>I see no reason for this: you could have PRs with out-of-sync Mathli.lean, but CI nevertheless building everything and then in the final Bors staging commit the output of mk_all.</p>",
        "id": 476930294,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728979730
    },
    {
        "content": "<p>Yeah, that would be nice.</p>",
        "id": 476930441,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728979787
    },
    {
        "content": "<p>But atm I don't know how to do that. Because bors is a black box to me.</p>",
        "id": 476930485,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728979800
    },
    {
        "content": "<p>As it currently is, CI already pretends that you updated Mathlib.lean.</p>",
        "id": 476930548,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728979811
    },
    {
        "content": "<p>I've never looked at the staging CI, but presumably you can run some script before that could include <code>mk_all</code>?</p>",
        "id": 476930747,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728979898
    },
    {
        "content": "<p>I'm a bit worried that we hand over to <code>bors</code> before that point.</p>",
        "id": 476931268,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728980080
    },
    {
        "content": "<p>I'll have to look at the code, as Bors is a black box to me too.</p>",
        "id": 476931841,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728980285
    },
    {
        "content": "<p>It looks like bors merges the PRs and runs the \"usual\" CI.  This probably means that some batches fail due to Mathlib.lean having failed to correctly (i.e. alphabetically) merge.</p>",
        "id": 476934375,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981140
    },
    {
        "content": "<p>Would it be too aggressive to add a CI step that commits import changes if Mathlib.lean is out of sync?</p>",
        "id": 476934531,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981202
    },
    {
        "content": "<p>If we can make bors reliably commit the correct mathlib.lean, then we also no longer need to bug users that the mathlib.lean in their PR is out of date.</p>",
        "id": 476934558,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728981213
    },
    {
        "content": "<p>Yeah, I would prefer if we do <em>not</em> need to commit to user PRs.</p>",
        "id": 476934592,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728981229
    },
    {
        "content": "<p>The staging script could do that, though?</p>",
        "id": 476934795,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981293
    },
    {
        "content": "<p>After all, the staging script is generated to be virtually identical to CI, but we could have a different one instead.</p>",
        "id": 476934940,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981340
    },
    {
        "content": "<p>I hope so. Where does that live? I have no idea which steps are part of the black box, and which parts we can tweak.</p>",
        "id": 476935044,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728981364
    },
    {
        "content": "<p>The CI script has a master file that is in <code>.github/build...</code>.</p>",
        "id": 476935128,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981396
    },
    {
        "content": "<p>That file auto-generates the remaining build scripts that are in <code>.github/workflows</code>.</p>",
        "id": 476935219,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981426
    },
    {
        "content": "<p>Yes, but I didn't see anything about setting up staging. Maybe I didn't look carefully?</p>",
        "id": 476935297,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728981454
    },
    {
        "content": "<p>The one called <code>bors.yml</code> is the result of auto-generation, but auto-generation is run manually and has its own script <code>mk_build_something</code>.</p>",
        "id": 476935361,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981482
    },
    {
        "content": "<p>I view all the CI steps in the bors.yml file as \"pre-staging\": there we may add a commit?</p>",
        "id": 476935523,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981535
    },
    {
        "content": "<p>If we don't commit to user branches, but to a branch managed by CI / bors, that's totally fine.</p>",
        "id": 476935759,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728981617
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/476934592\">said</a>:</p>\n<blockquote>\n<p>Yeah, I would prefer if we do <em>not</em> need to commit to user PRs.</p>\n</blockquote>\n<p>But can we make it so that we don't have an extra \"Update Mathlib.lean\" commit on master for each bors batch?</p>",
        "id": 476935809,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1728981633
    },
    {
        "content": "<p>It does not mean that bors receives a correct Mathlib.lean file, but it receives the same that it would now.</p>",
        "id": 476935847,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981644
    },
    {
        "content": "<p>At worst, we can create a new PR with the extra commit and merge <em>that</em>.</p>",
        "id": 476936026,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981709
    },
    {
        "content": "<p>So bors receives PR that already have a compliant Mathlib.lean</p>",
        "id": 476936169,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728981753
    },
    {
        "content": "<p>But then it merges the original branches, so we need to make sure that they have a compliant Mathlib.lean...</p>",
        "id": 476936737,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728981917
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/reviewdog/near/476934592\">said</a>:</p>\n<blockquote>\n<p>Yeah, I would prefer if we do <em>not</em> need to commit to user PRs.</p>\n</blockquote>\n<p>Let me amend that a bit: I would really prefer if we do not commit to user branches, unless it is &lt; 30 seconds before merging them.</p>",
        "id": 476936976,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728981980
    },
    {
        "content": "<p>So only between the point where bors decides \" <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> yup we can merge this\" and where bors actually carries out the merging.</p>",
        "id": 476937080,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728982019
    },
    {
        "content": "<p>Right, I'm thinking that instead of <code>bors merge</code> we do <code>mk_all, commit, merge</code></p>",
        "id": 476937135,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728982037
    },
    {
        "content": "<p><code>commit</code> on which branch?</p>",
        "id": 476937210,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728982059
    },
    {
        "content": "<p><code>bors merge</code> can still fail...</p>",
        "id": 476937254,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728982075
    },
    {
        "content": "<p>Possibly the commit on a new branch that includes the modifications and the merge on that branch.</p>",
        "id": 476937318,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728982086
    },
    {
        "content": "<p>(Sorry, I'm on my phone and I'm about to see a student!  I'll try to type something as soon as I'm in my office!)</p>",
        "id": 476937740,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728982219
    },
    {
        "content": "<p>How about</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>mk_all\n<span class=\"k\">then</span>\n<span class=\"w\">  </span>bors<span class=\"w\"> </span>merge\n<span class=\"k\">else</span>\n<span class=\"w\">  </span>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span>-b<span class=\"w\"> </span>new_branch\n<span class=\"w\">  </span>git<span class=\"w\"> </span>add<span class=\"w\"> </span>-u\n<span class=\"w\">  </span>git<span class=\"w\"> </span>commit<span class=\"w\"> </span>-m<span class=\"w\"> </span><span class=\"s1\">'add imports'</span>\n<span class=\"w\">  </span><span class=\"o\">(</span>create<span class=\"w\"> </span>a<span class=\"w\"> </span>PR<span class=\"o\">)</span>\n<span class=\"w\">  </span>bors<span class=\"w\"> </span>merge<span class=\"w\"> </span>this<span class=\"w\"> </span>PR\n<span class=\"k\">fi</span>\n</code></pre></div>\n<p>(modulo a million extra safety checks)?</p>",
        "id": 476938561,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1728982476
    },
    {
        "content": "<p>What about</p>\n<ol>\n<li>\n<p>For each PR in the batch,<br>\n  a. Run <code>lake exe mk_all</code> on the branch<br>\n  b. Commit the result onto a new branch <code>PR-N-staging</code> where N is the PR number. Don't publish that branch<br>\n  c. Squash merge <code>PR-N-staging</code> onto <code>staging</code> (assuming no conflict). If there is a conflict in <code>Mathlib.lean</code>, fix it by running <code>lake exe mk_all</code> again.</p>\n</li>\n<li>\n<p>Run CI on <code>staging</code></p>\n</li>\n<li>If CI passes, rebase <code>master</code> on <code>staging</code></li>\n</ol>",
        "id": 476942607,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1728983699
    },
    {
        "content": "<p>Pros:</p>\n<ul>\n<li>No need to bother about <code>lake exe mk_all</code> whil making a PR</li>\n<li>No extra commit on master</li>\n<li>Each commit corresponds to the content of the relevant PR</li>\n</ul>",
        "id": 476943228,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1728983872
    },
    {
        "content": "<p>Sounds totally fine, but once again, I don't know where to implement your steps.</p>",
        "id": 476965096,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728991147
    },
    {
        "content": "<p>I think it's in bors' guts</p>",
        "id": 476984733,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1728997307
    },
    {
        "content": "<p>It would be very strange to hardcode <code>lake</code> references inside bors, even if it is our own fork.</p>",
        "id": 476995379,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1729000365
    },
    {
        "content": "<p>We could hardcode functionality to run a pre-bors-hook and a post-bors-hook.</p>",
        "id": 477001325,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1729002054
    }
]