[
    {
        "content": "<p>There is an instance <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Fintype/EquivFin.html#instInfiniteOption\">instInfiniteOption</a> for infinite Option types.  But there does not seem to be a corresponding Finite Option instance, like the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instFiniteOption</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">of_finite_univ</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">finite_option</span><span class=\"bp\">.</span><span class=\"n\">mpr</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">toFinite</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">univ</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>Shouldn't something like the above be added to mathlib?</p>",
        "id": 535619476,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1755842025
    },
    {
        "content": "<p>Yes, that is definitely missing.</p>\n<p>One of the usual ways to derive these is using the <code>Fintype</code> instance like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">ofFinite</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"w\">  </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">of_fintype</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>but if your version lets it appear earlier that's fine too.</p>",
        "id": 535620316,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755842598
    },
    {
        "content": "<p>Should instFiniteOption be added to mathlib?</p>",
        "id": 535622278,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1755843795
    },
    {
        "content": "<p>By \"it's missing\", I mean \"mathlib should have it\", not \"it's intentionally excluded\", to be clear.</p>\n<p>The instance should not be given an explicit name.</p>",
        "id": 535623097,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755844293
    },
    {
        "content": "<p>I can't find such an instance in mathlib.</p>",
        "id": 535623726,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1755844652
    },
    {
        "content": "<p>\"Mathlib <em>ought</em> to have it\" — please contribute it</p>",
        "id": 535624081,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755844875
    },
    {
        "content": "<p>The code suggestion was how the contribution could look. For style, we like to use the autogenerated name, hence the suggestion to not give it an explicit name.</p>\n<p>When I said it's definitely missing, that's after verifying that the instance does not exist. I used this code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 535624401,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755845061
    },
    {
        "content": "<p>Which mathlib file should the instance be added to?</p>",
        "id": 535625307,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1755845495
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">ofFinite</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"w\">  </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">of_fintype</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"bp\">#</span><span class=\"n\">min_imports</span><span class=\"w\"> </span><span class=\"c1\">-- import Mathlib.Data.Fintype.Option</span>\n</code></pre></div>\n<p>vs</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Set</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">instFiniteOption</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">of_finite_univ</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">finite_option</span><span class=\"bp\">.</span><span class=\"n\">mpr</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">toFinite</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">univ</span><span class=\"o\">}</span>\n<span class=\"bp\">#</span><span class=\"n\">min_imports</span><span class=\"w\"> </span><span class=\"c1\">-- import Mathlib.Data.Set.Finite.Basic</span>\n</code></pre></div>\n<p>So you should add Kyle's proof to <code>Mathlib.Data.Fintype.Option</code></p>",
        "id": 535630576,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1755847934
    },
    {
        "content": "<p>PR: <a href=\"https://github.com/leanprover-community/mathlib4/pull/28783\">https://github.com/leanprover-community/mathlib4/pull/28783</a></p>",
        "id": 535761512,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1755900100
    },
    {
        "content": "<p>By the way, thanks for all the comments!</p>",
        "id": 535761952,
        "sender_full_name": "Ching-Tsun Chou",
        "timestamp": 1755900425
    },
    {
        "content": "<p>Wait, <code>Mathlib.Data.Fintype.Option</code> is heavier with 370 imports compared to <code>Mathlib.Data.Set.Finite.Basic</code>'s 312 imports.<br>\n(You can check this by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"bp\">#</span><span class=\"n\">trans_imports</span><span class=\"w\"> </span><span class=\"s2\">\"Mathlib.\"</span>\n</code></pre></div>\n<p>)</p>",
        "id": 535855556,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755972132
    },
    {
        "content": "<p>Hm, I thought I checked and <code>Mathlib.Data.Set.Finite.Basic</code> imported <code>Mathlib.Data.Fintype.Option</code>, but it doesn't seem so anymore. Still, the Option file seems more topical</p>",
        "id": 535858718,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1755976320
    },
    {
        "content": "<p>I also observed that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=nonempty_fintype#doc\">docs#nonempty_fintype</a> saves a few (dozen?) imports over <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Fintype/EquivFin.html#Fintype.ofFinite\">Fintype.ofFinite</a>. The latter should probably be moved into the same file as the former.</p>",
        "id": 535868708,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755991170
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224323\">@Junyan Xu</span> Please feel free to make these basic instances not depend on Fintype/Finset/etc.</p>\n<p>The Option instance can be created using much more basic imports, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">f</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inst</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"o\">(</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">optionCongr</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"n\">finSuccEquivLast</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"bp\">⟩</span>\n<span class=\"bp\">#</span><span class=\"n\">min_imports</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">import Mathlib.Data.Finite.Defs</span>\n<span class=\"cm\">import Mathlib.Logic.Equiv.Fin.Basic</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 535869295,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755992242
    },
    {
        "content": "<p>(I didn't check if optionCongr or finSuccEquivLast are actually in more basic modules, but in principle they could be.)</p>",
        "id": 535869323,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1755992289
    }
]