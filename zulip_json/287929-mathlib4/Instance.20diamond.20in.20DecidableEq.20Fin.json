[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"266253\">@Joseph Myers</span>' <a href=\"https://github.com/leanprover-community/mathlib4/pull/29418\">#29418</a> led me to discover this diamond:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">instLinearOrder</span><span class=\"bp\">.</span><span class=\"n\">toDecidableEq</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">instDecidableEqFin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">smartUnfolding</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"bp\">.</span><span class=\"n\">instLinearOrder</span><span class=\"bp\">.</span><span class=\"n\">toDecidableEq</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">instDecidableEqFin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>\n<p>I guess we decided \"this will obviously be defeq to the instance in core\" without  actually reusing the core instance, but then the meaning of \"defeq\" changed</p>",
        "id": 538119386,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757295806
    },
    {
        "content": "<p>interesting</p>",
        "id": 538119530,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757295989
    },
    {
        "content": "<p>I guess it's time to pull out</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mahtlib</span>\n\n<span class=\"sd\">/-- Replace decidable equality in a `LinearOrder` instance with a propositionally (but possibly not</span>\n<span class=\"sd\">definitionally) equal one. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"bp\">.</span><span class=\"n\">replaceDecEq</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">__</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span>\n<span class=\"w\">  </span><span class=\"n\">toDecidableEq</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decEq</span>\n<span class=\"w\">  </span><span class=\"n\">compare_eq_compareOfLessAndEq</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">Subsingleton</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">toDecidableEq</span><span class=\"w\"> </span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">compare_eq_compareOfLessAndEq</span>\n</code></pre></div>\n<p>and friends</p>",
        "id": 538119672,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757296186
    },
    {
        "content": "<p>I think really <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearOrder.lift#doc\">docs#LinearOrder.lift</a> and family are to blame</p>",
        "id": 538186155,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757327055
    },
    {
        "content": "<p>Do you think we should have versions which don't synthesize the decidability fields?</p>",
        "id": 538186916,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757327303
    },
    {
        "content": "<p>Can someone remind me why we have all this constructivist nonsense in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearOrder#doc\">docs#LinearOrder</a> ? My instinct with these things is that the moment they start causing trouble, rip them out, but presumably there's a good reason that they're there in the first place?</p>",
        "id": 538188787,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757327919
    },
    {
        "content": "<p>Perhaps related (but perhaps not): it seems that core is adding predicates to <code>LE</code> to get things like partial orders (sorry for no link, on mobile, but I thought I saw a recent core PR). Should we switch to this model? (edit: it was <a href=\"https://github.com/leanprover/lean4/pull/9908\">lean4#9908</a> which was going on about <code>IsPartialOrder</code>, <code>IsLinearOrder</code> etc)</p>",
        "id": 538189047,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757327998
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Instance.20diamond.20in.20DecidableEq.20Fin/near/538186916\">said</a>:</p>\n<blockquote>\n<p>Do you think we should have versions which don't synthesize the decidability fields?</p>\n</blockquote>\n<p>Yes, I've started writing these in <a href=\"https://github.com/leanprover-community/mathlib4/pull/29436\">#29436</a></p>",
        "id": 538194999,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757329724
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Instance.20diamond.20in.20DecidableEq.20Fin/near/538188787\">said</a>:</p>\n<blockquote>\n<p>My instinct with these things is that the moment they start causing trouble, rip them out</p>\n</blockquote>\n<p>In this case the problem is mostly <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearOrder.lift#doc\">docs#LinearOrder.lift</a>, which completely ignores the pattern set by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Function.Injective.ring#doc\">docs#Function.Injective.ring</a> etc</p>",
        "id": 538195403,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757329844
    },
    {
        "content": "<p>Aah OK, let's see if this solves it.</p>",
        "id": 538198247,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1757330743
    },
    {
        "content": "<p>It definitely solves it, you can't construct diamonds if you don't construct any data in the first place!</p>",
        "id": 538281232,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757352286
    },
    {
        "content": "<p>One thing that <a href=\"https://github.com/leanprover-community/mathlib4/pull/29436\">#29436</a> raises is what to do about this and similar theorems):</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span>lemma Function.Injective.isOrderedMonoid [IsOrderedMonoid α]\n<span class=\"gd\">-    [One β] [Mul β] [Pow β ℕ]</span>\n<span class=\"gi\">+    [CommMonoid β] [PartialOrder β]</span>\n<span class=\"w\"> </span>    (f : β → α)\n<span class=\"gd\">-    (hf : Function.Injective f) (one : f 1 = 1) (npow : ∀ (x) (n : ℕ), f (x ^ n) = f x ^ n)</span>\n<span class=\"gi\">+    (le : ∀ {x y}, f x ≤ f y ↔ x ≤ y)</span>\n<span class=\"w\"> </span>    (mul : ∀ x y, f (x * y) = f x * f y) :\n<span class=\"gd\">-    let _ : CommMonoid β := hf.commMonoid f one mul npow</span>\n<span class=\"gd\">-    let _ : PartialOrder β := PartialOrder.lift f hf</span>\n<span class=\"w\"> </span>    IsOrderedMonoid β :=\n</code></pre></div>\n<p>after changing the arguments, the name no longer makes any sense!</p>",
        "id": 538304833,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757361325
    }
]