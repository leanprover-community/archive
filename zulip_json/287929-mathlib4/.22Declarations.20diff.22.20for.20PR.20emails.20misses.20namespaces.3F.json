[
    {
        "content": "<p>I just submitted a PR (<a href=\"https://github.com/leanprover-community/mathlib4/pull/29355\">https://github.com/leanprover-community/mathlib4/pull/29355</a>) and I got an email with a declarations diff:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Declarations</span><span class=\"w\"> </span><span class=\"n\">diff</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">cos_series_bound</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">sin_series_bound</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_range_even</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">cos_series_bound</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">sin_series_bound</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">cos_antitone</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">cos_monotone</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">sin_antitone</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">sin_monotone</span>\n</code></pre></div>\n<p>I believe this is wrong, and that the last four are <code>Real.cos_antitone</code>, etc. since the entire file is in a <code>namespace Real</code> (#check agrees with me). Is it expected that this email tooling doesn't understand namespace scopes?</p>",
        "id": 537749453,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1757018240
    },
    {
        "content": "<p>yes this is expected the bot that does the declarations diff is text-based</p>",
        "id": 537749647,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1757018326
    },
    {
        "content": "<p>Note that the email is really just a notification about a comment being left on github</p>",
        "id": 538028161,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1757189182
    },
    {
        "content": "<p>Any chance we get a smarter diff bot that's based on the parsed code or doc?<br>\nAside from the namespace, the diff bot also misses other important changes such as </p>\n<ul>\n<li>theorems generated by <code>@[simps]</code> and <code>@[to_additive]</code></li>\n<li>section variables</li>\n</ul>",
        "id": 538028432,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1757189444
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover-community/mathlib4/pull/22464\">#22464</a>, <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Lean-based.20.22changed.20names.22.20script.3F/near/505878694\">#mathlib4 &gt; Lean-based \"changed names\" script? @ ðŸ’¬</a>.</p>",
        "id": 545449572,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760651645
    },
    {
        "content": "<p>This script works with names only, not types etc.</p>",
        "id": 545449591,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1760651666
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873350\">Weiyi Wang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.22Declarations.20diff.22.20for.20PR.20emails.20misses.20namespaces.3F/near/538028432\">said</a>:</p>\n<blockquote>\n<p>Any chance we get a smarter diff bot that's based on the parsed code or doc?<br>\nAside from the namespace, the diff bot also misses other important changes such as </p>\n<ul>\n<li>theorems generated by <code>@[simps]</code> and <code>@[to_additive]</code></li>\n<li>section variables</li>\n</ul>\n</blockquote>\n<p>Yes please! This would be a great project if anyone is interesting in doing some metaprogramming.</p>",
        "id": 545455423,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1760655206
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.22Declarations.20diff.22.20for.20PR.20emails.20misses.20namespaces.3F/near/545455423\">said</a>:</p>\n<blockquote>\n<p>Yes please! This would be a great project if anyone is interesting in doing some metaprogramming.</p>\n</blockquote>\n<p>I could work on this. It nicely intersects with my thoughts after our discussion about the Cslib namespace.</p>",
        "id": 545465823,
        "sender_full_name": "Chris Henson",
        "timestamp": 1760662504
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"687698\">@Chris Henson</span> That would be great! Please keep me in the loop if you pick this up.</p>",
        "id": 545502739,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1760686823
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> and I were discussing a bit of the design behind a Lean-based version of this. My intent is to write something that essentially uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Environment.constants#doc\">docs#Lean.Environment.constants</a> to compare the base and merge commit of a PR, possibly using oleans if they are available. (I'd like this to be somewhat general so CSlib can also use it, so that piece would be configurable)</p>\n<p>Damiano brought up the point that this makes a tradeoff of requiring a successful build, because a commit with errors would not be compatible with this approach. So this would need to need to be after CI passes. The question we were considering is if a syntax-directed version (which could still be in Lean as drafted in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26878\">#26878</a>) should still run as the PR opens, then be superseded by the environment checking version.</p>",
        "id": 547826009,
        "sender_full_name": "Chris Henson",
        "timestamp": 1761778641
    },
    {
        "content": "<p>My view is that the current script is still useful, even if imprecise.  So, my preference would be to have immediately the current script and have that comment updated once/if the PR passes CI.</p>",
        "id": 547826375,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761778870
    },
    {
        "content": "<p>I was a bit neutral above, I suppose I should share my opinion. I am personally somewhat ambivalent towards the declaration diff for non-building commits. However, procedurally this is fine and not hard to include, so if folks find it useful I do not object. (The only practical consideration is that it is probably easiest to separate out the declarations diff comment from the current PR summary if you want something that updates)</p>",
        "id": 547827902,
        "sender_full_name": "Chris Henson",
        "timestamp": 1761779781
    },
    {
        "content": "<p>A bit off-topic, but it would be cool if the same diff tool can run for version releases of lean / mathlib and generate report as change log. Sometimes the statements of theorems are slightly changed (explicit / implicit argument, argument reordering...) and it is sometimes not trivial to figure it out by just looking at the current doc and the old code with error</p>",
        "id": 547836054,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1761785574
    },
    {
        "content": "<p>I'd prefer to have things be simpler (i.e. only keep one mechanism for computing diffs; it's expensive to keep CI alive) and more correct (i.e. one based on the <code>Lean.Environment</code> is preferable), even if that is at the expense of having the report arrive later during CI.</p>",
        "id": 547841509,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761789973
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"687698\">Chris Henson</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.22Declarations.20diff.22.20for.20PR.20emails.20misses.20namespaces.3F/near/547826009\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> and I were discussing a bit of the design behind a Lean-based version of this. My intent is to write something that essentially uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Environment.constants#doc\">docs#Lean.Environment.constants</a> to compare the base and merge commit of a PR, possibly using oleans if they are available. (I'd like this to be somewhat general so CSlib can also use it, so that piece would be configurable)</p>\n<p>Damiano brought up the point that this makes a tradeoff of requiring a successful build, because a commit with errors would not be compatible with this approach. So this would need to need to be after CI passes. The question we were considering is if a syntax-directed version (which could still be in Lean as drafted in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26878\">#26878</a>) should still run as the PR opens, then be superseded by the environment checking version.</p>\n</blockquote>\n<p>I have a script that prints all names, sorted, see <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Lean-based.20.22changed.20names.22.20script.3F/near/505878694\">#mathlib4 &gt; Lean-based \"changed names\" script? @ ðŸ’¬</a></p>",
        "id": 547937849,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1761831560
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Lean-based.20.22changed.20names.22.20script.3F/near/505907645\">#mathlib4 &gt; Lean-based \"changed names\" script? @ ðŸ’¬</a> is the right message.</p>",
        "id": 547938011,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1761831599
    },
    {
        "content": "<p>I found myself wanting a smarter version of the declaration diff comment while reviewing <a href=\"https://github.com/leanprover-community/mathlib4/pull/31852\">#31852</a> and we will really want something that can give us a reliable list of added / removed declarations once the <code>to_dual</code> tagging starts in earnest. </p>\n<p>Also, I looked at Yury's script linked above, but it looks like it doesn't work anymore (<code>binductionOnSuffix</code> seems to have been renamed (?)). I can investigate further but not today.</p>",
        "id": 558569023,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1763694038
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> What's the status of your \"rewrite it in Lean\" project? Sounds like it would be nice to get over the line...</p>",
        "id": 558592226,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763709695
    },
    {
        "content": "<p>What I have is still something that works without the need to have oleans, so it is somewhat orthogonal to what Bryan is asking here.</p>",
        "id": 558601094,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1763712951
    },
    {
        "content": "<p>How about having a \"dual\" system, where we have an initial string-based feedback, which is essentially what you get now, that works on each push and then, once the oleans are available, we run a version of Yury's code to update the PR summary comment with correct information?</p>",
        "id": 558601095,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1763712952
    },
    {
        "content": "<p>I had started work on this also but paused because of the uncertainty around needing a \"dual\" approach. I had thought it would be nice to package into an action (so other projects can standardize) that takes as input two paths for oleans and diffs the environment.</p>",
        "id": 558622004,
        "sender_full_name": "Chris Henson",
        "timestamp": 1763719679
    }
]