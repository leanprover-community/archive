[
    {
        "content": "<p>Consider the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hx</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>The <code>norm_cast</code> fails to close this goal. Before that line, the goal is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\">   </span><span class=\"n\">aka</span><span class=\"w\">  </span><span class=\"o\">((</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and afterwards it's</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">‚Üë</span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\">   </span><span class=\"n\">aka</span><span class=\"w\">  </span><span class=\"o\">((</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This seems a bit unfortunate, since a goal that \"looks like\" <code>‚Üë(3 / 5) = ‚Üë(3 / 5)</code> should in general be the kind of thing that norm_cast can solve. This also means that <code>exact_mod_cast rfl</code> doesn't close the goal. (Not that that is really necessary, but it means that in other more complicated situations things wouldn't work.) Note that <code>simp</code> and <code>push_cast; rfl</code> both work, by essentially moving all the casts inwards instead.</p>\n<p>I noticed this while trying to figure out the ideal norm_cast's for a different type, was having some issues, and I wanted to see how ‚ÑÇ handles it, only to see it wasn't ideal either.</p>\n<p>What's the theory here? Like, what's the best way to pick simp/norm_cast/push_cast lemmas to handle this robustly?</p>",
        "id": 534243101,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755095405
    },
    {
        "content": "<p><a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/norm_cast.20and.20inverses/with/504719013\">#mathlib4 &gt; norm_cast and inverses</a></p>",
        "id": 534243467,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755095523
    },
    {
        "content": "<p>it looks like essentially the same problem</p>",
        "id": 534243511,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755095534
    },
    {
        "content": "<p>I wanted to say \"we should change norm_cast to call norm_num to prove that the denom is not zero\", but norm_cast is in core unfortunately and we can't change core</p>",
        "id": 534243519,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755095535
    },
    {
        "content": "<p>I see</p>",
        "id": 534243597,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755095560
    },
    {
        "content": "<p>In particular it looks like <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/exact_mod_cast.20and.20rationals/near/483080107\">#mathlib4 &gt; exact_mod_cast and rationals @ üí¨</a> . Thanks for pointer</p>",
        "id": 534243746,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755095615
    },
    {
        "content": "<p>Well, sounds like not a very solved problem then I guess. Too bad</p>",
        "id": 534243879,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755095659
    },
    {
        "content": "<p>I would make an example without mathlib but I don't know of any scalar towers in core</p>",
        "id": 534244277,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755095789
    },
    {
        "content": "<p>N N Z?</p>",
        "id": 534244431,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1755095847
    },
    {
        "content": "<p>N N doesn't give you a cast</p>",
        "id": 534244470,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755095860
    },
    {
        "content": "<p>There's N -&gt; Z -&gt; Fin x</p>",
        "id": 534244531,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755095880
    },
    {
        "content": "<p>Z -&gt; Fin also doesn't give you a cast</p>",
        "id": 534244608,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755095904
    },
    {
        "content": "<p>What do you mean? <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fin.IntCast.instIntCast#doc\">docs#Fin.IntCast.instIntCast</a></p>",
        "id": 534244726,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755095941
    },
    {
        "content": "<p>is Z -&gt; Fin something that <code>norm_cast</code> will know about?</p>",
        "id": 534244758,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755095949
    },
    {
        "content": "<p>oh this might work</p>",
        "id": 534245125,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755096044
    },
    {
        "content": "<p>This instance to fin is deprecated as of recently</p>",
        "id": 534246021,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1755096290
    },
    {
        "content": "<p>maybe I have misunderstood how <code>norm_cast</code> works</p>",
        "id": 534246104,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755096319
    },
    {
        "content": "<p>I feel like all my examples are reflecting a poor support for <code>Fin</code> rather than a problem with <code>norm_cast</code></p>",
        "id": 534248451,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755096955
    },
    {
        "content": "<p>Here's a solution:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DivisionRing</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CharZero</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">}</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">norm_cast</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast_div'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">divInt</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">divInt_eq_div</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">norm_cast</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"c1\">-- not needed for the below example</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">cast_div'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">divInt</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">divInt_eq_div</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hx</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n</code></pre></div>",
        "id": 534272668,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755105656
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/norm_cast.20best.20practices/near/534243519\">said</a>:</p>\n<blockquote>\n<p>but norm_cast is in core unfortunately and we can't change core</p>\n</blockquote>\n<p>A PR, making sure to branch off <code>nightly-with-mathlib</code> and to  verify that Mathlib still builds with whatever changes you make (adjusting the Mathlib lean-pr-testing-NNNN branch as needed), is very welcome.</p>",
        "id": 534313225,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755123802
    },
    {
        "content": "<p>It would have to be a change that allows a customisable discharger, of course, because <code>norm_num</code> is in Mathlib.</p>",
        "id": 534313297,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1755123841
    },
    {
        "content": "<p>I've made an attempt in <a href=\"https://github.com/leanprover-community/mathlib4/pull/28355\">#28355</a> to fix this, but unfortunately the new <code>@[norm_cast]</code> lemma overshadows <code>cast_div_charZero</code>. And I can't solve this non-confluency by adding the extra lemma, because that lemma doesn't work as a <code>@[norm_cast]</code> lemma in the <code>norm_cast</code> direction.</p>\n<p>I don't think a fix here should involve <code>norm_num</code>, because we want it to also work for arbitrary natural numbers, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hx</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 534314047,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755124300
    },
    {
        "content": "<p>It might sound crazy, but I think the answer might be to do some un-squashing before the elim. You can unsquash it into Complex.ofReal on both sides, then strip that in the elim phase, and things look better.</p>",
        "id": 534317629,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755126626
    },
    {
        "content": "<p>As an aside, I think you're generally in trouble as soon as you step outside of the <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">N</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">Z</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">Q</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">R</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">C</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{N} &lt; \\mathbb{Z} &lt; \\mathbb{Q} &lt; \\mathbb{R} &lt; \\mathbb{C}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.728em;vertical-align:-0.0391em;\"></span><span class=\"mord mathbb\">N</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.728em;vertical-align:-0.0391em;\"></span><span class=\"mord mathbb\">Z</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8556em;vertical-align:-0.1667em;\"></span><span class=\"mord mathbb\">Q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.728em;vertical-align:-0.0391em;\"></span><span class=\"mord mathbb\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">C</span></span></span></span> chain (eg to <code>NNReal</code> or <code>NNRat</code>)</p>",
        "id": 534323608,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755131719
    },
    {
        "content": "<p>From what I remember, the <code>norm_cast</code> algorithm only makes sense when the type involved in any given expression are totally ordered</p>",
        "id": 534323636,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755131743
    },
    {
        "content": "<p>I was working with real interval arithmetic (and don't really care about ordering, just calculation)</p>",
        "id": 534325530,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755133392
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"448405\">Alex Meiburg</span> <a href=\"#narrow/channel/287929-mathlib4/topic/norm_cast.20best.20practices/near/534317629\">said</a>:</p>\n<blockquote>\n<p>You can unsquash it into Complex.ofReal on both sides, then strip that in the elim phase, and things look better.</p>\n</blockquote>\n<p>Isn't that exactly what <code>norm_cast</code> is doing?</p>",
        "id": 534450168,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755166967
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/norm_cast.20best.20practices/near/534323608\">said</a>:</p>\n<blockquote>\n<p>As an aside, I think you're generally in trouble as soon as you step outside of the <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">N</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">Z</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">Q</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">R</mi><mo>&lt;</mo><mi mathvariant=\"double-struck\">C</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{N} &lt; \\mathbb{Z} &lt; \\mathbb{Q} &lt; \\mathbb{R} &lt; \\mathbb{C}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.728em;vertical-align:-0.0391em;\"></span><span class=\"mord mathbb\">N</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.728em;vertical-align:-0.0391em;\"></span><span class=\"mord mathbb\">Z</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8556em;vertical-align:-0.1667em;\"></span><span class=\"mord mathbb\">Q</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.728em;vertical-align:-0.0391em;\"></span><span class=\"mord mathbb\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">C</span></span></span></span> chain (eg to <code>NNReal</code> or <code>NNRat</code>)</p>\n</blockquote>\n<p>Indeed, I would have expected the following to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"w\"> </span><span class=\"n\">NNRat</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact_mod_cast</span><span class=\"w\"> </span><span class=\"n\">h</span>\n</code></pre></div>",
        "id": 534452028,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755167762
    },
    {
        "content": "<p>The same problem appears for <code>‚Åª¬π</code>, so I think that makes it easier to understand:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"bp\">‚Åª¬π</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">‚Åª¬π</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact_mod_cast</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"c1\">-- succeeds</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñ§</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"bp\">‚Åª¬π</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">‚Åª¬π</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact_mod_cast</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>The underlying problem is that <code>((a : ‚Ñ§) : ‚Ñù)‚Åª¬π</code> should be un-squashed to <code>(((a : ‚Ñ§) : ‚Ñö) : ‚Ñù)‚Åª¬π</code>. This could be done with a simproc.</p>",
        "id": 534460802,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755171285
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/norm_cast.20best.20practices/near/534450168\">said</a>:</p>\n<blockquote>\n<p>Isn't that exactly what <code>norm_cast</code> is doing?</p>\n</blockquote>\n<p>Oh, this is the \"heuristic splitting procedure\" I guess? It's described in <a href=\"https://arxiv.org/pdf/2001.10594\">the paper</a> but not anywhere in the Lean docs, afaict. (This is also the <em>only</em> place I've seen that states that move lemmas are applied right-to-left!)</p>",
        "id": 534501709,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755183668
    },
    {
        "content": "<p>In that case I don't understand why the original above didn't work.</p>",
        "id": 534532514,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1755193810
    },
    {
        "content": "<p>The splitting heuristic is used when an operator has 2 arguments, and if it can un-squash one of the arguments to match the other one. In this case, <code>=</code> has two arguments, and it can un-squash one of them so that both sides have the same cast as the head.</p>\n<p>But in the problematic case, the casts are hidden inside a <code>‚Åª¬π</code>, so it doesn't know that it should un-squash them...</p>",
        "id": 534539919,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1755196757
    }
]