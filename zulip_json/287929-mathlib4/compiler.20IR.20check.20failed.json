[
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"692118\">Shaopeng</span> <a href=\"#narrow/stream/270676-lean4/topic/compiler.20IR.20check.20failed/near/450065685\">said</a>:</p>\n<blockquote>\n<p>Yet another instance involving <code>FirstOrder.Language.Formula.varFreeFinset</code> and <code>Finset.toList</code>, the latter of which is <code>noncomputable</code>. Will comment at <a href=\"https://github.com/leanprover/lean4/pull/1785\">lean4#1785</a> as well.</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">ModelTheory</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">ModelTheory</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">FirstOrder</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Finset</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">freeVarFinset_Equal_Min</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ğ“›</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"o\">}(</span><span class=\"n\">Î²</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">ut</span><span class=\"o\">)[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">](</span><span class=\"n\">Ï†</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ“›</span><span class=\"bp\">.</span><span class=\"n\">Formula</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)(</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ“›</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ“›</span><span class=\"bp\">.</span><span class=\"n\">Formula</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î²</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"bp\">.</span><span class=\"n\">freeVarFinset</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"w\"> </span><span class=\"n\">t1</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> cf. Weirdly the following works. Note the only diff is the order of terms in the last line,</span>\n<span class=\"cm\">    making the match essentially uniform. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">freeVarFinset_Equal_Min2</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ğ“›</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"o\">}(</span><span class=\"n\">Î²</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">ut</span><span class=\"o\">)[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">](</span><span class=\"n\">Ï†</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ“›</span><span class=\"bp\">.</span><span class=\"n\">Formula</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)(</span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ“›</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ“›</span><span class=\"bp\">.</span><span class=\"n\">Formula</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î²</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Ï†</span><span class=\"bp\">.</span><span class=\"n\">freeVarFinset</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">nil</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">cons</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Language</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">t1</span><span class=\"w\"> </span><span class=\"n\">t2</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>By the way is there a way to circumvent the above issue for the following purposes? Essentially I <br>\nwanted to write a function <code>L.Formula  Î² â†’ L.Formula  (Î² âŠ• Î²)</code> which converts <code>Ï†</code> with freevariables <br>\n<code>xâ‚,..., xâ‚™</code>to the formula <code>xâ‚=xâ‚' âˆ§ ... âˆ§ xâ‚™=xâ‚™'</code>. A natural way would be to use pattern matching<br>\non the finite list of free variables but it gets stuck at similar compiler IR issues minimized as above.</p>\n<p>Any help or advice would be much appreciated!</p>",
        "id": 450068586,
        "sender_full_name": "Shaopeng",
        "timestamp": 1720503592
    },
    {
        "content": "<p>I think the answer here is to add a <code>freeVarList</code> definition (implemented from scratch), prove that <code>freeVarList.toFinset = freeVarFinset</code>, and use that list version instead</p>",
        "id": 450175819,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720532317
    },
    {
        "content": "<p>Thank you so much for the advice, Eric. That looks reasonable. Will try!</p>",
        "id": 450245918,
        "sender_full_name": "Shaopeng",
        "timestamp": 1720548554
    }
]