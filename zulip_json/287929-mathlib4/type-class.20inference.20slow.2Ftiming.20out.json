[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">⧸</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">37</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 530178706,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753200215
    },
    {
        "content": "<p>I think this is due to diamond instance coming from quotient and from addgroup -&gt; Zmod?</p>",
        "id": 530178766,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753200237
    },
    {
        "content": "<p>This works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">synthInstance</span><span class=\"bp\">.</span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">32197</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"bp\">⧸</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">span</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">37</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 530180012,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753200644
    },
    {
        "content": "<p><code>attribute [-instance] NormedAddCommGroup.toENormedAddCommMonoid</code> also fixes it (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormedAddCommGroup.toENormedAddCommMonoid#doc\">docs#NormedAddCommGroup.toENormedAddCommMonoid</a>)</p>",
        "id": 530180444,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753200792
    },
    {
        "content": "<p>Some suspicious instances I found by looking through the trace, which maybe should be scoped:</p>\n<ul>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Submodule.Quotient.normedAddCommGroup#doc\">docs#Submodule.Quotient.normedAddCommGroup</a> (and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ideal.Quotient.normedCommRing#doc\">docs#Ideal.Quotient.normedCommRing</a>) - might be ok, but this means we need to prove ideal properties by type-class inference to use this. We currently do that before even checking whether <code>M</code> has a seminorm.</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subsingleton.instComplementedLattice#doc\">docs#Subsingleton.instComplementedLattice</a> - I think we should scope all instances that assume unique/subsingleton(/finite?) to conclude some algebraic (or topological) class. </li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Bundle.instNormedAddCommGroupOfRiemannianBundle#doc\">docs#Bundle.instNormedAddCommGroupOfRiemannianBundle</a> seems really bad: it has a variable as its head symbol, and can therefore unify with any function application. In particular, when trying to find <code>NormedAddCommGroup (ℤ ⧸ Ideal.span {37})</code> it will use <code>E := fun A =&gt; ℤ ⧸ A</code>. This should definitely be scoped.</li>\n</ul>\n<p>Removing the 4 instances mentioned above reduced the number of heartbeats by <code>70x</code>, from <code>20000</code> to <code>300</code>.</p>\n<ul>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ENormedAddCommMonoid.toAddCommMonoid#doc\">docs#ENormedAddCommMonoid.toAddCommMonoid</a> (and friends) are ok I think, but maybe should have lower priority. </li>\n<li>Also, why are <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsSimpleModule#doc\">docs#IsSimpleModule</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsSemisimpleModule#doc\">docs#IsSemisimpleModule</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsSemisimpleRing#doc\">docs#IsSemisimpleRing</a> <code>abbrev</code>s? Do you really want to apply instances like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BooleanAlgebra.toComplementedLattice#doc\">docs#BooleanAlgebra.toComplementedLattice</a> to try to find an instance?</li>\n</ul>",
        "id": 530312318,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753266792
    },
    {
        "content": "<p>(cc <span class=\"user-mention\" data-user-id=\"890057\">@ZhiKai Pong</span>)</p>",
        "id": 530312448,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1753266841
    },
    {
        "content": "<p>I think we should make much more classes non-abbrevs: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsArtinian#doc\">docs#IsArtinian</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WellFoundedLT#doc\">docs#WellFoundedLT</a> (is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=isWellOrder_lt#doc\">docs#isWellOrder_lt</a> now completely useless, since <code>WellFoundedLT</code> is currently an abbrev?), etc.</p>",
        "id": 530313812,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753267426
    },
    {
        "content": "<p>(cc <span class=\"user-mention\" data-user-id=\"110050\">@Sébastien Gouëzel</span> for the bundle instance)</p>",
        "id": 530314033,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753267501
    },
    {
        "content": "<p>So we should try to replace <code>abbrev X := Y</code> by <code>class X extends Y</code>, right? I try to do this in <a href=\"https://github.com/leanprover-community/mathlib4/pull/27427\">#27427</a> for semisimple modules and I expect I'll need to add a few instances, since previously e.g. IsSimpleModule-&gt;IsSemisimpleModule comes from IsSimpleOrder-&gt;ComplementedLattice.</p>",
        "id": 530558662,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1753362148
    },
    {
        "content": "<p>The loss of defeq is annoying, see errors at <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16497574869/job/46647016790?pr=27427\">https://github.com/leanprover-community/mathlib4/actions/runs/16497574869/job/46647016790?pr=27427</a></p>",
        "id": 530559071,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1753362254
    },
    {
        "content": "<p>With <code>class X extends Y</code> we still get an instance from <code>X</code> to <code>Y</code>. Is this bad?</p>",
        "id": 530565053,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1753363995
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/bug.20with.20quotient.20of.20Z/near/530559071\">said</a>:</p>\n<blockquote>\n<p>The loss of defeq is annoying, see errors at <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/16497574869/job/46647016790?pr=27427\">https://github.com/leanprover-community/mathlib4/actions/runs/16497574869/job/46647016790?pr=27427</a></p>\n</blockquote>\n<p>you can replace <code>t</code> of type <code>ComplementedLattice ...</code> by <code>{ t with }</code> and that should work fine (if the type is known(?)), so that is barely any overhead, IMO.</p>",
        "id": 530582370,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753368758
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/bug.20with.20quotient.20of.20Z/near/530565053\">said</a>:</p>\n<blockquote>\n<p>With <code>class X extends Y</code> we still get an instance from <code>X</code> to <code>Y</code>. Is this bad?</p>\n</blockquote>\n<p>That direction is fine. In a semi-simple module it's fine if you use that <code>Submodule</code> is a completed lattice. We block the other direction, because it's rare that you are looking for a semi-simple module instance, and you want to find a generic complemented lattice instance. It is much more likely that you only want to try other semi-simple module instances. (Whenever you want to apply a generic complemented lattice instance to semi-simple modules, then that has to now be added as a separate instance.)</p>",
        "id": 530583199,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753369003
    },
    {
        "content": "<p>I also diagnosed the type-class problem from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/grind.20and.20ordered.20ring/with/530593683\">#lean4 &gt; grind and ordered ring</a> (cc <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span>), and identified a few more problematic instances, although the results here are not as clear as they were in the example above.</p>\n<p>I do think we should strive for some better instances hygiene in Mathlib.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">}</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> instances that are not great, since they assume something ordered and conclude</span>\n<span class=\"cm\">something algebraic. It might be annoying to scope them, though... -/</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">IsStrictOrderedRing</span><span class=\"bp\">.</span><span class=\"n\">toCharZero</span>\n<span class=\"w\">  </span><span class=\"n\">instIsAddTorsionFree</span>\n<span class=\"w\">  </span><span class=\"n\">IsStrictOrderedRing</span><span class=\"bp\">.</span><span class=\"n\">noZeroDivisors</span>\n<span class=\"c\">/-</span><span class=\"cm\"> probably fine... -/</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">instNoZeroSMulDivisorsOfIsDomain</span>\n<span class=\"c\">/-</span><span class=\"cm\"> concluding something algebraic from something finite(-dimensional).  -/</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">instIsReflexiveOfFiniteOfProjective</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">free_of_finite_type_torsion_free'</span>\n<span class=\"c\">/-</span><span class=\"cm\"> these instances all conclude something algebraic from finite/subsingleton,</span>\n<span class=\"cm\">and should all be scoped, IMO -/</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">Subsingleton</span><span class=\"bp\">.</span><span class=\"n\">to_noZeroDivisors</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"bp\">.</span><span class=\"n\">of_subsingleton'</span>\n<span class=\"w\">  </span><span class=\"n\">Subsingleton</span><span class=\"bp\">.</span><span class=\"n\">instComplementedLattice</span>\n<span class=\"w\">  </span><span class=\"n\">isArtinian_of_finite</span>\n<span class=\"w\">  </span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">fg_of_finite</span>\n<span class=\"w\">  </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">to_wellQuasiOrderedLE</span>\n<span class=\"w\">  </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">to_wellFoundedLT</span>\n<span class=\"w\">  </span><span class=\"n\">isNoetherian_of_finite</span>\n<span class=\"w\">  </span><span class=\"n\">isNoetherian_of_subsingleton</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">of_finite</span>\n<span class=\"w\">  </span><span class=\"n\">Subsingleton</span><span class=\"bp\">.</span><span class=\"n\">to_isAddTorsionFree</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">FinitePresentation</span><span class=\"bp\">.</span><span class=\"n\">of_subsingleton</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"bp\">.</span><span class=\"n\">of_subsingleton</span>\n<span class=\"c\">/-</span><span class=\"cm\"> not very suspicious, but it's relatively slow by itself,</span>\n<span class=\"cm\">probably when unifying instances -/</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">IsFractionRing</span><span class=\"bp\">.</span><span class=\"n\">instFaithfulSMul</span>\n<span class=\"c\">/-</span><span class=\"cm\"> not great together with `Module.IsNoetherian.finite`. -/</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"kn\">instance</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">isNoetherian_of_isNoetherianRing_of_finite</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">NoNatZeroDivisors</span><span class=\"w\"> </span><span class=\"n\">K</span>\n</code></pre></div>",
        "id": 530602780,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753374777
    },
    {
        "content": "<p>Do we need some <code>class IsTrivial extends Subsingleton</code> as an algebraic version of <code>Subsingleton</code>?</p>",
        "id": 530631655,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1753385202
    },
    {
        "content": "<p>The bench result of <a href=\"https://github.com/leanprover-community/mathlib4/pull/27427\">#27427</a> is out, overall it speeds things up but there are also some files that get a lot slower.</p>",
        "id": 530631776,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1753385241
    },
    {
        "content": "<p>Do we have a documentation entry/library note/docstring that explains and document clearly why such instances are \"bad/not great\"?</p>",
        "id": 530633653,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1753385954
    },
    {
        "content": "<p><code>-- see note [lower instance priority]</code> maybe</p>",
        "id": 530654350,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1753394615
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/stream/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/530631776\">said</a>:</p>\n<blockquote>\n<p>The bench result of <a href=\"https://github.com/leanprover-community/mathlib4/pull/27427\">#27427</a> is out, overall it speeds things up but there are also some files that get a lot slower.</p>\n</blockquote>\n<p>I'm not convinced that any benchmarks are trustworthy at the moment; many changes are in files that are earlier than your diff</p>",
        "id": 530674239,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753406157
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/530654350\">said</a>:</p>\n<blockquote>\n<p><code>-- see note [lower instance priority]</code> maybe</p>\n</blockquote>\n<p>The note is related but I feel like it's not the full story here.</p>\n<p>I think if we're removing or scoping these instances this should come along such a documentation entry so that newcomers/less aware people don't think it's good to turn them back to instances or to make them global.</p>",
        "id": 530703365,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1753425648
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/530312318\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Bundle.instNormedAddCommGroupOfRiemannianBundle#doc\">docs#Bundle.instNormedAddCommGroupOfRiemannianBundle</a> seems really bad: it has a variable as its head symbol, and can therefore unify with any function application. In particular, when trying to find <code>NormedAddCommGroup (ℤ ⧸ Ideal.span {37})</code> it will use <code>E := fun A =&gt; ℤ ⧸ A</code>. This should definitely be scoped.</p>\n</blockquote>\n<p>Scoped in <a href=\"https://github.com/leanprover-community/mathlib4/pull/27462\">#27462</a></p>",
        "id": 530749605,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1753441598
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c\">/-</span><span class=\"cm\"> these instances all conclude something algebraic from finite/subsingleton,</span>\n<span class=\"cm\">and should all be scoped, IMO -/</span>\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span>, do you have ideas about where any of these should be scoped to? <code>Subsingleton</code>? <code>Finite</code>?</p>",
        "id": 531262591,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753671569
    },
    {
        "content": "<p>That's how I would scope them, yes. It might be a bit annoying, but I expect that these instances are not used all that frequently(?)</p>",
        "id": 531317263,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1753694424
    },
    {
        "content": "<p>I think we need them all to be available to the <code>nontriviality</code> tactic</p>",
        "id": 531319055,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1753694934
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/27592\">#27592</a> looks at </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">Subsingleton</span><span class=\"bp\">.</span><span class=\"n\">to_noZeroDivisors</span>\n<span class=\"w\">  </span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Free</span><span class=\"bp\">.</span><span class=\"n\">of_subsingleton'</span>\n<span class=\"w\">  </span><span class=\"n\">Subsingleton</span><span class=\"bp\">.</span><span class=\"n\">instComplementedLattice</span>\n<span class=\"w\">  </span><span class=\"n\">isArtinian_of_finite</span>\n<span class=\"w\">  </span><span class=\"n\">AddMonoid</span><span class=\"bp\">.</span><span class=\"n\">fg_of_finite</span>\n<span class=\"w\">  </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">to_wellQuasiOrderedLE</span>\n<span class=\"w\">  </span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">to_wellFoundedLT</span>\n</code></pre></div>\n<p>either removing them as an instance, or scoping the instance.</p>",
        "id": 531344189,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753702179
    },
    {
        "content": "<p>Sadly this only minimally reduces the heartbeats required for <code>variable (K : Type) [Field K] in #synth Lean.Grind.NoNatZeroDivisors K</code> from 18808 down to 18643.</p>",
        "id": 531347398,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753703206
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/531319055\">said</a>:</p>\n<blockquote>\n<p>I think we need them all to be available to the <code>nontriviality</code> tactic</p>\n</blockquote>\n<p>How does one open a namespace in <code>TacticM</code>?</p>",
        "id": 531348742,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753703640
    },
    {
        "content": "<p>Can we have a scope that contains all things that could be instances but cannot due to loops or bad performances or even diamonds and have something like <code>infer_instance!</code> that opens it locally and suggests a scope to open when it is found?</p>",
        "id": 531387034,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1753713380
    },
    {
        "content": "<p>It's surprising to me that <code>Grind.NoNatZeroDivisors</code> fails so slowly when <code>IsAddTorsionFree</code> fails so quickly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span>\n\n<span class=\"bp\">#</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"c1\">-- 944 ms to fail</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">NoNatZeroDivisors</span><span class=\"w\"> </span><span class=\"n\">K</span>\n\n<span class=\"bp\">#</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"c1\">-- 973 ms to fail</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">NoZeroSMulDivisors</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"n\">K</span>\n\n<span class=\"bp\">#</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"c1\">-- 73 ms to fail</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">IsAddTorsionFree</span><span class=\"w\"> </span><span class=\"n\">K</span>\n</code></pre></div>",
        "id": 531426176,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1753725115
    },
    {
        "content": "<p>They're equivalent to each other under very mild conditions, right?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">NoNatZeroDivisors</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">IsAddTorsionFree</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">constructor</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rintro</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">h</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">constructor</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">rintro</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">h</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">constructor</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"n\">habk</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"n\">habk</span>\n</code></pre></div>",
        "id": 531426303,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1753725158
    },
    {
        "content": "<p>Would it work simply to have only one instance of <code>Lean.Grind.NoNatZeroDivisors</code>, namely from <code>IsAddTorsionFree</code>?</p>",
        "id": 531426478,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1753725214
    },
    {
        "content": "<p>It's worth also considering that, according to the module documentation here: <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/NoZeroSMulDivisors/Defs.html#NoZeroSMulDivisors\">https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/NoZeroSMulDivisors/Defs.html#NoZeroSMulDivisors</a>, our goal will be to remove <code>NoZeroSMulDivisors</code> in favor of something mathematically correct for semimodules.</p>",
        "id": 531428088,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1753725720
    },
    {
        "content": "<p>Does that mean that <code>IsAddTorsionFree K</code> is the \"good way\"?</p>",
        "id": 531428274,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1753725771
    },
    {
        "content": "<p>I would argue \"yes\".</p>",
        "id": 531428354,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1753725793
    },
    {
        "content": "<p>So maybe the really problematic instance here is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instNoNatZeroDivisorsOfNoZeroSMulDivisorsNat#doc\">docs#instNoNatZeroDivisorsOfNoZeroSMulDivisorsNat</a> <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 531428547,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1753725849
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/531428088\">said</a>:</p>\n<blockquote>\n<p>It's worth also considering that, according to the module documentation here: <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/NoZeroSMulDivisors/Defs.html#NoZeroSMulDivisors\">https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/NoZeroSMulDivisors/Defs.html#NoZeroSMulDivisors</a>, our goal will be to remove <code>NoZeroSMulDivisors</code> in favor of something mathematically correct for semimodules.</p>\n</blockquote>\n<p>Ahah, I added this docstring three days ago. I am glad it turns out useful already</p>",
        "id": 531526280,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1753771635
    },
    {
        "content": "<p>Unfortunately replacing <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instNoNatZeroDivisorsOfNoZeroSMulDivisorsNat#doc\">docs#instNoNatZeroDivisorsOfNoZeroSMulDivisorsNat</a> with an instance from <code>IsAddTorsionFree K</code> causes a grind failure in LinearAlgebra/RootSystem/Finite/Lemmas</p>",
        "id": 531543240,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753777088
    },
    {
        "content": "<p>Where can I see that failure?</p>",
        "id": 531543338,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1753777124
    },
    {
        "content": "<p>Let me push a branch.</p>",
        "id": 531543376,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753777140
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/27627\">#27627</a></p>",
        "id": 531543650,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753777232
    },
    {
        "content": "<p>I think the problem is that CommRing + CharZero doesn't give IsAddTorsionFree.</p>",
        "id": 531544324,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753777410
    },
    {
        "content": "<p>perhaps providing that instance will destroy the gains Heather observed above :-(</p>",
        "id": 531544390,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753777427
    },
    {
        "content": "<p>That is strange. You ought to get <code>IsAddTorsionFree</code> from the combination of <code>CharZero</code> and <code>IsDomain</code>.</p>",
        "id": 531658643,
        "sender_full_name": "Scott Carnahan",
        "timestamp": 1753808379
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/531543338\">said</a>:</p>\n<blockquote>\n<p>Where can I see that failure?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>, would you be interested in fixing this?</p>",
        "id": 532048597,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1753961495
    },
    {
        "content": "<p>I added the instance saying a characteristic zero domain has <code>IsAddTorsionFree</code> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/28031\">#28031</a>. It has no effect on the timings above.</p>",
        "id": 533066671,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754474199
    },
    {
        "content": "<p>and <a href=\"https://github.com/leanprover-community/mathlib4/pull/28033\">#28033</a> changes the instances for <code>NoNatZeroDivisors</code> to use this. It drastically speeds up the failing synthesis problem </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">}</span>\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">NoNatZeroDivisors</span><span class=\"w\"> </span><span class=\"n\">K</span>\n</code></pre></div>\n<p>as well as <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span>'s originally reported problem </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">45</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">grind</span>\n</code></pre></div>",
        "id": 533072794,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1754476467
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/532048597\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/type-class.20inference.20slow.2Ftiming.20out/near/531543338\">said</a>:</p>\n<blockquote>\n<p>Where can I see that failure?</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span>, would you be interested in fixing this?</p>\n</blockquote>\n<p>Sorry, I am very behind on everything (although things will get better now that I live in one place). If you want me to do something, please somehow land a notification in my inbox (eg by creating an issue and assigning me to it)</p>",
        "id": 533111238,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1754489123
    }
]