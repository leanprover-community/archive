[
    {
        "content": "<p>I have x in my tactic state.<br>\n<strong>x</strong> : (Fin 2)ᵒᵈ<br>\nfin_cases x produces the following error. </p>\n<hr>\n<p>tactic 'cases' failed, nested error:<br>\nAppBuilder for 'eq_of_heq', heterogeneous equality types are not definitionally equal<br>\n  List (Fin 2)<br>\nis not definitionally equal to<br>\n  List (Fin 2)ᵒᵈ</p>\n<hr>\n<p>Here is <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOJgCmAdnAPJQAmhUAIgK5Lo4oxTb0yFwDa6EAYyZxgUKIUr0B2dIQC65KjQZM81AGZwkcAFxwAYsFIAmOICTCOACEIEdLoC8cAIQ829QgBo46pgGd5OBpwWLpwABSGJgCUgEq4gBK45lY2djqOLj7o/l5u8nBwgBhEcBDqKsw4hAAeSOCyodqFkQB04gBuFNRQAJK+EHmOwXmpwQCeOHmV8BVj3kYA+kL+vnAVcAA8ANwAfHBQ6sxAA\">mwe</a>.</p>",
        "id": 476603556,
        "sender_full_name": "Sorrachai Yingchareonthawornchai",
        "timestamp": 1728823440
    },
    {
        "content": "<p>To clarify, I have told Sorrachai to add <code>attribute [local irreducible] OrderDual</code> at the top of his file so that he could learn not to confuse <code>α</code> with <code>αᵒᵈ</code>. However, it seems that <code>fin_cases</code> was never taught the same!</p>",
        "id": 476603756,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728823605
    },
    {
        "content": "<p>But a priori <code>fin_cases</code> shouldn't work for <code>x : (Fin 2)ᵒᵈ</code> and only for <code>x : Fin 2</code> so you should first replace <code>x</code> with <code>y.toDual</code> for some <code>y</code> by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">obtain</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">OrderDual</span><span class=\"bp\">.</span><span class=\"n\">toDual</span><span class=\"bp\">.</span><span class=\"n\">surjective</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 476608993,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1728828434
    },
    {
        "content": "<p>The underlying problem might be that the <code>Fintype</code> instance on <code>OrderDual</code> somehow abuses the defeq.</p>",
        "id": 476609102,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1728828541
    },
    {
        "content": "<p>From the docstring of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Tactic.finCases#doc\">docs#Lean.Elab.Tactic.finCases</a> :</p>\n<blockquote>\n<p><code>fin_cases h</code> performs case analysis on a hypothesis of the form<br>\n<code>h : A</code>, where <code>[Fintype A]</code> is available</p>\n</blockquote>",
        "id": 476609136,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728828589
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/stream/287929-mathlib4/topic/OrderDual.20and.20fin_cases/near/476609102\">said</a>:</p>\n<blockquote>\n<p>The underlying problem might be that the <code>Fintype</code> instance on <code>OrderDual</code> somehow abuses the defeq.</p>\n</blockquote>\n<p>This looks very incompatible with <code>attribute [local irreducible] OrderDual</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">OrderDual</span><span class=\"bp\">.</span><span class=\"n\">fintype</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">ᵒᵈ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‹</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">›</span>\n</code></pre></div>",
        "id": 476609608,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1728828968
    },
    {
        "content": "<p>Are you saying <code>fin_cases</code> literally unfolds the fintype instance?</p>",
        "id": 476609664,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728829050
    },
    {
        "content": "<p>My mental model of <code>Fintype X</code> is just an <code>e : Fin n ≃ X</code> and to my understanding <code>fin_cases x</code> replaces <code>x</code> with <code>e i</code> for each <code>i</code>.<br>\nBut here the <code>e</code> has the wrong type because of the irreducibility.<br>\nAt least this is what appears to me to have happened.</p>",
        "id": 476609913,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1728829265
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/OrderDual.20and.20fin_cases/near/476609664\">said</a>:</p>\n<blockquote>\n<p>Are you saying <code>fin_cases</code> literally unfolds the fintype instance?</p>\n</blockquote>\n<p>Yes, this is precisely what happens</p>",
        "id": 476625691,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728843180
    },
    {
        "content": "<p>Okay, sounds a bit dangerous precisely because of type synonyms</p>",
        "id": 476628063,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728845322
    },
    {
        "content": "<p>It sounds like <code>OrderDual.fintype</code> is the problem here: it should respect the distinction and use the equivalence <code>αᵒᵈ ≃ α</code></p>",
        "id": 476744136,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1728901632
    },
    {
        "content": "<p>I'd argue that  the way <code>fin_cases</code> just reduces things to a constructor is probably not the right approach either</p>",
        "id": 476744436,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728901714
    },
    {
        "content": "<p>I think this results in it using <code>Fin.mk</code> expressions for the elements of <code>ZMod n</code> rather than numeric literals</p>",
        "id": 476744553,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728901746
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/OrderDual.20and.20fin_cases/near/476744136\">said</a>:</p>\n<blockquote>\n<p>it should respect the distinction and use the equivalence <code>αᵒᵈ ≃ α</code></p>\n</blockquote>\n<p>I am willing to try making it respect it, but the problem is that <code>Finset.map_id</code> is not defeq, so it might break lemmas that are dualised through the equality of all operations on <code>αᵒᵈ</code> with the ones on `α</p>",
        "id": 476744567,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728901750
    },
    {
        "content": "<p>My proposed alternative would be a typeclass system something like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">autoImplicit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">FinCasesImpl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">qu</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">qα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">qu</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">inst</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">qα</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">elems</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">({</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">qα</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">Nodup</span><span class=\"o\">})</span>\n<span class=\"w\">  </span><span class=\"n\">helems</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">⟦</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">elems</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"bp\">⟧</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">FinCasesImpl</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">inferInstance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">elems</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"o\">[</span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"bp\">⟩</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">helems</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 476746156,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728902163
    },
    {
        "content": "<p>This also lets you choose the order of the cases that <code>fin_cases</code> emits</p>",
        "id": 476746458,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728902261
    }
]