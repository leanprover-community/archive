[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">Magma</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span>\n\n<span class=\"kn\">infix</span><span class=\"o\">:</span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"s2\">\" ∘ \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Magma</span><span class=\"bp\">.</span><span class=\"n\">op</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Equation1689</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Magma</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Equation2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Magma</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Equation1689_implies_Equation2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Magma</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equation1689</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Equation2</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h9</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span>\n<span class=\"w\">    </span><span class=\"k\">calc</span>\n<span class=\"w\">      </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">      </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- profiler reports:</span>\n<span class=\"c1\">-- [Elab.command] [1.489524] theorem Equation1689_implies_Equation2 ...</span>\n\n<span class=\"c1\">-- If I comment out `import Mathlib.tactic`, then the profiler reports:</span>\n<span class=\"c1\">-- [Elab.command] [0.135244] theorem Equation1689_implies_Equation2 ...</span>\n</code></pre></div>",
        "id": 474673476,
        "sender_full_name": "David Renshaw",
        "timestamp": 1727986165
    },
    {
        "content": "<p>oh... I think this is due to the <code>∘</code> syntax</p>",
        "id": 474674114,
        "sender_full_name": "David Renshaw",
        "timestamp": 1727986287
    },
    {
        "content": "<p>and already noted here: <a href=\"#narrow/stream/458659-Equational/topic/Symbol.20for.20.60Magma.2Eop.60/near/474069724\">https://leanprover.zulipchat.com/#narrow/stream/458659-Equational/topic/Symbol.20for.20.60Magma.2Eop.60/near/474069724</a></p>",
        "id": 474674425,
        "sender_full_name": "David Renshaw",
        "timestamp": 1727986354
    },
    {
        "content": "<p>Function.comp syntax is in core, right?</p>",
        "id": 475023980,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728163434
    },
    {
        "content": "<p>I think with Mathlib it has to search a lot more before it figures out that it isn't a function</p>",
        "id": 475048976,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1728188023
    },
    {
        "content": "<p>Maybe mathlib adds a bunch of typeclasses on Function.comp and that somehow slows things down?</p>",
        "id": 475049192,
        "sender_full_name": "David Renshaw",
        "timestamp": 1728188214
    },
    {
        "content": "<p>Mathlib adds a bunch of instances for <code>CoeFun</code></p>",
        "id": 475056437,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728191316
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=DFunLike#doc\">docs#DFunLike</a></p>",
        "id": 475056456,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728191326
    },
    {
        "content": "<p>They should be discarded by the discrimination tree, unless we forgot to migrate some <code>[**HomClass]</code> to a mixin.</p>",
        "id": 475056674,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728191415
    },
    {
        "content": "<p>Can you make it print which instance(s) it tries?</p>",
        "id": 475056731,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728191479
    },
    {
        "content": "<p>The ones from Mathlib, as far as I can tell, are:</p>\n<ul>\n<li>SetLike.instCoeSortType</li>\n<li>DFunLike.hasCoeToFun</li>\n<li>EquivLike.toFunLike</li>\n<li>StarRingEquivClass.instCoeHead</li>\n<li>SemilinearEquivClass.instCoeToSemilinearEquiv</li>\n<li>LinearMapClass.instCoeToLinearMap</li>\n<li>EquivLike.toFunLike</li>\n<li>SemilinearMapClass.instCoeToSemilinearMap</li>\n<li>NonUnitalStarRingHomClass.instCoeHeadNonUnitalStarRingHom</li>\n<li>StarAlgEquivClass.instCoeHead</li>\n<li>Pi.instNatCast</li>\n</ul>",
        "id": 475059112,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1728193345
    },
    {
        "content": "<p>Probably, we should fix our instances like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=StarRingEquivClass.instCoeHead#doc\">docs#StarRingEquivClass.instCoeHead</a></p>",
        "id": 475059385,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728193494
    },
    {
        "content": "<p>It tries to use it to turn <code>a</code> into a <code>StartRingEquiv</code>, then coerce to a function.</p>",
        "id": 475059458,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728193527
    },
    {
        "content": "<p>Some other classes like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MonoidHom#doc\">docs#MonoidHom</a> use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CoeTC#doc\">docs#CoeTC</a> for similar coercions. Can you change the <code>*Class</code> instances you see here to use <code>CoeTC</code>, rebuild Mathlib, and try again?</p>",
        "id": 475059959,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1728194102
    },
    {
        "content": "<p>I think when I look at it it wasn't type classes, but simply the fact that every circ could be one or the other operation, and it's trying one first until it fails, and then the other, so I assumed that due to nested occurrences, thats blows up exponentially</p>",
        "id": 475077280,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1728205420
    }
]