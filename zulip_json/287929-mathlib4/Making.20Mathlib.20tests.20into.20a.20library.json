[
    {
        "content": "<p>I would like to convert Mathlib's tests to a lake library. This means:</p>\n<ul>\n<li>we don't need to depend on the ad-hoc test runner I implemented in Batteries</li>\n<li>it is possible for Mathlib tests to import other files from Mathlib tests (e.g. so it is possible to properly test <code>linter.minImports</code>)</li>\n</ul>\n<p>I created <a href=\"https://github.com/leanprover-community/mathlib4/pull/18304\">#18304</a> to attempt this, but <code>lake build MathlibTests</code> then runs with all the Mathlib linters, despite me not asking for them in </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_lib</span><span class=\"w\"> </span><span class=\"n\">MathlibTest</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">globs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">submodules</span><span class=\"w\"> </span><span class=\"ss\">`MathlibTest</span><span class=\"o\">]</span>\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, or anyone else who knows <code>lake</code> well enough, ... Could I please have some assistance here?</p>",
        "id": 479172235,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730070141
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> The mathlib linters are set globally (as weak options) on the <code>package</code> <a href=\"https://github.com/leanprover-community/mathlib4/blob/2061d034b2e163f02fdbe7c36548662355406fee/lakefile.lean#L45-L52\">declaration</a>.</p>",
        "id": 479172373,
        "sender_full_name": "Mac Malone",
        "timestamp": 1730070289
    },
    {
        "content": "<p>Can I turn them off again?</p>",
        "id": 479172395,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730070311
    },
    {
        "content": "<p>Lake does not provide a way to subtract options, so they would have to be individual set (or not set) on the each target.</p>",
        "id": 479172508,
        "sender_full_name": "Mac Malone",
        "timestamp": 1730070395
    },
    {
        "content": "<p>Would having an extra <code>linter.test</code> option set that enables/disables all linters when you are in a <code>test.something</code> file help?</p>",
        "id": 479172982,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730070878
    },
    {
        "content": "<p>Each linter would then use the combination of its own option and this \"global test\" option to decide whether to run or not.</p>",
        "id": 479173009,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730070908
    },
    {
        "content": "<p>Okay, I will just move those options from the package to the <code>lean_lib Mathlib</code>, so they don't affect the tests.</p>",
        "id": 479174631,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730072496
    },
    {
        "content": "<p>Okay, that works fine.</p>",
        "id": 479174839,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730072668
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"313038\">@Moritz Firsching</span> and <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, I don't understand the (now failing) test </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- info: [termG, termG] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">consts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">toList</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">getRoot</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">`termG</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">reps</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">consts</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"m\">1</span><span class=\"bp\">.</span><span class=\"n\">components</span><span class=\"bp\">.</span><span class=\"n\">take</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"n\">default</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{reps}\"</span>\n<span class=\"w\">  </span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">reps</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">reps</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"o\">)</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">termG</span>\n</code></pre></div>\n<p>in <code>MathlibTest/Lint.lean</code>, which was added in <a href=\"https://github.com/leanprover-community/mathlib4/pull/17631\">#17631</a>.</p>\n<p>Would one of you mind looking at it on the <code>test_lib</code> branch, and doing some combination of fixing it / documenting what it is actually testing / explaining to me?</p>",
        "id": 479174907,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730072757
    },
    {
        "content": "<p>I'll take a look now.  The test was a little hack: I wanted to make sure that \"auto-generated\" names with a repeated namespace would get caught by the linter.  So, I used a <code>term...</code> autogenerated name: since these added <code>term</code> automatically, I rigged the namespace to contain a <code>termG</code> repetition.</p>",
        "id": 479175109,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730072938
    },
    {
        "content": "<p>It looks like the heuristics for the auto-generated name depend on the path... Probably it is easiest to remove the test: I was not too convinced by it to begin with.</p>",
        "id": 479175338,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730073178
    },
    {
        "content": "<p>If we would like to merge this, I would appreciate a speedy review. This PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/18304\">#18304</a> will rot quickly, and every time we need to merge it is a rebuild from scratch because we touch the lakefile.</p>",
        "id": 479415827,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730187087
    },
    {
        "content": "<p>I personally like the idea of having a separate test library!</p>",
        "id": 479416357,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730187346
    },
    {
        "content": "<p>I don't think there's any opposition. The PR just needs a review for me being dumb. :-)</p>",
        "id": 479416506,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730187409
    },
    {
        "content": "<p>Ah, ok, let me look at it again!  I was surprised that not more linters required changes: I thought that some of them inspected whether the root of the module name was <code>test</code> or not.</p>",
        "id": 479416633,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730187466
    },
    {
        "content": "<p>Was the <code>MathlibTest.lean</code> file generated by <code>mk_all</code>?</p>",
        "id": 479416758,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730187516
    },
    {
        "content": "<p>Yes</p>",
        "id": 479416779,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730187530
    },
    {
        "content": "<p>For me, the main test will be to see the PR pass CI.</p>",
        "id": 479417570,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730187876
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Making.20Mathlib.20tests.20into.20a.20library/near/479416633\">said</a>:</p>\n<blockquote>\n<p>Ah, ok, let me look at it again!  I was surprised that not more linters required changes: I thought that some of them inspected whether the root of the module name was <code>test</code> or not.</p>\n</blockquote>\n<p>I think that <code>HashCommandLinter</code> looks at the path to decide whether to run or not.  I can switch that to a separate option or just perpetrate the hack by renaming the root of the path.</p>",
        "id": 479421050,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730189242
    },
    {
        "content": "<p>There are also a few comments in <code>Mathlib</code> that refer to <code>test/...</code>.  I found them with</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git<span class=\"w\"> </span>grep<span class=\"w\"> </span><span class=\"s1\">'`test\\b[^ ]'</span><span class=\"w\"> </span>Mathlib/*\n</code></pre></div>",
        "id": 479421281,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730189320
    },
    {
        "content": "<p>(If you prefer, I can push those renames directly to the branch.)</p>",
        "id": 479421754,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730189501
    },
    {
        "content": "<p>Actually, I just tested the new setup and the linters appear to be automatically disabled in <code>MathlibTest</code>, and they have to be explicitly opted in to view their reports.  This means that the <code>HashCommandLinter</code> hack can simply be removed and nothing should break.</p>",
        "id": 479423034,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730189958
    },
    {
        "content": "<p>The current test error seems to be an <code>inductive C</code> defined in both <code>MathlibTest/DeriveFintype.lean</code> and <code>MathlibTest/DeriveToExpr.lean</code>.</p>",
        "id": 479423517,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730190127
    },
    {
        "content": "<p>What's the benefit of having MathlibTest.lean?</p>",
        "id": 479430804,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1730192600
    },
    {
        "content": "<p>Do you mean as opposed to using a glob? We need one or the other, and given we don't use globs for Mathlib, I assumed we wouldn't want to here either.</p>",
        "id": 479442520,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730196523
    },
    {
        "content": "<p>Just fixed another round of merge conflicts.</p>",
        "id": 479586045,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730247468
    },
    {
        "content": "<p>I've switched back to using globs, so that name collisions in the test files are allowed.</p>",
        "id": 479596408,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730255099
    }
]