[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> I'll continue here from <a href=\"https://github.com/leanprover-community/mathlib4/pull/21195\">#21195</a> (and <a href=\"https://github.com/leanprover-community/mathlib4/pull/20568\">#20568</a>) since this feels more natural to discuss.</p>\n<p>(for context, I want <code>lake exe cache get MyProject.lean</code> to download only the relevant part of the Mathlib cache and both PRs do something in that direction)</p>\n<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>  re the suggested cleanups from <a href=\"https://github.com/leanprover-community/mathlib4/pull/8767\">#8767</a>, the main hack comes from what's still in this PR:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"c1\">-- TODO this should be generated automatically from the information in `lakefile.lean`.</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"Mathlib\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"Archive\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"o\">),</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"s2\">\"Counterexamples\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n</code></pre></div>\n<p>because I do not know any way to get the currently available libs (\"Mathlib\", \"MyProject\", \"Archive\", etc.) or default-targets from lake... you can get stuff written in the manifest from </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lake</span><span class=\"bp\">.</span><span class=\"n\">Manifest</span><span class=\"bp\">.</span><span class=\"n\">load?</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"s2\">\"lake-manifest.json\"</span><span class=\"bp\">⟩</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n</code></pre></div>\n<p>but that only tells you the names like <code>leanprover-community/mathlib</code>. Do you know of a way to access the lake workspace or reparse the lakefile?</p>",
        "id": 496440865,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738106632
    },
    {
        "content": "<p>I wonder if we could use the Lean search path instead of trying to parse the lake metadata</p>",
        "id": 496442142,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738107298
    },
    {
        "content": "<p>I no longer remember why we need this data in the first place; isn't knowing the module name and the file it came from enough? Why do we care which folder it is in?</p>",
        "id": 496442204,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738107339
    },
    {
        "content": "<p>where do I start looking at that, I've never looked at the search path?</p>\n<p>I think the <code>cache</code> does a simple filter where it filters module names <code>Mathlib.X.Y</code> by its prefix <code>Mathlib</code> to decide which library it belongs to. maybe that can be done otherwise</p>",
        "id": 496442503,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738107516
    },
    {
        "content": "<p>one place you can get the search path is through the <code>LEAN_PATH</code> environment variable, which I believe <code>lake</code> sets</p>",
        "id": 496442761,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738107661
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getEnv</span><span class=\"w\"> </span><span class=\"s2\">\"LEAN_PATH\"</span>\n</code></pre></div>\n<p>does give something <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 496443035,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738107831
    },
    {
        "content": "<p>Right, the question is whether it is set in <code>exe cache</code></p>",
        "id": 496443145,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738107892
    },
    {
        "content": "<p>What you actually want is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.addSearchPathFromEnv#doc\">docs#Lean.addSearchPathFromEnv</a> which does the parsing for you</p>",
        "id": 496443169,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738107904
    },
    {
        "content": "<p>I tested it and it seems to work</p>",
        "id": 496443785,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738108227
    },
    {
        "content": "<p>Ah and I think <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.findLean#doc\">docs#Lean.findLean</a> is very informative on how to do this properly, this gives a mapping <code>\"module name\" --&gt; filePath</code></p>",
        "id": 496445316,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738109004
    },
    {
        "content": "<p>(<a href=\"https://github.com/leanprover/lean4/blob/7e8af0fc9d28069ef7c61fea47790f9c40917119/src/Lean/Util/Path.lean#L119-L126\">Lean.findLean</a>)</p>",
        "id": 496445560,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738109139
    },
    {
        "content": "<p>I do not know if this will help, but <code>scripts/mk_all.lean</code> contains the function <code>getLeanLibs</code> that returns all the libraries on which the current project depends.</p>",
        "id": 496445942,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738109375
    },
    {
        "content": "<p><code>mk_all</code> uses this to generate <code>Archive.lean</code> and <code>Counterexamples.lean</code> (or rather, to \"know\" that <code>Archive</code> and <code>Counterexamples</code> exist).</p>",
        "id": 496446039,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738109418
    },
    {
        "content": "<p>That is indeed huge :D May or may not be needed for the cache, but regardless I've certainly wished for a tutorial to get a <code>Lake.Workspace</code> in a script, thanks! I'll try these things out tomorrow</p>",
        "id": 496446399,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738109662
    },
    {
        "content": "<p>I had asked about this on Zulip when working on <code>mk_all</code> and then a combination of Mac, Mario and Kim wrote that function and bumped it when it stopped working.</p>",
        "id": 496446477,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738109720
    },
    {
        "content": "<p>The conclusion should be: it works, but I do not know why... <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 496446502,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738109737
    },
    {
        "content": "<p>If you search \"getLeanLibs\" on Zulip you get a few hits, but all pertinent.</p>",
        "id": 496446734,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738109886
    },
    {
        "content": "<p>While I'm on it, would it be a bad idea to change the syntax for cache to <code>lake exe cache get Mathlib.Algebra.Field</code>?</p>\n<p>(instead of the current <code>lake exe cache get Mathlib/Algebra/Field/*.lean</code>)</p>",
        "id": 496501304,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738142161
    },
    {
        "content": "<p>I would rather it accepted both.</p>",
        "id": 496501504,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738142225
    },
    {
        "content": "<p>From the command-line it is very convenient to use auto completion and you only get that with paths.</p>",
        "id": 496501598,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738142263
    },
    {
        "content": "<p>Right now these fail:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">perf</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">AlgebraicGeometry</span><span class=\"bp\">.</span><span class=\"n\">ProjectiveSpectrum</span><span class=\"bp\">.</span><span class=\"n\">Proper</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">AlgebraicGeometry</span><span class=\"bp\">/</span><span class=\"n\">ProjectiveSpectrum</span><span class=\"bp\">/</span><span class=\"n\">Proper</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n</code></pre></div>\n<p>and these succeed:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">perf</span><span class=\"w\"> </span><span class=\"n\">stat</span><span class=\"w\"> </span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">AlgebraicGeometry</span><span class=\"bp\">/</span><span class=\"n\">ProjectiveSpectrum</span><span class=\"bp\">/</span><span class=\"n\">Proper</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">AlgebraicGeometry</span><span class=\"bp\">.</span><span class=\"n\">ProjectiveSpectrum</span><span class=\"bp\">.</span><span class=\"n\">Proper</span>\n</code></pre></div>",
        "id": 496504477,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738143211
    },
    {
        "content": "<p>I would consider it a great improvement if you could <em>always</em> use the path, even in <code>import ...</code> statements!</p>",
        "id": 496505545,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738143571
    },
    {
        "content": "<p>I have my own function so that <code>lb xxx</code> does <code>lake build</code> and then converts <code>xxx</code> to whatever the right format is.</p>",
        "id": 496505843,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738143642
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"ch\">#!/usr/bin/env bash</span>\n\n<span class=\"nb\">set</span><span class=\"w\"> </span>-euo<span class=\"w\"> </span>pipefail\n\n<span class=\"c1\"># Replace every '/' with '.'</span>\n<span class=\"nv\">modified_args</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"si\">${</span><span class=\"p\">@//</span><span class=\"se\">\\/</span><span class=\"p\">/.</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n\n<span class=\"c1\"># Remove every '.lean' suffix</span>\n<span class=\"nv\">modified_args</span><span class=\"o\">=</span><span class=\"s2\">\"</span><span class=\"si\">${</span><span class=\"nv\">modified_args</span><span class=\"p\">//.lean/</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n\n<span class=\"c1\"># Call 'lake' with the modified arguments</span>\nlake<span class=\"w\"> </span><span class=\"nv\">$modified_args</span>\n</code></pre></div>",
        "id": 496507176,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1738144078
    },
    {
        "content": "<p>This is <a href=\"https://github.com/leanprover-community/mathlib4/pull/2756\">#2756</a>. It's on <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>'s radar still, I hope.</p>",
        "id": 496515690,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738146661
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/2756\">lean4#2756</a></p>",
        "id": 496544278,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1738156126
    },
    {
        "content": "<p>A prototype is here now <a href=\"https://github.com/leanprover-community/mathlib4/pull/21238\">#21238</a> and while it works fine locally and downloads cache as expected, <del>in CI it looks like it does not find the cache files. If there are CI wizards who know how to investigate here, I would appreciate the help. It might just be something with relative paths</del></p>",
        "id": 496818665,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738254506
    }
]