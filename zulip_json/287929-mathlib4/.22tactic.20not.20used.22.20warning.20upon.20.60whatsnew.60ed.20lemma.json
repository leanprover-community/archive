[
    {
        "content": "<p>In <a href=\"https://leanprover-community.github.io/mathematics_in_lean/C08_Hierarchies.html#basics:~:text=In%20order%20to%20check%20the%20name%20of%20this%20additive%20version%20we%20used%20the%20whatsnew%20in%20command\">MIL C08S01</a>, for the following snippet</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">left_inv_eq_right_inv'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monoid₃</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hba</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hac</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">one_mul</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">hba</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_assoc₃</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hac</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_one</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and putting the cursor after the <code>by</code>, the <a href=\"/user_uploads/3121/M3SDYmHZtOm6_k8dadA0574U/QQ20250916162313.png\">infoview</a> fails to display the goal, and complains that the proof is never used. Is this due to <code>whatsnew</code> or <code>to_additive</code>?</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/M3SDYmHZtOm6_k8dadA0574U/QQ20250916162313.png\" title=\"infoview\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2560x1371\" src=\"/user_uploads/thumbnail/3121/M3SDYmHZtOm6_k8dadA0574U/QQ20250916162313.png/840x560.webp\"></a></div>",
        "id": 539710094,
        "sender_full_name": "Gravifer",
        "timestamp": 1758010960
    },
    {
        "content": "<p>You can try removing <code>@[to_additive]</code> and see what happens. My guess is that the same warning will still be there.</p>",
        "id": 539711109,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758011276
    },
    {
        "content": "<p>Probably <code>whatsnew</code>, yeah</p>",
        "id": 539711137,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758011287
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/RHzTLfxYRCrwCMkcPZPTYX8r/QQ20250916162943.png\">Confirmed</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/RHzTLfxYRCrwCMkcPZPTYX8r/QQ20250916162943.png\" title=\"Confirmed\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1593x955\" src=\"/user_uploads/thumbnail/3121/RHzTLfxYRCrwCMkcPZPTYX8r/QQ20250916162943.png/840x560.webp\"></a></div><p>I went through the <a href=\"https://github.com/leanprover-community/mathlib4/blob/24d8de9da5cf8a1a39a8e7f618548973e4bbe75d/Mathlib/Util/WhatsNew.lean\"><code>WhatsNew.lean</code></a> but still have no clue why</p>",
        "id": 539712005,
        "sender_full_name": "Gravifer",
        "timestamp": 1758011548
    },
    {
        "content": "<p>It must be <code>whatsnew</code> doing something funny. But this shouldn't be an issue, because in the final code you don't need to have <code>whatsnew</code>, right?</p>",
        "id": 539712307,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758011648
    },
    {
        "content": "<p>True, though this is not a production project of mine. I'm going through the <em>Mathematics in Lean</em> tutorial; I only have a very limited idea of lean metaprogramming at this point, so I was worried whether there is some deeper issue here</p>",
        "id": 539712651,
        "sender_full_name": "Gravifer",
        "timestamp": 1758011770
    },
    {
        "content": "<p>I think it's related to async elaboration</p>",
        "id": 539713354,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758011995
    },
    {
        "content": "<p>Would you mind to elaborate? I expect the language server is doing a lot of async work behind the scenes, but I don't know where to begin reading about it. Perhaps you can give me some pointers?</p>",
        "id": 539714060,
        "sender_full_name": "Gravifer",
        "timestamp": 1758012247
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span> means that if you write <code>set_option Elab.async false</code> somewhere above it in the lean file, then the weird error will disappear. But I would suggest that you just ignore the warning.</p>",
        "id": 539714574,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758012432
    },
    {
        "content": "<p>Yeah. I'm not finding it now, but some other thing caused similar warnings. Maybe count_heartbeats?</p>",
        "id": 539714748,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758012492
    },
    {
        "content": "<p>Yes, <code>count_heartbeats</code> recently stopped working without the <code>set_option Elab.async false</code> option.</p>",
        "id": 539715050,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758012584
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span><a href=\"#narrow/channel/287929-mathlib4/topic/.22tactic.20not.20used.22.20warning.20upon.20.60to_additive.60.20lemma/near/539714574\"> : </a></p>\n<blockquote>\n<p>if you write <code>set_option Elab.async false</code> somewhere above it in the lean file, then the weird error will disappear</p>\n</blockquote>\n<p><a href=\"/user_uploads/3121/Vp3E5eSDDnW5KFbML_WRk5zM/QQ20250916164944.png\">Indeed</a>. Thanks!</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Vp3E5eSDDnW5KFbML_WRk5zM/QQ20250916164944.png\" title=\"Indeed\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1685x754\" src=\"/user_uploads/thumbnail/3121/Vp3E5eSDDnW5KFbML_WRk5zM/QQ20250916164944.png/840x560.webp\"></a></div><p>This of course doesn't hinder me from proceeding with the tutorial, but I also appreciate this as an opportunity to see the mechanisms of Lean. I'll try to find out more to understand it ; D</p>",
        "id": 539715852,
        "sender_full_name": "Gravifer",
        "timestamp": 1758012847
    },
    {
        "content": "<p>This is unintended behaviour that should be fixed. I wonder if the fix should be made in <code>whatsnew</code>, or in the unused tactic linter.</p>",
        "id": 539716324,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758013018
    },
    {
        "content": "<p>Here's a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> of the issue (cc <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">-- this option fixes the issue:</span>\n<span class=\"c1\">-- set_option Elab.async false</span>\n\n<span class=\"n\">whatsnew</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- unreachabeTactic and unusedTactic linters trigger here</span>\n</code></pre></div>",
        "id": 539718214,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758013603
    },
    {
        "content": "<p>It seems worth filing an issue somewhere. Where do the linter / <code>whatsnew</code> live?</p>",
        "id": 539718577,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758013717
    },
    {
        "content": "<ul>\n<li><code>whatsnew</code> at <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Util/WhatsNew.lean\"><code>org:eanprover-community  mathlib4/Mathlib/Util/WhatsNew.lean</code></a></li>\n<li><code>linter.</code> at <a href=\"https://github.com/leanprover-community/batteries/blob/main/Batteries/Linter/UnreachableTactic.lean\"><code>org: leanprover-community  batteries/Batteries/Linter/UnreachableTactic.lean</code></a> <br>\n    　　(and I just found out that it's not in mathlib)</li>\n</ul>\n<p>I don't know where the issue should go though</p>",
        "id": 539719740,
        "sender_full_name": "Gravifer",
        "timestamp": 1758014063
    },
    {
        "content": "<p>Mathlib, it's the highest up</p>",
        "id": 539720453,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758014287
    },
    {
        "content": "<p>I beg to differ. Here's a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> with just <code>import Batteries</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"mywhatsnew \"</span><span class=\"w\"> </span><span class=\"s2\">\"in\"</span><span class=\"w\"> </span><span class=\"n\">ppLine</span><span class=\"w\"> </span><span class=\"n\">cmd</span><span class=\"o\">:</span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"n\">cmd</span>\n<span class=\"w\">  </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">()</span>\n\n<span class=\"n\">mywhatsnew</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- unreachabeTactic linters trigger here</span>\n</code></pre></div>",
        "id": 539723128,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758015136
    },
    {
        "content": "<p>Okay, <em>now</em> you can do batteries :)</p>",
        "id": 539723983,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1758015410
    },
    {
        "content": "<p>I looked a bit deeper, and the issue is in the implementation of <code>liftCoreM</code>. It (for no reason) resets the <code>infoState.lazyAssignment</code> state, which causes the trouble.</p>",
        "id": 539726059,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758016118
    },
    {
        "content": "<p>Oh, right, I found this just now<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/Linter/UnusedTactic.lean\"><code>org:eanprover-community mathlib4/Mathlib/Tactic/Linter/UnusedTactic.lean</code></a><br>\nwhich seems to be an extended clone of <code>UnreachableTactic.lean</code></p>\n<p><a href=\"/user_uploads/3121/jKNfAWSvbln_2FWuNw0_6_f2/QQ20250916174807.png\">(both complained, actually )</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/jKNfAWSvbln_2FWuNw0_6_f2/QQ20250916174807.png\" title=\"(both complained, actually )\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2560x1371\" src=\"/user_uploads/thumbnail/3121/jKNfAWSvbln_2FWuNw0_6_f2/QQ20250916174807.png/840x560.webp\"></a></div>",
        "id": 539726250,
        "sender_full_name": "Gravifer",
        "timestamp": 1758016185
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> thanks for debugging this!  It does look like it is an issue with <code>liftCoreM</code>, rather than the two linters.</p>",
        "id": 539727048,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758016439
    },
    {
        "content": "<p>Btw, the implementation of the <code>unusedTactic</code> linter was <em>heavily</em> inspired by the implementation of the <code>unreachableTactic</code>, so it is expected that they share similar bugs.</p>",
        "id": 539727195,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758016489
    },
    {
        "content": "<p>If anything, the <code>unusedTactic</code> linter may have more, introduced by me!  <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 539727271,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758016511
    },
    {
        "content": "<p>Also, Jovan, what made you suspect that <code>liftCoreM</code> was involved?  If I had started looking into the issue, it would have taken me quite some time before I realised that the issue not in the linter itself...</p>",
        "id": 539727989,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758016753
    },
    {
        "content": "<p>I put the original MWE inside the file where <code>whatsnew</code> is defined, and then tried to remove parts of the implementation, seeing when the MWE still did and did not show the warning, until I found that removing/adding <code>liftCoreM</code> was the culprit.</p>",
        "id": 539728428,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758016897
    },
    {
        "content": "<p>Great detective work!</p>",
        "id": 539728855,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017058
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/blob/919e297292280cdb27598edd4e03437be5850221/src/Lean/Elab/Command.lean#L211-L212\">implementation of <code>liftCoreM</code></a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandElabM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">MonadExcept</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">runCore</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">observing</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>Looks like the fix won't be an obvious one</p>",
        "id": 539729089,
        "sender_full_name": "Gravifer",
        "timestamp": 1758017136
    },
    {
        "content": "<p>The problem is in <code>runCore</code>, which is defined a few lines up.</p>",
        "id": 539729165,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758017160
    },
    {
        "content": "<p>To see where the issue is, I copied the implementation of <code>liftCoreM</code> and <code>runCore</code>, and again removed stuff until the MWE stopped working. That's how I found that the issue is in <code>infoState.lazyAssignment</code></p>",
        "id": 539729382,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758017243
    },
    {
        "content": "<p>Ah, I see</p>",
        "id": 539729384,
        "sender_full_name": "Gravifer",
        "timestamp": 1758017243
    },
    {
        "content": "<p>There is a comment in <code>runCoreM</code> precisely about <code>lazyAssignment</code>.  Maybe, the \"assumption\" is not always satisfied.</p>",
        "id": 539729597,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017324
    },
    {
        "content": "<p>I am looking at</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"c1\">-- we assume substitution of `assignment` has already happened, but for lazy assignments we only</span>\n<span class=\"w\">    </span><span class=\"c1\">-- do it at the very end</span>\n<span class=\"w\">    </span><span class=\"n\">infoState</span><span class=\"bp\">.</span><span class=\"n\">lazyAssignment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">coreS</span><span class=\"bp\">.</span><span class=\"n\">infoState</span><span class=\"bp\">.</span><span class=\"n\">lazyAssignment</span>\n</code></pre></div>",
        "id": 539729641,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017341
    },
    {
        "content": "<p>Yes, I don't quite get what the comment is saying, but in the case of <code>runCoreM (pure ())</code>, this is resetting the <code>infoState.lazyAssignment</code>, which seems clearly wrong</p>",
        "id": 539729860,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758017422
    },
    {
        "content": "<p>This was introduced in <a href=\"https://github.com/leanprover/lean4/commit/96f9ee2a41e7e77ef011009107f5f3671d8a0d6c\">96f9ee2</a></p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/Lean/Elab/Command.lean b/src/Lean/Elab/Command.lean</span>\n<span class=\"gh\">index aeb0b820e30c..e83c3f4d1ed8 100644</span>\n<span class=\"gd\">--- a/src/Lean/Elab/Command.lean</span>\n<span class=\"gi\">+++ b/src/Lean/Elab/Command.lean</span>\n<span class=\"gu\">@@ -226,13 +226,16 @@ private def runCore (x : CoreM α) : CommandElabM α := do</span>\n<span class=\"w\"> </span>  }\n<span class=\"w\"> </span>  let (ea, coreS) ← liftM x\n<span class=\"w\"> </span>  modify fun s =&gt; { s with\n<span class=\"gd\">-    env               := coreS.env</span>\n<span class=\"gd\">-    nextMacroScope    := coreS.nextMacroScope</span>\n<span class=\"gd\">-    ngen              := coreS.ngen</span>\n<span class=\"gd\">-    infoState.trees   := s.infoState.trees.append coreS.infoState.trees</span>\n<span class=\"gd\">-    traceState.traces := coreS.traceState.traces.map fun t =&gt; { t with ref := replaceRef t.ref ctx.ref }</span>\n<span class=\"gd\">-    snapshotTasks     := coreS.snapshotTasks</span>\n<span class=\"gd\">-    messages          := s.messages ++ coreS.messages</span>\n<span class=\"gi\">+    env                      := coreS.env</span>\n<span class=\"gi\">+    nextMacroScope           := coreS.nextMacroScope</span>\n<span class=\"gi\">+    ngen                     := coreS.ngen</span>\n<span class=\"gi\">+    infoState.trees          := s.infoState.trees.append coreS.infoState.trees</span>\n<span class=\"gi\">+    -- we assume substitution of `assingment` has already happened, but for lazy assignments we only</span>\n<span class=\"gi\">+    -- do it at the very end</span>\n<span class=\"gi\">+    infoState.lazyAssignment := coreS.infoState.lazyAssignment</span>\n<span class=\"gi\">+    traceState.traces        := coreS.traceState.traces.map fun t =&gt; { t with ref := replaceRef t.ref ctx.ref }</span>\n<span class=\"gi\">+    snapshotTasks            := coreS.snapshotTasks</span>\n<span class=\"gi\">+    messages                 := s.messages ++ coreS.messages</span>\n<span class=\"w\"> </span>  }\n<span class=\"w\"> </span>  return ea\n</code></pre></div>",
        "id": 539730018,
        "sender_full_name": "Gravifer",
        "timestamp": 1758017488
    },
    {
        "content": "<p>But only when <code>Elab.async</code> is true, right?  With <code>false</code> it works as expected?</p>",
        "id": 539730051,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017501
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.22tactic.20not.20used.22.20warning.20upon.20.60whatsnew.60ed.20lemma/near/539730051\">said</a>:</p>\n<blockquote>\n<p>But only when <code>Elab.async</code> is true, right?  With <code>false</code> it works as expected?</p>\n</blockquote>\n<p>Yes, nothing appears wrong</p>",
        "id": 539730155,
        "sender_full_name": "Gravifer",
        "timestamp": 1758017537
    },
    {
        "content": "<p>The commit message may have a clue:</p>\n<p>feat: allow async elab tasks to contribute to info trees reported to linters and request handlers (<a href=\"https://github.com/leanprover/lean4/pull/7457\">#7457</a>)</p>\n<p>This PR ensures info tree users such as linters and request handlers have access to info subtrees created by async elab task by introducing API to leave holes filled by such tasks. <strong>Breaking change</strong>: other metaprogramming users of <code>Command.State.infoState</code> may need to call <code>InfoState.substituteLazy</code> on it manually to fill all holes.</p>",
        "id": 539730159,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017538
    },
    {
        "content": "<p>It looks like this is another \"remember to instantiate metavariables\" metaprogramming footguns.</p>",
        "id": 539730339,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017602
    },
    {
        "content": "<p>Are you suggesting the behaviour may be intentional?</p>",
        "id": 539730637,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758017704
    },
    {
        "content": "<blockquote>\n<p>getting scared of metaprogramming two months before learning even a bit of it</p>\n</blockquote>",
        "id": 539730699,
        "sender_full_name": "Gravifer",
        "timestamp": 1758017726
    },
    {
        "content": "<p>Well, the commit message precisely warns about something <code>lazy</code> requiring more care, so it may be indeed intended behaviour.</p>",
        "id": 539730767,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017743
    },
    {
        "content": "<p>Or, possibly, least worse consequence?</p>",
        "id": 539730811,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017755
    },
    {
        "content": "<p>Honestly, I do not really know how <code>async</code> works, but it seems like a <em>really hard</em> question, with all the interleaving computations of going from text to syntax and expressions, with every bit using information from the rest.</p>",
        "id": 539731000,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017823
    },
    {
        "content": "<p>I've made an issue: <a href=\"https://github.com/leanprover/lean4/pull/10408\">lean#10408</a></p>",
        "id": 539731056,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758017841
    },
    {
        "content": "<p>So, if this makes the process hold together (or possibly speeds up things) most of the times and linters have to work around this sometimes, it may be a win.  <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span></p>",
        "id": 539731125,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758017864
    },
    {
        "content": "<p>In that case it may be nice for the linter to display a message that one can temporarily do <code>set_option Elab.async false</code> to confirm that everything is as expected</p>",
        "id": 539731440,
        "sender_full_name": "Gravifer",
        "timestamp": 1758017972
    },
    {
        "content": "<p>You mean that the message could be issued <em>always</em>?  Or try to find a heuristic for when this could be the culprit?</p>",
        "id": 539731613,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018027
    },
    {
        "content": "<p>It does not seem easy to figure out whether the missing <code>lazyAssignment</code>s are not there because they should not be there or because they have been erased.</p>",
        "id": 539731746,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018069
    },
    {
        "content": "<p>Maybe just always issue it if <code>Elab.async</code> is currently turned on?</p>",
        "id": 539731918,
        "sender_full_name": "Gravifer",
        "timestamp": 1758018129
    },
    {
        "content": "<p>I view <code>Elab.async</code> as being always on, unless you know what you are doing.</p>",
        "id": 539731980,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018158
    },
    {
        "content": "<p>Yes, I think it would be better to just fix the underlying issue</p>",
        "id": 539732014,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758018171
    },
    {
        "content": "<p><code>Elab.async</code> is what allows Lean to process in parallel most of the files, so it is a <em>huge</em> improvement and speed up.  Setting it to <code>false</code> should be a \"last resort\" kind of option.</p>",
        "id": 539732152,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018215
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.22tactic.20not.20used.22.20warning.20upon.20.60whatsnew.60ed.20lemma/near/539732014\">said</a>:</p>\n<blockquote>\n<p>Yes, I think it would be better to just fix the underlying issue</p>\n</blockquote>\n<p>I agree: if this can be fixed in core, then I think that would be best.  If not, then we can look for a workaround.</p>",
        "id": 539732298,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018263
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.22tactic.20not.20used.22.20warning.20upon.20.60whatsnew.60ed.20lemma/near/539732152\">said</a>:</p>\n<blockquote>\n<p><code>Elab.async</code> is what allows Lean to process in parallel most of the files, so it is a <em>huge</em> improvement and speed up.  Setting it to <code>false</code> should be a \"last resort\" kind of option.</p>\n</blockquote>\n<p>I was thinking about a local mute (In my screenshots I enclosed it with a section block); I think this means that locally  it reverts to pre4.19 behavior and leave async elab outside it unaffected, but I know too little to be sure</p>",
        "id": 539733503,
        "sender_full_name": "Gravifer",
        "timestamp": 1758018683
    },
    {
        "content": "<p><code>Elab.async</code> is relatively recent, so it is even possible that pre4.19 it was either not present of not used as extensively.</p>",
        "id": 539733688,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018749
    },
    {
        "content": "<p>Also, what you say is correct: the options enclosed in <code>section/end</code> blocks are set only locally.  You can achieve the same for a single command using <code>set_option ... in cmd</code>.</p>",
        "id": 539734068,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018898
    },
    {
        "content": "<p>Still, I do not think that this is what the linter should suggest.  Either core adapts, or the linter does, but it should not suggest to set to <code>false</code> <code>Elab.async</code>.  At least, this is my opinion.</p>",
        "id": 539734228,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1758018955
    },
    {
        "content": "<p>What turns out to be seemingly an unrelated issue, but I figure openning a separate thread would feel somewhat spammy:<br>\n<a href=\"/user_uploads/3121/S6vUhrDJmdfA-lUwuZEJ6ytl/QQ20250921175049.png\">screenshot</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/S6vUhrDJmdfA-lUwuZEJ6ytl/QQ20250921175049.png\" title=\"screenshot\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1526x1280\" src=\"/user_uploads/thumbnail/3121/S6vUhrDJmdfA-lUwuZEJ6ytl/QQ20250921175049.png/840x560.webp\"></a></div><p>This is <a href=\"https://leanprover-community.github.io/mathematics_in_lean/C10_Linear_Algebra.html#pushing-and-pulling-subspaces:~:text=reprove%20one%20implication%20of%20Submodule.mem_sup\">MIL C10S2.4</a>, and the commented lines would close <code>add</code>; I set <code>Elab.async</code> to false just for posting, to check if it comes from similar roots</p>",
        "id": 540646294,
        "sender_full_name": "Gravifer",
        "timestamp": 1758448446
    },
    {
        "content": "<p>Fixed by @Kha in <a href=\"https://github.com/leanprover/lean4/pull/10518/commits/1892d180b198acbaff44f9ea83d063a9d51da569\">https://github.com/leanprover/lean4/pull/10518/commits/1892d180b198acbaff44f9ea83d063a9d51da569</a></p>\n<p>[Quoting…]</p>",
        "id": 541684562,
        "sender_full_name": "Gravifer",
        "timestamp": 1758897698
    }
]