[
    {
        "content": "<p>I've noticed that since a few days or so, the \"build Mathlib\" step in CI first builds ProofWidgets after every push even though no changes have been made to it. Is this by design or a bug?</p>",
        "id": 481281282,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1731060566
    },
    {
        "content": "<p>I've noticed the same thing when getting cache. I seem to need to build ProofWidgets every time</p>",
        "id": 481281372,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1731060601
    },
    {
        "content": "<p>Here is the log from the latest CI run for one of my PRs:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Run liskin/gh-problem-matcher-wrap@v3\n/usr/bin/bash -o pipefail -c env LEAN_ABORT_ON_PANIC=1 lake build --wfail -KCI\n✔ [941/5439] Built ProofWidgets.Compat\n✔ [942/5439] Built ProofWidgets.Util\n✔ [943/5439] Built ProofWidgets.Component.Basic\n✔ [944/5439] Built ProofWidgets.Cancellable\n✔ [945/5439] Built ProofWidgets.Component.MakeEditLink\n✔ [946/5439] Built ProofWidgets.Component.Panel.Basic\n✔ [947/5439] Built ProofWidgets.Data.Html\n✔ [948/5439] Built ProofWidgets.Component.HtmlDisplay\n✔ [949/5439] Built ProofWidgets.Component.OfRpcMethod\n✔ [5365/5439] Built ProofWidgets.Component.PenroseDiagram\n✔ [5366/5439] Built ProofWidgets.Presentation.Expr\n✔ [5437/5439] Built Mathlib.RingTheory.RootsOfUnity.EnoughRootsOfUnityInstances\n✔ [5438/5439] Built Mathlib\nBuild completed successfully.\n</code></pre></div>",
        "id": 481281563,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1731060654
    },
    {
        "content": "<p>It's not meant to be like this. :-(</p>",
        "id": 481281843,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731060747
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, could this be connected to the exit code 3 failures from <code>lake build --no-build</code> that we're seeing on <code>nightly-testing</code>?</p>",
        "id": 481282077,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731060829
    },
    {
        "content": "<p>After upgrading to the latest Mathlib, I have to manually rebuild ProofWidgets after getting the cache:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">Floris@Dell-E MINGW64 ~/projects/mathlibc ((efb737da256...))</span>\n<span class=\"gp\">$ </span>lc\n<span class=\"go\">info: batteries: updating repository '.\\.\\.lake/packages\\batteries' to revision 'af731107d531b39cd7278c73f91c573f40340612'</span>\n<span class=\"go\">info: Qq: updating repository '.\\.\\.lake/packages\\Qq' to revision '303b23fbcea94ac4f96e590c1cad6618fd4f5f41'</span>\n<span class=\"go\">info: aesop: updating repository '.\\.\\.lake/packages\\aesop' to revision '5dfdc66e0d503631527ad90c1b5d7815c86a8662'</span>\n<span class=\"go\">info: proofwidgets: updating repository '.\\.\\.lake/packages\\proofwidgets' to revision '1383e72b40dd62a566896a6e348ffe868801b172'</span>\n<span class=\"go\">info: importGraph: URL has changed; you might need to delete '.\\.\\.lake/packages\\importGraph' manually</span>\n<span class=\"go\">info: importGraph: updating repository '.\\.\\.lake/packages\\importGraph' to revision 'ac7b989cbf99169509433124ae484318e953d201'</span>\n<span class=\"go\">info: LeanSearchClient: updating repository '.\\.\\.lake/packages\\LeanSearchClient' to revision '86d0d0584f5cd165353e2f8a30c455cd0e168ac2'</span>\n<span class=\"go\">info: plausible: cloning https://github.com/leanprover-community/plausible to '.\\.\\.lake/packages\\plausible'</span>\n<span class=\"go\">info: Cli: updating repository '.\\.\\.lake/packages\\Cli' to revision '726b3c9ad13acca724d4651f14afc4804a7b0e4d'</span>\n<span class=\"go\">✔ [2/10] Built Cache.IO</span>\n<span class=\"go\">✔ [3/10] Built Cache.Hashing</span>\n<span class=\"go\">✔ [4/10] Built Cache.Requests</span>\n<span class=\"go\">✔ [5/10] Built Cache.Hashing:c.o</span>\n<span class=\"go\">✔ [6/10] Built Cache.Main</span>\n<span class=\"go\">✔ [7/10] Built Cache.Requests:c.o</span>\n<span class=\"go\">✔ [8/10] Built Cache.IO:c.o</span>\n<span class=\"go\">✔ [9/10] Built Cache.Main:c.o</span>\n<span class=\"go\">✔ [10/10] Built cache</span>\n<span class=\"go\">Attempting to download 4354 file(s)</span>\n<span class=\"go\">Downloaded: 4354 file(s) [attempted 4354/4354 = 100%] (100% success)</span>\n<span class=\"go\">Decompressing 5434 file(s)</span>\n<span class=\"go\">Unpacked in 35279 ms</span>\n<span class=\"go\">Completed successfully!</span>\n\n<span class=\"go\">Floris@Dell-E MINGW64 ~/projects/mathlibc ((efb737da256...))</span>\n<span class=\"gp\">$ </span>lb\n<span class=\"go\">✔ [941/5446] Built ProofWidgets.Compat</span>\n<span class=\"go\">✔ [942/5446] Built ProofWidgets.Util</span>\n<span class=\"go\">✔ [943/5446] Built ProofWidgets.Component.Basic</span>\n<span class=\"go\">✔ [944/5446] Built ProofWidgets.Cancellable</span>\n<span class=\"go\">✔ [945/5446] Built ProofWidgets.Component.MakeEditLink</span>\n<span class=\"go\">✔ [946/5446] Built ProofWidgets.Data.Html</span>\n<span class=\"go\">✔ [947/5446] Built ProofWidgets.Component.Panel.Basic</span>\n<span class=\"go\">✔ [948/5446] Built ProofWidgets.Presentation.Expr</span>\n<span class=\"go\">✔ [949/5446] Built ProofWidgets.Component.HtmlDisplay</span>\n<span class=\"go\">✔ [950/5446] Built ProofWidgets.Component.OfRpcMethod</span>\n<span class=\"go\">✔ [1259/5446] Built ProofWidgets.Component.PenroseDiagram</span>\n<span class=\"go\">Build completed successfully.</span>\n</code></pre></div>\n<p>(<code>lc = lake exe cache get</code> and <code>lb = lake build</code>). This is on Windows.</p>",
        "id": 481388911,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1731101209
    },
    {
        "content": "<p>See also <a href=\"#narrow/channel/287929-mathlib4/topic/CI.20building.20ProofWidgets.20every.20time/near/481281282\">here</a>.</p>",
        "id": 481390825,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1731102238
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, sorry to bother you, but could you expand on what the +1 means? Is this something that you're fixing / you already understand / others need to be working on too?</p>",
        "id": 481396453,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731105071
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> No worries! (Feel free to bother me. <span aria-label=\"smile cat\" class=\"emoji emoji-1f638\" role=\"img\" title=\"smile cat\">:smile_cat:</span>). By <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span>, it seems quite possible and will invesitgate it (which I am currently doing now).</p>",
        "id": 481396663,
        "sender_full_name": "Mac Malone",
        "timestamp": 1731105144
    },
    {
        "content": "<p>2 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/rebuild.20ProofWidgets\">#mathlib4 &gt; rebuild ProofWidgets</a> by <span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span>.</p>",
        "id": 481401162,
        "sender_full_name": "Notification Bot",
        "timestamp": 1731107451
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Sorry for a somewhat slow reply, I was otherwise distracted. I have discovered a few problems here. </p>\n<p>The first problem is that the oleans for ProofWidgets in the mathlib cache appear to be corrupt (they cause a rebuild). This seems like it could be reason check the cache is failing on nightly-testing as well.  That is, the the <code>--no-build</code> failure is not a false positive and the wrong oleans are somehow being uploaded. Perhaps someone more familiar with cache can identify likely reasons for this? If not,  I can try to investigate further.</p>\n<p>The second problem is that <code>lake exe cache get</code> does not fetch the ProofWidgets cloud release before fetching the cache, thus the cloud release overwrites the cache. This is a by-product of <a href=\"https://github.com/leanprover/lean4/pull/5641\">lean4#5641</a>, as <code>lake exe cache</code> no longer fetches the ProofWidgets cloud release as <code>cache</code> does nto depend on  it.  One possible solution is to include the ProofWidget <code>js</code> in the Mahtlib cache. Another is to have <code>lake exe cache</code> invoke <code>lake build proofwidgets:release</code> before clobbering the cloud release's oleans with the mathlib cache's.</p>",
        "id": 481447626,
        "sender_full_name": "Mac Malone",
        "timestamp": 1731147218
    },
    {
        "content": "<p>Is there even any reason to store ProofWidgets .oleans in the Mathlib cache?</p>",
        "id": 481461436,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1731159322
    },
    {
        "content": "<p>If you don't, you always get the warning \"dependencies out of date\" when you open a file in vscode, right?</p>",
        "id": 481470611,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1731166698
    },
    {
        "content": "<p>I also do not know how to reproduce this, nor if it is actually the same issue, but I just pulled the current master and tried downloading the cache, but then <code>lake build</code> was still building.  So, I tried this:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>rm<span class=\"w\"> </span>-i<span class=\"w\"> </span>-rf<span class=\"w\"> </span>.lake/build/lib/Mathlib/*\n\n$<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get\nNo<span class=\"w\"> </span>files<span class=\"w\"> </span>to<span class=\"w\"> </span>download\nDecompressing<span class=\"w\"> </span><span class=\"m\">5483</span><span class=\"w\"> </span>file<span class=\"o\">(</span>s<span class=\"o\">)</span>\nUnpacked<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">12424</span><span class=\"w\"> </span>ms\nCompleted<span class=\"w\"> </span>successfully!\n\n$<span class=\"w\"> </span>lake<span class=\"w\"> </span>build\n⣿<span class=\"w\"> </span><span class=\"o\">[</span>?/?<span class=\"o\">]</span><span class=\"w\"> </span>Computing<span class=\"w\"> </span>build<span class=\"w\"> </span><span class=\"nb\">jobs</span>\n⣟<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">955</span>/5495<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>Mathlib.Tactic.MinImports<span class=\"w\"> </span><span class=\"o\">(</span>+<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>more<span class=\"o\">)</span>\n⡿<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">956</span>/5495<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>Mathlib.Tactic.Linter.MinImports<span class=\"w\"> </span><span class=\"o\">(</span>+<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>more<span class=\"o\">)</span>\n⣻<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">957</span>/5495<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>Mathlib.Tactic.Linter<span class=\"w\"> </span><span class=\"o\">(</span>+<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>more<span class=\"o\">)</span>\n⣽<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">958</span>/5495<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>Mathlib.Tactic.Common<span class=\"w\"> </span><span class=\"o\">(</span>+<span class=\"w\"> </span><span class=\"m\">0</span><span class=\"w\"> </span>more<span class=\"o\">)</span>\n⢿<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">959</span>/5495<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>Mathlib.Order.Interval.Set.UnorderedInterval<span class=\"w\"> </span><span class=\"o\">(</span>+<span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span>more<span class=\"o\">)</span>\n⣽<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">959</span>/5495<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>Mathlib.Order.Interval.Set.UnorderedInterval<span class=\"w\"> </span><span class=\"o\">(</span>+<span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span>more<span class=\"o\">)</span>^C\n</code></pre></div>",
        "id": 481880493,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731396568
    },
    {
        "content": "<p><a href=\"#narrow/channel/287929-mathlib4/topic/CI.20building.20ProofWidgets.20oleans.20every.20time/near/481880493\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/cache.20rebuilding.20proofwidgets.20JS\">#mathlib4 &gt; cache rebuilding proofwidgets JS</a> by <span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span>.</p>",
        "id": 481932733,
        "sender_full_name": "Notification Bot",
        "timestamp": 1731413675
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/CI.20building.20ProofWidgets.20every.20time/near/481461436\">said</a>:</p>\n<blockquote>\n<p>Is there even any reason to store ProofWidgets .oleans in the Mathlib cache?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> Do you see any downsides of relying on the GitHub/Reservoir cache for <strong>all</strong> Mathlib dependencies? Caching them in two different systems fighting each other does seem problematic to me. I suppose it slightly increases the latency between dependency release and corresponding Mathlib bump because Reservoir has to run in between.</p>",
        "id": 481934039,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1731414060
    },
    {
        "content": "<p>It's pretty important to me that an olean cache is available on <code>nightly-testing</code> and <code>lean-pr-testing-NNNN</code> branches, which very often depend on corresponding branches of upstream repositories.</p>",
        "id": 482033785,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731443446
    },
    {
        "content": "<p>I suspect that Reservoir can't support that use case yet?</p>",
        "id": 482033868,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1731443480
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, a heads up that we are getting exit code 3 again from <code>lake build --no-build</code>, and this is preventing essential PRs from being merged.</p>",
        "id": 484473323,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732615004
    },
    {
        "content": "<p>See for example <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/12026201798/job/33524709775?pr=19487\">https://github.com/leanprover-community/mathlib4/actions/runs/12026201798/job/33524709775?pr=19487</a></p>",
        "id": 484473339,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732615008
    },
    {
        "content": "<p>Can someone confirm for me that this is reproducible locally as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">clone</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">.</span><span class=\"n\">git</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">mathlib4</span>\n<span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">checkout</span><span class=\"w\"> </span><span class=\"n\">fb766983b642b3588158800b4ee8e3cca235a198</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">get</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"c1\">--no-build</span>\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"bp\">$?</span>\n</code></pre></div>\n<p>which for me reports an exit code of 3.</p>",
        "id": 484475310,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732615538
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, could you please treat this as a critical issue? This preventing us merging essential PRs to Mathlib. If we need to cut an rc to get a fix, let's do it.</p>",
        "id": 484475490,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732615585
    },
    {
        "content": "<p>I confirm that I also get <code>3</code>.</p>",
        "id": 484499162,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1732623267
    },
    {
        "content": "<p>Same here: everything appears to work, but the final exit code is 3.</p>",
        "id": 484509488,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732626397
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I tested commit <code>fb766983b642b3588158800b4ee8e3cca235a198</code> and as far as I can tell the cache is simply corrupt. After a <code>lake exe cache get!</code> (which afaik should clobber any Lake-produced cache files), Lake is building multiple dependency files (including those from Plausible and Aesop). Thus, I can only infer that the cached oleans are bad.</p>",
        "id": 484559922,
        "sender_full_name": "Mac Malone",
        "timestamp": 1732640920
    },
    {
        "content": "<p>Just quoting a conversation elsewhere for anyone wondering about the conclusion here:</p>\n<hr>\n<p>Mac Malone: Using Sebastian's info, I think I have found the source of the problem. A <code>lake exe cache lookup Plausible/Gen.lean</code> revealed that the commit which pushed the bad olean was <a href=\"https://github.com/leanprover-community/mathlib4/commit/5b40b8f3d99cf3f3e8ce0766ef2a45bdfcf7cf4f\"><code>5b40b8f</code></a>. The CI for the job was cancelled mid-build, but it still uploaded a cache. Since mathlib was unable to build the proper oleans for batteries, the ones from the Reservoir cache were uploaded instead.</p>\n<p>Sebastian Ullrich: Oh that's nefarious. But uploading partial builds is important for Mathlib afaiu. What solution do you suggest?</p>\n<p>Mac Malone: Since this is a critical blocker, I think the simplest solution is best at the moment. As such, disabling Lake's cache in the mathlib CI seems the route to go.</p>\n<p>Mac Malone: It does not appear there is a way to reconcile Mathlib's / Cache's requirements for the Lake directory with Lake's here without some significant new features / refactoring.</p>\n<p>Mac Malone: PR with fixes: <a href=\"https://github.com/leanprover-community/mathlib4/pull/19524\">mathlib4#19524</a>.</p>",
        "id": 484634354,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732678168
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/cache.20rebuilding.20oleans/near/484634354\">said</a>:</p>\n<blockquote>\n<p>The CI for the job was cancelled mid-build, but it still uploaded a cache. Since mathlib was unable to build the proper oleans for batteries, the ones from the Reservoir cache were uploaded instead.</p>\n</blockquote>\n<p>is there some part in the process here where distinguishing between \"complete build\" oleans and \"partial build\" oleans would allow some kind of CI warning at least? something along the lines of \"the cache has only a partially compiled project, so let's build it again ourselves and hope things work out better?\"</p>",
        "id": 484666370,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732697181
    },
    {
        "content": "<p>i might be misunderstanding what's going on here, so please ignore if my question doesn't make sense</p>",
        "id": 484666604,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1732697253
    }
]