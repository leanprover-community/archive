[
    {
        "content": "<p>Hi all, hope you have a great new year :)</p>\n<p>I finished a fully dependently typed formalization of (coloured) operads over on my <a href=\"https://github.com/adrianmartir/mathlib4/blob/adrianmartir-operads/Mathlib/CategoryTheory/Operad/Basic.lean\">mathlib fork</a>. It is based on the notion of a profunctor, i.e. for me a coloured operad on a category <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span> (in most cases, this is just a discrete set of objects) is a certain profunctor equipped with a <em>composition</em> and a <em>unit</em> that satisfy associativity and unit laws. In my setup, these turned out to be not too bad to write down, despite the dependent type.</p>\n<p>My formalization is based on the abstraction of what in my file is referred to as a <em>monad of profunctors</em>. This is meant to encapsulate a notion of a <a href=\"https://arxiv.org/abs/0907.2460\">monad on a virtual equipment</a>, meaning that we send profunctors to profunctors and functors to functors in a compatible way and moreover, we send units (natural transformations with zero inputs), natural transformations and binatural transformations (natural transformations with two inputs) to their counterparts on the target. <code>MonadProf</code> does omit some of the required axioms, since I did not need them, making the definition a bit ad-hoc (subject to change in the future).</p>\n<p>In any case, this <code>MonadProf</code> abstraction lets us insert different monads to get the different flavours of operads: planar, symmetric and cartesian (or even semicartesian), which is a super useful feature. I have not yet written up the constructions for these monads and the corresponding instances for <code>MonadProf</code>.</p>\n<p>So far, I've <a href=\"#narrow/channel/116395-maths/topic/Looking.20for.20feedback.3A.20Coloured.20operads.20formalization/with/562233262\">played with a number of different definitions of operads</a>, and I would say that I like this current one the most.</p>\n<p>I was wondering whether the mathlib community has any thoughts on <em>merging this into mathlib</em> soon. Should I PR it? There are a couple of obvious things that are not there yet.</p>\n<ul>\n<li>Constructions of the different monads giving rise to different flavours of operads</li>\n<li>Defining more generally usable abstractions for <code>FunctorProf</code> so that we can send a general natural transformation with n inputs to a natural transformation with n inputs on the target and stating the missing axioms.</li>\n<li>Maybe some examples as test cases?</li>\n</ul>\n<p>I am sure there are also a number of minor things, like documentation or splitting up into more files that should be done before merging. Also, I would be happy to provide an explanation of how this <code>FunctorProf</code> and <code>MonadProf</code> thing works if someone would like me to expand on it :)</p>",
        "id": 566072326,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767369018
    },
    {
        "content": "<p>P.S. There are some simple diagrams (in a virtual equipment, i.e. involving functors, profunctors and 2-cells with n inputs) that give rise to the operad laws as I formalized them. They greatly helped me understand what is going on, so I made a quick sketch.<br>\n<a href=\"/user_uploads/3121/tItppyrjEOiIP2JnKIDP0azL/2026-01-02-Operad-diagrams.pdf\">2026-01-02-Operad diagrams.pdf</a></p>",
        "id": 566094565,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767382835
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> and I have been working on a different implementation of profunctors. We should coordinate and make sure we find a good approach (although I have family obligations for the next few weeks and it‚Äôs unclear how much time I‚Äôll have for Lean).</p>",
        "id": 566117750,
        "sender_full_name": "Dagur Asgeirsson",
        "timestamp": 1767407151
    },
    {
        "content": "<p>First off, congratulations for finding a framework that minimizes the amount of DTT Hell for this!</p>\n<p>So that we don't end up all stepping on each other toes, I'll mention that I am also working on something a bit related: interpretations of symmetric monoidal categories in \"unbiased\" frameworks (specifically infty-operads √† la Lurie, but without defining them directly for now: I'm content with just producing a fibration over/pseudofunctor out of finite pointed sets that has the expected properties.). Hopefully, some of the output of what I'm doing could help you give a constructor for a symmetric operads out of a symmetric monoidal category.</p>\n<p>Cruttwell and Shulman mention this as 9.6 in their paper: these operads/multicategories based approaches produce \"unbiased\" things, and there is a nontrivial amount of work to do to  to go from the biased constructors (where you give only \"low-arity\" operations and coherences) to the unbiased ones that can be used in frameworks like the one you are defining here: in the case of symmetric monoidal categories, Maclane's coherence theorem (the symmetric version) has to be used.</p>",
        "id": 566132176,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1767426324
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"519559\">@Dagur Asgeirsson</span> I would love to get profunctors into mathlib and coordiinate! There are two obvious approaches that I can think of, either take functors <code>C·µí·µñ √ó C ‚•§ Type u</code> or functors <code>`C·µí·µñ ‚•§  C ‚•§ Type u</code> (curried). There is also the question of whether to op on the left or on the right. Honestly, most of these issues don't matter too much to me, as long as a basic API is there.</p>\n<p>Of course, getting a bicategory instance through profunctor composition would be nice. In this case, however, I have explicitly avoided profunctor composition by allowing 2-cells with multiple input profunctors (in part, because I have an application where computability is important in mind). So getting an API for working with these more general n-cells would be something I care about, though it's possibly a somewhat niche usecase.</p>",
        "id": 566142057,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767438733
    },
    {
        "content": "<p>For profunctors, mathlib would likely prefer the curried version: this tends to work better with automation.</p>",
        "id": 566142405,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1767439209
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"286014\">@Robin Carlier</span> You're right, your n-ary tensor product implementation you posted about before might be useful to do that! And thank you for the interesting remark in the paper, I haven't really read a lot of it! If I need it, I could try making my formalization depend on yours.</p>\n<p>It would also be an interesting project to define the \"category of operators\" together with the functor satisfying the Segal condition to also get the fully unbiased construction of operads (a la Lurie). It might be desirable to have both ideas in mathlib eventually! One perhaps more suitable for concrete constructions and the other for more abstract ideas and comparison with the <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">‚àû</mi></mrow><annotation encoding=\"application/x-tex\">\\infty</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord\">‚àû</span></span></span></span>-setting.</p>",
        "id": 566142525,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767439396
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"286014\">Robin Carlier</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Operads.20Formalization/near/566142405\">said</a>:</p>\n<blockquote>\n<p>For profunctors, mathlib would likely prefer the curried version: this tends to work better with automation.</p>\n</blockquote>\n<p>I think that is an easy change for me to make :) I found that I need a constructor to apply profunctors to objects anyways (<code>Prof.app</code>), because the left object lives in the opposite category.</p>",
        "id": 566142654,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767439566
    },
    {
        "content": "<p>I have moved the profunctor code to <a href=\"https://github.com/adrianmartir/mathlib4/blob/adrianmartir-operads/Mathlib/CategoryTheory/Prof.lean\">a new file</a>. Do you think the curried version is better, even if the way always goes through the API like <code>Prof.app</code> for application? I'm not an automation expert.</p>",
        "id": 566147345,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767444815
    },
    {
        "content": "<p>A general comment: I see you are using <code>(X Y : Cat)</code>, usually, in mathlib we tend to write things in an unbundled way, i.e the idiomatic way to write things would be with parameters <code>(X : Type*) [Category* X] (Y : Type*) [Category* Y]</code>. One of the reasons behind this design choice is that it allows for more universe polymorphism (<code>X Y : Cat</code> implicitly means X and Y must have same universe levels for objects and morphisms)</p>",
        "id": 566149603,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1767446898
    },
    {
        "content": "<p>It's great to hear that others are also interested in getting profunctors into Mathlib! As Dagur mentioned, we have been working on this and settled on the following approach: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">w</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Profunctor</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span>\n<span class=\"w\">  </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y'</span>\n<span class=\"w\">  </span><span class=\"n\">map_id</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">ùüô</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">ùüô</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">map_comp</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"n\">X''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"w\"> </span><span class=\"n\">Y''</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">X''</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"w\"> </span><span class=\"bp\">‚ü∂</span><span class=\"w\"> </span><span class=\"n\">Y''</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">X''</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">f'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"bp\">‚â´</span><span class=\"w\"> </span><span class=\"n\">g'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">f'</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Since the role of <code>Type w</code> here is in the usual type-theoretic sense (not as a category) we ended up getting somewhat bogged down with category theory automation failing due to getting confused between functions and morphisms in <code>Type w</code> (surely anyone who has done category theory in Mathlib has experienced such annoyances). So the first task we wanted to tackle is to introduce a new <code>TypeCat</code> category whose morphisms are one field structures bundling a function, and systematically refactoring the uses of <code>Type w</code> in the category theory library to use <code>TypeCat</code> instead.</p>",
        "id": 566152492,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1767449159
    },
    {
        "content": "<p>If the refactor bringing in <code>TypeCat</code> goes through, would there still be a need for an <em>ad hoc</em> structure like this for profunctors? I feel like this is just duplicating code for things we already have.<br>\n(Edit: oh I guess the point is to <em>not</em> use TypeCat even here. Still not sure about the pros and cons: wouldn't that block using the API for coends that we already have when dealing with compositions of profunctors?)</p>",
        "id": 566152888,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1767449591
    },
    {
        "content": "<p>(I also agree that a stronger separation between category-theory morphisms and bare functions would be a good thing to help unconfusing automation, but it's probably going to be quite a big refactor. Have there been prior discussions about this or are you taking this thread as an opportunity to announce this upcoming refactor?)</p>",
        "id": 566153796,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1767450535
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"286014\">Robin Carlier</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Operads.20Formalization/near/566149603\">said</a>:</p>\n<blockquote>\n<p>A general comment: I see you are using <code>(X Y : Cat)</code>, usually, in mathlib we tend to write things in an unbundled way</p>\n</blockquote>\n<p>I'm kind of aware of that and that the way I'm doing profunctors should do it that way. I think I'll leave it to Adam and Dagur to work that part out and use a temporary definition for now. Unless, of course, there is a branch somewhere I can use.</p>\n<p>However, the way I'm doing operads using a monad <code>T : Monad Cat</code>, makes it really convenient to have <code>structure Operad (X : Cat) where ...</code>, since I'm constantly calling <code>T.obj X</code> or also <code>T.obj (T.obj X)</code>, where I would otherwise have to insert <code>Cat.of</code> everywhere anyways. I hope this is fine.</p>",
        "id": 566159233,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767456059
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"286014\">Robin Carlier</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Operads.20Formalization/near/566149603\">said</a>:</p>\n<blockquote>\n<p>A general comment: I see you are using <code>(X Y : Cat)</code>, usually, in mathlib we tend to write things in an unbundled way</p>\n</blockquote>\n<p>I'm kind of aware of that and that the way I'm doing profunctors should do it that way. I think I'll leave it to Adam and Dagur to work that part out and use a temporary definition for now. Unless, of course, there is a branch somewhere I can use.</p>\n<p>However, the way I'm doing operads using a monad <code>T : Monad Cat</code>, makes it really convenient to have <code>structure Operad (X : Cat) where ...</code>, since I'm constantly calling <code>T.obj X</code> or also <code>T.obj (T.obj X)</code>, where I would otherwise have to insert <code>Cat.of</code> everywhere anyways. I hope this is fine.</p>\n<p>In any case, I'm happy to hear that you have been experimenting with profunctors and settled for an approach! I guess I didn't really pay too much attention to the details of this, being focused on the operads part.</p>",
        "id": 566160316,
        "sender_full_name": "Adrian Marti",
        "timestamp": 1767457094
    }
]