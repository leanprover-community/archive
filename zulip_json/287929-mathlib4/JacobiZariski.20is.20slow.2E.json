[
    {
        "content": "<p>Matt Ballard pointed out to me the following stunning stat (the screenshot below is from the speedcenter):</p>\n<p><a href=\"/user_uploads/3121/8C92hCfYc86HTRHrhdWJySrN/Screenshot-from-2025-01-27-22-25-41.png\">Screenshot from 2025-01-27 22-25-41.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/8C92hCfYc86HTRHrhdWJySrN/Screenshot-from-2025-01-27-22-25-41.png\" title=\"Screenshot from 2025-01-27 22-25-41.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1300x384\" src=\"/user_uploads/thumbnail/3121/8C92hCfYc86HTRHrhdWJySrN/Screenshot-from-2025-01-27-22-25-41.png/840x560.webp\"></a></div><p>This is all benchmarks sorted by \"value\" (which I think is \"number of instructions\"?). Turns out that <code>Mathlib.RingTheory.Kaehler.JacobiZariski</code>'s value is about twice as large as the next file in mathlib. Christian just opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/21129\">#21129</a> which looks to me like a huge hack but even with the resulting massive speedup the file is still the most instructiony file in mathlib and it's under 500 lines. </p>\n<p>I fired it up and watched the orange bars; there was a distinct pause in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators.CotangentSpace.compEquiv#doc\">docs#Algebra.Generators.CotangentSpace.compEquiv</a> on my fast machine. <code>set_option trace.profiler true</code> on line 156 just before that declaration gives <code>[Elab.command] [2.141008]...</code> but when I unfold it down, the majority of the time is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"kn\">def</span><span class=\"bp\">.</span><span class=\"n\">processPreDef</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.543822</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"bp\">-</span><span class=\"n\">definitions</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1.516111</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">typechecking</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n</code></pre></div>\n<p>with no further unfolding available. My understanding of the kernel is primitive. Are we able to conjecture exactly what is making the kernel take 1.5 seconds here? The full declaration is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">compEquiv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ‚Çó</span><span class=\"o\">[</span><span class=\"n\">T</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"w\"> </span><span class=\"bp\">√ó</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"o\">[</span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">repr</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">baseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">repr</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n</code></pre></div>\n<p>I noticed that removing the type and just writing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">compEquiv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">repr</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">prod</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">baseChange</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">repr</span><span class=\"bp\">.</span><span class=\"n\">symm</span>\n</code></pre></div>\n<p>made the time drop to 0.5 seconds, and the file still compiles, with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.036026</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">typechecking</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n</code></pre></div>\n<p>so somehow I've removed the problem (but I don't know what I'm doing). There seem to be many other problems with this file but I thought I'd start by flagging that because it's something I don't understand. In fact the file seems to be full of slow \"typechecking declaration\"s e.g. <code>CotangentSpace.fst_compEquiv</code> has</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Kernel</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">3.417108</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">typechecking</span><span class=\"w\"> </span><span class=\"n\">declaration</span>\n</code></pre></div>\n<p>I noticed that you can tell when this is happening because the orange bars jump up: they compile the proof and then when the kernel is typechecking the declaration they jump up again to the statement. </p>\n<p>There is also a very slow-looking <code>rfl</code> on line 326.</p>",
        "id": 496225223,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738018387
    },
    {
        "content": "<p>The output of <code>#check CotangentSpace.compEquiv</code> with and without the def being given explictly are different with pp.all on. (&lt; is with, &gt; is without):</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code>19c19\n<span class=\"gd\">&lt;   @LinearEquiv.{uT, uT, max (max (max u uT) w) w', max (max (max (max u v) w') uT) (max uT v) w} T T</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt;   @LinearEquiv.{uT, uT, max (max (max u uT) w) w', max (max (max (max u uT) v) w) w'} T T</span>\n28c28\n<span class=\"gd\">&lt;     (@Algebra.Extension.CotangentSpace.{max (max u w) w', u, uT} R T inst‚úù inst‚úù¬≤ inst‚úù‚Åµ</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt;     (@Algebra.Extension.CotangentSpace.{max u w w', u, uT} R T inst‚úù inst‚úù¬≤ inst‚úù‚Åµ</span>\n31c31\n<span class=\"gd\">&lt;     (Prod.{max (max uT v) w, max (max (max u v) w') uT}</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt;     (Prod.{max (max uT v) w, max (max (max u uT) v) w'}</span>\n...\n</code></pre></div>\n<p>There are loads of universe differences like this, and what look like different solutions to typeclass inference in other places. This could explain why the hack in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21129\">#21129</a> has an effect.</p>",
        "id": 496227267,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738019454
    },
    {
        "content": "<p>cf <a class=\"stream-topic\" data-stream-id=\"144837\" href=\"/#narrow/channel/144837-PR-reviews/topic/.2321099.20use.20unification.20hints.20for.20generators\">#PR reviews &gt; #21099 use unification hints for generators</a></p>",
        "id": 496241929,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738028063
    },
    {
        "content": "<p>So my conjecture is</p>\n<ol>\n<li>Lean does some universe normalization when assigning universes.</li>\n<li>\n<p>This causes some universe discrepancies when some universe is normalized but we are trying to unify it to another term which produces a non-normalized universe. <br>\ne. g. in the example above, <code>(Q.comp P).toExtension</code> has type <code>Extension.{max u w w', u, uT} R T</code>, but in <code>(Q.comp P).toExtension.CotangentSpace</code>, the inferred universe is now <code>CotangentSpace.{max (max u w) w'}</code>. We then try to unify this with <code>(Q.comp P).cotangentBasis</code>, which gives a basis for <code>CotangentSpace.{max u w w'}</code>. If one replace <code>(Q.comp P).toExtension.CotangentSpace</code> with <code>Extension.CotangentSpace.{max u w w'} (Q.comp P).toExtension</code> then the issue disappears.</p>\n</li>\n<li>\n<p>When the kernel notices that the two universes don't match, it unfolds both sides first before trying to unify them. I have no evidence at hand because I don't know how to get traces for the kernel. But I recall something similar happening in <code>IsDefEq</code> checks.</p>\n</li>\n<li>The normalization in step 1 sorts the universes alphabetically, which is why Christian's hack in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21129\">#21129</a> changing the names of universe variables has an impact.</li>\n</ol>",
        "id": 496243813,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738029378
    },
    {
        "content": "<p>Bleurgh sorry for starting a thread on this, I had thought the other one was a discussion about unification hints. I claim my title is better :-)</p>",
        "id": 496300959,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738059671
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496300959\">said</a>:</p>\n<blockquote>\n<p>Bleurgh sorry for starting a thread on this, I had thought the other one was a discussion about unification hints. I claim my title is better :-)</p>\n</blockquote>\n<p>Thanks for starting it, the other started as a discussion about unification hints, but went on the performance tangent. I am still interested in the original design question for the unification hints.</p>",
        "id": 496301406,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738059815
    },
    {
        "content": "<p>Oh wow, the only file which imports <code>JacobiZariski</code> is <code>RingTheory.Etale.Kaehler</code> which is universe-monomorphic without any explanation. <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> do you know why this is? I've tried making JacobiZariski universe-monomorphic in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21165\">#21165</a> just as an experiment to see what happens (I don't know of a better way of counting instructions than benchmarking).</p>",
        "id": 496306720,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738061559
    },
    {
        "content": "<p>On Linux, <code>lake env perf stat lean &lt;file&gt;</code> should give you similar numbers independent of the hardware</p>",
        "id": 496307376,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738061753
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496306720\">said</a>:</p>\n<blockquote>\n<p>Oh wow, the only file which imports <code>JacobiZariski</code> is <code>RingTheory.Etale.Kaehler</code> which is universe-monomorphic without any explanation. <span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> do you know why this is? I've tried making JacobiZariski universe-monomorphic in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21165\">#21165</a> just as an experiment to see what happens (I don't know of a better way of counting instructions than benchmarking).</p>\n</blockquote>\n<p>This is because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Smooth#doc\">docs#Algebra.Smooth</a> (and hence <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Etale#doc\">docs#Algebra.Etale</a>) are only defined universe-monomorphic, which might change soonish though.</p>",
        "id": 496308927,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738062280
    },
    {
        "content": "<p>Looking forward to the resulting super-slowdowns ;-)</p>",
        "id": 496309644,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738062509
    },
    {
        "content": "<p>Taking a step back, I know the prevailing philosophy here is \"we have universes therefore of course we should be universe-polymorphic\" and I could even imagine a justification of the form \"an initial definition of etale cohomology involves taking a limit over a class of schemes and thus <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>H</mi><mrow><mi>e</mi><mi>t</mi></mrow><mn>0</mn></msubsup><mo stretchy=\"false\">(</mo><msup><mi mathvariant=\"double-struck\">P</mi><mn>0</mn></msup><mo separator=\"true\">,</mo><msub><mi mathvariant=\"double-struck\">Z</mi><mi>p</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">H^0_{et}(\\mathbb{P}^0,\\Z_p)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.1002em;vertical-align:-0.2861em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.453em;margin-left:-0.0813em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">e</span><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathbb\">P</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">Z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> will be a group in <code>Type 1</code> so it's important that we are polymorphic\" but honestly, can you really envisage some kind of application of the specific results in this file where we really do have rings or presentations in universes other than <code>Type</code> or at worst <code>Type u</code>? If it comes down to a choice between \"this file can be made much faster by making things universe-monomorphic\" or \"this file can be made much faster by some PR to core making <code>Algebra.Extension.CotangentSpace.{max (max u w) w', u, uT}</code> unify with <code>Algebra.Extension.CotangentSpace.{max u w w', u, uT}</code> without unfolding all fields\" then it might be a darn sight easier to roll back on our universe conventions. Our current super-universe-polymorphic design decisions at this level might be making our lives much worse with no actual applications ever.</p>",
        "id": 496310684,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738062848
    },
    {
        "content": "<p>I am fine with restricting to <code>R S T : Type u</code>, because we plug this into <code>CommRingCat.{u}</code> and then in <code>Scheme.{u}</code> anyway, so it does not matter. But we should be more careful when restricting the universes of the <code>vars</code> field in <code>Generators.{w, u, u}</code>, because there both <code>w = 0</code> and <code>w = u</code> appear in applications.</p>",
        "id": 496312178,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738063352
    },
    {
        "content": "<p>Hmm. Mario warned me years ago about structures such as <code>Generators</code>, which have a free universe variable in a field. I don't see why you <em>need</em> w = 0, you can just <code>ulift</code>. I agree it's a bit crappy though. As someone who believes in the set-theoretic foundations of mathematics I don't see why we can't just take w = u = 0 because none of those higher universes actually exist anyway ;-)</p>",
        "id": 496312821,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738063605
    },
    {
        "content": "<p>Boom: universe monomorphism hack beats alphabetical order hack hands down:</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21165#issuecomment-2618740450\">https://github.com/leanprover-community/mathlib4/pull/21165#issuecomment-2618740450</a></p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gi\">+ ~Mathlib.RingTheory.Kaehler.JacobiZariski   instructions   -60.7%</span>\n</code></pre></div>\n<p>Looks like you need to work more on your alphabet :-)</p>",
        "id": 496315711,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738064616
    },
    {
        "content": "<p>The oleans are also about 20% smaller with your version, Kevin.</p>",
        "id": 496317244,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738065241
    },
    {
        "content": "<p>We can monomorphise now and still consider going back once lean is smarter about it</p>",
        "id": 496318594,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738065712
    },
    {
        "content": "<p>I closed the PR because I wanted to discourage this solution over actually thinking harder about the problem now.</p>",
        "id": 496321548,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738066684
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496312821\">said</a>:</p>\n<blockquote>\n<p>Hmm. Mario warned me years ago about structures such as <code>Generators</code>, which have a free universe variable in a field. </p>\n</blockquote>\n<p>This was also my concern initially.</p>",
        "id": 496332299,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738070103
    },
    {
        "content": "<p>One major point of the whole API around <code>Generators</code>, <code>Presentation</code>, <code>Extension</code> etc. is to have one type for all presentations of a given algebra. But we could still achieve this with a sigma type on top of a more unbundled <code>Generators</code> (etc.) type. For example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Generators'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">S</span>\n<span class=\"w\">  </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"w\">  </span><span class=\"n\">aeval_val_œÉ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span><span class=\"bp\">.</span><span class=\"n\">aeval</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">Œ£</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">Generators'</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">Œπ</span>\n</code></pre></div>\n<p>Then possibly a lot of theory can be developed only using <code>Generators'</code> and if we need the uniform type we can use the sigma type.</p>",
        "id": 496334140,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738070651
    },
    {
        "content": "<p>I also think this will suffer from the same issues. I have to teach from dawn to dusk today so won't be able to contribute more usefully until tomorrow morning at the earliest.</p>",
        "id": 496335322,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738070998
    },
    {
        "content": "<p>There are two precise Lean issues so far: </p>\n<ol>\n<li>does normalization of levels not fully associate <code>max</code> in some situations? (Unknown)</li>\n<li>does the mismatch between the normal forms in the elaborator and kernel materially cause problems? I think this file provides a definite yes to that.</li>\n</ol>",
        "id": 496335863,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738071149
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496243813\">said</a>:</p>\n<blockquote>\n<p>...<br>\nIf one replace <code>(Q.comp P).toExtension.CotangentSpace</code> with <code>Extension.CotangentSpace.{max u w w'} (Q.comp P).toExtension</code> then the issue disappears.</p>\n</blockquote>\n<p>Wooah. Indeed just after <code>CotangentSpace.compEquiv</code> dump this in the file:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">experiment</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"n\">Extension</span><span class=\"bp\">.</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">w'</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toExtension</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"c1\">--   [Kernel] [2.126365] typechecking declaration</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">experiment</span>\n</code></pre></div>",
        "id": 496348891,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738074693
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/kernel.20universe.20normalization.20issue/near/496355201\">#lean4 &gt; kernel universe normalization issue @ üí¨</a> </p>\n<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496312178\">said</a>:</p>\n<blockquote>\n<p>I am fine with restricting to <code>R S T : Type u</code>, because we plug this into <code>CommRingCat.{u}</code> and then in <code>Scheme.{u}</code> anyway, so it does not matter. But we should be more careful when restricting the universes of the <code>vars</code> field in <code>Generators.{w, u, u}</code>, because there both <code>w = 0</code> and <code>w = u</code> appear in applications.</p>\n</blockquote>\n<p>Given that <a href=\"https://github.com/leanprover-community/mathlib4/pull/21165\">#21165</a> compiled, I can only assume you mean \"...in applications which have not yet appeared in <code>mathlib</code>\"? But there are definitely such applications? (I can quite believe that there are, for example \"a relation for every term in <code>R</code>\" or \"a relation for every term in <code>Fin n</code>\", I'm just saying that we don't seem to have seen them yet?)</p>",
        "id": 496357811,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738076850
    },
    {
        "content": "<p>We have uses of <code>Generators.{u, u, u}</code> and uses of <code>Generators.{0, u, u}</code> in <code>mathlib</code>, the first by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Generators.self#doc\">docs#Generators.self</a> (this is your <code>R</code> example with <code>R</code> replaced by <code>S</code>) and the second one by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AlgebraicGeometry.IsSmooth#doc\">docs#AlgebraicGeometry.IsSmooth</a> (this is your <code>Fin n</code> example). The first one is the more important one, since it is used to define <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.H1Cotangent#doc\">docs#Algebra.H1Cotangent</a>, which is then used in <code>RingTheory.Etale.Kaehler</code>.</p>\n<p>I <em>believe</em> that everything we need goes through if we restrict to <code>w = u = v</code> in the <code>JacobiZariski</code> file, since <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.H1Cotangent#doc\">docs#Algebra.H1Cotangent</a> is independent of the presentation, so you can always choose <code>w = u</code>. And we are restricting to <code>u = v</code> in the AG applications anyway.</p>\n<p>Mathematically, there is of course no obstruction, because where we want to use <code>w = 0</code> is for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.IsStandardSmooth#doc\">docs#Algebra.IsStandardSmooth</a> (where the universes should just be changed to <code>.{0, 0, u, v}</code>, I have been wanting to PR a fix for a while), but there the index type is finite so the universe does not matter.</p>",
        "id": 496360991,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738077729
    },
    {
        "content": "<p>Aah I see: so in fact what will have happened in my branch would simply be that u was set to 0 in those examples.</p>",
        "id": 496361298,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738077832
    },
    {
        "content": "<p>Drive by thought between other things: it should be simple to write an elaborator that just (re?-)normalizes the universe levels of constants declared in a file. Putting this at the top of problematic files would put all the universe levels in the same normalized form and you can test the hypothesis that <code>max</code> association is the cause itself.</p>",
        "id": 496368175,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738079654
    },
    {
        "content": "<p>Did you see <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/kernel.20universe.20normalization.20issue/near/496355201\">#lean4 &gt; kernel universe normalization issue @ üí¨</a>  ? That looks like a pretty good test. Is it clear that this would help with e.g. <code>CotangentSpace.compEquiv</code>? cf Andrew's point 2 <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496243813\">here</a>.</p>",
        "id": 496369230,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738079957
    },
    {
        "content": "<p>For the record, I am currently trying to unbundle <code>P</code> from <code>Extensions</code> but I am failing miserably and I don't see a good way out.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">TensorProduct</span><span class=\"bp\">.</span><span class=\"n\">RightExactness</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Cotangent</span>\n\n<span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">TensorProduct</span><span class=\"w\"> </span><span class=\"n\">MvPolynomial</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Extension</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">algebra</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">isScalarTower</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- A chosen (set-theoretic) section of an extension. -/</span>\n<span class=\"w\">  </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">P</span>\n<span class=\"w\">  </span><span class=\"n\">algebraMap_œÉ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Extension</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Pe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Extension</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span>\n\n<span class=\"sd\">/-- The underlying algebra of an extension. -/</span>\n<span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Extension</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">P</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">algebraMap_œÉ</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">Pe</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Pe</span><span class=\"bp\">.</span><span class=\"n\">algebra</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Pe</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Pe</span><span class=\"bp\">.</span><span class=\"n\">isScalarTower</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R‚ÇÄ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R‚ÇÄ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R‚ÇÄ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R‚ÇÄ</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">R‚ÇÄ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R‚ÇÄ</span><span class=\"w\"> </span><span class=\"n\">Pe</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">compHom</span><span class=\"w\"> </span><span class=\"n\">Pe</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"n\">R‚ÇÄ</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">Pe</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"c1\">-- understandibly fails</span>\n</code></pre></div>",
        "id": 496370849,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738080408
    },
    {
        "content": "<p>Why do we need <code>Extension.Ring</code> if <code>P</code> is unbundled?</p>",
        "id": 496371339,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738080561
    },
    {
        "content": "<p>With respect to <code>max</code> associativity, I think that this discussion also happened <a href=\"#narrow/channel/287929-mathlib4/topic/Universe-heterogeneous.20ordinal.20and.20cardinal.20relations\">here</a>.</p>",
        "id": 496371453,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738080601
    },
    {
        "content": "<p>Because we need the instance synthesizer to find <code>algebra P S</code>.</p>",
        "id": 496371515,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738080608
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496371515\">said</a>:</p>\n<blockquote>\n<p>Because we need the instance synthesizer to find <code>algebra P S</code>.</p>\n</blockquote>\n<p>At this point you might as well unbundle <code>[Algebra P S]</code></p>",
        "id": 496371678,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738080666
    },
    {
        "content": "<p>This is also very painful because in practice they are some hand constructed thing and we don't have these instances floating around. (e.g. <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Extension.localization#doc\">docs#Algebra.Extension.localization</a>)</p>",
        "id": 496372049,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738080776
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> excellent! Ask and you shall receive. Thanks to <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> :) (Caveat: I didn‚Äôt actually read the code.)</p>",
        "id": 496372478,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738080903
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/496368175\">said</a>:</p>\n<blockquote>\n<p>Drive by thought between other things: it should be simple to write an elaborator that just (re?-)normalizes the universe levels of constants declared in a file. Putting this at the top of problematic files would put all the universe levels in the same normalized form and you can test the hypothesis that <code>max</code> association is the cause itself.</p>\n</blockquote>\n<p>I'm not sure if this is what you are thinking of but using this elab function that I modified from Eric's code</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\"><pre><span></span><code>section\n\nopen Lean Meta Elab Tactic Term\n\nderiving instance DecidableEq for Lean.LevelMVarId\nderiving instance DecidableEq for Lean.Level\nderiving instance Ord for Lean.Name\nderiving instance Ord for Lean.LevelMVarId\nderiving instance Ord for Lean.Level\n\n/-- Associate and sort `max`es within a `Level`. -/\ndef _root_.Lean.Level.normalizeMax (l : Level) (max_fun : Level ‚Üí Level ‚Üí Level) : Level :=\n  addMax (go l)\nwhere\n  addMax (l : List Level) : Level :=\n    match l.dedup.mergeSort (compare ¬∑ ¬∑ ‚â† .lt) with\n    | [] =&gt; panic!&quot;impossible&quot;\n    | [l] =&gt; l\n    | l :: ls =&gt; ls.dedup.foldl max_fun l\n  go : Level ‚Üí List Level\n    | u@.zero | u@(.mvar _) | u@(.param _) =&gt; [u]\n    | .succ u =&gt; [.succ &lt;| addMax (go u)]\n    | .max u v =&gt; go u ++ go v\n    | .imax u v =&gt; [.imax (addMax (go u)) (addMax (go v))]\n\nelab &quot;clean_universe% &quot; t:term : term =&gt; do\n  let t ‚Üê Term.levelMVarToParam (‚Üê instantiateMVars (‚Üê Term.elabTerm t none))\n  return t.replaceLevel fun l ‚Ü¶ l.normalizeMax .max\n\nelab &quot;clean_universe_reverse% &quot; t:term : term =&gt; do\n  let t ‚Üê Term.levelMVarToParam (‚Üê instantiateMVars (‚Üê Term.elabTerm t none))\n  return t.replaceLevel fun l ‚Ü¶ l.normalizeMax (Function.swap .max)\n\nend\n</code></pre></div>\n</div></div>\n<p>Adding <code>clean_universe_reverse%</code> to type signature and the body of defs works until <code>Œ¥Aux_toAlgHom</code> which wants <code>clean_universe%</code> and after that, these elab functions has little effect and are slower compared to master (where <code>clean_universe</code> weren't added to any of the defs above)</p>",
        "id": 496392619,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738086853
    },
    {
        "content": "<p>Between classes so I can‚Äôt really read or think. Does ‚Äúworks ‚Äú mean gets faster? Since the elaborator and the kernel have different association normal form conventions and the declaration you reference is the worst for the kernel in the file but is fine for the elaborator I wouldn‚Äôt be surprised by a phase transition in performance. </p>\n<p>Can you give more details on your investigations?</p>",
        "id": 496411573,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738093219
    },
    {
        "content": "<p>I plan on coming back to this but I need to figure out grading first. At worst, I will show up to office hours later today.</p>",
        "id": 496555305,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738159350
    },
    {
        "content": "<p>By \"works\" I meant that it does not get stuck in kernel. And I do not observe a huge increase in the other parts of elaboration.<br>\ne.g. in <code>CotangentSpace.compEquiv_symm_inr</code> it was 1.5s on elaboration of type signature, 1.4s on elaboration on proof body and 7.4s of kernel typechecking, and it became 1.4s, 1.4s, 0.3s after adding the elaboration command.<br>\nOr in <code>Œ¥Aux_toAlgHom</code> it is 0.6s, 4.9s, 9.6s in the start, 0.6s, 5.0s, 11.6s with <code>clean_universe_reverse% </code> and 0.6s, 5.6s, 1.0s with <code>clean_universe% </code>.</p>",
        "id": 496581422,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738166229
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kd\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">w</span>\n\n<span class=\"kd\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ≥</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚äï</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚äï</span><span class=\"w\"> </span><span class=\"n\">Œ≥</span>\n\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp.universes</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"c1\">-- foo.{u, v, w} (Œ± : Type u) (Œ≤ : Type v) (Œ≥ : Type w) : Foo.{max w v u}</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">where</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"bp\">‚äï</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"bp\">‚äï</span><span class=\"w\"> </span><span class=\"n\">Œ≥</span>\n\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp.universes</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"k\">#check</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"c1\">-- bar.{u, v, w} (Œ± : Type u) (Œ≤ : Type v) (Œ≥ : Type w) : Foo.{max (max w v) u}</span>\n</code></pre></div>\n<p>Should elaboration normalize the universes of the expected types of structure instances?</p>",
        "id": 496642644,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738184529
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> I'm hoping you can help here.</p>",
        "id": 496786115,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1738246314
    },
    {
        "content": "<p>My comment is slightly obtuse: </p>\n<ol>\n<li>should we normalize universes as the final step in elaboration? </li>\n<li>should the universe normal forms for the elaborator and kernel match? </li>\n</ol>\n<p>My opinion:</p>\n<ol>\n<li>Need to try it out to see if the penalty you pay each time you elaborate is worth the savings that unification gets</li>\n<li>Yes. I think this is uncontroversial. <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> already gave one suggestion in the ordinal thread.</li>\n</ol>",
        "id": 496787043,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738246523
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Universe-heterogeneous.20ordinal.20and.20cardinal.20relations/near/495607579\">#mathlib4 &gt; Universe-heterogeneous ordinal and cardinal relations @ üí¨</a></p>",
        "id": 496787293,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738246576
    },
    {
        "content": "<p>I could try out changes like this but today is another teaching from dawn to dusk.</p>",
        "id": 496788050,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738246749
    },
    {
        "content": "<p>Let me point out another behaviour that looks strange to me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">B</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">universes</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"c1\">-- Type (max u v)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- Type (max v u)</span>\n</code></pre></div>\n<p>I thought the universes are sorted alphabetically but then why is this sorted the other way around?<br>\nI ran into this while trying to speed up <code>AffineSpace.lean</code>.<br>\nIf one switches <code>u</code> and <code>v</code> in the snippet, then <code>u</code> and <code>v</code> will switch in both of the outputs too. So lean genuinely switches the universes instead of sorting them.</p>",
        "id": 497783450,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1738715292
    },
    {
        "content": "<p>If you use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">step</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isLevelDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>You can see where the two universe levels are swapped.</p>\n<p><code>Bar</code> gets elaborated as <code>Bar.{?u.34}</code> and <code>Foo</code> gets elaborated as<code>Foo.{?u.36, ?u.35}</code>. Then the types are unified, so <code>Type ?u.34 =?= Type (max ?u.36 ?u.35)</code>, which leads to the assignment <code>?u.34 := max ?u.35 ?u.36</code>. The variables get swapped because it sorts <code>?u.35</code> and <code>?u.36</code>.</p>",
        "id": 497799481,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738724764
    },
    {
        "content": "<p>So I got the total <code>type checking</code> down to 2.43s on my machine for the whole file by </p>\n<ol>\n<li>associating <code>max</code> to the the right for levels during normalization</li>\n<li>normalizing levels consistently during elaboration </li>\n<li>associating <code>max</code> to the right on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators#doc\">docs#Algebra.Generators</a></li>\n<li>replacing <code>u</code> with <code>z</code> for the names of declared levels for the \"deeper\" levels in <code>Generators</code></li>\n</ol>",
        "id": 497971914,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738785177
    },
    {
        "content": "<p>Currently on <code>master</code> is about 30s</p>",
        "id": 497972189,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738785287
    },
    {
        "content": "<p>I should clean up 1 and 2 and do a broader test of the effect on mathlib.</p>",
        "id": 497972387,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738785381
    },
    {
        "content": "<p>1+2 alone don't make a huge difference directly until you put in 4. (I am not sure how much 3 really matters because my process was not very scientific.)</p>",
        "id": 497972574,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738785464
    },
    {
        "content": "<p>4 is still deeply unsatisfying as a solution</p>",
        "id": 497972869,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738785581
    },
    {
        "content": "<p>And 4 alone is significantly worse than 1+2+4?</p>",
        "id": 497979824,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738788398
    },
    {
        "content": "<p>Still 15-16s</p>",
        "id": 497980588,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1738788714
    },
    {
        "content": "<p>Mild update: </p>\n<ul>\n<li>I reversed the association of max's in the elaborator and benchmarked the effects in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21684\">#21684</a> </li>\n<li>normalized levels after instantiating metavariables <a href=\"https://github.com/leanprover-community/mathlib4/pull/21714\">#21714</a></li>\n<li>then did both <a href=\"https://github.com/leanprover-community/mathlib4/pull/21722\">#21722</a> </li>\n</ul>\n<p>Observations: this is file is really an outlier.</p>",
        "id": 499335973,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1739397406
    },
    {
        "content": "<p>So for two of your experiments, you changed some general set-up overall and the only file which had a significant change was JacobZariski.lean ?</p>",
        "id": 499336967,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739397781
    },
    {
        "content": "<p>In two of them the only thing that really affected anything was the same change: use <code>max u (max v w)</code> instead of <code>max (u max v w)</code> during normalization in the elaborator. And the only thing it really affected was this file. Overall the impact was slightly negative. </p>\n<p>This tells me something about the design of this file is suboptimal compared to the remainder of the mathlib. Whenever I can breathe for a bit, I am going to poke around the kernel but I think the intuition that transparency is set too low resulting in default unfolding of large amounts of stuff is probably going to be the end conclusion regardless.</p>",
        "id": 499486506,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1739456724
    },
    {
        "content": "<p>But making <code>CotangentSpace</code> a <code>def</code> did not make the file faster at all, see <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/kernel.20universe.20normalization.20issue/near/497399181\">#lean4 &gt; kernel universe normalization issue @ üí¨</a>. Do you think that combining your kernel changes with making it a <code>def</code> is significantly better than your kernel changes with the current <code>abbrev</code>?</p>\n<p>Making <code>CotangentSpace</code> a def just means either duplicating a big chunk of tensor product and Kaehler differential API specialized to <code>CotangentSpace</code>, immediatly unfolding the definition at the beginning of most proofs or introducing many <code>erw</code>s. I think none of these are desirable.</p>\n<p>I totally understand why making definitions like <code>TensorProduct</code> as irreducible as possible is sensible, because here we never want to unfold the definition, but only work with the characterizing properties. But requiring that every type that is built on top of a tensor product can't be an <code>abbrev</code>, because of potential performance regressions, does not sound like a strategy that will scale.</p>",
        "id": 499492813,
        "sender_full_name": "Christian Merten",
        "timestamp": 1739458210
    },
    {
        "content": "<p>First, the changes to the elaborator do not result in a sufficient performance impact to really turn core's head. This is a low priority and I don't see anything we've learned here changing that. </p>\n<p>I think <code>def</code> + duplication is what where this will end up. It is the natural way. We are already in desperate need to better automation for this in many other settings. </p>\n<p>Has anyone attempted making <code>TensorProduct</code> completely <code>irreducible</code>?</p>",
        "id": 499494028,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1739458514
    },
    {
        "content": "<p>I got nerdsniped into thinking about this again. Maybe this <code>CotangentSpace</code> being a def is a red herring in the sense that it might be one cause of a slowdown, but not the main cause. I went back to my joke branch where there was only one universe (the joke branch gave a 60% speed-up but the file is still super-slow!), and chose a random slowish result (in this case <code>Œ¥Aux_toAlgHom</code>, line 269 or so) and tried to figure out why it was slow. The proof ends <code>rw [add_left_comm]; rfl</code> and the <code>rw</code> takes nearly half a second on my fast machine. The reason is that Lean seems to be going through some unification hell because the term it has before the rewrite, namely</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">‚ä¢</span><span class=\"w\"> </span><span class=\"n\">eval‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ¥Aux</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Q'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ¥Aux</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">      </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">linearCombination</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚áë</span><span class=\"o\">(</span><span class=\"n\">Œ¥Aux</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Q'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚àò</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">))</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚äó‚Çú</span><span class=\"o\">[</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)))</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ¥Aux</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"n\">aeval</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ¥Aux</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Q'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span>\n<span class=\"w\">      </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">linearCombination</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚áë</span><span class=\"o\">(</span><span class=\"n\">Œ¥Aux</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Q'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚àò</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">cotangentSpaceBasis</span><span class=\"bp\">.</span><span class=\"n\">repr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚äó‚Çú</span><span class=\"o\">[</span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)))</span>\n</code></pre></div>\n<p>, has some issues. The <code>Q.cotangentSpaceBasis.repr</code> term in there is carrying around a <code>TensorProduct.leftModule : Module T (T ‚äó[Q.toExtension.Ring] Œ©[Q.toExtension.Ring‚ÅÑS])</code>. But it's being fed a term of type <code>T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]</code>. Now it is true that <code>Q.toExtension.Ring = Q.Ring</code> by <code>rfl</code>, but not on reducible transparency. So what is happening in this proof is whenever Lean tries to do any arithmetic it is constantly having to check that the addition on <code>T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]</code> is equal to the addition on <code>T ‚äó[Q.toExtension.Ring] Œ©[Q.toExtension.Ring‚ÅÑS]</code> and it does this by unfolding all of the instances resulting in everything taking forever. Example of trace:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>                      [] [0.466879] rewrite [add_left_comm] ‚ñº\n                        [Meta.check] [0.458498] ‚úÖÔ∏è fun _a ‚Ü¶\n                              _a =\n                                Q.val n ‚Ä¢ (Œ¥Aux R Q) p +\n                                  ((aeval Q.val) p ‚Ä¢ (Œ¥Aux R Q') (f.val n) +\n                                    Q.val n ‚Ä¢\n                                      (Finsupp.linearCombination T (‚áë(Œ¥Aux R Q') ‚àò f.val))\n                                        (Q.cotangentSpaceBasis.repr (1 ‚äó‚Çú[Q.Ring] (D S Q.Ring) p))) ‚ñº\n                          [isDefEq] [0.056118] ‚úÖÔ∏è AddCommMonoid Q.toExtension.CotangentSpace =?= AddCommMonoid (T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]) ‚ñ∂\n                          [isDefEq] [0.047696] ‚úÖÔ∏è Module T Q.toExtension.CotangentSpace =?= Module T (T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]) ‚ñ∂\n                          [isDefEq] [0.047258] ‚úÖÔ∏è AddCommMonoid Q.toExtension.CotangentSpace =?= AddCommMonoid (T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]) ‚ñ∂\n                          [isDefEq] [0.042882] ‚úÖÔ∏è Module T Q.toExtension.CotangentSpace =?= Module T (T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]) ‚ñ∂\n                          [isDefEq] [0.042163] ‚úÖÔ∏è AddCommMonoid Q.toExtension.CotangentSpace =?= AddCommMonoid (T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]) ‚ñ∂\n                          [isDefEq] [0.046017] ‚úÖÔ∏è Module T Q.toExtension.CotangentSpace =?= Module T (T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS]) ‚ñ∂\n                          [isDefEq] [0.045918] ‚úÖÔ∏è Basis Q.vars T Q.toExtension.CotangentSpace =?= Basis Q.vars T Q.toExtension.CotangentSpace ‚ñ∂\n                          [isDefEq] [0.057254] ‚úÖÔ∏è Q.toExtension.CotangentSpace =?= T ‚äó[Q.Ring] Œ©[Q.Ring‚ÅÑS] ‚ñ∂\n</code></pre></div>\n<p>Note that <code>Q.toExtension.CotangentSpace</code> is an <code>abbrev</code> for <code>T ‚äó[Q.toExtension.Ring] Œ©[Q.toExtension.Ring‚ÅÑS]</code>. When typeclass inference can't see that the types are equal,  but it knows they must be because of some defeq abuse which it has picked up, then it has to do lots of very long checks checking that the typeclasses it finds on the two types match up. Is there a way of making these types more equaller?</p>",
        "id": 505890533,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742076928
    },
    {
        "content": "<p>Right now we have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Extension#doc\">docs#Algebra.Extension</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Extension</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- The underlying algebra of an extension. -/</span>\n<span class=\"w\">  </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">w</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">commRing</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">algebra‚ÇÅ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">algebra‚ÇÇ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">isScalarTower</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- A chosen (set-theoretic) section of an extension. -/</span>\n<span class=\"w\">  </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Ring</span>\n<span class=\"w\">  </span><span class=\"n\">algebraMap_œÉ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>with this type embedded as a field, and then <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators.toExtension#doc\">docs#Algebra.Generators.toExtension</a> taking <code>(P : Generators R S)</code> and defined as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simps</span><span class=\"kd\">]</span>\n<span class=\"kn\">noncomputable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">toExtension</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Extension</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">Ring</span>\n<span class=\"w\">  </span><span class=\"n\">œÉ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">œÉ</span>\n<span class=\"w\">  </span><span class=\"n\">algebraMap_œÉ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>so we have <code>P.toExtension.Ring = P.Ring</code> but <code>with_reducible_and_instance rfl</code> doesn't prove it. So, as far as typeclass inference is concerned, these are two different rings and any defeq abuse will be very costly.</p>",
        "id": 505892211,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742078443
    },
    {
        "content": "<p>Also, woe betide you if you don't remember <code>P.toExtension.{u}</code> because then there will be another very long search as Lean tries to figure out the most general universe variable which makes everything work.</p>",
        "id": 505892345,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742078563
    },
    {
        "content": "<p>Similarly the lemma <code>map_comp_cotangentComplex_baseChange</code> is slow even with one universe; the proof is <code>ext; simp</code> but the <code>simp</code> takes over 5 seconds on my machine, and most of it is spent proving that things which look syntactically equal are defeq. However if you put pp.all on (making the terms over 1000 lines long) and wade through the diff you see</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code>10,16c10,13\n<span class=\"gd\">&lt;                     (@Algebra.Extension.Ring.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥</span>\n<span class=\"gd\">&lt;                       (@Algebra.Generators.toExtension.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P))</span>\n<span class=\"gd\">&lt;                     (@CommRing.toCommSemiring.{u}</span>\n<span class=\"gd\">&lt;                       (@Algebra.Extension.Ring.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥</span>\n<span class=\"gd\">&lt;                         (@Algebra.Generators.toExtension.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P))</span>\n<span class=\"gd\">&lt;                       (@Algebra.Extension.commRing.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥</span>\n<span class=\"gd\">&lt;                         (@Algebra.Generators.toExtension.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P)))</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt;                     (@Algebra.Generators.Ring.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P)</span>\n<span class=\"gi\">&gt;                     (@CommRing.toCommSemiring.{u} (@Algebra.Generators.Ring.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P)</span>\n<span class=\"gi\">&gt;                       (@MvPolynomial.instCommRingMvPolynomial.{u, u} R</span>\n<span class=\"gi\">&gt;                         (@Algebra.Generators.vars.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P) inst‚úù‚Å∂))</span>\n18,20c15\n<span class=\"gd\">&lt;                     (@KaehlerDifferential.{u, u} R</span>\n<span class=\"gd\">&lt;                       (@Algebra.Extension.Ring.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥</span>\n<span class=\"gd\">&lt;                         (@Algebra.Generators.toExtension.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P))</span>\n<span class=\"gs\">---</span>\n<span class=\"gi\">&gt;                     (@KaehlerDifferential.{u, u} R (@Algebra.Generators.Ring.{u, u, u} R S inst‚úù‚Å∂ inst‚úù‚Åµ inst‚úù‚Å¥ P)</span>\n</code></pre></div>\n<p>(and hundreds more of these): again it's the case that <code>Algebra.Extension.Ring</code> and <code>Algebra.Generators.Ring</code> are somehow being unified by defeq abuse and this is throwing typeclass inference into chaos (it proves that e.g. the ring instances on these two types match up by completely taking everything apart, which is very time-consuming).</p>",
        "id": 505893790,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742079720
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/505890533\">said</a>:</p>\n<blockquote>\n<p>Is there a way of making these types more equaller?</p>\n</blockquote>\n<p>I tried with a unification hint in <a href=\"https://github.com/leanprover-community/mathlib4/pull/22975\">#22975</a>, but the performance did not improve.</p>",
        "id": 505956064,
        "sender_full_name": "Christian Merten",
        "timestamp": 1742130787
    },
    {
        "content": "<p>Christian is visiting London and we revisited this issue. Turns out that on master <code>P.toExtension.Ring = P.Ring</code> is true by <code>rfl</code> but not <code>with_reducible rfl</code> (so typeclass inference is free to assign ring structures which might be different but aren't, and then spend ages checking that they are). And on the unification hint branch <a href=\"https://github.com/leanprover-community/mathlib4/pull/22975\">#22975</a> they <em>are</em> equal by <code>with_reducible rfl</code>, but this doesn't solve the problem because apparently (according to people who can read the source code) this only works because the usual <code>with_reducible rfl</code> check fails and only <em>then</em> does Lean check for unification hints. So the simp calls are still slow because they work slowly instead of failing, meaning that unification hints never kick in!</p>",
        "id": 508596588,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743101622
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513680344\">said</a>:</p>\n<blockquote>\n<p>Plus: Is there any case of a universe level that's used only in the body of a declaration that couldn't just be replaced by <code>0</code>?</p>\n</blockquote>\n<p>Yes. In fact Mathlib's slowest file, <code>JacobiZariski.lean</code>, is full of them (and indeed someone suggested to me that perhaps one reason that this file is so slow is that every time a user forgets to explicitly state which universe they're using might cause a huge time hit). The culprits are declarations such as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Extension#doc\">docs#Algebra.Extension</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators#doc\">docs#Algebra.Generators</a> . Mathematically the latter definition is all about presenting ring extensions, and sometimes this is done under finiteness conditions where you want <code>vars</code> just to be <code>Fin n</code> for some appropriate <code>n</code>, which is of course in <code>Type 0</code>, but sometimes you are doing some universal argument and you want <code>vars</code> to be equal to the type underlying some ring in the argument in which case it could well have Type <code>u</code>.</p>",
        "id": 514076519,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745489406
    },
    {
        "content": "<p>Why can't <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Extension.Ring#doc\">docs#Algebra.Extension.Ring</a> live in <code>Type (max u v)</code>?</p>",
        "id": 514081858,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745490490
    },
    {
        "content": "<p>Ansering the analogous question about Generators: because sometimes you want <code>vars</code> to be <code>Fin n</code> or whatever and this lives in <code>Type 0</code>. And no you don't want it to be <code>uLift (Fin n)</code> because that just introduces a lot of noise.</p>",
        "id": 514089122,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745492765
    },
    {
        "content": "<p>But why? Surely any indexing type is just as good as another one</p>",
        "id": 514090192,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745492915
    },
    {
        "content": "<p>What is it about <code>Fin n</code> that's less noisy than <code>ULift (Fin n)</code>?</p>",
        "id": 514090568,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745492967
    },
    {
        "content": "<p>For your Ring example, this would be like saying \"any ring isomorphic to the ring you want would be just as good as the one you want\" so this is like saying \"adding loads of RingEquivs into a file which aren't currently there and then fixing all the proofs will be just as good as not having them there\" which is clearly false.</p>",
        "id": 514090889,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745493007
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/21165\">#21165</a> I changed all universes in JacobiZariski to be the same universe and I got <a href=\"https://github.com/leanprover-community/mathlib4/pull/21165#issuecomment-2618740450\">a 61% speedup</a>. Universes are definitely one of the big problems in that file but I don't think that people are prepared to pay the price which you want them to pay. You could try the refactor yourself I guess!</p>",
        "id": 514092034,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745493157
    },
    {
        "content": "<p>Sure, for a ring I would understand, but for an indexing type?</p>",
        "id": 514092053,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745493159
    },
    {
        "content": "<p>And follow up question on the ring example: Why is <code>Algebra.Extension.Ring</code> a field of <code>Algebra.Extension</code>, rather than an index?</p>",
        "id": 514092784,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745493247
    },
    {
        "content": "<p>Sometimes the indexing type is one of the rings involved, which would then have to become ulift of it, so again you are going to get a lot of noise. Regarding the design decisions, I quizzed <span class=\"user-mention\" data-user-id=\"648495\">@Christian Merten</span> about this when he was in London last month and he tried a different design but ran into problems; I think he would be better placed to answer this than me.</p>",
        "id": 514093280,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745493309
    },
    {
        "content": "<p>In my mind, either you care about the defeqs and that type should be an index, or you don't care about the defeqs and that type can be ulifted however the definition requires it to. Currently, you're saying \"We care about the defeqs, but also it's not an index\"</p>",
        "id": 514093602,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745493352
    },
    {
        "content": "<p>Mario suggested that these random extra universes in structure fields were a code smell and that we should try and rip them out altogether, but I think this is what Christian tried and failed to do.</p>",
        "id": 514093814,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745493376
    },
    {
        "content": "<p>I stand with Mario here. I guess I will go bother Christian about this</p>",
        "id": 514093982,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745493436
    },
    {
        "content": "<p>It's one thing \"standing with Mario\" but unfortunately it's quite another to find a design which works and which doesn't have the smell.</p>",
        "id": 514094525,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745493616
    },
    {
        "content": "<p>Let me go through the mathematics of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators#doc\">docs#Algebra.Generators</a> to at least give you a feel for the issue. I'll simplify a little by dropping the section <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>œÉ</mi></mrow><annotation encoding=\"application/x-tex\">\\sigma</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">œÉ</span></span></span></span>, that is not important for us. What is happening is that we have two commutative rings <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> is an <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span>-algebra, so we have some fixed ring homomorphism from <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span> to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span>. Sometimes in commutative algebra it becomes necessary to have certain \"presentations\" of this homomorphism, i.e. you want to write <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>‚Üí</mo><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">R\\to S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">‚Üí</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> as a composite <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>‚Üí</mo><mi>R</mi><mo stretchy=\"false\">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy=\"false\">]</mo><mo>‚Üí</mo><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">R\\to R[X_i]\\to S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">‚Üí</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">‚Üí</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo stretchy=\"false\">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">R[X_i]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span> is a polynomial ring in variables <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">X_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> indexed by <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6595em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> in an indexing set <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span>, and the Lean issue is the universe which <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span> lives in. Often you will not want just one presentation of the ring homomorphism, you want to be able to change the presentation on the fly during a proof (this is why it's a structure, not a class). Situations which I could imagine being needed in the real world: <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span> could be finite (if <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> is finitely-presented) or it could be <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> (in <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span>'s universe) or it could be <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>‚àê</mo><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">R\\coprod S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop op-symbol small-op\" style=\"position:relative;top:0em;\">‚àê</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> (in the max of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span>'s universes) or it could be an arbitrary type which we get from the axiom of choice (and then maybe we don't even have much control over it, it could end up as <code>max (max u (v+1)) v)</code> or whatever, depending on how much category theory was used to construct the index set).</p>",
        "id": 514096339,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745494193
    },
    {
        "content": "<p>One natural attempt to fix this is to make <code>vars</code> (this is <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span> in the previous post) an input to the structure rather than a field but I think this is precisely what Christian tried to do and had problems with.</p>",
        "id": 514097222,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745494450
    },
    {
        "content": "<p>17 messages were moved here from #<strong>mathlib4&gt;Task 26: Replace Type u by Type* wherever possible</strong> by <span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span>.</p>",
        "id": 514128774,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745501922
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/514096339\">said</a>:</p>\n<blockquote>\n<p>ou want to write <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>‚Üí</mo><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">R\\to S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">‚Üí</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> as a composite <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo>‚Üí</mo><mi>R</mi><mo stretchy=\"false\">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy=\"false\">]</mo><mo>‚Üí</mo><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">R\\to R[X_i]\\to S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">‚Üí</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">‚Üí</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi><mo stretchy=\"false\">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">R[X_i]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span> is a polynomial ring in variables <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding=\"application/x-tex\">X_i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3117em;\"><span style=\"top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">i</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> indexed by <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi></mrow><annotation encoding=\"application/x-tex\">i</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6595em;\"></span><span class=\"mord mathnormal\">i</span></span></span></span> in an indexing set <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span>, and the Lean issue is the universe which <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>I</mi></mrow><annotation encoding=\"application/x-tex\">I</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span></span></span></span> lives in.</p>\n</blockquote>\n<p>Maybe we can try force <code>I</code> be a <code>Set S</code>, just like what <code>Module.rank</code> do.</p>",
        "id": 514148302,
        "sender_full_name": "Jz Pan",
        "timestamp": 1745506167
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/near/514090568\">said</a>:</p>\n<blockquote>\n<p>What is it about <code>Fin n</code> that's less noisy than <code>ULift (Fin n)</code>?</p>\n</blockquote>\n<p>There are a lot of API on tuples (<code>Fin n -&gt; R</code>) that is not there for <code>ULift (Fin n)</code>. Or are you suggesting we develop them for <code>ULift (Fin n)</code> as well?</p>",
        "id": 514149742,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1745506448
    },
    {
        "content": "<p>in the ongoing work of <span class=\"user-mention\" data-user-id=\"406490\">@Mar√≠a In√©s de Frutos Fern√°ndez</span> and me on polynomial laws, we had to consider (partial) presentations of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span>-algebras <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span>, namely <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span>-algebra morphisms <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">‚Ä≤</mo></msup><mo>‚Üí</mo><mi>S</mi></mrow><annotation encoding=\"application/x-tex\">S&#x27; \\to S</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7519em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7519em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">‚Ä≤</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">‚Üí</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span></span></span></span> where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">‚Ä≤</mo></msup></mrow><annotation encoding=\"application/x-tex\">S&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7519em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7519em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">‚Ä≤</span></span></span></span></span></span></span></span></span></span></span></span> is in the same universe as <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span> and whose image contains given elements. Our solution was indeed to take for <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mi>S</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">‚Ä≤</mo></msup></mrow><annotation encoding=\"application/x-tex\">S&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7519em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7519em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">‚Ä≤</span></span></span></span></span></span></span></span></span></span></span></span> a polynomial algebra over <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mrow><mi mathvariant=\"normal\">F</mi><mi mathvariant=\"normal\">i</mi><mi mathvariant=\"normal\">n</mi></mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">\\mathrm{Fin} n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">Fin</span></span><span class=\"mord mathnormal\">n</span></span></span></span> for a given integer <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span>. I have tried using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Small#doc\">docs#Small</a> but this wasn't as easy.</p>",
        "id": 514228822,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1745528674
    }
]