[
    {
        "content": "<p>I discovered that there was a flexible linter, and it triggers on this example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">flexible</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"n\">field_simp</span>\n<span class=\"w\">  </span><span class=\"n\">ring</span>\n\n<span class=\"w\">  </span><span class=\"n\">ring</span>\n</code></pre></div>\n<p>But I would have thought that <code>field_simp</code> was a flexible tactic :</p>\n<blockquote>\n<p>a tactic like <code>simp</code> acts on a wide variety of inputs and returns an output that is possibly unpredictable: if later modifications adds a <code>simp</code>-lemma or some internals of <code>simp</code> changes, the output of <code>simp</code> may change as well. Such a tactic is <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Tactic/Linter/FlexibleLinter.html#Mathlib.Linter.linter.flexible\">flexible</a>. Other examples are <code>split</code>, <code>abel</code>, <code>norm_cast</code>, ...</p>\n</blockquote>\n<p>Am I missing something?</p>",
        "id": 537352811,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1756841943
    },
    {
        "content": "<p>I guess previous discussion on this <a href=\"#narrow/channel/287929-mathlib4/topic/flexible.20vs.20rigid.20tactics\">here</a>, I think there was debate on this.</p>",
        "id": 537353537,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1756842269
    },
    {
        "content": "<p>Thanks for the pointer. I am still not sure why the linter triggers though. The debate in the thread seems to be more about whether we should allow <code>field_simp</code> to be followed by rigid tactics. Then again I noticed that <code>field_simp</code> was recently rewritten to not rely on <code>simp</code> anymore, which probably makes this debate kind of obsolete? But I don't see the difference between <code>field_simp</code> and <code>ring_nf</code> which would make one the latter flexible but not the former.</p>",
        "id": 537356802,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1756843729
    },
    {
        "content": "<p>Note this naming in the linter that might cause some confusion:</p>\n<ul>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Linter.flexible%3F#doc\">docs#Mathlib.Linter.flexible?</a> returns true for only <code>simp</code> and <code>simp_all</code> without <code>only</code></li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Linter.Flexible.flexible#doc\">docs#Mathlib.Linter.Flexible.flexible</a> defines what is allowed to follow a flexible tactic, including <code>omega</code>, <code>linarith</code>, etc. </li>\n</ul>\n<p>Currently only <code>simp</code> or <code>simp_all</code> can \"start\"  a check of the flexible linter. For your example it sees <code>simp</code> followed by <code>field_simp</code>, which is not included in <code>Mathlib.Linter.Flexible.flexible</code>, so triggers a failure.</p>",
        "id": 537357437,
        "sender_full_name": "Chris Henson",
        "timestamp": 1756843999
    },
    {
        "content": "<p>(perhaps these should have more distinct names like <code>flexible?</code> and <code>follow_flexible?</code>)</p>",
        "id": 537358049,
        "sender_full_name": "Chris Henson",
        "timestamp": 1756844294
    },
    {
        "content": "<p>My question I think is then why isn't <code>field_simp</code> in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Linter.Flexible.flexible#doc\">docs#Mathlib.Linter.Flexible.flexible</a>? Looking more closely at this it looks like the reason is that <code>field_simp</code> is not a finishing tactic nor outputting a normal form.</p>",
        "id": 537358608,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1756844611
    },
    {
        "content": "<p>I think that for a few of the questions in this thread, the answer is simply that the linter has not been used much.</p>",
        "id": 537363736,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756846945
    },
    {
        "content": "<p>When the linter was first written, there were already thousands of exceptions in mathlib.  Hence, there was not incentive to <em>really</em> flag all flexible tactics, because already flagging <code>simp</code> was more than enough!</p>",
        "id": 537363896,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756847008
    },
    {
        "content": "<p>So, the linter was added to mathlib, but off by default.  This meant that it did not get feedback on bugs and improvements.</p>",
        "id": 537364038,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756847070
    },
    {
        "content": "<p>Specifically with <code>field_simp</code>, I think that the tactic itself used to be one that everyone hoped was better, so again there was little incentive to change its \"flexible\" status.</p>",
        "id": 537364174,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756847125
    },
    {
        "content": "<p>Now, with the recent improvements, it probably makes sense to make it flexible.</p>",
        "id": 537364216,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756847143
    },
    {
        "content": "<p>I am not sure if it is normalising enough to consider it stopping, since I have not actually looked at the implementation.</p>",
        "id": 537364270,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1756847167
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover-community/mathlib4/pull/29027\">#29027</a></p>",
        "id": 537407908,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756880600
    },
    {
        "content": "<p>I propose marking field_simp as flexible and normalising</p>",
        "id": 537407951,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756880632
    },
    {
        "content": "<p>(And can write more in a week, if you like.)</p>",
        "id": 537407993,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1756880656
    }
]