[
    {
        "content": "<p>Hello! </p>\n<p>While working on my PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/32152\">32152</a><br>\nand after applying the reviewer's suggestion which registering the finiteness proof  of abelian simple group as an instance since <code>Finite</code> is  itself a type class, I noticed <code>aesop</code> in the lemma in <code>NumberTheory/ModularForms/Cusps</code> failed: </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">strictWidthInfty_nonneg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">ùí¢</span><span class=\"bp\">.</span><span class=\"n\">strictWidthInfty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">strictWidthInfty</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span>\n</code></pre></div>\n<p>with error report </p>\n<blockquote>\n<p>split failed:<br>\nfailed to synthesize DiscreteTopology ‚Ü•ùí¢.strictPeriods</p>\n</blockquote>\n<p>I guess it is because the definition of <code>strictWidthInfty</code> branches on <code>if h : DiscreteTopology ùí¢.strictPeriods then ... else 0</code>, and relying on automation to split this seems quite sensitive to the typeclass environment?</p>\n<p>Replacing the proof with an explicit case split makes it stable and mathlib build successfully again.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">strictWidthInfty_nonneg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">ùí¢</span><span class=\"bp\">.</span><span class=\"n\">strictWidthInfty</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">unfold</span><span class=\"w\"> </span><span class=\"n\">strictWidthInfty</span>\n<span class=\"w\">  </span><span class=\"n\">by_cases</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DiscreteTopology</span><span class=\"w\"> </span><span class=\"n\">ùí¢</span><span class=\"bp\">.</span><span class=\"n\">strictPeriods</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Would it make sense to patch the lemma in this direction?<br>\nI‚Äôm very happy to open a small PR if we agree it‚Äôs preferable.</p>\n<p>Thanks!</p>\n<p>Add <span class=\"user-mention\" data-user-id=\"481963\">@David Loeffler</span>  as the author of <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/NumberTheory/ModularForms/Cusps.lean\">NumberTheory/ModularForms/Cusps</a><br>\nAdd <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> as my <a href=\"https://github.com/leanprover-community/mathlib4/pull/32152\">PR</a> viewer</p>",
        "id": 560673987,
        "sender_full_name": "Lingyin Luo",
        "timestamp": 1764279494
    },
    {
        "content": "<p>For context, this PR adds <code>instance [CommGroup Œ±] [IsSimpleGroup Œ±] : Finite Œ±</code>.<br>\nI think this is not a good instance for performance reasons.</p>",
        "id": 560692712,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1764293485
    },
    {
        "content": "<p>I wouldn't have any great objection to patching this one specific proof of <code>strictWidthInfty_nonneg</code>; but it seems a bit worrying that 32152 causes automation that worked before to stop working, and makes me concerned that it might also be impacting other code elsewhere.</p>",
        "id": 560715099,
        "sender_full_name": "David Loeffler",
        "timestamp": 1764311816
    },
    {
        "content": "<p>I also just made this remark on the PR, but <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> do you think a scoped instance would be appropriate? Or should it just be a theorem?</p>",
        "id": 560718973,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764314251
    },
    {
        "content": "<p>Perhaps another reason why it's not a good instance is -- although it's true, can one ever imagine it being useful in practice? And conversely can one ever imagine it being misleading to typeclass inference? Maybe it should just have low priority? Right now we might be a victim of \"defined late on and therefore tried first\".</p>",
        "id": 560738177,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764321348
    },
    {
        "content": "<p>This should definitely not be a global instance! It will fire on every single type, and initial searches for <code>CommGroup</code> structures..</p>",
        "id": 560749972,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1764325102
    },
    {
        "content": "<p>For motivation of this PR : it comes from an exercise in <em>Algebra</em> Dummit‚ÄìFoote 3.4.1, where the isomorphism between a nontrivial abelian simple group and <code>ZMod p</code> is stated with the explicit remark <em>not</em> to assume finiteness. This made me realise that the finiteness can actually be derived from the assumptions, which is why I added the corresponding lemma in mathlib.</p>",
        "id": 560750697,
        "sender_full_name": "Lingyin Luo",
        "timestamp": 1764325356
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/aesop.20failed.20in.20NumberTheory.2FModularForms.2FCusps/near/560718973\">said</a>:</p>\n<blockquote>\n<p>should it just be a theorem?</p>\n</blockquote>\n<p>IMO yes, it should just be a theorem. Mathematically, this is not the sort of inference one is expecting to happen automatically.</p>",
        "id": 560751199,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1764325534
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"948789\">Lingyin Luo</span> <a href=\"#narrow/channel/287929-mathlib4/topic/aesop.20failed.20in.20NumberTheory.2FModularForms.2FCusps/near/560750697\">said</a>:</p>\n<blockquote>\n<p>For motivation of this PR : it comes from an exercise in <em>Algebra</em> Dummit‚ÄìFoote 3.4.1</p>\n</blockquote>\n<p>Sure -- we understand the reason why we might want it to be a theorem in mathlib; the discussion here is a technical non-mathematical question about whether we want to add the theorem to the typeclass inference system by upgrading it from a <code>theorem</code> to an <code>instance</code> (with the answer being that we probably don't).</p>",
        "id": 560761338,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1764328625
    }
]