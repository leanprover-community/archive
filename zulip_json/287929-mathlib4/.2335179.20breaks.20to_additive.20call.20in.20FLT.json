[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"c1\">--import Mathlib.Algebra.Group.End -- uncomment this to break `to_additive`</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Î¹â‚</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Râ‚</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î¹â‚</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î¹â‚</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Râ‚</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MulEquiv</span><span class=\"bp\">.</span><span class=\"n\">restrictedProductCongrLeft'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î¹â‚</span><span class=\"w\"> </span><span class=\"bp\">â‰ƒ</span><span class=\"w\"> </span><span class=\"n\">Î¹â‚</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î¹â‚</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Râ‚</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">â‰ƒ*</span><span class=\"w\"> </span><span class=\"n\">Râ‚</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>On v4.28.0 <code>to_additive</code> on (a variant of) this definition from FLT breaks. The Xena minimising team has isolated the problem as being the line</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">to_additive_dont_translate</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Perm</span><span class=\"w\"> </span><span class=\"n\">Equiv</span>\n</code></pre></div>\n<p>added in <a href=\"https://github.com/leanprover-community/mathlib4/pull/35179\">#35179</a> and in particular it's the attribute on the <code>Equiv</code>. <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> do you know what we should be doing here? The FLT bump to v4.28.0 is <a href=\"https://github.com/ImperialCollegeLondon/FLT/pull/859\">FLT#859</a> and the issue is in the file <code>FLT/Mathlib/Topology/Algebra/RestrictedProduct/Equiv.lean</code> but I'm happy to fix it myself if someone can explain what we should be doing. The actual FLT declaration which is currently being manually to_additivised is an isomorphism of restricted products of monoids:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">MulEquiv</span><span class=\"bp\">.</span><span class=\"n\">restrictedProductCongrLeft'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î¹â‚</span><span class=\"w\"> </span><span class=\"bp\">â‰ƒ</span><span class=\"w\"> </span><span class=\"n\">Î¹â‚‚</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ“•â‚‚</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">ğ“•â‚</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">Î Ê³</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Râ‚</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Aâ‚</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"bp\">_</span><span class=\"o\">[</span><span class=\"n\">ğ“•â‚</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">â‰ƒ*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">Î Ê³</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Râ‚</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">Aâ‚</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">)]</span><span class=\"bp\">_</span><span class=\"o\">[</span><span class=\"n\">ğ“•â‚‚</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 574821758,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1771535139
    },
    {
        "content": "<p>FYI, I've got <a href=\"https://github.com/leanprover-community/mathlib4/pull/35546\">#35546</a> checking to see if removing <code>Equiv</code> from that line doesn't break mathlib.</p>",
        "id": 574821921,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1771535218
    },
    {
        "content": "<p>Thanks for investigating!</p>",
        "id": 574822022,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1771535254
    },
    {
        "content": "<p>here's some trace</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[translate_detail] attributes: []; reorder arguments: none\n[translate_detail] The name restrictedProductCongrLeft' splits as [restricted, Product, Congr, Left']\n[translate_detail] visiting MulEquiv.restrictedProductCongrLeft'\n[translate_detail] âœ…ï¸ translating the value fun {Î¹â‚} {Râ‚} [(i : Î¹â‚) â†’ Monoid (Râ‚ i)] e i =&gt; sorry â–¼\n  [] âœ…ï¸ replacing at sorry â–¼\n    [] âœ…ï¸ replacing at Lean.Name\n    [] âœ…ï¸ replacing at Râ‚ i â‰ƒ* Râ‚ (e.symm i) â–¼\n      [] changing MulEquiv to AddEquiv\n      [] âœ…ï¸ replacing at e.symm i â–¶\n      [] âœ…ï¸ replacing at (instâœ i).toMulOneClass.toMul â–¶\n      [] âœ…ï¸ replacing at (instâœ (e.symm i)).toMulOneClass.toMul â–¼\n        [] The application of MulOne.toMul contains the fixed type Equiv so it is not changed.\n        [] âœ…ï¸ replacing at (instâœ (e.symm i)).toMulOneClass.toMulOne â–¶\n    [] âœ…ï¸ replacing at false\n    [] âœ…ï¸ replacing at `external:file:///MathlibDemo/MathlibDemo.lean.12.29.12.34.29.34._sorry._@.external:file:///MathlibDemo/MathlibDemo.lean.3413694690._hygCtx._hyg.32 â–¶\n  [] âœ…ï¸ replacing at Monoid (Râ‚ i) â–¶\n[translate_detail] âœ…ï¸ translating the type {Î¹â‚ : Type u_1} â†’\n      {Râ‚ : Î¹â‚ â†’ Type u_2} â†’ [inst : (i : Î¹â‚) â†’ Monoid (Râ‚ i)] â†’ (e : Î¹â‚ â‰ƒ Î¹â‚) â†’ (i : Î¹â‚) â†’ Râ‚ i â‰ƒ* Râ‚ (e.symm i) â–¶\n</code></pre></div>",
        "id": 574822822,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1771535575
    },
    {
        "content": "<p>the application not getting translated is <code>@MulOne.toMul (Râ‚ (e.symm i)) (instâœ (e.symm i)).toMulOneClass.toMulOne</code></p>",
        "id": 574823027,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1771535660
    },
    {
        "content": "<p>and then a bunch of other forgetful inheritance below that too</p>",
        "id": 574823087,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1771535688
    },
    {
        "content": "<p>As <span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> observed, the problem is that <code>to_additive</code> looks inside <code>Râ‚ (e.symm i)</code> in order to determine whether to translate the constant. Then it finds the constant <code>Equiv</code> somewhere in <code>e.symm i</code>, which stops it from translating.</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/35546\">#35546</a> has now been merged with removes the <code>to_additive_dont_translate</code> annotation from <code>Equiv</code>, so the original example should now work again.</p>\n<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/35549\">#35549</a> I've made a fix for the underlying problem, namely that when looking in <code>Râ‚ (e.symm i)</code>, <code>to_additive</code> should never have looked inside the argument of <code>Râ‚</code> in the first place.</p>",
        "id": 574850446,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771550563
    },
    {
        "content": "<p>Once more for the emojibot: <a href=\"https://github.com/leanprover-community/mathlib4/pull/35549\">#35549</a></p>",
        "id": 574886269,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1771575546
    }
]