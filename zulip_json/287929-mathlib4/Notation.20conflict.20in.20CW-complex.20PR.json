[
    {
        "content": "<p>I've been working with <span class=\"user-mention\" data-user-id=\"559197\">@E. Dean Young</span> on Whitehead theorem and we are very close to finishing the <a href=\"https://github.com/leanprover-community/mathlib4/pull/12502#discussion_r1745581711\">PR that defines relative CW-complexes</a>.</p>\n<p>We (<span class=\"user-mention\" data-user-id=\"387244\">@YaÃ«l Dillies</span> <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span>) think the following definitions are useful more generally than just for CW-complexes and we want to move them to <code>Topology/Category/TopCat/Basic.lean</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The `n`-sphere is the set of points in â„â¿âºÂ¹ whose norm equals `1`,</span>\n<span class=\"sd\">endowed with the subspace topology. -/</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sphere</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">â„¤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopCat</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">TopCat</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">ULift</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Metric</span><span class=\"bp\">.</span><span class=\"n\">sphere</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">â„</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"sd\">/-- The `n`-disk is the set of points in â„â¿ whose norm is at most `1`,</span>\n<span class=\"sd\">endowed with the subspace topology. -/</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">disk</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">â„¤</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopCat</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">TopCat</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">ULift</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Metric</span><span class=\"bp\">.</span><span class=\"n\">closedBall</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">â„</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">toNat</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>However, doing so results in a conflict between the <a href=\"https://github.com/leanprover-community/mathlib4/blob/2eb00cae7edccf4e54238db2cb4b0a7dff59fbdd/Mathlib/Analysis/InnerProductSpace/Basic.lean#L85\">Lean-3-style notation <code>âŸªx, yâŸ«_ğ•œ</code> for inner product</a> and the (Lean 4) <a href=\"https://github.com/leanprover-community/mathlib4/blob/2eb00cae7edccf4e54238db2cb4b0a7dff59fbdd/Mathlib/Topology/Sheaves/Presheaf.lean#L113\">notation <code>x |_â‚— U âŸªeâŸ«</code> for <code>TopCat.Presheaf.restrict</code></a>, and hence a syntax error in line 125 of <a href=\"https://github.com/leanprover-community/mathlib4/blob/2eb00cae7edccf4e54238db2cb4b0a7dff59fbdd/Mathlib/Topology/Sheaves/Presheaf.lean#L125\"><code>Topology/Sheaves/Presheaf.lean</code></a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|_â‚—</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"bp\">âŸª</span><span class=\"n\">e</span><span class=\"bp\">âŸ«</span>\n<span class=\"w\">        </span><span class=\"c1\">-- ^ unexpected token 'âŸ«'; expected ','</span>\n</code></pre></div>\n<p>These two notations are simultaneously in effect thanks to the import links shown below, where the thick red link is new, needed for the <a href=\"https://github.com/leanprover-community/mathlib4/blob/2eb00cae7edccf4e54238db2cb4b0a7dff59fbdd/Mathlib/Analysis/InnerProductSpace/PiL2.lean#L100\"><code>EuclideanSpace</code></a> in the definition of <code>sphere</code> and <code>disk</code>.</p>\n<p><a href=\"/user_uploads/3121/CO-ND88z_KlhNekpjMSgqJYF/20240909_import_links_annotated.png\">20240909_import_links_annotated.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/CO-ND88z_KlhNekpjMSgqJYF/20240909_import_links_annotated.png\" title=\"20240909_import_links_annotated.png\"><img data-original-dimensions=\"1532x827\" src=\"/user_uploads/thumbnail/3121/CO-ND88z_KlhNekpjMSgqJYF/20240909_import_links_annotated.png/840x560.webp\"></a></div><p>I tried making the Lean-3-style notation <code>âŸªx, yâŸ«_ğ•œ</code> local, but this leads to more errors and I'm reluctant to modify existing code unrelated to CW-complexes.</p>\n<p>(There is also a conflict in <code>Topology/Category/TopCat/Limits/Basic.lean</code> where the tactic <code>by continuity</code> presumably gets overwhelmed by newly imported lemmas. This <a href=\"https://github.com/leanprover-community/mathlib4/pull/12502/commits/6ed65746447583d849c1af5cb71820d43284885d\">can be fixed</a> by using the lemma <code>continuous_const</code> instead of the tactic.)</p>\n<p>Could anyone help us decide the best way to resolve these conflicts? Thank you!</p>",
        "id": 468847729,
        "sender_full_name": "Jiazhen Xia",
        "timestamp": 1725898124
    },
    {
        "content": "<p>I'm not sure what the issue is, but just FYI <code>notation3</code> incidentally has a <code>3</code>, and it does not have any relationship to Lean 3 anymore. For simple notations like these, <code>notation</code> and <code>notation3</code> are the same, except <code>notation3</code> creates better pretty printers. (I'm hoping to see this functionality incorporated into <code>notation</code> at some point.)</p>",
        "id": 468864908,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725901811
    },
    {
        "content": "<p>Here's a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> of the parsing conflict:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">Notation3</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span>\n\n<span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"âŸª\"</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"s2\">\", \"</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"s2\">\"âŸ«_\"</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span>\n<span class=\"kn\">notation</span><span class=\"o\">:</span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"s2\">\" |_â‚— \"</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"s2\">\" âŸª\"</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"s2\">\"âŸ« \"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">|_â‚—</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">âŸª</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">âŸ«</span>\n<span class=\"w\">                </span><span class=\"c1\">--^ unexpected token 'âŸ«'; expected ','</span>\n</code></pre></div>",
        "id": 468866416,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725902182
    },
    {
        "content": "<p>Changing the first <code>:max</code> on the first notation to <code>:lead</code> seems to fix it. This means \"almost highest precedence, but can't be used as a function argument without parentheses\". The highest defined precedences in order go <code>lead</code>, <code>arg</code>, <code>max</code>.</p>",
        "id": 468867386,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725902442
    },
    {
        "content": "<p>I'm not sure why this works though! I believe the only thing that would break is that you need to write <code>f (âŸªv,wâŸ«_k)</code> instead of <code>f âŸªv,wâŸ«_k</code>.</p>",
        "id": 468867732,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725902535
    },
    {
        "content": "<p>Oof, we <em>really</em> need a test file with <code>import Mathlib</code> that exercises all the notation, and somehow in CI enforce that people who add new notation exercise that notation in the test file!</p>",
        "id": 469018970,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725955165
    },
    {
        "content": "<p>(The full compatibility of Mathlib with itself is a big deal, and a distinguishing feature from \"libraries\" in other languages.)</p>",
        "id": 469019216,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725955226
    },
    {
        "content": "<p>Is there some way we could allow people to register notation examples at the same time they set up the notation, and then we replay all registered examples with <code>import Mathlib</code>? (And some scheme for requiring that at least one such example is registered for every new notation?)</p>",
        "id": 469019815,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725955343
    },
    {
        "content": "<p>Maybe we can use a mechanism similar to the one for <code>assert_not_exists</code>, where there is a global check at the end, and something stored in an environment extension.</p>",
        "id": 469020478,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725955492
    },
    {
        "content": "<p>How long does parsing all of Mathlib take?</p>",
        "id": 469020666,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1725955535
    },
    {
        "content": "<p>E.g. there could be a linter that warns on <code>notation</code> (and maybe also <code>infix</code>,...) that does not have a corresponding gadget that records its use and then a final check that the usages are compatible.</p>",
        "id": 469020832,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725955568
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Notation.20conflict.20in.20CW-complex.20PR/near/469020666\">said</a>:</p>\n<blockquote>\n<p>How long does parsing all of Mathlib take?</p>\n</blockquote>\n<p>Parsing mathlib is probably not much faster than building it, since a lot of mathlib requires elaboration for correct parsing.</p>",
        "id": 469020915,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725955597
    },
    {
        "content": "<p>Do we actually need to check examples? Is it possible to directly check if there's ambiguous notation?</p>",
        "id": 469021987,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1725955898
    },
    {
        "content": "<p>How do you check for ambiguous notation?</p>",
        "id": 469022345,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725955971
    },
    {
        "content": "<p>As for parsing time, maybe I retract a little what I said: you certainly need some elaboration, but <code>byAsSorry</code> may be enough for most notation purposes.</p>",
        "id": 469024310,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725956267
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Notation.20conflict.20in.20CW-complex.20PR/near/469022345\">said</a>:</p>\n<blockquote>\n<p>How do you check for ambiguous notation?</p>\n</blockquote>\n<p>I don't know the details of the parser, but maybe it's possible to mathematically check for it</p>",
        "id": 469025094,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1725956449
    },
    {
        "content": "<p>Although I see that checking if a CFG is ambiguous is undecidable, so that's probably not possible</p>",
        "id": 469025203,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1725956481
    },
    {
        "content": "<p>If we were writing a math book we could just say at the beginning of a section that <code>âŸª âŸ«</code> in this section means \"restriction of a section of a presheaf\" rather than \"inner product\". Or we could temporarily change the notation for one of the concepts if both concepts are needed in the same section. Maybe we could hope to see such features in a future version of Lean?</p>",
        "id": 469027436,
        "sender_full_name": "Jiazhen Xia",
        "timestamp": 1725957184
    },
    {
        "content": "<p>I think that this is what <code>scoped</code> is supposed to achieve, at least to some extent.</p>",
        "id": 469028235,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725957328
    },
    {
        "content": "<p>Maybe a low-key solution is to lint against non-scoped <code>notation</code>, so that \"global\" notation comes with the need of adding a <code>set_option</code> reminder before it.</p>",
        "id": 469028410,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725957378
    },
    {
        "content": "<p>I'm just not sure whether there is more notation that is expected to be global or more that is expected to be local.</p>",
        "id": 469028505,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725957424
    },
    {
        "content": "<p>Here is a link to a <a href=\"#narrow/stream/287929-mathlib4/topic/global.20notation.20linter\">similar discussion</a>.</p>",
        "id": 469028861,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725957554
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Notation.20conflict.20in.20CW-complex.20PR/near/468867386\">said</a>:</p>\n<blockquote>\n<p>Changing the first <code>:max</code> on the first notation to <code>:lead</code> seems to fix it. This means \"almost highest precedence, but can't be used as a function argument without parentheses\". The highest defined precedences in order go <code>lead</code>, <code>arg</code>, <code>max</code>.</p>\n</blockquote>\n<p>Thanks! Lowering the precedence indeed works, and it involves adding parentheses to about 10 occurrences of <code>âŸªx, yâŸ«_ğ•œ</code> in mathlib that are function arguments.</p>",
        "id": 469031171,
        "sender_full_name": "Jiazhen Xia",
        "timestamp": 1725958170
    },
    {
        "content": "<p>Thanks for all the ideas. I've implemented two solutions to resolve the conflict between <a href=\"https://github.com/leanprover-community/mathlib4/blob/2eb00cae7edccf4e54238db2cb4b0a7dff59fbdd/Mathlib/Analysis/InnerProductSpace/Basic.lean#L85\"><code>âŸªx, yâŸ«_ğ•œ</code></a> and <a href=\"https://github.com/leanprover-community/mathlib4/blob/2eb00cae7edccf4e54238db2cb4b0a7dff59fbdd/Mathlib/Topology/Sheaves/Presheaf.lean#L113\"><code>x |_â‚— U âŸªeâŸ«</code></a>.</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/compare/master...DYJX_CWComplex_chore_InnerProductSpace\">The first solution</a> is to lower the precedence of <code>âŸªx, yâŸ«_ğ•œ</code> and then add parentheses where necessary.</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/compare/master...DYJX_CWComplex_chore_InnerProductSpace_scoped\">The second solution</a> is to make <code>âŸªx, yâŸ«_ğ•œ</code> a scoped notation within <code>InnerProductSpace</code> and then add <code>open scoped InnerProductSpace</code> wherever the notation is used.</p>\n<p>Which one is better?</p>",
        "id": 469065083,
        "sender_full_name": "Jiazhen Xia",
        "timestamp": 1725968022
    },
    {
        "content": "<p>Can we not create the new import?</p>",
        "id": 469071248,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725969908
    },
    {
        "content": "<p>That's also possible. As a third solution, we can place the new definitions (<code>sphere</code> and <code>disk</code>) in a new file (called <code>Topology/Category/TopCat/Objects.lean</code> or something).</p>",
        "id": 469079874,
        "sender_full_name": "Jiazhen Xia",
        "timestamp": 1725972242
    },
    {
        "content": "<p>I think you will get notation collision no matter the choice (and that should be fixed) but I don't think basic files about the category of topological spaces need to know about inner products.</p>",
        "id": 469081386,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1725972590
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Notation.20conflict.20in.20CW-complex.20PR/near/469081386\">said</a>:</p>\n<blockquote>\n<p>I don't think basic files about the category of topological spaces need to know about inner products.</p>\n</blockquote>\n<p>I think this point is partially addressed by my <a href=\"https://github.com/leanprover-community/mathlib4/compare/master...DYJX_CWComplex_chore_InnerProductSpace_scoped\">second solution</a>, where <code>âŸªx, yâŸ«_ğ•œ</code> becomes scoped within the <code>InnerProductSpace</code> namespace. In this way, although the inner product notation <code>âŸªx, yâŸ«_ğ•œ</code> is imported into <code>TopCat/Basic.lean</code>, it is hidden (\"not known\") unless you explicitly <code>open InnerProductSpace</code>.</p>",
        "id": 469084030,
        "sender_full_name": "Jiazhen Xia",
        "timestamp": 1725973185
    },
    {
        "content": "<p>I opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/16672\">PR #16672</a> making the inner product notation scoped.</p>",
        "id": 469124832,
        "sender_full_name": "Jiazhen Xia",
        "timestamp": 1725980923
    }
]