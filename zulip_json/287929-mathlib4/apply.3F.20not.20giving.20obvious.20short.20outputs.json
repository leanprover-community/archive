[
    {
        "content": "<p>In the file below, I want to use apply to find the name of the lemma <code>IsClosed.union</code>/see if it exists. In fact this lemma does exist, and works perfectly, and intuitively it feels like the first thing I should try in this situation.</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">Set</span> <span class=\"n\">ℝ</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">IsClosed</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"bp\">∪</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">apply</span><span class=\"bp\">?</span>\n  <span class=\"c1\">-- apply IsClosed.union</span>\n</code></pre></div>\n<p>How should I think about the way <code>apply?</code> chooses to order its outputs?</p>\n<p>(Edited to be more minimal, the lemma shows up now, but not as the first option)</p>",
        "id": 419056831,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1706712653
    },
    {
        "content": "<p>Afaik ordering of the outputs of <code>apply?</code> is a very hard problem that we haven't tackled yet.</p>",
        "id": 419057231,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1706712761
    },
    {
        "content": "<p>Well, rather I would say we have tackled it, and despite a lot of thought going into it (by both me and Joe Hendrix when preparing <code>std_exact?</code>) the results still leave a lot to be desired. It's not for lack of trying. :-)</p>",
        "id": 419736887,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1707085462
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> , After 5 minutes of searching I was unable to locate the source code for <code>apply?</code>. Would you mind pointing to it? I want to see what is the current ordering. From personal experience, <code>apply?</code> often favors low-level statements as opposed to high-level API, which is counter-intuitive to me. For example, when working with Reals, it usually suggests things about Cauchy sequences. </p>\n<p>I also wonder if either of the following two orderings has been tried?</p>\n<ol>\n<li>Order lemmas by frequency of use in mathlib, the more frequent the higher. This requires ~10Mb memory to store a table of frequencies.</li>\n<li>Order by the number of dependencies to surface high-level API first. More dependencies = higher level. Also ~10Mb of memory to store.</li>\n</ol>",
        "id": 546925581,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1761320013
    },
    {
        "content": "<p>I tried to Ctrl-Click on <code>apply?</code> and it took me to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.LibrarySearch.evalApply#doc\">docs#Lean.Elab.LibrarySearch.evalApply</a>.  The implementation appears to be the one of <code>exact?</code>, with a flag set to <code>false</code>.</p>",
        "id": 546926293,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761320239
    },
    {
        "content": "<p>And then you ctrl-click on <code>exact?</code> and repeat until you're happy.</p>",
        "id": 546926443,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761320286
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/apply.3F.20not.20giving.20obvious.20short.20outputs/near/546926443\">said</a>:</p>\n<blockquote>\n<p>And then you ctrl-click on <code>exact?</code> and repeat until you're happy.</p>\n</blockquote>\n<p>I don't understand what you mean. How to find the implementation of <code>apply?</code>?</p>",
        "id": 546928327,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1761320824
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">False</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply?</span><span class=\"w\"> </span><span class=\"c1\">-- wait for orange bars to go away and then ctrl-click on `apply?`</span>\n<span class=\"w\">         </span><span class=\"c1\">-- or command-click on a mac</span>\n</code></pre></div>\n<p>In general, whenever you have compiling code, you can ctrl-click on anything and jump to its definition.</p>",
        "id": 546937161,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761323362
    },
    {
        "content": "<p>It takes me to <a href=\"https://github.com/leanprover/lean4/blob/744f98064b056ee27fc8c97f524797c8cc96f436/src/Lean/Elab/Tactic/LibrarySearch.lean#L20-L55\">https://github.com/leanprover/lean4/blob/744f98064b056ee27fc8c97f524797c8cc96f436/src/Lean/Elab/Tactic/LibrarySearch.lean#L20-L55</a><br>\nThis is the implementation of <code>exact?</code>, not <code>apply?</code>.</p>",
        "id": 547028607,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1761368719
    },
    {
        "content": "<p>As has been explained above, this single function is used for both <code>apply?</code> and <code>exact?</code>. Look at the rest of the file, immediately below.</p>",
        "id": 547034896,
        "sender_full_name": "Chris Henson",
        "timestamp": 1761375927
    },
    {
        "content": "<p>It takes me to this code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">builtin_tactic</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">apply?</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalApply</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">apply?</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">required</span><span class=\"o\">],</span><span class=\"bp\">*</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">        </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">  </span><span class=\"n\">exact?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getRef</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>which is exactly the definition of <code>apply?</code>, you can see <code>let `(tactic| apply?  ...</code> in the definition, and it's defined to be <code>exact? ... required false</code>. Now looking at the definition of <code>exact?</code> you can see it takes an input <code>(requireClose : Bool)</code> and so <code>apply?</code> is \"<code>exact?</code> but don't require to close the goal\".</p>",
        "id": 547153212,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761505863
    },
    {
        "content": "<p>Okay, I see now, thank you</p>",
        "id": 547595701,
        "sender_full_name": "Vasily Ilin",
        "timestamp": 1761688851
    }
]