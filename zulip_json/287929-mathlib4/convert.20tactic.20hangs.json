[
    {
        "content": "<p>The following code results in a hang that <code>maxHeartbeats</code> seems unable to stop:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Convert</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">200</span><span class=\"w\"> </span><span class=\"c1\">-- be quick please</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"w\"> </span><span class=\"mi\">1500</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"w\"> </span><span class=\"mi\">500</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">convert</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- hangs forever</span>\n</code></pre></div>\n<p>if you add and remove a space after the <code>1</code>, then you get a new hanging lean background process each time</p>",
        "id": 474687701,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727992705
    },
    {
        "content": "<p>I guess this is a bug in <code>convert</code>, right? Or do you think it is lower-level than that?</p>",
        "id": 474723020,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728012676
    },
    {
        "content": "<p>isn't this exactly caused by <a href=\"https://github.com/leanprover/lean4/pull/5565\">lean4#5565</a> ?</p>",
        "id": 474726968,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1728014490
    },
    {
        "content": "<p>Sounds likely, yes! <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> do you agree this is probably the cause?</p>",
        "id": 474728311,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728014962
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I think you asked if there was a reason to cut a bugfix release about <a href=\"https://github.com/leanprover/lean4/pull/5565\">lean4#5565</a>. This might be it.</p>",
        "id": 474729053,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1728015184
    },
    {
        "content": "<p>I think this might also be a lower level issue caused by using <code>MVarId.assign</code>, which would pass a huge Nat to the kernel where no further timeout checks are made</p>",
        "id": 474772687,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728031502
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/convert.20tactic.20hangs/near/474729053\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> I think you asked if there was a reason to cut a bugfix release about <a href=\"https://github.com/leanprover/lean4/pull/5565\">lean4#5565</a>. This might be it.</p>\n</blockquote>\n<p>Even if we don't do a 4.12.0 bug fix release, it would be good to get the <a href=\"https://github.com/leanprover/lean4/pull/5566\">lean4#5566</a> patch into a 4.13.0rc2</p>",
        "id": 474773590,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728031842
    },
    {
        "content": "<p>You mean 4.13.0-rc3 ?</p>",
        "id": 474774003,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1728031990
    },
    {
        "content": "<p>Nope, looks like I mean rc4</p>",
        "id": 474777672,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728033171
    },
    {
        "content": "<p>I don't think this is a <code>convert</code> issue, given that <code>rfl</code> hangs too:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"w\"> </span><span class=\"mi\">1500</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">choose</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"w\"> </span><span class=\"mi\">500</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 475038023,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1728178465
    },
    {
        "content": "<p>Huh, I was sure I tried that when minimizing!</p>",
        "id": 475065369,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728197387
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> Is this a known issue? Or should we report it at core?</p>",
        "id": 475315553,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728312692
    },
    {
        "content": "<p>Maybe <a href=\"#narrow/stream/341532-lean4-dev/topic/Code.20generator.2Fcompiler.2Fmemory.20allocator.20docs.3F/near/474692975\">this message</a> is relevant?</p>",
        "id": 475316297,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1728312887
    },
    {
        "content": "<p>Seems like a good idea to report it. I don't immediately see any related issues.</p>",
        "id": 475334414,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1728317490
    },
    {
        "content": "<p>Is this the same issue as <a href=\"#narrow/stream/113488-general/topic/.E2.9C.94.20.60rfl.60.20regression.3F\">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/.E2.9C.94.20.60rfl.60.20regression.3F</a> ?</p>",
        "id": 475756938,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728454605
    },
    {
        "content": "<p>One difference is that this example never triggers a timeout, which on its own is worth figuring out. The other thread at least gets a \"max recursion depth\".</p>",
        "id": 475759905,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1728455386
    },
    {
        "content": "<p>That's a good point</p>",
        "id": 475760039,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1728455412
    }
]