[
    {
        "content": "<p>I've been using <a href=\"https://github.com/kim-em/mathlib-minimizer\">mathlib-minimizer</a> for the last few days in an attempt to minimize the universe issue which has been bugging me recently (my\"weekend project\"). It's bombed out on me twice so far. Once because it turned out that my failing test was too brittle (the error would sometimes be <code>timed out doing IsDefEq</code> and sometimes <code>timed out doing whnf</code> or whatever), which I fixed by making a better test. But the second time was this morning, for a more interesting reason: at some point in mathlib we're apparently explicitly using the name of an auto-generated instance. In <code>Mathlib/Algebra/Algebra/Operations.lean</code> we have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NonUnitalSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">__</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toAddSubmonoid_injective</span><span class=\"bp\">.</span><span class=\"n\">semigroup</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">mul_toAddSubmonoid</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>and later on in that file (in the <code>Submodule</code> namespace) we have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Sub-R-modules of an R-algebra form an idempotent semiring. -/</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">idemSemiring</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IdemSemiring</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Submodule</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">__</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">instNonUnitalSemiring</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>with <code>Submodule.instNonUnitalSemiring</code> being the name given to the instance by mathlib. Aah! But in the minimiser this instance was given the name <code>Submodule.instNonUnitalSemiring_mathlibMinimizer</code>! (the instance naming algorithm puts the name of the project at the end; I have a bunch of <code>..._fLT</code> instances in FLT, for example). This leads to the error</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>FATAL: All 1 import inlining attempts failed.\nFailed imports: #[Mathlib.Algebra.Algebra.Operations]\nThis should never happen - import inlining should always succeed.\nThe last failed source has been written to the output file for debugging.\n</code></pre></div>\n<p>in the minimiser. What should be done here?</p>",
        "id": 572731595,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1770632159
    },
    {
        "content": "<p>I believe we can simply get rid of the line <code>  __ := Submodule.instNonUnitalSemiring</code>, because nowadays, the instance can be inferred automatically.</p>",
        "id": 572732854,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1770632486
    },
    {
        "content": "<p>But longer-term there are the questions of (a) is it OK to use automatically-generated instance names in mathlib and (b) if it is then this will break the minimiser -- will it be easy to fix?</p>",
        "id": 572751534,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1770637175
    },
    {
        "content": "<p>Using automatically generated instance names explicitly in the source feels bad to me. Either, we should not reference them, or we should name them by hand.</p>",
        "id": 572768895,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1770641758
    },
    {
        "content": "<p>Imho, we should have a linter for this and track any existing violations as technical debt (unless there are so few that we can remove them all in one go).</p>",
        "id": 572768997,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1770641785
    },
    {
        "content": "<p>Proposal for finding them: change the instance-naming algorithm in core and see what breaks.</p>\n<p>How would one lint against this though?</p>",
        "id": 572769802,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1770641961
    },
    {
        "content": "<p>one could try to keep track of which names are automatically generated somehow, for example by enforcing some kind of naming scheme or by keeping track in an environment extension, and then at elaboration time insert a check which raises a warning?</p>",
        "id": 572770502,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1770642105
    },
    {
        "content": "<p>You could also write a linter that chirps out the automatically generated instance names: these are the ones that syntactically do not have a <code>declId</code> node.  Once you have that list, you check if any of these names is referenced in the syntax of another command.</p>",
        "id": 572889326,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1770672228
    }
]