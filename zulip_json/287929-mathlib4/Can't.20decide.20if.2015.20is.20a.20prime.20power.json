[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsPrimePow</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>\n<p>Fails on both 4.28.0-rc1 and a more recent checkout of main with with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"ss\">`decide</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">proposition</span>\n<span class=\"w\">  </span><span class=\"bp\">¬</span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">15</span>\n<span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">its</span><span class=\"w\"> </span><span class=\"ss\">`Decidable</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"kn\">instance</span>\n<span class=\"w\">  </span><span class=\"n\">instDecidableNot</span>\n<span class=\"n\">did</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"ss\">`isTrue</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"ss\">`isFalse</span><span class=\"bp\">`.</span>\n</code></pre></div>\n<p>It succeeds for smaller values and for larger even values but seems to fail on odd products of primes.</p>\n<p>Is this a bug and/or is there a better way of proving this?</p>",
        "id": 572431114,
        "sender_full_name": "Alastair Irving",
        "timestamp": 1770398967
    },
    {
        "content": "<p>Can you first <code>rw</code> with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=isPrimePow_nat_iff_bounded#doc\">docs#isPrimePow_nat_iff_bounded</a> (or one of the other lemmas there)?</p>",
        "id": 572431370,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1770399053
    },
    {
        "content": "<p>Actually, I guess that's probably what decide is already doing?</p>",
        "id": 572431494,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1770399092
    },
    {
        "content": "<p>The <code>bounded_log</code> version works up to the mid-two-digits:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">55</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">isPrimePow_nat_iff_bounded_log</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 572431782,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1770399203
    },
    {
        "content": "<p>Not sure why the <code>minFac</code> version doesn't though</p>",
        "id": 572431817,
        "sender_full_name": "Thomas Browning",
        "timestamp": 1770399215
    },
    {
        "content": "<p>Yes, rewriting with the bounded_log version works so I'll rewrite with that. Its curious why the minFac doesn't work though.</p>",
        "id": 572432355,
        "sender_full_name": "Alastair Irving",
        "timestamp": 1770399404
    },
    {
        "content": "<p>It looks like <code>Nat.minFac</code> is defined with well-founded recursion (and is appropriately irreducible), so <code>decide</code> won't unfold that.</p>",
        "id": 572436872,
        "sender_full_name": "Alex Meiburg",
        "timestamp": 1770400864
    },
    {
        "content": "<p>Could the decidable instance be rewritten in terms of <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Nat/NthRoot/Defs.html#Nat.nthRoot\">Nat.nthRoot</a>? I don't think that existed when I was doing these in September.</p>",
        "id": 572513330,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1770455835
    },
    {
        "content": "<p>Ideally something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">NthRoot</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsPrimePow</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">isPrimePow_nat_iff_bounded_log_nthRoot</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">      </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">nthRoot</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">nthRoot</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">decidable_of_iff'</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isPrimePow_nat_iff_bounded_log_nthRoot</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span>\n</code></pre></div>\n<p>but it would be leaving the file this way.</p>",
        "id": 572513670,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1770456093
    },
    {
        "content": "<p>The problem described above can be solved using an experimental <code>decide_cbv</code> tactic available in the latest nightly. This tactic mimics call-by-value evaluation, but unlike <code>rfl</code> it can handle functions defined via well-founded recursion. Unlike <code>native_decide</code> it does not rely on the additional axioms.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">IsPrimePow</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">10093</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide_cbv</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">100999</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide_cbv</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide_cbv</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">IsPrimePow</span><span class=\"w\"> </span><span class=\"mi\">111111111111111155</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide_cbv</span>\n</code></pre></div>\n<p>If you're interested <a href=\"#narrow/channel/270676-lean4/topic/Experimental.20.60cbv.60and.20.60cbv_decide.60.20tactic.20in.20nightly\">here is the thread</a> that describes it and <a href=\"https://github.com/leanprover-community/mathlib4-nightly-testing/pull/178\">here is the PR</a> on <code>mathlib4-nigthly-testing</code> that tests the provided example.</p>",
        "id": 574133049,
        "sender_full_name": "Wojciech Różowski",
        "timestamp": 1771255158
    },
    {
        "content": "<p>Just noting that <code>cbv</code> and <code>decide_cbv</code> are availably in <code>v4.29.0-rc1</code> (and hence in Mathlib) --- but also noting Wojciech's warning above that their behaviour <em>will</em> change underneath you! They are still experimental.</p>",
        "id": 574718586,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1771505319
    }
]