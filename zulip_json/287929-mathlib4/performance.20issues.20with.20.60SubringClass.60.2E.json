[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/16975\">#16975</a> I am trying to add missing instances (or, what would have a similar effect: make some hom classes <code>class abbrev</code>). In fact, there are only two of them, but the performance impact is annoyingly bad. These instances are entirely natural (essentially just <code>SubringClass.toNonUnitalSubringClass</code> and the semiring variant).</p>\n<p>This came up as a consequence of <a href=\"https://github.com/leanprover-community/mathlib4/pull/16953\">#16953</a> where I'm trying to add classes of C*-algebras in order to improve performance there (which is basically successful). I'm soliciting suggestions for what I should do or attempt.</p>",
        "id": 472715436,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727275702
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/12617\">#12617</a> is very loosely related</p>",
        "id": 472717664,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727276325
    },
    {
        "content": "<p>Do you understand in more detail where the performance hit lands? The bench bot shows that certain files become much slower? But are there specific decls that become slower? Or is it just generically \"death by a thousand cuts\"?</p>",
        "id": 472831174,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1727335839
    },
    {
        "content": "<p>If 1 or 2 decls become significantly slower, then we can try to start working on a MWE displaying the behaviour.</p>",
        "id": 472831271,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1727335875
    },
    {
        "content": "<p>I took the four worst offending files and looked at all the declarations in each. It seems like for the worst performance, it is indeed mostly just a few declarations. I've tried looking at some of them, but this isn't my area of Mathlib, so I didn't make much progress. Help would be greatly appreciated.</p>\n<p><strong>NB:</strong> I compared against <code>30da628648</code>, which is the <em>first</em> commit in the PR, not the most recent commit (as Eric suggested, and I agree, that the first commit is really the correct one to use; feel free to revert the PR to that commit if you choose to work on this).</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>NumberTheory.NumberField.Discriminant</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>Below are the number of heartbeats used on (a recent) <code>master</code> versus <code>30da628648</code>. I've highlighted the biggest offenders (both in terms of percentage and total hearbeats added).</p>\n<ul>\n<li>Used 1517/1517 heartbeats</li>\n<li>Used 6863/7112 heartbeats</li>\n<li>Used 4612/4614 heartbeats</li>\n<li>Used 3338/3343 heartbeats</li>\n<li>Used 13612/14151 heartbeats</li>\n<li>Used 40662/40661 heartbeats</li>\n<li>Used 29729/29740 heartbeats</li>\n<li>Used 3443/3453 heartbeats</li>\n<li>Used 75365/76959 heartbeats</li>\n<li>Used 11875/11878 heartbeats</li>\n<li>Used 1706/1705 heartbeats</li>\n<li>Used 310/310 heartbeats</li>\n<li>Used 351/351 heartbeats</li>\n<li>Used 6657/6658 heartbeats</li>\n<li>Used 12567/12575 heartbeats</li>\n<li>Used 5501/5480 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NumberField.hermiteTheorem.finite_of_discr_bdd_of_isReal#doc\">docs#NumberField.hermiteTheorem.finite_of_discr_bdd_of_isReal</a> Used 148505/189592 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NumberField.hermiteTheorem.finite_of_discr_bdd_of_isComplex#doc\">docs#NumberField.hermiteTheorem.finite_of_discr_bdd_of_isComplex</a> Used 122875/163971 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NumberField.finite_of_discr_bdd#doc\">docs#NumberField.finite_of_discr_bdd</a> Used 17301/25345 heartbeats</li>\n<li>Used 7132/7330 heartbeats</li>\n<li>Used 16052/16031 heartbeats</li>\n</ul>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>NumberTheory.Cyclotomic.PrimitiveRoots</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>Below are the number of heartbeats used on (a recent) <code>master</code> versus <code>30da628648</code>. I've highlighted the biggest offenders (both in terms of percentage and total hearbeats added).</p>\n<ul>\n<li>Used 270/270 heartbeats</li>\n<li>Used 290/290 heartbeats</li>\n<li>Used 1208/1208 heartbeats</li>\n<li>Used 1061/1061 heartbeats</li>\n<li>Used 457/457 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsPrimitiveRoot.powerBasis#doc\">docs#IsPrimitiveRoot.powerBasis</a> Used 19101/38303 heartbeats</li>\n<li>Used 4878/4880 heartbeats</li>\n<li>Used 2454/2493 heartbeats</li>\n<li>Used 8841/8846 heartbeats</li>\n<li>Used 1137/1136 heartbeats</li>\n<li>Used 1513/1513 heartbeats</li>\n<li>Used 8623/8955 heartbeats</li>\n<li>Used 3129/3128 heartbeats</li>\n<li>Used 4087/4093 heartbeats</li>\n<li>Used 1985/1986 heartbeats</li>\n<li>Used 6221/6226 heartbeats</li>\n<li>Used 3491/3489 heartbeats</li>\n<li>Used 3271/3266 heartbeats</li>\n<li>Used 1328/1328 heartbeats</li>\n<li>Used 13872/13572 heartbeats</li>\n<li>Used 1612/1612 heartbeats</li>\n<li>Used 10414/11228 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsPrimitiveRoot.norm_pow_sub_one_of_prime_pow_ne_two#doc\">docs#IsPrimitiveRoot.norm_pow_sub_one_of_prime_pow_ne_two</a> Used 76355/112378 heartbeats</li>\n<li>Used 2083/2083 heartbeats</li>\n<li>Used 6108/6108 heartbeats</li>\n<li>Used 6086/6086 heartbeats</li>\n<li>Used 8388/8391 heartbeats</li>\n<li>Used 8009/8007 heartbeats</li>\n<li>Used 4203/4204 heartbeats</li>\n<li>Used 1029/1029 heartbeats</li>\n<li>Used 939/939 heartbeats</li>\n<li>Used 1951/1949 heartbeats</li>\n<li>Used 1725/1723 heartbeats</li>\n<li>Used 1109/1109 heartbeats</li>\n<li>Used 1487/1488 heartbeats</li>\n</ul>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Algebra.Algebra.Subalgebra.Rank</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>Below are the number of heartbeats used on (a recent) <code>master</code> versus <code>30da628648</code>. These are all just about 20% or so slower. Also, these declarations are surprisingly slow to me anyway? <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span></p>\n<ul>\n<li>Used 53159/62505 heartbeats</li>\n<li>Used 29224/35577 heartbeats</li>\n<li>Used 14834/17841 heartbeats</li>\n<li>Used 27586/33213 heartbeats</li>\n<li>Used 27252/33009 heartbeats</li>\n<li>Used 14837/17842 heartbeats</li>\n</ul>\n</div></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>FieldTheory.PurelyInseparable</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>Below are the number of heartbeats used on (a recent) <code>master</code> versus <code>30da628648</code>. I've highlighted the biggest offenders (both in terms of percentage and total hearbeats added).</p>\n<ul>\n<li>Used 728/728 heartbeats</li>\n<li>Used 509/509 heartbeats</li>\n<li>Used 406/406 heartbeats</li>\n<li>Used 457/457 heartbeats</li>\n<li>Used 528/528 heartbeats</li>\n<li>Used 1024/1023 heartbeats</li>\n<li>Used 656/656 heartbeats</li>\n<li>Used 760/760 heartbeats</li>\n<li>Used 468/468 heartbeats</li>\n<li>Used 673/673 heartbeats</li>\n<li>Used 4237/4798 heartbeats</li>\n<li>Used 4392/4393 heartbeats</li>\n<li>Used 1358/1358 heartbeats</li>\n<li>Used 845/845 heartbeats</li>\n<li>Used 559/559 heartbeats</li>\n<li>Used 2236/2236 heartbeats</li>\n<li>Used 819/819 heartbeats</li>\n<li>Used 5472/5471 heartbeats</li>\n<li>Used 575/575 heartbeats</li>\n<li>Used 768/768 heartbeats</li>\n<li>Used 769/769 heartbeats</li>\n<li>Used 1602/1602 heartbeats</li>\n<li>Used 4860/5031 heartbeats</li>\n<li>Used 1382/1382 heartbeats</li>\n<li>Used 3181/3358 heartbeats</li>\n<li>Used 3677/3754 heartbeats</li>\n<li>Used 4702/4878 heartbeats</li>\n<li>Used 2316/2364 heartbeats</li>\n<li>Used 2896/2895 heartbeats</li>\n<li>Used 541/541 heartbeats</li>\n<li>Used 526/526 heartbeats</li>\n<li>Used 748/748 heartbeats</li>\n<li>Used 4811/4820 heartbeats</li>\n<li>Used 6215/7124 heartbeats</li>\n<li>Used 2153/2333 heartbeats</li>\n<li>Used 2058/2057 heartbeats</li>\n<li>Used 1754/1755 heartbeats</li>\n<li>Used 2485/2484 heartbeats</li>\n<li>Used 800/800 heartbeats</li>\n<li>Used 383/382 heartbeats</li>\n<li>Used 1106/1106 heartbeats</li>\n<li>Used 685/685 heartbeats</li>\n<li>Used 1348/1348 heartbeats</li>\n<li>Used 766/765 heartbeats</li>\n<li>Used 7875/8277 heartbeats</li>\n<li>Used 3867/3866 heartbeats</li>\n<li>Used 1053/1053 heartbeats</li>\n<li>Used 1330/1330 heartbeats</li>\n<li>Used 2609/2610 heartbeats</li>\n<li>Used 307/307 heartbeats</li>\n<li>Used 640/640 heartbeats</li>\n<li>Used 3207/3437 heartbeats</li>\n<li>Used 1422/1422 heartbeats</li>\n<li>Used 398/397 heartbeats</li>\n<li>Used 7378/7600 heartbeats</li>\n<li>Used 1015/1015 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=separableClosure.isPurelyInseparable#doc\">docs#separableClosure.isPurelyInseparable</a> Used 23766/25430 heartbeats</li>\n<li>Used 6360/6807 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=separableClosure_le_iff#doc\">docs#separableClosure_le_iff</a> Used 15610/16747 heartbeats</li>\n<li>Used 3660/3910 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=eq_separableClosure_iff#doc\">docs#eq_separableClosure_iff</a> Used 7271/7849 heartbeats</li>\n<li>Used 788/788 heartbeats</li>\n<li>Used 1862/1862 heartbeats</li>\n<li>Used 1483/1483 heartbeats </li>\n<li>Used 1841/1841 heartbeats </li>\n<li>Used 2316/2316 heartbeats </li>\n<li>Used 3284/3283 heartbeats</li>\n<li>Used 2507/2508 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=adjoin_eq_adjoin_pow_expChar_pow_of_isSeparable#doc\">docs#adjoin_eq_adjoin_pow_expChar_pow_of_isSeparable</a> Used 60843/64968 heartbeats</li>\n<li>Used 3371/3548 heartbeats</li>\n<li>Used 1456/1456 heartbeats</li>\n<li>Used 473/473 heartbeats</li>\n<li>Used 5144/5146 heartbeats</li>\n<li>Used 4964/4965 heartbeats</li>\n<li>Used 13140/13432 heartbeats</li>\n<li>Used 7869/7994 heartbeats</li>\n<li>Used 2196/2196 heartbeats</li>\n<li>Used 3989/3990 heartbeats</li>\n<li>Used 3313/3312 heartbeats</li>\n<li>Used 2315/2315 heartbeats</li>\n<li>Used 299/299 heartbeats</li>\n<li>Used 2271/2271 heartbeats</li>\n<li>Used 8658/9127 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Field.finSepDegree_mul_finInsepDegree#doc\">docs#Field.finSepDegree_mul_finInsepDegree</a> Used 19946/25871 heartbeats</li>\n<li>Used 19760/20845 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=separableClosure.adjoin_eq_of_isAlgebraic#doc\">docs#separableClosure.adjoin_eq_of_isAlgebraic</a> Used 9757/10228 heartbeats</li>\n<li>Used 13720/13721 heartbeats</li>\n<li>Used 10825/10953 heartbeats</li>\n<li>Used 5173/5187 heartbeats</li>\n<li>Used 1588/1589 heartbeats</li>\n<li><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Field.sepDegree_eq_of_isPurelyInseparable#doc\">docs#Field.sepDegree_eq_of_isPurelyInseparable</a> Used 19878/20692 heartbeats</li>\n<li>Used 6168/6468 heartbeats</li>\n<li>Used 1184/1183 heartbeats</li>\n<li>Used 51051/53571 heartbeats</li>\n<li>Used 5130/5131 heartbeats</li>\n<li>Used 8744/8792 heartbeats</li>\n<li>Used 4667/4668 heartbeats</li>\n</ul>\n</div></div>",
        "id": 473809894,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727718620
    },
    {
        "content": "<p>Note that the performance hit in these 4 files accounts for about 1/3 of the entire impact of the PR. (by instruction count)</p>",
        "id": 473810264,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727718732
    },
    {
        "content": "<p><code>NumberTheory.NumberField.Discriminant</code> alone accounts for 1/6 of the total impact, and in there, it's really just 2-3 declarations that cause the fallout.</p>",
        "id": 473810391,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727718782
    },
    {
        "content": "<p>Can I tempt a number theorist, say, <span class=\"user-mention\" data-user-id=\"300245\">@Filippo A. E. Nuccio</span> or <span class=\"user-mention\" data-user-id=\"130384\">@Riccardo Brasca</span> into taking a look at the slow declarations on <code>30da628648</code> in <code>NumberTheory.NumberField.Discriminant</code> that I linked in the fold above? It would be very nice to see if we can address this performance issue to unlock some other PRs.</p>",
        "id": 474362888,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727891912
    },
    {
        "content": "<p>I feel guilty for half of the files, so I will try to have a look. Not sure I will have time before next week though.</p>",
        "id": 474371193,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1727894857
    },
    {
        "content": "<p>Well, actually, maybe <span class=\"user-mention\" data-user-id=\"488648\">@Xavier Roblot</span> can have a look at the declarations in the discriminant file.</p>",
        "id": 474371359,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1727894897
    },
    {
        "content": "<p>Yes, I should have some time to take a look tomorrow or Friday.</p>",
        "id": 474378711,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1727896792
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/stream/287929-mathlib4/topic/performance.20issues.20with.20.60SubringClass.60.2E/near/474371193\">said</a>:</p>\n<blockquote>\n<p>I feel guilty for half of the files</p>\n</blockquote>\n<p>There's no blame here! I'm not even sure why adding these instances has such a significant performance hit.</p>",
        "id": 474408011,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727906734
    },
    {
        "content": "<p>I have posted some possible changes for the file <code>Discriminant.lean</code> on the PR page. With those, I was able to get compilation times comparable to <code>master</code>.</p>",
        "id": 474567342,
        "sender_full_name": "Xavier Roblot",
        "timestamp": 1727955412
    },
    {
        "content": "<p>Late to the party, but it seems the problem has been solved <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 474649843,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1727977597
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"488648\">@Xavier Roblot</span> ! I'll definitely incorporate those changes.</p>",
        "id": 474688965,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727993408
    },
    {
        "content": "<p>As for the <code>Rank.lean</code> file, it seems to me that what's going on is, because of the additional import of the <code>NonUnitalSubring</code> file, Lean spends more time looking for <code>AddCommMonoid</code> instances when it wants to find a <code>Module R M</code> instance in order to make sense of <code>Module.rank R M</code>. Even on current master, elaboration of the <em>statement alone</em> of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subalgebra.rank_sup_eq_rank_left_mul_rank_of_free#doc\">docs#Subalgebra.rank_sup_eq_rank_left_mul_rank_of_free</a> takes 25000 heartbeats and it spends 1.5 seconds on inferring those <code>Module</code> instances. On the PR, it spends about 31000 heartbeats on the same. </p>\n<p>So, my take on that particular file is that inferring those <code>Module</code> instances is <em>already</em> slow, and this only makes it a bit worse. I'm fairly certain that it's slow because it's working with a lot of subtypes, and so, as we've seen before, Lean has to search all over the place because the head expression is a coercion to <code>Sort</code> and the indexing is not fine-grained enough.</p>",
        "id": 474689478,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727993733
    },
    {
        "content": "<p>I managed to speed up <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsPrimitiveRoot.powerBasis#doc\">docs#IsPrimitiveRoot.powerBasis</a> by replacing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">powerBasis</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PowerBasis</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">PowerBasis</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">adjoin</span><span class=\"bp\">.</span><span class=\"n\">powerBasis</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">integral</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isIntegral</span><span class=\"w\"> </span><span class=\"n\">ζ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">equivOfEq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IsCyclotomicExtension</span><span class=\"bp\">.</span><span class=\"n\">adjoin_primitive_root_eq_top</span><span class=\"w\"> </span><span class=\"n\">hζ</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n<span class=\"w\">      </span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">topEquiv</span>\n</code></pre></div>\n<p>with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">powerBasis</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PowerBasis</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">letI</span><span class=\"w\"> </span><span class=\"n\">pb</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">adjoin</span><span class=\"bp\">.</span><span class=\"n\">powerBasis</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">integral</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isIntegral</span><span class=\"w\"> </span><span class=\"n\">ζ</span><span class=\"bp\">;</span>\n<span class=\"w\">  </span><span class=\"n\">pb</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">equivOfEq</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IsCyclotomicExtension</span><span class=\"bp\">.</span><span class=\"n\">adjoin_primitive_root_eq_top</span><span class=\"w\"> </span><span class=\"n\">hζ</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">trans</span>\n<span class=\"w\">    </span><span class=\"n\">Subalgebra</span><span class=\"bp\">.</span><span class=\"n\">topEquiv</span>\n</code></pre></div>\n<p>it went from ~20000 heartbeats on master and ~38000 on this PR, to ~4700 with the new (identical! aside from elaboration) version.</p>",
        "id": 474691889,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727995073
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> <span aria-label=\"up\" class=\"emoji emoji-2b06\" role=\"img\" title=\"up\">:up:</span> given that you found something like this recently, I thought you would be interested.</p>",
        "id": 474691975,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1727995102
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsPrimitiveRoot.norm_pow_sub_one_of_prime_pow_ne_two#doc\">docs#IsPrimitiveRoot.norm_pow_sub_one_of_prime_pow_ne_two</a> was suffering from some serious defeq abuse, and being a bit more careful actually improves performance (on this branch) beyond current <code>master</code> by about 40%.</p>",
        "id": 474723558,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1728012927
    },
    {
        "content": "<p>I've split off the performance enhancements into <a href=\"https://github.com/leanprover-community/mathlib4/pull/17395\">#17395</a></p>",
        "id": 474726308,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1728014203
    },
    {
        "content": "<p>By the way, in the original code for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsPrimitiveRoot.powerBasis#doc\">docs#IsPrimitiveRoot.powerBasis</a> above, the <code>synthInstance</code> trace shows repeated attempts at <code>CommRing ?mvar</code> <span aria-label=\"explosion\" class=\"emoji emoji-1f4a5\" role=\"img\" title=\"explosion\">:explosion:</span> . I was under the impression that this should never happen because this is a doomed search. Do we know why that happens? This can even be witnessed on current <code>master</code> (and note that it's the same <code>?mvar</code> every time).</p>",
        "id": 474729753,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1728015323
    }
]