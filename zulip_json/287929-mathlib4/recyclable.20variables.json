[
    {
        "content": "<p>Throughout mathlib, there are quite a few instances of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>where the available <code>m n</code> in scope are simply overruled.</p>\n<p>Should this be discouraged?</p>",
        "id": 450980042,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720791815
    },
    {
        "content": "<p>I am running an experiment (<a href=\"https://github.com/leanprover-community/mathlib4/pull/14675\">#14675</a>) where a linter warns about the possibility of recycling a variable in scope.  This happens thousands of times in mathlib (EDIT: 2650 times spread over 630 files).</p>\n<p>I realize that sometimes, this is done on purpose to change the order of the variables in the signature of the statement, but, upon looking at a few samples, this looks like the vast minority of the cases.</p>",
        "id": 450980117,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720791838
    },
    {
        "content": "<p>I personally think it's the sort of thing that someone can decide to go through and choose to clean up, but I wouldn't want people to be forced to always avoid shadowing <code>variable</code>s.</p>\n<p>It would be neat having a code action that inserts all the used <code>variable</code>s back as arguments. That would help with moving declarations between modules.</p>",
        "id": 451027990,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720803230
    },
    {
        "content": "<p>Fair enough.  In fact, I probably have a preference for erring on the explicit side for variables!</p>",
        "id": 451053024,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720811283
    },
    {
        "content": "<p>Sometimes shadowing is necessary if you want to change the argument order</p>",
        "id": 451056720,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720812173
    },
    {
        "content": "<p>I agree, but I spot-checked a few of the declarations that were flagged and the overwhelming majority did not change the argument order.</p>",
        "id": 451056903,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720812226
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451027990\">said</a>:</p>\n<blockquote>\n<p>It would be neat having a code action that inserts all the used <code>variable</code>s back as arguments.</p>\n</blockquote>\n<p>And the reverse! :) (I.e., removing all arguments that shadow variables)</p>",
        "id": 451057287,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1720812346
    },
    {
        "content": "<p>Please don't remove explicit variables from theorems.</p>",
        "id": 451105015,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1720832332
    },
    {
        "content": "<p>As for the implicit variables, using <code>variable</code> LGTM.</p>",
        "id": 451105062,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1720832348
    },
    {
        "content": "<p>Ageing with the above, I would not want any policy or linter that pushes us to use more <code>variable</code>.</p>\n<p>If anything I would like us to get rid of \"global\" variables, e.g. when people set up variables for both a monoid and a ring at the top of a file, and then you need to carefully watch the name of the type in order to know which setting you're in. I would prefer if we could completely avoid this idiom and use sections instead. Unclear how one could lint, however.</p>",
        "id": 451167963,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720874462
    },
    {
        "content": "<p>(this issue is way better today than it used to be, already)</p>",
        "id": 451167990,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720874496
    },
    {
        "content": "<p>Kim, if you can be a little more specific with what kind of <code>variable</code> confusion you would like to avoid, I can try to think about how to improve the situation.</p>",
        "id": 451177928,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720879980
    },
    {
        "content": "<p>In fact, even though the linter in this thread flags unnecessary uses of variables, my instinct is also to move away from Lean inserting variables in a seemingly magical way.  So I am happy to try something else!</p>",
        "id": 451178068,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720880040
    },
    {
        "content": "<p>I guess, something like <code>variable {M N : Type*} [Monoid M] [CommMonoid N]</code> at the top of the file.</p>",
        "id": 451198943,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1720890190
    },
    {
        "content": "<p>Exactly that!</p>",
        "id": 451200360,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720890846
    },
    {
        "content": "<p>Yeah this makes code really hard to read on eg GitHub.</p>",
        "id": 451217710,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720898948
    },
    {
        "content": "<p>Long sections (several hundred lines) also make it challenging, so our push to keep file size down and disentangle the import hierarchy helps a lot.</p>",
        "id": 451222370,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1720901873
    },
    {
        "content": "<p>With the idea of making a \"lintable rule\", how about the linter complains if one available typeclass is an instance of another available typeclass?</p>\n<p>This should make uses of \"incremental\" typeclass assumption in variables neatly separated.</p>",
        "id": 451354936,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720964098
    },
    {
        "content": "<p>So, an alternative way of saying this, in scope there can only be an antichain of instances.  If you want to violate this, then you should silence the linter.</p>",
        "id": 451354977,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720964154
    },
    {
        "content": "<p>Perhaps exclude <code>Prop</code> typeclasses? I believe it's fine for those</p>",
        "id": 451356006,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720965056
    },
    {
        "content": "<p>This night also really help all the beginners who write <code>variable [Mul X] [Field X]</code> and don't get any automatic feedback that this is broken. In fact this special case (i.e. the same type argument!) could be a linter even if the full one is problematic for some reason.</p>",
        "id": 451357289,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720965867
    },
    {
        "content": "<p>The <code>Mul</code> <code>Field</code> linter I was planning to add to the \"beginners\" linter that also warns about <code>Nat.sub</code>, <code>Nat.div</code> and friends.</p>",
        "id": 451357430,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720966026
    },
    {
        "content": "<p>I might've misunderstood, do you mean to lint against things like <code>[CommRing X] [Field Y]</code>?</p>",
        "id": 451357652,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720966239
    },
    {
        "content": "<p>No, against <code>CommRing X</code> and <code>Field X</code> -- note the repetition of <code>X</code>.</p>",
        "id": 451357685,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720966297
    },
    {
        "content": "<p>The issue with <code>variable {M N : Type*} [Monoid M] [CommMonoid N]</code> 100 lines into a 2000-line-long file (this is something mentioned above which you might be referrring to) is that it says \"at this point we establish the for-this-file-only convention that all monoids called M are not commutative, and all monoids called N are commutative, and we expect the user to spot this and understand that this is what's going on throughout the file\". A better style is sections called things like <code>commutative</code> with <code>[CommMonoid M]</code> valid throughout that section only.</p>",
        "id": 451357794,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720966442
    },
    {
        "content": "<p>So, essentially, for each typeclass assumption you make sure that <code>#synth &lt;that typeclass&gt;</code> in the context of all the remaining ones fails, otherwise the linter tells you that there is a typeclass dependence in your <code>variable</code>s.</p>",
        "id": 451357893,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720966526
    },
    {
        "content": "<p>Damiano, that's a good start but it's not enough: <code>[CommMonoid R] [Ring R]</code> is also bad</p>",
        "id": 451358205,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1720966858
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451357794\">said</a>:</p>\n<blockquote>\n<p>The issue with <code>variable {M N : Type*} [Monoid M] [CommMonoid N]</code> 100 lines into a 2000-line-long file (this is something mentioned above which you might be referrring to) is that it says \"at this point we establish the for-this-file-only convention that all monoids called M are not commutative, and all monoids called N are commutative, and we expect the user to spot this and understand that this is what's going on throughout the file\". A better style is sections called things like <code>commutative</code> with <code>[CommMonoid M]</code> valid throughout that section only.</p>\n</blockquote>\n<p>Perhaps the actual problem is <code>variable</code> being in effect for too many lines? After all, this problem persists even if it's <code>[Foo M] [Bar N]</code>, where <code>Foo</code> and <code>Bar</code> are completely unrelated, only it's easier to figure out from the context what's going on.</p>",
        "id": 451358232,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720966898
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451358205\">said</a>:</p>\n<blockquote>\n<p>Damiano, that's a good start but it's not enough: <code>[CommMonoid R] [Ring R]</code> is also bad</p>\n</blockquote>\n<p>I agree, but let me try to get a linter working that flags all uses that are \"clearly\" bad and then we can discuss other, more subtle abuses.  Does that seem right?</p>",
        "id": 451358308,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720966957
    },
    {
        "content": "<p>I'm going to write a \"permissive\" linter that just does what I said above, also to see if there are some \"legitimate\" uses of a dependency among typeclass assumptions.  Given that mathlib is so large, there is usually some edge case (typically by you, Ya√´l), where the linter is not doing what it should!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 451358410,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720967055
    },
    {
        "content": "<p>Perhaps if both are named and each time it's explicitly written which one to use</p>",
        "id": 451358653,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1720967297
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14731\">#14731</a> in its very first run!</p>",
        "id": 451359770,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720968522
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451358232\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451357794\">said</a>:</p>\n<blockquote>\n<p>The issue with <code>variable {M N : Type*} [Monoid M] [CommMonoid N]</code> 100 lines into a 2000-line-long file (this is something mentioned above which you might be referrring to) is that it says \"at this point we establish the for-this-file-only convention that all monoids called M are not commutative, and all monoids called N are commutative, and we expect the user to spot this and understand that this is what's going on throughout the file\". A better style is sections called things like <code>commutative</code> with <code>[CommMonoid M]</code> valid throughout that section only.</p>\n</blockquote>\n<p>Perhaps the actual problem is <code>variable</code> being in effect for too many lines? After all, this problem persists even if it's <code>[Foo M] [Bar N]</code>, where <code>Foo</code> and <code>Bar</code> are completely unrelated, only it's easier to figure out from the context what's going on.</p>\n</blockquote>\n<p>OTOH, <code>variable {Œ± : Type*} {m : MeasurableSpace Œ±} {Œº : Measure Œ±}</code> at the top of a measure theory file is OK, even if the file is long.</p>",
        "id": 451360538,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1720968734
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451357893\">said</a>:</p>\n<blockquote>\n<p>So, essentially, for each typeclass assumption you make sure that <code>#synth &lt;that typeclass&gt;</code> in the context of all the remaining ones fails, otherwise the linter tells you that there is a typeclass dependence in your <code>variable</code>s.</p>\n</blockquote>\n<p>When would that run? I am a bit worried this would be a rather slow linter.</p>",
        "id": 451363249,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1720971072
    },
    {
        "content": "<p>For the moment, I'm just trying to get something that reports something useful.</p>\n<p>It is currently running on each <code>variable</code> command, but I think that some of the warnings that it is reporting are timeouts.  <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 451363883,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720971715
    },
    {
        "content": "<p>Surely it should be a syntax linter, so that it is only run when you open a file in vscode?</p>",
        "id": 451364111,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1720971942
    },
    {
        "content": "<p>It is a syntax linter, but syntax linters also run on CI.</p>",
        "id": 451364168,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720971976
    },
    {
        "content": "<p>75% of all syntax linter time is spent in the <code>unusedVariables</code> linter</p>",
        "id": 451370698,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720979140
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451364168\">said</a>:</p>\n<blockquote>\n<p>It is a syntax linter, but syntax linters also run on CI.</p>\n</blockquote>\n<p>That sounds like maybe they shouldn't?</p>",
        "id": 451370807,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1720979281
    },
    {
        "content": "<p>If syntax linters did not run on CI, then whatever they are warning against would get merged, though.<br>\n(Or likely I misunderstood what you meant!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> )</p>",
        "id": 451373414,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720982107
    },
    {
        "content": "<p>The first run, uncovered a bug when dealing with binder-update.</p>\n<p>The current round found in <code>Mathlib/Order/Minimal.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span>\n<span class=\"bp\">...</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"o\">}</span>\n<span class=\"c\">/-</span><span class=\"cm\"> Minimal.lean:357:9</span>\n<span class=\"cm\">Typeclass '[LE Œ±]' is implied by [[PartialOrder Œ±], [LE Œ≤], [LE Œ≤]]</span>\n<span class=\"cm\">note: this linter can be disabled with `set_option linter.dependentTypeclass false`</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 451375214,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720984034
    },
    {
        "content": "<p>Whoops <span aria-label=\"flushed\" class=\"emoji emoji-1f633\" role=\"img\" title=\"flushed\">:flushed:</span></p>",
        "id": 451378017,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1720986979
    },
    {
        "content": "<p>Spot-checking a few files, the linter seems to flag actual issues.  However, resolving these issues is sometimes tricky.  If the file looks like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"bp\">...</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Y</span>\n</code></pre></div>\n<p>when the linter gets to <code>Group Y</code> it tells you that now <code>Mul X</code> is superfluous.  However, simply sectioning off <code>Mul X</code>, it is not clear whether <code>lemma Y</code> <em>might</em> work with just <code>Mul X</code>.</p>\n<p>Of course, this is exactly one of the traps that the linter is supposed to avoid, but now it requires quite a bit of thinking about what to do!</p>",
        "id": 451421215,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721025407
    },
    {
        "content": "<p>Well, I'm really glad that you started digging into this. It unearths a whole new category of technical debt.</p>",
        "id": 451421490,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721025560
    },
    {
        "content": "<p>Can you generate a list of filenames + line numbers that indicate where we should look for trouble?</p>",
        "id": 451421557,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721025596
    },
    {
        "content": "<p>In fact is it even clear what happens if you state a lemma which only mentions <code>*</code> at this point? Do you pick up a random one or is it deterministic? It's likely that the statement will not use any group properties but the proof will so presumably the statement must get the group one or else the proof wouldn't work</p>",
        "id": 451421562,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1721025600
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451421557\">said</a>:</p>\n<blockquote>\n<p>Can you generate a list of filenames + line numbers that indicate where we should look for trouble?</p>\n</blockquote>\n<p>Does the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/9934230730/job/27438230138?pr=14731\">output of CI</a> work?  The list of files is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Minimal</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Update</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Monoidal</span><span class=\"bp\">.</span><span class=\"n\">Category</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">FinCategory</span><span class=\"bp\">.</span><span class=\"n\">AsType</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"kt\">Sort</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Computability</span><span class=\"bp\">.</span><span class=\"n\">TuringMachine</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">MLList</span><span class=\"bp\">.</span><span class=\"n\">BestFirst</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Birkhoff</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">Finite</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">GroupWithZero</span><span class=\"bp\">.</span><span class=\"n\">NonZeroDivisors</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GroupTheory</span><span class=\"bp\">.</span><span class=\"n\">Perm</span><span class=\"bp\">.</span><span class=\"n\">Sign</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">Preserves</span><span class=\"bp\">.</span><span class=\"n\">Limits</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">Additive</span><span class=\"bp\">.</span><span class=\"n\">AP</span><span class=\"bp\">.</span><span class=\"n\">Three</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">OreLocalization</span><span class=\"bp\">.</span><span class=\"n\">Ring</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">Map</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Order</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Pi</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Field</span><span class=\"bp\">.</span><span class=\"n\">Subfield</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GroupTheory</span><span class=\"bp\">.</span><span class=\"n\">QuotientGroup</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Topology</span><span class=\"bp\">.</span><span class=\"n\">Bases</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Opposite</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">SimpleGraph</span><span class=\"bp\">.</span><span class=\"n\">DegreeSum</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GroupTheory</span><span class=\"bp\">.</span><span class=\"n\">CommutingProbability</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">MonoidAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Degree</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">GlueData</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">Limits</span><span class=\"bp\">.</span><span class=\"n\">Preserves</span><span class=\"bp\">.</span><span class=\"n\">Shapes</span><span class=\"bp\">.</span><span class=\"n\">Kernels</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">Optimization</span><span class=\"bp\">.</span><span class=\"n\">ValuedCSP</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">Module</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">StdBasis</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">GroupTheory</span><span class=\"bp\">.</span><span class=\"n\">SpecificGroups</span><span class=\"bp\">.</span><span class=\"n\">Alternating</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">ContinuedFractions</span><span class=\"bp\">.</span><span class=\"n\">Computation</span><span class=\"bp\">.</span><span class=\"n\">ApproximationCorollaries</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">CategoryTheory</span><span class=\"bp\">.</span><span class=\"n\">GradedObject</span><span class=\"bp\">.</span><span class=\"n\">Single</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">HahnSeries</span><span class=\"bp\">.</span><span class=\"n\">Multiplication</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Convex</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">Localization</span><span class=\"bp\">.</span><span class=\"n\">Module</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Calculus</span><span class=\"bp\">.</span><span class=\"n\">Deriv</span><span class=\"bp\">.</span><span class=\"n\">Mul</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">InnerProductSpace</span><span class=\"bp\">.</span><span class=\"n\">GramSchmidtOrtho</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Analytic</span><span class=\"bp\">.</span><span class=\"n\">Polynomial</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">FieldTheory</span><span class=\"bp\">.</span><span class=\"n\">NormalClosure</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">NormedSpace</span><span class=\"bp\">.</span><span class=\"n\">TrivSqZeroExt</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">FieldTheory</span><span class=\"bp\">.</span><span class=\"n\">Finite</span><span class=\"bp\">.</span><span class=\"n\">GaloisField</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Lie</span><span class=\"bp\">.</span><span class=\"n\">Weights</span><span class=\"bp\">.</span><span class=\"n\">Cartan</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">LinearAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Matrix</span><span class=\"bp\">.</span><span class=\"n\">LDL</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Module</span><span class=\"bp\">.</span><span class=\"n\">Zlattice</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">.</span><span class=\"n\">Measure</span><span class=\"bp\">.</span><span class=\"n\">Haar</span><span class=\"bp\">.</span><span class=\"n\">Quotient</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">DedekindDomain</span><span class=\"bp\">.</span><span class=\"n\">Different</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Probability</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">Stopping</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Calculus</span><span class=\"bp\">.</span><span class=\"n\">LineDeriv</span><span class=\"bp\">.</span><span class=\"n\">IntegrationByParts</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">NumberField</span><span class=\"bp\">.</span><span class=\"n\">Embeddings</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Distribution</span><span class=\"bp\">.</span><span class=\"n\">SchwartzSpace</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Probability</span><span class=\"bp\">.</span><span class=\"n\">Kernel</span><span class=\"bp\">.</span><span class=\"n\">Condexp</span>\n</code></pre></div>\n<p>(some of these could be false positives, but I have not yet observed one).</p>",
        "id": 451424741,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721026905
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451421562\">said</a>:</p>\n<blockquote>\n<p>In fact is it even clear what happens if you state a lemma which only mentions <code>*</code> at this point? Do you pick up a random one or is it deterministic? It's likely that the statement will not use any group properties but the proof will so presumably the statement must get the group one or else the proof wouldn't work</p>\n</blockquote>\n<p>I have not investigated this, but the <code>variable</code> behaviour is very \"dangerous\": after I mis-ported a file due to not realizing what <code>variable</code> actually did, I have been very very worried of <code>variable</code>.</p>",
        "id": 451425172,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721027080
    },
    {
        "content": "<p>Here is a \"fix\" of one file: <a href=\"https://github.com/leanprover-community/mathlib4/pull/14746\">#14746</a>.</p>\n<p>It is a real challenge to know whether or not separating the typeclasses made some lemmas assume too much.</p>",
        "id": 451426145,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721027465
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451424741\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451421557\">said</a>:</p>\n<blockquote>\n<p>Can you generate a list of filenames + line numbers that indicate where we should look for trouble?</p>\n</blockquote>\n<p>Does the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/9934230730/job/27438230138?pr=14731\">output of CI</a> work? </p>\n</blockquote>\n<p>Thanks for the list of filenames. The CI output is quite intimidating with its thousands of lines.</p>",
        "id": 451426972,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1721027820
    },
    {
        "content": "<p>The output is long, but if you look at it file-by-file it is not so bad!</p>",
        "id": 451429421,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721028669
    },
    {
        "content": "<p>Let me do a \"read\" of one file!</p>",
        "id": 451429456,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721028683
    },
    {
        "content": "<p>I had a recent PR merged that changed RingTheory.HahnSeries.Multiplication.  CI complained about line 85, but I cannot see a problem.</p>",
        "id": 451429795,
        "sender_full_name": "Scott Carnahan",
        "timestamp": 1721028811
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">‚ö†</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4711</span><span class=\"bp\">/</span><span class=\"mi\">4819</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Calculus</span><span class=\"bp\">.</span><span class=\"n\">LineDeriv</span><span class=\"bp\">.</span><span class=\"n\">IntegrationByParts</span>\n<span class=\"n\">trace</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">.&gt;</span><span class=\"w\"> </span><span class=\"n\">LEAN_PATH</span><span class=\"bp\">=././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">batteries</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Qq</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">proofwidgets</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Cli</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">importGraph</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"o\">:</span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"n\">LD_LIBRARY_PATH</span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/.</span><span class=\"n\">elan</span><span class=\"bp\">/</span><span class=\"n\">toolchains</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"c1\">--lean4---v4.10.0-rc2/bin/lean -Dpp.unicode.fun=true -DautoImplicit=false -DrelaxedAutoImplicit=false ././././Mathlib/Analysis/Calculus/LineDeriv/IntegrationByParts.lean -R ./././. -o ././.lake/build/lib/Mathlib/Analysis/Calculus/LineDeriv/IntegrationByParts.olean -i ././.lake/build/lib/Mathlib/Analysis/Calculus/LineDeriv/IntegrationByParts.ilean -c ././.lake/build/ir/Mathlib/Analysis/Calculus/LineDeriv/IntegrationByParts.c --json</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Calculus</span><span class=\"bp\">/</span><span class=\"n\">LineDeriv</span><span class=\"bp\">/</span><span class=\"n\">IntegrationByParts</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">183</span><span class=\"o\">:</span><span class=\"mi\">22</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Typeclass</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">[</span><span class=\"n\">IsScalarTower</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">ùïú</span>\n<span class=\"w\">      </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">implied</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BorelSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FiniteDimensional</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsAddHaarMeasure</span><span class=\"w\"> </span><span class=\"n\">Œº</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAlgebra</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAlgebra</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]]</span>\n<span class=\"n\">note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">disabled</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">dependentTypeclass</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>This is just saying that `IsScalarTower ‚Ñù ùïú G]  is implied by (a subset of)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MeasurableSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">BorelSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FiniteDimensional</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsAddHaarMeasure</span><span class=\"w\"> </span><span class=\"n\">Œº</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAlgebra</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedField</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAlgebra</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"o\">],</span>\n<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]]</span>\n</code></pre></div>",
        "id": 451429949,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721028863
    },
    {
        "content": "<p>I think that a reasonable way forward is to</p>\n<ul>\n<li>make Lean print the actual instances that are used by <code>inferInstance</code>, so that it removes the other typeclasses that do not play a role in the inference;</li>\n<li>automatically flag lemmas that compile with those \"bigger\" typeclasses removed, so that you can move to an earlier place in the file the corresponding lemma.</li>\n</ul>",
        "id": 451430187,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721028950
    },
    {
        "content": "<p>As for the length of the <code>CI</code> output, each built file produces a line (already ~4k lines!) and each time the linter fires, there is one extra line for <code>you can disable this linter by...</code>.</p>",
        "id": 451430458,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721029020
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"630477\">Scott Carnahan</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451429795\">said</a>:</p>\n<blockquote>\n<p>I had a recent PR merged that changed RingTheory.HahnSeries.Multiplication.  CI complained about line 85, but I cannot see a problem.</p>\n</blockquote>\n<p>Scott, was this meant for this thread?  The linter that is being discussed here is just a prototype.</p>",
        "id": 451430690,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721029092
    },
    {
        "content": "<p>Yes, I meant I looked at the output of CI that you linked, and looked at the current file, but could not see the variable problem that CI mentioned.  Perhaps I was reading it wrong.</p>",
        "id": 451431199,
        "sender_full_name": "Scott Carnahan",
        "timestamp": 1721029291
    },
    {
        "content": "<p>If you want to paste the output here, I can try to clarify it.</p>",
        "id": 451431771,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721029492
    },
    {
        "content": "<p>Oh, I found it by looking at the file.</p>",
        "id": 451433282,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721029992
    },
    {
        "content": "<p>This is what happens:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œì</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">Œì</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span>\n\n<span class=\"sd\">/-- The casting function to the type synonym. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œì</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">Œì</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">HahnSeries</span><span class=\"w\"> </span><span class=\"n\">Œì</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ</span><span class=\"w\"> </span><span class=\"n\">HahnModule</span><span class=\"w\"> </span><span class=\"n\">Œì</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n\n<span class=\"sd\">/-- Recursion principle to reduce a result about the synonym to the original type. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">elab_as_elim</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HahnModule</span><span class=\"w\"> </span><span class=\"n\">Œì</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HahnSeries</span><span class=\"w\"> </span><span class=\"n\">Œì</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">motive</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">ext</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HahnModule</span><span class=\"w\"> </span><span class=\"n\">Œì</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">coeff</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">coeff</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"bp\">.</span><span class=\"n\">injective</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">HahnSeries</span><span class=\"bp\">.</span><span class=\"n\">coeff_inj</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">V</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SMul</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">V</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>the linter flags <code>[Zero V]</code> on the <em>first</em> line, when it parses <code>[AddCommMonoid V]</code> on the last line of the excerpt above.</p>",
        "id": 451433472,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721030054
    },
    {
        "content": "<p>This case is subtle, since I actually think that this is ok, because the <code>V</code> from before is shadowed, but I am not completely sure.</p>\n<p>Even if it is ok, I would probably still think that \"good\" code should section this better.  I consider this a \"success\" of the linter.</p>",
        "id": 451433974,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721030222
    },
    {
        "content": "<p>(Btw, this \"action at a distance\" can be confusing and I am still trying to figure out what would be a good way of reporting it.)</p>",
        "id": 451437521,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721031158
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/recyclable.20variables/near/451421562\">said</a>:</p>\n<blockquote>\n<p>In fact is it even clear what happens if you state a lemma which only mentions <code>*</code> at this point? Do you pick up a random one or is it deterministic? It's likely that the statement will not use any group properties but the proof will so presumably the statement must get the group one or else the proof wouldn't work</p>\n</blockquote>\n<p>While trying to figure out whether there is a pattern to this, I found this very cryptic failure:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Z</span><span class=\"o\">}</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semigroup</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">]</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">mul_assoc</span><span class=\"w\"> </span><span class=\"bp\">..</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">synthesized type class instance is not definitionally equal to expression inferred by typing rules, synthesized</span>\n<span class=\"cm\">  inst‚úù¬π</span>\n<span class=\"cm\">inferred</span>\n<span class=\"cm\">  Monoid.toSemigroup</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Instead of Lean just picking either one of the typeclasses that work, you get an error.  The end result is probably that the user will remove <code>Group</code>, but this is likely after a while of being confused by the error message.</p>",
        "id": 451447650,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721034122
    },
    {
        "content": "<p>I think I understand now.  It looks like you are working with a version of the file from before the PR was merged.  However, I am quite impressed that the linter was able to pick up that pair.</p>",
        "id": 451457957,
        "sender_full_name": "Scott Carnahan",
        "timestamp": 1721037353
    },
    {
        "content": "<p>I just pushed another attempt at better reporting issues.  The linter is now more or less aware of which typeclass assumptions are used in the implication, as well as whether the flag of an issue happens \"far away\".  Here is an example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">DependentTypeclass</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Z</span><span class=\"o\">}</span>\n\n<span class=\"c\">/-</span><span class=\"cm\">  warning here:</span>\n<span class=\"cm\">Typeclass '[Semigroup Z]' follows from '{Z} [MonoidWithZero Z] ‚Ü¶ inferInstance'</span>\n<span class=\"cm\">note: this linter can be disabled with `set_option linter.dependentTypeclass false`</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semigroup</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"c1\">-- underlined in yellow</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> info here:</span>\n<span class=\"cm\">The assumptions '{Z} [MonoidWithZero Z]' imply the earlier assumption '[Semigroup Z]'</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MonoidWithZero</span><span class=\"w\"> </span><span class=\"n\">Z</span><span class=\"o\">]</span><span class=\"w\">  </span><span class=\"c1\">-- underlined in blue</span>\n</code></pre></div>",
        "id": 451525392,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721056782
    },
    {
        "content": "<p>If instead a single block of <code>variable</code>s already has some dependency, then the linter just underlines the \"implied\" typeclasses and, for each one, it tells you which other ones are used for the implication.</p>",
        "id": 451525716,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721056883
    },
    {
        "content": "<p>This is still slightly hacky, since I get precise <code>Expr</code> information about which typeclass assumptions are needed, but I am finding it trick to convert it back to <code>Syntax</code> information that is what the linter has direct access to.  But it seems to work.</p>",
        "id": 451525928,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721056940
    },
    {
        "content": "<p>What I consider to be the main missing usability feature for this, is flagging which lemmas that appear <em>after</em> a dependency in typeclasses is introduced can be actually proved <em>before</em> the dependency is introduced.</p>\n<p>E.g. in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"bp\">...</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">involving</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"bp\">&gt;</span>\n</code></pre></div>\n<p>flagging <code>Y</code> as needing to move earlier.</p>",
        "id": 451527888,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721057501
    },
    {
        "content": "<p>This will likely have to wait a couple of days, though!</p>",
        "id": 451528029,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1721057531
    },
    {
        "content": "<p>If anyone feels like helping out, please take a look at the output of the linter at <a href=\"https://github.com/leanprover-community/mathlib4/pull/14731\">#14731</a>.</p>",
        "id": 512361862,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744733567
    },
    {
        "content": "<p>The yellow squiggles tell you which typeclass assumption are implied by the blu squiggles.  Typically, you first see the yellow squiggles and they become redundant when the blue squiggles become part in scope.</p>",
        "id": 512361871,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744733570
    },
    {
        "content": "<p>For instance in <code>Mathlib/RingTheory/Valuation/ValExtension.lean</code>,</p>\n<ul>\n<li>on line 51 there are <code>[LinearOrderedCommMonoidWithZero ŒìR] [LinearOrderedCommMonoidWithZero ŒìA]</code> with yellow squiggles and</li>\n<li>on line 97-98 there are <code>[LinearOrderedCommGroupWithZero ŒìR] [LinearOrderedCommGroupWithZero ŒìA]</code> with blue squiggles.</li>\n</ul>\n<p>So, once you reach line 97-98, it is likely that the older <code>variable</code>s are no longer desirable and can only cause trouble,</p>",
        "id": 512362363,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744733706
    },
    {
        "content": "<p>This looks like a dangling sentence. Would you like to finish it? (I'm certainly curious how this post ends :-))</p>",
        "id": 512364239,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744734219
    },
    {
        "content": "<p>Ah,<br>\n... so some work needs to be done.</p>",
        "id": 512364435,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744734268
    },
    {
        "content": "<p>However, simply sectioning out the older ones and copying over the new ones may force Lean to use the stronger assumption, when the weaker was actually used.</p>",
        "id": 512364540,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744734299
    },
    {
        "content": "<p>This requires care and probably more metaprogram help to make sure that by sectioning off the weaker assumptions you are not actually increasing the hypotheses of later declarations.</p>",
        "id": 512364649,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744734335
    },
    {
        "content": "<p>In an ideal world, once the blue squiggle appears, the yellow-squiggled variable should disappear from scope.</p>",
        "id": 512364891,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744734390
    },
    {
        "content": "<p>There is some care to be taken in case some <em>later</em> declarations can be moved earlier with the weaker assumptions.</p>",
        "id": 512364999,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744734418
    },
    {
        "content": "<p>It is possible that \"mathlib builds\" is already a good test that instances have not been strengthened.</p>",
        "id": 512365115,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744734449
    },
    {
        "content": "<p>Otherwise, these will be picked up by the typeclass generalization tool... <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span></p>",
        "id": 512365210,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744734471
    },
    {
        "content": "<p>I left comment on the PR but it would be good to get more exposure to understand the desired user experience. </p>\n<p>I am somewhat worried about hammering <code>infer_instance</code> to check for overlaps on each <code>variable</code>. </p>\n<p>The examples above make me think we should only care about local instance overlap for a core style linter and perhaps leave deeper checks for CI.</p>",
        "id": 515322400,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746023899
    }
]