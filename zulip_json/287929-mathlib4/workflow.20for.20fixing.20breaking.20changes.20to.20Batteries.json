[
    {
        "content": "<p>Last week, a workflow has been added for PRs to Batteries to be automatically tested against mathlib, but i don't know there has been a discussion on how to proceed when a breaking change is suggested.</p>\n<p>In the particular case i'm working with (<a href=\"https://github.com/leanprover-community/Batteries/pull/948\">Batteries#948</a>), it is the case that a mathlib test (for the <code>#help</code> command, i.e. in <code>./test/help_cmd.lean</code>) now fails due to the addition of a command with syntax for which \"#chec\" is a prefix. </p>\n<p>The adaptation for mathlib is easy, adding the reported documentation to the expected message in the test, and i have a commit to that effect ready, to be added on top of <a href=\"https://github.com/leanprover-community/mathlib4/tree/batteries-pr-testing-948\">branch#batteries-pr-testing-948</a> ...</p>\n<p>How should we proceed?</p>",
        "id": 473346117,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727529646
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries/near/473346117\">said</a>:</p>\n<blockquote>\n<p>to be added on top of <a href=\"https://github.com/leanprover-community/mathlib4/tree/batteries-pr-testing-948\">branch#batteries-pr-testing-948</a></p>\n</blockquote>\n<p>or maybe there should be a branch <code>nightly-batteries-testing</code> for such fixes to be added on top of, once it's merged into batteries?</p>",
        "id": 473346848,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727529911
    },
    {
        "content": "<p>also feel free to move this topic elsewhere if this was not the appropriate place to ask this question...</p>",
        "id": 473348408,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727530670
    },
    {
        "content": "<p>Actually, the feature was added yesterday! <a href=\"https://github.com/leanprover-community/batteries/pull/948\">batteries#948</a> was the first PR to \"unintentionally\" test it.</p>",
        "id": 473355219,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727534767
    },
    {
        "content": "<p>There hasn't been much discussion about this. The plan was to add this tool to give Batteries maintainers a heads up that there will be a Mathlib adaptation after a PR is merged.</p>",
        "id": 473355439,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727534963
    },
    {
        "content": "<p>Of course, nobody would complain if a user proposed an adaptation instead.</p>",
        "id": 473355571,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727535029
    },
    {
        "content": "<p>The mathlib test for <code>#help</code> should be migrated to batteries in the same PR that migrates <code>#help</code> itself</p>",
        "id": 473363933,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727541440
    },
    {
        "content": "<p>The workflow that would result in the least work for others would be: </p>\n<ul>\n<li>if you get a <code>breaks-mathlib</code> label, push changes to <code>batteries-pr-testing-NNNN</code> until you get a <code>builds-mathlib</code> (or ask for help if you can't) </li>\n<li>then open a PR to Mathlib from that branch, adding the <code>depends-on-batteries-PR</code> label, linking to the batteries PR, and ask for a delegation</li>\n<li>(This label doesn't prevent things being on the <a href=\"https://bit.ly/3Ymuh0U\">#queue</a>, right?)</li>\n<li>Once the Mathlib PR is delegated, a maintainer can merge the Batteries PR</li>\n<li>and then the author can change the batteries branch on the Mathlib PR back to <code>main</code> and hit merge (or anyone can do this step if needed to avoid a breakage in to the automatic <code>lake update</code> processes on Mathlib's <code>master</code> and <code>nightly-testing</code> branches)</li>\n</ul>",
        "id": 473390356,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727562511
    },
    {
        "content": "<p>That requires a lot of responsiveness from the users. Especially the last two steps require a fair amount of timeliness.</p>",
        "id": 473392354,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727564759
    },
    {
        "content": "<p>I would change the first step to:</p>\n<ul>\n<li>if you get a <code>breaks-mathlib</code> label, don't worry, that's not necessarily unexpected</li>\n<li>after the review process, a maintainer may ask you to assist with a Mathlib adaptation PR</li>\n</ul>",
        "id": 473393136,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727565639
    },
    {
        "content": "<p>Hmm, I disagree, that will just push the work back on maintainers.</p>\n<p>The <code>breaks-mathlib</code> label should come with much better explanation of what the author needs to do next, of course.</p>",
        "id": 473393906,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727566547
    },
    {
        "content": "<p>How about this:</p>\n<ul>\n<li>if you get a <code>breaks-mathlib</code> label, don't worry, that's not necessarily unexpected and there is nothing to do until the review process has completed</li>\n<li>after the review process, a maintainer will ask you to make a Mathlib adaptation PR, if necessary</li>\n</ul>\n<p>I don't want users to worry about the <code>breaks-mathlib</code> label until <em>after</em> the review process.</p>",
        "id": 473396157,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727569042
    },
    {
        "content": "<p>I guess the Batteries maintainer could do the last few steps on the Mathlib side (i.e. point batteries in the lakefile back to main, run lake update batteries, and ask bors to merge). That way there's not too much need for timeliness in the last step.</p>",
        "id": 473396584,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727569470
    },
    {
        "content": "<p>In fact, that can be simplified to two easy steps for the maintainer by packing editing lakefile, running lake update batteries and push in a script that we sneak into every batteries-pr-testing-NNNN branch.</p>",
        "id": 473396887,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727569701
    },
    {
        "content": "<p>I don't know much about bors but perhaps it can be used to simplify further to one easy step?</p>",
        "id": 473397079,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727569814
    },
    {
        "content": "<p>Yes, we really should have a bot that will detect when a Batteries PR is merged, and if there is a delegated PR from the corresponding <code>batteries-pr-testing-NNNN</code> branch, just sends it to bors...</p>",
        "id": 473407863,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727581398
    },
    {
        "content": "<p>(A little scary having a bot run bors merge...?)</p>",
        "id": 473407872,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727581408
    },
    {
        "content": "<p>Maybe that's too much, and better is just that the bot posts in <a class=\"stream\" data-stream-id=\"345428\" href=\"/#narrow/stream/345428-mathlib-reviewers\">#mathlib reviewers</a> asking for someone to merge.</p>",
        "id": 473407890,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727581438
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119741\">François G. Dorais</span> <a href=\"#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries/near/473396157\">said</a>:</p>\n<blockquote>\n<p>I don't want users to worry about the <code>breaks-mathlib</code> label until <em>after</em> the review process.</p>\n</blockquote>\n<p>I think I disagree here. Certainly we don't have enough documentation / automatic explanation of what you're meant to do, but I'd prefer this work is by default belonging to the authors, not the maintainers.</p>",
        "id": 473408621,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727582238
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries/near/473408621\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"119741\">François G. Dorais</span> <a href=\"#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries/near/473396157\">said</a>:</p>\n<blockquote>\n<p>I don't want users to worry about the <code>breaks-mathlib</code> label until <em>after</em> the review process.</p>\n</blockquote>\n<p>I think I disagree here. Certainly we don't have enough documentation / automatic explanation of what you're meant to do, but I'd prefer this work is by default belonging to the authors, not the maintainers.</p>\n</blockquote>\n<p>There's too much other stuff to worry about in the early stages of a PR. The user should focus on making the PR suitable for Batteries. Working on the Mathlib adaptation is only relevant after that's achieved, it's a waste of time to work on that before.</p>",
        "id": 473411525,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727585212
    },
    {
        "content": "<p>Making the <code>builds-mathlib</code> criterion a target will more than likely decrease the utility of the criterion. Users  will be encouraged to use quick but mediocre solutions just to pass the test, or create extremely messy solutions because of dozens of pointless edits. I strongly prefer to deemphasize the <code>builds-mathlib</code> tag early on in the PR process.</p>",
        "id": 473412477,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727586042
    },
    {
        "content": "<p>I'd say that since mathlib depends on batteries, surely it's not the responsibility of a batteries contributor to also make sure mathlib builds?</p>",
        "id": 473416251,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727589499
    },
    {
        "content": "<p>And although it is nice to have as little breakage as possible, that should not withhold us from making some changes</p>",
        "id": 473416376,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1727589605
    },
    {
        "content": "<p>If we merge a Batteries PR that will break Mathlib, in practice that means most times I get to fix it. At present Batteries and Mathlib are too tightly coupled, and many things are unpleasant if they get out of sync. So I'm not planning on merging anything where I expect Mathlib to break, and the fix not to be available!</p>",
        "id": 473417670,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727590681
    },
    {
        "content": "<p>^most: at least, over the last year. Not necessarily going forward. :-)</p>",
        "id": 473417821,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727590809
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries/near/473417670\">said</a>:</p>\n<blockquote>\n<p>So I'm not planning on merging anything where I expect Mathlib to break, and the fix not to be available!</p>\n</blockquote>\n<p>This is still compatible with François' preference above that during initial review there is no need to get Mathlib fixed.  It would mean that there's a <em>later</em> stage of review where we get this sorted.</p>",
        "id": 473419820,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727592597
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries/near/473419820\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/workflow.20for.20fixing.20breaking.20changes.20to.20Batteries/near/473417670\">said</a>:</p>\n<blockquote>\n<p>So I'm not planning on merging anything where I expect Mathlib to break, and the fix not to be available!</p>\n</blockquote>\n<p>This is still compatible with François' preference above that during initial review there is no need to get Mathlib fixed.  It would mean that there's a <em>later</em> stage of review where we get this sorted.</p>\n</blockquote>\n<p>I've tested the bot on a bunch a lot of recent PRs. I've seen both false positives and false negatives. The error rate is significant and sometimes for really menial issues like network errors.</p>\n<p>I think we can all agree that this needs to be a two-stage process where users are instructed to ignore the <code>builds-mathlib</code>/<code>breaks-mathlib</code> tags until a maintainer says that a Mathlib adaptation is needed. Then, the maintainers will not merge until the Mathlib adaptation is ready.</p>\n<p>Now we need to hash out the implementation of this two-stage review process.</p>",
        "id": 474037535,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727789134
    },
    {
        "content": "<p>Let's see if we can fix the some of the false positive / negatives!</p>",
        "id": 474159163,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727831981
    },
    {
        "content": "<p>They were all very contextual so fixing is not really an option.</p>\n<ul>\n<li>The false <code>builds-mathlib</code> were because no part of Mathlib imported both the conflicting parts of Batteries and Mathlib. This is a consequence of minimizing imports, which should not be compromised for the purpose of this test.</li>\n<li>There were many false causes for <code>breaks-mathlib</code>. One was a network error (rare and not hard to diagnose). Most were because Mathlib itself wasn't quite up to date when the check started. </li>\n</ul>\n<p>In almost all cases I've observed, there was no systematic thing that the bot could reasonably do to fix the error.</p>",
        "id": 474175861,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727838315
    },
    {
        "content": "<p>For the first problem, I don't understand. There's a test file that imports Mathlib and Batteries.</p>",
        "id": 474183333,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727841248
    },
    {
        "content": "<p>This is <a href=\"https://github.com/leanprover-community/batteries/pull/969\">batteries#969</a>. This is an unusual case. Just importing Mathlib and Batteries isn't enough since the two help commands are in different namespaces.</p>",
        "id": 474189563,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1727843420
    },
    {
        "content": "<p>Okay, in that case it sounds like on acceptable false positive.</p>",
        "id": 474189972,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727843635
    }
]