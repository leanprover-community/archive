[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24465\">#24465</a> contains a linter that enforces whitespace formatting on all declarations up to and excluding the type signature.  Essentially, it checks that the \"hypotheses\" of each declaration are correctly formatted.</p>",
        "id": 515514619,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746109486
    },
    {
        "content": "<p>While the scope is limited, the linter found hundreds of exceptions in mathlib, including one in <a href=\"https://github.com/leanprover-community/mathlib4/pull/24119\">#24119</a>, merged 8 hours ago.</p>",
        "id": 515514632,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746109491
    },
    {
        "content": "<p>The PR is long, but a lot of it is documentation, tests and making the tests compliant.  All the mathlib adaptation PRs that resulted from it have been completely straightforward.</p>",
        "id": 515514646,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746109496
    },
    {
        "content": "<p>Another strong point in favour of the linter is that it has no \"special-casing\", although it has an exclusion mechanism to allow the linter to ignore parts of a declaration, based on the syntax type that gave rise to them.</p>",
        "id": 515514660,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746109499
    },
    {
        "content": "<p>Overall, I think that it works very well and the fact that there isn't a single exception in all of mathlib seems a strong endorsement!</p>",
        "id": 515514665,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746109501
    },
    {
        "content": "<p>Some previous discussions:</p>\n<ul>\n<li><a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Linting.20space.20around.20variables/with/504535993\">#mathlib4 &gt; Linting space around variables</a> </li>\n<li><a class=\"message-link\" href=\"/#narrow/channel/113488-general/topic/Mathlib.20community.20meetings/near/499861275\">#general &gt; Mathlib community meetings @ ðŸ’¬</a></li>\n</ul>",
        "id": 515515360,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746109716
    },
    {
        "content": "<p>As I already said on github (also perhaps on a related PR), I think this is great to have. I look forward to extending this linter in the future, towards checking all formatting (with an opt-out for syntax it doesn't understand). I can try to review the linter implementation soon.</p>",
        "id": 515520422,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746111213
    },
    {
        "content": "<p>Let me dream big: what is needed to make this closer to an auto-formatter, i.e. enable the author of a pull request to automatically reformat all affected lines to comply with the linter? I presume there are two steps:</p>\n<ul>\n<li>making the linter generate \"try this\" suggestions (or similar) --- this is blocked on <a href=\"https://github.com/leanprover/lean4/pull/4363\">lean#4363</a> (the RFC is accepted, I think - and medium priority)</li>\n<li>some way of \"apply all try this suggestions in this file\" (which could be be useful in many other settings also, such as tryAtEachStep or for auto-fixing all non-terminal simps, and generally for self-rewriting code)</li>\n</ul>\n<p>Is there a way to move any of these items forward?</p>",
        "id": 515520463,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746111230
    },
    {
        "content": "<p>(Without opening the can of worms that is <code>lake exe refactor</code>.)</p>",
        "id": 515520942,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1746111377
    },
    {
        "content": "<p>Right now, the linter piggy-backs on the pretty-printer for deciding what is correctly formatted or not (plus a little custom-handling of where to put line breaks).</p>",
        "id": 515522532,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746111850
    },
    {
        "content": "<p>However, the pretty-printer has too many short-comings to be reliably used as an \"oracle formatter\".  This, I view as the main obstacle, and the linter takes no step in this direction.</p>",
        "id": 515522716,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746111915
    },
    {
        "content": "<p>The other question, of automated code-editing is certainly (and easily) within reach.  I think that all that is lacking is the desire to accept one way as the standard and then build infrastructure around it.</p>",
        "id": 515522946,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746111957
    },
    {
        "content": "<p>I ran a few tests, before and after <code>refactor</code>, using it and not using it.  They all worked, of course each with its pros and cons.</p>",
        "id": 515523135,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746112010
    },
    {
        "content": "<p>Here is another recent whitespace lint: <a href=\"https://github.com/leanprover-community/mathlib4/pull/24585\">#24585</a>.</p>",
        "id": 515992784,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746335135
    },
    {
        "content": "<p>One thing I would love to have in this vein is something like the vscode typescript formatter. It's very non-judgmental, it doesn't try to do any extra line breaking, and mainly just makes sure that indentation of successive lines is correct and whitespace around operators and parentheses is correct, which means that you get the easy stuff fixed and can leave the harder questions for manual intervention, which seems like a good compromise for a hugely complex syntax like lean's where we want to err on the side of doing something useful but not making a mess</p>",
        "id": 516322547,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1746492368
    },
    {
        "content": "<p>Out of curiosity, why is there <code>Symbol</code> in CommandStart.lean?</p>",
        "id": 516360643,
        "sender_full_name": "Martin DvoÅ™Ã¡k",
        "timestamp": 1746513709
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"417654\">Martin DvoÅ™Ã¡k</span> <a href=\"#narrow/channel/287929-mathlib4/topic/A.20whitespace.20linter/near/516360643\">said</a>:</p>\n<blockquote>\n<p>Out of curiosity, why is there <code>Symbol</code> in CommandStart.lean?</p>\n</blockquote>\n<p>This is a test: at some point, the linter flagged it as an error and I made it into one of the test elements.</p>",
        "id": 516362106,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746514316
    },
    {
        "content": "<p>With respect to Mario's comment, the linter implements a very initial step towards that: it verifies whitespace around variables, but trusts line breaks provided by the source code.  It also does not provide autocorrection.</p>",
        "id": 516362952,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746514633
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24664\">#24664</a></p>",
        "id": 516704452,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1746630870
    },
    {
        "content": "<p>Yet more whitespace: <a href=\"https://github.com/leanprover-community/mathlib4/pull/24837\">#24837</a>.</p>",
        "id": 517777281,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747127617
    },
    {
        "content": "<p>Note also that these PRs are all completely automatic: the linter only suggests correct changes <span aria-label=\"trademark\" class=\"emoji emoji-2122\" role=\"img\" title=\"trademark\">:trademark:</span> . In case someone feels like merging it, here is the PR: <a href=\"https://github.com/leanprover-community/mathlib4/pull/24465\">#24465</a>!  <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 517777446,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747127671
    },
    {
        "content": "<p>I would love to see the linter in, and active on PRs, because it would save us a lot of boring work when reviewing. Unfortunately, I can't review it for lack of skills, sorry...</p>",
        "id": 517778491,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1747127993
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24946\">#24946</a></p>",
        "id": 518485230,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747384554
    },
    {
        "content": "<p>I also want to point out what I consider to be an added benefit of this linter: since it actually inspects the pretty-printed version of the various commands, it helps in catching situations where the newly introduced notation would not print accordingly to what you expect.  This happened in several of the past PRs, including the one I just linked to.</p>",
        "id": 518485739,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747384698
    },
    {
        "content": "<p>I view this as an incremental way of producing a formatter: little by little, the scope of the linter can expand and, each time there is a discrepancy between what has been written and how it pretty-prints, it may mean that there is a style decision to be made about what is the \"correct\" way of writing a particular part of the syntax.</p>",
        "id": 518485988,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747384785
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/25018\">#25018</a></p>",
        "id": 519068976,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747651699
    },
    {
        "content": "<p>Dear All,</p>\n<p>the whitespace linter has just made its way into mathlib!  Essentially, it checks for correct formatting of all declarations up to and excluding the type specification:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"c\">/-</span><span class=\"cm\"> end of checking -/</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 524541864,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750186627
    },
    {
        "content": "<p>As usual, with all such new additions, there may be issues: let me know if you run into any unwanted behaviour!</p>",
        "id": 524541929,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750186630
    },
    {
        "content": "<p>Are there currently files that violate the linter and could we have a look at an example? Sometimes I'm not sure if things need an extra indentation, like I'll write something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">very_long_proof_term_1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">moderately_long_proof_term</span>\n<span class=\"w\">      </span><span class=\"n\">the_complement_of_the_moderately_long_proof_term</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">proof_term_2</span><span class=\"w\"> </span><span class=\"n\">proof_term_3</span><span class=\"w\"> </span><span class=\"n\">proof_term_4</span>\n</code></pre></div>",
        "id": 524545392,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750186758
    },
    {
        "content": "<p>Specifically indentation is <em>not</em> something that the linter checks, it trusts that you know what you are doing.</p>",
        "id": 524546696,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750186807
    },
    {
        "content": "<p>Also, note that it only inspects the <em>hypotheses</em>, so such long terms are rare.</p>",
        "id": 524547571,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750186843
    },
    {
        "content": "<p>The main reason for these limitations is that the linter basically uses the pretty-printer as an oracle for formatting, and the pretty-printer is only reliable in a limited setting.</p>",
        "id": 524548770,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750186890
    },
    {
        "content": "<p>In fact, while making mathlib compliant, I uncovered several missing spaces in <code>syntax</code> declarations, since no one had ever looked at how they pretty-printed.</p>",
        "id": 524550331,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750186946
    },
    {
        "content": "<p>Ah, ok, I had a look at the <a href=\"https://github.com/leanprover-community/mathlib4/commit/1e3fd2ae72c72afc312889b3be4d1e9aba69f048\">diff</a>, very interesting, thanks</p>",
        "id": 524551524,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750187003
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/chi0Ccjfy5jxsvv5Q2TxKY5Q/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/chi0Ccjfy5jxsvv5Q2TxKY5Q/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1430x362\" src=\"/user_uploads/thumbnail/3121/chi0Ccjfy5jxsvv5Q2TxKY5Q/image.png/840x560.webp\"></a></div>",
        "id": 524552976,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750187061
    },
    {
        "content": "<p>it looks like this is the only instance where whitespaces issues were identified and fixed?</p>",
        "id": 524553212,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750187072
    },
    {
        "content": "<p>ah, and also a few instances of changing <code>notation_class *</code> to <code>notation_class*</code></p>",
        "id": 524556694,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750187202
    },
    {
        "content": "<p>For all (or almost all) the adaptation PRs that I made, I referenced the \"linter PR\", so they appear as comments.  There were <em>a lot</em> of exceptions.  Here are some examples.</p>\n<ul>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/24465\">#24465</a> -- the linter</li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/24459\">#24459</a></li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/24467\">#24467</a></li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/24472\">#24472</a></li>\n<li><a href=\"https://github.com/leanprover-community/mathlib4/pull/24501\">#24501</a></li>\n</ul>\n<p>and so on.</p>",
        "id": 524581933,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750188396
    },
    {
        "content": "<p>Note that the linter adds 2 minutes of linting time to the mathlib build, according to the <a href=\"https://speed.lean-lang.org/mathlib4/run-detail/7f7b1275-929d-4b32-b4ba-ae0316ee927d\">speedcenter</a>. Has this been considered and can it be improved?</p>",
        "id": 525091877,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750446576
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, I don't know if the preformance bottleneck is in <code>Lean.PrettyPrinter.ppCategory</code>, <code>Std.Format.pretty</code> or in the implementation of the linter itself. But what I find suspicious is that the linter works with <code>String</code> instead of <code>Substring</code>. This is very memory inefficient, because after every little string token that is being processed, you are allocating memory to copy the whole rest of the <code>String</code> (using <code>String.drop 1</code>). So I would suggest using <code>Substring</code> to avoid this extra memory allocation.</p>",
        "id": 525096032,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750448909
    },
    {
        "content": "<p>I tried doing so in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26240\">#26240</a>: some of these changes are definitely readability regressions. Let's see if this helps meaningfully...</p>",
        "id": 525104238,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1750454129
    },
    {
        "content": "<p>Actually, I had initially planned this linter to be a test for a new kind of \"relative\" linter.  However, since there were initially quite a few exceptions and the linter was not the easiest to write, I decided to leave the \"relative\" part for a later development.</p>",
        "id": 525105378,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750454877
    },
    {
        "content": "<p>Now, \"relative\" refers to the fact that I wanted this linter to only act on the git diff of a PR, and not on all of mathlib.  So, the plan is</p>\n<ul>\n<li>write the linter (done);</li>\n<li>make mathlib compliant (done);</li>\n<li>write the code for detecting the git diff and store it in an environment extension (partly done);</li>\n<li>hook the commandStart linter into the git diff mechanism, so it only inspects code that changes, since the other is already compliant.</li>\n</ul>",
        "id": 525105380,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750454879
    },
    {
        "content": "<p>Since I imagine that this will noticeably reduce the running time of the linter, I was not too worried about its performance.</p>",
        "id": 525105448,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750454916
    },
    {
        "content": "<p>In my experience such relative checks have a high likelihood of missing things over time and then failing when you touch code nearby. I'd carefully consider whether the tradeoffs are worth the increased complexity</p>",
        "id": 525105652,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1750455017
    },
    {
        "content": "<p>That is a possibility, so I was also toying with the idea that maybe <code>bors</code> would run the linter on all of mathlib.  At the same time, it is not like a misplaced whitespace is such a tragedy and there could be a monthly clean up run of all mathlib.</p>",
        "id": 525105847,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750455129
    },
    {
        "content": "<p>By the way, most style linters could hook into the \"relative\" mechanism as well.  And, moreover, the \"relative\" mechanism need not be so fine-grained at the declaration (or even syntax node level): the linter could simply run on every modified file, not just on the modified parts of the files.</p>",
        "id": 525106308,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750455407
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/A.20whitespace.20linter/near/525104238\">said</a>:</p>\n<blockquote>\n<p>I tried doing so in <a href=\"https://github.com/leanprover-community/mathlib4/pull/26240\">#26240</a></p>\n</blockquote>\n<p>The result shows that this is indeed somewhat of a performance improvement, but it only saves about 5 seconds.</p>\n<p>So, I think this does show that we might be better off with a \"relative\" linter, which runs on all changed files, and also runs every now and then on the whole of mathlib.</p>",
        "id": 525113857,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750461504
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> as a middle ground, is it possible to only do the linter for the <em>files</em> affected? (so bypassing the vulnerability of only focusing on the git diff, but also not running the linter on the whole mathlib)</p>",
        "id": 525118094,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750467054
    },
    {
        "content": "<p>I think that's what Damiano suggested in his last message</p>",
        "id": 525118824,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750468141
    },
    {
        "content": "<p>A first implementation of the \"git-aware\" version of the linter is available at <a href=\"https://github.com/leanprover-community/mathlib4/pull/26299\">#26299</a>.</p>",
        "id": 525321472,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750682100
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/26298\">#26298</a> is a test PR that should show that the linter is active on modified files, new or otherwise.</p>\n<p>EDIT: the test passed, since CI failed with error</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Some<span class=\"w\"> </span>required<span class=\"w\"> </span>builds<span class=\"w\"> </span>logged<span class=\"w\"> </span>failures:\n-<span class=\"w\"> </span>Mathlib.Data.Array.Extract\n-<span class=\"w\"> </span>Mathlib.New\n</code></pre></div>",
        "id": 525321767,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750682195
    },
    {
        "content": "<p>Bug report? <code>Type (u+1)</code> got corrected to <code>Type (u + 1)</code></p>",
        "id": 525403285,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750710518
    },
    {
        "content": "<p>I've been using <code>u + 1</code> when the linter suggested it.  Though we can switch back in case that is not desired.</p>",
        "id": 525403387,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1750710564
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/287929-mathlib4/topic/A.20whitespace.20linter/near/525403285\">said</a>:</p>\n<blockquote>\n<p>Bug report? <code>Type (u+1)</code> got corrected to <code>Type (u + 1)</code></p>\n</blockquote>\n<p>Is that not normal?</p>",
        "id": 525404924,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1750711422
    },
    {
        "content": "<p>that one might be worth taking a census for</p>",
        "id": 525405165,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750711526
    },
    {
        "content": "<p>my guess is that humans usually write it without spaces, but the formatter always uses spaces there</p>",
        "id": 525405231,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750711566
    },
    {
        "content": "<p>331 results for <code>u + 1</code> and 94 for <code>u+1</code> so maybe not</p>",
        "id": 525405354,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750711633
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">invalid universe level for field 'x', has type</span>\n<span class=\"cm\">  Type u</span>\n<span class=\"cm\">at universe level</span>\n<span class=\"cm\">  u+2</span>\n<span class=\"cm\">which is not less than or equal to the structure's resulting universe level</span>\n<span class=\"cm\">  u+1</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 525405815,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750711892
    },
    {
        "content": "<p>the printer sometimes uses <code>u+1</code> and sometimes uses <code>u + 1</code></p>",
        "id": 525405831,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1750711901
    },
    {
        "content": "<p>ah right, there is a second printer specifically for printing levels (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Level.format#src\">src#Lean.Level.format</a>)</p>",
        "id": 525406027,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750712003
    },
    {
        "content": "<p>I think that one will also do things like <code>(max u v)+1</code> instead of <code>max u v + 1</code></p>",
        "id": 525406064,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750712029
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">error: invalid universe level for field 'x', has type</span>\n<span class=\"sd\">  Sort (imax u v)</span>\n<span class=\"sd\">at universe level</span>\n<span class=\"sd\">  (imax u v)+1</span>\n<span class=\"sd\">which is not less than or equal to the structure's resulting universe level</span>\n<span class=\"sd\">  u+1</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Sort</span><span class=\"w\"> </span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n\n<span class=\"sd\">/-- info: Type (imax u v) : Type ((imax u v) + 1) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">imax</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n</code></pre></div>",
        "id": 525406365,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750712183
    },
    {
        "content": "<p>I guess the normal printer also puts unnecessary parentheses there</p>",
        "id": 525406414,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750712211
    },
    {
        "content": "<p>i've always treated universe expressions as though they were any others, meaning spaces around <code>+</code>... TIL some people disagree</p>",
        "id": 525410174,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1750714182
    },
    {
        "content": "<p>Here's an interesting issue I encountered when leaving an extra space at the end of the <code>@[simp]</code> line:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>It gives the error</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">remove</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"n\">break</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">source</span>\n\n<span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">part</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">code</span>\n<span class=\"w\">  </span><span class=\"bp\">'</span><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"bp\">'</span>\n<span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">written</span><span class=\"w\"> </span><span class=\"n\">as</span>\n<span class=\"w\">  </span><span class=\"bp\">'</span><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"bp\">'</span>\n\n\n<span class=\"n\">Note</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">disabled</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">commandStart</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>Both the replacement suggestion and the error message are confusing here.<br>\nInstead of just <code>remove line break in the source</code>, maybe a better message would be <code>whitespace linter: please remove the extra whitespace</code>.</p>",
        "id": 528087261,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752155465
    },
    {
        "content": "<p>This looks similar to <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Bug.20in.20commandStart.20linter.20error.20message/near/526997878\">#mathlib4 &gt; Bug in commandStart linter error message @ ðŸ’¬</a>, right?</p>",
        "id": 528110178,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752161732
    },
    {
        "content": "<p>It is true that removing the line break would also silence the linter.  I may make the message say that <em>one way</em> of silencing the linter is to follow its suggestion, but it is not <em>the only</em> way to silence it.</p>",
        "id": 528110309,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752161778
    },
    {
        "content": "<p>(Also, I have an option that automatically removes trailing whitespace on every line upon saving, so I am very rarely in a situation such as the one that you describe.)</p>",
        "id": 528110463,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752161822
    },
    {
        "content": "<p>I also have that option, but I'm not always saving files immediately :)</p>",
        "id": 528110758,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752161916
    },
    {
        "content": "<p>I do save pretty obsessively my files, to be honest... <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 528110912,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752161950
    },
    {
        "content": "<p>Oh, I only realize now that the linter meant to suggest</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">written</span><span class=\"w\"> </span><span class=\"n\">as</span>\n<span class=\"w\">  </span><span class=\"bp\">'</span><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"bp\">'</span>\n</code></pre></div>",
        "id": 528111011,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752161975
    },
    {
        "content": "<p>Indeed, line breaks in the pretty-printer are not ideal, though...</p>",
        "id": 528111154,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162017
    },
    {
        "content": "<p>But I am very pleasantly surprised by the fact that <em>spaces</em> are surprisingly good!</p>",
        "id": 528111237,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162044
    },
    {
        "content": "<p>(And, besides, controllable by the user, at least if you can modify the code where the syntax is defined.)</p>",
        "id": 528111340,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162081
    },
    {
        "content": "<p>Maybe I should also make it clear that, right now, I am aiming for the following goals from the commandStart linter:</p>\n<ul>\n<li>that it is active on most of mathlib;</li>\n<li>that it virtually never suggests something undesirable;</li>\n<li>that it is pretty consistent.</li>\n</ul>\n<p>Being completely thorough is not (yet) a goal.</p>",
        "id": 528111806,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162212
    },
    {
        "content": "<p>Do you think the linter should (after that goal is reached) enforce either a newline or not a newline in <code>@[simp]</code>? For long tags, they should definitely be on a separate line, but maybe we can tell it to remove the newline when the tag <code>@[simp]</code> is at most 10 (?) characters long.</p>",
        "id": 528112092,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752162275
    },
    {
        "content": "<p>I have not really thought about line breaks, but I would like it if it inspected the length of the string and, up to 100 chars, would suggest to place the whole command on a single line.</p>",
        "id": 528112287,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162324
    },
    {
        "content": "<p>Breaking down more and more bits as the 100 chars limit is exceeded.</p>",
        "id": 528112331,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162341
    },
    {
        "content": "<p>However, with line breaks and whitespace sensitivity, there are a lot of constraints and I have not really given it much thought.</p>",
        "id": 528112413,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162369
    },
    {
        "content": "<p>For the moment, I find that allowing some (currently complete!) leeway in where the line-breaks are placed is actually a good compromise.</p>",
        "id": 528112600,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162430
    },
    {
        "content": "<p>Btw, the \"breaking down depending on the length\" is also what the <code>add_deprecation</code> script does: it tries to fit <code>@[deprecated (since := \"...\"] alias xxx := yyy</code> on as few lines as possible, with breaks allowed at the attribute, and after the <code>:=</code>.</p>",
        "id": 528112854,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752162516
    }
]