[
    {
        "content": "<p>When <code>fun_prop</code> succeeds, it is very quick, and in my experience <em>much</em> quicker than the aesop-alternatives like <code>measurability</code>/<code>continuity</code> and so on. <br>\nHowever, when looking at the trace of a failed <code>fun_prop</code> call, you can see <em>many</em> duplicated steps, so I was already worried for a while that <code>fun_prop</code> would be slow to fail.<br>\nFor example, when looking through the trace of this example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span>\n</code></pre></div>\n<p><code>fun_prop</code> is actually trying to prove that <code>f</code> is continuous thrice, once after calling <code>Continuous.add</code>, and twice after calling <code>Continuous.comp'</code> (I don't even know why that is tried twice). This looks bad, since <code>fun_prop</code> tries multiple paths at every operation.</p>\n<p>And indeed, <code>fun_prop</code> succeeds very quickly, but fails very slowly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- succeeds in 18ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- succeeds in 27ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- succeeds in 39ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- succeeds in 42ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- succeeds in 46ms</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- fails in 18ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- fails in 100ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- fails in 590ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- fails in 2720ms</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Continuous</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">fun_prop</span><span class=\"w\"> </span><span class=\"c1\">-- fails in 10600ms</span>\n</code></pre></div>\n<p>When the tracing is turned off, the times are a bit quicker, but it's still exponentially slowing down.</p>\n<p><span class=\"user-mention\" data-user-id=\"346070\">@Tomas Skrivan</span>, is there a way to (re)design <code>fun_prop</code> to improve this? Can the <code>@[fun_prop]</code> attribute check that we don't add \"duplicate\" paths?</p>\n<p>I conjectured this behavior recently in <a href=\"https://github.com/leanprover-community/mathlib4/pull/18874\">#18874</a> and this was also mentioned in <a href=\"https://github.com/leanprover-community/mathlib4/pull/19032\">#19032</a>.</p>\n<p>cc <span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span></p>",
        "id": 482441916,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1731604097
    },
    {
        "content": "<p>This is something I encountered as well and have a use case where I really want <code>fun_prop</code> to fail fast. I do not know the solution yet. I was thinking about adding a cache for failed goals to exactly prevent trying a goal multiple times.</p>",
        "id": 482443015,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731604461
    },
    {
        "content": "<p>Thanks for the examples, I will investigate them and see if something can be done to improve on them.</p>",
        "id": 482443189,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731604524
    },
    {
        "content": "<p>A cache of failed goals also sounds like a good idea.<br>\nDo you think it's also good to become more hygienic with our <code>@[fun_prop]</code> tagging? It seems that a large part of the branching factor comes from two \"equivalent\" lemmas being tagged.</p>",
        "id": 482443316,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1731604565
    },
    {
        "content": "<p>A cache of successful goals seems worthwhile too, although less important.</p>",
        "id": 482444165,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731604806
    },
    {
        "content": "<p>Successful goals should be cached already.</p>",
        "id": 482444356,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731604873
    },
    {
        "content": "<p>Also there is an option <code>maxTransitionDepth</code> which controls how many times you can switch function property e.g. inferring continuity from differentiability and that from linearity. Setting it to zero improved failure times for me in a few scenarios.</p>",
        "id": 482444791,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731605005
    },
    {
        "content": "<p>I can also try to do something about the simple vs compositional form theorems, such that adding both does not introduce too much branching. However, I am not sure how to robustly detect that a theorem is a compositional version of another theorem.</p>",
        "id": 482446393,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731605493
    },
    {
        "content": "<p>But I think the exponential blow up should go away with catching failed goals and still having \"duplicate\" theorems.</p>",
        "id": 482447761,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731605974
    },
    {
        "content": "<p>I think the only value of the simple theorems for <code>fun_prop</code> would be for outputting the proof via a <code>fun_prop?</code> with <code>Try this:</code> (to be honest, this would be nice to have even in cases when <code>fun_prop</code> fails, so that you can get a partial proof).</p>\n<p>Another nice thing to have would be<code>fun_prop? 1</code>, which gives a <code>Try this:</code> for all the immediately applicable <code>fun_prop</code>lemmas.</p>\n<p>But I'll shut up now since I'm just asking for features without (currently) offering to implement them.</p>",
        "id": 482455108,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731608425
    },
    {
        "content": "<p>The reasons for supporting the simple theorems is more of a user friendly feature. Writing the compositional form is a chore and feels really weird for functions like sin, exp etc. Also in SciLean I generate the theorems automatically and right now I do it only in the simple form.</p>",
        "id": 482455739,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731608649
    },
    {
        "content": "<p>I don't think Mathlib minds writing the compositional form. We do it most of the time anyway for our own convenience (generally because of dot notation).</p>",
        "id": 482456046,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731608779
    },
    {
        "content": "<p>If <code>fun_prop</code> becomes amazing and we don't have to prove these things manually, I'm happy to get rid of the compositional forms!</p>",
        "id": 482458044,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1731609582
    },
    {
        "content": "<p>you mean simple forms?</p>",
        "id": 482458336,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1731609675
    },
    {
        "content": "<p>I didn't. But honestly it's not important until we never have to prove simple continuity lemmas ourselves anymore.</p>",
        "id": 482462336,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1731611107
    },
    {
        "content": "<p>I added the cache for failed goals and it seems to fix the problem: <a href=\"https://github.com/leanprover-community/mathlib4/pull/19107\">#19107</a></p>",
        "id": 482691670,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731703320
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/19112\">#19112</a> I added a command <code>#print_fun_prop_theorems HDiv.hDiv</code> to print out all <code>fun_prop</code> theorem attached to for example division. This should make it easier to maintain <code>fun_prop</code> attributes.</p>\n<hr>\n<p>So far the function with the highest number of theorems I have found is <code>HPow.hPow</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">print_fun_prop_theorems</span><span class=\"w\"> </span><span class=\"n\">HPow</span><span class=\"bp\">.</span><span class=\"n\">hPow</span><span class=\"w\"> </span><span class=\"n\">Continuous</span>\n</code></pre></div>\n<p>prints</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Continuous</span>\n<span class=\"w\">  </span><span class=\"n\">Continuous</span><span class=\"bp\">.</span><span class=\"n\">pow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compositional</span>\n<span class=\"w\">  </span><span class=\"n\">Continuous</span><span class=\"bp\">.</span><span class=\"n\">zpow₀</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compositional</span>\n<span class=\"w\">  </span><span class=\"n\">Continuous</span><span class=\"bp\">.</span><span class=\"n\">zpow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compositional</span>\n<span class=\"w\">  </span><span class=\"n\">ENNReal</span><span class=\"bp\">.</span><span class=\"n\">continuous_pow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simple</span>\n<span class=\"w\">  </span><span class=\"n\">ENNReal</span><span class=\"bp\">.</span><span class=\"n\">continuous_zpow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simple</span>\n<span class=\"w\">  </span><span class=\"n\">continuous_const_cpow</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simple</span>\n<span class=\"w\">  </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">continuous_rpow_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simple</span>\n<span class=\"w\">  </span><span class=\"n\">NNReal</span><span class=\"bp\">.</span><span class=\"n\">continuous_rpow_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simple</span>\n<span class=\"w\">  </span><span class=\"n\">ENNReal</span><span class=\"bp\">.</span><span class=\"n\">continuous_rpow_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simple</span>\n<span class=\"w\">  </span><span class=\"n\">NNReal</span><span class=\"bp\">.</span><span class=\"n\">continuous_nnrpow_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">simple</span>\n</code></pre></div>\n<hr>\n<p>I have found out that <code>fun_prop</code> does not check if you mark a theorem twice :) </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">print_fun_prop_theorems</span><span class=\"w\"> </span><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"n\">Differentiable</span>\n</code></pre></div>\n<p>prints</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Differentiable</span>\n<span class=\"w\">  </span><span class=\"n\">Differentiable</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compositional</span>\n<span class=\"w\">  </span><span class=\"n\">Differentiable</span><span class=\"bp\">.</span><span class=\"n\">add_const</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compositional</span>\n<span class=\"w\">  </span><span class=\"n\">Differentiable</span><span class=\"bp\">.</span><span class=\"n\">const_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compositional</span>\n<span class=\"w\">  </span><span class=\"n\">Differentiable</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">],</span><span class=\"w\"> </span><span class=\"n\">form</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">compositional</span>\n</code></pre></div>\n<p>This comes from <code>Tactic.FunProp.Differentiable</code> which is an old file that should be removed. This would cause <code>Differentiable.add</code> to be tried twice in case of failure thus making the situation worse.</p>",
        "id": 482702945,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1731708794
    }
]