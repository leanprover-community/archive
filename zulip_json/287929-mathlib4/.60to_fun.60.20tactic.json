[
    {
        "content": "<p>I just learned about the <code>to_fun</code> tactic. The idea of this seems to be that we have decided lemmas about (e.g.) continuity of sums of functions, should be written in both \"unapplied\" and \"applied\" form, <code>f + g</code> (e.g. <code>Continuous.add</code>) vs <code>fun x â†¦ f x + g x</code> (<code>Continuous.fun_add</code>); and the tactic auto-generates the latter from the former, which clearly has the potential to save much tedium and in writing and maintaining code.</p>\n<p>Unfortunately, it doesn't seem to handle finset sums very well. In the following example I've created aliases for the existing <code>DifferentiableAt.add</code> and <code>DifferentiableAt.sum</code> and applied <code>to_fun</code> to them. For the first it works perfectly, but for the second the theorem signature is scrambled:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">Î¹</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NontriviallyNormedField</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">NormedSpace</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">Î¹</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î¹</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_fun</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">DifferentiableAt</span><span class=\"bp\">.</span><span class=\"n\">mysum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">âˆ€</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">âˆˆ</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">DifferentiableAt</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">DifferentiableAt</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">âˆ‘</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">âˆˆ</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">DifferentiableAt</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"n\">hA</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_fun</span><span class=\"kd\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">DifferentiableAt</span><span class=\"bp\">.</span><span class=\"n\">myadd</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DifferentiableAt</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hg</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DifferentiableAt</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">DifferentiableAt</span><span class=\"w\"> </span><span class=\"n\">ğ•œ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">hf</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">hg</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">DifferentiableAt</span><span class=\"bp\">.</span><span class=\"n\">fun_myadd</span><span class=\"w\"> </span><span class=\"c1\">-- the right thing</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">DifferentiableAt</span><span class=\"bp\">.</span><span class=\"n\">fun_mysum</span><span class=\"w\"> </span><span class=\"c1\">-- the wrong thing</span>\n</code></pre></div>\n<p>The output of the second <code>#check</code> is the following:</p>\n<div class=\"codehilite\" data-code-language=\"differentiableat.fun_mysum.\"><pre><span></span><code>  (aâœÂ² : NontriviallyNormedField a) (aâœÂ³ : NormedAddCommGroup aâœ) (aâœâ´ : NormedSpace a aâœ) (aâœâµ : a) (aâœâ¶ : Finset aâœÂ¹)\n  (aâœâ· : aâœÂ¹ â†’ a â†’ aâœ) :\n  (âˆ€ i âˆˆ aâœâ¶, DifferentiableAt a (aâœâ· i) aâœâµ) â†’ DifferentiableAt a (fun a =&gt; âˆ‘ c âˆˆ aâœâ¶, aâœâ· c a) aâœâµ\n</code></pre></div>\n<p>This is hard to read (for humans) since almost every variable has been unexpectedly renamed to <code>a</code>, and has somehow lost the information of which variables are implicit and which are explicit (which should match the original statement).</p>\n<p>Tagging <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> because I believe he wrote the \"to_fun\" tactic.</p>",
        "id": 563600151,
        "sender_full_name": "David Loeffler",
        "timestamp": 1765609869
    },
    {
        "content": "<p>My understanding is that</p>\n<ul>\n<li>we don't necessarily want to duplicate every lemma (and indeed, not having to do so would be an even nicer output --- which is sadly impossible). In other words, I would use <code>@[to_fun]</code> for replacing the current manually added statement, but not tag every lemma without serious thought</li>\n<li>sometimes to_fun does not work well because of missing <code>push</code> lemma tags</li>\n</ul>",
        "id": 563605862,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765617027
    },
    {
        "content": "<p>I agree that the second autogenerated lemma does not look nice: until then, I would keep the manual lemma, with a TODO to improve the lemma generation in to_fun.</p>",
        "id": 563605907,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765617077
    },
    {
        "content": "<p>I currently have no idea why the underlying simp call would change the binders in one case but not the other <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 563606032,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765617250
    },
    {
        "content": "<p>Isn't there a feature that matches up the binder name that was invented for <code>push_neg</code>? I forgot the name</p>",
        "id": 563614952,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1765627208
    },
    {
        "content": "<p>Yes, that is <code>binderNameHint</code>, and may indeed be useful here. But what doesn't make sense to me is why all of the binders got messed up, not only the ones where we did a rewrite.</p>",
        "id": 563623809,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765635283
    },
    {
        "content": "<p>Ok, I now have a fix in <a href=\"https://github.com/leanprover-community/mathlib4/pull/32866\">#32866</a></p>",
        "id": 563660636,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1765682361
    }
]