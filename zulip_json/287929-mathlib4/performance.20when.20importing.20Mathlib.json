[
    {
        "content": "<p>Consider this example, either with a minimal import, or when importing all of Mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- import Mathlib.Algebra.Polynomial.Eval.Coeff</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>The performance of this depends <strong>massively</strong> on the imports (by a factor &gt;100):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- importing Mathlib</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">simp took 6.81s</span>\n\n<span class=\"cm\">[reduction] unfolded declarations (max: 14466, num: 23): ▶</span>\n<span class=\"cm\">[reduction] unfolded instances (max: 145800, num: 31): ▶</span>\n<span class=\"cm\">[reduction] unfolded reducible declarations (max: 9000, num: 11): ▶</span>\n<span class=\"cm\">[type_class] used instances (max: 49, num: 2): ▶</span>\n<span class=\"cm\">[type_class] max synth pending failures (maxSynthPendingDepth: 1), use `set_option maxSynthPendingDepth &lt;limit&gt;` ▶</span>\n<span class=\"cm\">[def_eq] heuristic for solving `f a =?= f b` (max: 1807, num: 10): ▶</span>\n<span class=\"cm\">use `set_option diagnostics.threshold &lt;num&gt;` to control threshold for reporting counters</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"c1\">-- importing Mathlib.Algebra.Polynomial.Eval.Coeff</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">simp took 53.5ms</span>\n\n<span class=\"cm\">[reduction] unfolded declarations (max: 30, num: 3): ▶</span>\n<span class=\"cm\">[reduction] unfolded instances (max: 264, num: 15): ▶</span>\n<span class=\"cm\">[reduction] unfolded reducible declarations (max: 106, num: 2): ▶</span>\n<span class=\"cm\">[type_class] used instances (max: 49, num: 2): ▶</span>\n<span class=\"cm\">[def_eq] heuristic for solving `f a =?= f b` (max: 35, num: 1): ▶</span>\n<span class=\"cm\">use `set_option diagnostics.threshold &lt;num&gt;` to control threshold for reporting counters</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 486485285,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1733481692
    },
    {
        "content": "<p>I expect there are some simp-lemmas/instances that are problematic that we might want to get rid off. Anyone wants to try to figure out the problematic one(s)?</p>",
        "id": 486485428,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1733481731
    },
    {
        "content": "<p>(after squeezing the simp when importing all of Mathlib, it is quick: <code>34.5ms</code>)</p>",
        "id": 486485726,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1733481832
    },
    {
        "content": "<p>It's spending a lot of time solving this defeq instance:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span>\n</code></pre></div>\n<p>where the left side is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">SMulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and the right side is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">instZSMul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 486488011,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1733482624
    },
    {
        "content": "<p>The output of <code>trace.Meta.Tactic.simp</code> is almost identical except for</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">unify</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">smul_eq_mul</span><span class=\"o\">:</span><span class=\"mi\">1000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">unify</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">y</span>\n<span class=\"w\">    </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">unify</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">smul_X</span><span class=\"o\">:</span><span class=\"mi\">1000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">unify</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"w\">    </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span>\n</code></pre></div>\n<p>so either the problem is there or that's not the problem</p>",
        "id": 486491666,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733483721
    },
    {
        "content": "<p><code>trace.Meta.synthInstance</code> shows it fails to synthesize <code>MulSemiringAction ℤ ℤ</code> (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MulSemiringAction#doc\">docs#MulSemiringAction</a>) many times (although that's cached)</p>",
        "id": 486492292,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733483995
    },
    {
        "content": "<p>Squeezing and adding <code>smul_X</code> it still takes a lot of time, so that must be part of the problem</p>",
        "id": 486492755,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733484169
    },
    {
        "content": "<p>You can run <code>set_option trace.profiler true</code> to see that almost all of the time is spent in the defeq problem I reportd above.</p>",
        "id": 486492859,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1733484212
    },
    {
        "content": "<p>Floris, are your comments backwards above?</p>",
        "id": 486492888,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733484222
    },
    {
        "content": "<p>Or does importing more things really make it faster, not slower?</p>",
        "id": 486492993,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733484248
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/channel/287929-mathlib4/topic/performance.20when.20importing.20Mathlib/near/486492755\">said</a>:</p>\n<blockquote>\n<p>Squeezing and adding <code>smul_X</code> it still takes a lot of time, so that must be part of the problem</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">smul_X</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>takes approximately the same time to fail, and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">smul_X</span>\n</code></pre></div>\n<p>causes a timeout</p>",
        "id": 486493542,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733484457
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/performance.20when.20importing.20Mathlib/near/486492888\">said</a>:</p>\n<blockquote>\n<p>Floris, are your comments backwards above?</p>\n</blockquote>\n<p>They seem fine to me.</p>",
        "id": 486511593,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1733490848
    },
    {
        "content": "<p>If I understand correct there is an unresolved <code>@MulSemiringAction.toDistribMulAction ℤ ℤ (?m.11062 : Monoid ℤ) Int.instSemiring (?m.11065 : MulSemiringAction ℤ ℤ)</code> in the rhs of the defeq, and after failing to synthesize <code>MulSemiringAction ℤ ℤ</code> it attempts to fill it by unification.</p>",
        "id": 486640071,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733552443
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> <a href=\"#narrow/channel/287929-mathlib4/topic/performance.20when.20importing.20Mathlib/near/486488011\">said</a>:</p>\n<blockquote>\n<p>It's spending a lot of time solving this defeq instance:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span>\n</code></pre></div>\n<p>where the left side is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">SMulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>and the right side is:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">@</span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">instZSMul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HSMul</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I think there is also exponential blow-up due to the heuristic</p>\n<blockquote>\n<p>3- If <code>t</code> and <code>s</code> can be unfolded and they have the same head symbol, then<br>\n     a) First try to solve unification by unifying arguments.<br>\n     b) If it fails, unfold both and continue.<br>\n     Implemented by <code>unfoldBothDefEq</code></p>\n</blockquote>\n<p>in defeq checking, with e.g. <code>@SMul.smul ℤ ℤ[X] instZSMul =?= @SMul.smul ℤ ℤ[X] SMulZeroClass.toSMul</code>, as first it tries to compare the arguments (<code>instZSMul =?= SMulZeroClass.toSMul</code>), which after unfolding stuff means comparing <code>{ smul := foo } =?= { smul := bar }</code>, so it compares <code>foo =?= bar</code>, and fails.<br>\nThen it tries to first unfold <code>SMul.smul</code> and continue, so it gets <code>instZSMul.1 =?= SMulZeroClass.toSMul.1</code>, which eventually unfolds to <code>foo =?= bar</code>, and it tries to solve that again. I'm not sure why the cache doesn't trigger here, though</p>",
        "id": 486640792,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733553164
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/channel/287929-mathlib4/topic/performance.20when.20importing.20Mathlib/near/486640071\">said</a>:</p>\n<blockquote>\n<p>If I understand correct there is an unresolved <code>@MulSemiringAction.toDistribMulAction ℤ ℤ (?m.11062 : Monoid ℤ) Int.instSemiring (?m.11065 : MulSemiringAction ℤ ℤ)</code> in the rhs of the defeq, and after failing to synthesize <code>MulSemiringAction ℤ ℤ</code> it attempts to fill it by unification.</p>\n</blockquote>\n<p>Perhaps the metavariable for the <code>Monoid ℤ</code> (which I think gets assigned eventually), causes the cache to not trigger here?</p>",
        "id": 486641152,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733553501
    },
    {
        "content": "<p>The offending simp lemma is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.smul_X#doc\">docs#Polynomial.smul_X</a> (edit: as I now notice was pointed out above by Daniel, although not emphasized). As we know, this is slow:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>and the trace says</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">5.211678</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">❌️</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">▶</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">simp</span><span class=\"bp\">.</span><span class=\"n\">unify</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">smul_X</span><span class=\"o\">:</span><span class=\"mi\">1000</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">unify</span>\n<span class=\"w\">      </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span>\n<span class=\"w\">    </span><span class=\"k\">with</span>\n<span class=\"w\">      </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span>\n</code></pre></div>\n<p>I have even less understanding than others above about why we're getting that <code>❌️</code>; the typeclass problem quickly turns into <code>@instHSMul ℤ ℤ[X] SMulZeroClass.toSMul =?= @instHSMul ℤ ℤ[X] instZSMul</code> and, as has been already pointed out, the proof is <code>rfl</code>. Is it a reducibility issue? But now we see in the trace why Lean is even trying to solve this, and indeed</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">smul_X</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>is fast again.</p>",
        "id": 486715179,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1733614882
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/performance.20when.20importing.20Mathlib/near/486715179\">said</a>:</p>\n<blockquote>\n<p>as has been already pointed out, the proof is <code>rfl</code>. </p>\n</blockquote>\n<p>This wasn't my reading at all; the LHS has a metavariable that is mathematically (or at the very least, canonically) false, so the unification is impossible</p>",
        "id": 486729863,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733628803
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/channel/287929-mathlib4/topic/performance.20when.20importing.20Mathlib/near/486640792\">said</a>:</p>\n<blockquote>\n<p>I think there is also exponential blow-up due to the heuristic</p>\n<blockquote>\n<p>3- If <code>t</code> and <code>s</code> can be unfolded and they have the same head symbol, then<br>\n     a) First try to solve unification by unifying arguments.<br>\n     b) If it fails, unfold both and continue.<br>\n     Implemented by <code>unfoldBothDefEq</code></p>\n</blockquote>\n<p>in defeq checking, with e.g. <code>@SMul.smul ℤ ℤ[X] instZSMul =?= @SMul.smul ℤ ℤ[X] SMulZeroClass.toSMul</code>, as first it tries to compare the arguments (<code>instZSMul =?= SMulZeroClass.toSMul</code>), which after unfolding stuff means comparing <code>{ smul := foo } =?= { smul := bar }</code>, so it compares <code>foo =?= bar</code>, and fails.<br>\nThen it tries to first unfold <code>SMul.smul</code> and continue, so it gets <code>instZSMul.1 =?= SMulZeroClass.toSMul.1</code>, which eventually unfolds to <code>foo =?= bar</code>, and it tries to solve that again. I'm not sure why the cache doesn't trigger here, though</p>\n</blockquote>\n<p>In <a href=\"https://github.com/leanprover/lean4/pull/6335\">lean4#6335</a> I attempted to tweak the heuristic to avoid this. How can this be benchmarked with Mathlib? <del>I attempted to branch off <code>nightly-with-mathlib</code>, but I don't think it worked correctly</del></p>",
        "id": 486736832,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733635300
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span>, to get a benchmark, you would need to tweak Mathlib so it actually compiles under your change. You can do this by pushing changes to <code>lean-pr-testing-6335</code> (if it is even possible, I didn't look at all at the change in <a href=\"https://github.com/leanprover/lean4/pull/6335\">lean#6335</a>).</p>",
        "id": 486750701,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733648378
    },
    {
        "content": "<p>How do I update my local toolchain after pushing changes to the Lean PR?</p>",
        "id": 486764401,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733659572
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elan</span><span class=\"w\"> </span><span class=\"n\">toolchain</span><span class=\"w\"> </span><span class=\"n\">uninstall</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">&lt;</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">toolchain</span><span class=\"o\">)</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span>\n</code></pre></div>",
        "id": 486989760,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733749359
    }
]