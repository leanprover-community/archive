[
    {
        "content": "<p>Hey there,<br>\nI am hitting a problem with a code I have, that crashes because of a stack overflow in a function called <code>l_List_redLength___rarg</code> (which I assume is <code>List.redLength</code>. I can't find any place where my code uses <code>List.toArray</code> so I don't understand why this function is ever being called. How can I debug that ?</p>",
        "id": 456574335,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722865872
    },
    {
        "content": "<p>I think my question is somewhat related to \"How to debug lean code ?\"</p>",
        "id": 456574405,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722865897
    },
    {
        "content": "<p>Can it be because of a <code>fold</code> operation ? I am honestly confused by this</p>",
        "id": 456577037,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722866573
    },
    {
        "content": "<p>this could be used in pattern matching code, or syntax match? It's hard to tell without an MWE</p>",
        "id": 456577481,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1722866682
    },
    {
        "content": "<p>Sadly, making a MWE out of this is completely out of my league.<br>\nI can link to to project that causes the bug though.</p>",
        "id": 456577667,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722866735
    },
    {
        "content": "<p>There it is: <a href=\"https://git.sr.ht/~vigoux/busybeaver\">https://git.sr.ht/~vigoux/busybeaver</a></p>",
        "id": 456578257,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722866889
    },
    {
        "content": "<p>It seems that the binary crashes on initialization for some reason</p>",
        "id": 456578568,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722866977
    },
    {
        "content": "<p>It looks like this is because I am trying to initialize a huge thing in called <code>Init_TacticsExtra</code></p>",
        "id": 456582061,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722867647
    },
    {
        "content": "<p>Do you have a stack trace?</p>",
        "id": 456688069,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722886640
    },
    {
        "content": "<p>I'll provide one tomorrow but yeah I have one</p>",
        "id": 456705203,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722891108
    },
    {
        "content": "<p>I did a bit of debugging.<br>\nThe bug occurs _after_ doing a 'Finset.fold' for some reason.<br>\nHere is a back trace (numbers are off because I reordered them by call order):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x00005555578f52a8</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Finset_fold___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x00005555560f7a92</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">init_l_main___closed__5</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">653</span>\n<span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555791f497</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_Busybeaver</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x_1</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x_2</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x_3</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x7fffe0ca2800</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">x_4</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x7fffdab764b8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Busybeaver</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">900</span>\n<span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x00005555560f7074</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">initialize_Main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">builtin</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">'\\</span><span class=\"mi\">001</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">840</span>\n<span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x00005555560f7206</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">argc</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">argv</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x7fffffffd2f8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">861</span>\n</code></pre></div>",
        "id": 456767387,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722920468
    },
    {
        "content": "<p>The offending code is essentially a <code>Finset.fold</code> operation on a pretty big <code>Finset</code>.<br>\nIt seems that the <code>fold</code> operation goes through (after stepping through instruction by instruction).<br>\nThere is something <em>after</em> the execution of the underlying <code>Multiset.foldR</code> operation though that calls <code>toArray</code> for some reason, and this  causes the problem.</p>",
        "id": 456767578,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722920621
    },
    {
        "content": "<p>I'll try to recompile mahlib with debug information so that I can have a better stack trace.</p>",
        "id": 456767640,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722920643
    },
    {
        "content": "<p>So the problem definitely comes from <code>Finset.fold</code>, that for some reason calls <code>toArray</code> at some point.</p>",
        "id": 456770602,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722922383
    },
    {
        "content": "<p>I don't understand what that backtrace is supposed to represent. A stack overflow backtrace should be thousands of frames. You shouldn't need a debug build either, just run it under gdb until it stops</p>",
        "id": 456773568,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722923464
    },
    {
        "content": "<p>Oh, I did cut the thousands of <code>l_List_...</code> calls</p>",
        "id": 456773621,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722923510
    },
    {
        "content": "<p>There you go, I just thought this was less interesting:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07e2</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">5</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">6</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">7</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">8</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">9</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">19</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07fe</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n</code></pre></div>",
        "id": 456773860,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722923641
    },
    {
        "content": "<p>So there is no List.toArray in the stack trace?</p>",
        "id": 456774409,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1722923883
    },
    {
        "content": "<p>I'll try to search for it, I remember there was</p>",
        "id": 456774452,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722923906
    },
    {
        "content": "<p>Nope, the stack overflow occurs in a call to <code>l_List_foldrTR___rarg</code></p>",
        "id": 456774889,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722924023
    },
    {
        "content": "<p>The top of the stack when the stack overflow occurs:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b2a07e0</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_redLength___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x000055555b242c3c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l_List_foldrTR___rarg</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x00005555560f84a1</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">init_l_main___closed__14</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">796</span>\n<span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x00005555560f779c</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">initialize_Main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">builtin</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">'\\</span><span class=\"mi\">001</span><span class=\"bp\">'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">1055</span>\n<span class=\"bp\">#</span><span class=\"mi\">4</span><span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"n\">x00005555560f7956</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">argc</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">argv</span><span class=\"bp\">=</span><span class=\"mi\">0</span><span class=\"n\">x7fffffffd2f8</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">././.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">ir</span><span class=\"bp\">/</span><span class=\"n\">Main</span><span class=\"bp\">.</span><span class=\"n\">c</span><span class=\"o\">:</span><span class=\"mi\">1080</span>\n</code></pre></div>",
        "id": 456775299,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722924112
    },
    {
        "content": "<p>I suspect there is a problem in the stack trace though</p>",
        "id": 456775385,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722924125
    },
    {
        "content": "<p>I just can't wrap my head around why <code>foldrTR</code> would call <code>redLength</code> though</p>",
        "id": 456783763,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722928087
    },
    {
        "content": "<p>The issue is reproducible using the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">univ</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"o\">:=</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3000000</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"bp\">.</span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">λ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Res: {res}\"</span>\n</code></pre></div>",
        "id": 456784390,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722928362
    },
    {
        "content": "<p>The call to <code>toArray</code> is in <code>List.foldrTR</code></p>",
        "id": 456784704,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722928522
    },
    {
        "content": "<p>I think that my question amounts to \"Why foldr in Multiset.fold instead of foldl, which is already tail recursive ?\"</p>\n<p>Is it possible to move this thread to <a class=\"stream\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4\">#mathlib4</a> ?</p>",
        "id": 456787248,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722929377
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/stream/270676-lean4/topic/Stack.20overflow.20because.20of.20List.2EtoArray\">#lean4 &gt; Stack overflow because of List.toArray</a> by <span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span>.</p>",
        "id": 456788585,
        "sender_full_name": "Notification Bot",
        "timestamp": 1722929862
    },
    {
        "content": "<p>Sorry to bother, but I have an issue with <code>Multiset.fold</code> causing a stack overflow.</p>\n<p>Apparently <code>Multiset.fold</code> uses <code>List.foldr</code> which quite a bad idea because it in turns imply a <code>toArray</code> conversion. Is there a specific reason for chosing <code>List.foldr</code> instead of <code>List.foldl</code> ?</p>",
        "id": 456788903,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722929982
    },
    {
        "content": "<p>Maybe the answer is \"because these things were written with proofs in mind rather than computational efficiency\"? I don't know, that's just a conjecture. But certainly when I write code which I want to PR to mathlib I don't think at all about computational efficiency or tail recursion or anything.</p>",
        "id": 456788932,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722929996
    },
    {
        "content": "<p>That's a good reason to me <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 456789086,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722930039
    },
    {
        "content": "<p>Maybe the answer is \"if you actually have a multiset with 300,000 elements and you want to run code rather than prove theorems then you might want to think about using a more computationally efficient model for multisets\"? I have never regarded it as mathlib's job to offer computationally efficient data structures (cf the steady stream of questions we have about why polynomials aren't computable: answer -- this makes it easier to prove theorems about them).</p>",
        "id": 456789088,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722930041
    },
    {
        "content": "<p>Actually, having a quotient of list up to permutation is awesome computationally: a set is just a list on which I can make no assumption on the order, and the type system enforces that</p>",
        "id": 456789207,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722930089
    },
    {
        "content": "<p>But if I make a PR that changes from <code>foldr</code> to <code>foldl</code> (fixing the lemmas), will this be accepted (under the assumption that is fixes my problem) ?</p>",
        "id": 456789348,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722930137
    },
    {
        "content": "<p>OK then if you think it's already computationally efficient then you could try making the PR which changes it from one fold to the other :-)</p>",
        "id": 456789351,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722930139
    },
    {
        "content": "<p>I <em>seems</em> computationally efficient <em>enough to me</em> <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 456789416,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722930170
    },
    {
        "content": "<p>I would imagine that it would be a tricky job getting mathlib to compile after the change, but feel free to try! I'll defer to others about whether such a PR would be merged,  I don't know the first thing about computation.</p>",
        "id": 456789526,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1722930214
    },
    {
        "content": "<p>I am trying my change as we speak, I'll report back !</p>",
        "id": 456789612,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722930242
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib/pull/161\">!3#161</a> might be related</p>",
        "id": 456790022,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722930410
    },
    {
        "content": "<p>Probably.</p>\n<p>Note that this change seems to fix my problem.</p>",
        "id": 456791553,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722931002
    },
    {
        "content": "<p>I <em>just</em> have to fix a bunch of lemmas in <code>Finset</code> and <code>Multiset</code> and it should be good to go hopefully.</p>",
        "id": 456791673,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722931059
    },
    {
        "content": "<p>So to get better definitional equalities, but I think it's a bug if we rely on them anywhere outside the basic API lemmas anyway</p>",
        "id": 456792606,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722931399
    },
    {
        "content": "<p>I'd be surprised if making the change would be terribly hard, though</p>",
        "id": 456792790,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722931458
    },
    {
        "content": "<p>Making the change is very easy<br>\nBut it breaks in unexpected places e.g. <code>Multiset.Lattice</code></p>",
        "id": 456792920,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722931519
    },
    {
        "content": "<p>An easy way out might be to use <code>@[csimp]</code> to give <code>Multiset.fold</code> a faster runtime implementation</p>",
        "id": 456793080,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722931562
    },
    {
        "content": "<p>In my specific case, I don't need this</p>",
        "id": 456793161,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722931594
    },
    {
        "content": "<p><code>Multiset.fold</code> already boils down (I went through the assembly) <code>List.foldr</code> in a few instructions</p>",
        "id": 456793287,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722931633
    },
    {
        "content": "<p>The faster runtime version would be the one that unfolds to <code>List.foldl</code></p>",
        "id": 456793437,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722931663
    },
    {
        "content": "<p>Changing it to <code>foldl</code> will turn that into something tail-recursive</p>",
        "id": 456793444,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722931664
    },
    {
        "content": "<p>My point is that if you use <code>csimp</code> you don't have to fix anything downstream</p>",
        "id": 456793545,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722931682
    },
    {
        "content": "<p>Oh I see</p>",
        "id": 456794999,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722932204
    },
    {
        "content": "<p>This way I don't have to make a PR to mathlib <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 456795055,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722932227
    },
    {
        "content": "<p>Or better: I can make a PR to mathlib that adds the <code>csimp</code></p>",
        "id": 456795374,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722932332
    },
    {
        "content": "<p>Adding the csimp fixes the issue.</p>",
        "id": 456796403,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722932706
    },
    {
        "content": "<p>Please put the changes you already made somewhere, I probably want to land them anyway</p>",
        "id": 456796583,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722932767
    },
    {
        "content": "<p>Here is my version of it, do you want me to open a PR ?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fold_impl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Multiset</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">right_comm</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hc</span><span class=\"bp\">.</span><span class=\"n\">comm</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"bp\">.</span><span class=\"n\">assoc</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">csimp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">fold_eq_fold_impl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">fold_impl</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">funext</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">fold_eq_foldl</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"o\">}</span>\n</code></pre></div>",
        "id": 456796601,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722932774
    },
    {
        "content": "<p>I think probably a reasonable approach here is:</p>\n<ul>\n<li>Merge a PR adding that <code>csimp</code> lemma, to unblock usage like yours, with a TODO comment to...</li>\n<li>Evaluate (in terms of the effect on downstream proofs, and the effort required) whether we should just use <code>foldl</code> as the definition in the first place</li>\n</ul>",
        "id": 456797715,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722933113
    },
    {
        "content": "<p>Well, the advantage of this <code>csimp</code> is to avoid having to think about that at all actually.</p>",
        "id": 456798156,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722933292
    },
    {
        "content": "<p>But I see what you mean</p>",
        "id": 456798180,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722933298
    },
    {
        "content": "<p>Step 2 is only for if Ruben or someone else decides they want to think about it. I agree that step 1 is great because it means you can avoid worrying about it</p>",
        "id": 456800005,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722933882
    },
    {
        "content": "<p>(I get the feeling Ruben would like to see how far you got with that second step, even if you now are abandoning it)</p>",
        "id": 456800113,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1722933925
    },
    {
        "content": "<p>Yes, exactly</p>",
        "id": 456800159,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1722933939
    },
    {
        "content": "<p>I'm not abandonning it</p>\n<p>Step 1 is a great quickfix to my problem.<br>\nI'll try to make step 2 go through too</p>",
        "id": 456800291,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722933980
    },
    {
        "content": "<p>As indeed, there should not be any reason as to why this causes problems</p>",
        "id": 456800361,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1722934006
    },
    {
        "content": "<p>There you go: <a href=\"https://github.com/leanprover-community/mathlib4/pull/15617\">https://github.com/leanprover-community/mathlib4/pull/15617</a></p>\n<p>Step one</p>",
        "id": 457369262,
        "sender_full_name": "Thomas Vigouroux",
        "timestamp": 1723123201
    }
]