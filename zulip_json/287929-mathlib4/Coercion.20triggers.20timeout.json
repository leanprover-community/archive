[
    {
        "content": "<p>I'm opening a new thread since the problem seems to be fairly unrelated to <code>apply?</code>. See <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/apply.3F.20failure/near/516740598\">#mathlib4 &gt; apply? failure @ üí¨</a>  for the history.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- this works fine:</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">norm_add_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- this times out:</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">norm_add_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>In the linked thread, you can see how this comes up when using <code>exact?</code> or <code>apply?</code>, even when avoiding <code>‚Üëx</code> in the code.</p>\n<p>It appears that lean gets lost in trying to unify <code>@norm ‚ÑÇ SeminormedAddGroup.toNorm</code> (coming from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=norm_add_le#doc\">docs#norm_add_le</a>) and <code>@norm ‚ÑÇ Complex.instNorm</code>, but for some strange reason only when I use <code>‚Üëx</code> and not <code>(x : ‚ÑÇ)</code> or <code>Complex.ofReal x</code>.</p>",
        "id": 517177117,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746819557
    },
    {
        "content": "<p>A possibly more minimal version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Norm</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">a</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">b</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 34 heartbeats</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 34 heartbeats</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 41 heartbeats</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 217827 heartbeats</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n\n<span class=\"n\">seal</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">sqrt</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 114 heartbeats</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>In the second example, lean seems to introduce a metavariable for <code>(‚Üëx)</code> that stays unassigned apparently until the very end, and it keeps unfolding definitions, in particular of the norm on the complex numbers. <code>seal</code>ing <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Real.sqrt#doc\">docs#Real.sqrt</a> stops this (compare <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Complex.instNorm#doc\">docs#Complex.instNorm</a> -- the definition is <code>Real.sqrt (Complex.normSq z)</code>) and makes it almost as fast as with the explicit type ascription.</p>\n<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/24752\">#24752</a>, I'm trying to see what the fallout is when I make <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Real.sqrt#doc\">docs#Real.sqrt</a> irreducible.</p>",
        "id": 517281888,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746902129
    },
    {
        "content": "<p>There are no big changes; overall build needs about 50 fewer Giga-instructions.</p>",
        "id": 517285944,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746904796
    },
    {
        "content": "<p>But somehow my impression is that this is a work-around and not a fix.<br>\nWith</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>building the test file and looking at the output, I see several (13, to be precise) occurrences of</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>            [Meta.isDefEq] [0.00000...] ‚ùåÔ∏è Complex.ofReal x =?= ?m.526\n</code></pre></div>\n<p>and I am wondering why at this point the metavariable <code>?m.526</code> does not get assigned to <code>Complex.ofReal x</code> (if it did, the whole going down rabbit holes by unfolding would be avoided).</p>",
        "id": 517292882,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746908744
    },
    {
        "content": "<p>Note that what happens is roughly this (many intermediate lines omitted and without <code>pp.all</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>      [Meta.isDefEq] [0.001783] ‚ùåÔ∏è ‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ =?= ‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ\n            [Meta.isDefEq] [0.000002] ‚ùåÔ∏è ‚Üëx =?= ?m.526\n          [Meta.isDefEq] [0.001702] ‚ùåÔ∏è Complex.instNorm.1 ‚Üëx =?= Complex.instNorm.1 ?m.526\n            [Meta.isDefEq] [0.001668] ‚ùåÔ∏è ‚àö(Complex.normSq ‚Üëx) =?= ‚àö(Complex.normSq ?m.526)\n              [Meta.isDefEq] [0.001642] ‚ùåÔ∏è Complex.normSq ‚Üëx =?= Complex.normSq ?m.526\n                  [Meta.isDefEq] [0.000002] ‚ùåÔ∏è ‚Üëx =?= ?m.526\n                [Meta.isDefEq] [0.001546] ‚ùåÔ∏è MonoidWithZeroHom.funLike.1 Complex.normSq\n                      ‚Üëx =?= MonoidWithZeroHom.funLike.1 Complex.normSq ?m.526\n                  [Meta.isDefEq] [0.001479] ‚ùåÔ∏è (‚ÜëComplex.normSq).toFun ‚Üëx =?= (‚ÜëComplex.normSq).toFun ?m.526\n                      [Meta.isDefEq] [0.000002] ‚ùåÔ∏è ‚Üëx =?= ?m.526\n                    [Meta.isDefEq] [0.001420] ‚ùåÔ∏è (‚ÜëComplex.normSq).1 ‚Üëx =?= (‚ÜëComplex.normSq).1 ?m.526\n                      [Meta.isDefEq] [0.001352] ‚ùåÔ∏è (‚Üëx).re * (‚Üëx).re +\n                            (‚Üëx).im *\n                              (‚Üëx).im =?= Complex.re ?m.526 * Complex.re ?m.526 + Complex.im ?m.526 * Complex.im ?m.526\n                          [Meta.isDefEq] [0.000366] ‚ùåÔ∏è (‚Üëx).re * (‚Üëx).re =?= Complex.re ?m.526 * Complex.re ?m.526\n                              [Meta.isDefEq] [0.000072] ‚ùåÔ∏è (‚Üëx).re =?= Complex.re ?m.526\n                                  [Meta.isDefEq] [0.000002] ‚ùåÔ∏è ‚Üëx =?= ?m.526\n                            [Meta.isDefEq] [0.000243] ‚ùåÔ∏è instHMul.1 (‚Üëx).re\n                                  (‚Üëx).re =?= instHMul.1 (Complex.re ?m.526) (Complex.re ?m.526)\n                              [Meta.isDefEq] [0.000202] ‚ùåÔ∏è Mul.mul (‚Üëx).re\n                                    (‚Üëx).re =?= Mul.mul (Complex.re ?m.526) (Complex.re ?m.526)\n                                      [Meta.isDefEq] [0.000001] ‚ùåÔ∏è ‚Üëx =?= ?m.526\n                                [Meta.isDefEq] [0.000121] ‚ùåÔ∏è Real.instMul.1 (‚Üëx).re\n                                      (‚Üëx).re =?= Real.instMul.1 (Complex.re ?m.526) (Complex.re ?m.526)\n                                  [Meta.isDefEq] [0.000092] ‚ùåÔ∏è Real.mul‚úù (‚Üëx).re\n                                        (‚Üëx).re =?= Real.mul‚úù (Complex.re ?m.526) (Complex.re ?m.526)\n                                    [Meta.isDefEq] [0.000065] ‚ùåÔ∏è (‚Üëx).re =?= Complex.re ?m.526\n                                        [Meta.isDefEq] [0.000001] ‚ùåÔ∏è ‚Üëx =?= ?m.526\n                        [Meta.isDefEq] [0.000813] ‚ùåÔ∏è instHAdd.1 ((‚Üëx).re * (‚Üëx).re)\n                              ((‚Üëx).im *\n                                (‚Üëx).im) =?= instHAdd.1 (Complex.re ?m.526 * Complex.re ?m.526)\n                              (Complex.im ?m.526 * Complex.im ?m.526)\n(...)\n              [Meta.isDefEq.onFailure] [0.000002] ‚ùåÔ∏è ‚àö(Complex.normSq ‚Üëx) =?= ‚àö(Complex.normSq ?m.526)\n        [Meta.isDefEq.onFailure] [0.000002] ‚ùåÔ∏è ‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ =?= ‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ\n    [Meta.isDefEq] [0.000859] ‚ùåÔ∏è ‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ =?= ‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ\n      [Meta.isDefEq] [0.000835] ‚ùåÔ∏è ‚Äñ?m.526‚Äñ =?= ‚Äñ‚Üëx‚Äñ\n          [Meta.isDefEq] [0.000002] ‚ùåÔ∏è ?m.526 =?= ‚Üëx\n        [Meta.isDefEq] [0.000812] ‚ùåÔ∏è Complex.instNorm.1 ?m.526 =?= Complex.instNorm.1 ‚Üëx\n          [Meta.isDefEq] [0.000804] ‚ùåÔ∏è ‚àö(Complex.normSq ?m.526) =?= ‚àö(Complex.normSq ‚Üëx)\n            [Meta.isDefEq] [0.000788] ‚ùåÔ∏è Complex.normSq ?m.526 =?= Complex.normSq ‚Üëx\n                [Meta.isDefEq] [0.000001] ‚ùåÔ∏è ?m.526 =?= ‚Üëx\n              [Meta.isDefEq] [0.000764] ‚ùåÔ∏è MonoidWithZeroHom.funLike.1 Complex.normSq\n                    ?m.526 =?= MonoidWithZeroHom.funLike.1 Complex.normSq ‚Üëx\n(...)\n            [Meta.isDefEq.onFailure] [0.000002] ‚ùåÔ∏è ‚àö(Complex.normSq ?m.526) =?= ‚àö(Complex.normSq ‚Üëx)\n      [Meta.isDefEq.onFailure] [0.000002] ‚ùåÔ∏è ‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ =?= ‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ\n</code></pre></div>\n<p>(<code>seal</code>ing <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Real.sqrt#doc\">docs#Real.sqrt</a> prevents it from also unfolding square roots all the way down...)</p>",
        "id": 517293466,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746909278
    },
    {
        "content": "<p>Then it goes on a tangent starting with</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>    [Elab.coe] [0.001073] adding coercion for test ?m.526 z : ‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ =?= ‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ\n      [Meta.isDefEq] [0.000812] ‚ùåÔ∏è Eq ‚Äñ?m.526‚Äñ =?= Eq ‚Äñ‚Üëx‚Äñ\n        [Meta.isDefEq] [0.000788] ‚ùåÔ∏è ‚Äñ?m.526‚Äñ =?= ‚Äñ‚Üëx‚Äñ\n            [Meta.isDefEq] [0.000001] ‚ùåÔ∏è ?m.526 =?= ‚Üëx\n          [Meta.isDefEq] [0.000770] ‚ùåÔ∏è Complex.instNorm.1 ?m.526 =?= Complex.instNorm.1 ‚Üëx\n            [Meta.isDefEq] [0.000764] ‚ùåÔ∏è ‚àö(Complex.normSq ?m.526) =?= ‚àö(Complex.normSq ‚Üëx)\n              [Meta.isDefEq] [0.000747] ‚ùåÔ∏è Complex.normSq ?m.526 =?= Complex.normSq ‚Üëx\n                  [Meta.isDefEq] [0.000001] ‚ùåÔ∏è ?m.526 =?= ‚Üëx\n(... repeating its fruitless endeavors)\n              [Meta.isDefEq.onFailure] [0.000002] ‚ùåÔ∏è ‚àö(Complex.normSq ?m.526) =?= ‚àö(Complex.normSq ‚Üëx)\n        [Meta.isDefEq.onFailure] [0.000002] ‚ùåÔ∏è Eq ‚Äñ?m.526‚Äñ =?= Eq ‚Äñ‚Üëx‚Äñ\n      [Meta.synthInstance] [0.000207] üí•Ô∏è CoeT (‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ) ‚ãØ (‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ)\n        [Meta.synthInstance] [0.000027] new goal CoeT (‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ) ‚ãØ (‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ)\n        [Meta.synthInstance] [0.000145] üí•Ô∏è apply @instCoeT to CoeT (‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ) ‚ãØ (‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ)\n          [Meta.synthInstance.tryResolve] [0.000126] üí•Ô∏è CoeT (‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ) ‚ãØ (‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ) ‚âü CoeT ?m.601 ?m.602 ?m.601\n            [Meta.isDefEq] [0.000122] üí•Ô∏è CoeT (‚Äñ?m.526‚Äñ = ‚Äñz‚Äñ) ‚ãØ (‚Äñ‚Üëx‚Äñ = ‚Äñz‚Äñ) =?= CoeT ?m.601 ?m.602 ?m.601\n</code></pre></div>",
        "id": 517293841,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746909686
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> <span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> any ideas as to whether this is expected or possibly a bug? I have no idea how unification works in detail, but my naive expectation would be that when the question is whether I can unify a metavariable with a concrete term, then the answer should certainly be \"yes\".</p>",
        "id": 517294094,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746909959
    },
    {
        "content": "<p>Yes I am also surprised by this (in the test file above, with pp.all on):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">3.452198</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">367</span><span class=\"o\">)</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span>\n<span class=\"w\">            </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">))</span>\n<span class=\"w\">          </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>You would have thought that there was a pretty obvious answer to this...</p>",
        "id": 517297440,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746913147
    },
    {
        "content": "<p>It doesn't like the answer for some reason...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">3.452163</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span>\n<span class=\"w\">            </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">367</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">        </span><span class=\"o\">[</span><span class=\"n\">delta</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000008</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span>\n<span class=\"w\">              </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">367</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000003</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">367</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>",
        "id": 517297523,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746913223
    },
    {
        "content": "<p>Maybe it's not assignable yet?</p>",
        "id": 517299554,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1746915237
    },
    {
        "content": "<p>Yes, the metavariable is not assignable:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">5.900020</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ‚Üë</span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">367</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000006</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">367</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">      </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonassignable</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">367</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonassignable</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I'd guess is that this is by design: whenever you write the <code>‚Üëx</code>, Lean is only allowed to fill in the arrow by synthesizing the coercion instance.</p>",
        "id": 517310757,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746926369
    },
    {
        "content": "<p>And the slowness in unification is the same as in <a href=\"#narrow/channel/287929-mathlib4/topic/simp.20timeout.20at.20.60whnf.60/near/517077307\">#mathlib4 &gt; simp timeout at &#96;whnf&#96; @ üí¨</a>: exponentially slow unification in the presence of metavariables.</p>",
        "id": 517310846,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746926440
    },
    {
        "content": "<p>Since this unification slowness seems to be quite common, I made a small minimal example. It takes about 6s to fail, and this time is exponential in the number that I set to <code>15</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">.</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">test</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 517312308,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746927774
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Coercion.20triggers.20timeout/near/517310757\">said</a>:</p>\n<blockquote>\n<p>I'd guess is that this is by design: whenever you write the <code>‚Üëx</code>, Lean is only allowed to fill in the arrow by synthesizing the coercion instance.</p>\n</blockquote>\n<p>But at that point, we are already dealing with <code>Complex.ofReal x</code>, so it is clear what the coercion is?</p>",
        "id": 517340918,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746953601
    },
    {
        "content": "<p>The unification algorithm doesn't know anything about coercions. So it has to be filled in by a type class search.</p>",
        "id": 517342408,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746954905
    },
    {
        "content": "<p>What I was trying to say is that</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Meta.isDefEq] [0.00000...] ‚ùåÔ∏è Complex.ofReal x =?= ?m.526\n</code></pre></div>\n<p>does not involve a coercion (as far as I understand it): the left hand side is the application of an explicit function to an explicit variable.</p>",
        "id": 517344030,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746956346
    },
    {
        "content": "<p>Another observation is that parts of the trace are repeated several times (partly with sides switched), so it appears that very possibly something could be gained by caching the failures.</p>",
        "id": 517344148,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746956428
    },
    {
        "content": "<p>Yes, but the right hand side represents the expression ‚Üëx. Apparently this how Lean implements the ‚Üë: replace the entire expression with an unassignable metavariable. And later fill it in.</p>",
        "id": 517344318,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746956583
    },
    {
        "content": "<p>Here is a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> without using type classes.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"mi\">2000</span><span class=\"w\"> </span><span class=\"c1\">-- otherwise error in the second #check below</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 517345522,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746957648
    },
    {
        "content": "<p>The first <code>#check</code> gives this trace:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Elab.command] [0.004925] #check (foo (x : Int) y : g (x : Int) 1000 = g y 1000) ‚ñº\n  [step] [0.000174] expected type: Type, term\n      Nat ‚ñ∂\n  [step] [0.000087] expected type: Type, term\n      Int ‚ñ∂\n  [step] [0.004360] expected type: &lt;not-available&gt;, term\n      (foo (x : Int) y : g (x : Int) 1000 = g y 1000) ‚ñº\n    [] [0.003584] expected type: Sort ?u.281, term\n        g (x : Int) 1000 = g y 1000 ‚ñ∂\n    [] [0.000657] expected type: g (‚Üëx) 1000 = g y 1000, term\n        foo (x : Int) y ‚ñ∂\n    [Meta.isDefEq] [0.000056] ‚úÖÔ∏è g (‚Üëx) 1000 = g y 1000 =?= g (‚Üëx) 1000 = g y 1000 ‚ñº\n      [] [0.000002] ‚úÖÔ∏è g (‚Üëx) 1000 =?= g (‚Üëx) 1000       [] [0.000001] ‚úÖÔ∏è g y 1000 =?= g y 1000       [] [0.000001] ‚úÖÔ∏è Nat =?= Nat       [isLevelDefEq] [0.000000] ‚úÖÔ∏è 0 =?= 0\n  [Meta.check] [0.000095] ‚úÖÔ∏è foo (‚Üëx) y ‚ñ∂\n</code></pre></div>",
        "id": 517345560,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746957683
    },
    {
        "content": "<p>The second one gives</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Elab.command] [0.095349] #check (foo (‚Üëx) y : g (x : Int) 1000 = g y 1000) ‚ñº\n  [step] [0.000106] expected type: Type, term\n      Nat ‚ñ∂\n  [step] [0.000055] expected type: Type, term\n      Int ‚ñ∂\n  [step] [0.094532] expected type: &lt;not-available&gt;, term\n      (foo (‚Üëx) y : g (x : Int) 1000 = g y 1000) ‚ñº\n    [] [0.003083] expected type: Sort ?u.342, term\n        g (x : Int) 1000 = g y 1000 ‚ñ∂\n    [] [0.052486] expected type: g (‚Üëx) 1000 = g y 1000, term\n        foo (‚Üëx) y ‚ñ∂\n    [Meta.isDefEq] [0.038652] ‚úÖÔ∏è g ?m.395 1000 = g y 1000 =?= g (‚Üëx) 1000 = g y 1000 ‚ñº\n      [] [0.038588] ‚úÖÔ∏è g ?m.395 1000 =?= g (‚Üëx) 1000 ‚ñº\n        [delta] [0.000011] ‚ùåÔ∏è g ?m.395 1000 =?= g (‚Üëx) 1000 ‚ñ∂\n        [whnf] [0.000033] Non-easy whnf: (fun motive x h_1 h_2 ‚Ü¶ Nat.casesOn x (h_1 ()) fun n ‚Ü¶ h_2 n) (fun x ‚Ü¶ Nat) 1000 h_1 h_2         [whnf] [0.000011] Non-easy whnf: (fun motive x h_1 h_2 ‚Ü¶ Nat.casesOn x (h_1 ()) fun n ‚Ü¶ h_2 n) (fun x ‚Ü¶ Nat) 1000 h_1 h_2\n        [] [0.038467] ‚úÖÔ∏è g ?m.395 999 =?= g (‚Üëx) 999 ‚ñº\n          [delta] [0.000005] ‚ùåÔ∏è g ?m.395 999 =?= g (‚Üëx) 999 ‚ñ∂\n          [whnf] [0.000010] Non-easy whnf: (fun motive x h_1 h_2 ‚Ü¶ Nat.casesOn x (h_1 ()) fun n ‚Ü¶ h_2 n) (fun x ‚Ü¶ Nat) 999 h_1 h_2           [whnf] [0.000009] Non-easy whnf: (fun motive x h_1 h_2 ‚Ü¶ Nat.casesOn x (h_1 ()) fun n ‚Ü¶ h_2 n) (fun x ‚Ü¶ Nat) 999 h_1 h_2\n          [] [0.038418] ‚úÖÔ∏è g ?m.395 998 =?= g (‚Üëx) 998 ‚ñ∂\n      [] [0.000004] ‚úÖÔ∏è g y 1000 =?= g y 1000       [] [0.000000] ‚úÖÔ∏è Nat =?= Nat       [isLevelDefEq] [0.000000] ‚úÖÔ∏è 0 =?= 0\n  [step] [0.000173] expected type: Int, term\n      ‚Üëx ‚ñ∂\n  [Meta.isDefEq] [0.000000] ‚úÖÔ∏è Int =?= Int\n  [Meta.check] [0.000031] ‚úÖÔ∏è foo (‚Üëx) y ‚ñ∂\n</code></pre></div>\n<p>it unfolds the definition of <code>g</code> until the very end (when it succeeds, but only because <code>g a n</code> does not actually depend on <code>a</code> or <code>n</code>).</p>",
        "id": 517345794,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746957847
    },
    {
        "content": "<p>At the point where we try to unify (say) <code>Complex.ofReal x</code> with the metavariable representing <code>‚Üëx</code>, we know what type <code>‚Üëx</code> is supposed to have. So it should be possible to synthesize the relevant coercion instance at that point and thus fill in the arrow.</p>",
        "id": 517346347,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746958294
    },
    {
        "content": "<p>In your example, the second <code>#check</code> isn't significantly slower than the first, so I think it's not such a big deal. I think the real problem is the exponentially slow unification.</p>",
        "id": 517347744,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746959390
    },
    {
        "content": "<p>It's a toy example, and it is still 20 times slower, and increasing <code>1000</code> to  <code>10000</code> or so gives a stack overflow. But you are certainly right that exponentially slow unification is a problem.</p>",
        "id": 517347925,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746959522
    },
    {
        "content": "<p>When I change the 1000 to a 2000, the two <code>#check</code> are similarly slow</p>",
        "id": 517348066,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746959609
    },
    {
        "content": "<p>You have to change <em>all</em> <code>1000</code> to <code>2000</code>. On the web server, I then get</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Elab.command] [0.008249] #check (foo (x : Int) y : g (x : Int) 2000 = g y 2000)\n[Elab.command] [0.367612] #check (foo (‚Üëx) y : g (x : Int) 2000 = g y 2000)\n</code></pre></div>\n<p>(with <code>set_option maxRecDepth 5000</code>; otherwise the second check gives an error.)</p>",
        "id": 517348331,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746959794
    },
    {
        "content": "<p>Ah sorry, my mistake</p>",
        "id": 517348378,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746959834
    },
    {
        "content": "<p>What is the rationale for making the metavariable that stands for the coerced value unassignable?</p>",
        "id": 517349165,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746960581
    },
    {
        "content": "<p>If it were assignable, then it could be assigned anyhting; e.g. something other than a coercion. But I'm just guessing about these implementation details</p>",
        "id": 517358725,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746967804
    },
    {
        "content": "<p>In the context of my earlier Mathlib example, consider:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Norm</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">a</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">b</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 217734 heartbeats</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"c1\">-- Used 40 heartbeats</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>The difference is that in the first case, the expected type of <code>‚Üëx</code> is still a metavariable when the expression left of the colon is elaborated, whereas in the second case, it is already known to be <code>‚ÑÇ</code>, which leads to the coercion being looked for and found at this point, and then unification is basically trivial. In the first case, we still have the unassignable metavariable <code>?m.abc</code>for <code>‚Üëx</code> in the mix when the expression left of the colon is elaborated with the expected type given, which leads to the frantic, but eventually unsuccessful attempt to unify <code>‚Äñ?m.abc‚Äñ</code> with <code>‚ÄñComplex.ofReal x‚Äñ</code>. At this point the expected type of <code>?m.abc</code> is known to be <code>‚ÑÇ</code>, but this does not help.</p>\n<p>I'm wondering whether it might by possible to detect this situation (this may involve remembering that the unassignable metavariable came from a coercion) and then re-elaborate the coercion with its then known expected type before proceeding.</p>\n<p>I think I will open a thread in the lean4 channel for this (later; I have other obligations now).</p>",
        "id": 517372639,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746978650
    },
    {
        "content": "<p>If you have observed <code>apply?</code> or <code>exact?</code> timing out (or taking a very long time) unexpectedly, this may be related to what is described in this thread, and so you may want to up-vote the issue I created for this: <a href=\"https://github.com/leanprover/lean4/pull/8364\">lean4#8364</a></p>",
        "id": 518380138,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1747335973
    }
]