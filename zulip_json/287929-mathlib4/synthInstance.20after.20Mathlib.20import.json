[
    {
        "content": "<p>In the following code segment, the <code>synthInstance</code> call is successful:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"c1\">-- import Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`AddCommMagma</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Level</span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"o\">])</span>\n<span class=\"w\">           </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`ZMod</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">`Nat</span><span class=\"w\"> </span><span class=\"o\">[]))))</span>\n\n<span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span>\n<span class=\"o\">)</span>\n</code></pre></div>\n<p>However, if you uncomment <code>import Mathlib</code> the <code>synthInstance</code> call fails. Any advice?</p>",
        "id": 527313864,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751763862
    },
    {
        "content": "<p>confusion</p>",
        "id": 527314640,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751765172
    },
    {
        "content": "<p>it thinks it needs more stuff than it actually does</p>",
        "id": 527314914,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751765649
    },
    {
        "content": "<p>maybe I can figure this out after I learn how typeclass works</p>",
        "id": 527314925,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751765666
    },
    {
        "content": "<p>Maybe synthesis is willing to assign a metavariable if there is only one thing that unifies?</p>",
        "id": 527335292,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1751793776
    },
    {
        "content": "<p>But I don't think that's what's happening here</p>",
        "id": 527350492,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751812235
    },
    {
        "content": "<p>assigning metavariables doesn't do anything</p>",
        "id": 527350516,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1751812253
    },
    {
        "content": "<p><code>synthInstance</code> fails if it thinks that it could succeed when more metavariables were assigned.<br>\nIn this case, the instance <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=DirectSum.GradeZero.commRing#doc\">docs#DirectSum.GradeZero.commRing</a> which has type <code>CommRing (A 0)</code> makes it think that: if the metavariable would be assigned <code>0</code>, then this instance could be used (it thinks); so it just fails and leaves it to the caller to delay the synthesization.</p>",
        "id": 527360532,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751822587
    },
    {
        "content": "<p>What you might be looking for is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Term.mkInstMVar#doc\">docs#Lean.Elab.Term.mkInstMVar</a>; this function also takes on the responsibility of registering an instance metavariable as pending.</p>",
        "id": 527360633,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751822712
    },
    {
        "content": "<p>Would that function succeed in generating an instance or fail in this case? Because my workaround was going to be replacing all metavariables with free variables, and then replacing them back with the metavariables when synthInstance is done. I want the metavariables to be treated just like meta-level variables.</p>",
        "id": 527361276,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751823528
    },
    {
        "content": "<p>And this happens even if the metavariable is syntheticOpaque</p>",
        "id": 527361338,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751823590
    },
    {
        "content": "<p>In short, the metavariable is _not_ pending and I do _not_ want synthInstance to consider potential assignments to it.</p>",
        "id": 527362333,
        "sender_full_name": "Chase Norman",
        "timestamp": 1751824734
    },
    {
        "content": "<p>For what it's worth, you can see the same behaviour like this (which to me makes it clearer that something is weird here)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">ZMod</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"c1\">-- import Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">AddCommMagma</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ZMod</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 527372736,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1751835497
    }
]