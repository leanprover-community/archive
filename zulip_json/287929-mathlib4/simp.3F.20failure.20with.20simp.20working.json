[
    {
        "content": "<p>I have a mwe for this wierd situation.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">LocalRing</span><span class=\"bp\">.</span><span class=\"n\">MaximalIdeal</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsLocalRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsLocalRing</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">≃+*</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comap</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n</code></pre></div>\n<p>changing into simp? fails here.</p>",
        "id": 571271681,
        "sender_full_name": "Nailin Guan",
        "timestamp": 1769938352
    },
    {
        "content": "<p>If you run <code>simp?</code> again you get</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">LocalRing</span><span class=\"bp\">.</span><span class=\"n\">MaximalIdeal</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsLocalRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsLocalRing</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">≃+*</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comap</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">mem_comap</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">mem_maximalIdeal</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">map_mem_nonunits_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem_nonunits_iff</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MulEquiv</span><span class=\"bp\">.</span><span class=\"n\">isUnit_map</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Not sure what's wrong here</p>",
        "id": 571272486,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1769939208
    },
    {
        "content": "<p>This is an issue with <code>simp</code> using priorities, but <code>simp only</code> not doing that. Compare the traces:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Meta.Tactic.simp.rewrite] Ideal.mem_comap:1000:\n      x✝ ∈ Ideal.comap e (IsLocalRing.maximalIdeal R')\n    ==&gt;\n      e x✝ ∈ IsLocalRing.maximalIdeal R'\n[Meta.Tactic.simp.rewrite] IsLocalRing.mem_maximalIdeal:1000:\n      e x✝ ∈ IsLocalRing.maximalIdeal R'\n    ==&gt;\n      e x✝ ∈ nonunits R'\n[Meta.Tactic.simp.rewrite] map_mem_nonunits_iff:10000:  &lt;----\n      e x✝ ∈ nonunits R'\n    ==&gt;\n      x✝ ∈ nonunits R\n[Meta.Tactic.simp.rewrite] mem_nonunits_iff:1000:\n      x✝ ∈ nonunits R\n    ==&gt;\n      ¬IsUnit x✝\n[Meta.Tactic.simp.rewrite] IsLocalRing.mem_maximalIdeal:1000:\n      x✝ ∈ IsLocalRing.maximalIdeal R\n    ==&gt;\n      x✝ ∈ nonunits R\n[Meta.Tactic.simp.rewrite] iff_self:1000:\n      ¬IsUnit x✝ ↔ ¬IsUnit x✝\n    ==&gt;\n      True\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Meta.Tactic.simp.rewrite] Ideal.mem_comap:1000:\n      x✝ ∈ Ideal.comap e (IsLocalRing.maximalIdeal R')\n    ==&gt;\n      e x✝ ∈ IsLocalRing.maximalIdeal R'\n[Meta.Tactic.simp.rewrite] IsLocalRing.mem_maximalIdeal:1000:\n      e x✝ ∈ IsLocalRing.maximalIdeal R'\n    ==&gt;\n      e x✝ ∈ nonunits R'\n[Meta.Tactic.simp.rewrite] mem_nonunits_iff:1000:\n      e x✝ ∈ nonunits R'\n    ==&gt;\n      ¬IsUnit (e x✝)\n[Meta.Tactic.simp.rewrite] IsLocalRing.mem_maximalIdeal:1000:\n      x✝ ∈ IsLocalRing.maximalIdeal R\n    ==&gt;\n      x✝ ∈ nonunits R\n[Meta.Tactic.simp.rewrite] mem_nonunits_iff:1000:\n      x✝ ∈ nonunits R\n    ==&gt;\n      ¬IsUnit x✝\n</code></pre></div>\n<p>The higher priority of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=map_mem_nonunits_iff#doc\">docs#map_mem_nonunits_iff</a> makes <code>simp</code> use it, which then enables further simplifications. But <code>simp only</code> does not look at these priorities, so it first applies some other lemma, which leads to a different path (this also has the effect that the linter says that <code>map_mem_nonunits_iff</code> is unused in the <code>simp only</code> call).</p>\n<p>Ultimately, this indicates a lack of confluence of <code>simp</code> lemmas. One should be able to fix this by adding a <code>simp</code> lemma that makes the process confluent again. (Presumably a lemma that transfers <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IsUnit#doc\">docs#IsUnit</a> via a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingEquiv#doc\">docs#RingEquiv</a> .)</p>",
        "id": 571277132,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1769943534
    },
    {
        "content": "<p>In fact, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MulEquiv.isUnit_map#doc\">docs#MulEquiv.isUnit_map</a> <em>is</em> a <code>simp</code> lemma. The problem (I think) is that <code>simp?</code> just lists the lemmas that the original <code>simp</code> call uses, and the list then may not contain lemmas needed for the confluence. Indeed,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">LocalRing</span><span class=\"bp\">.</span><span class=\"n\">MaximalIdeal</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsLocalRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsLocalRing</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">≃+*</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"n\">R'</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">comap</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">maximalIdeal</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">mem_comap</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">IsLocalRing</span><span class=\"bp\">.</span><span class=\"n\">mem_maximalIdeal</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mem_nonunits_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">MulEquiv</span><span class=\"bp\">.</span><span class=\"n\">isUnit_map</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>works.</p>",
        "id": 571279217,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1769945486
    },
    {
        "content": "<p>Is there a reason that <code>simp only</code> doesn't use priorities?</p>",
        "id": 571322472,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1769986856
    },
    {
        "content": "<p>It sort of does use priorities, the problem just that when we add things in the argument list we don't look up the priorities from the environment simp attribute if present.</p>\n<p>It's a bit unclear to me what we want here. I like that <code>simp only</code>'s behaviour is <em>independent</em> of whatever crap people have put in the environment, and looking up the priorities would break that.</p>",
        "id": 571350022,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770010268
    },
    {
        "content": "<p>just spitballing, maybe <code>simp?</code> could call <code>simp only</code> with some <code>+priority</code> option?</p>",
        "id": 571350350,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1770010574
    },
    {
        "content": "<p>Yes, or maybe even run the <code>simp only</code> output, and if it failed retry with <code>simp +priority</code>. </p>\n<p>To be honest, sounds like a lot of work, although this is a pain point that has come up multiple times.</p>\n<p>If someone would be game to write an RFC for the two new pieces of behavior (or suggest an alternative approach), and demonstrate that people agree it's a good approach, I'd be willing to try implementing.</p>",
        "id": 571355848,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1770014392
    }
]