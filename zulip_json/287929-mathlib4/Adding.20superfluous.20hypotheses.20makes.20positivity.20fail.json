[
    {
        "content": "<p>Experimenting with positivity and finiteness support for <code>ENNReal</code>, I discovered that adding superfluous hypotheses can make positivity fail. This seems very surprising to me. Any ideas where this is coming from or how to debug this?<br>\nCC <span class=\"user-mention\" data-user-id=\"111080\">@Floris van Doorn</span> <span class=\"user-mention\" data-user-id=\"726531\">@Pan Lin</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">positivity</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ENNReal</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">fail_if_success</span><span class=\"w\"> </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">-- why does this fail?</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 568774110,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1768820435
    },
    {
        "content": "<p>(For broader context, <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOJgCmAdnAKIByFASoUujgLSNwDu0A1gM5z1R0ATAJ45CADyTh0hOAG8xcAFzkqtegF84AClQLlCwAZEcAAwBKJXDGBvAgCdcADxxAeERKAvHCwi4cAGbBiwDAkhFxceMxsnFwAhKISUjLyFpQ0dOiayloKANRwAIymtg7Obh5evv6BwaHhLEgCAv4A5ryk4jBQSHCoQpBoISFwIEgcg34BQcQhPD5IwOjRHoQAxkgArlwykFyBwABugUK+c+hcAPxxkmDScnoqqRrauhaGJuaZOfmFdo4uiu6eHDeWbzAD6wB8oK4a2Wy2mFQm1TC3i40CgIiYLHYUG4sXEVxuSSOyhSanSTzurzMFiycFyQm+xT+APK4yqUxqmMiOJilwStzgxPuZIy2k+R1yBSKv1KgOBlUm0zOcC4SCEyO8vDA1yOFEIADp0DBQTACEDNUhtegjqS0vqAGIKpH6/x7UFTE1mzXaba7A4wBl4fH8onJVRpUXiun5OBGYyyo6+mD7Q5wCLY7h866JBRC22PHSU2NvF7RiUxuMJ80g9DgyHQ2HwpMpgNplg1rgAGjYPTOfb75tRUHRtV4DWarTg7U63V6EDQwB4w1GMydHJmJzTPaEF2D2YFefDBee+mL1I+ZejUp+JX+ZWrJzrUJhcNCCPZ00HaIxe8JubDDzkoWpZxu8YqXpKjIynecrvoqoTuhAxBBFAID+PQ5qoEgewyMo8aOFGkoJiq35ttucDEPOyrNv65Q0amESUawcD0a2GZdh4azwGgKAAOQ8F0yyoHQYAsVAEAQD4+rSaOyxIThUCbNa3arOgmDEC0bLwTM4kgGwgSoP4LEQDsyZ7AGWZ/hYgC4hKKgBoBGIdmAIkERSVjBrKPhCz6Nm+rHlFhOEWA5znFoAJUTEVpSJfsORyMRAzF+XAclrOgAgkeggULryQA\">this makes finiteness less powerful also</a>.)</p>",
        "id": 568774307,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1768820488
    },
    {
        "content": "<p>This seems to be a bug in the <code>evalAdd</code> function for <code>positivity</code>. <br>\nDebugging with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">positivity</span><span class=\"bp\">.</span><span class=\"n\">failure</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>shows that in the first case it's trying to add <code>x + y</code> (nonnegative) and <code>1</code> (positive) which is positive.<br>\nIn the second case it's trying to add <code>x + y</code> (positive) and <code>1</code> (positive), and cannot figure out that this is positive.<br>\nThe function <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Meta.Positivity.evalAdd#doc\">docs#Mathlib.Meta.Positivity.evalAdd</a> tries to find <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddRightMono#doc\">docs#AddRightMono</a> in the first case and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddLeftStrictMono#doc\">docs#AddLeftStrictMono</a> in the second case. This second instance doesn't exists on <code>ENNReal</code>.</p>\n<p>Please fix this by:</p>\n<ul>\n<li>weakening the type class instance needed for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=add_pos#doc\">docs#add_pos</a> (probably to <code>AddLeftMono</code>?)</li>\n<li>weakening the instance needed in <code>evalAdd</code> to in the positive+positive case.</li>\n</ul>",
        "id": 568779083,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1768822135
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=add_pos%27#doc\">docs#add_pos'</a> seems to be the version of <code>add_pos</code> that I want here. Is there a reason that the unprimed version assumes the stronger type-class assumptions? (I guess it's only stronger if you have a partial order: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=addLeftMono_of_addLeftStrictMono#doc\">docs#addLeftMono_of_addLeftStrictMono</a>.)</p>",
        "id": 568780399,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1768822563
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/34133\">#34133</a></p>",
        "id": 568781317,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1768822908
    }
]