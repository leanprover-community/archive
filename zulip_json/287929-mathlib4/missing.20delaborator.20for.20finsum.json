[
    {
        "content": "<p>I sometimes whinge about missing delaborators but this time when I found one I thought I'd try and figure out how to add it myself. But it's completely hopeless. Here is what I think is a missing delaborator:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">delaborator</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Î±</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Î²</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">âˆ‘á¶ </span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">âˆˆ</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"c1\">-- âˆ‘á¶  (a : Î±) (_ : a âˆˆ s), f a : Î²</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">delaborator</span>\n</code></pre></div>\n<p>and I looked at how the notation <code>âˆ‘á¶ </code> was defined but it's just some call to <code>notation3</code> so I don't really know where to start. I would like it to delaborate as the input, if possible.</p>",
        "id": 507846738,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742840407
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/missing.20delaborator.20for.20finsum/near/507846738\">said</a>:</p>\n<blockquote>\n<p>I would like it to elaborate as the input, if possible.</p>\n</blockquote>\n<p>\"delaborate\", you mean</p>",
        "id": 507847642,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1742840676
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22048\">#22048</a> contains an example of doing something similar for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sum#doc\">docs#Finset.sum</a>. Do you want to try adapting it?</p>",
        "id": 507847816,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1742840730
    },
    {
        "content": "<p>Let's not go down a path of custom delaborators for every notation. I consider <code>Finset.sum</code> to be a special case since it's not able to use the more general system due to <code>Finset</code> complexities.</p>\n<p><code>notation3</code> ought to help us out here, but the fundamental problem is that we don't have a mechanism to re-compress the binders. There are some ad hoc ones in Mathlib/Util/Delaborators.lean, but it would be nice to work out a general system to delaborate extended binders.</p>",
        "id": 508059543,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742917247
    },
    {
        "content": "<p>I am interpreting this as \"don't make the PR doing this\", which I'm happy to do, but I would like to extend the API for finsum in general (e.g. <a href=\"https://github.com/leanprover-community/mathlib4/pull/23284\">#23284</a>) because I prefer it to Finset.sum so perhaps I'll just have it locally if I can figure it out.</p>",
        "id": 508063702,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742918260
    },
    {
        "content": "<p>Yes, don't make a PR making a custom delaborator.</p>\n<p>However, if you copy the idea of the ad hoc delaborators in Mathlib/Util/Delaborators.lean (which run the main delaborator and then adjust the binders), create (or find) a mathlib issue that tracks the fact that <code>notation3</code> can't join binders, and then label the binder-joining delaborator with this, I think that would be an acceptable PR-able short-term solution.</p>",
        "id": 508065056,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742918555
    },
    {
        "content": "<p>I looked at Yael's PR and at the file you suggested, and unfortunately I found them both completely incomprehensible with my current state of knowledge about these things, so I'm afraid that what will actually happen is that I'll do nothing :-(</p>",
        "id": 508065543,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742918668
    },
    {
        "content": "<p>Could you make sure there's a mathlib issue at least and paste the issue number here? I'd like this all to Just Work one day.</p>",
        "id": 508072378,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742920225
    },
    {
        "content": "<p>I'm afraid I know so little that I don't even understand whether <a href=\"https://github.com/leanprover-community/mathlib4/pull/13496\">#13496</a> is the relevant issue or whether we're talking about something else here.</p>",
        "id": 508073300,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742920438
    },
    {
        "content": "<p>I can tell you that one's different. It's saying that <code>Î â‚€ i j, Î´ i j</code> doesn't parse.</p>",
        "id": 508073603,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742920502
    },
    {
        "content": "<p>I think there are no pre-existing issues about this</p>",
        "id": 508074203,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742920637
    },
    {
        "content": "<p>It seems we're repeating ourselves a little: <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/finsum.20delaborator/near/496595944\">#mathlib4 &gt; finsum delaborator @ ðŸ’¬</a> <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>\n<p>The general point is, whenever you run into problems with <code>notation3</code> notations, please report them. I'd like it to be able to handle the majority of our notational needs. In the ideal world, we never have to write delaborators ourselves â€” whenever we write low-level code like delaborators, it is Lean failing to provide us necessary functionality.</p>\n<p>A neat thing with this particular issue in the current thread is that it we'll be going beyond what Lean 3 ever had. We already do this for a handful of notations, but it's definitely possible to do it for <code>notation3</code> notations too.</p>",
        "id": 508076021,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742921061
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/287929-mathlib4/topic/missing.20delaborator.20for.20finsum/near/508076021\">said</a>:</p>\n<blockquote>\n<p>It seems we're repeating ourselves a little: <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/finsum.20delaborator/near/496595944\">#mathlib4 &gt; finsum delaborator @ ðŸ’¬</a> <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>\n</blockquote>\n<p><span aria-label=\"older man\" class=\"emoji emoji-1f474\" role=\"img\" title=\"older man\">:older_man:</span></p>",
        "id": 508076376,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1742921159
    },
    {
        "content": "<p>I didn't know that this was the same issue: in my example in this thread, Lean does print a finsum symbol; in the other thread it printed the word <code>finsum</code>. So in fact it's not that I forgot that thread, it's that my understanding of what's going on is so poor that I didn't understand that the two problems had the same root cause (assuming that this is what Kyle is saying).</p>",
        "id": 508076630,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742921214
    },
    {
        "content": "<p>Oh no, I don't mean to say that. I just mean the core issue to both is \"notation3 should be able to handle this, but it doesn't have that feature yet\"</p>",
        "id": 508076774,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742921256
    },
    {
        "content": "<p>and the answer isn't \"let's write a custom delaborator\", but \"let's improve notation3\"</p>",
        "id": 508076820,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742921269
    },
    {
        "content": "<p>My effort to write the issue is <a href=\"https://github.com/leanprover-community/mathlib4/pull/23311\">#23311</a> but I do not understand some of the words I've written there (I just copied phrases from this thread) so please feel free to edit.</p>",
        "id": 508077251,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1742921376
    },
    {
        "content": "<p>Sorry to make it seem like it was the same issue, rather than a class of issues. I don't expect people to be able to know whether notation3 should be able to support something, but it's reasonable assuming problems with <code>notation3</code> notation are problems with <code>notation3</code>. I'd like to avoid a future where mathlib is full of custom delaborators that all do slightly different things, and also a future where people spend too much time learning how to write/maintain delaborators. It's really neat that we have the ability to customize pretty printing to this degree, but for mathlib purposes, these should be a last resort.</p>\n<p>Sometimes there are notations that really are one-off and can't be generalized, and need a custom delaborator. However, finsum is like any other \"big operator\" that can expand through nesting, and <code>notation3</code> aims to support all big operators.</p>",
        "id": 508078170,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1742921595
    }
]