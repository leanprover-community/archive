[
    {
        "content": "<p>Should we banish all <code>example</code>s to <code>/test</code>?</p>",
        "id": 450143437,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720525210
    },
    {
        "content": "<p>I am seeing too many of that are really tests. I am sure there are other uses though...</p>",
        "id": 450143739,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720525291
    },
    {
        "content": "<p>Can you say more why you would like to do this? I have certainly seen examples in documentation which are really useful (not sure about ones in code).</p>",
        "id": 450164840,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1720529863
    },
    {
        "content": "<p>I think it's sometimes quite useful to add these tests immediately after the thing they are testing, especially in the context of instance diamonds etc</p>",
        "id": 450165111,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720529961
    },
    {
        "content": "<p>There are some problems with this particular use case:</p>\n<ol>\n<li>We explicitly have <code>test/instance_diamond.lean</code> for this </li>\n<li>Too often, we blow up the context in a lower level file just for the <code>example</code> </li>\n<li>If we leave some arguments as <code>_</code> that still need synthesis, then changes downstream can break the test. I would argue this is more what we care about.</li>\n</ol>",
        "id": 450176054,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720532378
    },
    {
        "content": "<ol start=\"4\">\n<li>These get written inconsistently. Most are <code>rfl</code> tests and should be <code>with_reducible_and_instances rfl</code>. Scattering them across files makes it harder to catch.</li>\n</ol>",
        "id": 450176376,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720532470
    },
    {
        "content": "<ol start=\"5\">\n<li>If I want to know which are broken right now, how can I collect the spiritually broken ones?</li>\n</ol>",
        "id": 450176616,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720532529
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/ban.20.60example.60/near/450176054\">said</a>:</p>\n<blockquote>\n<ol>\n<li>We explicitly have <code>test/instance_diamond.lean</code> for this</li>\n</ol>\n</blockquote>\n<p>This is a bad solution, because it means you have to build every file that could possibly contain an instance diamond before being able to run any of the tests. Probably it would make more sense to split this file into one file per import.</p>",
        "id": 450179759,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1720533391
    },
    {
        "content": "<p>There is also folder with that name :)</p>",
        "id": 450180999,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720533651
    },
    {
        "content": "<p>I think no one has finished that</p>",
        "id": 450181164,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720533678
    },
    {
        "content": "<p>I am strongly against banning <code>example</code> from mathlib proper. It's really useful to show how API should be used</p>",
        "id": 450184338,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720534401
    },
    {
        "content": "<blockquote>\n<p>Too often, we blow up the context in a lower level file just for the <code>example</code></p>\n</blockquote>\n<p>What does this mean?</p>",
        "id": 450190763,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1720536355
    },
    {
        "content": "<p>I suppose it means adding <code>import</code>s to make the example work</p>",
        "id": 450193372,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720537120
    },
    {
        "content": "<p>That should definitely be banned. :-)</p>",
        "id": 450196320,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1720537872
    },
    {
        "content": "<p>At least shake should alert on that, right?</p>",
        "id": 450197799,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720538245
    },
    {
        "content": "<p>From my <a href=\"https://github.com/leanprover-community/mathlib4/pull/14176\">#14176</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">SubmodulesRingBasis</span><span class=\"bp\">.</span><span class=\"n\">topology</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">submodulesRingBasis</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- the point of the above: this now works</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>\n<p>This used to be a commented-out <code>-- #synth TopologicalRing (FiniteAdeleRing R K)  -- the point of the above</code> but a reviewer suggested I change it to <code>example</code> to avoid any regressions. What would you rather I do here? The point is to explain what all the code above just did, for those not familiar with <code>SubmodulesRingBasis</code> (the <code>CommRing</code> instance has been there for a long time, the art was to add a <code>TopologicalSpace</code> instance which made <code>TopologicalRing</code> not a huge chore to prove).</p>",
        "id": 450200102,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720538702
    },
    {
        "content": "<p>I think it makes sense for this to be an <code>example</code></p>",
        "id": 450202077,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720539018
    },
    {
        "content": "<p>I only mention it because I'm pretty sure it's the first time I've ever PRed an <code>example</code> and I would have been hard pressed to justify examples in mathlib before I ran into this.</p>",
        "id": 450203440,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720539261
    },
    {
        "content": "<p>I think that there are good reasons to have <code>example</code>s in Mathlib, but also that this should be sporadic.  If \"sporadic\" is measured by the fact that you are supposed to add <code>set_option linter.noExamples false in</code> before the <code>example</code>, maybe with a mandatory comment, that seems like a reasonable compromise.</p>",
        "id": 450210555,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720540758
    },
    {
        "content": "<p>The linter could even just be triggered on doc-string-less <code>example</code>s. (Like the non-existing one for <code>theorem</code>s.)</p>",
        "id": 450211119,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720540849
    },
    {
        "content": "<p>I just don't see the point of banning <code>example</code>, full stop</p>",
        "id": 450218813,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720542406
    },
    {
        "content": "<p>I'm in favor of <code>example</code>, modulo not blowing up imports.</p>",
        "id": 450220439,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1720542722
    },
    {
        "content": "<p>I still haven’t seen a good use of example. If it’s to prevent regression, then it’s a test. </p>\n<p>If it’s to demonstrate API use, then it belongs in a doc string where it is discoverable.</p>",
        "id": 450230329,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720544739
    },
    {
        "content": "<p>Counterpoints:</p>\n<ol>\n<li>I want to know about my regression when I implement it, not after I build Mathlib and run a test.</li>\n<li>We don't have Verso in docstrings yet, so they're not interactive the way code is.</li>\n</ol>",
        "id": 450233226,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1720545371
    },
    {
        "content": "<ol start=\"6\">\n<li>I end up fighting <code>shake</code> because examples don't affect the environment (much). Cf 2</li>\n</ol>",
        "id": 450239703,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720547058
    },
    {
        "content": "<p>Matt, you may \"like\" the following: in <code>Mathlib/Topology/Sheaves/Forget.lean</code> <code>import Mathlib.Algebra.Category.Ring.Limits</code> could be lowered to <code>import Mathlib.Algebra.Category.Ring.Basic</code>, if it were not for the <code>example</code> that concludes the file.</p>",
        "id": 450240849,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720547359
    },
    {
        "content": "<p>I asked GPT who gave a nuanced take</p>",
        "id": 450241051,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720547408
    },
    {
        "content": "<p>(Oddly enough, this was the very first file on which I decided to test the <code>min_imports</code> linter and I could not understand why it was failing on <em><code>Expr</code></em> information, while getting the <code>Syntax</code> one right...)</p>",
        "id": 450241276,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720547461
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/287929-mathlib4/topic/ban.20.60example.60/near/450240849\">said</a>:</p>\n<blockquote>\n<p>Matt, you may \"like\" the following: in <code>Mathlib/Topology/Sheaves/Forget.lean</code> <code>import Mathlib.Algebra.Category.Ring.Limits</code> could be lowered to <code>import Mathlib.Algebra.Category.Ring.Basic</code>, if it were not for the <code>example</code> that concludes the file.</p>\n</blockquote>\n<p>Is this one noshaken because of this?</p>",
        "id": 450241295,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720547469
    },
    {
        "content": "<p>I am not sure...</p>",
        "id": 450241349,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720547483
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"s2\">\"Mathlib.Topology.Sheaves.Forget\"</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"Mathlib.Algebra.Category.Ring.Limits\"</span><span class=\"o\">],</span>\n</code></pre></div>",
        "id": 450241455,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720547515
    },
    {
        "content": "<p>There you go, happy now?  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 450241631,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720547548
    },
    {
        "content": "<p>So we agree this is not allowed? <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 450241755,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720547578
    },
    {
        "content": "<p>I may have come across as absolute but I think this merits cleaning up at the least</p>",
        "id": 450241842,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720547609
    },
    {
        "content": "<p>Actually, with the <code>min_imports</code> linter, that gives you incremental import information, you can even lint for that!</p>",
        "id": 450241846,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720547611
    },
    {
        "content": "<p>(Sorry, have to go now, but I am really enjoying this conversation!  <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span> )</p>",
        "id": 450241928,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720547633
    },
    {
        "content": "<p>Reviews of <a href=\"https://github.com/leanprover-community/mathlib4/pull/14176\">#14176</a> welcome :-)</p>",
        "id": 450350900,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720591216
    },
    {
        "content": "<p>With the comment before the example, I find this helpful and like it when I find it in code.</p>",
        "id": 450352791,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720591912
    },
    {
        "content": "<p>Would requiring no import-bump and a doc-string be a good compromise for having examples in code?</p>",
        "id": 450353020,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720591985
    },
    {
        "content": "<p>I have no opinion on this, as I already said the suggestion to make it an <code>example</code> came from code review. I'd happily give the example a docstring if examples are allowed docstrings :-) I just didn't want to make it an instance because it would clutter the place up.</p>",
        "id": 450354203,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720592410
    },
    {
        "content": "<p>I'm wondering whether it would be better to make examples be <code>private</code> defs/lemmas? A side effect is that they would appear in documentation, which is both good (it helps people know what's supposed to work without reading the code) and bad (it clutters the documentation somewhat).</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The above instance makes the following work. -/</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testTopologicalRingInstance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TopologicalRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">FiniteAdeleRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">inferInstance</span>\n</code></pre></div>",
        "id": 450356298,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720593122
    },
    {
        "content": "<p>I thought private defs didn't appear in documentation?</p>",
        "id": 450356521,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720593191
    },
    {
        "content": "<p>Ah, so they don't.</p>",
        "id": 450357418,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720593492
    },
    {
        "content": "<p>At least this would help with the shake issues with <code>example</code>s though, right?</p>",
        "id": 450357665,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720593596
    },
    {
        "content": "<p>Depends on what for mean by \"help\" - it would no longer flag imports that are only used in those defs as unused, which I'm not sure is a good thing</p>",
        "id": 450373205,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720597749
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/287929-mathlib4/topic/ban.20.60example.60/near/450197799\">said</a>:</p>\n<blockquote>\n<p>At least shake should alert on that, right?</p>\n</blockquote>\n<p>Shake actually has several exceptions in noshake.json because of this practice</p>",
        "id": 450572057,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720647758
    },
    {
        "content": "<p>All of them were added as single file exceptions so you can probably find them by deleting all noshakes for files containing <code>example</code> and review the failures</p>",
        "id": 450572252,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720647854
    },
    {
        "content": "<p>When I tried to do a bulk deletion (of the whole file), shake would hang</p>",
        "id": 450572870,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720648156
    },
    {
        "content": "<p>I believe <a href=\"#narrow/stream/287929-mathlib4/topic/shake.20hangs.20with.20no.20config.20file\">all</a> <a href=\"#narrow/stream/287929-mathlib4/topic/shake.20going.20crazy\">recent</a> <a href=\"#narrow/stream/287929-mathlib4/topic/check.20for.20unused.20imports.20doesn't.20stop\">reports</a> of shake hanging are <a href=\"#narrow/stream/287929-mathlib4/topic/check.20for.20unused.20imports.20doesn't.20stop/near/449137381\">this bug</a>, for which <a href=\"https://github.com/leanprover-community/mathlib4/pull/14417\">the fix</a> has not yet landed</p>",
        "id": 450583405,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720651634
    },
    {
        "content": "<p>in the current situation shake is very likely to hang if it has to calculate the downstream consequences of any change</p>",
        "id": 450583510,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720651669
    },
    {
        "content": "<p>(I think the fix is still not completely correct, but it should at least restore the structural property needed to ensure termination)</p>",
        "id": 450584130,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720651867
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/ban.20.60example.60/near/450583405\">said</a>:</p>\n<blockquote>\n<p>I believe <a href=\"#narrow/stream/287929-mathlib4/topic/shake.20hangs.20with.20no.20config.20file\">all</a> <a href=\"#narrow/stream/287929-mathlib4/topic/shake.20going.20crazy\">recent</a> <a href=\"#narrow/stream/287929-mathlib4/topic/check.20for.20unused.20imports.20doesn't.20stop\">reports</a> of shake hanging are <a href=\"#narrow/stream/287929-mathlib4/topic/check.20for.20unused.20imports.20doesn't.20stop/near/449137381\">this bug</a>, for which <a href=\"https://github.com/leanprover-community/mathlib4/pull/14417\">the fix</a> has not yet landed</p>\n</blockquote>\n<p>It works without a <code>noshake</code> file now.</p>",
        "id": 450605433,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720662006
    },
    {
        "content": "<p><a href=\"https://gist.github.com/mattrobball/0894df9dcb0cb3e2f47036971c550e8c\">Gist</a> of the output without the noshake file</p>",
        "id": 450605877,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1720662419
    }
]