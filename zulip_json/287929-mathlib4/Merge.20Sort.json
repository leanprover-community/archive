[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover/lean4/pull/5092\">lean4#5092</a>, Lean core got its own <code>mergeSort</code>. As a result,  <span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/Insertion.20Sort/near/464335599\">mentioned</a> that:</p>\n<blockquote>\n<p>working out a clean way to get rid of Mathlib's <code>mergeSort'</code>, and allowing us to proceed with just one version, would be great.</p>\n</blockquote>\n<p>The problem is that:</p>\n<blockquote>\n<p>in Mathlib we want a <code>Prop</code> valued comparator, while in Lean we want a <code>Bool</code> valued comparator.</p>\n<p>I am open to changing the design of <code>mergeSort</code> in the Lean repository to help resolve this difficulty.</p>\n</blockquote>\n<p>And as <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> mentions:</p>\n<blockquote>\n<p>I realize [that a <code>Bool</code> valued comparator] is consistent with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.filter#doc\">docs#List.filter</a> [...], but the general pattern is at odds with mathlib</p>\n</blockquote>\n<hr>\n<p>I have no idea which solution is the right one, but to get the ball rolling I was wondering if any people involved in Mathlib have experience with resolving such a discrepancy? I can't imagine this being the first instance of Lean core wanting <code>Bool</code> where Mathlib wants <code>Prop</code>.</p>",
        "id": 466103713,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1724961824
    },
    {
        "content": "<p>I think in the past Lean core has just said \"sorry, this is changing and now you have to change too\", but the fallout has been at worst minorly irritating</p>",
        "id": 466109524,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724964158
    },
    {
        "content": "<p>We adapted to <code>List.filter</code> changing to use <code>Bool</code> during the port. Initially we tried changing <code>Multiset.filter</code> to match, but in the end decided that this did more harm than good</p>",
        "id": 466109626,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724964207
    },
    {
        "content": "<p>What's the rationale for preferring <code>Bool</code> to <code>Decidable</code> in core?</p>",
        "id": 466109804,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724964278
    },
    {
        "content": "<p>As far as I understand, it is to avoid any performance overhead from <code>Decidable</code>, and to not scare the programmers with <code>Prop</code>!</p>",
        "id": 466141678,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724982923
    },
    {
        "content": "<p>A quick <a href=\"https://github.com/search?q=repo%3Aleanprover-community%2Fmathlib4%20mergeSort&amp;type=code\">search</a> for <code>mergeSort</code> in Mathlib shows that it's only ever used to sort multisets, which is in turn only used to construct an instance of <code>Denumerable (Multiset α)</code>. So <code>mergeSort</code> seems to be of little importance from a math perspective. Accordingly, it probably makes sense to prefer the CS perspective and use <code>Bool</code>. The fix would then simply be to remove Mathlib's <code>mergeSort</code>, adjust the two files related to multisets and be done with it.</p>",
        "id": 466201824,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725007858
    },
    {
        "content": "<p>It's used to sort finsets too</p>",
        "id": 466203946,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725008380
    },
    {
        "content": "<p>I think we should leave Finset.sort and Multiset.sort as taking Prop not bool, and put up with the list mismatch as we have done elsewhere</p>",
        "id": 466204651,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725008529
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Merge.20Sort/near/466141678\">said</a>:</p>\n<blockquote>\n<p>And to not scare the programmers with <code>Prop</code>!</p>\n</blockquote>\n<p>This argument seems a little weird to me, we already do this with <code>if</code> which such programmers are far more likely to use than mergeSort!</p>",
        "id": 466206123,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725008871
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Merge.20Sort/near/466203946\">said</a>:</p>\n<blockquote>\n<p>It's used to sort finsets too</p>\n</blockquote>\n<p>By virtue of finsets being based on multisets, right?</p>",
        "id": 466225981,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725012962
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Merge.20Sort/near/466201824\">said</a>:</p>\n<blockquote>\n<p>The fix would then simply be to remove Mathlib's <code>mergeSort</code>,</p>\n</blockquote>\n<p>Just to check here: we still plan to keep every lemma in Mathlib about <code>mergeSort</code> that doesn't exist already in core, right?</p>",
        "id": 466226884,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725013154
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Good point, I guess that might make things a bit more tricky. Though the number of lemmas seems manageable.</p>",
        "id": 466229640,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725013680
    },
    {
        "content": "<p>I see <code>map_mergeSort</code>, but not much else. I think everything else has a direct replacement (although is stated slightly differently, as discussed above).</p>",
        "id": 466246685,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725017693
    },
    {
        "content": "<p>How would I go about creating a branch for Mathlib based on <a href=\"https://github.com/leanprover/lean4/pull/5092\">lean4#5092</a> such that it could later be merged when Mathlib is bumped to the next Lean release?</p>",
        "id": 466247482,
        "sender_full_name": "Marcus Rossel",
        "timestamp": 1725017944
    },
    {
        "content": "<p>Tangentially: it would be great if there were a version of the docs for Lean nightly (either with or without the mathlib nightly branches), to make it easier to discuss upcoming changes like this</p>",
        "id": 466252122,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725019314
    },
    {
        "content": "<p>Though I guess some care would need to be taken to avoid confusing users about which doc is which</p>",
        "id": 466252291,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725019360
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Merge.20Sort/near/466246685\">said</a>:</p>\n<blockquote>\n<p>I see <code>map_mergeSort</code>, but not much else. I think everything else has a direct replacement (although is stated slightly differently, as discussed above).</p>\n</blockquote>\n<p>Keeping the typeclass-enabled version of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.sorted_mergeSort#doc\">docs#List.sorted_mergeSort</a> seems pretty handy: the Lean core <a href=\"https://github.com/leanprover/lean4/pull/5092/files#diff-eef9bc53cd5521510efc038d965ef29f8a774340ab9373ea95835ed93a87d362R241\"><code>List.mergeSort_sorted</code></a> has a non <a href=\"https://leanprover-community.github.io/contribute/naming.html\">#naming</a>-compliant name, and some inconvenient assumptions to deal with</p>",
        "id": 466252608,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1725019436
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"372804\">Marcus Rossel</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Merge.20Sort/near/466247482\">said</a>:</p>\n<blockquote>\n<p>How would I go about creating a branch for Mathlib based on <a href=\"https://github.com/leanprover/lean4/pull/5092\">lean4#5092</a> such that it could later be merged when Mathlib is bumped to the next Lean release?</p>\n</blockquote>\n<p>Mathlib will probably have moved to v4.12.0-rc1 by the time you see this message. :-)</p>",
        "id": 467131673,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725344497
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Merge.20Sort/near/466252608\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Merge.20Sort/near/466246685\">said</a>:</p>\n<blockquote>\n<p>I see <code>map_mergeSort</code>, but not much else. I think everything else has a direct replacement (although is stated slightly differently, as discussed above).</p>\n</blockquote>\n<p>Keeping the typeclass-enabled version of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.sorted_mergeSort#doc\">docs#List.sorted_mergeSort</a> seems pretty handy: the Lean core <a href=\"https://github.com/leanprover/lean4/pull/5092/files#diff-eef9bc53cd5521510efc038d965ef29f8a774340ab9373ea95835ed93a87d362R241\"><code>List.mergeSort_sorted</code></a> has a non <a href=\"https://leanprover-community.github.io/contribute/naming.html\">#naming</a>-compliant name, and some inconvenient assumptions to deal with</p>\n</blockquote>\n<p>I will change the name to <code>sorted_mergeSort</code>, but I agree that Mathlib should provide a wrapper that handles the hypotheses via Mathlib-specific typeclasses.</p>",
        "id": 467131911,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725344547
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/5242\">lean#5242</a></p>",
        "id": 467133248,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725344867
    },
    {
        "content": "<p>I'm again cleaning up the <code>mergeSort'</code> / <code>mergeSort</code> duplication. I seem to have it working now and will make a PR (but which will need to wait for <code>v4.13.0</code> to hit master).</p>",
        "id": 471134577,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726621511
    },
    {
        "content": "<p>Separately, I'd like to move <code>map_mergeSort</code> up to Lean. <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> and <span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span>, is \"upstream map_mergeSort <a href=\"https://github.com/leanprover/lean4/pull/5377\">lean#5377</a>\" okay with you?</p>",
        "id": 471134621,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726621538
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16902\">#16902</a></p>",
        "id": 471138640,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726623640
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> The PR for <code>map_mergeSort</code> looks pretty clean to me after a quick walk through. No issues on my end. This basic algorithm belongs in core. (If you want a review then I can probably do so in the near future, but that doesn't seem to be what you want.)</p>",
        "id": 471138928,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1726623822
    },
    {
        "content": "<blockquote>\n<p>the old mergeSort' in Mathlib (which was not a stable sort algorithm)</p>\n</blockquote>\n<p>This surprises me; do you have an example showing non-stability?</p>",
        "id": 471179808,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1726641319
    },
    {
        "content": "<p>Try anything. :-) Jeremy's implementation would split the lists by unriffling, rather than taking a prefix and a suffix.</p>",
        "id": 471181747,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642169
    },
    {
        "content": "<p>This immediately breaks stability.</p>",
        "id": 471181759,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726642174
    }
]