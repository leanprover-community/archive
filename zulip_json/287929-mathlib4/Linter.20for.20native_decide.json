[
    {
        "content": "<p>In light of the discussion on <a href=\"https://github.com/nielsvoss/lean-pitfalls\">https://github.com/nielsvoss/lean-pitfalls</a>: should there be a mathlib linter against native_decide? Right now, CI does not enforce this.</p>",
        "id": 521076855,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1748518734
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/25297\">#25297</a> implements one</p>",
        "id": 521083177,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1748521041
    },
    {
        "content": "<p>I did not look carefully at the setting and unsetting of <code>native_decide</code>, but should the linter rather warn about introducing <code>ofReduceBool</code>?  Isn't the issue that <code>native_decide</code> opens the door to adding the unsafe <code>ofReduceBool</code> axiom, rather than the tactic itself being potentially malicious?</p>\n<p>It would be great if, when <code>native_decide</code> finds a \"good\" proof, that it suggested a proof that does not risk of becoming dependent on <code>ofReduceBool</code> with a refactor, though.</p>",
        "id": 521094442,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1748525179
    },
    {
        "content": "<p>Sure, warning about <code>ofReduceBool</code> would also be good/ could help to make the error message more specific. That said, unless <code>native_decide</code> suggests a \"good\" proof automatically, having proofs that could silently start to depend on <code>ofReduceBool</code> does not sound good either.</p>",
        "id": 521123176,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1748534224
    },
    {
        "content": "<p>In other words: once <code>native_decide</code> becomes self-replacing, linting against it is fine because you can either replace by a good proof, or you proof depends on <code>ofReduceBool</code> already.</p>",
        "id": 521123413,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1748534297
    },
    {
        "content": "<p>Is the real request here to just do an axiom check?</p>",
        "id": 521124620,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748534670
    },
    {
        "content": "<p>Is there any proposal to make <code>native_decide</code> not always use <code>ofReduceBool</code> like it currently does?</p>",
        "id": 521125277,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748534864
    },
    {
        "content": "<p>Oh, my comment may have been based on a false premise: does <code>native_decide</code> <em>always</em> imply a dependency on <code>ofReduceBool</code>?</p>",
        "id": 521125538,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1748534934
    },
    {
        "content": "<p>I naively thought that it <em>might</em> introduce one, not that it was guaranteed to.</p>",
        "id": 521125607,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1748534955
    },
    {
        "content": "<p>Yes, it always uses <code>ofReduceBool</code>.</p>",
        "id": 521125610,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748534956
    },
    {
        "content": "<p>Ah, ok, so the linter is good!</p>",
        "id": 521125664,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1748534977
    },
    {
        "content": "<p>Although I think that also having an axiom check might be good.</p>",
        "id": 521125817,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1748535013
    },
    {
        "content": "<p>I'd say this justifies having only the axiom check :-)</p>",
        "id": 521125931,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748535047
    },
    {
        "content": "<p>If the axiom is found, could the linter look through the infotrees to implicate a tactic or term that introduced it? That's expensive, but it's only done in the rare case the axiom is present.</p>",
        "id": 521126087,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748535097
    },
    {
        "content": "<p>Yes, that might be a nice feature!</p>",
        "id": 521126244,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1748535135
    },
    {
        "content": "<p>I take this slightly back: having a <code>native_decide</code> linter for mathlib is a good idea, since it can quickly activate and explain why it's not allowed</p>",
        "id": 521126276,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748535147
    },
    {
        "content": "<p>Note that you'd need to check for <code>decide +native</code> and <code>decide (config := { native := true })</code> etc. etc. (Not sure how to reliably do that!)</p>",
        "id": 521126424,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748535206
    },
    {
        "content": "<p>Maybe <code>decide</code> along with any \"<code>native</code>\" in the <code>Syntax</code>? That should only give false positives for <code>decide -native</code>, etc., but better safe than sorry.</p>",
        "id": 521126676,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748535290
    },
    {
        "content": "<p>I think it's much cheaper to do an axiom check globally</p>",
        "id": 521127606,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748535629
    },
    {
        "content": "<p>Otherwise we're recursing through the same constants every time we transitively check for axioms, instead of memoizing them across all of mathlib</p>",
        "id": 521127673,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748535655
    },
    {
        "content": "<p>(So I'm suggesting an environment linter)</p>",
        "id": 521127702,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1748535665
    },
    {
        "content": "<p>For reference, how <code>native_decide</code> works:</p>\n<ol>\n<li>It adds an auxiliary definition <code>def auxdef : Bool := decide p</code></li>\n<li>It adds an auxiliary lemma <code>lemma aux : p := of_decide_eq_true (Lean.ofReduceBool auxdef true rfl)</code>.</li>\n<li>If the kernel accepts the lemma, then <code>aux</code> is used as the proof of <code>p</code>.</li>\n</ol>\n<p>Step 2 is what triggers evaluating <code>auxdef</code> using the \"<code>#eval</code> interpreter.\"</p>\n<p>There's not really any room for it come up with a proof that doesn't use ofReduceBool. If you accept ofReduceBool, you're happy with the proof, so there's no reason for it to then spend time having the kernel try reducing <code>auxDef</code> to <code>true</code> directly.</p>",
        "id": 521127747,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748535682
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Linter.20for.20native_decide/near/521127673\">said</a>:</p>\n<blockquote>\n<p>Otherwise we're recursing through the same constants every time we transitively check for axioms, instead of memoizing them across all of mathlib</p>\n</blockquote>\n<p>It might only look at new constants, if that's somehow possible to detect.</p>\n<p>Or there could be an environment extension for \"this constant has been checked\"</p>",
        "id": 521127947,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1748535758
    },
    {
        "content": "<blockquote>\n<p>Otherwise we're recursing through the same constants every time we transitively check for axioms, instead of memoizing them across all of mathlib</p>\n</blockquote>\n<p>Is there a reason to prefer a linter if this is the case? Isn't whether (and how) to do an axiom checker somewhat related to Mathlib's CI running an external type checker (or checkers)? There was discussion of the latter in another thread I believe but Mathlib doesn't yet do so. E.g. running nanoda would allow both independently checking Mathlib's declarations with a second checker as well as ensuring no additional axioms are used?</p>",
        "id": 521133516,
        "sender_full_name": "Julian Berman",
        "timestamp": 1748537809
    }
]