[
    {
        "content": "<p>Hey everyone, quick question. So I’ve noticed that you now need to provide a <code>Repr</code> instance for the  custom type in order for the result to display, even when forcing an eval. Previously, having a <code>toString</code> definition was enough, but now Lean complains about missing 'Lean.MetaEval' (which is implemented via Repr.<br>\nWas this change introduced recently? Is there a way to make eval use 'toString' automatically, or do we always need to provide a Repr typeclass for custom types now?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">BisectionResult</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">BisectionResult</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">String</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Root found: {root} (after {iter} iterations)\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">invalidBounds</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Invalid bounds: {reason}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">maxIterationsReached</span><span class=\"w\"> </span><span class=\"n\">approx</span><span class=\"w\"> </span><span class=\"n\">iter</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Max iterations reached: best approximation {approx} (after {iter} iterations)\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">numericalError</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Numerical error: {reason}\"</span>\n\n<span class=\"c1\">-- note for zulip : recent lean; now requires repr typeclass to display eval results</span>\n<span class=\"c1\">-- for custom types</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"w\"> </span><span class=\"n\">BisectionResult</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">reprPrec</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">BisectionResult</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">r</span>\n\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ToString</span><span class=\"w\"> </span><span class=\"n\">BisectionResult</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">BisectionResult</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n\n<span class=\"c1\">-- Example usage and tests</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testFunction1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mf\">2.0</span><span class=\"w\">  </span><span class=\"c1\">-- Root at √2 ≈ 1.414</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testFunction2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\">  </span><span class=\"c1\">-- Root ≈ 1.324</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">testFunction3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">sin</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\">  </span><span class=\"c1\">-- Root at π ≈ 3.14159</span>\n\n<span class=\"c1\">-- Test cases</span>\n<span class=\"bp\">#</span><span class=\"n\">eval!</span><span class=\"w\"> </span><span class=\"n\">findRoot</span><span class=\"w\"> </span><span class=\"n\">testFunction1</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"mf\">2.0</span><span class=\"w\">  </span><span class=\"c1\">-- Should find √2</span>\n<span class=\"bp\">#</span><span class=\"n\">eval!</span><span class=\"w\"> </span><span class=\"n\">findRoot</span><span class=\"w\"> </span><span class=\"n\">testFunction2</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"mf\">2.0</span><span class=\"w\">  </span><span class=\"c1\">-- Should find real root of x³ - x - 1 = 0</span>\n<span class=\"bp\">#</span><span class=\"n\">eval!</span><span class=\"w\"> </span><span class=\"n\">findRoot</span><span class=\"w\"> </span><span class=\"n\">testFunction3</span><span class=\"w\"> </span><span class=\"mf\">3.0</span><span class=\"w\"> </span><span class=\"mf\">4.0</span><span class=\"w\">  </span><span class=\"c1\">-- Should find π</span>\n</code></pre></div>",
        "id": 537373318,
        "sender_full_name": "Oscar Matemb ⚛️",
        "timestamp": 1756852163
    },
    {
        "content": "<p>you can always <code>#eval toString foobar</code> instead of <code>#eval foobar</code></p>",
        "id": 537374502,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1756852959
    },
    {
        "content": "<p>It's supposed to use <code>toString</code> instances, though <code>Repr</code> is preferred. Even more preferred is <code>ToExpr</code>. I'd like to help, but without an <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> I can't check.</p>",
        "id": 537375611,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1756853837
    },
    {
        "content": "<p>I can't send one anymore, I have resolved the issue with termination. The question was mainly directed at understanding the timeline of when was this introduced</p>",
        "id": 538122332,
        "sender_full_name": "Oscar Matemb ⚛️",
        "timestamp": 1757299612
    },
    {
        "content": "<p>There were changes to <code>#eval</code> 11 months ago: <a href=\"https://github.com/leanprover-community/mathlib4/pull/5627\">#5627</a></p>\n<p>What version of Lean are you using, and what version was \"previously\"? <code>Lean.MetaEval</code> has not existed since <a href=\"https://github.com/leanprover-community/mathlib4/pull/5327\">#5327</a>, and the current version is able to use <code>ToExpr</code>, <code>Repr</code>, and <code>ToString</code> instances, depending on what's available, and it also tries deriving a <code>ToExpr</code> instance if there's no such instance.</p>\n<p>Also, to my recollection, there never was such a change as the one you're describing, or at least <code>#eval</code> has been using <code>Repr</code> and <code>ToString</code> instances for over four years. I am guessing there were some subtle errors in your code preventing <code>Lean.MetaEval</code> from synthesizing; that's why a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> is essential.</p>",
        "id": 538179300,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1757324997
    }
]