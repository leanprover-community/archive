[
    {
        "content": "<p>Should the submonoid of elements smaller than one be added to mathlib? There is already <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Order/Monoid/Submonoid.html#Submonoid.oneLE\">Submonoid.oneLE</a>, which is the submonoid of elements greater than one.</p>\n<p>Here is a straight-forward adaption:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The submonoid of elements that are at most `1`. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">simps</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"The submonoid of nonpositive elements.\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">le_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submonoid</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Iic</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">mul_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mul_le_one'</span>\n<span class=\"w\">  </span><span class=\"n\">one_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">le_rfl</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">mem_le_one</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">le_one</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 501084573,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740137987
    },
    {
        "content": "<p>It should be called <code>leOne</code>, but this otherwise seems reasonable</p>",
        "id": 501084725,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740138035
    },
    {
        "content": "<p>In that case, <code>to_additive</code> generates the name <code>leZero</code> instead of <code>nonpos</code> (the corresponding <code>oneLE</code> generates <code>nonneg</code>). I could force <code>to_additive</code> to generate <code>nonpos</code>, making it consistent with the existing code, like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The submonoid of elements that are at most `1`. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">simps</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">nonpos</span><span class=\"w\"> </span><span class=\"s2\">\"The submonoid of nonpositive elements.\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">leOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Submonoid</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">carrier</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Iic</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">mul_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mul_le_one'</span>\n<span class=\"w\">  </span><span class=\"n\">one_mem'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">le_rfl</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"o\">}</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">mem_nonpos</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">mem_leOne</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">leOne</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>Does this look good?</p>",
        "id": 501086978,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740138762
    },
    {
        "content": "<p>Yes, that looks good to me</p>",
        "id": 501090522,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740139892
    },
    {
        "content": "<p>You can also teach <code>to_additive</code> to automatically suggest the correct name by modifying <a href=\"https://github.com/leanprover-community/mathlib4/blob/dc7342d7eb421552f1fbd5de4e403a7054ad8759/Mathlib/Tactic/ToAdditive/Frontend.lean#L1016\">this</a> definition and adding a line</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"le\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"s2\">\"Zero\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">        </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"nonpos\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">fixAbbreviation</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>",
        "id": 501093970,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740141028
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Submonoid.20of.20elements.20smaller.20than.20one/near/501093970\">said</a>:</p>\n<blockquote>\n<p>You can also teach <code>to_additive</code> to automatically suggest the correct name...</p>\n</blockquote>\n<p>Yeah, I was thinking that this could be done. That is probably the best approach. Thanks for providing the appropriate rule.</p>",
        "id": 501094750,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740141295
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Submonoid.20of.20elements.20smaller.20than.20one/near/501093970\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"le\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"s2\">\"Zero\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">        </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"nonpos\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">fixAbbreviation</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Unfortunately, this causes a collision with the following rule:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"le\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"s2\">\"Zero\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"s2\">\"Part\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">         </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"negPart\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">fixAbbreviation</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>\n<p>Perhaps I should just hardcode <code>nonpos</code> after all.</p>",
        "id": 501102080,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740143638
    },
    {
        "content": "<p>That won't be a collision as long as you put your case after that one</p>",
        "id": 501102621,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740143796
    },
    {
        "content": "<p>BTW, shouldn't <code>leZeroPart</code> become <code>nonposPart</code>, and so on anyway, for consistency? I guess there is a tradeoff between consistency and simplicity here.</p>",
        "id": 501102972,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740143910
    },
    {
        "content": "<p>I don't think we want to change the name of something we use frequently to slightly simplify an internal function nobody looks at.</p>",
        "id": 501104586,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1740144382
    },
    {
        "content": "<p>Makes sense!</p>",
        "id": 501104766,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740144443
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Submonoid.20of.20elements.20smaller.20than.20one/near/501093970\">said</a>:</p>\n<blockquote>\n<p>You can also teach <code>to_additive</code> to automatically suggest the correct name by modifying <a href=\"https://github.com/leanprover-community/mathlib4/blob/dc7342d7eb421552f1fbd5de4e403a7054ad8759/Mathlib/Tactic/ToAdditive/Frontend.lean#L1016\">this</a> definition and adding a line</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"s2\">\"le\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"s2\">\"Zero\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\">        </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"s2\">\"nonpos\"</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"n\">fixAbbreviation</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>If we do changes like this one, should we verify if any of <code>@[to_additive]</code>-generated names changed and add deprecated aliases?</p>",
        "id": 501110148,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1740145991
    },
    {
        "content": "<p>I implemented the code here: <a href=\"https://github.com/leanprover-community/mathlib4/tree/adompeldorius/leOne\">https://github.com/leanprover-community/mathlib4/tree/adompeldorius/leOne</a></p>\n<p>The checks passed, but I guess it is still possible that some <code>@[to_additive]</code>-generated names have changed, if the generated code is not used by any other code in mathlib. Is it possible to get a diff of generated code after a commit?</p>",
        "id": 501115894,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740147690
    },
    {
        "content": "<p>I have a local branch with mostly forward-ported <code>leaff</code> locally. I'll try to fix the remaining issues and run it on your branch tomorrow.</p>",
        "id": 501116371,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1740147839
    },
    {
        "content": "<p>Please remind me if I don't report back in 48h.</p>",
        "id": 501116471,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1740147862
    },
    {
        "content": "<p>Thank you so much!</p>",
        "id": 501116612,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740147914
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> Hi, did you have a chance to check the diff? I could also try doing it myself. I guess my change is small enough that it would be also possible to just generate the olean files and do a regular diff.</p>",
        "id": 501527908,
        "sender_full_name": "Albus Dompeldorius",
        "timestamp": 1740399623
    }
]