[
    {
        "content": "<p>One part of adding linters is slower build times.  In a PR that is already delegated, I am trying to mitigate this, by getting linters to only run on files that are git-modified.</p>\n<p>This works well with Linux computers (at least, it works well on mine!) and I checked that it does not seem to break the online server (and assumes that <em>every</em> file is modified).</p>\n<p>Could someone using Windows or MacOs try out the command below?</p>\n<p>Thanks!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isGitModified</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">modName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- On the `whitespace` test file we always return `true`, since we want the linter to inspect</span>\n<span class=\"w\">  </span><span class=\"c1\">-- the file.</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">modName</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"ss\">`MathlibTest.Whitespace</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">diffFiles</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">gd</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"git\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"diff\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"--name-only\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"master...\"</span><span class=\"o\">]}</span>\n<span class=\"w\">    </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">gd</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">diffFiles</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">diffFiles</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">diffFiles</span><span class=\"bp\">.</span><span class=\"n\">isEmpty</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">diffModules</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">diffFiles</span><span class=\"bp\">.</span><span class=\"n\">trimAscii</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"bp\">.</span><span class=\"n\">splitOn</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">mapM</span>\n<span class=\"w\">      </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">moduleNameOfFileName</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">diffModules</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">modName</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"c1\">-- Replace `Mathlib.Tactic.Linter.Whitespace` with files that are locally modified/non-modified</span>\n<span class=\"c1\">-- and see if there are any errors and whether the result is actually correct!</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span>\n<span class=\"w\">  </span><span class=\"n\">isGitModified</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib.Tactic.Linter.Whitespace</span>\n</code></pre></div>",
        "id": 568599699,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768667073
    },
    {
        "content": "<p>do I just paste this into a scratch file</p>",
        "id": 568600040,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768667443
    },
    {
        "content": "<p>Yes, please and see whether you get consistent information.</p>",
        "id": 568600058,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768667472
    },
    {
        "content": "<p>(In doubt, the linter should think that every file is modified.)</p>",
        "id": 568600081,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768667487
    },
    {
        "content": "<p>In case you are curious, the linter is calling <code>git diff --name-only master...</code> from the shell and then checking whether the currently modified file is in the list or not.</p>",
        "id": 568600191,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768667564
    },
    {
        "content": "<p>What I am not sure about is what happens if the <code>git</code> call fails/breaks something.</p>",
        "id": 568600210,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768667582
    },
    {
        "content": "<p>I tried it on master and it returns false on <code>Mathlib.Tactic.Linter.Whitespace</code><br>\nthen I tried it on my branch where I have modified <code>Mathlib.Order.RelClasses</code>, it returns false on <code>Mathlib.Tactic.Linter.Whitespace</code> but returns true on <code>Mathlib.Order.RelClasses</code><br>\ncommenting out and uncommenting the <code>#eval</code> to run the command again doesn't change anything</p>",
        "id": 568600790,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768668221
    },
    {
        "content": "<p>Ok, so this seems to behave as intended, thanks!</p>",
        "id": 568600838,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768668270
    },
    {
        "content": "<p>What system is this?</p>",
        "id": 568600842,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768668277
    },
    {
        "content": "<p>(Note that a file that is modified, but the changes have not been committed, does <em>not</em> count as modified as far as this command is concerned.  The actual linter that uses this command has a separate mechanism to detect this, not relying on <code>git</code>.)</p>",
        "id": 568600911,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768668340
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Testing.20new.20linter.20framework/near/568600842\">said</a>:</p>\n<blockquote>\n<p>What system is this?</p>\n</blockquote>\n<p>not sure what exactly you're looking for</p>",
        "id": 568600947,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768668376
    },
    {
        "content": "<p>the <code>#version</code> command outputs</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"mf\">4.27</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span>\n<span class=\"n\">Target</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x86_64</span><span class=\"bp\">-</span><span class=\"n\">w64</span><span class=\"bp\">-</span><span class=\"n\">windows</span><span class=\"bp\">-</span><span class=\"n\">gnu</span><span class=\"w\"> </span><span class=\"n\">Windows</span>\n</code></pre></div>",
        "id": 568600955,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768668384
    },
    {
        "content": "<p>Did you use it with Windows?  MacOs?  Linux?</p>",
        "id": 568600960,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768668395
    },
    {
        "content": "<p>My main concern is that relying on calling external commands, such as <code>git</code> could have unintended consequences on the linter, which I want to avoid as much as possible.</p>",
        "id": 568601017,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768668451
    },
    {
        "content": "<p>However, I only have access to Linux computers and I would like to see some evidence that the same behaviour that I see also applies to different operating systems.</p>",
        "id": 568601047,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768668482
    },
    {
        "content": "<p>If you need to do this for individual files as that type signature suggests, would it be a little nicer to use the exit code from for instance <code>git diff --quiet master -- Mathlib/Tactic/Linter/Whitespace.lean</code>? This should also detect unstaged changes.</p>",
        "id": 568602243,
        "sender_full_name": "Chris Henson",
        "timestamp": 1768669606
    },
    {
        "content": "<p>I like the idea of the exit code for individual files!  I think that the reason I got to this, is that in an earlier prototype, I was storing all the modified files in an environment extension once, and then I was reading that value on each file.  I later decided to run <code>git</code> on every file, with a mechanism to avoid running it on every command of every file.</p>",
        "id": 568604275,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768671645
    },
    {
        "content": "<p>However, given the granular, per file approach, your solution looks cleaner, I agree.  Thanks!</p>",
        "id": 568604276,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1768671645
    },
    {
        "content": "<p>Can somebody on windows test this, please? I'd love to get this merged, but would prefer even more to know that this seems to work on windows.</p>",
        "id": 570871176,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1769712338
    },
    {
        "content": "<p>Just checking: if <code>git</code> is not installed, this code will exit gracefully --- right?</p>",
        "id": 570871287,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1769712375
    },
    {
        "content": "<p>What happens if this is in a depth-1 repository clone where there is no prior history?</p>",
        "id": 570871598,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769712497
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Testing.20new.20linter.20framework/near/570871176\">said</a>:</p>\n<blockquote>\n<p>I'd love to get this merged</p>\n</blockquote>\n<p>Does \"this\" correspond toa  PR? I don't see it up-thread.</p>",
        "id": 570871675,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769712529
    },
    {
        "content": "<p>This corresponds to <a href=\"https://github.com/leanprover-community/mathlib4/pull/26299\">#26299</a></p>",
        "id": 570871872,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1769712606
    },
    {
        "content": "<p>This feels really scarily hacky, and I hope we don't merge anything where the linter framework queries <code>git</code>. Sorry. :-(</p>",
        "id": 570925207,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769736812
    },
    {
        "content": "<p>If we need to do things like this, it must be done from the outside: some test in CI decides which files have been modified, and re-runs <code>lake build</code> with different settings to enable additional linters.</p>",
        "id": 570925256,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769736847
    },
    {
        "content": "<p>How about this, instead.</p>\n<p>In CI, we set the linters off.  However, while CI is building, we create copies of the modified files only and on those we run the linters.</p>",
        "id": 570978608,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769765291
    },
    {
        "content": "<p>This means that the modified files will be built twice: once in CI without linters and once in CI with linters.</p>",
        "id": 570978679,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769765316
    },
    {
        "content": "<p>The advantage, though, is that all the files downstream of the changes only get built once and without the linters.</p>",
        "id": 570978763,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769765340
    },
    {
        "content": "<p>Since the new files need to be built with the linters on anyway, the overall cost is just building one extra time the modified files without the linters.</p>",
        "id": 570979053,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769765433
    },
    {
        "content": "<p>i think this setup will not have the intended effect when a PR adds a new linter?</p>",
        "id": 571025960,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1769779145
    },
    {
        "content": "<p>since it won't lint the downstream files with the new linter</p>",
        "id": 571026152,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1769779196
    },
    {
        "content": "<p>This issue was there before.  This change is intended only for linters that have already passed over mathlib.</p>",
        "id": 571040168,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769782529
    },
    {
        "content": "<p>If you make a PR modifying this linter, you'd disable this change, and once CI passes, revert it. This is a tiny bit annoying, but I don't anticipate many modifications to the <code>whitespace</code> linter.</p>",
        "id": 571048084,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1769784370
    }
]