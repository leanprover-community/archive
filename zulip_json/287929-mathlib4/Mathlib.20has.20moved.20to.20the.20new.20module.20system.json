[
    {
        "content": "<p>Mathlib has just moved to Lean's new <a href=\"https://lean-lang.org/doc/reference/latest/The-Module-System/#module-system\">module system</a>. </p>\n<p>The module system allows for fast compilation, smaller olean file sizes, and better modular design. Take a look at this: </p>\n<p><a href=\"/user_uploads/3121/WdDHeW_HzPpObIEOxeSq4qVX/modulize.gif\">modulize.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/WdDHeW_HzPpObIEOxeSq4qVX/modulize.gif\" title=\"modulize.gif\"><img data-animated=\"true\" data-original-content-type=\"image/gif\" data-original-dimensions=\"1418x477\" src=\"/user_uploads/thumbnail/3121/WdDHeW_HzPpObIEOxeSq4qVX/modulize.gif/840x560-anim.webp\"></a></div><p>Here I've modified a proof somewhere in the middle of Mathlib, saved the file, and then get an instant rebuild of Mathlib! The module system understands that proof irrelevance means downstream files don't need to be re-checked.</p>\n<p>What do you need to know?</p>\n<ul>\n<li>If your work doesn't involve modifying <code>import</code> statements, you can get by not knowing anything new. :-)</li>\n<li>There's preliminary documentation at <a href=\"https://lean-lang.org/doc/reference/latest/The-Module-System/\">https://lean-lang.org/doc/reference/latest/The-Module-System/</a>. Please read this first!</li>\n<li>By the time the module system matures from its current experimental status, there'll be further documentation.</li>\n<li>The <code>lake exe shake</code> tool will stop working (and will be temporarily disabled in CI), but there is a more powerful and sound replacement on the way.</li>\n</ul>\n<p>Initially in Mathlib the main effect you'll see is fast recompilation if you only change proofs. But the module system will later allow us to do much fancier things, along the lines of Lean understanding that while the real numbers might be defined in terms of Cauchy sequences, there is a proper API barrier here. Changing even <em>definitions</em> about Cauchy sequences will only necessitate recompilation up to the construction of the reals, but not of all downstream <em>uses</em> of the reals.</p>\n<p>The module system splits <code>.olean</code> files into several components. For now the <code>lake exe cache</code> system just downloads everything, but in the future it will get smarter, and the module system will enable us to significantly shrink the size of oleans which need to be downloaded to get started.</p>",
        "id": 558159080,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763546645
    },
    {
        "content": "<p>This looks cool. If you add a theorem to a file but don't actually use that elsewhere, will that require a re-compilation of everything downstream?</p>",
        "id": 558169745,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1763549562
    },
    {
        "content": "<p>Naturally if you change a statement I can see that there would be issues but in that case in theory everything should still work.</p>",
        "id": 558169857,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1763549588
    },
    {
        "content": "<p>I presume so, because it will change the behaviour of e.g. <code>try exact my_theorem</code></p>",
        "id": 558170026,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763549624
    },
    {
        "content": "<p>The potential for proper API barriers sounds <em>really</em> cool. I will repeat an observation I have made before: the concept of \"proof API\" in the sense that Lean and Mathlib communities use it is I think fairly novel - like I think a proper research paper exploring it and comparing it against similar notions etc. would be viable and useful.</p>",
        "id": 558170208,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1763549668
    },
    {
        "content": "<p>In my PhD dissertation I had to describe the concept but it was hard to find anything to cite on the matter!</p>",
        "id": 558170294,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1763549691
    },
    {
        "content": "<p>Yes, if you add a <em>public</em> theorem, (which is the default throughout Mathlib at the moment because every file starts with <code>public section</code>) then that will require recompilation of everything downstream.</p>",
        "id": 558173526,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763550625
    },
    {
        "content": "<p>However, if you add a <em>non-public</em> theorem in <code>X</code>, then it will only require recompilation of modules which use <code>import all X</code>. (or transitive chains of <code>import all</code>s, right?)</p>",
        "id": 558173710,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763550681
    },
    {
        "content": "<p>Don't want to spam announce, so I'll hijack this a bit. The docs link in the announcement (4.26.0) is broken :(. It's <a href=\"https://lean-lang.org/doc/reference/latest/releases/v4.26.0-rc1/\">this link</a>.</p>\n<p><a href=\"https://lean-lang.org/doc/reference/latest/releases/v4.26.0/\">This one</a> works instead (when I manually remove -rc1).</p>",
        "id": 558173861,
        "sender_full_name": "Franti≈°ek Silv√°≈°i ü¶â",
        "timestamp": 1763550727
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"364929\">Franti≈°ek Silv√°≈°i ü¶â</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558173861\">said</a>:</p>\n<blockquote>\n<p>Don't want to spam announce, so I'll hijack this a bit. The docs link in the announcement (4.26.0) is broken :(. It's <a href=\"https://lean-lang.org/doc/reference/latest/releases/v4.26.0-rc1/\">this link</a>.</p>\n</blockquote>\n<p>Fixed, much appreciated!</p>",
        "id": 558174161,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763550791
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558170208\">said</a>:</p>\n<blockquote>\n<p>The potential for proper API barriers sounds <em>really</em> cool. I will repeat an observation I have made before: the concept of \"proof API\" in the sense that Lean and Mathlib communities use it is I think fairly novel - like I think a proper research paper exploring it and comparing it against similar notions etc. would be viable and useful.</p>\n</blockquote>\n<p>I've had the same exact thought. It interacts with both the the software engineering and technical aspects in interesting ways. Like you say, I think if there's a depth of comparison to other systems it would make for a compelling paper.</p>",
        "id": 558176444,
        "sender_full_name": "Chris Henson",
        "timestamp": 1763551465
    },
    {
        "content": "<p>It looks like the import diff bot is broken, eg it doesn't mention any import increase in <a href=\"https://github.com/leanprover-community/mathlib4/pull/29449\">#29449</a>, even though there is one</p>",
        "id": 558177359,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763551717
    },
    {
        "content": "<p>Thanks for reporting, good catch! Let me CC <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> <span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> about the import diff bot. (I don't have time today to investigate, sadly.)</p>",
        "id": 558177622,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763551785
    },
    {
        "content": "<p>Maybe not an appropriate place, but can we have this kind of big shift in announce priorior to the change itself? Also is it possible to to have auto fix for these kind of updates for PR? As when facing PR \"A\" depending on both PR \"B\" and \"C\" having conflicts, this is almost impossible to update smoothly (there are even more annoying case).</p>",
        "id": 558178360,
        "sender_full_name": "Nailin Guan",
        "timestamp": 1763551961
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558159080\">said</a>:</p>\n<blockquote>\n<p>The module system splits <code>.olean</code> files into several components. For now the <code>lake exe cache</code> system just downloads everything, but in the future it will get smarter, and the module system will enable us to significantly shrink the size of oleans which need to be downloaded to get started.</p>\n</blockquote>\n<p>In particular, one immediate effect of this split and reduction of build dependencies is that the RAM necessary for both building and opening Mathlib has fallen by 2.8GB or 48%, reaching a value lower than at the end of the port to Lean 4 or ever since. <br>\n<a href=\"/user_uploads/3121/f0eFaTyNxBiQfDdnSCuf4W9Q/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/f0eFaTyNxBiQfDdnSCuf4W9Q/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1127x707\" src=\"/user_uploads/thumbnail/3121/f0eFaTyNxBiQfDdnSCuf4W9Q/image.png/840x560.webp\"></a></div><p><a href=\"https://radar.lean-lang.org/repos/mathlib4/graph?m=build//maxrss&amp;n=18000\">https://radar.lean-lang.org/repos/mathlib4/graph?m=build//maxrss&amp;n=18000</a></p>",
        "id": 558198236,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1763557799
    },
    {
        "content": "<p>Is the ram usage unchanged for downstream users importing <code>Mathlib</code> like FLT which aren't opted into the module system?</p>",
        "id": 558199385,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1763558131
    },
    {
        "content": "<p>It is, until they opt in as well (which we don't want to recommend yet for this release cycle, let's evaluate it on Mathlib first)</p>",
        "id": 558199638,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1763558201
    },
    {
        "content": "<p>Does this new module system have any affect on open PRs? My <a href=\"https://github.com/leanprover-community/mathlib4/pull/31101\">#31101</a> is currently broken and I'm wondering if it has something to do with this. First I had a merge conflict with master, which I think was just a missing <code>module</code> at the start of the <code>Mathlib.lean</code> file. I updated that then ran <code>lake exe mk_all</code> (the PR creates a new file) but now have this error message:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Run</span><span class=\"w\"> </span><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">pr</span><span class=\"bp\">-</span><span class=\"n\">branch</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">pr</span><span class=\"bp\">-</span><span class=\"n\">branch</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">LEAN_ABORT_ON_PANIC</span><span class=\"bp\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">../</span><span class=\"n\">master</span><span class=\"bp\">-</span><span class=\"n\">branch</span><span class=\"bp\">/</span><span class=\"n\">scripts</span><span class=\"bp\">/</span><span class=\"n\">lake</span><span class=\"bp\">-</span><span class=\"n\">build</span><span class=\"bp\">-</span><span class=\"n\">wrapper</span><span class=\"bp\">.</span><span class=\"n\">py</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build_summary_lint</span><span class=\"bp\">.</span><span class=\"n\">json</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">runLinter</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"n\">Build</span><span class=\"w\"> </span><span class=\"n\">progress</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">starting</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"bp\">/</span><span class=\"mi\">22</span><span class=\"o\">]</span>\n<span class=\"bp\">‚úñ</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">7568</span><span class=\"bp\">/</span><span class=\"mi\">7568</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mf\">4.8</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">required</span><span class=\"w\"> </span><span class=\"n\">targets</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">specified</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">actions</span><span class=\"bp\">-</span><span class=\"n\">runner</span><span class=\"bp\">/_</span><span class=\"n\">work</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span><span class=\"bp\">/</span><span class=\"n\">pr</span><span class=\"bp\">-</span><span class=\"n\">branch</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">olean'</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">exist</span>\n</code></pre></div>",
        "id": 558242804,
        "sender_full_name": "Emily Riehl",
        "timestamp": 1763567990
    },
    {
        "content": "<p>This looks great <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> How does it compare to the OCaml/rocq module system, or with the wide theoretical literature on modules (Harper-Stone, F-ing modules, ..., or even more recent work based on modal type theory)</p>",
        "id": 558242881,
        "sender_full_name": "Bas Spitters",
        "timestamp": 1763568004
    },
    {
        "content": "<p>It has basically no relation to what ML calls modules at all</p>",
        "id": 558245361,
        "sender_full_name": "Henrik B√∂ving",
        "timestamp": 1763568534
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"246635\">@Emily Riehl</span> , that's the wrong part of the error; that's just saying \"the linter failed because the build higher up failed\"</p>",
        "id": 558246378,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1763568758
    },
    {
        "content": "<p>Unfortunately github defaults to showing the last error not the first</p>",
        "id": 558246465,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1763568773
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"395550\">@Henrik B√∂ving</span> so is there something the module system takes inspiration from?</p>",
        "id": 558248087,
        "sender_full_name": "Bas Spitters",
        "timestamp": 1763569117
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> thanks for the fix. I take it I'm supposed to write <code>module</code> at the start of any new Lean file now? What else should (naive) users know?</p>",
        "id": 558250954,
        "sender_full_name": "Emily Riehl",
        "timestamp": 1763569746
    },
    {
        "content": "<p><code>module</code> + replace <code>import</code> with <code>public import</code> (for now)</p>",
        "id": 558251051,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763569773
    },
    {
        "content": "<p>I note that the backticks in the following error are misplaced:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">non</span><span class=\"bp\">`-</span><span class=\"n\">module</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Probability</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">BinomialRandomGraph</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"ss\">`module</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>It should instead be</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">non</span><span class=\"bp\">-</span><span class=\"ss\">`module</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Probability</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">BinomialRandomGraph</span><span class=\"bp\">.</span><span class=\"n\">Defs</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"ss\">`module</span><span class=\"bp\">`</span>\n</code></pre></div>",
        "id": 558251389,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763569857
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558177359\">said</a>:</p>\n<blockquote>\n<p>It looks like the import diff bot is broken, eg it doesn't mention any import increase in <a href=\"https://github.com/leanprover-community/mathlib4/pull/29449\">#29449</a>, even though there is one</p>\n</blockquote>\n<p>The script that counts transitive dependencies probably looks for lines that start with <code>import ...</code> instead of <code>public import ...</code>.  I don't have time now for a proper fix, but a quick one would be to simply change the regex to allow <code>public</code> before <code>import</code>...</p>",
        "id": 558257342,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1763571327
    },
    {
        "content": "<p>I foresee that a lot of PRs adding a (single) new file will forget to add <code>@[expose] public section</code>, because it won't break anything within the PR. Could we have a linter against files that contain only private declarations?</p>",
        "id": 558258065,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763571503
    },
    {
        "content": "<p>I tried reviewing a PR (<a href=\"https://github.com/leanprover-community/mathlib4/pull/27414\">#27414</a>) adding a single new file by copying its content in <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a>. Unfortunately, the <code>module</code> invokation at the top fails with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">'/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">lean4web</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">deploy</span><span class=\"bp\">-</span><span class=\"mi\">2025</span><span class=\"bp\">-</span><span class=\"mi\">11</span><span class=\"bp\">-</span><span class=\"mi\">16</span><span class=\"n\">T18</span><span class=\"bp\">-</span><span class=\"mi\">00</span><span class=\"bp\">-</span><span class=\"mi\">12</span><span class=\"bp\">+</span><span class=\"mi\">00</span><span class=\"bp\">-</span><span class=\"mi\">00</span><span class=\"bp\">/</span><span class=\"n\">MathlibDemo</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Order</span><span class=\"bp\">/</span><span class=\"n\">Group</span><span class=\"bp\">/</span><span class=\"n\">Ideal</span><span class=\"bp\">.</span><span class=\"n\">olean'</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">exist</span>\n</code></pre></div>\n<p>What gives?</p>",
        "id": 558265778,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763573477
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558258065\">said</a>:</p>\n<blockquote>\n<p>I foresee that a lot of PRs adding a (single) new file will forget to add <code>@[expose] public section</code>, because it won't break anything within the PR. Could we have a linter against files that contain only private declarations?</p>\n</blockquote>\n<p>I was asking exactly this... and if someone has 2 minutes... <a href=\"https://github.com/leanprover-community/mathlib4/pull/31815\">#31815</a></p>",
        "id": 558266249,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1763573630
    },
    {
        "content": "<p>Ahahah, my prediction was quick to realise <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 558266373,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763573666
    },
    {
        "content": "<p>Do we have opinions on whether import statements should be sorted by private vs public first, then alphabetically, or just alphabetically? ie</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n</code></pre></div>\n<p>vs</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"c1\">-- A space here? Don't know!</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n</code></pre></div>\n<p>vs</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n<span class=\"c1\">-- A space here? Don't know!</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n</code></pre></div>",
        "id": 558266690,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763573765
    },
    {
        "content": "<p>The former looks ragged, but has the advantage of being the easiest to edit when privatising or publicising an import, although I foresee that this might be an uncommon operation to perform</p>",
        "id": 558266938,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763573835
    },
    {
        "content": "<p>Btw, looking at it on Zulip, it's clear that <code>public</code> should be highlighted as a keyword just like <code>import</code> is. Anyone to update the lexer? <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 558267263,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763573943
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558258065\">said</a>:</p>\n<blockquote>\n<p>I foresee that a lot of PRs adding a (single) new file will forget to add <code>@[expose] public section</code>, because it won't break anything within the PR. Could we have a linter against files that contain only private declarations?</p>\n</blockquote>\n<p>I took a quick look because I expected this to be easy, but I'm actually not sure how we're meant to access the public/private constants in the current environment (per scope) in meta code, or even how to see the <code>Visibility</code> of a given declaration. No visibility information seems to be stored in the kernel environment, <code>VisibilityMap</code> itself is private, and Loogle doesn't turn up anything promising for <code>Visibility</code>...is the right approach just to <code>import all</code> and deal with the internals directly? Maybe this is a question for <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> ? <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span> :)</p>",
        "id": 558270772,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1763575122
    },
    {
        "content": "<p>Here's a first stab. Documentation suggests that everything does indeed wind up in <code>asyncConstsMap</code> even if added synchronously with <code>addDecl</code>.</p>\n<p>From experimentation, it seems like Lean adds <code>_private</code> to the front of non-public declarations, and includes all declarations in <em>both</em> the <code>public</code> and <code>private</code> <code>VisibilityMap</code> fields accessed here. I don't really understand why, or if this may change in the future, but this code should be robust to a change if it does.</p>\n<p>I'd definitely like to get some feedback, though. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>linter code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span>\n\n<span class=\"c\">/-</span><span class=\"cm\">!</span>\n<span class=\"cm\"># Private module linter</span>\n\n<span class=\"cm\">This linter lints against nonempty modules that have only private declarations.</span>\n<span class=\"cm\">-/</span>\n\n<span class=\"n\">meta</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">Linter</span>\n\n<span class=\"sd\">/-- The `privateModule` linter lints against nonempty modules that have only private declarations,</span>\n<span class=\"sd\">and suggests adding `@[expose] public section` to the top. -/</span>\n<span class=\"n\">register_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">privateModule</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">defValue</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Enable the `privateModule` linter, which lints against nonempty modules that have only </span><span class=\"se\">\\</span>\n<span class=\"s2\">    private declarations.\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">privateModule</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Linter</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Parser.Command.eoi</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">getLinterValue</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">privateModule</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getLinterOptions</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"n\">return</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">header</span><span class=\"bp\">.</span><span class=\"n\">isModule</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"c1\">-- Wait for everything (necessary?)</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">checked</span><span class=\"bp\">.</span><span class=\"n\">get</span>\n<span class=\"w\">        </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">asyncConstsMap</span><span class=\"bp\">.</span><span class=\"n\">public</span><span class=\"bp\">.</span><span class=\"n\">revList</span><span class=\"bp\">.</span><span class=\"n\">any</span>\n<span class=\"w\">            </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"ss\">`_private</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isPrefixOf</span><span class=\"w\"> </span><span class=\"bp\">¬∑.</span><span class=\"n\">constInfo</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">          </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">asyncConstsMap</span><span class=\"bp\">.</span><span class=\"kn\">private</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">‚â†</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">            </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">topOfFileRef</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">atom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">synthetic</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"mi\">0</span><span class=\"bp\">‚ü©</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"mi\">0</span><span class=\"bp\">‚ü©</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">            </span><span class=\"n\">logLint</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">privateModule</span><span class=\"w\"> </span><span class=\"n\">topOfFileRef</span>\n<span class=\"w\">              </span><span class=\"s2\">\"Module only contains private declarations.</span><span class=\"se\">\\n\\n\\</span>\n<span class=\"s2\">              Consider adding `@[expose] public section` at the beginning of the module.\"</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">addLinter</span><span class=\"w\"> </span><span class=\"n\">privateModule</span>\n</code></pre></div>\n</div></div>",
        "id": 558281858,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1763578830
    },
    {
        "content": "<p>(This is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/31820\">#31820</a>...we'll see if it catches any more missed <code>@[expose] public section</code>s <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span>)</p>",
        "id": 558285117,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1763580046
    },
    {
        "content": "<p>It caught exactly one: <a href=\"https://github.com/leanprover-community/mathlib4/pull/31822\">#31822</a> :)</p>",
        "id": 558294893,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1763583699
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"749361\">Nailin Guan</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558178360\">said</a>:</p>\n<blockquote>\n<p>Maybe not an appropriate place, but can we have this kind of big shift in announce priorior to the change itself? Also is it possible to to have auto fix for these kind of updates for PR? As when facing PR \"A\" depending on both PR \"B\" and \"C\" having conflicts, this is almost impossible to update smoothly (there are even more annoying case).</p>\n</blockquote>\n<p>Indeed, there could have been a useful preliminary public announcement. We've been discussing it at length both in private maintainers/reviewers channels for some time, and also discussing it in the public #**nightly-testing&gt; channel for the last two months. There's a balance to get right here: if we have something equally as dramatic come up in future, I'll try to make sure the information about it is a bit more visible. But realistically, we don't want to spam most users about things still in the future, and for those who want visibility into what is coming up, I recommend subscribing to (parts of) the #nightly-testing channel, which is open to all.</p>",
        "id": 558312180,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763589834
    },
    {
        "content": "<p>Kim, I understand, but here <em>writing a script</em> would have been nice. It personally took me 2-3h fixing the conflicts on my 50 open PRs, even though they were (almost) all quite trivial.</p>",
        "id": 558360499,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763622252
    },
    {
        "content": "<p>I took nearly 2 hours only fixing approximately 1/3 of my nearly 50 open PRs, although some difficulties caused by github. Cache broken make this really having some difficulties.</p>\n<p>Also, I believe a short announce is always good (at least in my opinion). Also, if in some cases it is hard to have a script, is it possible to have a time with parallel system, leaving some time for the change? Maybe this idea isn't appropriate here as this is from migrating to fork.</p>",
        "id": 558362019,
        "sender_full_name": "Nailin Guan",
        "timestamp": 1763623002
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558312180\">Ë™™</a>Ôºö</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"749361\">Nailin Guan</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558178360\">said</a>:</p>\n<blockquote>\n<p>Maybe not an appropriate place, but can we have this kind of big shift in announce priorior to the change itself? Also is it possible to to have auto fix for these kind of updates for PR? As when facing PR \"A\" depending on both PR \"B\" and \"C\" having conflicts, this is almost impossible to update smoothly (there are even more annoying case).</p>\n</blockquote>\n<p>Indeed, there could have been a useful preliminary public announcement. We've been discussing it at length both in private maintainers/reviewers channels for some time, and also discussing it in the public #**nightly-testing&gt; channel for the last two months. There's a balance to get right here: if we have something equally as dramatic come up in future, I'll try to make sure the information about it is a bit more visible. But realistically, we don't want to spam most users about things still in the future, and for those who want visibility into what is coming up, I recommend subscribing to (parts of) the #nightly-testing channel, which is open to all.</p>\n</blockquote>\n<p>Also, there are different priorior, I believe  this thread should at least appear before the update PR, this is at least 2 hours later than the update, within these time we can only get random instructions from the ones online.</p>",
        "id": 558363683,
        "sender_full_name": "Nailin Guan",
        "timestamp": 1763623810
    },
    {
        "content": "<p>My understanding is that having a time with and without the module system coexisting in mathlib would not have worked well. That said, a migration script would have been helpful.</p>",
        "id": 558367946,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1763625607
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> I think you'll simply want to use <code>env.constants.map‚ÇÇ</code> as before and filter by <code>isPrivateName</code></p>",
        "id": 558371376,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1763626895
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Ya√´l Dillies</span>, <span class=\"user-mention\" data-user-id=\"749361\">@Nailin Guan</span>, <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span>, if you have ideas for a script, please suggest / implement it! My experience so far is that it's not super scriptable, but I'm happy to see proposals.</p>",
        "id": 558399834,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763635938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558266690\">said</a>:</p>\n<blockquote>\n<p>Do we have opinions on whether import statements should be sorted by private vs public first, then alphabetically, or just alphabetically?</p>\n</blockquote>\n<p>I now have the opinion that public and private imports should be separated, with the public ones coming first, and sorted alphabetically within each, ie</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">D</span>\n</code></pre></div>",
        "id": 558491896,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763660430
    },
    {
        "content": "<p>Indeed, the procedure to reduce imports is to first reduce the public imports, potentially adding more private imports doing so, then reduce the private imports. The public and private imports usually come from widely different strata of mathlib (the public ones being much earlier, which also shows mathlib could gain <em>a lot</em> from wholly embracing modules), so it basically never happens that you privatise an existing public import, except when you're trying to reduce imports (meaning that a PR diff should basically never contain some pure unprivatising)</p>",
        "id": 558492584,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763660639
    },
    {
        "content": "<p>I did some experiment with my existing PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/24912\">#24912</a>, and I am very pleased. I deliberately did not use <code>@[expose]</code> because all files but one don't contain <code>def</code>s at all, and the one that does contains a <code>def</code> that could be considered an implementation detail.</p>",
        "id": 558493176,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1763660764
    },
    {
        "content": "<p>A possible improvement to linting for files with only private declarations would be to check for any private lemmas / definitions that aren't used at all in the whole project. This is particularly relevant for the mathlib archive: a typical file there should probably have only one or two main results that are public, with everything else being private, and it's very easy while developing something for the archive to end up with lemmas that you used at an earlier stage of the development but ended up not being needed in the final version (and are presumptively not of more general use, because more general lemmas should have gone in mathlib proper in the first place). So switching the archive to the convention that only the final main results are public would potentially allow detecting private lemmas that are no longer used and so should be deleted. (The same can apply to private lemmas in mathlib, it's just that there aren't so many such lemmas.)</p>",
        "id": 558564719,
        "sender_full_name": "Joseph Myers",
        "timestamp": 1763690783
    },
    {
        "content": "<p>Is <code>private</code> now a legacy API in non-module system or orthogonal with the module system (especially the <code>public</code> keyword)? Thanks!</p>",
        "id": 558848923,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1763852688
    },
    {
        "content": "<p>Is <code>shake</code> broken? I tried running it and it seems to be recommend removing many of the imports in most of the files.</p>",
        "id": 558864988,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1763872854
    },
    {
        "content": "<p>Yes, <code>shake</code> no longer works. A replacement is coming soon. In the meantime, relax. :-)</p>",
        "id": 558865051,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1763872930
    },
    {
        "content": "<p>My understanding is that for old files, the primary changes are adding <code>module</code> to the top, making all the imports into <code>public import</code>, and adding <code>@[expose] public section</code>. But for new files, can we skip the <code>@[expose] public section</code> and be more judicious about what to expose?</p>",
        "id": 558876273,
        "sender_full_name": "Niels Voss",
        "timestamp": 1763885691
    },
    {
        "content": "<p>I noticed that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mythm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>fails, but replacing the <code>rfl</code> with a <code>by rfl</code> causes it to succeed. Are theorems whose proofs are just <code>rfl</code> treated specially for some reason (perhaps <code>dsimp</code>)?</p>",
        "id": 558924917,
        "sender_full_name": "Niels Voss",
        "timestamp": 1763934324
    },
    {
        "content": "<p>Yes but that has been true regardless of <code>module</code> for a while, <a href=\"https://github.com/leanprover/lean4/pull/8419\">lean#8419</a>. That <code>rfl</code> is not even accepted here is new, of course.</p>",
        "id": 558925119,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1763934588
    },
    {
        "content": "<p>Does <code>find_home</code> also fail because of the change? I got some strange result.<br>\n<a href=\"/user_uploads/3121/FEq4w8F5Ei_dt0FhYORBm_zG/.png\">ÂõæÁâá.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/FEq4w8F5Ei_dt0FhYORBm_zG/.png\" title=\"ÂõæÁâá.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2388x420\" src=\"/user_uploads/thumbnail/3121/FEq4w8F5Ei_dt0FhYORBm_zG/.png/840x560.webp\"></a></div>",
        "id": 560067461,
        "sender_full_name": "Nailin Guan",
        "timestamp": 1764045937
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- `by rfl` also fails</span>\n</code></pre></div>\n<p>fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Not</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">definitional</span><span class=\"w\"> </span><span class=\"n\">equality</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">log2</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">definitionally</span><span class=\"w\"> </span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>but if you remove the <code>module</code> then it works. Why is this and what should I do about it? It's causing the failure of <a href=\"https://github.com/leanprover-community/mathlib4/pull/30144\">#30144</a>.</p>",
        "id": 560595100,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764249474
    },
    {
        "content": "<p>If you want your function <code>binaryRec‚Çñ</code> to be kernel reducible for anyone who imports it, then you need to explicitly expose the value of the definition. This is done with the <code>@[expose]</code> tag.</p>",
        "id": 560595765,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764249669
    },
    {
        "content": "<p>Noted, thanks! The file doesn't currently build though due to the log2 defeq failure.</p>",
        "id": 560596338,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764249833
    },
    {
        "content": "<p>Since <code>Nat.log2</code> has not been tagged with <code>@[expose]</code>, the kernel cannot unfold it. Instead you will need to rewrite with <code>Nat.log2_def</code> (or any other lemma).</p>",
        "id": 560596860,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764249973
    },
    {
        "content": "<p>Oh and you don't need to use the <code>@[expose]</code> tag if you are already inside an <code>@[expose] section</code>, which is currently basically all of mathlib.</p>",
        "id": 560597329,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764250109
    },
    {
        "content": "<p>Why does it work without the <code>module</code>? Is the module system working as intended here?</p>",
        "id": 560597369,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764250120
    },
    {
        "content": "<p>Yes, being able to hide definitions is one of the features of the <code>module</code> system. Not using <code>module</code> gives you the old behaviour where everything can be unfolded.</p>",
        "id": 560597655,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764250206
    },
    {
        "content": "<p>I'm afraid my <code>binaryRec‚Çñ</code> won't compute if <code>Nat.log2</code> don't compute. I guess I should submit a PR to Lean 4 repo to add the <code>@[expose]</code> tag to <code>Nat.log2</code>.</p>",
        "id": 560597877,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764250269
    },
    {
        "content": "<p>Sorry for the noob question but how do I test the effect of Lean changes on mathlib? If I edit the file <code>C:\\Users\\xujys\\.elan\\toolchains\\leanprover--lean4---v4.26.0-rc2\\src\\lean\\Init\\Data\\Nat\\Log2.lean</code> (where \"Go to Definition\" jumps to) there's no effect even if I restart the file or the server. I guess I can modify the <code>lean-toolchain</code> file in mathlib but it takes a release, not a commit ID like <code>lake-manifest.json</code>.</p>",
        "id": 560603354,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764251715
    },
    {
        "content": "<p>I've now opened <a href=\"https://github.com/leanprover/lean4/pull/11401\">lean4#11401</a> but can't verify whether it makes <a href=\"https://github.com/leanprover-community/mathlib4/pull/30144\">#30144</a> build.</p>",
        "id": 560603629,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1764251777
    },
    {
        "content": "<p>The way to test this is slightly involved. You have to make a PR to lean core, but instead of branching off of <code>master</code>, you have to branch off of <code>nightly-with-mathlib</code>, because that branch has a corresponding mathlib version. If you branched off of <code>master</code> already, you can fix this by doing a <code>git rebase</code> onto <code>nightly-with-mathlib</code> (and a <code>push --force</code>). Then the automation will create a corresponding mathlib branch that depends on the toolchain from your lean PR.</p>\n<p>Though I think this change is small enough where testing it on Mathlib may not be necessary.</p>",
        "id": 560617227,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764255413
    },
    {
        "content": "<p>I just encountered a case of unexpected rebuilding: adding a <code>set_option linter.flexible false in</code> to a lemma causes a rebuild. Is this to be expected? (That linter is a syntax linter, hence does not/should not affect the generated proofs.)</p>",
        "id": 560735331,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1764320538
    },
    {
        "content": "<p>Linters can emit (error) messages, so maybe that is the reason for rebuilding?  Linters cannot affect the environment, but can also rewrite files, so they can certainly affect more than proofs, if you really wanted to!</p>",
        "id": 560740070,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1764321975
    },
    {
        "content": "<p>I would like it if there were a new \"category\" of commands that could be inserted anywhere and has a guarantee that rebuilding is not required, though.</p>",
        "id": 560740209,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1764322010
    },
    {
        "content": "<p>Indeed, a way to say \"I'm a harmless linter, don't look at me for rebuilding\" might be nice.</p>",
        "id": 560740369,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1764322052
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> Do you have a reproducer?</p>",
        "id": 560751782,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764325737
    },
    {
        "content": "<p>I am not sure I understand what <code>@[expose]</code> is for. If I understand correctly, it puts the body of a <code>def</code> in the public scope. But if I write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">baz</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>then if I need the value of <code>foo</code>, I can use <code>foo_def</code>, so I don't need to access the body of <code>foo</code> directly. Note that in the lemma above I need to use <code>by rfl</code> (or <code>Eq.refl _</code>) instead of <code>rfl</code>. I don't know why because</p>\n<blockquote>\n<p><code>theorem</code>¬†and¬†<code>opaque</code>¬†never expose their body</p>\n</blockquote>\n<p>so <code>rfl</code> should be considered in the private scope and should therefore be able to unfold <code>foo</code>, and indeed <code>Eq.refl _</code> works. Is <code>@[expose]</code> only meant to allow for <code>:= rfl</code> proofs to work, because for some reason they don't work otherwise? I feel like I am missing something, can anyone enlighten me please?</p>",
        "id": 560855095,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764364438
    },
    {
        "content": "<p>if you do <code>rfl</code> instead of <code>by rfl</code> it marks the theorem as a rfl-lemma</p>",
        "id": 560855455,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764364694
    },
    {
        "content": "<p>and it's not a rfl-lemma in the public scope since the body isn't exposed</p>",
        "id": 560855469,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764364711
    },
    {
        "content": "<p>In what situation would you use <code>rfl</code> in the public scope?</p>",
        "id": 560855725,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764364935
    },
    {
        "content": "<p>if you're rewriting by a rfl-lemma then you can use dsimp, for example</p>",
        "id": 560855836,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764365044
    },
    {
        "content": "<p>so that's why we mark rfl-lemmas specially</p>",
        "id": 560855852,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764365056
    },
    {
        "content": "<p>But <code>dsimp</code> would be used in a proof, so in the private scope, not the public scope.</p>",
        "id": 560857240,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764366158
    },
    {
        "content": "<p>if it's used in another module importing the one you wrote</p>",
        "id": 560857332,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764366244
    },
    {
        "content": "<p>So <code>@[expose]</code> is only needed to be able to unfold the definition in another module without relying on a lemma like <code>foo_def</code> that could be used with <code>rw</code> or <code>simp</code> or <code>simp_rw</code>? But if <code>:= rfl</code> tags the lemma as a <code>rfl</code> lemma, then when you use <code>rfl</code> in another module it calls the lemma, it does not unfold the definition directly? Or does it?</p>",
        "id": 560858072,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764366849
    },
    {
        "content": "<p>if it's a rfl-lemma then that means you should be able to replace any occurrence of the lemma with just rfl</p>",
        "id": 560858226,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764366986
    },
    {
        "content": "<p>so rfl has to work in the public scope too</p>",
        "id": 560858249,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367004
    },
    {
        "content": "<p>But you never use a lemma in the public scope</p>",
        "id": 560858294,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764367039
    },
    {
        "content": "<p>what does that mean</p>",
        "id": 560858447,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367194
    },
    {
        "content": "<p>if it's a <code>public theorem</code> then you can use it in the public scope</p>",
        "id": 560858488,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367224
    },
    {
        "content": "<p>When you use a lemma, you are inside a proof, and proofs are in the private scope</p>",
        "id": 560858506,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764367238
    },
    {
        "content": "<p>I don't understand why <code>:= by rfl</code> would work without <code>@[expose]</code> but <code>:= rfl</code> wouldn't work as they are the same lemmas in the end. Why should the latter being a <code>rfl</code> lemma change anything?</p>",
        "id": 560858734,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764367377
    },
    {
        "content": "<p>if I have another module which imports your file</p>",
        "id": 560858766,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367392
    },
    {
        "content": "<p>then it's important that your lemma is still a rfl-lemma in my new file</p>",
        "id": 560858826,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367419
    },
    {
        "content": "<p>my new file only imports the public scope of your file</p>",
        "id": 560858839,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367431
    },
    {
        "content": "<p>so if the definition is in the private scope of your file, I can't unfold it</p>",
        "id": 560858851,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367441
    },
    {
        "content": "<p>so it's not a rfl-lemma, which is a problem</p>",
        "id": 560858867,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367449
    },
    {
        "content": "<p>Yes but my lemma <code>:= by rfl</code> is in the public scope of my file.</p>",
        "id": 560858881,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764367462
    },
    {
        "content": "<p>So you can use this to unfold.</p>",
        "id": 560858896,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764367477
    },
    {
        "content": "<p>it's not the lemma that's the problem</p>",
        "id": 560858905,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367481
    },
    {
        "content": "<p>it's the fact that it's a rfl-lemma</p>",
        "id": 560858907,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367488
    },
    {
        "content": "<p>rfl-lemma means it has to be true by definition</p>",
        "id": 560858932,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367511
    },
    {
        "content": "<p>The fact that <code>theorem</code> doesn't expose its body does not mean that you get access to all private scopes while writing the proof. It just means that once the theorem is proved, you can't look into the proof.</p>",
        "id": 560858937,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764367515
    },
    {
        "content": "<p>and if I'm stopped from unfolding stuff then it's no longer true by definition</p>",
        "id": 560858968,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764367539
    },
    {
        "content": "<p>How does <code>rfl</code> unfold the definition? Does it use the <code>rfl</code>-lemma, or the body of the definition directly?</p>",
        "id": 560859469,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764367848
    },
    {
        "content": "<p>The story about <code>rfl</code> lemmas is a red herring, it is only relevant to <code>dsimp</code></p>",
        "id": 560859625,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764367950
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560858937\">said</a>:</p>\n<blockquote>\n<p>The fact that <code>theorem</code> doesn't expose its body does not mean that you get access to all private scopes while writing the proof. It just means that once the theorem is proved, you can't look into the proof.</p>\n</blockquote>\n<p>Ok fair point, you don't want to access the inside of a theorem for instance. But I would guess that the body of a <code>def</code> is always accessible in the private scope if you are in the same file as where the <code>def</code> is.</p>",
        "id": 560859740,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764368046
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560859625\">said</a>:</p>\n<blockquote>\n<p>The story about <code>rfl</code> lemmas is a red herring, it is only relevant to <code>dsimp</code></p>\n</blockquote>\n<p>Ok, so <code>rfl</code> does not use <code>rfl</code> lemmas, it unfolds directly, so <code>@[expose]</code> is needed on a <code>def</code> if we want <code>rfl</code> to be able to unfold it in later imports. Do I get that right?</p>",
        "id": 560859836,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764368115
    },
    {
        "content": "<p>maybe?</p>",
        "id": 560859919,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368193
    },
    {
        "content": "<p>so when you write a theorem and you prove it with <code>:= rfl</code> it gets tagged with an attribute <code>@[defeq]</code></p>",
        "id": 560860052,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368318
    },
    {
        "content": "<p>and that's supposed to signal to tactics like dsimp that this lemma is a definitional equality</p>",
        "id": 560860094,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368352
    },
    {
        "content": "<p>but of course this only works well when the lemma is actually a definitional equality</p>",
        "id": 560860122,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368373
    },
    {
        "content": "<p>and that has to be a defeq in the scope that it gets used in</p>",
        "id": 560860193,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368433
    },
    {
        "content": "<p>so if it's a public theorem then the <code>@[defeq]</code> attribute will double check that it's a definitional equality in the public scope, since even though the proof is <code>rfl</code> that proof was elaborated in the private scope which is allowed to unfold more things</p>",
        "id": 560860252,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368489
    },
    {
        "content": "<p>Well if I did get it right then it answers my main question. However I am then still unsure why <code>:= by rfl</code> is accepted but not <code>:= rfl</code>.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560860122\">said</a>:</p>\n<blockquote>\n<p>but of course this only works well when the lemma is actually a definitional equality</p>\n</blockquote>\n<p>This does not seem obvious to me. If you just apply a lemma, why do you care whether it is defeq or not? But this is more of a question about how <code>dsimp</code> works I guess. I personally never use it.</p>",
        "id": 560860300,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764368525
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"703970\">Etienne Marion</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560860300\">said</a>:</p>\n<blockquote>\n<p>This does not seem obvious to me. If you just apply a lemma, why do you care whether it is defeq or not?</p>\n</blockquote>\n<p>well I have a code example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">17</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">)</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">True</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">foo_def</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">baz</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">foo_def</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- the goal is now `baz 17 bar`</span>\n<span class=\"w\">  </span><span class=\"c1\">-- if foo is not defeq to 17 then this no longer typechecks</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 560860693,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368826
    },
    {
        "content": "<p>and indeed if you change the proof of <code>foo_def</code> to <code>by rfl</code> then you get \"<code>simp</code> made no progress\"</p>",
        "id": 560860781,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764368890
    },
    {
        "content": "<p>I believe the question <span class=\"user-mention\" data-user-id=\"703970\">@Etienne Marion</span> asked was not related to <code>dsimp</code> or <code>simp</code></p>",
        "id": 560861110,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764369152
    },
    {
        "content": "<p>yes I'm showing why we sometimes care whether a lemma is defeq</p>",
        "id": 560861206,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764369240
    },
    {
        "content": "<p>Actually my initial question was not because it was more about the purpose of <code>@[expose]</code>, but then I asked why <code>defeq</code> lemmas were treated in a special way, which is related to <code>dsimp</code></p>",
        "id": 560861214,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764369245
    },
    {
        "content": "<p>I see. So there are certain situations where a <code>defeq</code> rewrite cannot be replaced by a propositional rewrite, here because you rewrite something which is part of a type, so you need defeq to be sure it still typechecks I guess?</p>",
        "id": 560861280,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764369298
    },
    {
        "content": "<p>oh I realized I haven't actually answered your initial question (\"what is the purpose of <code>@[expose]</code>\")</p>",
        "id": 560861408,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1764369392
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"703970\">Etienne Marion</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560859836\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560859625\">said</a>:</p>\n<blockquote>\n<p>The story about <code>rfl</code> lemmas is a red herring, it is only relevant to <code>dsimp</code></p>\n</blockquote>\n<p>Ok, so <code>rfl</code> does not use <code>rfl</code> lemmas, it unfolds directly, so <code>@[expose]</code> is needed on a <code>def</code> if we want <code>rfl</code> to be able to unfold it in later imports. Do I get that right?</p>\n</blockquote>\n<p>This is the conclusion I got.</p>",
        "id": 560861450,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764369428
    },
    {
        "content": "<p>Well I certainly learnt a lot, thank you!</p>",
        "id": 560861556,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764369504
    },
    {
        "content": "<p>There's certainly something confusing here: The fact that <code>rfl</code> tags the lemma with <code>@[defeq]</code> is an implementation detail that should not influence whether the proof goes through or not. IMO it would be much less surprising if the criterion for tagging with <code>@[defeq]</code> were to be \"the proof is <code>rfl</code> AND the definitions that need unfolding for the equality to be defeq all expose their body\".</p>",
        "id": 560893126,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1764402986
    },
    {
        "content": "<p>If you agree, I'll open an issue in the lean repo</p>",
        "id": 560893195,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1764403044
    },
    {
        "content": "<p>It is not an implementation detail though, it is part of your module's interface and changing it <em>will</em> break downstream code. So there needs to be some syntactic marker.</p>",
        "id": 560894279,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764403855
    },
    {
        "content": "<p>Right, so let that be an actual use of the <code>@[defeq]</code> attribute, and not this weird technicality that <code>:= rfl</code> and <code>:= by rfl</code> are different?</p>",
        "id": 560900796,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1764409959
    },
    {
        "content": "<p>And let the attribute check that the lemma actually is <code>rfl</code> in the public scope</p>",
        "id": 560900834,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1764410008
    },
    {
        "content": "<p>I will leave that part to <span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> :)</p>",
        "id": 560900836,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764410008
    },
    {
        "content": "<p>Is one of the long-term goal of the module system to have files which strictly contain only <code>def</code>s, and these files should be the only ones to be <code>public import</code>ed, and all the theorems are in separate files which should be <code>import</code>ed?</p>",
        "id": 560901160,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764410309
    },
    {
        "content": "<p>i don't think that's a goal, that's a <em>means</em> if anything. the relevant <em>goal</em> should be (and probably is) enabling increased compiler/typechecker efficiency.</p>",
        "id": 560908308,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1764416462
    },
    {
        "content": "<p>(among other goals of course)</p>",
        "id": 560908346,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1764416518
    },
    {
        "content": "<p>for an answer which better than a guess, i seem to recall the FRO roadmap mentioning the module system, as well as (i believe) goals and motivations for it.</p>",
        "id": 560908443,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1764416620
    },
    {
        "content": "<p>The word \"goal\" may not be the right one indeed, I am just wondering if this something we should tend to. I‚Äôll have a look at the roadmap.</p>",
        "id": 560909368,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764417549
    },
    {
        "content": "<p>I don't find much on <a href=\"https://lean-lang.org/fro/roadmap/y3/\">https://lean-lang.org/fro/roadmap/y3/</a>.</p>",
        "id": 560910064,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764418196
    },
    {
        "content": "<p>I agree it‚Äôs somewhat confusing that </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¶</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>is special (unlike <code>:= (rfl)</code> or <code>:= by refl</code> or anything else) and equivalent to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">defeq</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¶</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and that one can think that it‚Äôs in bad taste. The goal here was to be pragmatic and do the right thing in the common case.</p>\n<p>With this syntactic peculiarity explained, is there still something not working as intended?</p>",
        "id": 560911326,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1764419363
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"470149\">Joachim Breitner</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560911326\">said</a>:</p>\n<blockquote>\n<p>With this syntactic peculiarity explained, is there still something not working as intended?</p>\n</blockquote>\n<p>No it's fine by me, thanks!</p>",
        "id": 560911763,
        "sender_full_name": "Etienne Marion",
        "timestamp": 1764419765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560735331\">said</a>:</p>\n<blockquote>\n<p>I just encountered a case of unexpected rebuilding: adding a <code>set_option linter.flexible false in</code> to a lemma causes a rebuild. Is this to be expected? (That linter is a syntax linter, hence does not/should not affect the generated proofs.)</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> I tried removing one of the linter lines and nothing else was rebuilt.</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>git<span class=\"w\"> </span>diff\n<span class=\"go\">diff --git a/Mathlib/Analysis/Complex/Arg.lean b/Mathlib/Analysis/Complex/Arg.lean</span>\n<span class=\"go\">index 29831c3642..153f98f103 100644</span>\n<span class=\"go\">--- a/Mathlib/Analysis/Complex/Arg.lean</span>\n<span class=\"go\">+++ b/Mathlib/Analysis/Complex/Arg.lean</span>\n<span class=\"go\">@@ -31,7 +31,6 @@ variable {x y : ‚ÑÇ}</span>\n<span class=\"go\"> namespace Complex</span>\n\n<span class=\"go\"> -- Non-terminal simp, used to be field_simp</span>\n<span class=\"go\">-set_option linter.flexible false in</span>\n<span class=\"go\"> -- see https://github.com/leanprover-community/mathlib4/issues/29041</span>\n<span class=\"go\"> set_option linter.unusedSimpArgs false in</span>\n<span class=\"go\"> theorem sameRay_iff : SameRay ‚Ñù x y ‚Üî x = 0 ‚à® y = 0 ‚à® x.arg = y.arg := by</span>\n<span class=\"gp\">$ </span>lake<span class=\"w\"> </span>build<span class=\"w\"> </span>-v\n<span class=\"go\">...</span>\n<span class=\"go\">‚ö† [7651/7687] Built Mathlib.Analysis.Complex.Arg (1.2s)</span>\n<span class=\"go\">...</span>\n<span class=\"go\">Build completed successfully (7687 jobs).</span>\n</code></pre></div>",
        "id": 560990742,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764501536
    },
    {
        "content": "<p>Is there any reason that shifting from <code>public import</code>s to <code>import</code>s (where possible) needs to happen from the ground up? I <em>suspect</em> not, but I would like confirmation about this.</p>",
        "id": 561488140,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1764699291
    },
    {
        "content": "<p>I have done this in a leaf file, making it use a (non-public) <code>import</code> to import a theorem from another file. So no, I don't see a reason this needs to be done from the ground up.</p>",
        "id": 561506869,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764705212
    },
    {
        "content": "<p>I don't see one either</p>",
        "id": 561507358,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1764705380
    },
    {
        "content": "<p>Is there an issue with the deprecated module linter and the new module system?  I'm not getting a warning if I public import a deprecated module but I do get the warning if I remove public.</p>",
        "id": 561825752,
        "sender_full_name": "Alastair Irving",
        "timestamp": 1764839145
    },
    {
        "content": "<p>Probably. :-)</p>",
        "id": 561826935,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1764839478
    },
    {
        "content": "<p>PR: <a href=\"https://github.com/leanprover-community/mathlib4/pull/32422\">https://github.com/leanprover-community/mathlib4/pull/32422</a></p>",
        "id": 561829845,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1764840326
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/560751782\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> Do you have a reproducer?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> As I just told you in person, my attempts at finding a minimal reproducer failed (in that lake indeed rebuild very little \\o/). I believe my original reproducer was on <a href=\"https://github.com/leanprover-community/mathlib4/pull/28962\">#28962</a>:</p>\n<ul>\n<li>checkout e.g. <a href=\"https://github.com/leanprover-community/mathlib4/pull/28962/commits/9bd0a0c4c1a6d7202a934880ded7bf61aa52d9c6\">9bd0a0c4c1a6d7202a934880ded7bf61aa52d9c6</a></li>\n<li>apply the next commit <a href=\"https://github.com/leanprover-community/mathlib4/pull/28962/commits/6e64ea345f5b4d342280a9c1e0d66778b9a0d711\">6e64ea345f5b4d342280a9c1e0d66778b9a0d711</a>,</li>\n<li>verify that lean actually rebuilds things.</li>\n</ul>",
        "id": 562649834,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765276899
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> Cannot reproduce.</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span>9bd0a0c4c1a6d7202a934880ded7bf61aa52d9c6\n<span class=\"gp\">$ </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>--repo<span class=\"o\">=</span>grunweg/mathlib4<span class=\"w\"> </span>get\n<span class=\"gp\">$ </span>git<span class=\"w\"> </span>checkout<span class=\"w\"> </span>6e64ea345f5b4d342280a9c1e0d66778b9a0d711<span class=\"w\"> </span>Mathlib/Analysis/Fourier/\n<span class=\"gp\">$ </span>lake<span class=\"w\"> </span>build<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>cat\n<span class=\"go\">‚úî [7646/7668] Built Mathlib.Analysis.Fourier.FourierTransformDeriv (13s)</span>\n<span class=\"go\">Build completed successfully (7668 jobs).</span>\n</code></pre></div>",
        "id": 562658438,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1765279310
    },
    {
        "content": "<p>I see. Let me check again later and see if I can reproduce it myself. Sorry that this is so hard.</p>",
        "id": 562662221,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765280616
    },
    {
        "content": "<p>I might finally have realised that this is about: let me take <a href=\"https://github.com/leanprover-community/mathlib4/pull/32724\">#32724</a> as an example. Building locally, I indeed see Lean doing no work --- but the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20164775471/job/57885446238?pr=32724\">CI workflow run</a> does a lot of work. Is that indicative of something mathlib CI should fix?</p>",
        "id": 563450578,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765538443
    },
    {
        "content": "<p>Ah, that makes sense. I think there was some previous discussion and also the future <code>lake cache</code> would change this anyway, but for now I would suggest CI to instead/also fetch the cache for a <code>push</code> event's <code>before</code> commit. I assume that would enable reuse in most cases.</p>",
        "id": 563452000,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1765538906
    },
    {
        "content": "<p>Makes sense, thanks! <span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span> do you know how difficult it would be to make this change?</p>",
        "id": 563452931,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765539235
    },
    {
        "content": "<p>If we just have to checkout the parent commit and then run <code>lake exe cache get</code> on that instead / in addition, it shouldn't be too hard: we can probably add a few lines <a href=\"https://github.com/leanprover-community/mathlib4/blob/8d3520ad1f44b6f95aff22e74804ca48efceb1d0/.github/build.in.yml#L308\">here</a>? Happy to review a PR, otherwise I'll take a look at it when I can.</p>",
        "id": 563471237,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1765545312
    },
    {
        "content": "<p>I created <a href=\"https://github.com/leanprover-community/mathlib4/pull/33044\">#33044</a> for this.</p>",
        "id": 564483897,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766070377
    },
    {
        "content": "<p>How often do you think it happens that people push multiple commits at once? There is also a field for the commit before the push in the event data as mentioned</p>",
        "id": 564485659,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1766070774
    },
    {
        "content": "<p>Then again that doesn't help either if people e.g. push multiple times in quick succession</p>",
        "id": 564485990,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1766070842
    },
    {
        "content": "<p>I do often push mutiple commits in a single push, with the purpose of labelling the changes more clearly.</p>",
        "id": 564486571,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1766070972
    },
    {
        "content": "<p>I've switched to using <code>github.event.before</code> when it exists (falling back to <code>HEAD^</code> otherwise).</p>",
        "id": 564489224,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766071574
    },
    {
        "content": "<p>I often push multiple commits at once because I don't want to overload the build runners when I'm in intermediate stages of a project (and I don't rebase before pushing because we squash-merge PRs to Mathlib anyway).</p>",
        "id": 564522861,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1766079516
    },
    {
        "content": "<p>I have opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/32541\">#32541</a> as a way to start a discussion about basic tactic files: should those be re-exported by all files since they are basic, or should they instead be explicitly imported by the few files that actually need them?</p>",
        "id": 564647354,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1766134727
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558159080\">said</a>:</p>\n<blockquote>\n<ul>\n<li>There's preliminary documentation at <a href=\"https://lean-lang.org/doc/reference/latest/The-Module-System/\">https://lean-lang.org/doc/reference/latest/The-Module-System/</a>. Please read this first!</li>\n</ul>\n</blockquote>\n<p>Here's the new link: <a href=\"https://lean-lang.org/doc/reference/latest/Source-Files-and-Modules/\">https://lean-lang.org/doc/reference/latest/Source-Files-and-Modules/</a>.</p>\n<p>Can I specify the version of the Lean toolchain for the reference manual?</p>",
        "id": 565094808,
        "sender_full_name": "Bulhwi Cha",
        "timestamp": 1766461425
    },
    {
        "content": "<p>Sure: <a href=\"https://lean-lang.org/doc/reference/4.27.0-rc1/Source-Files-and-Modules/\">https://lean-lang.org/doc/reference/4.27.0-rc1/Source-Files-and-Modules/</a></p>",
        "id": 565187674,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1766509212
    },
    {
        "content": "<p>It'd be nice if we could choose the version of the docs on the sidebar.</p>",
        "id": 565243828,
        "sender_full_name": "Bulhwi Cha",
        "timestamp": 1766553517
    },
    {
        "content": "<p>FYI a possible module system bug/bugs <a class=\"message-link\" href=\"/#narrow/channel/113489-new-members/topic/Strange.20module.20system.20sorries/near/569146824\">#new members &gt; Strange module system sorries @ üí¨</a></p>",
        "id": 569151317,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768956012
    },
    {
        "content": "<p>Is it possible to have a section private (typical use-case: a mathlib file is mostly public and the few private theorems and definitions happen somewhere in the middle in one section)? The following code seems to indicate that it is not possible</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">section</span>\n\n<span class=\"kn\">private</span>\n<span class=\"kn\">section</span>\n\n<span class=\"kn\">end</span>\n\n<span class=\"kn\">end</span>\n</code></pre></div>",
        "id": 570671731,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1769639170
    },
    {
        "content": "<p>Also somewhat related: it is a bit confusing that a proof in term mode flags as a problem and you have to use <code>by exact</code> or something to get into tactic mode</p>",
        "id": 570671921,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1769639256
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"412682\">Moritz Doll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/570671731\">said</a>:</p>\n<blockquote>\n<p>Is it possible to have a section private (typical use-case: a mathlib file is mostly public and the few private theorems and definitions happen somewhere in the middle in one section)?</p>\n</blockquote>\n<p>Perhaps open an issue on this one. </p>\n<p>But I think it may actually cause more harm than it is worth, by encouraging people to write files where it is hard to decipher what is public and what is private.</p>\n<p>The best solution to this is just to not write <code>public section</code>, and instead just put <code>public</code> everywhere you want it. Takes more time to write, but is better for the reader as the information is local. (And, as a side effect, puts slight pressure on the writer to omit <code>public</code>!)</p>",
        "id": 570673125,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769639828
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558491896\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558266690\">said</a>:</p>\n<blockquote>\n<p>Do we have opinions on whether import statements should be sorted by private vs public first, then alphabetically, or just alphabetically?</p>\n</blockquote>\n<p>I now have the opinion that public and private imports should be separated, with the public ones coming first, and sorted alphabetically within each, ie</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">module</span>\n\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">A</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">C</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">B</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">D</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Would someone like to open an issue requesting this?</p>",
        "id": 570674215,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769640359
    },
    {
        "content": "<p>Requesting this in shake or as a linter or both?</p>",
        "id": 570675428,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1769640995
    },
    {
        "content": "<p>I think requesting it in <code>shake</code>.</p>",
        "id": 570675470,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769641019
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/570673125\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"412682\">Moritz Doll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/570671731\">said</a>:</p>\n<blockquote>\n<p>Is it possible to have a section private (typical use-case: a mathlib file is mostly public and the few private theorems and definitions happen somewhere in the middle in one section)?</p>\n</blockquote>\n<p>Perhaps open an issue on this one. </p>\n<p>But I think it may actually cause more harm than it is worth, by encouraging people to write files where it is hard to decipher what is public and what is private.</p>\n<p>The best solution to this is just to not write <code>public section</code>, and instead just put <code>public</code> everywhere you want it. Takes more time to write, but is better for the reader as the information is local. (And, as a side effect, puts slight pressure on the writer to omit <code>public</code>!)</p>\n</blockquote>\n<p>I agree that it can be easily abused, but that should not be an argument against having the feature.<br>\nI don't think that making a whole mathlib file private will happen from that, rather people not bothering with having private theorems. In most mathlib files I know you want the vast majority of theorems to be public and only a handful could be private, so the easy solution is to make everything public.</p>\n<p><a href=\"https://github.com/leanprover/lean4/pull/12222\">lean4#12222</a></p>",
        "id": 570677215,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1769641994
    },
    {
        "content": "<p>I agree with Kim, adding this mental complexity is not remotely worth it for avoiding writing out a keyword for \"a handful\" of declarations</p>",
        "id": 570721017,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1769671953
    },
    {
        "content": "<p>I also agree with Kim. Code gets really messy when you have the ability to both turn on and turn off a global option at a whim.</p>",
        "id": 570725099,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1769673484
    },
    {
        "content": "<p>With regard to sorting imports alphabetically, this may have performance implications, so I am skeptical about linting against it.</p>",
        "id": 570767694,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769685517
    },
    {
        "content": "<p>Some time ago, I produced a PR that sorted imports alphabetically systematically and the overall performance decreased and some files just broke down in a way that I was no longer able to fix, unless the imports were reverted to a specific order.</p>",
        "id": 570767938,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769685588
    },
    {
        "content": "<p>I believe that PR of yours would have just gone through had \"tactics\" been named \"actics\" instead</p>",
        "id": 570883251,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1769716369
    },
    {
        "content": "<p>is it good to put tactics imports first?</p>",
        "id": 570884631,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769716830
    },
    {
        "content": "<p>That is my experience, yes</p>",
        "id": 570885282,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1769717064
    },
    {
        "content": "<p>That's interesting. Why is this? Do they come with some initializers that process the environment so far or something?</p>",
        "id": 570885812,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1769717242
    },
    {
        "content": "<p>Could the problem have been the order of type class search or simp lemmas?</p>",
        "id": 570887446,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1769717852
    },
    {
        "content": "<p>Definitely some of the breakage was due to timeouts that were almost certainly due to typeclass searches.</p>",
        "id": 570901516,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769723344
    },
    {
        "content": "<p>I think that there was another breakage that I never tracked down, though.</p>",
        "id": 570901546,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769723361
    },
    {
        "content": "<p>It was in a tactic file.</p>",
        "id": 570901572,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769723370
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/6763\">#6763</a></p>",
        "id": 570902333,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1769723683
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/570674215\">said</a>:</p>\n<blockquote>\n<p>Would someone like to open an issue requesting this?</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover/lean4/pull/12252\">lean#12252</a></p>",
        "id": 571053313,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1769785613
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558159080\">said</a>:</p>\n<blockquote>\n<ul>\n<li>There's preliminary documentation at <a href=\"https://lean-lang.org/doc/reference/latest/The-Module-System/\">https://lean-lang.org/doc/reference/latest/The-Module-System/</a>. Please read this first!</li>\n</ul>\n</blockquote>\n<p>The link is dead. The new one seems to be <a href=\"https://lean-lang.org/doc/reference/latest/Source-Files-and-Modules/#module-scopes\">https://lean-lang.org/doc/reference/latest/Source-Files-and-Modules/#module-scopes</a>. Can you update?</p>",
        "id": 571265935,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1769932491
    },
    {
        "content": "<p>There are several gaps in the docs. I can already spot:</p>\n<ol>\n<li><code>@[no_expose]</code> isn't documented</li>\n<li>What <code>@[expose]</code>/<code>@[no_expose]</code> does to an <code>abbrev</code>. <code>instance</code>, <code>structure</code>, <code>class</code>. In particular, what the default exposition is for each of these</li>\n</ol>",
        "id": 571266270,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1769932867
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/571265935\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/558159080\">said</a>:</p>\n<blockquote>\n<ul>\n<li>There's preliminary documentation at <a href=\"https://lean-lang.org/doc/reference/latest/The-Module-System/\">https://lean-lang.org/doc/reference/latest/The-Module-System/</a>. Please read this first!</li>\n</ul>\n</blockquote>\n<p>The link is dead. The new one seems to be <a href=\"https://lean-lang.org/doc/reference/latest/Source-Files-and-Modules/#module-scopes\">https://lean-lang.org/doc/reference/latest/Source-Files-and-Modules/#module-scopes</a>. Can you update?</p>\n</blockquote>\n<p>Sorry, what is it you'd like me to update? I can't work out the context here.</p>",
        "id": 571320501,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769984840
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Mathlib.20has.20moved.20to.20the.20new.20module.20system/near/571266270\">said</a>:</p>\n<blockquote>\n<p>There are several gaps in the docs. I can already spot:</p>\n<ol>\n<li><code>@[no_expose]</code> isn't documented</li>\n<li>What <code>@[expose]</code>/<code>@[no_expose]</code> does to an <code>abbrev</code>. <code>instance</code>, <code>structure</code>, <code>class</code>. In particular, what the default exposition is for each of these</li>\n</ol>\n</blockquote>\n<p>Could you please open issues for these?</p>",
        "id": 571320510,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769984851
    },
    {
        "content": "<p>Will open issues. The context is the announcement of yours that started this topic (I keep on going back to it, and I am probably not the only one)</p>",
        "id": 571322707,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1769987091
    }
]