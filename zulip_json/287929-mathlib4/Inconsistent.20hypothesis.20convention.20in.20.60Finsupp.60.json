[
    {
        "content": "<p>Let's say you want to simplify <code>(fun₀ | 0 =&gt; x | 1 =&gt; y) n</code> in the case where you know <code>1 &lt; n</code>. Let me take you through the simplifcation chain.</p>\n<p>First, Lean uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Finsupp/Single.html#Finsupp.coe_update\">Finsupp.coe_update</a> to bring the goal to <code>Function.update (⇑fun₀ | 0 =&gt; x) 1 y n</code>.</p>\n<p>Then Lean reduces using <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Logic/Function/Basic.html#Function.update_of_ne\">Function.update_of_ne</a>, which takes the hypothesis <code>n ≠ 1</code>.</p>\n<p>Finally, Lean reduces using <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Finsupp/Single.html#Finsupp.single_eq_of_ne\">Finsupp.single_eq_of_ne</a>, which takes the hypothesis <code>0 ≠ n</code>.</p>\n<p>So the call has to be something like <code>simp [show 0 ≠ i ∧ i ≠ 1 by omega]</code>. Getting the inequalities the wrong way around means the proof breaks.</p>\n<p>So, the question: I want to change these to have the same hypothesis direction. Do we want <code>n ≠ 0</code> or <code>0 ≠ n</code>?</p>",
        "id": 535940539,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756085766
    },
    {
        "content": "<p><code>n ≠ ...</code> seems to me like the obvious choice</p>",
        "id": 535951691,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1756096490
    },
    {
        "content": "<p>The inconsistency comes back to the RHS of <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Finsupp/Single.html#Finsupp.single_apply\">Finsupp.single_apply</a>, which reads<br>\n<code>(single a b) a' = if a = a' then b else 0</code>, having the condition <code>a = a'</code> the wrong way around relative to the actual definition of <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Finsupp/Single.html#Finsupp.single\">Finsupp.single</a>.</p>\n<p>And indeed, the proof of this lemma has a tell-tale <code>eq_comm</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">single_apply</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">classical</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">eq_comm</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">single</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">single_apply</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>But wait, why do we need <code>simp_rw</code>? And what's up with that highly specific <code>Decidable</code> instance in our noncomputable <code>Finsupp</code> theory?</p>\n<p>Well, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Prelude.html#ite\">ite</a> requires its condition to be decidable. If we just write the \"corrected\" proof naively, this leads to an issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">single_apply</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">classical</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">single</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">single_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n\n<span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"ss\">`rfl</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">ite</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">definitionally</span><span class=\"w\"> </span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">ite</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>So why doesn't the existing proof run into this problem? Well, the <code>eq_comm</code> creates a classical instance to decide <code>a = a'</code>! That's also why we need <code>simp_rw</code>: otherwise we get a \"motive isn't type correct\" error.</p>",
        "id": 536146382,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756178733
    },
    {
        "content": "<p>At least I know now why nobody else has tried to clean up this inconsistency yet..<br>\nPR coming soon, we'll see if anyone wants to touch it <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span></p>",
        "id": 536146434,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756178767
    },
    {
        "content": "<p>By the way, I propose removing the <code>Decidable</code> instance</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">single_apply</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">haveI</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">    </span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">classical</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">single</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">single_apply</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>(which is what the definition of <code>Finsupp.apply</code> already does).</p>",
        "id": 536146624,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756178888
    },
    {
        "content": "<p>This is bad, because you've effectively specialised the RHS to <code>Classical.dec</code> instead of an arbitrary <code>Decidable (a' = a)</code> instance</p>",
        "id": 536162314,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1756187562
    },
    {
        "content": "<p>I think this lemma is intended to match <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Pi.single_apply#doc\">docs#Pi.single_apply</a></p>",
        "id": 536173985,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756192727
    },
    {
        "content": "<p>It looks like it doesn't though, so indeed we could flip the arguments</p>",
        "id": 536174076,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756192765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Inconsistent.20hypothesis.20convention.20in.20.60Finsupp.60/near/536162314\">said</a>:</p>\n<blockquote>\n<p>This is bad, because you've effectively specialised the RHS to <code>Classical.dec</code> instead of an arbitrary <code>Decidable (a' = a)</code> instance</p>\n</blockquote>\n<p>Sure. The existing proof still only goes through for nonsense reasons. Do you know how to actually fix it?</p>",
        "id": 536195931,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756200784
    },
    {
        "content": "<p>Put back the decidable instance?</p>",
        "id": 536196765,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756200958
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Inconsistent.20hypothesis.20convention.20in.20.60Finsupp.60/near/536146382\">said</a>:</p>\n<blockquote>\n<p>If we just write the \"corrected\" proof naively, this leads to an issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">single_apply</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">classical</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">single</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">single_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- error</span>\n\n<span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"ss\">`rfl</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">left</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">ite</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Classical</span><span class=\"bp\">.</span><span class=\"n\">decEq</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">definitionally</span><span class=\"w\"> </span><span class=\"n\">equal</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"bp\">-</span><span class=\"n\">hand</span><span class=\"w\"> </span><span class=\"n\">side</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">ite</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n</blockquote>\n<p>That leads to this issue. I guess I could <code>simp_rw</code> with <code>eq_comm</code> twice, but I wanted to know the real fix.</p>",
        "id": 536197075,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756201022
    },
    {
        "content": "<p>Find and squash the classical instance which has been inserted in the proof?</p>",
        "id": 536199166,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756201535
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Inconsistent.20hypothesis.20convention.20in.20.60Finsupp.60/near/536199166\">said</a>:</p>\n<blockquote>\n<p>Find and squash the classical instance which has been inserted in the proof?</p>\n</blockquote>\n<p>There <em>has</em> to be a classical instance inserted in the proof - the definition of <code>single_apply</code> uses a classical instance for its <code>ite</code>! This lemma is effectively a generalisation.</p>",
        "id": 536199542,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756201659
    },
    {
        "content": "<p><code>convert Pi.single_apply ..</code> or even <code>convert rfl</code> should work as the full proof</p>",
        "id": 536199645,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1756201688
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">single_apply</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">classical</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">single</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Pi</span><span class=\"bp\">.</span><span class=\"n\">single_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">congr</span>\n</code></pre></div>\n<p><span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 536226370,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756211662
    },
    {
        "content": "<p>Is there a reason we can't have both?</p>",
        "id": 536244781,
        "sender_full_name": "Dexin Zhang",
        "timestamp": 1756216972
    },
    {
        "content": "<p>No, but I think the preferred one should be the one that matches the definition and also the intuitive usage. I want to move <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Finsupp/Single.html#Finsupp.single_eq_of_ne\">Finsupp.single_eq_of_ne</a> to <code>Finsupp.single_eq_of_ne'</code>, by analogy to <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Notation/Pi/Basic.html#Pi.single_eq_of_ne'\">Pi.single_eq_of_ne'</a>, but I do think <code>single_apply</code> should be the thing I wrote and not the thing it currently is.</p>",
        "id": 536245251,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756217114
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/29006\">#29006</a></p>",
        "id": 536452239,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756310282
    },
    {
        "content": "<p>Didn't touch <code>single_apply</code> yet, only <code>single_eq_of_ne</code></p>",
        "id": 536452364,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1756310319
    }
]