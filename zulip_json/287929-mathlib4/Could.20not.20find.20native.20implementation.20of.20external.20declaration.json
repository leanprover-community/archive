[
    {
        "content": "<p>In the compilation of <a href=\"https://github.com/leanprover-community/mathlib4/pull/35830\">#35830</a>, we get the following <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/22466069783/job/65072222544?pr=35830#step:42:72\">error message</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Nat</span><span class=\"bp\">/</span><span class=\"n\">Choose</span><span class=\"bp\">/</span><span class=\"n\">Plurinomial</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">132</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">external</span><span class=\"w\"> </span><span class=\"n\">declaration</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Multiset</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"bp\">._</span><span class=\"n\">redArg'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_mathlib_Multiset_filter___redArg___boxed'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">lp_mathlib_Multiset_filter___redArg'</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n\n<span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">declarations</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"ss\">`Init</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"ss\">`Std</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"ss\">`Lean</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">need</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"ss\">`supportInterpreter</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">relevant</span><span class=\"w\"> </span><span class=\"ss\">`lean_exe</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">statement</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"ss\">`lakefile.lean</span><span class=\"bp\">`.</span>\n\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">exited</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>which I don't understand and do not know how to address.<br>\nThank you in advance for any help!</p>",
        "id": 576220272,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1772186341
    },
    {
        "content": "<p>Does it help to mark things as <code>noncomputable</code>?</p>",
        "id": 576221548,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1772186682
    },
    {
        "content": "<p>I can try, but it should be computable because it is. Moreover it compiles at home, so that's really something involving CI.</p>",
        "id": 576221848,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1772186765
    },
    {
        "content": "<p>Does <code>lake build</code> work for you?</p>\n<p>I expect this is something like: the <code>induction</code> tactic makes a term that doesn't get picked up correctly by the compiler, compared to hand-written induction. And then when we want to link everything together in one big Mathlib library, the expected output of the compiler is missing some bits.</p>",
        "id": 576222266,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1772186887
    },
    {
        "content": "<p>I would say this is reportable as a Lean bug: at the very least the error message should be clearer.</p>",
        "id": 576222356,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1772186921
    },
    {
        "content": "<p>Yeah, you'd need to <code>meta import</code> to have the code available at build time, i.e.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">meta</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Choose</span><span class=\"bp\">.</span><span class=\"n\">Multinomial</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Choose</span><span class=\"bp\">.</span><span class=\"n\">Multinomial</span>\n<span class=\"n\">public</span><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">ToFinsupp</span>\n</code></pre></div>\n<p>but presumably you don't want that <code>#eval</code> to stick around so you should be able to instead just remove it. I agree though that there should be a better error message that indicates this has to do with the meta separation.</p>",
        "id": 576224779,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772187731
    },
    {
        "content": "<p>Removing the <code>#eval</code>line (that was just an example) was enough, thank you!</p>",
        "id": 576234286,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1772190665
    },
    {
        "content": "<p>Your messages suggest that during CI or when one orders <code>lake build</code>, the compiler is in a different state than when it compiles the given open file. Is that somewhat true?</p>",
        "id": 576234487,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1772190737
    },
    {
        "content": "<p>Yeah, I think the language server loads compiled IR for more functions than the build does (to reduce build dependencies). In particular, <code>#eval</code> in the language server is (almost) unconstrainted but during build it is limited to <code>meta import</code>ed functions or actual <code>meta</code> functions.</p>",
        "id": 576249297,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1772195615
    }
]