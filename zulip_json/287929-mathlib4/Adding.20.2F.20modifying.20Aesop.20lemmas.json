[
    {
        "content": "<p>After working on top of Mathlib for a while, I have some ideas for how to improve what is tagged as a lemma for Aesop, to make automation easier.</p>\n<p>Is there any particular process to go through for discussing changes to Aesop tagging? Or should I just make a PR and see what happens?</p>",
        "id": 490535739,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734967118
    },
    {
        "content": "<p>Making a PR is certainly an option. But if you feel like you can write down some concise guidelines, that might be much more valuable.</p>",
        "id": 490537107,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734967665
    },
    {
        "content": "<p>Because that will help us review similar PRs in the future. And it could be a basis on which we could start a crowdsourced project to aesopify much more of mathlib.</p>",
        "id": 490537217,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734967707
    },
    {
        "content": "<p>I haven't got anything too general, just a couple of observations.</p>\n<p>(1) Lemmas like <code>add_mem</code> and  <code>mul_mem</code> lemmas should be tagged <code>unsafe 90%</code> rather than <code>safe</code>: if all you have is <code>AddZeroClass</code> or whatever, then you're always going to want to apply them, but the more complicated structures I'm working with have lemmas like <code>mul_self_mem</code>.</p>\n<p>(2) I want to add some automation for proving \"obvious\" <code>IsSquare</code> results like <code>IsSquare x -&gt; IsSquare (x * (y * y))</code>, similar to the <code>SetLike</code> automation described in (1).</p>",
        "id": 490538333,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734968147
    },
    {
        "content": "<p>I suppose the reason more stuff isn't tagged with Aesop is running time concerns. Is there an easy way for me to audit this in case I'm trying out some new Aesop tags?</p>",
        "id": 490538622,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734968261
    },
    {
        "content": "<p>If you make a PR, you can comment with <code>!bench</code> and that will show if performance regresses.</p>",
        "id": 490538744,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734968303
    },
    {
        "content": "<p>But I think there is a more mundane reason that \"more stuff isn't tagged with Aesop\": there were a million lines of mathlib before Aesop was born. Who is going to <span aria-label=\"detective\" class=\"emoji emoji-1f575\" role=\"img\" title=\"detective\">:detective:</span> through all of those, and mark suitable results with <code>@[aesop]</code>?</p>",
        "id": 490538879,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734968363
    },
    {
        "content": "<p>That needs a community effort. And such a community effort needs someone to take the lead.</p>",
        "id": 490538954,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734968398
    },
    {
        "content": "<p>Just didn't happen yet.</p>",
        "id": 490539006,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734968404
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/490538879\">said</a>:</p>\n<blockquote>\n<p>But I think there is a more mundane reason that \"more stuff isn't tagged with Aesop\": there were a million lines of mathlib before Aesop was born. Who is going to <span aria-label=\"detective\" class=\"emoji emoji-1f575\" role=\"img\" title=\"detective\">:detective:</span> through all of those, and mark suitable results with <code>@[aesop]</code>?</p>\n</blockquote>\n<p>Yeah for sure<br>\nBut if I tagged every lemma I found locally useful into global Aesop, eg <code>Set.Nonempty.some_mem</code>, then there would surely be a performance drop across Mathlib as a whole.</p>",
        "id": 490540036,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734968847
    },
    {
        "content": "<p>I would be happy to do some work around Aesop for membership of algebraic structures -- that's something where just tagging everything with <code>simp</code> doesn't work well and Aesop has a lot of potential ime</p>",
        "id": 490540176,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1734968901
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/490540036\">said</a>:</p>\n<blockquote>\n<p>But if I tagged every lemma I found locally useful into global Aesop, eg <code>Set.Nonempty.some_mem</code>, then there would surely be a performance drop across Mathlib as a whole.</p>\n</blockquote>\n<p>Honestly, the fact that <code>Fintype.card_ofIsEmpty</code> and <code>Fintype.card_ofSubsingleton</code> have <code>@[simp]</code> on them is quite inconvenient for me. Should there be a category for \"this can be a <code>simp</code> lemma but I don't want <code>aesop</code> to use it\" ?</p>",
        "id": 490653831,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1735032759
    },
    {
        "content": "<p>hmm<br>\nI think that would be a bit weird, because lemmas you want Aesop to use generally expect simp normal form as input right?<br>\nwhat sort of context do those lemmas cause issues in?<br>\n(btw I have no idea how familiar you are with Aesop, but, in case you don't know, you can write <code>aesop (erase simp &lt;rule&gt;)</code> for one-off cases)</p>",
        "id": 490662395,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1735037935
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"417654\">@Martin Dvořák</span> if those are inconvenient <code>simp</code> lemmas, it suggests there is something else wrong with your approach, not that those shouldn't be marked <code>simp</code>.</p>",
        "id": 490711872,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1735071999
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/490711872\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"417654\">Martin Dvořák</span> if those are inconvenient <code>simp</code> lemmas, it suggests there is something else wrong with your approach, not that those shouldn't be marked <code>simp</code>.</p>\n</blockquote>\n<p>I minimized the code from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/TU.20block.20matrix.20.2319607\">#mathlib4 &gt; TU block matrix #19607</a> and the result exhibits the following behavior depending on whether <code>Fintype.card_ofIsEmpty</code> and <code>Fintype.card_ofSubsingleton</code> have <code>@[simp]</code> on them.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card_ofIsEmpty</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card_ofSubsingleton</span><span class=\"w\"> </span><span class=\"c1\">-- try commenting this line</span>\n\n<span class=\"c1\">--count_heartbeats in -- 12718 vs 74031</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">⊕</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">eX</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">eY</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">fst</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">snd</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">sumCongr</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span>\n\n<span class=\"c1\">--count_heartbeats in -- 2128 vs 4826</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eX</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eY</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">sumCongr</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span>\n\n<span class=\"c1\">--count_heartbeats in -- no difference</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eX</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eY</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">sumCongr</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span>\n</code></pre></div>",
        "id": 491402512,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1735650469
    },
    {
        "content": "<p>Can you narrow it down to just a <code>simp</code> call that exhibits the difference, as opposed to <code>aesop</code>?</p>",
        "id": 491417567,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1735661655
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/491417567\">said</a>:</p>\n<blockquote>\n<p>Can you narrow it down to just a <code>simp</code> call that exhibits the difference, as opposed to <code>aesop</code>?</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">simp</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card_ofIsEmpty</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card_ofSubsingleton</span><span class=\"w\"> </span><span class=\"c1\">-- try commenting this line</span>\n\n<span class=\"c1\">--count_heartbeats in -- 297 vs 752</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eX</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"n\">X'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">eY</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"n\">Y'</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≃</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Sum</span><span class=\"bp\">.</span><span class=\"n\">elim</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">∘</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">sumCongr</span><span class=\"w\"> </span><span class=\"n\">eX</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"n\">eY</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">comp_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Equiv</span><span class=\"bp\">.</span><span class=\"n\">sumCongr_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">inl</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"c1\">-- here</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">inr</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 491419533,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1735662924
    },
    {
        "content": "<p>For practical purposes, the difference in a single <code>simp</code> evaluation is not the problem.<br>\nHowever, <code>aesop</code> can reach over million heartbeats in nontrivial examples, which is annoying.</p>",
        "id": 491420245,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1735663391
    },
    {
        "content": "<p>Hmmm.... looking at the trace of the <code>simp</code> call, you can see repeated attempts to try and unify the <code>Fintype</code> instances with <code>Fintype.ofSubsingleton</code> and <code>Fintype.ofIsEmpty</code>, which obviously fail. It seems that they are not cached, but I'm not sure why. <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> do you know why this would be the case? This may need to be minimized further and posted in <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4\">#lean4</a>, as it seems quite suspicious to me.</p>",
        "id": 491948118,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736065406
    },
    {
        "content": "<p>looking at the position of <code>Fintype.card X'</code> (as the argument to <code>Fin</code>), I'm wondering if this could be caused by some <code>no_index</code>ing of some <code>simp</code> lemmas for <code>Fin _</code>. (Maybe this is far off base)</p>",
        "id": 491948673,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736066010
    },
    {
        "content": "<p>Either way, <span class=\"user-mention\" data-user-id=\"417654\">@Martin Dvořák</span> since these lemmas are about these <code>Fintype.ofSubsingleton</code> and <code>Fintype.ofIsEmpty</code> instances (I didn't realize this when you first posted about them, my bad), I'm betting Mathlib would build without <code>@[simp]</code>  on these lemmas. Do you want to try, and then benchmark the resulting PR?</p>",
        "id": 491949014,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736066350
    },
    {
        "content": "<p>Is there a way of seeing what lemmas are in a particular Aesop ruleset? Say, SetLike? I know I can do a syntactic library search, but I'm wondering if there is something I can extract from the actual Aesop tactic.</p>",
        "id": 491973778,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736089513
    },
    {
        "content": "<p>I have made a PR with some first, tentative changes to specifically the SetLike ruleset: <a href=\"https://github.com/leanprover-community/mathlib4/pull/20477\">#20477</a></p>",
        "id": 491995251,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736108310
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> do you have thoughts on this? ^</p>",
        "id": 491995267,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736108329
    },
    {
        "content": "<p>OK, here is a weird thing I found:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Hom</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Subsemigroup</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">mul_mem</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"mi\">90</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rule_sets</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"o\">])]</span><span class=\"w\"> </span><span class=\"n\">mul_mem</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test_1</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→*</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsemigroup</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop?</span><span class=\"w\"> </span><span class=\"c1\">-- finds proof</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">mul_mem</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rule_sets</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"o\">])]</span><span class=\"w\"> </span><span class=\"n\">mul_mem</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test_2</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→*</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsemigroup</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop?</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">mul_mem</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">aesop</span><span class=\"w\"> </span><span class=\"n\">safe</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rule_sets</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SetLike</span><span class=\"o\">])]</span><span class=\"w\"> </span><span class=\"n\">mul_mem</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test_3</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→*</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsemigroup</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop?</span><span class=\"w\"> </span><span class=\"c1\">-- finds proof</span>\n</code></pre></div>",
        "id": 492153591,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736185971
    },
    {
        "content": "<p>I would expect that increasing the priority of an <code>unsafe</code> Aesop rule brings its behaviour monotonically closer to that rule being <code>safe</code>, but this does not appear to be the case. The example above is minimised from one of two examples of this behaviour I came across in practice. I'm not sure exactly where the spurious <code>mul_mem</code> calls are coming from, but it's to do with the presence of the hypothesis <code>hy</code>: without it, Aesop succeeds in all cases.</p>",
        "id": 492154022,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736186102
    },
    {
        "content": "<p>I think Aesop is somehow looping <code>mul_mem</code> indefinitely, but surely if that is the case then the <code>safe</code> version should fail too?</p>",
        "id": 492155317,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736186506
    },
    {
        "content": "<p>I'm tempted to say that you shouldn't be asking <code>aesop</code> to supply witnesses for you, <em>especially</em> when there are multiple choices in context.</p>",
        "id": 492156229,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736186831
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/492156229\">said</a>:</p>\n<blockquote>\n<p>I'm tempted to say that you should be asking <code>aesop</code> to supply witnesses for you, <em>especially</em> when there are multiple choices in context.</p>\n</blockquote>\n<p>(Shouldn't, presumably)<br>\nYes, I was surprised the proof worked in the first place! But now I want to try to figure out why this change makes it stop working.</p>",
        "id": 492156404,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736186896
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/492156404\">said</a>:</p>\n<blockquote>\n<p>(Shouldn't, presumably)</p>\n</blockquote>\n<p>edited</p>",
        "id": 492156575,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736186953
    },
    {
        "content": "<p>My thought, perhaps unfounded, is that <code>aesop</code> tries to supply <code>y * y⁻¹</code> as the witness at some point? Thus invoking <code>mul_mem</code>. Have you enabled the trace?</p>",
        "id": 492156624,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736186973
    },
    {
        "content": "<p>Ah! Aesop applies a 10%  priority penalty to <code>safe</code> rules that introduce new metavariables (eg in filling an existential), but not to <code>unsafe</code> rules that do the same. The traces of <code>test_1</code> and <code>test_3</code> are identical!<br>\nPerhaps this behaviour should be made uniform across <code>safe</code> and <code>unsafe</code> rules?</p>\n<p>edit: <a href=\"https://github.com/leanprover-community/aesop?tab=readme-ov-file#handling-metavariables\">here's the documentation</a></p>",
        "id": 492158043,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736187551
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> I've thought before that <code>Fintype.card_ofSubsingleton</code> seemed like a sketchy <code>@[simp]</code> lemma. It's sort of ok because it's only for <code>Fintype.ofSubsingleton</code>, which thankfully isn't an instance, but it's going to try being applied to all <code>Fintype.card</code> expressions, which we can check with <code>#discr_tree_simp_key</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">discr_tree_simp_key</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"bp\">.</span><span class=\"n\">card_ofSubsingleton</span>\n<span class=\"c1\">-- Fintype.card _ _</span>\n</code></pre></div>",
        "id": 492158119,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736187586
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 492158127,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736187588
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span>: I think it's fine to ask Aesop to synthesise a witness here, because it's one of the hypotheses.</p>",
        "id": 492158326,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736187654
    },
    {
        "content": "<p>I disagree, as there are multiple options, but <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span></p>",
        "id": 492158413,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736187696
    },
    {
        "content": "<p>Kyle, that doesn't explain why it's trying to do the same unification repeatedly.</p>",
        "id": 492158576,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736187754
    },
    {
        "content": "<p>The other proof that broke asks for a more complicated witness:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">extracted_1</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">→+*</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Subsemiring</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Surjective</span><span class=\"w\"> </span><span class=\"bp\">⇑</span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">hsupp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">↑</span><span class=\"o\">(</span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">ker</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊆</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">aesop</span>\n</code></pre></div>\n<p>Not fully minimised but you get the idea. I think it's fine for <code>aesop</code> to fail here. The witness is any preimage of <code>f y * f y</code>, but the proof it's in <code>P</code> requires synthesising new terms using <code>add_mem</code> and metavariables.</p>",
        "id": 492158929,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736187901
    },
    {
        "content": "<p>I think likely nothing will break if we remove the <code>simp</code> attribute from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Fintype.card_ofSubsingleton#doc\">docs#Fintype.card_ofSubsingleton</a>, but I still want to know why the same unification problem appears a bunch of times in the <code>simp</code> trace.</p>",
        "id": 492160891,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736188685
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/492158043\">said</a>:</p>\n<blockquote>\n<p>Ah! Aesop applies a 10%  priority penalty to <code>safe</code> rules that introduce new metavariables (eg in filling an existential), but not to <code>unsafe</code> rules that do the same. The traces of <code>test_1</code> and <code>test_3</code> are identical!<br>\nPerhaps this behaviour should be made uniform across <code>safe</code> and <code>unsafe</code> rules?</p>\n<p>edit: <a href=\"https://github.com/leanprover-community/aesop?tab=readme-ov-file#handling-metavariables\">here's the documentation</a></p>\n</blockquote>\n<p>The other conclusion to draw is that perhaps no <code>unsafe</code> rule should be given &gt;90% success probability. 99% success probability increases decay time for a loop by a factor of ~10 vs 90%.</p>",
        "id": 492161738,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736188992
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> I'm not too familiar with isDefEq caching, but I know that if there are metavariables (or if there's a non-default configuration), then it uses a \"transient\" cache. There are definitely metavariables in this particular isDefEq problem, since the Subsingleton instance hasn't been solved for yet.</p>",
        "id": 492162572,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1736189281
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 492162672,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736189306
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20524\">#20524</a></p>",
        "id": 492164996,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736190158
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/491995251\">said</a>:</p>\n<blockquote>\n<p>I have made a PR with some first, tentative changes to specifically the SetLike ruleset</p>\n</blockquote>\n<p>I've made another, independent, PR reworking the automation for <code>Even</code> / <code>IsSquare</code>: <a href=\"https://github.com/leanprover-community/mathlib4/pull/20558\">#20558</a></p>\n<p>Any thoughts very welcome <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 492398920,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736288971
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> has suggested adding a library note describing the principles I'm following in <a href=\"https://github.com/leanprover-community/mathlib4/pull/20477\">#20477</a>. Where should this go? Perhaps in <code>Algebra/HeirarchyDesign</code>?</p>",
        "id": 492585355,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736370842
    },
    {
        "content": "<p>Seems reasonable! That document is pretty old, but maybe adding more to it will encourage others to update it!</p>",
        "id": 492608071,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736383111
    },
    {
        "content": "<p>I'd like to mention the fact that because that file is not imported, <code>#help note</code> never finds it... Is this something we care about?</p>",
        "id": 492627527,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736395850
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/492627527\">said</a>:</p>\n<blockquote>\n<p>I'd like to mention the fact that because that file is not imported, <code>#help note</code> never finds it... Is this something we care about?</p>\n</blockquote>\n<p>Just came across this with <code>[reducible non_instances]</code>. It feels like certain operations should be able to (syntactically) see all of Mathlib..</p>",
        "id": 493580841,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736859727
    },
    {
        "content": "<p>Should we import the hierarchy design file in <code>Mathlib.Init</code> maybe?</p>",
        "id": 493583900,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1736860759
    },
    {
        "content": "<p>either that, or seperately in every file which mentions the notes in the design file?</p>",
        "id": 493585364,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736861253
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/493585364\">said</a>:</p>\n<blockquote>\n<p>either that, or seperately in every file which mentions the notes in the design file?</p>\n</blockquote>\n<p>this doesn't feel maintainable when new files are added</p>",
        "id": 493594604,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1736864023
    },
    {
        "content": "<p>Finally getting to this, sorry for the delay.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/491973778\">said</a>:</p>\n<blockquote>\n<p>Is there a way of seeing what lemmas are in a particular Aesop ruleset? Say, SetLike?</p>\n</blockquote>\n<p><code>#aesop_rules SetLike</code> will show you  the rules in the <code>SetLike</code> rule set. <code>#aesop_rules</code> by itself will show you the rules in all available rule sets.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Adding.20.2F.20modifying.20Aesop.20lemmas/near/492158043\">said</a>:</p>\n<blockquote>\n<p>Ah! Aesop applies a 10%  priority penalty to <code>safe</code> rules that introduce new metavariables (eg in filling an existential), but not to <code>unsafe</code> rules that do the same. The traces of <code>test_1</code> and <code>test_3</code> are identical!<br>\nPerhaps this behaviour should be made uniform across <code>safe</code> and <code>unsafe</code> rules?</p>\n</blockquote>\n<p>This sounds very reasonable. <a href=\"https://github.com/leanprover-community/aesop/pull/191\">aesop#191</a></p>\n<p>I'll look at the <code>SetLike</code> PR. Thank you very much for your efforts, <span class=\"user-mention\" data-user-id=\"400289\">@Artie Khovanov</span>!</p>",
        "id": 495099529,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1737477737
    },
    {
        "content": "<p>Reviewed the PR.</p>",
        "id": 495103872,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1737478914
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span> what do you think of the pattern <code>@[simp, aesop safe apply]</code>, to maintain metavariable capabilities?<br>\nI had tried just changing all <code>aesop safe apply</code> in the ruleset <code>SetLike</code> to <code>simp</code>, but a couple of proofs broke because they were using <code>aesop</code> rules to fill \"obvious\" existentials (in both cases, nonemptiness assertions).</p>",
        "id": 495114910,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1737482427
    },
    {
        "content": "<p>Ah! Very interesting; I hadn't considered this use case. Yes, with metavariables around, <code>simp</code> + <code>aesop safe</code> makes sense.</p>",
        "id": 495118421,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1737483574
    },
    {
        "content": "<p>Could you add a note about this to the design notes (if it isn't already there)?</p>",
        "id": 495118966,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1737483789
    },
    {
        "content": "<p>I'll go back and apply the pattern to all the <code>aesop safe</code> rules that really are safe to apply. I don't think there's a meaningful performance decrease compared to tagging only with <code>simp</code>.</p>",
        "id": 495165926,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1737503078
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> what is the \"SetLike tactic\" mentioned in <code>Mathlib/Tactic/SetLike</code>?</p>",
        "id": 495166717,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1737503504
    },
    {
        "content": "<p>I am very confused. I thought <code>SetLike</code> was an Aesop ruleset?</p>",
        "id": 495166740,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1737503520
    },
    {
        "content": "<p>I was going to make a separate tactic, and then was convinced that it should just be a rule set. If there's reference to a tactic somewhere you can probably remove it. I don't have time to think about it at the moment though. Maybe in a few days.</p>",
        "id": 495170726,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1737505482
    },
    {
        "content": "<p>It's just a reference in some documentation, and I'm writing up full documentation for the SetLike ruleset. I'll invite you to review the PR for when you have a moment; it's not getting merged anytime soon.</p>",
        "id": 495170915,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1737505590
    }
]