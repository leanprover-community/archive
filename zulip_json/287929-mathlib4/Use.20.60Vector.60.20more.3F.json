[
    {
        "content": "<p>Should we use <code>Vector</code> instead of <code>Fin n -&gt; X</code> in more cases? E.g., for matrices?</p>",
        "id": 567043758,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767911261
    },
    {
        "content": "<p>The downside is that we can't use index types other than <code>Fin n</code>, so this may be a bad idea for proofs, even though it's good for computation.</p>",
        "id": 567043902,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767911341
    },
    {
        "content": "<p>Such a coincidence that I was just refactoring my own code to replace <code>Fin n -&gt; X</code> with <code>Vector</code> to get better computability. Though I am not sure about Mathlib itself. I think I still see it mainly as a library for proofs so I probably prefer keeping <code>Fin n -&gt; X</code>? As long as there are enough API to convert between these</p>",
        "id": 567050108,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1767915196
    },
    {
        "content": "<p>btw I just discovered there is no <code>AddMonoid (Vector _ _)</code> even though there is <code>Add (Vector _ _)</code></p>",
        "id": 567051749,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1767916423
    },
    {
        "content": "<p>There is <code>Lean.Grind.AddCommMonoid (Vector α n)</code> though <span aria-label=\"melting face\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melting face\">:melting_face:</span></p>",
        "id": 567051802,
        "sender_full_name": "Weiyi Wang",
        "timestamp": 1767916478
    },
    {
        "content": "<p>Maybe we should have a <code>VectorLike</code> class so that the user can choose whether they want <code>Fin n -&gt; X</code> or <code>Vector n</code>?</p>",
        "id": 567106291,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1767952957
    },
    {
        "content": "<p>A related point: in some places we use the \"Tuple\" namespace, but we don't actually define \"Tuple\" anywhere. I think we could do worse than <em>at the very least</em> defining \"Tuple A n\" as an abbreviation for Fin n -&gt; A.</p>",
        "id": 567136956,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767963729
    },
    {
        "content": "<p>Don't forget we also have <code>List.Vector</code> in mathlib. I wish we didn't, but we do.</p>",
        "id": 567137137,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767963779
    },
    {
        "content": "<p>Having had a good deal of experience with this sort of thing, I do think you want to keep Fin n -&gt; A as that is often a much nicer and natural way to state things (whether under the Fin name or otherwise).</p>",
        "id": 567137251,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767963818
    },
    {
        "content": "<p>I assume when people talk about computability, they don't mean computability so much as performance (Fin n -&gt; A is perfectly computable, it just sometimes has bad performance).</p>",
        "id": 567137538,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767963914
    },
    {
        "content": "<p>(Perhaps more accurately because it is a function Lean does just treat it differently to a Vector which is kind of more of a static block object.)</p>",
        "id": 567137704,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767963961
    },
    {
        "content": "<p>It can especially be useful to use <code>Fin n -&gt; A</code> when using <code>Equiv</code>, I find.</p>",
        "id": 567138406,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767964199
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Use.20.60Vector.60.20more.3F/near/567137538\">said</a>:</p>\n<blockquote>\n<p>I assume when people talk about computability, they don't mean computability so much as performance (Fin n -&gt; A is perfectly computable, it just sometimes has bad performance).</p>\n</blockquote>\n<p>When I said that <code>Vector</code> is good for computation, I meant performance.</p>",
        "id": 567181604,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767976063
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Use.20.60Vector.60.20more.3F/near/567137137\">said</a>:</p>\n<blockquote>\n<p>Don't forget we also have <code>List.Vector</code> in mathlib. I wish we didn't, but we do.</p>\n</blockquote>\n<p>IMHO, we should deprecate it.</p>",
        "id": 567181753,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767976095
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Use.20.60Vector.60.20more.3F/near/567181753\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Use.20.60Vector.60.20more.3F/near/567137137\">said</a>:</p>\n<blockquote>\n<p>Don't forget we also have <code>List.Vector</code> in mathlib. I wish we didn't, but we do.</p>\n</blockquote>\n<p>IMHO, we should deprecate it.</p>\n</blockquote>\n<p>I strongly agree but I do not have the energy or the community clout to make it happen.</p>",
        "id": 567186844,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767977429
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Use.20.60Vector.60.20more.3F/near/567181604\">said</a>:</p>\n<blockquote>\n<p>When I said that <code>Vector</code> is good for computation, I meant performance.</p>\n</blockquote>",
        "id": 567186885,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767977443
    },
    {
        "content": "<p>Yeah I figured you did.</p>",
        "id": 567186915,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1767977451
    },
    {
        "content": "<p>What's the argument for dropping <code>List.Vector</code>?</p>",
        "id": 567191387,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767978772
    },
    {
        "content": "<p>Mathematically, it's the same as <code>Vector</code>, which is in core. If there are computational reasons to have it, then IMHO it belongs in CSLib, not Mathlib.</p>",
        "id": 567191656,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767978871
    },
    {
        "content": "<p>Couldn't the same argument be used to say that <code>List</code> shouldn't exist, only <code>Array</code> should?</p>",
        "id": 567242513,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767984823
    },
    {
        "content": "<p>The main difference is that <code>List</code> already has lots of API &amp; uses in Mathlib.</p>",
        "id": 567242714,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767984887
    },
    {
        "content": "<p>Also, pattern matching defs are nice.</p>",
        "id": 567242752,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767984900
    },
    {
        "content": "<p>I guess I'd claim that the pattern matching argument applies to <code>List.Vector</code> too</p>",
        "id": 567242895,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767984947
    },
    {
        "content": "<p>My opinion is that</p>\n<ul>\n<li>we should choose one of <code>List</code>/<code>Array</code> for Mathlib;</li>\n<li>we should choose one of <code>List.Vector</code>/<code>Vector</code> for Mathlib;</li>\n<li>the choices don't have to match;</li>\n<li>I may prefer <code>Array</code>/<code>Vector</code>, but this may be a side effect of me writing some code in Lean as a programming language.</li>\n</ul>",
        "id": 567243624,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767985188
    },
    {
        "content": "<p>I would be very sad if <code>List</code> gets out of Mathlib: I think almost every formalization project that I have or had use them and their API quite extensively in a way or an other.</p>",
        "id": 567244272,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1767985401
    },
    {
        "content": "<p>On your last point, is this because you've tried to verify your <code>Array</code> code and found that results you need are stated about List instead?</p>",
        "id": 567244349,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767985426
    },
    {
        "content": "<p>Or just because the Array APi is more in your muscle memory?</p>",
        "id": 567244384,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1767985439
    },
    {
        "content": "<p>It's because I've started caring more about performance since I've started writing code in Lean.</p>",
        "id": 567244457,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767985468
    },
    {
        "content": "<p>But I with Mathlib hat on understand that this may not be what we want for proofs in Mathlib, so if there is a vote, then I'm going to abstain.</p>",
        "id": 567244620,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1767985528
    },
    {
        "content": "<p>E.g., I think that some of our code that uses <code>Finset</code>s would become faster if we used <code>Array</code>s. Also, if we had a way to override <code>DecidableEq</code> on <code>Finset</code>s for <code>LinearOrder</code>s to just sort both sides and compare...</p>",
        "id": 567282335,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768006515
    },
    {
        "content": "<p>UPD: I meant, on <code>Multiset</code>s. We can speedup it on <code>Finset</code>s by using something like <code>s = t \\iff s.card = t.card \\and s \\sub t</code> instead of relying on <code>List.isPerm</code>.<br>\nUPD2: the current algorithm is not much worse. It takes elements from LHS one by one, verifies that they're there in the RHS and removes them from there. At least, it runs in a polynomial time.</p>",
        "id": 567282519,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768006635
    },
    {
        "content": "<p>Note: it looks like I don't understand something important about performance in Lean. I've tried to write <code>List.offDiag</code> with lists and arrays, and the array version turned out to be slower.</p>",
        "id": 567285598,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768009991
    },
    {
        "content": "<p>I think some methods like <code>Array.eraseIdx</code> are worse than the <code>List</code> version because the <code>List</code> version only has to change a single pointer, while for <code>Array</code> it needs to move all the next ones</p>",
        "id": 567287912,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1768013111
    },
    {
        "content": "<p>I tried to use <code>Array.ofFn</code> and failed.</p>",
        "id": 567287951,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768013158
    },
    {
        "content": "<p>This is a definition for <code>List</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- List.offDiag l` is the product `l.product l` with the diagonal removed. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">offDiag</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">zipIdx</span><span class=\"bp\">.</span><span class=\"n\">flatMap</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Prod</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">eraseIdx</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>A similar definition for <code>Array</code>s is ~2x worse on <code>List.range 5000</code>, while this one is ~4x worse:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">offDiag</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">mapIdx</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">mapIdx</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">flatten</span><span class=\"bp\">.</span><span class=\"n\">reduceOption</span>\n</code></pre></div>",
        "id": 567288204,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768013448
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Use.20.60Vector.60.20more.3F/near/567282335\">said</a>:</p>\n<blockquote>\n<p>E.g., I think that some of our code that uses <code>Finset</code>s would become faster if we used <code>Array</code>s. Also, if we had a way to override <code>DecidableEq</code> on <code>Finset</code>s for <code>LinearOrder</code>s to just sort both sides and compare...</p>\n</blockquote>\n<p>You want a map to bitvec and back for finsets rather than arrays</p>",
        "id": 567288493,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1768013904
    },
    {
        "content": "<p>Arrays don't guarantee Nodup, and I know a few problems where combining some lean formalisation work with some <code>bv_decide</code> calls might lead to interesting results (despite its downside of expanding the trusted code base).</p>",
        "id": 567288529,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1768013954
    },
    {
        "content": "<p>I think <code>Array.flatten</code> has a similar problem, <code>List.flatMap</code> only needs to update the pointer at the end of each list in the list, while <code>Array.flatten</code> has to copy/resize a lot of data</p>",
        "id": 567288729,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1768014234
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span> how can I test this? <code>#eval (List.range 257).offDiag</code> crashes the Lean server for me</p>\n<p>perhaps</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">offDiag'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"bp\">.</span><span class=\"n\">emptyWithCapacity</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[:</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[:</span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">size</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>\n<p>is more performant but I cannot test</p>",
        "id": 567289360,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1768015120
    },
    {
        "content": "<p>I've tested with <code>#eval (List.range 5000).offDiag.length</code> so that it doesn't have to pretty print a long list.</p>",
        "id": 567289404,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768015180
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 567290335,
        "sender_full_name": "Lua Viana Reis",
        "timestamp": 1768016557
    },
    {
        "content": "<p>Can we please stop discussing matrix-free definitions in this thread? I'm totally fine with this discussion happening in another thread, but it's offtopic for this one.</p>",
        "id": 567323137,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1768054239
    },
    {
        "content": "<p>(moving them) (edit: done. Sorry for contributing to the noise. Now back to your scheduled programming)</p>",
        "id": 567331735,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1768062937
    },
    {
        "content": "<p>Sorry, back to topic. What are the places where <code>List.Vector</code> is currently used, and how reasonable would it be to remove it from them?</p>",
        "id": 567352287,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1768085889
    },
    {
        "content": "<p>Loogle finds a handful of places: Mathlib.Data.Sym.Basic, Mathlib.GroupTheory.Perm.Cycle.Type, Mathlib.Computability.Primrec</p>",
        "id": 567353055,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1768086813
    },
    {
        "content": "<p>IMO we should prefer List.Vector over Vector in mathlib, just like we prefer List over Array. The only downside is that List.Vector API is underdeveloped.</p>",
        "id": 567400753,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1768148879
    }
]