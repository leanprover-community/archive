[
    {
        "content": "<p>Here is the example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">SuccPred</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">⦃</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">⦄,</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact?</span>\n</code></pre></div>\n<p>The output of <code>exact?</code>, when pasted in, gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">typeclass</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">problem</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">stuck</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">often</span><span class=\"w\"> </span><span class=\"n\">due</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">metavariables</span>\n<span class=\"w\">  </span><span class=\"n\">NoMaxOrder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1825</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>What's going on here? What's making exact? produce this weird looking proof term:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SuccAddOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NoMaxOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">        </span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one_iff</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 496874198,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738273430
    },
    {
        "content": "<p>Always do as much <code>intro</code> as you can before <code>exact</code> :-) (not that this is an answer, it's just a workaround/rule of think l thumb). Presumably the answer is that without the <code>intro</code> of the typeclass instances, lean can't find them. But if you intro them, they'll be in the local context so things should work.</p>",
        "id": 496875709,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738274058
    },
    {
        "content": "<p>Indeed doing intro first is what I told the student who came across this! But note that before the intro, the typeclass instances are already present! The intro is only a single implication, no instances or types.</p>",
        "id": 496877639,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738274869
    },
    {
        "content": "<p>More generally, I'm curious why the proof term makes it look like Lean wants to intro a bunch of typeclass assumptions!</p>",
        "id": 496888130,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738279956
    },
    {
        "content": "<p>Try doing <code>set_option pp.funBinderTypes true</code> first. (Likely won't solve the problem, but it'll make the term slightly better.)</p>",
        "id": 496906131,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738290109
    },
    {
        "content": "<p>There's a deeper issue that <code>x</code> and <code>y</code> are implicit, so their values aren't being printed.</p>",
        "id": 496906324,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738290242
    },
    {
        "content": "<p>Indeed that changes it to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SuccAddOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NoMaxOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">        </span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one_iff</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>instead</p>",
        "id": 497013853,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738332221
    },
    {
        "content": "<p>For the sake of comparison, an answer I would have expected here is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">lt_add_one_iff</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hex</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 497013955,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738332243
    },
    {
        "content": "<p>Should I make an issue for this? I can't seem to minimise further, but this seems like a pretty strange <code>exact?</code> output to me</p>",
        "id": 497512453,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738609578
    },
    {
        "content": "<p>Sure, makes sense to make an issue.</p>\n<p>Given what I know about how <code>exact?</code> works I'm not surprised the result looks like this, and it could take some work to address.</p>",
        "id": 497515796,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738610841
    },
    {
        "content": "<p>Can you suggest why the result looks like this? In other cases I've seen <code>exact?</code> work fine when there's an implication to prove, so I'd like to know what's going on in this case that makes it behave weirdly</p>",
        "id": 497516039,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738610929
    },
    {
        "content": "<p>Part of the issue is that the binderinfos aren't being set to explicit when they enter the local context. This causes the pretty printer to not print all of these implicit arguments, which are necessary here.</p>",
        "id": 497516542,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738611107
    },
    {
        "content": "<p>I don't know SolveByElim well enough though to know the exact details</p>",
        "id": 497516959,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738611259
    },
    {
        "content": "<p>Potentially this could be an artifact of how apply works. (Nevermind, can't reproduce it with <code>apply</code>.)</p>",
        "id": 497517552,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738611463
    },
    {
        "content": "<p>Does this also explain why <code>α</code> is getting reverted?</p>",
        "id": 497518459,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738611823
    },
    {
        "content": "<p>Here's another example of the same form (by the same student), where doing more <code>intro</code> first doesn't help</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">asdf</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact?</span>\n</code></pre></div>\n<p>The output of <code>exact?</code> here is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Group</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">conj_eq_one_iff</span><span class=\"bp\">.</span><span class=\"n\">mpr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>which also doesn't work.</p>",
        "id": 498125708,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738849989
    },
    {
        "content": "<p>(I did tell them to use <code>rw?</code> instead, but the failure of <code>exact?</code> still seems weird!)</p>",
        "id": 498125799,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738850014
    },
    {
        "content": "<p>removing the <code>fun {...} [...] {...}=&gt;</code> seems to fix it</p>",
        "id": 498126875,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738850320
    },
    {
        "content": "<p>i.e. yes, <code>exact?</code> produces weird output, but it's not complete nonsense</p>",
        "id": 498127030,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738850371
    },
    {
        "content": "<p>and it's an easy fix</p>",
        "id": 498127314,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738850431
    },
    {
        "content": "<p>I think the \"weird output\" was the bug report, yeah</p>",
        "id": 498127384,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738850451
    },
    {
        "content": "<p>i don't think \"weird output\" was the issue tho? the issue is <em>output which doesn't work</em></p>",
        "id": 498127588,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738850504
    },
    {
        "content": "<p>Right, the issue is that the output doesn't work, which is really annoying for a self-replacing tactic, and frustrating to beginners.</p>",
        "id": 498128945,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738850883
    },
    {
        "content": "<p>Sure, but the example in the OP is fixable in the exact same way you propose here</p>",
        "id": 498128964,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738850886
    },
    {
        "content": "<p>I perhaps should have clarified that a self-replacing code action replacing itself with an error is undesirable behaviour to me.</p>",
        "id": 498129112,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738850933
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Output.20of.20exact.3F.20gives.20metavariables.20error/near/498127314\">said</a>:</p>\n<blockquote>\n<p>and it's an easy fix</p>\n</blockquote>\n<p>It's an easy fix to you and to me, but not to people new to Lean!</p>",
        "id": 498129431,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738851012
    },
    {
        "content": "<p>right... so, reformulating the issue, <code>exact?</code> produces a term which explicitly writes a function with only implicit arguments, leading to a metavariable error...</p>",
        "id": 498129964,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738851168
    },
    {
        "content": "<p>that doesn't sound like a <em>hugely</em> difficult issue</p>",
        "id": 498130210,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738851226
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Output.20of.20exact.3F.20gives.20metavariables.20error/near/498130210\">said</a>:</p>\n<blockquote>\n<p>that doesn't sound like a <em>hugely</em> difficult issue</p>\n</blockquote>\n<p>It doesn't sound like that to me either, but I trust Kyle's judgement above :)</p>",
        "id": 498130987,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738851399
    },
    {
        "content": "<p>I removed the mathlib dependence and reported as <a href=\"https://github.com/leanprover/lean4/pull/6975\">lean4#6975</a></p>",
        "id": 498137737,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738853101
    }
]