[
    {
        "content": "<p>I've noticed that in Mathlib v4.20, <code>rw?</code> tactic returns some strange results when operating on hypotheses, as shown in the image:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">a</span><span class=\"bp\">^</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">^</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"n\">rw?</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p><a href=\"/user_uploads/3121/pPXQUT2lewi4uaA_jtdC95Bh/image.png\">image.png</a><br>\n Why is this?</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/pPXQUT2lewi4uaA_jtdC95Bh/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1134x936\" src=\"/user_uploads/thumbnail/3121/pPXQUT2lewi4uaA_jtdC95Bh/image.png/840x560.webp\"></a></div>",
        "id": 517490817,
        "sender_full_name": "张守信(Shouxin Zhang)",
        "timestamp": 1747044454
    },
    {
        "content": "<p>I also noticed that there were no problems when applying <code>rw?</code> to the goal, because it uses <code>rw [@xxx]</code> as usual, instead of <code>rw [xxx]</code>.</p>",
        "id": 517491902,
        "sender_full_name": "张守信(Shouxin Zhang)",
        "timestamp": 1747044679
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> I also met this error last week, but forgot to report it.</p>",
        "id": 517512893,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1747049691
    },
    {
        "content": "<p>also happens in apply? The fix is usually that one is applying the wrong side of the equality or the wrong direction of an iff lemma</p>",
        "id": 517542040,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747055859
    },
    {
        "content": "<p>or some typeclass instance is missing</p>",
        "id": 517542126,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747055877
    },
    {
        "content": "<p>Shreyas, the issue is that <code>rw?</code> reports non-existing issues. In Shouxin’s example, you can type <code>rw [Mathlib.Tactic.Zify.natCast_eq] at h</code> and everything works.</p>",
        "id": 517554016,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1747058062
    },
    {
        "content": "<p>Not sure when/if I'll get to this, if someone would like to diagnose / propose a fix that would be great.</p>",
        "id": 517799781,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1747134586
    },
    {
        "content": "<p>Found another example </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hnpos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">show_term</span><span class=\"w\"> </span><span class=\"n\">omega</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span>\n<span class=\"cm\">  found a proof, but the corresponding tactic failed:</span>\n<span class=\"cm\">  (expose_names; exact Decidable.byContradiction fun a =&gt; _example._proof_1 d hnpos a)</span>\n\n<span class=\"cm\">  It may be possible to correct this proof by adding type annotations, explicitly specifying implicit arguments, or eliminating unnecessary function abstractions.</span>\n<span class=\"cm\">  -/</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hnpos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">omega</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 518488515,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747385510
    },
    {
        "content": "<p>Well that one is reasonable I guess because it <em>actually</em> doesn't work</p>",
        "id": 518492866,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1747386637
    },
    {
        "content": "<p>omega does work</p>",
        "id": 518493609,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747386852
    },
    {
        "content": "<p>yes I mean <code>(expose_names; exact Decidable.byContradiction fun a =&gt; _example._proof_1 d hnpos a)</code> doesn't work like it claims</p>",
        "id": 518493672,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1747386878
    },
    {
        "content": "<p><code>show_term &lt;tactic&gt;</code> is supposed to show a term suggestion</p>",
        "id": 518493793,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747386916
    },
    {
        "content": "<p>if a tactic works then its <code>show_term</code> suggestion also works</p>",
        "id": 518493875,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747386938
    },
    {
        "content": "<p>Yes, not a tactic suggestion. <code>omega</code> elaborated to <code>Decidable.byContradiction fun a =&gt; _example._proof_1 d hnpos a</code> so that's what it suggests</p>",
        "id": 518493934,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1747386959
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/rw.3F.20is.20behaving.20strangely.20in.20Mathlib.20v4.2E20.20-rc5/near/518493875\">said</a>:</p>\n<blockquote>\n<p>if a tactic works then its <code>show_term</code> suggestion also works</p>\n</blockquote>\n<p>This has never been the case, though, except in the simplest cases.</p>",
        "id": 518494016,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1747386975
    },
    {
        "content": "<p>I have never seen it fail before. But I have also never seen it claim that it cannot produce a term</p>",
        "id": 518494309,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747387075
    },
    {
        "content": "<p>instead of showing a suggestion</p>",
        "id": 518494405,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1747387094
    },
    {
        "content": "<p>It can produce a term, <code>Decidable.byContradiction fun a =&gt; _example._proof_1 d hnpos a</code> (you can also get it using <code>by?</code>), but that term uses a theorem that <code>omega</code> introduces (<code>_example._proof_1</code>) so it doesn't work without it. This also happens often with <code>simp</code></p>",
        "id": 518549241,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1747403146
    }
]