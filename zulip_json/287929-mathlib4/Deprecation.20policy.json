[
    {
        "content": "<p>In the past weeks, the question of a deprecation policy for mathlib has come up a few times. I think it would be helpful to make a formal decision, to simplify guidance for future PR authors. Let me suggest a first draft, based on what I took away from discussions so far.</p>",
        "id": 436691955,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1714655933
    },
    {
        "content": "<h2>Mathlib deprecation policy</h2>\n<p><strong>This policy applies to</strong> all items in mathlib tagged with the <code>@deprecated</code> attribute. This can be aliasses, but also definitions, theorems and lemmas.</p>\n<p><strong>Deprecating items.</strong> When deprecating a new item, please add the current date (to allow removing it in the future).<br>\nSince Lean 4.8, the @deprecated attribute allows including a date in the <code>since</code> field (as a string of the form <code>2024-04-01</code>).<br>\nSome existing items have no deprecation date; PRs adding them are welcome. </p>\n<p><strong>Please deprecate when renaming.</strong> When renaming a definition or theorem, please create an <code>alias</code> for the old name and mark it with <code>deprecated</code>. This step can be skipped when the declaration is very new (say, less than one week).<br>\nThere is no need to create aliasses for renaming instances. <br>\nFor automatically generated declarations (e.g. by <code>to_additive</code> or <code>simps</code>), please ensure the generated declaration is also tagged with this attribute. </p>\n<p><strong>Removing deprecated items.</strong><br>\nDeprecated items can be removed from mathlib after &lt;time&gt; after their initial deprecation date. PRs doing so are welcome.</p>",
        "id": 436692029,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1714655949
    },
    {
        "content": "<p>I would appreciate comments on e.g the following questions:</p>\n<ul>\n<li>Any general comments about this? Missing aspects?</li>\n<li>Time-frame for skipping a deprecation.</li>\n<li>Are there other cases of generated declarations which could be deprecated? I've only seen this with <code>to_additive</code> (added: and <code>simps</code>) so far.</li>\n<li>Time-frame when items can be removed is up for discussion. (So far, I gather that \"a year\" is considered plenty and \"six months\" considered sufficient by some, but at least \"three months\" seems to be desired. But that is probably not a representative sample/will have overheard some!)</li>\n</ul>\n<p>If/once there's broad consensus, we could e.g. have a poll on the last question (which is perhaps the most controversial).</p>",
        "id": 436692083,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1714655967
    },
    {
        "content": "<p>Currently in mathlib,</p>\n<ul>\n<li>some declarations generated by <code>to_additive</code> are missing this attribute (update: it seems there is only one offender, fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/12597\">#12597</a>),</li>\n<li>not all deprecated declarations are tagged with a date (my WIP branch <a href=\"https://github.com/leanprover-community/mathlib4/tree/MR-deprecation-dates-all\">branch#MR-deprecation-dates-all</a> makes some progress on this; some PRs for this are open for review)</li>\n<li>deprecation dates are using doc comments; I presume PRs converting this to the <code>since</code> field are welcome</li>\n</ul>",
        "id": 436692435,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1714656052
    },
    {
        "content": "<p>My personal opinion (but I'm not a maintainer, so no need to weigh it highly): I think at least four months could be useful. In practice, deprecation dates are usually the date when the PR is filed, and merging it can take a while (especially with big refactoring PRs). A four months policy ensures the deprecation will be on mathlib for at least three months.</p>",
        "id": 436692990,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1714656183
    },
    {
        "content": "<p>Quick note, I think <code>simps</code> also generates candidates</p>",
        "id": 436697741,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1714657498
    },
    {
        "content": "<p>Did we end up recommending that people update mathlib on the lean release cadence? If so, we could use <em>x</em> of those as a cutoff</p>",
        "id": 436706640,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1714659868
    },
    {
        "content": "<p>I would say 1 year max and 1 stable release minimum, and for things in the middle we try to keep them if it's not an undue amount of work</p>",
        "id": 436728166,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1714666008
    },
    {
        "content": "<p>(I have nothing to add, but this is great to see discussed/given attention to!)</p>",
        "id": 436728954,
        "sender_full_name": "Julian Berman",
        "timestamp": 1714666250
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20policy/near/436692990\">said</a>:</p>\n<blockquote>\n<p>My personal opinion (but I'm not a maintainer, so no need to weigh it highly): I think at least four months could be useful. In practice, deprecation dates are usually the date when the PR is filed, and merging it can take a while (especially with big refactoring PRs). A four months policy ensures the deprecation will be on mathlib for at least three months.</p>\n</blockquote>\n<p>I think deprecation dates should reflect when they actually landed in mathlib, not when the deprecation was proposed. We may be able to do this more effectively by having PRs not put a date and then having a bot automatically add dates to unadorned deprecations directly on master</p>",
        "id": 436729787,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1714666522
    },
    {
        "content": "<p>Stupid consideration: What about the 100 chars line limit?</p>",
        "id": 436729923,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1714666563
    },
    {
        "content": "<p>try to leave enough space?</p>",
        "id": 436730068,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1714666611
    },
    {
        "content": "<p>the bot would probably fail and ping someone to help</p>",
        "id": 436730111,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1714666626
    },
    {
        "content": "<p>I would be fine not mandating deprecations for lemmas generated by <code>simps</code>:</p>\n<ul>\n<li>They are generally not typed manually (though they could appear in <code>simp only</code> calls</li>\n<li>It's very hard to have a lemma generated by <code>simps</code> in your code without the original definition, and the <code>simps</code> lemma should change very predictably. (assuming the only change is renaming the <code>def</code>.)</li>\n</ul>",
        "id": 436744276,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1714671549
    },
    {
        "content": "<p>Our policy should probably say something about renaming <code>X</code> to <code>Y</code> and in the same PR renaming <code>W</code> to <code>X</code>. E.g.:</p>\n<blockquote>\n<p>We allow but discourage contributors to rename declaration <code>X</code> to <code>Y</code> and at the same time renaming <code>W</code> to <code>X</code>. In this case, no deprecation attribute is required for <code>X</code> (but it is for <code>W</code>).</p>\n</blockquote>\n<p>But maybe we should have a better solution for this case? <br>\nE.g. a line in the docstring of (the new) <code>X</code> of the form \"On &lt;date&gt; <code>X</code> was renamed to <code>Y</code>.\"</p>",
        "id": 436745139,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1714671840
    },
    {
        "content": "<p>Random thought: instead of recording the \"date\" when a decl was deprecated, we record the PR number... Tooling can figure out the date on which a PR landed. Much less hassle for users.</p>",
        "id": 436765654,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1714679294
    },
    {
        "content": "<p>That means tying the deprecation notice to a git repo, which we might not want to do sine the deprecation system is supposed to be used across the Lean ecosystem</p>",
        "id": 436765907,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1714679396
    },
    {
        "content": "<p>Lean is intrinsically connected to both git and github in several places. I don't think this is an issue</p>",
        "id": 436767010,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1714679811
    },
    {
        "content": "<p>In any case this is a mathlib-local decision. You can put <code>(since := \"#12345\")</code> if you want and lean won't care</p>",
        "id": 436767145,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1714679875
    },
    {
        "content": "<p>About deprecating stuff: I’m bumping MIL and I just met the effect of a line of Mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">deprecated</span><span class=\"kd\">]</span> <span class=\"n\">alias</span> <span class=\"n\">op_norm_le_of_shell</span> <span class=\"o\">:=</span> <span class=\"n\">opNorm_le_of_shell</span>\n</code></pre></div>",
        "id": 436770224,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1714681086
    },
    {
        "content": "<p>with the associated code action. It’s really great!</p>",
        "id": 436770265,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1714681112
    },
    {
        "content": "<p>Of course we can still dream of a command line tool doing all those renames for us. But this is already infinitely nicer than getting an error and searching the changelog website (and I don’t even mention the situation before the changelog).</p>",
        "id": 436770407,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1714681182
    },
    {
        "content": "<p>Is there a possibility to skip the deletion time period for aliases to lemmas that already see little to no use? Or at least make it shorter, e.g. 1 month.</p>",
        "id": 463275646,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724033222
    },
    {
        "content": "<p>I find it's generally the untested stuff that's inconvenient or suboptimal</p>",
        "id": 463276313,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724033696
    },
    {
        "content": "<p>At an absolute minimum, every <code>@[deprecated]</code> attribute should survive at least to the next time we move Mathlib to a new stable version of Lean and update the <code>stable</code> tag.</p>",
        "id": 463278849,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724035393
    },
    {
        "content": "<p>Why is it hard to keep an alias for a longer time? Are you making 2 refactors one after another?</p>",
        "id": 463306510,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1724044601
    },
    {
        "content": "<p>If it's just \"cluttering your file\", then please be patient and leave things in place for several months. You don't need to remember to do the cleanup yourself --- eventually we'll get this semiautomated.</p>",
        "id": 463326365,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724051607
    },
    {
        "content": "<p>If you want to reduce imports, it's fine to move deprecations to another file.</p>",
        "id": 463326454,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724051627
    },
    {
        "content": "<p>So generally I think the only reason to do really fast deprecations is when you need to reuse an existing deprecated name.</p>",
        "id": 463326641,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724051652
    },
    {
        "content": "<p>A few people use Mathlib to teach courses on Lean and these are, very often, run once a year.</p>\n<p>For this kind of schedule, a \"deprecation period\" of at least 9 months, and preferably at least one year seems very useful.</p>",
        "id": 463328147,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724052003
    },
    {
        "content": "<p>For instance, the repository that I used for the module that I taught last October is on a Mathlib version from October (or at the very latest November).  In a couple of weeks, I will start looking at updating it for the new academic year and if I have deprecations in place for the last year to help with the upgrade, I will be very happy!</p>",
        "id": 463328153,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724052006
    },
    {
        "content": "<p>Alright then. I guess there isn't really any hurry.</p>",
        "id": 463329298,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724052314
    },
    {
        "content": "<p>I guess I hadn't considered people outside of Mathlib might be using my code</p>",
        "id": 463329574,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1724052387
    },
    {
        "content": "<p>I would however strongly encourage doc-gen to let us filter out deprecated lemmas. It's currently very hard to read the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.eLpNorm#doc\">docs#MeasureTheory.eLpNorm</a> API because (precisely) half the lemmas are deprecated</p>",
        "id": 463332506,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724052920
    },
    {
        "content": "<p>Deprecation warnings are primarily for code outside mathlib - you're already fixing the code inside mathlib anyway</p>",
        "id": 463338076,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1724054265
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20policy/near/463332506\">said</a>:</p>\n<blockquote>\n<p>I would however strongly encourage doc-gen to let us filter out deprecated lemmas. It's currently very hard to read the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.eLpNorm#doc\">docs#MeasureTheory.eLpNorm</a> API because (precisely) half the lemmas are deprecated</p>\n</blockquote>\n<p>Disagree with this. Non mathlib savvy users need to know a definition exists but has been deprecated. A notice on the definition is better than the definition disappearing altogether. There are several ways a user could end up at a definition including neural net search tools that are not retrained on every stable release</p>",
        "id": 463349230,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724057446
    },
    {
        "content": "<p>They should be flagged more clearly, though</p>",
        "id": 463349800,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1724057616
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20policy/near/463349800\">said</a>:</p>\n<blockquote>\n<p>They should be flagged more clearly, though</p>\n</blockquote>\n<p>they could be sorted and colour coded, both on the main content div and the side panel listing. Maybe even in the search results</p>",
        "id": 463349936,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724057661
    },
    {
        "content": "<p>And maybe we could add a checkbox in the UI to hide them, for people who prefer that</p>",
        "id": 463350003,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1724057686
    },
    {
        "content": "<p>sure. My main suggestion is : As long as a definition exists and can be found by search engines, it must show up in the docs and redirect users to the replacement.</p>",
        "id": 463350204,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724057727
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20policy/near/463349230\">said</a>:</p>\n<blockquote>\n<p>Disagree with this. Non mathlib savvy users need to know a definition exists but has been deprecated.</p>\n</blockquote>\n<p>I'm talking about \"letting us filter\" not \"filtering for us\"</p>",
        "id": 463352181,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724058355
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20policy/near/463332506\">said</a>:</p>\n<blockquote>\n<p>I would however strongly encourage doc-gen to let us filter out deprecated lemmas. It's currently very hard to read the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.eLpNorm#doc\">docs#MeasureTheory.eLpNorm</a> API because (precisely) half the lemmas are deprecated</p>\n</blockquote>\n<p>As a quick solution you can use this userscript:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"c1\">// ==UserScript==</span>\n<span class=\"c1\">// @name         Lean Docs Remove Deprecated</span>\n<span class=\"c1\">// @namespace    http://tampermonkey.net/</span>\n<span class=\"c1\">// @version      2024-08-19</span>\n<span class=\"c1\">// @description  try to take over the world!</span>\n<span class=\"c1\">// @author       You</span>\n<span class=\"c1\">// @match        https://leanprover-community.github.io/mathlib4_docs/**</span>\n<span class=\"c1\">// @icon         https://www.google.com/s2/favicons?sz=64&amp;domain=github.io</span>\n<span class=\"c1\">// @grant        none</span>\n<span class=\"c1\">// ==/UserScript==</span>\n\n<span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"s1\">'use strict'</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s1\">'.decl'</span><span class=\"p\">).</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">x</span><span class=\"w\"> </span><span class=\"p\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">x</span><span class=\"p\">.</span><span class=\"nx\">querySelector</span><span class=\"p\">(</span><span class=\"s1\">'.attributes'</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"nx\">innerText</span><span class=\"o\">?</span><span class=\"p\">.</span><span class=\"nx\">includes</span><span class=\"p\">(</span><span class=\"s1\">'deprecated'</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"nx\">x</span><span class=\"p\">.</span><span class=\"nx\">remove</span><span class=\"p\">());</span>\n<span class=\"p\">})();</span>\n</code></pre></div>",
        "id": 463359218,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1724060500
    },
    {
        "content": "<p>I think it's also reasonable for files that are badly cluttered with deprecations to simply move all the deprecations into a separate file (even under <code>Deprecated/</code>). They will still show up in the docs, but quarantined away from all the \"live\" stuff.</p>",
        "id": 463375969,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1724066184
    },
    {
        "content": "<p>That makes a lot of sense actually. Even just the bottom of the file would be better than \"inline\"</p>",
        "id": 463376870,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724066445
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20policy/near/463375969\">said</a>:</p>\n<blockquote>\n<p>I think it's also reasonable for files that are badly cluttered with deprecations to simply move all the deprecations into a separate file (even under <code>Deprecated/</code>). They will still show up in the docs, but quarantined away from all the \"live\" stuff.</p>\n</blockquote>\n<p>how will they be linked to by moogle?</p>",
        "id": 463380433,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1724067862
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Deprecation.20policy/near/463375969\">said</a>:</p>\n<blockquote>\n<p>I think it's also reasonable for files that are badly cluttered with deprecations to simply move all the deprecations into a separate file (even under <code>Deprecated/</code>). They will still show up in the docs, but quarantined away from all the \"live\" stuff.</p>\n</blockquote>\n<p>This has the effect of causing downstream code (or rebased code in mathlib branches) that doesn't <code>import Mathlib</code> to report \"name <code>foo</code> not found\" instead of \"<code>foo</code> is deprecated\".</p>",
        "id": 463380635,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724067946
    },
    {
        "content": "<p>Is there automatic removal of deprecated names?<br>\nAlso, what is the policy on wholesale refactoring that goes beyond renaming / editing the proof? Must the old version be kept?</p>",
        "id": 465505182,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1724777436
    },
    {
        "content": "<p>No. ?_. No.</p>",
        "id": 465506063,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724777603
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/20541\">#20541</a> I am moving a bunch of lemmas that were renamed in July. To avoid cluttering the diff, I deleted the deprecated aliases at the same time. Are people happy with this?</p>",
        "id": 492314936,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1736258359
    },
    {
        "content": "<p>Won't that have the opposite effect, cluttering the output of the github action declaration diff and furthermore making the blocks of deleted and included code even more different?</p>",
        "id": 492315748,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1736258626
    },
    {
        "content": "<p>I think it would be better to delete the deprecated aliases in their own pr</p>",
        "id": 492319105,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736259857
    },
    {
        "content": "<p>I think the policy says that's fine for you to do as long as the PR deprecating them was actually merged and not just opened in July</p>",
        "id": 492319172,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736259891
    },
    {
        "content": "<p>Which is of course very annoying to check for every decl. So we need better tooling there, but I'm not exactly sure how it should work.</p>",
        "id": 492348798,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1736268919
    },
    {
        "content": "<p>Maybe it can use git blame?</p>",
        "id": 492348819,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1736268926
    },
    {
        "content": "<p>I think it should work by looking at the environment in a previous release</p>",
        "id": 492351582,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736269872
    },
    {
        "content": "<p>Arguably it's also fine to delete lemmas without a deprecation if they never made it into a release</p>",
        "id": 492351604,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736269886
    },
    {
        "content": "<p>I disagree on that - that just makes life harder for people who update more frequently if they end up using anything new. We should be deprecating much more consistently, not less</p>",
        "id": 492353781,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1736270708
    },
    {
        "content": "<p>I think for deleting deprecated aliases we should go solely off the <code>since</code> date. It's up to the maintainer doing the merging in the PR introducing them to say: \"you added these deprecations 2 months ago, that's not recent enough, please update the date: bors d+\"</p>",
        "id": 492355101,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736271202
    },
    {
        "content": "<p>Maybe we should have <code>deprecated (pending_since := \"2025-01-07\")</code>, and a nightly job that replaces all such markers with <code>since := \"current date\"</code>?</p>",
        "id": 492356310,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736271665
    },
    {
        "content": "<p>Or even just <code>deprecated (since := pending-date)</code> in the PR, which avoids the need for any human thought about dates at all</p>",
        "id": 492356849,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736271853
    },
    {
        "content": "<p>(<code>pending-date</code> is the same length as <code>\"YYYY-MM-DD\"</code> so avoids any line wrapping issues\")</p>",
        "id": 492356899,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736271873
    },
    {
        "content": "<p>The other complexity that this introduces is that the nightly job has to run before a release is cut</p>",
        "id": 492356987,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1736271908
    },
    {
        "content": "<p>(if we can avoid PRs rotting for months, then it doesn't matter anyway <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span> I realize this isn't <em>quite</em> a fix as sometimes PRs can exist for a long time naturally.)</p>",
        "id": 492357237,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736271988
    },
    {
        "content": "<p>Is there a special label for renaming PRs? Should there be one? (Should such PRs be prioritised?)</p>",
        "id": 492357349,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1736272040
    },
    {
        "content": "<p>What about a GitHub bot which scans a PR before merging (just with grep, nothing fancy) and flags if the deprecations are older than, say, 2 weeks? I imagine this would fix 90+% of the issues, even if it weren't perfect. It would avoid the need for a maintainer to think, and it would prevent <code>pending-date</code> cruft from appearing on <code>master</code>.</p>",
        "id": 492357681,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736272195
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Deprecation.20policy/near/492357349\">said</a>:</p>\n<blockquote>\n<p>Is there a special label for renaming PRs? Should there be one? (Should such PRs be prioritised?)</p>\n</blockquote>\n<p>The problem is that renaming happens outside of \"renaming PRs\" (i.e., outside of PRs which <em>solely</em> perform renames).</p>",
        "id": 492357808,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736272241
    },
    {
        "content": "<p>And I don't think we should be in a rush to merge renaming PRs unless there is already consensus, as this can lead to hasty renames which cause further headaches. In cases where there is consensus and the PR touches many files, it often gets posted in the speedy review thread anyway.</p>",
        "id": 492358088,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1736272344
    },
    {
        "content": "<p>i think using <code>pending-date</code> is a feasable pattern... manually inserting a date pre-merging only makes it harder to automatically update the deprecations, since you'd need to go through the diff to decide if it was or wasn't there previously.</p>",
        "id": 492359091,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736272734
    },
    {
        "content": "<p>as for what triggers replacement, i feel like it should be possible to have bors do this replacement while pushing to <code>staging</code>, but i'm not familiar enough with bors to be the judge of that. if it's not happening with bors, we could have a CI trigger from a comment of <code>lock deprecations</code> on the PR...</p>",
        "id": 492359892,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736273003
    },
    {
        "content": "<p>we might then even implement <code>unlock deprecations</code> which looks for a commit by the bot with appropriate header and reverts it!</p>",
        "id": 492360114,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1736273068
    },
    {
        "content": "<p>For the record: this thread seems to have converged, and there's a de facto deprecation policy now. <a href=\"https://github.com/leanprover-community/leanprover-community.github.io/pull/604\">https://github.com/leanprover-community/leanprover-community.github.io/pull/604</a> is documenting that (awaiting-author to incorporate some details; I'll ping this thread when I'd maintainer-merge this).</p>",
        "id": 512028918,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744622529
    },
    {
        "content": "<p>I'd like to propose an addition to this deprecation policy: when a Lean module is removed, a module deprecation should be added. This will notify downstream projects (or mathlib branches) of files moving. Specifics:</p>\n<ul>\n<li>separate PRs: one PR should rename or remove the file (to keep git's diff clean), a follow-up PR should add the module deprecation. These PRs should be merged at the same time, and within the same release.</li>\n<li>specifics: a new deprecated module contains a copyright header and a <code>deprecated_module</code> command, no more</li>\n<li><code>deprecated_module</code>s keep the same removal schedule as for normal deprecations, i.e. six months after the PR is merged.</li>\n</ul>\n<p>The last point is up for discussion.</p>\n<p>See the other thread <a href=\"#narrow/channel/287929-mathlib4/topic/.60Deprecated.60.20folder\">#mathlib4 &gt; &#96;Deprecated&#96; folder</a> for the prior discussion.<br>\nIf there is agreement on this, I can PR this change to the webpage.</p>",
        "id": 512029051,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744622579
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Deprecation.20policy/near/512029051\">said</a>:</p>\n<blockquote>\n<ul>\n<li>specifics: a new deprecated module contains a copyright header and a <code>deprecated_module</code> command, no more</li>\n</ul>\n</blockquote>\n<p>does this mean we do not allow imports which make sure we don't fully pull the rug from under users?</p>",
        "id": 512037673,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744624888
    },
    {
        "content": "<p>I thought the <code>deprecated_module</code> file <em>must</em> have imports, because they are used to generate the replacement suggestion.</p>",
        "id": 512040510,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744625704
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Deprecation.20policy/near/512029051\">said</a>:</p>\n<blockquote>\n<ul>\n<li><code>deprecated_module</code>s keep the same removal schedule as for normal deprecations, i.e. six months after the PR is merged.</li>\n</ul>\n</blockquote>\n<p>And with the same exception as for deprecated declarations: \"and earlier is fine if there is a good reason, but please try to make sure it survives at least <em>one</em> month\".</p>",
        "id": 512040737,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744625766
    },
    {
        "content": "<p>Where \"one month\" really means \"is alive at one tagged release\"?</p>",
        "id": 512041148,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744625890
    },
    {
        "content": "<p>I confirm that <code>deprecated_module</code> uses the imports of the current file to suggest which modules to deprecate to.  So, the structure of a \"deprecated module\" is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">copyright</span>\n<span class=\"n\">imports</span>\n<span class=\"n\">deprecated_module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"s2\">\"yyy-mm-dd\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>except that the header linter will not enforce it.</p>",
        "id": 512041337,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744625963
    },
    {
        "content": "<p>Why would there be a copyright in a deprecated module?</p>",
        "id": 512041412,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744625988
    },
    {
        "content": "<p>I'm not sure about this, I was just going for \"minimal changes wrt the above\"!</p>",
        "id": 512041493,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744626011
    },
    {
        "content": "<p>I would be happy with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">imports</span>\n\n<span class=\"n\">deprecated_module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">since</span><span class=\"w\"> </span><span class=\"s2\">\"yyy-mm-dd\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>and I also would be ok with allowing something more (e.g. a module doc explaining the reason for the file existing, e.g. for doc-gen).</p>",
        "id": 512041640,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744626082
    },
    {
        "content": "<p>For instance, if removing a module is a long term refactor for some reason, the <code>deprecated_module</code> command may get there early, but the file might still contain declarations that are planned to be removed?  I am not sure.</p>",
        "id": 512041957,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744626194
    },
    {
        "content": "<p>Is the syntax really <code>deprecated_module (since \"yyy-mm-dd\")</code> and not <code>deprecated_module (since := \"yyyy-mm-dd\")</code>?</p>",
        "id": 512042136,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744626255
    },
    {
        "content": "<p>The syntax is what is written above, without <code>:=</code>.  Did I mess up copying the <code>@[deprecated]</code> syntax?</p>",
        "id": 512042361,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744626343
    },
    {
        "content": "<p>Yes, it looks like it.  Let me amend this.</p>",
        "id": 512042521,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744626401
    },
    {
        "content": "<p>I'm afraid so <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> The syntax is <code>@[deprecated decl \"message\" (since := \"yyyy-mm-dd\")]</code></p>",
        "id": 512042545,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744626411
    },
    {
        "content": "<p>Ok, <a href=\"https://github.com/leanprover-community/mathlib4/pull/24032\">#24032</a> makes the syntax line up, but it may be that Michael will add my PR to his <a href=\"https://github.com/leanprover-community/mathlib4/pull/24028\">#24028</a>.</p>",
        "id": 512045382,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744627422
    },
    {
        "content": "<p>(Note that my PR is a superset of Michael's, but his came before Yaël noticed the missing <code>:=</code> syntax from <code>deprecated_module</code>.)</p>",
        "id": 512045885,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744627578
    },
    {
        "content": "<p>Thanks for the comments so far. I will include those in a PR with the policy (assuming no further arguments against doing so).</p>",
        "id": 512050143,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744628962
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Deprecation.20policy/near/512029051\">said</a>:</p>\n<blockquote>\n<ul>\n<li>separate PRs: one PR should rename or remove the file (to keep git's diff clean), a follow-up PR should add the module deprecation. These PRs should be merged at the same time, and within the same release.</li>\n</ul>\n</blockquote>\n<p>I agree this is a good idea for git, but this sounds very annoying so I'd hope we can find a better solution. Could we teach lean / lake to either:</p>\n<ul>\n<li>Try <code>Foo.lean.deprecated</code> if it can't find <code>Foo.lean</code></li>\n<li>Try <code>deprecated/Mathlib/Foo.lean</code> if it can't find <code>Mathlib/Foo.lean</code></li>\n</ul>\n<p>Then we could create the files at the same time and wouldn't leave people in a weird middle ground where the change has landed but not the deprecation.</p>",
        "id": 512061800,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744632302
    },
    {
        "content": "<p>the latter sounds easier than the former, we just need it to exist as an additional LEAN_SRC_DIR</p>",
        "id": 512071246,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635004
    },
    {
        "content": "<p>I don't think source directories are allowed to overlap any more</p>",
        "id": 512071666,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744635115
    },
    {
        "content": "<p>That is, the algorithm for finding <code>import Foo.Bar</code> is:</p>\n<ul>\n<li>Search the search path for <code>Foo</code></li>\n<li>Now look inside the first match for <code>Bar.lean</code>, fail if it can't be found</li>\n</ul>\n<p>As opposed to</p>\n<ul>\n<li>Search the search path for <code>Foo/Bar.lean</code></li>\n</ul>",
        "id": 512071822,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744635149
    },
    {
        "content": "<p>I don't think it searches for directories</p>",
        "id": 512072710,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635388
    },
    {
        "content": "<p>I think what you say is mostly true but I don't think that algorithm is correct</p>",
        "id": 512072797,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635415
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">findWithExt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SearchPath</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"bp\">.</span><span class=\"n\">getRoot</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">escape</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">root?</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">sp</span><span class=\"bp\">.</span><span class=\"n\">findM?</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isDir</span><span class=\"w\"> </span><span class=\"bp\">&lt;||&gt;</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">pkg</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">addExtension</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pathExists</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">root?</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">modToFilePath</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 512073246,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635534
    },
    {
        "content": "<p>So you are mostly right but it's looking for <code>Foo.lean</code> not <code>Foo/</code></p>",
        "id": 512073319,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635553
    },
    {
        "content": "<p>It looks for both, right?</p>",
        "id": 512073368,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744635570
    },
    {
        "content": "<p>oh right I guess that's what it would do <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 512073468,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635601
    },
    {
        "content": "<p>if a change is needed to this function then I think both options are equally hard</p>",
        "id": 512073708,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635661
    },
    {
        "content": "<p>(I would suggest <code>Foo.deprecated.lean</code> instead of <code>Foo.lean.deprecated</code> though so that editors and general purpose language identification tools don't freak out)</p>",
        "id": 512073847,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744635709
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Deprecation.20policy/near/512061800\">said</a>:</p>\n<blockquote>\n<p>Then we could create the files at the same time and wouldn't leave people in a weird middle ground where the change has landed but not the deprecation.</p>\n</blockquote>\n<p>The usual way of keeping diffs clean while not having any weird intermediate states would be to do it in a single PR, but not squash the PR.</p>",
        "id": 512081364,
        "sender_full_name": "Maja Kądziołka",
        "timestamp": 1744637637
    },
    {
        "content": "<p>I think the way we use <code>bors</code> makes that difficult for mathlib</p>",
        "id": 512081492,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744637668
    },
    {
        "content": "<p>That has it's own difficulties, because of the pace of commits to <code>master</code> and the relatively long CI time. If you decide to manually merge, you lose the guarantees <code>bors</code> gives you.</p>",
        "id": 512081615,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744637704
    },
    {
        "content": "<p>Bors can probably be configured to use merge commits, but currently it's the norm to have PR's with ~20 \"fix\" commits, and we'd need a shift to requiring users to (partially) squash their history before merging</p>",
        "id": 512081769,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744637747
    },
    {
        "content": "<p>My preference is to just accept the suboptimal git history. It's pretty common that this happens anyway today during renames, and it would be unfortunate to stall here.</p>",
        "id": 512081841,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744637762
    },
    {
        "content": "<p>Do you mean \"don't split the commit\" or \"deal with it being in two unsynchronized parts\"?</p>",
        "id": 512081984,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744637794
    },
    {
        "content": "<p>Don't split the commit.</p>",
        "id": 512082109,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744637831
    },
    {
        "content": "<p>If we add a <code>removed-file</code> label and make sure that <code>bors</code> does not merge a PR with such a label, the PR could do the rename without the deprecation, have the label applied until the end and, only as a last step, create the deprecated file and remove the label.</p>",
        "id": 512083071,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744638083
    },
    {
        "content": "<p>That only helps with seeing the diff in review, not with seeing it in <code>git blame</code></p>",
        "id": 512083527,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744638196
    },
    {
        "content": "<p>Btw, is anyone interested in merging <a href=\"https://github.com/leanprover-community/mathlib4/pull/24032\">#24032</a>, which fixes my oversight of how the <code>since</code> syntax works?</p>",
        "id": 512083554,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744638205
    },
    {
        "content": "<p>Another option is to create the <code>.deprecated</code> files despite lean not supporting them and:</p>\n<ul>\n<li>Have CI rename them before doing a build, to check that they are valid</li>\n<li>Have a nightly bot that creates a PR removing the <code>.deprecated</code> suffix</li>\n</ul>",
        "id": 512083778,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744638259
    },
    {
        "content": "<p>If we do that, could the nightly bot also sync <code>Mathlib.lean</code> and we stop maintaining it?</p>",
        "id": 512084300,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744638384
    },
    {
        "content": "<p>Slightly different topic: <a href=\"https://github.com/leanprover-community/leanprover-community.github.io/pull/604\">https://github.com/leanprover-community/leanprover-community.github.io/pull/604</a> documents the mathlib deprecation policy. The PR looks good to me and matches my impression of the current policy --- but more eyes on this are welcome. Please comment on the PR (if you have style suggestions) or say here if you think something significant should change!</p>",
        "id": 512177761,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744666445
    }
]