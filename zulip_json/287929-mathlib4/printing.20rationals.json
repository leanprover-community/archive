[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/29193\">#29193</a> <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> added a simple <code>ToExpr Rat</code> instance.<br>\nUnfortunately this instance is used for printing <code>#eval</code> expressions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">Rat</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"c1\">-- mkRat 4 5</span>\n<span class=\"c1\">-- remove the import to get (4 : Rat)/5</span>\n</code></pre></div>\n<p>Can we get a better implementation of <code>ToExpr Rat</code> so that we pretty-print rational evaluation more nicely?<br>\nAn option that seems to work was given by <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> here: <a class=\"message-link\" href=\"/#narrow/channel/217875-Is-there-code-for-X.3F/topic/Lean.2EToExpr.20Rat/near/520504348\">#Is there code for X? &gt; Lean.ToExpr Rat @ ðŸ’¬</a></p>",
        "id": 547735113,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1761749048
    },
    {
        "content": "<p>that seems weird, you don't see 100 being printed as nat_lit 100</p>",
        "id": 547745901,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761751362
    },
    {
        "content": "<p>I'm confused, why do we care about the <code>ToExpr</code> instance? That's just a fall-back, isn't it, for when <code>Repr</code> is missing. We should just define that.</p>",
        "id": 547841796,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761790175
    },
    {
        "content": "<p>no repr doesn't give you hover info</p>",
        "id": 547841822,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761790197
    },
    {
        "content": "<p>and also used by <code>eval%</code></p>",
        "id": 547841844,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761790205
    },
    {
        "content": "<p>It looks like Leo just added in <a href=\"https://github.com/leanprover/lean4/pull/10961\">lean#10961</a> a nicer instance, so I think the solution is just to delete the Mathlib instance on <code>nightly-testing</code>.</p>",
        "id": 547842193,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761790481
    },
    {
        "content": "<p>I'm hitting this as well. For example, here's the first 50 terms of the <a href=\"https://github.com/girving/bottcher\">Mandelbrot BÃ¶ttcher series</a>. I did the thing where I formalised it all before running any of the subcomputations, and it did work first try, but alas because of this it came out ugly. :):/</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"mi\">128</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">47</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">987</span><span class=\"w\"> </span><span class=\"mi\">32768</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">3673</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">262144</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">61029</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">4194304</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">689455</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">33554432</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">21</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">59250963</span><span class=\"w\"> </span><span class=\"mi\">2147483648</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">164712949</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">17179869184</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"w\"> </span><span class=\"mi\">2048</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">2402805839</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">274877906944</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">4850812329</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">2199023255552</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"w\"> </span><span class=\"mi\">2048</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">18151141041</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">70368744177664</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">3534139462275</span><span class=\"w\"> </span><span class=\"mi\">562949953421312</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1039</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">131072</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">22045971176589</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">9007199254740992</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">256</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">750527255965871</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">72057594037927936</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">4579</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">524288</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">54146872254247683</span><span class=\"w\"> </span><span class=\"mi\">9223372036854775808</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">155379776183158669</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">73786976294838206464</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">2851</span><span class=\"w\"> </span><span class=\"mi\">1048576</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">6051993294029466699</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1180591620717411303424</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">7704579806709870203</span><span class=\"w\"> </span><span class=\"mi\">9444732965739290427392</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">92051</span><span class=\"w\"> </span><span class=\"mi\">16777216</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">403307733528668035403</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">302231454903657293676544</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">1650116480759617184697</span><span class=\"w\"> </span><span class=\"mi\">2417851639229258349412352</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">229813</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">67108864</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">36124726440442241978477</span><span class=\"w\"> </span><span class=\"mi\">38685626227668133590597632</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">41</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">4096</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">225851495844149964787753</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">309485009821345068724781056</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">564373</span><span class=\"w\"> </span><span class=\"mi\">67108864</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"mi\">35761228458796476847725737</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">19807040628566084398385987584</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mkRat</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 554599402,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1762730215
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> Lean.ToExpr Rat</p>",
        "id": 554601962,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762732898
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Lean/Expr/Rat.html#instToExprRat_mathlib\">instToExprRat_mathlib</a></p>",
        "id": 554601966,
        "sender_full_name": "loogle",
        "timestamp": 1762732901
    },
    {
        "content": "<p>Huh, I was convinced we already had an instance that used division</p>",
        "id": 554602083,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1762732958
    },
    {
        "content": "<p>The Core <code>Repr</code> instance uses division.</p>",
        "id": 554678809,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762774760
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instReprRat#doc\">docs#instReprRat</a></p>",
        "id": 554679035,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762774827
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/printing.20rationals/near/547842193\">said</a>:</p>\n<blockquote>\n<p>so I think the solution is just to delete the Mathlib instance on <code>nightly-testing</code>.</p>\n</blockquote>\n<p>I guess this didn't happen; now deleted in <a href=\"https://github.com/leanprover-community/mathlib4/pull/34737\">#34737</a></p>",
        "id": 571518321,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770063885
    },
    {
        "content": "<p>The rest of that file is also somewhat suspicious</p>",
        "id": 571518605,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770064004
    },
    {
        "content": "<p><code>Lean.Expr.rat?</code> is checking for <code>Div.div</code>, but the operation associated to the <code>/</code> notation is <code>HDiv.hDiv</code></p>",
        "id": 571518773,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1770064070
    },
    {
        "content": "<p>Good catch, though probably one for a separate PR</p>",
        "id": 571519033,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1770064168
    }
]