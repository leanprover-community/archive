[
    {
        "content": "<p><code>DirectSum</code> is defined to be <code>DFinsupp</code>, and this defeq is used a lot, for example to write <code>x.sum</code> when <code>x</code> is a term of a direct sum, but the <code>.sum</code> refers to <code>DFinsupp.sum</code>.<br>\nHowever, this leads to proofs like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mul_eq_dfinsupp_sum</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">⨁</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a'</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ai</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">aj</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">GradedMonoid</span><span class=\"bp\">.</span><span class=\"n\">GMul</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">ai</span><span class=\"w\"> </span><span class=\"n\">aj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">mulHom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Porting note: I have no idea how the proof from ml3 worked it used to be</span>\n<span class=\"w\">  </span><span class=\"c1\">-- simpa only [mul_hom, to_add_monoid, dfinsupp.lift_add_hom_apply, dfinsupp.sum_add_hom_apply,</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add_monoid_hom.dfinsupp_sum_apply, flip_apply, add_monoid_hom.dfinsupp_sum_add_hom_apply],</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mulHom</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">DFinsupp</span><span class=\"bp\">.</span><span class=\"n\">liftAddHom_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DirectSum</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DFinsupp</span><span class=\"bp\">.</span><span class=\"n\">sumAddHom_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">dfinsupp_sum_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">flip_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This used to be `rw`, but we need `erw` after https://github.com/leanprover/lean4/pull/2644</span>\n<span class=\"w\">  </span><span class=\"n\">erw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DFinsupp</span><span class=\"bp\">.</span><span class=\"n\">sumAddHom_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">gMulHom</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">dfinsupp_sum_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">flip_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">coe_comp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">coe_mk</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ZeroHom</span><span class=\"bp\">.</span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">comp_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">compHom_apply_apply</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Should <code>DirectSum</code> be an <code>abbrev</code>? Or a 1-field structure?<br>\nIt seems to me that at the moment it is trying to act a bit like both.</p>",
        "id": 504799270,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741689117
    },
    {
        "content": "<p>I tried to set things up such that DFinsupp : DirectSum :: Finsupp : AddMonoidAlgebra</p>",
        "id": 504800320,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689392
    },
    {
        "content": "<p>Which in theory would include one using pointwise multiplication and the other using convolutive multiplication, which rules out an abbrev</p>",
        "id": 504800657,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689481
    },
    {
        "content": "<p>As an aside, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=mul_eq_dfinsupp_sum#doc\">docs#mul_eq_dfinsupp_sum</a> looks like it should be true by definition, at least if the RHS is adjusted to use DirectSum APIs</p>",
        "id": 504800843,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689516
    },
    {
        "content": "<p>I think a one-field structure (with name <code>coeff</code> or <code>component</code>) would be sensible here. That could also remove the coercion to function, which is maybe desirable.</p>",
        "id": 504801767,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689744
    },
    {
        "content": "<p>It looks a good idea to me.</p>",
        "id": 504803678,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1741690225
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> and I talked about doing the same thing for MonoidAlgebra two years ago</p>",
        "id": 504805018,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741690570
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SkewMonoidAlgebra#doc\">docs#SkewMonoidAlgebra</a> got the right treatment at least</p>",
        "id": 504805074,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741690586
    },
    {
        "content": "<p>I remember the conversation and I also started to refactor, but as I was doing it, it became apparent that untangling <code>MonoidAlgebra</code> and <code>AddMonoidAlgebra</code> was a very useful preliminary step, but I did not have the capacity to do that!</p>",
        "id": 504829733,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741697025
    },
    {
        "content": "<p>I think an <code>abbrev</code> is a bad idea. I started a refactor via a structure wrapper a while back but got led off into the sorry state of deriving handlers which never produced anything.</p>",
        "id": 504849115,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741701442
    },
    {
        "content": "<p>I think more automation for single-field structures is perhaps a better investment than doing this refactor</p>",
        "id": 504852405,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741702153
    },
    {
        "content": "<p>(in that we need it anyway, and it will make the refactor easier)</p>",
        "id": 504852466,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741702168
    },
    {
        "content": "<p>It would be nice not to make life harder when doing the prudent thing.</p>",
        "id": 504853744,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741702448
    }
]