[
    {
        "content": "<p><code>DirectSum</code> is defined to be <code>DFinsupp</code>, and this defeq is used a lot, for example to write <code>x.sum</code> when <code>x</code> is a term of a direct sum, but the <code>.sum</code> refers to <code>DFinsupp.sum</code>.<br>\nHowever, this leads to proofs like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mul_eq_dfinsupp_sum</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">⨁</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a'</span>\n<span class=\"w\">      </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ai</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"bp\">.</span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">aj</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">GradedMonoid</span><span class=\"bp\">.</span><span class=\"n\">GMul</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">ai</span><span class=\"w\"> </span><span class=\"n\">aj</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">mulHom</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a'</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Porting note: I have no idea how the proof from ml3 worked it used to be</span>\n<span class=\"w\">  </span><span class=\"c1\">-- simpa only [mul_hom, to_add_monoid, dfinsupp.lift_add_hom_apply, dfinsupp.sum_add_hom_apply,</span>\n<span class=\"w\">  </span><span class=\"c1\">-- add_monoid_hom.dfinsupp_sum_apply, flip_apply, add_monoid_hom.dfinsupp_sum_add_hom_apply],</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mulHom</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">toAddMonoid</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">DFinsupp</span><span class=\"bp\">.</span><span class=\"n\">liftAddHom_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DirectSum</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DFinsupp</span><span class=\"bp\">.</span><span class=\"n\">sumAddHom_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">dfinsupp_sum_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">flip_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">funext</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"c1\">-- This used to be `rw`, but we need `erw` after https://github.com/leanprover/lean4/pull/2644</span>\n<span class=\"w\">  </span><span class=\"n\">erw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DFinsupp</span><span class=\"bp\">.</span><span class=\"n\">sumAddHom_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">gMulHom</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">dfinsupp_sum_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">flip_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">coe_comp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">coe_mk</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ZeroHom</span><span class=\"bp\">.</span><span class=\"n\">coe_mk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">comp_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">AddMonoidHom</span><span class=\"bp\">.</span><span class=\"n\">compHom_apply_apply</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Should <code>DirectSum</code> be an <code>abbrev</code>? Or a 1-field structure?<br>\nIt seems to me that at the moment it is trying to act a bit like both.</p>",
        "id": 504799270,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741689117
    },
    {
        "content": "<p>I tried to set things up such that DFinsupp : DirectSum :: Finsupp : AddMonoidAlgebra</p>",
        "id": 504800320,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689392
    },
    {
        "content": "<p>Which in theory would include one using pointwise multiplication and the other using convolutive multiplication, which rules out an abbrev</p>",
        "id": 504800657,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689481
    },
    {
        "content": "<p>As an aside, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=mul_eq_dfinsupp_sum#doc\">docs#mul_eq_dfinsupp_sum</a> looks like it should be true by definition, at least if the RHS is adjusted to use DirectSum APIs</p>",
        "id": 504800843,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689516
    },
    {
        "content": "<p>I think a one-field structure (with name <code>coeff</code> or <code>component</code>) would be sensible here. That could also remove the coercion to function, which is maybe desirable.</p>",
        "id": 504801767,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741689744
    },
    {
        "content": "<p>It looks a good idea to me.</p>",
        "id": 504803678,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1741690225
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> and I talked about doing the same thing for MonoidAlgebra two years ago</p>",
        "id": 504805018,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741690570
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SkewMonoidAlgebra#doc\">docs#SkewMonoidAlgebra</a> got the right treatment at least</p>",
        "id": 504805074,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741690586
    },
    {
        "content": "<p>I remember the conversation and I also started to refactor, but as I was doing it, it became apparent that untangling <code>MonoidAlgebra</code> and <code>AddMonoidAlgebra</code> was a very useful preliminary step, but I did not have the capacity to do that!</p>",
        "id": 504829733,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741697025
    },
    {
        "content": "<p>I think an <code>abbrev</code> is a bad idea. I started a refactor via a structure wrapper a while back but got led off into the sorry state of deriving handlers which never produced anything.</p>",
        "id": 504849115,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741701442
    },
    {
        "content": "<p>I think more automation for single-field structures is perhaps a better investment than doing this refactor</p>",
        "id": 504852405,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741702153
    },
    {
        "content": "<p>(in that we need it anyway, and it will make the refactor easier)</p>",
        "id": 504852466,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741702168
    },
    {
        "content": "<p>It would be nice not to make life harder when doing the prudent thing.</p>",
        "id": 504853744,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1741702448
    },
    {
        "content": "<p>Speaking of <code>DirectSum</code>, my student recently ran into the following issue. Consider the code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">DirectSum_eq_sum_direct</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hi</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">[(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">DirectSum</span><span class=\"bp\">.</span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">DFinsupp</span><span class=\"bp\">.</span><span class=\"n\">finset_sum_apply</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"c1\">--simp [DirectSum]</span>\n</code></pre></div>\n<p>The proof is a single application of <code>DFinsupp.finset_sum_apply</code>, but neither <code>exact?</code> nor <code>apply?</code> finds this lemma, and <code>simp</code> also does not call <code>DFinsupp.finset_sum_apply</code> to close the goal (even though <code>DFinsupp.finset_sum_apply</code>is tagged <code>simp</code>). We finally realized after some playing around that <code>simp [DirectSum]</code> was able to call <code>DFinsupp.finset_sum_apply</code> and to close the goal.</p>\n<p>In his actual code, the goal was something more complicated, and proving the equality I wrote above is only the first step. I was able to do it because I knew <code>DFinsupp.finset_sum_apply</code>, my student was stuck because he didn't. Given that <code>DFinsupp.finset_sum_apply</code> is tagged <code>simp</code>, I feel that it is the kind of lemma that we want to be called automatically and the current implementation of <code>DirectSum</code> is not optimal.</p>",
        "id": 524749512,
        "sender_full_name": "Sophie Morel",
        "timestamp": 1750266053
    },
    {
        "content": "<p>since <code>DirectSum</code> is a type alias, this just means that there is missing API here</p>",
        "id": 524751622,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1750266872
    },
    {
        "content": "<p>although to be honest, i'm not sure why <code>DirectSum</code> <em>is</em> a type alias... it looks to me like a lot of its instances are directly inherited from <code>DFinsupp</code>?</p>",
        "id": 524752093,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1750267065
    },
    {
        "content": "<p>See above:<br>\n<span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/DirectSum.20defeqs/near/504800657\">said</a>:</p>\n<blockquote>\n<p>I tried to set things up such that DFinsupp : DirectSum :: Finsupp : AddMonoidAlgebra</p>\n<p>Which in theory would include one using pointwise multiplication and the other using convolutive multiplication, which rules out an abbrev</p>\n</blockquote>",
        "id": 524763583,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1750271894
    },
    {
        "content": "<p>But yes, the answer is that this is just missing API.</p>",
        "id": 524763635,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1750271916
    },
    {
        "content": "<p>I think in both cases we're missing the \"coefficient\" function, probably we shouldn't be using <code>coeFn</code> at all</p>",
        "id": 524784537,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750281183
    },
    {
        "content": "<p>It's the summer soon and I have big plans to clean up this mess. It's been an annoying slowdown in Toric</p>",
        "id": 524784611,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1750281237
    },
    {
        "content": "<p>I temporarily solved the problem for my student by telling him to systematically try <code>simp [DirectSum]</code>.</p>",
        "id": 524897509,
        "sender_full_name": "Sophie Morel",
        "timestamp": 1750343083
    },
    {
        "content": "<p>That's a pretty reasonable workaround (at least, once <code>simp</code> by itself is stuck)</p>",
        "id": 524900105,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750343981
    },
    {
        "content": "<p>Another way out of the pain is to use DFinsupp as much as possible, and then prove your DirectSum result in one line using it</p>",
        "id": 524900252,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750344030
    }
]