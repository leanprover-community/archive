[
    {
        "content": "<p>I've just noticed that we have typeclasses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BoundingSieve#doc\">docs#BoundingSieve</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=SelbergSieve#doc\">docs#SelbergSieve</a>. I'm not an expert in this area, but it seems to me like there aren't going to be any \"canonical\" instances of these typeclasses. Should we turn them into <code>structure</code>s?</p>",
        "id": 519953708,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747967098
    },
    {
        "content": "<p>that seems to be using the technique of nullary typeclasses as fake parameters</p>",
        "id": 519955310,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747968216
    },
    {
        "content": "<p>if you want to keep this trick localized, you could make it a structure and then <code>attribute [local class]</code> it in the file</p>",
        "id": 519955400,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747968272
    },
    {
        "content": "<p>IMHO, if we want the main theorem of the file to be useable outside of the file, then we should turn these typeclasses into structures.</p>",
        "id": 519963401,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747973690
    },
    {
        "content": "<p>If we use <code>local class</code>, then chances are some of the external-facing lemmas will take it as <code>[BoundingSieve]</code> instead of <code>(s : BoundingSieve)</code>.</p>",
        "id": 519963470,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747973754
    },
    {
        "content": "<p>I didn't look carefully. Indeed the main theorem should take the structure explicitly or not at all</p>",
        "id": 519963939,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747974036
    },
    {
        "content": "<p>It seems this file doesn't really have what looks like a main theorem, in which case it makes sense to keep it as a global typeclass and just keep using a variable in downstream files which continue developing the theory</p>",
        "id": 519964277,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747974245
    },
    {
        "content": "<p>this file seems to be a leaf right now though</p>",
        "id": 519964294,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1747974258
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"585783\">@Arend Mellendijk</span> What are your plans about this file?</p>",
        "id": 519964798,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747974570
    },
    {
        "content": "<p>IIUC, <a href=\"https://github.com/leanprover-community/mathlib4/pull/20008\">#20008</a> adds the remaining results (which are used in the PNT+ project). Review of that PR and its deps has been slow...</p>",
        "id": 519973884,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1747980077
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/BoundingSieve.20is.20a.20class.3F.3F/near/519955400\">said</a>:</p>\n<blockquote>\n<p>if you want to keep this trick localized, you could make it a structure and then <code>attribute [local class]</code> it in the file</p>\n</blockquote>\n<p>I tried this when I first made it a class, but:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"c\">/-</span><span class=\"cm\"> invalid attribute 'class', must be global -/</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">class</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n</code></pre></div>",
        "id": 519992500,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1747987438
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/BoundingSieve.20is.20a.20class.3F.3F/near/519964798\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"585783\">Arend Mellendijk</span> What are your plans about this file?</p>\n</blockquote>\n<p>The plan for this file is to have only the main result be user-facing (plus a couple of the definitions used in the main theorem). This is <code>selberg_bound</code> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/20008\">#20008</a>, and it takes a <code>SelbergSieve</code> explicitly. </p>\n<p>You're right that there is never a canonical instance of this class, and in fact every application that I know of defines a family of sieves.The intent is for the user to define the family they care about by making it a <code>def</code>. There should never be an instance of this class. I thought I put that in a docstring, but it must have got lost somewhere.</p>",
        "id": 519995177,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1747988356
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> can you expand on the <code>local class</code> thing? I am also facing a case in <a href=\"https://github.com/leanprover-community/mathlib4/pull/24991\">#24991</a> where for practical reasons I had to make a <code>class</code> something that would make more sense as a structure, and that would probably be solved by a local class, but like <span class=\"user-mention\" data-user-id=\"585783\">@Arend Mellendijk</span> lean is unhappy with the syntax you gave.</p>",
        "id": 519995638,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1747988523
    },
    {
        "content": "<p>Do we have <code>local class</code>? A search on mathlib reveals that there are only <code>local instance</code>.</p>",
        "id": 520000111,
        "sender_full_name": "Jz Pan",
        "timestamp": 1747990046
    },
    {
        "content": "<p>The <a href=\"https://lean-lang.org/doc/reference/latest////Type-Classes/#type-classes\">reference manual section on type classes</a> does not mention it (or anything like it) :(</p>",
        "id": 520003806,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1747991123
    },
    {
        "content": "<blockquote>\n<p>There should never be an instance of this class.</p>\n</blockquote>\n<p>Is this another way of saying \"I miss parameters\"?</p>",
        "id": 520021708,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747996716
    },
    {
        "content": "<p>I don't think I've ever had that thought, but maybe I wasn't using parameters correctly when I used Lean 3.</p>",
        "id": 520034677,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748000989
    },
    {
        "content": "<p>Though here's an argument in favour of keeping it a class. Once your parameters are fixed, the <code>SelbergSieve</code> instance becomes canonical, so in theory one could wrap your parameters around a nullary typeclass and create an <code>instance [Parameters] : SelbergSieve</code>. That way you can apply all of the theorems and definitions about the <code>SelbergSieve</code> without passing any parameters explicitly. Here's what that might look like:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">SelbergSieve</span><span class=\"w\"> </span><span class=\"n\">ArithmeticFunction</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PrimeSieve</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">  </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span>\n<span class=\"w\">  </span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">y</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Proof</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">PrimeSieve</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PrimeSieve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SelbergSieve</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">support</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">prodPrimes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">primorial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">floor</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">prodPrimes_squarefree</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">weights</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">weights_nonneg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">zero_le_one</span>\n<span class=\"w\">  </span><span class=\"n\">totalMass</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">  </span><span class=\"n\">nu</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ∂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ArithmeticFunction</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pdiv</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">id</span>\n<span class=\"w\">  </span><span class=\"n\">nu_mult</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">arith_mult</span>\n<span class=\"w\">  </span><span class=\"n\">nu_pos_of_prime</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"o\">[</span><span class=\"n\">if_neg</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"bp\">.</span><span class=\"n\">ne_zero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pos_of_ne_zero</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"bp\">.</span><span class=\"n\">ne_zero</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">nu_lt_one_of_prime</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">level</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"n\">one_le_level</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hy</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PrimeSieve</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c\">/-</span><span class=\"cm\"> We get to use `BoundingSieve.siftedSum` for free. -/</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">siftedSum_eq</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">siftedSum</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"bp\">¬¨</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">‚à£</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">card</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">pi_le_siftedSum</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">œÄ</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">siftedSum</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">siftedSum_le</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">siftedSum</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"bp\">+</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> Apply the main theorem of the Selberg Sieve. -/</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Proof</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">primeCounting_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">œÄ</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"bp\">+</span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">^</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sieve</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrimeSieve</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">N</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hy</span><span class=\"bp\">‚ü©</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">pi_le_siftedSum</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">siftedSum_le</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">sieve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">  </span><span class=\"n\">linarith</span>\n</code></pre></div>",
        "id": 520034802,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748001015
    },
    {
        "content": "<p>IMHO, it means one of:</p>\n<ul>\n<li>you can define a structure that holds params, then a typeclass that takes this structure as an argument;</li>\n<li>you can use it as a structure and define custom constructors.</li>\n</ul>",
        "id": 520119329,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748029530
    },
    {
        "content": "<p>In either case, I would prefer to avoid using <code>class</code>es in place of Lean 3 parameters.</p>",
        "id": 520119438,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748029573
    },
    {
        "content": "<p>I'm afraid I don't understand what you mean by the first bullet point.</p>\n<p>The situation is this: I have a (structure/class) holding the data and running assumptions of the main proof. There are about 8 intermediate definitions that are used for the fundamental theorem that depend on the variables in the class. On paper these have names like <code>S</code>, <code>g</code>, <code>R</code>, etc. These definitions are not hidden: they are used in the statement of the final theorem.</p>\n<p>By using a class I don't have to pass the structure every time I write down one of these definitions (which could easily be 5 times on a single line). I also get to create hygienic local notation that mimics the paper proof.</p>",
        "id": 520125245,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748032317
    },
    {
        "content": "<p>FWIW I had a situation in FLT where I had several intermediate definitions which in the <a href=\"https://imperialcollegelondon.github.io/FLT/blueprint/Fujisaki_project.html\">blueprint</a> I called <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi></mrow><annotation encoding=\"application/x-tex\">E</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi></mrow><annotation encoding=\"application/x-tex\">X</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi></mrow><annotation encoding=\"application/x-tex\">Y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span></span>, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>T</mi></mrow><annotation encoding=\"application/x-tex\">T</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span> (see the definitions in the section), and in the Lean I've just stuffed them away in the namespace <code>NumberField.AdeleRing.DivisionAlgebra.Aux</code> (see e.g. <a href=\"https://imperialcollegelondon.github.io/FLT/docs/FLT/DivisionAlgebra/Finiteness.html#NumberField.AdeleRing.DivisionAlgebra.Aux.C\">here</a>). I could even have made them <code>private</code> and if this proof is ever upstreamed to FLT there might be a call to do that.</p>",
        "id": 520129363,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748034391
    },
    {
        "content": "<p>But those intermediate definitions don't show up in the final theorem, right? My definitions do, and in practise people will want to prove things like \"For this family of sieves I've just defined, <code>R d ‚â§ 2 ^ œâ d</code>\"</p>",
        "id": 520131145,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748035397
    },
    {
        "content": "<p>Yes that's correct, my final theorem was \"some space or other is compact\" and these were intermediate also-compact things that we found along the way.</p>",
        "id": 520136184,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748038317
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/BoundingSieve.20is.20a.20class.3F.3F/near/520119329\">said</a>:</p>\n<blockquote>\n<p>IMHO, it means one of:</p>\n<ul>\n<li>you can define a structure that holds params, then a typeclass that takes this structure as an argument;</li>\n<li>you can use it as a structure and define custom constructors.</li>\n</ul>\n</blockquote>\n<p>But this reminds me of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=StateT#doc\">docs#StateT</a> in lean4 functional programming. Maybe we can reuse/reinvent a similar thing?</p>",
        "id": 520158230,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748057740
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"585783\">Arend Mellendijk</span> <a href=\"#narrow/channel/287929-mathlib4/topic/BoundingSieve.20is.20a.20class.3F.3F/near/520131145\">said</a>:</p>\n<blockquote>\n<p>But those intermediate definitions don't show up in the final theorem, right? My definitions do, and in practise people will want to prove things like \"For this family of sieves I've just defined, <code>R d ‚â§ 2 ^ œâ d</code>\"</p>\n</blockquote>\n<p>How do you want a user to use your notation for a family of sieves with the typeclass setup? Did you consider using something like <code>abbrev Sieve.R := _</code>, then <code>s.R d</code>?</p>",
        "id": 520192922,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748089574
    },
    {
        "content": "<p>You're right that if you define your family as a <code>def</code> the notation won't play nice, but consider the setup I gave above:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Code</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">SelbergSieve</span><span class=\"w\"> </span><span class=\"n\">ArithmeticFunction</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"w\"> </span><span class=\"n\">SelbergSieve</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PrimeSieve</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">  </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span>\n<span class=\"w\">  </span><span class=\"n\">one_le_z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">z</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Proof</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">PrimeSieve</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PrimeSieve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SelbergSieve</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">support</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">prodPrimes</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">primorial</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">floor</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">prodPrimes_squarefree</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">weights</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">weights_nonneg</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">zero_le_one</span>\n<span class=\"w\">  </span><span class=\"n\">totalMass</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">N</span>\n<span class=\"w\">  </span><span class=\"n\">nu</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ∂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ArithmeticFunction</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pdiv</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">id</span>\n<span class=\"w\">  </span><span class=\"n\">nu_mult</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">arith_mult</span>\n<span class=\"w\">  </span><span class=\"n\">nu_pos_of_prime</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span><span class=\"o\">[</span><span class=\"n\">if_neg</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"bp\">.</span><span class=\"n\">ne_zero</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">pos_of_ne_zero</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"bp\">.</span><span class=\"n\">ne_zero</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">nu_lt_one_of_prime</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">level</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">z</span>\n<span class=\"w\">  </span><span class=\"n\">one_le_level</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">one_le_z</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PrimeSieve</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Classical</span><span class=\"w\"> </span><span class=\"k\">in</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">y_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">X_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ŒΩ_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ŒΩ</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ∂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ArithmeticFunction</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pdiv</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ŒΩ_apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ŒΩ</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ŒΩ_eq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">split_ifs</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">a_apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">A_eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">ùíú_apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùíú</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚åä</span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">‚åã‚Çä</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">multSum</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">a_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">sum_boole</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">floor_nat</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">id_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">cast_inj</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">A_eq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">R_eq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">‚åä</span><span class=\"o\">(</span><span class=\"n\">N</span><span class=\"bp\">/</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">‚åã‚Çä</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">rem</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">X_eq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ŒΩ_apply</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">ùíú_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">ring</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">R_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">R_eq</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">abs_floor_sub_le</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Proof</span>\n</code></pre></div>\n</div></div>",
        "id": 520198358,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748093931
    },
    {
        "content": "<blockquote>\n<p>Did you consider using something like <code>abbrev Sieve.R := _</code>, then <code>s.R d</code>?</p>\n</blockquote>\n<p>I have, but I admit I haven't tried to implement it. The <code>s.</code> seems like visual clutter in expressions that are already fairly large, especially when notation lets you write it exactly like you would on paper.</p>",
        "id": 520198649,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748094159
    },
    {
        "content": "<p>In FLT I got annoyed with this kind of visual clutter (maths said \"let's write <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>D</mi><mi mathvariant=\"double-struck\">A</mi></msub></mrow><annotation encoding=\"application/x-tex\">D_{\\mathbb{A}}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3322em;\"><span style=\"top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathbb mtight\">A</span></span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span> for <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><msub><mo>‚äó</mo><mi>K</mi></msub><msub><mi mathvariant=\"double-struck\">A</mi><mi>K</mi></msub></mrow><annotation encoding=\"application/x-tex\">D\\otimes_K\\mathbb{A}_K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\"><span class=\"mbin\">‚äó</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathbb\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.07153em;\">K</span></span></span></span><span class=\"vlist-s\">‚Äã</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>\" and then after using <code>notation</code> in the naive way I had to write <code>D_ùî∏ D K</code> which was horrible). But I fixed this with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">quotPrecheck</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"sd\">/-- `D_ùî∏` is notation for `D ‚äó[K] ùî∏_K`. -/</span>\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"D_ùî∏\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"bp\">‚äó</span><span class=\"o\">[</span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">AdeleRing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ùìû</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>which hasn't caused me any problems at all so far (although I have only used this in files where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span> and <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span> really are \"parameters\" in the sense that they never change, but it sounds like you're in that situation too).</p>",
        "id": 520202580,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748097135
    },
    {
        "content": "<p>I used to do something similar (that is, unhygienic notation), and maybe this is a reasonable compromise, but it has one big downside: the notation only refers to the specific <code>variable</code>s it uses. That means you can't make the notation public, or split the file multiple parts:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">long_name_we_want_to_call_X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Theory</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">quotPrecheck</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"X\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"n\">long_name_we_want_to_call_X</span><span class=\"w\"> </span><span class=\"n\">f</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> This works as expected -/</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Theory</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> ... some results not about `f` ... -/</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Theory</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"o\">)</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> unknown constant 'f‚úù' -/</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">long_name_we_want_to_call_X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Theory</span>\n</code></pre></div>",
        "id": 520205950,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748099837
    },
    {
        "content": "<p>I still can't see how it works for a <em>family</em> of sieves.</p>",
        "id": 520206057,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748099929
    },
    {
        "content": "<p>In the code <a href=\"#narrow/channel/287929-mathlib4/topic/BoundingSieve.20is.20a.20class.3F.3F/near/520198358\">here</a>, <code>R_le</code> is a statement about a family of sieves parameterised by <code>N</code> and <code>z</code>.</p>",
        "id": 520206277,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748100111
    },
    {
        "content": "<p>I see what you mean.</p>",
        "id": 520206347,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748100151
    },
    {
        "content": "<p>But you can't have 2 sieves in the same statement.</p>",
        "id": 520206394,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748100210
    },
    {
        "content": "<p>(e.g., to say that some sieve is better in some sense)</p>",
        "id": 520206403,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748100231
    },
    {
        "content": "<p>I don't know if there are any statements of this sort in this theory.</p>",
        "id": 520206456,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748100249
    },
    {
        "content": "<p>I don't know that this happens in practise. I feel that if you want to compare two sieves in a sense what you do is you compare the results they produce, rather than the specific values of the instances.</p>",
        "id": 520207427,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748101043
    },
    {
        "content": "<p>you can't really do that either though, all the functions defined on top take it as a typeclass</p>",
        "id": 520207512,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748101093
    },
    {
        "content": "<p>The purpose of a sieve is generally to get some concrete (but possibly rough) bound on a function you care about, like <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>œÄ</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>O</mi><mo stretchy=\"false\">(</mo><mi>x</mi><mi mathvariant=\"normal\">/</mi><mi>log</mi><mo>‚Å°</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\pi(x) = O(x / \\log x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">œÄ</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">/</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span>. I get the impression that usually we \"compare\" two sieves only in an informal sense to decide which one to apply to get the result we want. </p>\n<p>Also the word 'sieve' is overloaded here: it refers to both instance and class. In the literature one might consider the bounds produced by the large sieve, Brun's sieve, Selberg's sieve, etc., but when applying a sieve result you consider a family of objects which you might also call \"sieve\"</p>",
        "id": 520208391,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748101858
    },
    {
        "content": "<p>I don't know what this word sieve means here TBH, it seems to be used in a completely contentless way and I can't make heads or tails of the data in the structures. Is there a theorem which is motivating this?</p>",
        "id": 520209474,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748102683
    },
    {
        "content": "<p><a href=\"https://en.m.wikipedia.org/wiki/Selberg_sieve\">https://en.m.wikipedia.org/wiki/Selberg_sieve</a></p>",
        "id": 520210076,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748103145
    },
    {
        "content": "<p>It's the name of a technique in analytic number theory</p>",
        "id": 520210117,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748103204
    },
    {
        "content": "<p>That's a good overview.</p>\n<p>The specific result I've formalised is often called the \"Fundamental Theorem for Selberg's Sieve\". A variant of the specific statement I've formalised is outlined by Heath-Brown here: <a href=\"https://arxiv.org/abs/math/0209360\">https://arxiv.org/abs/math/0209360</a> (after Lemma 2.2)</p>",
        "id": 520210147,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748103238
    },
    {
        "content": "<p>Also to understand the data as I've defined it maybe the documentation in Mathlib is helpful:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/blob/b057c67c0905df3e5eabf70651a42625f05a56b9/Mathlib/NumberTheory/SelbergSieve.lean#L50-L79\">https://github.com/leanprover-community/mathlib4/blob/b057c67c0905df3e5eabf70651a42625f05a56b9/Mathlib/NumberTheory/SelbergSieve.lean#L50-L79</a></p>",
        "id": 520210370,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748103385
    },
    {
        "content": "<p>The technique says \"given an annoyingly large amount of data we can prove a mathematical statement involving numbers which you can work out from the data\" and the point is presumably that supplying all the data as an input to every lemma gets old very quickly</p>",
        "id": 520210665,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748103683
    },
    {
        "content": "<p>TBH I kind of agree with Yury that this should be used as a structure and not a class, I find it quite confusing as written what is a definition and what is a local variable because everything has tiny names</p>",
        "id": 520210786,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748103776
    },
    {
        "content": "<p>...which are probably standard in the domain</p>",
        "id": 520210828,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748103822
    },
    {
        "content": "<p>standard in a proof more like</p>",
        "id": 520210840,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748103833
    },
    {
        "content": "<p>this has the look of the internals of some argument</p>",
        "id": 520210886,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748103847
    },
    {
        "content": "<p>I mean \"in the literature\"</p>",
        "id": 520210892,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748103851
    },
    {
        "content": "<p>Like I call my primes p</p>",
        "id": 520210923,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748103888
    },
    {
        "content": "<p>I don't find this kind of literal transcription of the paper mathematics that useful, except during the informal -&gt; formal process</p>",
        "id": 520210982,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748103934
    },
    {
        "content": "<p>for standalone mathlib proof maintenance I would cut way back on the bespoke notations</p>",
        "id": 520211032,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748103963
    },
    {
        "content": "<p>The objection to using a structure is the same as the objection I would raise if you were to tell me that I had to call my prime <code>s.p</code> throughout my argument</p>",
        "id": 520211036,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1748103968
    },
    {
        "content": "<p>you could have a local variable and call it <code>p</code></p>",
        "id": 520211054,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748103990
    },
    {
        "content": "<p>but I don't like definitions named <code>p</code></p>",
        "id": 520211062,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104006
    },
    {
        "content": "<p>I think this kind of technique is fine if used in very local situations where no one ever has to look at the code</p>",
        "id": 520211119,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104065
    },
    {
        "content": "<p>but it's bad API design</p>",
        "id": 520211129,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104079
    },
    {
        "content": "<p>There's some truth to Mario's point: a lot of these variable names differ author by author, though they are invariably one letter long and are only referred to as such.</p>",
        "id": 520211257,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748104192
    },
    {
        "content": "<p>And sadly the theorem itself is rather leaky - you define the base data (rather annoyingly many of them), then you prove that the intermediate definitions happen to have these nice properties, and you get a theorem at the end stated in terms of these intermediate definitions.</p>",
        "id": 520211477,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748104334
    },
    {
        "content": "<p>I think most of that can be stated as functions taking one structure argument</p>",
        "id": 520211544,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104390
    },
    {
        "content": "<p>You are already using notations heavily to avoid having to write it anyway, so I don't see that this would make any difference for you</p>",
        "id": 520211622,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104456
    },
    {
        "content": "<p>Sorry I'm confused, wasn't your objection to the use of notation? Or do you mean switch to unhygienic local notation so it doesn't seep into the API?</p>",
        "id": 520211857,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748104636
    },
    {
        "content": "<p>yes that</p>",
        "id": 520211874,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104649
    },
    {
        "content": "<p>aggressively using notation where it's all local and confined to a single proof or file is fine, but there is some gradient from that to multi-file proofs to scoped notations, \"domain standard\" notations, and global notations</p>",
        "id": 520211983,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104744
    },
    {
        "content": "<p>as the scope increases more users have to be concerned with learning your notation</p>",
        "id": 520212023,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104785
    },
    {
        "content": "<p>and in API theorems this is especially problematic because these aren't users that have just gone through the multi page bootstrap section of the proof because they want to learn the proof, they just want to use it and all of the layers get in the way at that point</p>",
        "id": 520212167,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104857
    },
    {
        "content": "<p>I'll reiterate <a href=\"#narrow/channel/287929-mathlib4/topic/BoundingSieve.20is.20a.20class.3F.3F/near/520205950\">this</a> annoyance, but I understand the maintenance burden here might outweigh it.</p>",
        "id": 520212197,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748104879
    },
    {
        "content": "<p>did you try <code>set_option hygiene false</code> there?</p>",
        "id": 520212296,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748104940
    },
    {
        "content": "<p>Ah! I hadn't. That only works with autoImplicit, doesn't it?</p>",
        "id": 520212431,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748105050
    },
    {
        "content": "<p>no, it's unrelated</p>",
        "id": 520212438,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748105060
    },
    {
        "content": "<p>oh sorry, yeah that works.</p>",
        "id": 520212463,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748105084
    },
    {
        "content": "<p>an unhygienic notation there will pick up whatever happens to be called <code>f</code> in the local scope</p>",
        "id": 520212469,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748105090
    },
    {
        "content": "<blockquote>\n<p>and in API theorems this is especially problematic because these aren't users that have just gone through the multi page bootstrap section of the proof because they want to learn the proof, they just want to use it and all of the layers get in the way at that point</p>\n</blockquote>\n<p>I don't think this happens to be much of a concern for this specific theorem: the actual result is quite technical and phrased multiple different ways in the literature. To apply it you have to look at a bunch of definitions anyway, and the notation is documented very clearly. </p>\n<p>That said I understand your fears, and I'll make a PR to switch it back to a structure.</p>",
        "id": 520213031,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1748105551
    },
    {
        "content": "<p>I'm just a bystander in this discussion but I find it fascinating. Is there somewhere one can read about all these different design and implementation decisions, where/why some things are better than others (<code>structure</code> vs <code>class</code>, <code>abbrev</code> vs <code>notation</code>, etc etc)? Is there a concrete \"yoga\", or are people mostly speaking from experience in similar circumstances (heavy preliminaries that are annoying to have to carry around in each lemma)?</p>",
        "id": 520219922,
        "sender_full_name": "Alex Kontorovich",
        "timestamp": 1748110991
    },
    {
        "content": "<p>Generally, <code>class</code>es are reserved for structures that have canonical instances.</p>",
        "id": 520220017,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748111075
    },
    {
        "content": "<p>I'm not sure there is even a clear difference between those two. Guidelines are just peoples experiences with what works or doesn't written down</p>",
        "id": 520220019,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111079
    },
    {
        "content": "<p>There is a second use of classes though Yury, which is this parameter thing. It's qualitatively different from the usual use of typeclasses and it has different rules / best practices</p>",
        "id": 520220097,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111139
    },
    {
        "content": "<p>I guess, I never used classes this way, so I don't know what are the best practices here.</p>",
        "id": 520220182,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1748111203
    },
    {
        "content": "<p>I do wonder whether we should just revisit the possibility of re-adding <code>parameter</code> and possibly redesigning it to suit our uses</p>",
        "id": 520220187,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111208
    },
    {
        "content": "<p>It seems unlikely that this will happen without FRO support though, and I think first we need to have clear problem cases where the (ab)use of typeclasses causes problems. It's not good enough to just be violating a guideline like \"there should only be one instance of a class in scope\", we need actual demonstrable problems in a practical situation</p>",
        "id": 520220607,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111553
    },
    {
        "content": "<p>That particular guideline is there because of issues involving non-commuting diamonds in the algebraic hierarchy, and it's not clear that it still applies with these kind of local typeclasses. It might, but we need more data</p>",
        "id": 520220720,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111651
    },
    {
        "content": "<p>Has someone given a talk on this topic perhaps (that one can watch on, say, YouTube), like at a \"Lean Together\" or something ?</p>",
        "id": 520220869,
        "sender_full_name": "Alex Kontorovich",
        "timestamp": 1748111790
    },
    {
        "content": "<p>I guess this is not happening without FRO support, but turning <code>local class</code> into a thing would be a solution maybe?<br>\n(Edit: I have in mind one more \"classes as parameters\" example: <code>CatCommSq</code> in CategoryTheory, although in this case there are sometimes some \"canonical\" instances)</p>",
        "id": 520220940,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1748111869
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"252920\">@Alex Kontorovich</span> as far as I am aware, no; I'm not sure it's ever been studied in a systematic way</p>",
        "id": 520221022,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111921
    },
    {
        "content": "<p>I am reminded of <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> 's <a href=\"https://arxiv.org/abs/2405.04699\">article</a> on how \"good style\" is different between formal proofs and informal though</p>",
        "id": 520221051,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111952
    },
    {
        "content": "<p>but it doesn't get into the nitty gritty of mathlib best practices</p>",
        "id": 520221073,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1748111979
    },
    {
        "content": "<p>I know I'm rather late here but <a href=\"https://github.com/leanprover-community/mathlib4/pull/27820\">#27820</a> turns <code>BoundingSieve</code> into a struct. I got hung up deciding what to do with the notation, but it was too much effort to get it to pretty print correctly (I'd have to define custom unexpanders for each local notation) so I've just removed the notation completely.</p>",
        "id": 532760390,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1754324737
    },
    {
        "content": "<p>Stupid question: Can't <code>notation3</code> define the unexpanders for you?</p>",
        "id": 532760756,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1754324880
    },
    {
        "content": "<p>I couldn't get it to work. The difficulty is that <code>SelbergSieve</code> extends <code>BoundingSieve</code> and I want notation that works whichever one I'm working with. You can do this by making the notation unhygienic and using dot notation, but this breaks the unexpanders.</p>",
        "id": 532762164,
        "sender_full_name": "Arend Mellendijk",
        "timestamp": 1754325431
    }
]