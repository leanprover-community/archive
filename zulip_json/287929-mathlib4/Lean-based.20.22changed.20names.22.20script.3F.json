[
    {
        "content": "<p>WDYT about running something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Environment</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">withImportModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">hasMacroScopes</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">isInternal</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">c</span>\n</code></pre></div>\n<p>(TODO: sort alphabetically), upload these files for <code>master</code> somewhere, then <code>diff</code>ing <code>master</code> to <code>HEAD</code> in the CI?</p>",
        "id": 505878694,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067310
    },
    {
        "content": "<p>(instead of the current text search in <code>git diff</code>)</p>",
        "id": 505878719,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067339
    },
    {
        "content": "<p>This will catch stuff like \"<code>simps</code> gnerates different set of lemmas now\" or \"<code>to_additive</code> chose a different name for the additive version\".</p>",
        "id": 505878853,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067432
    },
    {
        "content": "<p>Or \" I accidentally changed namespaces\"</p>",
        "id": 505878898,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1742067469
    },
    {
        "content": "<p>BTW, what's the right way to sort it in Lean?</p>",
        "id": 505879007,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067538
    },
    {
        "content": "<p>For <a href=\"https://github.com/leanprover-community/mathlib4/pull/22461\">#22461</a>, I used <code>lake exe print_decls | sort</code></p>",
        "id": 505879192,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067690
    },
    {
        "content": "<p>See also <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/What.27s.20the.20right.20way.20to.20print.20lots.20of.20lines.3F/with/505865588\">#lean4 &gt; What's the right way to print lots of lines?</a>  for a thread where I asked why my script was slow (answer: because I was running it inside <code>#eval</code>).</p>",
        "id": 505879270,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742067743
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> is working on a rewrite of the \"declarations diff\" script in Lean - and if I understood correctly, this would also catch such versions, right?</p>",
        "id": 505882846,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1742070541
    },
    {
        "content": "<p>The relevant PR is <a href=\"https://github.com/leanprover-community/mathlib4/pull/22464\">#22464</a>, but I have not checked how different that is from what Yury wants.</p>",
        "id": 505883121,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1742070757
    },
    {
        "content": "<p>The file is not actually persisted: the script creates one for master and one for the PR, sorts them and then lets <code>diff</code> do the rest.</p>",
        "id": 505883182,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1742070799
    },
    {
        "content": "<p>By the way, the script that I use in that PR is indeed slow: if there is anything in there that is useful to you, feel free to take it or push over it!</p>",
        "id": 505883336,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1742070919
    },
    {
        "content": "<p>I'll try to speed it up tonight.</p>",
        "id": 505885976,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742073087
    },
    {
        "content": "<p>This executable runs in 4-5s:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"sd\">/-- A copy of `isAutoDecl` from Batteries that takes `env` as an argument</span>\n<span class=\"sd\">instead of using `getEnv`.</span>\n\n<span class=\"sd\">TODO: upstream. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">isAutoDecl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">hasMacroScopes</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">isInternal</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isReservedName</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"proof_\"</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"match_\"</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"unsafe_\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">isConstructor</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"injEq\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"inj\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"sizeOf_spec\"</span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ConstantInfo</span><span class=\"bp\">.</span><span class=\"n\">inductInfo</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"brecOn_\"</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"below_\"</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"binductionOn_\"</span>\n<span class=\"w\">        </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"ibelow_\"</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">casesOnSuffix</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">recOnSuffix</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">brecOnSuffix</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">binductionOnSuffix</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">belowSuffix</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"ibelow\"</span><span class=\"o\">,</span>\n<span class=\"w\">          </span><span class=\"s2\">\"ndrec\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"ndrecOn\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"noConfusionType\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"noConfusion\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"ofNat\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"toCtorIdx\"</span>\n<span class=\"w\">        </span><span class=\"o\">]</span><span class=\"bp\">.</span><span class=\"n\">any</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">isSubobjectField?</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">mkSimple</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">  </span><span class=\"n\">pure</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">withImportModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">fold</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ar</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isAutoDecl</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">ar</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">ar</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">    </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"bp\">.</span><span class=\"n\">qsortOrd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">name</span>\n</code></pre></div>",
        "id": 505907645,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742091557
    },
    {
        "content": "<p>I'm tired after the flight (it got delayed for ~2h30m), so I can't test if it speeds up your <code>bash</code> script (git checkout + getting cache takes time too) tonight.</p>",
        "id": 505907806,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742091712
    },
    {
        "content": "<p>Your Lean script takes ~50s on my laptop, probably because of the insertion sort.</p>",
        "id": 505914021,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742096940
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> WDYT about adding a version of <code>isAutoDecl</code> that takes an environment as an argument instead of relying on <code>getEnv</code>?</p>",
        "id": 505914613,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742097469
    },
    {
        "content": "<p>what's the motivation? Can't you just pass in a monad reader state containing the <code>env</code> of your choice?</p>",
        "id": 505914696,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742097544
    },
    {
        "content": "<p>My motivation is \"I don't know how to do it\". Probably, it's a wrong motivation.</p>",
        "id": 505915251,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742097946
    },
    {
        "content": "<p>Another solution (for me) would be adding instructions on how to run a chunk of code in a context with <code>← getEnv</code> returning a given <code>env</code> to the docstring of <code>getEnv</code>.</p>",
        "id": 505915819,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742098445
    },
    {
        "content": "<p>Is it <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.withEnv#doc\">docs#Lean.withEnv</a> ?</p>",
        "id": 505916197,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742098791
    },
    {
        "content": "<p>yes, that will do it</p>",
        "id": 505916254,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1742098823
    },
    {
        "content": "<p>One more question: how do run <code>CoreM</code> code from inside a pure function?</p>",
        "id": 505916469,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742099033
    },
    {
        "content": "<p>Found <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Core.CoreM.toIO#doc\">docs#Lean.Core.CoreM.toIO</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CoreM.withImportModules#doc\">docs#CoreM.withImportModules</a></p>",
        "id": 505916698,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742099171
    },
    {
        "content": "<p>This prints nothing :(</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">CoreM</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"bp\">.</span><span class=\"n\">withImportModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"ss\">`Mathlib</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trustLevel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">flip</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">foldM</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">ar</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Lint</span><span class=\"bp\">.</span><span class=\"n\">isAutoDecl</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">ar</span><span class=\"bp\">.</span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">ar</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"bp\">.</span><span class=\"n\">qsortOrd</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">name</span>\n</code></pre></div>\n<p>... and I don't know how to debug meta code.</p>",
        "id": 505917738,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742099985
    },
    {
        "content": "<p>I think the reason is in the docstring of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.withImportModules#doc\">docs#Lean.withImportModules</a>: \"No live references to the environment object or imported objects may exist after <code>act</code> finishes.\" In your case, the reference to the environment object is in <code>ar.push name.toString</code>. Replacing that with <code>ar.push name.toString.toName.toString</code> makes it work, I am guessing that <code>s.toName.toString</code> is implemented sufficiently not-in-place, that it creates a new memory reference.</p>",
        "id": 505942176,
        "sender_full_name": "Christian Merten",
        "timestamp": 1742119677
    },
    {
        "content": "<p>(note: I still don't understand why making a pure version of <code>isAutoDecl</code> is a bad idea; e.g., this will make it clear that the function doesn't depend on other parts of the context, only on <code>env</code>)</p>",
        "id": 505961315,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1742134402
    }
]