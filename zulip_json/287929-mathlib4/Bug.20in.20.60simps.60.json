[
    {
        "content": "<p>We've found this bug which seems to appear if a structure has a structure-typed field the name of which is a prefix of another field.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyStruct</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">bar_b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps</span><span class=\"kd\">]</span><span class=\"w\">  </span><span class=\"c1\">-- Error Failed to find constructor b in structure Fin.</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">set_foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyStruct</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyStruct</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>\n<p>Has anyone seen this before?</p>\n<p>cc <span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span></p>",
        "id": 558516863,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1763668517
    },
    {
        "content": "<p>that's a very weird bug, i haven't seen that before... let me add to it that if you move the field <code>bar_b</code> <em>after</em> <code>bar</code>, the error seems to disappear? (on live lean at least)</p>",
        "id": 558527628,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1763672354
    },
    {
        "content": "<p>It also disappears if I name it <code>bar_2</code> instead, it seems super cursed</p>",
        "id": 558527788,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1763672406
    },
    {
        "content": "<p>(btw, your error is inconsistent with the name of your field)</p>",
        "id": 558527953,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1763672459
    },
    {
        "content": "<p>(i.e. it should be <code>bar_baz</code> or <code>Failed to find constructor b in structure Fin.</code>. It seems you (accidentally?) edited it)</p>",
        "id": 558528062,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1763672490
    },
    {
        "content": "<p>a first guess as to why this happens: <code>@[simps]</code> generates lemmas and names them <code>[def_name]_[projection_name]_[projection_name]</code>, and this specific naming causes there to be a clash</p>",
        "id": 558529102,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1763672878
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Bug.20in.20.60simps.60/near/558528062\">said</a>:</p>\n<blockquote>\n<p>(i.e. it should be <code>bar_baz</code> or <code>Failed to find constructor b in structure Fin.</code>. It seems you (accidentally?) edited it)</p>\n</blockquote>\n<p>Ah, yes sorry, minimized it some more afterwards</p>",
        "id": 558529199,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1763672922
    },
    {
        "content": "<p>and then this clash <span aria-label=\"sparkles\" class=\"emoji emoji-2728\" role=\"img\" title=\"sparkles\">:sparkles:</span>somehow<span aria-label=\"sparkles\" class=\"emoji emoji-2728\" role=\"img\" title=\"sparkles\">:sparkles:</span> causes this weird error rather than failing gracefully</p>",
        "id": 558529275,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1763672959
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110789\">Jakob von Raumer</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Bug.20in.20.60simps.60/near/558529199\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Bug.20in.20.60simps.60/near/558528062\">said</a>:</p>\n<blockquote>\n<p>(i.e. it should be <code>bar_baz</code> or <code>Failed to find constructor b in structure Fin.</code>. It seems you (accidentally?) edited it)</p>\n</blockquote>\n<p>Ah, yes sorry, minimized it some more afterwards</p>\n</blockquote>\n<p>tbh i think <code>bar_baz</code> illustrates the correspondence between the error and the code more clearly...</p>",
        "id": 558529424,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1763673019
    },
    {
        "content": "<p>I guess that <code>simps</code> is doing some really cursed name handling</p>",
        "id": 558554743,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763684632
    },
    {
        "content": "<p>Also, if we use a non-structure instead of <code>Fin 5</code>, then it <code>panic</code>s.</p>",
        "id": 558557988,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1763686422
    },
    {
        "content": "<p>This is indeed a bug in <code>simps</code>.</p>\n<p>I think the main problems here are that:<br>\n(1) the naming scheme is ambiguous in edge cases, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyStruct</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">bar_b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n<span class=\"w\">  </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps</span><span class=\"w\"> </span><span class=\"n\">bar_b</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"c1\">-- which projection do you want here?</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">set_foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyStruct</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MyStruct</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>(2) The internal representation <code>simps</code> used for what projection you want is just a string, and it assumes that this is unambiguous. <br>\n(3) There is not enough logic to catch all errors, causing it to fail ungracefully.</p>\n<p>The weird behavior with numbers was a workaround added in <a href=\"https://github.com/leanprover-community/mathlib4/pull/15095\">#15095</a> when people ran into a similar issue.</p>\n<p>(2) + (3) can be fixed, and I can add some logic that <code>simps</code> tries to use the longest matching projection. E.g. when you want projection <code>bar_b_baz</code>, and both <code>bar</code> and <code>bar_b</code> are projections of your current structure, then it will <em>only</em> consider <code>bar_b</code>, not <code>bar</code>. I could even add a rule to the parser that <code>bar__b_baz</code> will consider projection <code>bar</code> only.</p>",
        "id": 558639136,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1763725063
    },
    {
        "content": "<p>Surely it would be much easier if we used the syntax <code>@[simps bar.b]</code> (where <code>bar.b</code> is parsed as an <code>ident</code>)?</p>",
        "id": 558667379,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1763733869
    },
    {
        "content": "<p>In our a case, another workaround would also be a simps <code>simps</code> argument which restricts the \"depth\" to 1</p>",
        "id": 558833496,
        "sender_full_name": "Jakob von Raumer",
        "timestamp": 1763835345
    }
]