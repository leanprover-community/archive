[
    {
        "content": "<p>I want to see what the community thinks about this, and maybe get a consensus, before I move on. In <a href=\"https://github.com/leanprover-community/mathlib4/pull/25218/files#r2119555307\">this comment about a PR of mine</a>, we've raised the question of whether lemmas of the following form should be tagged with <code>@[simp]</code> or not:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">variableChange_a₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">u</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">W</span><span class=\"bp\">.</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">variableChange_a₄</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">a₄</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">    </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">u</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">W</span><span class=\"bp\">.</span><span class=\"n\">a₄</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"bp\">.</span><span class=\"n\">a₃</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"bp\">.</span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"bp\">.</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">      </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">.</span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>For more context, <code>W</code> is a Weierstrass equation for an elliptic curve, and <code>C</code> is a change of variables. And these lemmas are about the coefficients in the new equation.</p>\n<p>Currently they are <code>@[simp]</code>, but I felt like it was undesirable, so I removed it. It's because in my PR I created some specific instances of change of variables such as <code>toTateNF</code>, and I would want to be able to use my custom simp lemmas such as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">toTateNF_a₄</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">W</span><span class=\"bp\">.</span><span class=\"n\">toTateNF</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">a₄</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>If the first lemmas are <code>@[simp]</code>, then the LHS of my new lemma would be unstable, and <code>simp</code> would not be able to use it. Instead, <code>simp</code> would destruct the LHS so that it wouldn't match the form here anymore, and it would have to use more simp lemmas and more rewrites to get the job done, which I see as inefficient.</p>\n<p>So now <span class=\"user-mention\" data-user-id=\"479359\">@Michael Stoll</span> suggested that I can make a custom simp set for the first lemmas, which brings me to the following two problems:</p>\n<ol>\n<li>I feel like I should ask the community before creating a custom simp set. I looked at <a href=\"https://github.com/leanprover-community/mathlib4/blob/06aa379ba3b26c7fd256a1605dd9d443a45be4ed/Mathlib/Tactic/Attr/Register.lean\">the current file with the list of simp attributes</a> and it seemed rather short and I don't know if anyone can/should just add more simp attributes.</li>\n<li>If we include lemmas of the form <code>(C • W).a₄ = _</code> in the simp set, where would <code>(W.toTateNF P • W).a₄ = 0</code> go? Would it just be tagged with the usual simp? Would it go in the simp set as well? If it went to the same simp set, it would defeat the very purpose of this in the first place, where I complained above that simp would destruct the LHS of <code>(W.toTateNF P • W).a₄ = 0</code> before I could apply this lemma.</li>\n</ol>\n<p>(Pinging the relevant people: <span class=\"user-mention\" data-user-id=\"464700\">@David Ang</span> <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> <span class=\"user-mention\" data-user-id=\"366779\">@Jz Pan</span> <span class=\"user-mention\" data-user-id=\"479359\">@Michael Stoll</span>)</p>",
        "id": 521714805,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1748862309
    },
    {
        "content": "<p>Summary: I want to remove <code>@[simp]</code> from <code>(C • W).a₁ = _</code>, because I want to add <code>@[simp]</code> to <code>(W.toTateNF P • W).a₄ = 0</code>, and someome suggested making a custom simp set instead.</p>",
        "id": 521714969,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1748862362
    },
    {
        "content": "<p>I personally agree that <code>variableChange_a₁</code> shouldn't be simp. I also had times where I want <code>variableChange_inv_a₁</code> (not in mathlib but you can probably guess what it says; in particular it has no <code>⁻¹</code> in the RHS) etc to fire instead.</p>",
        "id": 521715440,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1748862491
    },
    {
        "content": "<p>I think it's reasonable to remove <code>@[simp]</code> of them if they are not simpler. At first they are actually auto generated from <code>@[simps]</code>.</p>\n<p>Indeed in normal forms file, I've already noticed that if they are all simp lemmas, then the more complex ones actually shadows more simpler ones. So they are only selectively <code>@[simp]</code> (and the choice is not optimal I think).</p>",
        "id": 521725495,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748865508
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"366779\">@Jz Pan</span> the linter wouldn't accept conflicting simps anyway</p>",
        "id": 521726798,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1748865821
    },
    {
        "content": "<p>The changes to the simpNF linter in <a href=\"https://github.com/leanprover-community/batteries/pull/1220\">https://github.com/leanprover-community/batteries/pull/1220</a> also raise a lot of flags about elliptic curves.<br>\nI would be in favour of a redesign of the simp set in that part of the library.</p>",
        "id": 521727242,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1748865925
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> thanks for the comment. how would you arrange the simp sets? would we have one simp set for <code>(C • W).a₁</code> and another simp set for <code>(W.toTateNF P • W).a₄</code>?</p>",
        "id": 521729032,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1748866381
    },
    {
        "content": "<p>I haven't thought about what they should look like... <span aria-label=\"oops\" class=\"emoji emoji-1f643\" role=\"img\" title=\"oops\">:oops:</span></p>",
        "id": 521729428,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1748866479
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60.40.5Bsimp.5D.60.20for.20variable.20changes.20in.20Elliptic.20curves/near/521726798\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"366779\">Jz Pan</span> the linter wouldn't accept conflicting simps anyway</p>\n</blockquote>\n<p>Those different simp lemmas assume different normal forms on the equation, as typeclass instances. For example you can see <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/AlgebraicGeometry/EllipticCurve/NormalForms.html#WeierstrassCurve.b%E2%82%82_of_isCharNeTwoNF\">WeierstrassCurve.b₂_of_isCharNeTwoNF</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/AlgebraicGeometry/EllipticCurve/NormalForms.html#WeierstrassCurve.b%E2%82%82_of_isShortNF\">WeierstrassCurve.b₂_of_isShortNF</a>. They require instances <code>IsCharNeTwoNF</code> and <code>IsShortNF</code>, respectively. But <code>IsShortNF</code> implies <code>IsCharNeTwoNF</code> (which is also an instance). So these two results cannot be both simp lemmas otherwise there will be a complain. Currently <code>b₂_of_isCharNeTwoNF</code> is a simp lemma while <code>b₂_of_isShortNF</code> is not. There are a lot of such cases in <code>NormalForms</code> file...</p>",
        "id": 521729483,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748866495
    },
    {
        "content": "<p>And it turns out that one cannot rely on simp lemmas, but spell out such results manually according to what normal forms it have...</p>",
        "id": 521729789,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748866573
    },
    {
        "content": "<p>But in your case it is confluent because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WeierstrassCurve#doc\">docs#WeierstrassCurve</a>.a₂_of_isShortNF is simp (so <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WeierstrassCurve#doc\">docs#WeierstrassCurve</a>.b₂_of_isShortNF need not be a simp)</p>",
        "id": 521730268,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1748866684
    },
    {
        "content": "<blockquote>\n<p>But in your case it is confluent</p>\n</blockquote>\n<p>Yeah it was. But it seems that as the number of different normal forms increases they quickly become non-confluent...</p>",
        "id": 521731808,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748867051
    },
    {
        "content": "<p>For example there are some results in that file depending on characteristics. None of them can be simp lemmas since they conflict...</p>",
        "id": 521732850,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748867294
    },
    {
        "content": "<p>why would the linter complain if they have conflicting assumptions?</p>",
        "id": 521733733,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1748867527
    },
    {
        "content": "<p>I think the <code>a₂ = 0</code> lemmas in my experiment about nodal cubics etc in char 2 and char 3 works fine because similar reasons imply that they are confluent.</p>",
        "id": 521734062,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1748867617
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60.40.5Bsimp.5D.60.20for.20variable.20changes.20in.20Elliptic.20curves/near/521733733\">said</a>:</p>\n<blockquote>\n<p>why would the linter complain if they have conflicting assumptions?</p>\n</blockquote>\n<p>For example, I have a result which is true for general characteristic, and it's <code>3 * something</code> (say), and another result only holds for char 3 and it's <code>0</code>. Another example is <code>4 * something</code> vs <code>something</code>.</p>",
        "id": 521743745,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748869995
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60.40.5Bsimp.5D.60.20for.20variable.20changes.20in.20Elliptic.20curves/near/521734062\">said</a>:</p>\n<blockquote>\n<p>I think the <code>a₂ = 0</code> lemmas in my experiment about nodal cubics etc in char 2 and char 3 works fine because similar reasons imply that they are confluent.</p>\n</blockquote>\n<p>Yeah, I think results which reduces to fixed values <code>0</code> or <code>1</code> etc. are generally safe for simp lemmas.</p>",
        "id": 521744049,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748870070
    },
    {
        "content": "<p>FWIW I am happy to have the <code>simp</code>s removed for the default <code>variableChange_a.*</code> lemmas. There will likely be a lot of normal forms coming soon, so dealing with this earlier with custom simp-sets might be a good idea, but I don't know how to write them.</p>",
        "id": 522159202,
        "sender_full_name": "David Ang",
        "timestamp": 1748965378
    },
    {
        "content": "<p>Simp sets could be always added later. For now maybe just spell them out manually.</p>",
        "id": 522167427,
        "sender_full_name": "Jz Pan",
        "timestamp": 1748967637
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> Would you be happy with the change proposed above, which removes <code>simp</code> for <code>variableChange_a*</code> lemmas? i.e. <a href=\"https://github.com/leanprover-community/mathlib4/blob/48d79931ac3d59c7bd2bafba5ac5aa20a6c505b7/Mathlib/AlgebraicGeometry/EllipticCurve/VariableChange.lean#L173-L190\">Mathlib/AlgebraicGeometry/EllipticCurve/VariableChange.lean#L173-L190</a></p>\n<p>(PS: I think the <code>variableChange_b₂</code> and similar lemmas should also have <code>simp</code> removed too...)</p>",
        "id": 522220005,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1748987034
    },
    {
        "content": "<p>i'm happy to do this as a separate PR on its own</p>",
        "id": 522220084,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1748987067
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110064\">@Kenny Lau</span> yes, that sounds good to me!</p>",
        "id": 522261838,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749011148
    },
    {
        "content": "<p>ok i'm getting to this in these two days</p>",
        "id": 523954775,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749823827
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">variableChange_j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">•</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">W</span><span class=\"bp\">.</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>",
        "id": 523954812,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749823838
    },
    {
        "content": "<p>it seems like i can leave the <code>@[simp]</code> for this, because this time the RHS is actually simpler <span aria-label=\"melt\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"melt\">:melt:</span></p>",
        "id": 523954855,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749823853
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/25847\">#25847</a> created</p>",
        "id": 523958569,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749825151
    }
]