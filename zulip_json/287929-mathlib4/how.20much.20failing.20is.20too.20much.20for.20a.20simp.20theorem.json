[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24558\">#24558</a> removes <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Set.insert_eq_of_mem#doc\">docs#Set.insert_eq_of_mem</a> from the simp theorems. From the benchmark, we see that ~1/1000 = 0.1% of the total instructions in mathlib are from Lean attempting unification with <code>insert_eq_of_mem</code> whenever the keys <code>@insert _ (Set _) _ _ _</code> are found in a subterm. We will see this n times for <code>({a₁, a₂, ..., aₙ} : Set α)</code>.</p>\n<p>What should be done? I don't think that 1/1000 for a single simp theorem is <strong>not</strong> sustainable. We can remove it from the simp theorems but it can maybe also be improved if <code>{}</code> used an <code>Insert.insert</code> with a signature of the form <code>ℕ → α → γ → γ</code></p>",
        "id": 516678260,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746625005
    },
    {
        "content": "<p>Is it possible to see if the failures come from a long time spent trying to solve the side assumption <code>(h : a ∈ s)</code> in complicated cases, or if it's the mere application of the lemma which is costly?</p>",
        "id": 516680427,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1746625507
    },
    {
        "content": "<p>Poking at it now</p>",
        "id": 516680771,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746625586
    },
    {
        "content": "<p>Actually it appears that it cannot discharge the side condition with it in the local context but only with it being manually fed into <code>simp</code>.</p>",
        "id": 516681376,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746625733
    },
    {
        "content": "<p>Eg </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Data.Set.Insert</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">h</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- succeeds</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\">  </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 516681671,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746625802
    },
    {
        "content": "<p><code>simp</code> doesn't use context to discharge side conditions by default, unless you use <code>simp [h]</code> or <code>simp [*]</code>.</p>",
        "id": 516683895,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746626376
    },
    {
        "content": "<p>Shoult it be replaced by a <code>simp_proc</code> that only works for <code>{a, b, c}</code>?</p>",
        "id": 516684359,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746626484
    },
    {
        "content": "<p>I think a better way to test for Sebastien's theory is to test how simp behaves on <code>{1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1}</code></p>",
        "id": 516685201,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746626696
    },
    {
        "content": "<p>I think it's unavoidable quadratic, but maybe we're doing worse than that, or our constant term is bad</p>",
        "id": 516686067,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746626905
    },
    {
        "content": "<p>a simproc just working to discharge <code>a ∈ univ</code>, and <code>a ∈ s</code> if it's in the context, and for sets with 1, 2 or 3 elements, would already cover most reasonable applications of the lemma. If <code>s</code> is very complicated and simp works hard to check whether <code>a ∈ s</code> holds, I'm not surprised this can be costly quite quickly.</p>",
        "id": 516687202,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1746627155
    },
    {
        "content": "<p>some profiling suggests it is indeed asymptotically as expected:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"c1\">-- 0.257972s</span>\n<span class=\"bp\">#</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"c1\">-- 0.825771s</span>\n<span class=\"bp\">#</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"c1\">-- 3.288878s</span>\n<span class=\"bp\">#</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">21</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">26</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">27</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">34</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">35</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">38</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">400000</span>\n<span class=\"c1\">-- 14.628687s</span>\n<span class=\"bp\">#</span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">15</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">21</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">26</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">27</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">28</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">31</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">33</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">34</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">35</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">38</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">39</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">41</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">43</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">44</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">45</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">46</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">47</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">49</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">50</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">51</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">52</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">53</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">54</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">55</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">56</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">57</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">58</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">59</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">60</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">61</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">62</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">63</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">64</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">65</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">66</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">67</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">68</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">69</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">70</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">71</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">72</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">73</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">74</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">75</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">76</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">77</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">78</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">79</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"o\">,</span>\n<span class=\"w\">        </span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 516687688,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746627251
    },
    {
        "content": "<p>I think that it will be slow even without <code>1</code> at the end.</p>",
        "id": 516688300,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746627371
    },
    {
        "content": "<p>It's about 30% faster if you reduce the import to <code>import Mathlib.Data.Set.Insert</code>, so perhaps something else is making things slow here</p>",
        "id": 516688665,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746627458
    },
    {
        "content": "<p>I guess, it has more theorems to match <code>a ∈ _</code> with.</p>",
        "id": 516688891,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746627500
    },
    {
        "content": "<p>Yeah, inserting <code>100 ∈</code> in front of each <code>#simp</code> barely moves the time</p>",
        "id": 516690189,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746627757
    },
    {
        "content": "<p>Presumably that should be a higher priority simp lemma than <code>Set.insert_eq_of_mem</code>?</p>",
        "id": 516690430,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746627809
    },
    {
        "content": "<p>There's no point running O(n^2) dedupication to conclude an O(n) membership</p>",
        "id": 516690544,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746627827
    },
    {
        "content": "<p>What does <code>simp</code> do to <code>f (g x)</code> if it can apply a low prio lemma to <code>g x</code> or a high prio lemma to <code>f (g x)</code>?</p>",
        "id": 516691166,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746627949
    },
    {
        "content": "<p><code>attribute [simp↓] Set.mem_insert_iff</code> makes the above faster for the <code>100 ∈</code> case</p>",
        "id": 516691363,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746627986
    },
    {
        "content": "<p>Indeed, priority is the wrong tool, it still applies the inner low priority lemma first</p>",
        "id": 516691724,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746628051
    },
    {
        "content": "<p>What's the performance cost of removing <code>@[simp]</code> on  <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.insert_eq_of_mem#doc\">docs#Finset.insert_eq_of_mem</a> too? (I'm on board with both changes)</p>",
        "id": 516755694,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746647595
    },
    {
        "content": "<p>I would be sad to see this particular lemma desimped. I use it quite frequently with simp being fed a membership hypothesis.</p>",
        "id": 516866980,
        "sender_full_name": "Peter Nelson",
        "timestamp": 1746701939
    },
    {
        "content": "<p>Can we make it faster but less powerful by using a cheaper tactic for the side goal?</p>",
        "id": 517004651,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1746752254
    },
    {
        "content": "<p>Why isn't the simp normal form <code>insert a s = {a} ∪ s</code>?</p>",
        "id": 517836174,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1747144130
    },
    {
        "content": "<p>I guess, because <code>{a, b, c}</code> looks better than <code>{a} \\cup {b} \\cup {c}</code>.</p>",
        "id": 517852342,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747147950
    },
    {
        "content": "<p>Can it be simp normal form with an appropriate delaborator then?</p>",
        "id": 517869672,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747152178
    },
    {
        "content": "<p>What will it change for the purpose of this discussion?</p>",
        "id": 517871305,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747152619
    },
    {
        "content": "<p>I mean, if we change the simp normal form to use unions, then we'll get to \"should <code>a \\in s -&gt; {a} \\cup s = s</code> be a simp lemma?\"</p>",
        "id": 517871554,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1747152698
    }
]