[
    {
        "content": "<p>There is an error in <a href=\"https://github.com/leanprover-community/mathlib4/pull/25780\">#25780</a> that I can't figure out. We're trying to apply <code>Presheaf.colimitOfRepresentable</code> to a simplicial set (a special case of a presheaf). </p>\n<p>We think the problem may be some sort of universe error. </p>\n<p>In a discussion over the infinity-cosmos channel <span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> said:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/455414-Infinity-Cosmos/topic/challenge.3A.20eight.20sorries.20away.20from.20product-preserving/near/530700317\">said</a>:</p>\n<blockquote>\n<p>I'm also a little confused by lean's refusal to see <code>X</code> as something of type <code>?_ᵒᵖ ⥤ Type ?u</code> after <code>Presheaf.colimitOfRepresentable</code>. If I try to recreate the issue with something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trivial</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SSet</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">})</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">x</span>\n</code></pre></div>\n<p>it shows no signs of trouble.</p>\n<p>If I add a coercion of the form</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Coe</span><span class=\"w\"> </span><span class=\"n\">SSet</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">SimplexCategory</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">id</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>the application type mismatch for <code>X</code> disappears, and is replaced by a failure to synthesize a certain <code>Category</code> (which I believe, in this case, hints at the deeper universe issue I mentioned above).</p>\n<p>I wonder if the application mismatch wouldn't have occurred if the typeclass synthesis would succeed, or something strange like that? (If so, I'd suspect that something to do with backtracking and/or metavariable synthesis order/postponement was to blame...)</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span> or <span class=\"user-mention\" data-user-id=\"439483\">@Andrew Yang</span> I think one of you may have written this code, which I'll admit I don't fully understand. In particular, what is <code>CategoryTheory2</code>?</p>",
        "id": 530977646,
        "sender_full_name": "Emily Riehl",
        "timestamp": 1753551107
    },
    {
        "content": "<p>I'll also mention the universe issue itself here (which is buried in a bullet point in that thread, sorry):</p>\n<blockquote>\n<p><code>Presheaf.colimitOfRepresentable</code> makes a choice that constrains a universe in its argument to be smaller than necessary. (If it were too big, that would be fine—just ulift.) Generalizing this universe parameter in the original file seems plausible, but then the <em>whole</em> file needs to be reworked (starting all the way up at <code>functorToRepresentables</code>), <code>uliftFunctors</code> need to be inserted everywhere, potential pitfalls await, etc.</p>\n</blockquote>\n<p>To be a bit more explicit, <code>colimitOfRepresentable</code> has type</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">colimitOfRepresentable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IsColimit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">coconeOfRepresentable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>but <code>v₁</code> here is the universe level of the arrows of <code>C</code>. For <code>SimplexCategory</code>, that's <code>0</code> (or <code>1</code>?), but <code>SSet.{u}</code> is <code>SimplexCategoryᵒᵖ ⥤ Type u</code>.</p>\n<p>Ideally we would have <code>(P : Cᵒᵖ ⥤ Type v₂)</code>, but starting on that journey in <code>CategoryTheory.Limits.Presheaf</code> looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">reducible</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">functorToRepresentables</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">Elements</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">v₁</span><span class=\"w\"> </span><span class=\"n\">v₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">(</span><span class=\"n\">CategoryOfElements</span><span class=\"bp\">.</span><span class=\"n\">π</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">leftOp</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">yoneda</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Functor</span><span class=\"bp\">.</span><span class=\"n\">whiskeringRight</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">uliftFunctor</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simps</span><span class=\"kd\">]</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">coconeOfRepresentable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Cocone</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">functorToRepresentables</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">pt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"bp\">⋙</span><span class=\"w\"> </span><span class=\"n\">uliftFunctor</span>\n<span class=\"w\">  </span><span class=\"n\">ι</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">        </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">P</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">down</span><span class=\"bp\">.</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">unop</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"bp\">⟩</span>\n<span class=\"w\">      </span><span class=\"o\">}</span>\n<span class=\"w\">    </span><span class=\"o\">}</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">coconeOfRepresentable_naturality</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">P₁</span><span class=\"w\"> </span><span class=\"n\">P₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"bp\">ᵒᵖ</span><span class=\"w\"> </span><span class=\"bp\">⥤</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v₂</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P₁</span><span class=\"w\"> </span><span class=\"bp\">⟶</span><span class=\"w\"> </span><span class=\"n\">P₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P₁</span><span class=\"bp\">.</span><span class=\"n\">Elements</span><span class=\"bp\">ᵒᵖ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">coconeOfRepresentable</span><span class=\"w\"> </span><span class=\"n\">P₁</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">ι</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"bp\">≫</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"c1\">-- Application type mismatch error for `α`</span>\n<span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>which is a bit unwieldy. But maybe doable!</p>",
        "id": 530979372,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1753551989
    },
    {
        "content": "<p>I have a draft branch where I fix this particular universe issue (which is quite painful to do). I will try to PR it soon.</p>",
        "id": 530980931,
        "sender_full_name": "Joël Riou",
        "timestamp": 1753552803
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"459699\">@Joël Riou</span>. Let us know if we can help. This is the last thing blocking the construction of the strict bicategory of quasi-categories.</p>",
        "id": 531154401,
        "sender_full_name": "Emily Riehl",
        "timestamp": 1753628005
    },
    {
        "content": "<p>For the moment, do not hesitate to focus on the <code>Type 0</code> case, and it should be easy to refactor the code afterwards.</p>",
        "id": 531156116,
        "sender_full_name": "Joël Riou",
        "timestamp": 1753628676
    },
    {
        "content": "<p>I have finally managed to make <a href=\"https://github.com/leanprover-community/mathlib4/pull/27576\">#27576</a> compile. (In particular, this generalizes the construction of singular homology to topological spaces in arbitrary universes.) It is still very much a draft, not at all ready for review.</p>",
        "id": 531815326,
        "sender_full_name": "Joël Riou",
        "timestamp": 1753874216
    },
    {
        "content": "<p>This PR should now be ready for review.</p>",
        "id": 532040982,
        "sender_full_name": "Joël Riou",
        "timestamp": 1753959036
    },
    {
        "content": "<p>Will look at it. I was also interested in that result.</p>",
        "id": 532042937,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1753959654
    }
]