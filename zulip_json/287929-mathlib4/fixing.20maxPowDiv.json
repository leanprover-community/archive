[
    {
        "content": "<p>So I was working on a proof which required me to calculate various p-adic valuations. Sadly, p-adic valuations are noncomputable, butthankfully, mathlib provides padicValNat.maxPowDiv_eq_multiplicity ... : p.maxPowDiv n = multiplicity p n</p>\n<p>however, even after rewriting to maxPowDiv, lean still doesnt seem to work nicely with it, for example<br>\nlean cant prove <code>example : Nat.maxPowDiv 5 125 = 3 := by rfl</code>,  looking into maxPowDiv, I see the definition</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">maxPowDiv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">k</span>\n<span class=\"w\">  </span><span class=\"n\">termination_by</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">  </span><span class=\"n\">decreasing_by</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">div_lt_self</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">tauto</span>\n</code></pre></div>\n<p>it seems that the decreasing_by proof makes it a bit less to reduce in the kernel, so as an experiment, i try giving it fuel instead</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">maxPowDiv'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fuel'</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">fuel'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">k</span>\n</code></pre></div>\n<p>and suddenly we can do<br>\n<code>example : maxPowDiv' 5 125 = 3 := by rfl</code></p>\n<p>I am wondering if there is no reason apart from deprecation to not change to this definition for its nicer kernel properties?</p>",
        "id": 571347949,
        "sender_full_name": "Cookie Guy",
        "timestamp": 1770008511
    },
    {
        "content": "<p>I have a branch that tries to migrate to a similar definition, but I have no time to polish it for a review.</p>",
        "id": 571348236,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770008704
    },
    {
        "content": "<p>Let me open a draft PR.</p>",
        "id": 571348369,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770008815
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover-community/mathlib4/pull/34711\">#34711</a></p>",
        "id": 571348500,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770008911
    },
    {
        "content": "<p>Do you want to take over that PR? If yes, then probably the way to go is to create a branch in your fork based on my PR, then open a PR to <code>master</code>, and mention my PR.</p>",
        "id": 571348887,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770009289
    },
    {
        "content": "<p>Ok, that sounds good.</p>\n<p>I was also thinking about creating a simproc for padicValNat to reduce using maxPowDvd, so let me work on creating that too</p>",
        "id": 571349083,
        "sender_full_name": "Cookie Guy",
        "timestamp": 1770009464
    },
    {
        "content": "<p>We use <code>norm_num</code> for simplifying functions about numbers.</p>",
        "id": 571349785,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770010057
    },
    {
        "content": "<p>I.e., you should probably write a <code>norm_num</code> plugin instead of a simproc.</p>",
        "id": 571349824,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770010088
    },
    {
        "content": "<p>But the first PR should include just <a href=\"https://github.com/leanprover-community/mathlib4/pull/34711\">#34711</a> + cleanup:</p>\n<ul>\n<li>make linters happy (probably, by removing some <code>simp</code> attrs)</li>\n<li>add missing docstrings, if any</li>\n<li>restore old defs and lemmas, probably as deprecated aliases.</li>\n</ul>\n<p>Any work on meta code for computing <code>padicValNat</code> should go into a PR stacked on top of the first one.</p>",
        "id": 571354655,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770013580
    },
    {
        "content": "<p>After <a href=\"https://github.com/leanprover/lean4/pull/7965\">lean4#7965</a> fuel is no longer needed.</p>",
        "id": 571357720,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1770015482
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">semireducible</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">maxPowDiv</span><span class=\"bp\">.</span><span class=\"n\">go</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">maxPowDiv</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"mi\">125</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>",
        "id": 571358365,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1770015773
    },
    {
        "content": "<p>I wrote <a href=\"https://github.com/leanprover-community/mathlib4/pull/34711\">#34711</a> before that, then I was too lazy to adjust the proofs to a non-fuel def.</p>",
        "id": 571458987,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770045519
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"933284\">@Cookie Guy</span> Are you going to work on this? If no, then I may have a go next weekend.</p>",
        "id": 571578705,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1770098920
    },
    {
        "content": "<p>How can I check (other than <code>@[semireducible]</code> being accepted w/o a warning) that <a href=\"https://github.com/leanprover/lean4/pull/7965\">lean4#7965</a> worked on a definition? Is it visible in the <code>#print</code> output?</p>",
        "id": 575019950,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771617849
    },
    {
        "content": "<p>Answering myself by looking at the source: it uses <code>WellFounded.Nat.fix</code> instead of a generic well-founded fixpoint function.</p>",
        "id": 575021611,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1771618657
    }
]