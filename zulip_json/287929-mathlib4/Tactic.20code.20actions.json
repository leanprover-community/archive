[
    {
        "content": "<p><a href=\"https://github.com/leanprover/std4/pull/132\">std4#132</a> continues the series of code action related PRs, adding a framework for running code actions on tactics and tactic sequences. There aren't any flashy code actions implemented yet, but one simple one is the <code>Remove tactics after 'no goals'</code> code action:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">True</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">trivial</span>\n  <span class=\"n\">trivial</span> <span class=\"c1\">-- &lt;- remove this, proof is already done</span>\n  <span class=\"n\">rfl</span>\n</code></pre></div>\n<p>is transformed to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">True</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">trivial</span>\n</code></pre></div>\n<p>Note that this is elaborator-aware, and the code action will not show up unless the tactic is applied to no goals. Hopefully this will be useful when cleaning up broken proofs after a tactic gets smarter and closes more goals.</p>",
        "id": 356912778,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1683622529
    },
    {
        "content": "<p>The fun part of this implementation is the indentation sensitivity:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">skip</span>\n  <span class=\"bp\">¬∑</span> <span class=\"n\">skip</span>\n    <span class=\"n\">rfl</span>\n    <span class=\"bp\">|</span>\n</code></pre></div>\n<p>after a hypothetical \"insert library_search\" code action:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">skip</span>\n  <span class=\"bp\">¬∑</span> <span class=\"n\">skip</span>\n    <span class=\"n\">rfl</span>\n    <span class=\"n\">library_search</span>\n</code></pre></div>\n<p>as compared to:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">skip</span>\n  <span class=\"bp\">¬∑</span> <span class=\"n\">skip</span>\n    <span class=\"n\">rfl</span>\n  <span class=\"bp\">|</span>\n</code></pre></div>\n<p>which goes to</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">true</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">skip</span>\n  <span class=\"bp\">¬∑</span> <span class=\"n\">skip</span>\n    <span class=\"n\">rfl</span>\n  <span class=\"n\">library_search</span>\n</code></pre></div>\n<p>where the <code>|</code> represents the cursor position.</p>",
        "id": 356914535,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1683622943
    },
    {
        "content": "<p>Added another code action. Invoking tactic code action \"Generate an explicit pattern match for 'induction'\" in the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">induction</span> <span class=\"n\">e</span>\n</code></pre></div>\n<p>produces:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">e</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">induction</span> <span class=\"n\">e</span> <span class=\"k\">with</span>\n  <span class=\"bp\">|</span> <span class=\"n\">zero</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">done</span>\n  <span class=\"bp\">|</span> <span class=\"n\">succ</span> <span class=\"n\">n</span> <span class=\"n\">n_ih</span> <span class=\"bp\">=&gt;</span> <span class=\"n\">done</span>\n</code></pre></div>\n<p>It also works with <code>cases</code>.</p>",
        "id": 357173316,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1683699739
    },
    {
        "content": "<p>I guess we should bump the std dependency of mathlib to get access to all these goodies? Or do you have even more lined up?</p>",
        "id": 357173553,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1683699824
    },
    {
        "content": "<p>/poll How should the branches of the induction tactic be terminated?<br>\ndone<br>\nsorry<br>\n_<br>\n?_<br>\nnewline + 'done'</p>",
        "id": 357173859,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1683699915
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> They aren't merged yet, I would like to get some review on them and most of the people who could do so are indisposed</p>",
        "id": 357174090,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1683699967
    },
    {
        "content": "<p>Note that <code>_</code>/<code>?_</code> at the end of <code>induction</code> arms means something special: it postpones the proof of that branch until after the tactic, equivalently to using <code>induction e</code> on its own. In practice that means that you will not get an error on the <code>_</code> but rather on the <code>by</code> because the proof is not finished, with two subgoals remaining</p>",
        "id": 357174477,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1683700084
    },
    {
        "content": "<p>Since it's just for editing it doesn't matter too much one way or another but perhaps we want to encourage some style</p>",
        "id": 357174626,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1683700126
    },
    {
        "content": "<p>The <code>zero</code> branch is often solved <code>by simp</code>: maybe the action could be optimistic and try that...</p>",
        "id": 357175679,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1683700456
    },
    {
        "content": "<p>But the code action isn't just for induction on <code>Nat</code>, or is it?</p>",
        "id": 357176597,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1683700765
    },
    {
        "content": "<p>It seems not, but it could be even more optimistic!  For lists also simp could solve the empty case...</p>",
        "id": 357176866,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1683700841
    },
    {
        "content": "<p>Anyway, it is just a suggestion: since there is the need for human input <em>always</em> otherwise, this takes care of some completely trivial situation where you may not need to do anything else.</p>",
        "id": 357177061,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1683700909
    },
    {
        "content": "<p>Re: how to terminate the branches, it would be neat if we chose something that would be standard for other code actions to chain on! E.g. if we choose sorry, maybe sorry could be a generic starting point for other code actions, and options to replace the sorry with simp, a result from library_search, propose, etc. would pop up. (Possibly in a ‚Äúsmart‚Äù way, informed by the position of sorry in the tactic and even the outcomes of the potential suggestions.)</p>",
        "id": 357413873,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1683757235
    },
    {
        "content": "<p>Can we get a hook that checks for spare CPU capacity? :-)</p>",
        "id": 357418083,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1683759522
    },
    {
        "content": "<p>Hole and tactic code actions are now live on <code>Std</code>, although the API might not be quite stable yet and it might evolve as more code actions are added. I pushed two new simple code actions:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">True</span> <span class=\"o\">:=</span> <span class=\"n\">_</span> <span class=\"c1\">-- &lt;- \"start a tactic proof\"</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">True</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">done</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">True</span> <span class=\"bp\">‚àß</span> <span class=\"n\">True</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">constructor</span>\n  <span class=\"c1\">-- &lt;- \"add subgoals\"</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">True</span> <span class=\"bp\">‚àß</span> <span class=\"n\">True</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"n\">constructor</span>\n  <span class=\"bp\">¬∑</span> <span class=\"n\">done</span>\n  <span class=\"bp\">¬∑</span> <span class=\"n\">done</span>\n</code></pre></div>",
        "id": 358624431,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684214507
    },
    {
        "content": "<p>and bors is working on <a href=\"https://github.com/leanprover-community/mathlib4/pull/4012\">!4#4012</a> which brings these all to mathlib4!</p>",
        "id": 358624711,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684214649
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20code.20actions/near/357413873\">said</a>:</p>\n<blockquote>\n<p>Re: how to terminate the branches, it would be neat if we chose something that would be standard for other code actions to chain on! E.g. if we choose sorry, maybe sorry could be a generic starting point for other code actions, and options to replace the sorry with simp, a result from library_search, propose, etc. would pop up. (Possibly in a ‚Äúsmart‚Äù way, informed by the position of sorry in the tactic and even the outcomes of the potential suggestions.)</p>\n</blockquote>\n<p>Code actions are currently doing a bit of both here. They are somewhat loose regarding what constitutes a tactic sequence terminator (the one I just pushed supports <code>done</code>, <code>sorry</code>, <code>admit</code> and nothing at the end of a tactic sequence), and will also preserve the user's preference where possible (an example of this is in the induction auto-fill code action which uses <code>_</code> if you used <code>_</code>, <code>?_</code> if you used <code>?_</code> and <code>sorry</code> if you used <code>sorry</code>). So while yes, we certainly want code actions to be chainable, they should also be somewhat non-prescriptive regarding different lean styles</p>",
        "id": 358625116,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684214851
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Scott Morrison</span> Actually you might want to bump <a href=\"https://github.com/leanprover-community/mathlib4/pull/4012\">!4#4012</a> again if you want the other code actions, currently it only has \"try this\" I think</p>",
        "id": 358625264,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684214913
    },
    {
        "content": "<p>I bumped (again, twice).</p>",
        "id": 358632565,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684218076
    },
    {
        "content": "<p>Code actions have landed in mathlib4!</p>",
        "id": 358983386,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684329966
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Std</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">:</span> <span class=\"n\">True</span> <span class=\"o\">:=</span> <span class=\"n\">_</span>\n</code></pre></div>",
        "id": 358985951,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684330647
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/KLUmjBYi_thU37MB3KVT4U-r/foo.gif\">Library search code action</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/KLUmjBYi_thU37MB3KVT4U-r/foo.gif\" title=\"Library search code action\"><img src=\"/user_uploads/3121/KLUmjBYi_thU37MB3KVT4U-r/foo.gif\"></a></div>",
        "id": 359413668,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684420385
    },
    {
        "content": "<p>I mean, can we actually deploy this as is? I'm guessing we are going to conclude that it is unkind to people's CPUs and battery life if every time you put you cursor on a <code>_</code> or <code>sorry</code>, <code>library_search</code> runs in the background...</p>\n<p>I would sure like to, however. :-)</p>",
        "id": 359415209,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684420773
    },
    {
        "content": "<p>(it is worth noting that <code>library_search</code> is vastly more performant than you are used to, if you haven't been using it in the last few weeks)</p>",
        "id": 359415396,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684420823
    },
    {
        "content": "<p>I need a new computer anyway ;)</p>",
        "id": 359415615,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1684420888
    },
    {
        "content": "<p>More seriously, can we put the automatic library search behind some optional configuration?</p>",
        "id": 359415870,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1684420952
    },
    {
        "content": "<p>Yes, we could certainly put this behind a <code>set_option</code>.</p>",
        "id": 359416635,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684421147
    },
    {
        "content": "<p>There's not really a convenient mechanism for individuals to run mathlib with different options than the default, however.</p>",
        "id": 359416828,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684421183
    },
    {
        "content": "<p>You could test for an environment variable??? Try to ask the OS if there are spare CPUs? :-)</p>",
        "id": 359417118,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684421268
    },
    {
        "content": "<p>Can it be done with an option in the vscode extensions perhaps?</p>",
        "id": 359417977,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1684421478
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Scott Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20code.20actions/near/359417118\">said</a>:</p>\n<blockquote>\n<p>You could test for an environment variable??? Try to ask the OS if there are spare CPUs? :-)</p>\n</blockquote>\n<p>Checking for spare CPUs still doesn't help with battery life, unfortunately.</p>",
        "id": 359418594,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1684421603
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Scott Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20code.20actions/near/359416828\">said</a>:</p>\n<blockquote>\n<p>There's not really a convenient mechanism for individuals to run mathlib with different options than the default, however.</p>\n</blockquote>\n<p>I'd prefer to have this fixed by addressing this issue...</p>",
        "id": 359419107,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1684421706
    },
    {
        "content": "<p>Different options interacts somewhat scarily with caching. Do you refuse to use the olean cache? Or just hope for the best?</p>",
        "id": 359419290,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684421750
    },
    {
        "content": "<p>Ah, I see.</p>",
        "id": 359419439,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1684421783
    },
    {
        "content": "<p>Well, where I have really wanted this is in my own tiny mathlib-dependent projects, where caching isn't an issue. But maybe indeed it wouldn't be useful for the problem at hand here</p>",
        "id": 359419738,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1684421859
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Scott Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Tactic.20code.20actions/near/359415209\">said</a>:</p>\n<blockquote>\n<p>I mean, can we actually deploy this as is? I'm guessing we are going to conclude that it is unkind to people's CPUs and battery life if every time you put you cursor on a <code>_</code> or <code>sorry</code>, <code>library_search</code> runs in the background...</p>\n<p>I would sure like to, however. :-)</p>\n</blockquote>\n<p>For the version shown here, I see no reason why it would need to run in the background</p>",
        "id": 359426820,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684423568
    },
    {
        "content": "<p>I agree with Mario. Shouldn't the computation happen <em>after</em> you click the \"use library_search\" button?</p>",
        "id": 359448494,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1684428960
    },
    {
        "content": "<p>But I'd prefer not to even see a pop-up if library_search isn't going to solve it. I want the information of \"there is an easy proof from here\", not \"save 14 keystrokes\".</p>",
        "id": 359462276,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1684432555
    },
    {
        "content": "<p>I think that should be an option, <code>set_option keep_me_warm_in_the_winter true</code></p>",
        "id": 359465417,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684433446
    },
    {
        "content": "<p>you may as well run <code>tidy</code> or <code>aesop</code> or other general purpose automation for that</p>",
        "id": 359465605,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684433502
    },
    {
        "content": "<p>But if any other code action applies (like your example already shows!), you only see whether <code>library_search</code> works after you click the lightbulb. So for your wish we would need additional tooling. <br>\nYour behavior sounds useful, but should probably not be the default.</p>",
        "id": 359465831,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1684433557
    },
    {
        "content": "<p>Does it make sense to have vscode extension preferences for things like ‚Äúrun library search before clicking the lightbulb‚Äù? (Is there a way to make such preferences extensible, so you don‚Äôt need to PR the extension each time you want to add a preference?) This seems like an extension behavior/UI configuration, after all, not a mathlib configuration per se.</p>",
        "id": 359466050,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1684433638
    },
    {
        "content": "<p>I think it would make sense to be able to set lean options in the VSCode extension settings, yes</p>",
        "id": 359466784,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684433848
    },
    {
        "content": "<p>Of course you have to be careful not to set any options that change the behavior of lean code, but I think the caching concerns aren't a major issue provided that all the built oleans use the official option set and the server only uses your custom options when processing files in the editor</p>",
        "id": 359467419,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684434025
    },
    {
        "content": "<p>Perhaps options could be registered (when declared) as being exclusively ‚ÄúUI‚Äù options (i.e. not changing the behavior of Lean code), and only these would be customizable via the extension</p>",
        "id": 359467908,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1684434175
    },
    {
        "content": "<p>Right now I think the bigger issue is that you can't set custom options at all via <code>-D</code></p>",
        "id": 359468239,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684434275
    },
    {
        "content": "<p>I think this will be a rather advanced technique and so I'm not too fussed about putting guard rails on it. Theoretically any option could affect lean code (you could just have a tactic which emits a declaration if <code>pp.all</code> is on), but in practice most don't, or at least not in any interesting or easily observable way even if it changes the hash in some way</p>",
        "id": 359468628,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684434414
    },
    {
        "content": "<p>This is really a design criterion for options. Looking at the list, I see only two kinds of options:</p>\n<ol>\n<li>Options that change what lean prints but not what it does</li>\n<li>Options that make lean succeed or fail where it would not otherwise</li>\n<li>Mostly unrepresented: Options that cause lean to change from one valid behavior to a different one</li>\n</ol>\n<p>I don't see any in the third group, except possibly <code>etaExperiment</code>, and <code>genInjectivity</code>, <code>genSizeOf</code> which are for internal (bootstrap) use only</p>",
        "id": 359469475,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684434661
    },
    {
        "content": "<p>An option which I'd like to set in a mathlib-dependent project is <code>push_neg.use_distrib</code>.  This changes the behaviour of a tactic, so it would definitely break some proofs.  Does this fall outside your classification?</p>",
        "id": 359470209,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1684434868
    },
    {
        "content": "<p>It would fall in the third group. You would definitely not want to set those kind of options in the extension</p>",
        "id": 359470609,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684434980
    },
    {
        "content": "<p>Even changes to options in group 2 can be problematic, since it is confusing if you visit a file which apparently compiled successfully and it doesn't compile in the editor</p>",
        "id": 359471307,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684435178
    },
    {
        "content": "<p>something like <code>push_neg.use_distrib</code> would mostly manifest as causing failures like group 2; it would be pretty rare for it to work anyway but produce a relevant difference (group 3)</p>",
        "id": 359471633,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1684435247
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <br>\nwould such a code action also be possible for match?<br>\ne.g. it would be very nice to be able to autogenerate a match for the constructors, like here for Lean.Expr:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">constInExpr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">bvar</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">mvar</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">lam</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">forallE</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">letE</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">mdata</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">proj</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I think deleting the not-needed cases into a catch all is a much safer workflow, than adding them ontop of a catch-all, and autogenerating all constructors enables this.<br>\nEven better would be, if it wouldn't use <code>_</code>, but rather the original names (if there are any) used in the definition (if thats even possible)</p>",
        "id": 523770545,
        "sender_full_name": "Moritz R",
        "timestamp": 1749738687
    },
    {
        "content": "<p>there is a code action for function types, so you can use <code>: Expr -&gt; Bool := _</code> and then apply the code action and edit it to what you want</p>",
        "id": 523771124,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749738842
    },
    {
        "content": "<p>oh thanks! Thats already pretty cool. I just wish we also had that for match - then i can keep my variables in the order i want (e.g. if expr wasn't the last one)</p>",
        "id": 523772222,
        "sender_full_name": "Moritz R",
        "timestamp": 1749739166
    },
    {
        "content": "<p>the problem is that we don't have a way to say what the expression is, like the <code>{! e !}</code> holes in agda</p>",
        "id": 523772354,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749739202
    },
    {
        "content": "<p>so it's unclear how to indicate what type we want to match on</p>",
        "id": 523772474,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749739232
    },
    {
        "content": "<p>i dont think i understand:<br>\nIf i write <br>\n<code>match e (with)</code> isn't it clear from the type of e what the constructors of that type are?</p>",
        "id": 523772680,
        "sender_full_name": "Moritz R",
        "timestamp": 1749739291
    },
    {
        "content": "<p>you're right, that's implemented for <code>induction e</code> already, I'll see what it takes to make that work</p>",
        "id": 523772942,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749739374
    },
    {
        "content": "<p>Also, what do you think about making the code action for function types also availible without writing the <br>\n<code>:= _</code> <br>\nand then deleting the unnessecarily generated <code>:= fun</code>.</p>\n<p>E.g. for writing </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>\n<p>i would expect to be able to already autocomplete when only having written </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n</code></pre></div>\n<p>not only after </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>(which generates )</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>but i want </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>",
        "id": 523775191,
        "sender_full_name": "Moritz R",
        "timestamp": 1749740059
    },
    {
        "content": "<p>the latter would be easier than the former</p>",
        "id": 523862919,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749783122
    },
    {
        "content": "<p>I think both would be optimal, though the version for match I think is much more important, since the workaround for it, is much more annoying</p>",
        "id": 523907224,
        "sender_full_name": "Moritz R",
        "timestamp": 1749806907
    },
    {
        "content": "<p>I would also be interested to take a shot at this myself, but i would need some pointers, for where to look for the exisiting implementation of the action for \"induction n\" and where the one for \"match\" would go</p>",
        "id": 523911170,
        "sender_full_name": "Moritz R",
        "timestamp": 1749808371
    },
    {
        "content": "<p>(im quite new to metaprogramming)</p>",
        "id": 523911229,
        "sender_full_name": "Moritz R",
        "timestamp": 1749808398
    },
    {
        "content": "<p>The induction and cases code actions are in <a href=\"https://github.com/leanprover-community/batteries/blob/main/Batteries/CodeAction/Misc.lean\">https://github.com/leanprover-community/batteries/blob/main/Batteries/CodeAction/Misc.lean</a> (at <code>casesExpand</code>)</p>",
        "id": 523911429,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1749808479
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20code.20actions/near/523772354\">said</a>:</p>\n<blockquote>\n<p>the problem is that we don't have a way to say what the expression is, like the <code>{! e !}</code> holes in agda</p>\n</blockquote>\n<p>reminds me of <a href=\"https://github.com/brendanzab/lean-holes\">https://github.com/brendanzab/lean-holes</a></p>",
        "id": 524116649,
        "sender_full_name": "Alok Singh",
        "timestamp": 1749979202
    },
    {
        "content": "<p>How do people get textual representations of anything?<br>\nf.e.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">command_code_action</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">blabla</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommandCodeAction</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">CodeActionParams</span><span class=\"w\"> </span><span class=\"n\">Snapshot</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">ofTacticInfo</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[]</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{info.goalsBefore}\"</span>\n\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">eagerAction</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lsp</span><span class=\"bp\">.</span><span class=\"n\">CodeAction</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"My Always Visible Action\"</span>\n<span class=\"w\">    </span><span class=\"n\">kind?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"quickfix\"</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"w\"> </span><span class=\"n\">lazy?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">eager</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">eagerAction</span><span class=\"w\"> </span><span class=\"o\">}]</span>\n</code></pre></div>\n<p>logInfo and dbg_trace fail - Is there any other options how i can see values of things?</p>",
        "id": 524125433,
        "sender_full_name": "Moritz R",
        "timestamp": 1749987938
    },
    {
        "content": "<p>Once upon a time I had to do this so I just put it in the title of the action</p>",
        "id": 524125589,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749988060
    },
    {
        "content": "<p>Does <code>IO.eprintln</code> work?</p>",
        "id": 524125727,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749988181
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20code.20actions/near/524125727\">schrieb</a>:</p>\n<blockquote>\n<p>Does <code>IO.eprintln</code> work?</p>\n</blockquote>\n<p>This one gives </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">synthesize</span>\n<span class=\"w\">  </span><span class=\"n\">ToString</span><span class=\"w\"> </span><span class=\"n\">MessageData</span>\n</code></pre></div>",
        "id": 524125793,
        "sender_full_name": "Moritz R",
        "timestamp": 1749988228
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20code.20actions/near/524125589\">schrieb</a>:</p>\n<blockquote>\n<p>Once upon a time I had to do this so I just put it in the title of the action</p>\n</blockquote>\n<p>I also get a clash from </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n<span class=\"w\">  </span><span class=\"n\">toMessageData</span><span class=\"w\"> </span><span class=\"s2\">\"My Always Visible Action\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">toMessageData</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">goalsBefore</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"n\">toMessageData</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">MessageData</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">outParam</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n<span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">type</span>\n<span class=\"w\">  </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span>\n</code></pre></div>",
        "id": 524125828,
        "sender_full_name": "Moritz R",
        "timestamp": 1749988259
    },
    {
        "content": "<p>Yeah I had a string representation, it wasn't a <code>MessageData</code></p>",
        "id": 524125860,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749988286
    },
    {
        "content": "<p>(this was <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/Macro.20vs.2E.20code.20action/near/518299749\">#lean4 &gt; Macro vs. code action @ üí¨</a> )</p>",
        "id": 524125928,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749988343
    },
    {
        "content": "<p>Right, my question was whether <code>IO.eprintln \"This is visible\"</code> is visible</p>",
        "id": 524126029,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749988477
    },
    {
        "content": "<p>You can deal with stringification once you've found a channel that you can send anything through</p>",
        "id": 524126048,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749988495
    },
    {
        "content": "<p>These both work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"s2\">\"blabla\"</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"s2\">\"This is visible\"</span>\n</code></pre></div>\n<p>But i cant get anything i actually want to know into it</p>",
        "id": 524126265,
        "sender_full_name": "Moritz R",
        "timestamp": 1749988705
    },
    {
        "content": "<p>What do you want to know? Maybe you can convert it into a string</p>",
        "id": 524126406,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749988877
    },
    {
        "content": "<p>e.g. what <code>node : InfoTree</code> contains</p>",
        "id": 524126519,
        "sender_full_name": "Moritz R",
        "timestamp": 1749989001
    },
    {
        "content": "<p>I had to hand-roll a <code>toString</code> function lol</p>",
        "id": 524126983,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749989483
    },
    {
        "content": "<p>I guess since you have access to the infotree could you just insert a node</p>",
        "id": 524127103,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749989604
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20code.20actions/near/524127103\">schrieb</a>:</p>\n<blockquote>\n<p>I guess since you have access to the infotree could you just insert a node</p>\n</blockquote>\n<p>how would that help?</p>",
        "id": 524128186,
        "sender_full_name": "Moritz R",
        "timestamp": 1749990874
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20code.20actions/near/524126983\">schrieb</a>:</p>\n<blockquote>\n<p>I had to hand-roll a <code>toString</code> function lol</p>\n</blockquote>\n<p>can you share it? ;)</p>",
        "id": 524128200,
        "sender_full_name": "Moritz R",
        "timestamp": 1749990888
    },
    {
        "content": "<p>Can you use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=InfoTree.format#doc\">docs#InfoTree.format</a> ?</p>",
        "id": 524129209,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749992093
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Tactic.20code.20actions/near/524129209\">schrieb</a>:</p>\n<blockquote>\n<p>Can you use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=InfoTree.format#doc\">docs#InfoTree.format</a> ?</p>\n</blockquote>\n<p>Yess!</p>",
        "id": 524129664,
        "sender_full_name": "Moritz R",
        "timestamp": 1749992589
    },
    {
        "content": "<p>more precisely in my context, this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">InfoTree</span><span class=\"bp\">.</span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">node</span><span class=\"w\"> </span><span class=\"n\">ctx</span>\n<span class=\"n\">dbg_trace</span><span class=\"w\"> </span><span class=\"n\">m</span>\n</code></pre></div>",
        "id": 524129722,
        "sender_full_name": "Moritz R",
        "timestamp": 1749992657
    },
    {
        "content": "<p>For the pattern-completion of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n</code></pre></div>\n<p>do we want  an action to match against the second argument as well? i.e. generate smth. like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>If so, until which argument-number should we generate the action?</p>",
        "id": 524151288,
        "sender_full_name": "Moritz R",
        "timestamp": 1750015841
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/6baAJHzHBFZ-J4D5BMSGvF9R/2025-06-16-12-24-24.gif\">2025-06-16 12-24-24.gif</a><br>\n(sighs in relief)</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/6baAJHzHBFZ-J4D5BMSGvF9R/2025-06-16-12-24-24.gif\" title=\"2025-06-16 12-24-24.gif\"><img data-animated=\"true\" data-original-content-type=\"image/gif\" data-original-dimensions=\"1920x1080\" src=\"/user_uploads/thumbnail/3121/6baAJHzHBFZ-J4D5BMSGvF9R/2025-06-16-12-24-24.gif/840x560-anim.webp\"></a></div>",
        "id": 524224572,
        "sender_full_name": "Moritz R",
        "timestamp": 1750069733
    },
    {
        "content": "<p>That's really cool! But I would suggest using two spaces less indentation, so that the <code>match</code> and the <code>|</code> start at the same column.</p>",
        "id": 524224783,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750069810
    },
    {
        "content": "<p>good catch! - now fixed</p>",
        "id": 524225109,
        "sender_full_name": "Moritz R",
        "timestamp": 1750069920
    },
    {
        "content": "<p>Im not 100% happy with my implementation code, but i don't see a better way to do it -</p>",
        "id": 524225356,
        "sender_full_name": "Moritz R",
        "timestamp": 1750070008
    },
    {
        "content": "<p>Very open to feedback</p>",
        "id": 524225443,
        "sender_full_name": "Moritz R",
        "timestamp": 1750070043
    },
    {
        "content": "<p>Can somebody have a look at the code?<br>\nIt's now public under <a href=\"https://github.com/MoritzBeroRoos/batteries\">https://github.com/MoritzBeroRoos/batteries</a></p>",
        "id": 524231134,
        "sender_full_name": "Moritz R",
        "timestamp": 1750071972
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> is the expert for this</p>",
        "id": 524231194,
        "sender_full_name": "Moritz R",
        "timestamp": 1750071992
    },
    {
        "content": "<p>It seems Mario is busy, can maybe someone else have a look?</p>",
        "id": 526562344,
        "sender_full_name": "Moritz R",
        "timestamp": 1751361269
    },
    {
        "content": "<p>Could you open a PR? Then we can use the github review feature</p>",
        "id": 526598607,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1751373447
    },
    {
        "content": "<p>Note, this ended up in a slightly awkward position because I have already written half of the implementation and it handles a more general situation than your version, so I might replace this later. On the other hand, I didn't finish it and I don't want to block people for that reason, so I'd be okay merging your version in the meantime</p>",
        "id": 526614240,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1751378040
    },
    {
        "content": "<p>I have opened a pull request at <a href=\"https://github.com/leanprover-community/batteries/pull/1307\">https://github.com/leanprover-community/batteries/pull/1307</a>.<br>\nIf this code is deemed ok, im fine with it only being merged and later replaced when mario finishes a more general version.</p>",
        "id": 526629812,
        "sender_full_name": "Moritz R",
        "timestamp": 1751382299
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>  does your generalized version already handle the implicit match as in </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">&lt;--</span><span class=\"o\">(</span><span class=\"n\">cursor</span><span class=\"w\"> </span><span class=\"n\">here</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>or should try to solve this?</p>",
        "id": 526630163,
        "sender_full_name": "Moritz R",
        "timestamp": 1751382398
    },
    {
        "content": "<p>Does anybody have any ideas for how to go from generating</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>to generating</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>?</p>\n<p>At the moment we just have annotations of definitions with <code>[match_pattern]</code><br>\nwhich will then be unfolded in the matching, but i don't see any way to do anything nice backwards here.</p>\n<p>Is there anything to say against hardcoding a few of the most common patterns?</p>",
        "id": 527922966,
        "sender_full_name": "Moritz R",
        "timestamp": 1752077687
    },
    {
        "content": "<p>I think it is reasonable to hard-code this special case.</p>",
        "id": 527924038,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1752078062
    },
    {
        "content": "<p>Anyone have a clue why <code>@[command_code_action Parser.Term.match]</code> doesn't fire on anything i try?</p>",
        "id": 529916024,
        "sender_full_name": "Moritz R",
        "timestamp": 1753112020
    },
    {
        "content": "<p>because that's not a command</p>",
        "id": 529916245,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1753112090
    },
    {
        "content": "<p>most of my half-implementation involved implementing <code>term_code_action</code> first</p>",
        "id": 529916337,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1753112123
    },
    {
        "content": "<p>i see</p>",
        "id": 529916443,
        "sender_full_name": "Moritz R",
        "timestamp": 1753112155
    },
    {
        "content": "<p>FYI: <span class=\"user-mention\" data-user-id=\"602461\">@Moritz R</span> 's <a href=\"https://github.com/leanprover-community/batteries/pull/1307\">batteries#1307</a> is ready for a final review.</p>",
        "id": 529940912,
        "sender_full_name": "Fran√ßois G. Dorais",
        "timestamp": 1753120793
    },
    {
        "content": "<p>I have been working on extending the <code>match</code> codeaction by an option that generates constructors with implicit arguments. (This option will only show if it's relevant, see PR for details when)<br>\n<a href=\"/user_uploads/3121/PAdLcgPPRngWJUnNttlogj2m/Screen-Recording-2026-02-22-at-19.09.11.gif\">Screen Recording 2026-02-22 at 19.09.11.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/PAdLcgPPRngWJUnNttlogj2m/Screen-Recording-2026-02-22-at-19.09.11.gif\" title=\"Screen Recording 2026-02-22 at 19.09.11.gif\"><img data-animated=\"true\" data-original-content-type=\"image/gif\" data-original-dimensions=\"2438x1572\" src=\"/user_uploads/thumbnail/3121/PAdLcgPPRngWJUnNttlogj2m/Screen-Recording-2026-02-22-at-19.09.11.gif/840x560-anim.webp\"></a></div>",
        "id": 575180182,
        "sender_full_name": "Moritz R",
        "timestamp": 1771783941
    },
    {
        "content": "<p>Currently i generate the <code>@</code> version of the constructor, and fill in <code>_</code> for <code>parameters</code> of the inductive type</p>",
        "id": 575180219,
        "sender_full_name": "Moritz R",
        "timestamp": 1771783998
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119741\">@Fran√ßois G. Dorais</span>  has rightly said that we could also instead consider other variants of this</p>",
        "id": 575180260,
        "sender_full_name": "Moritz R",
        "timestamp": 1771784047
    },
    {
        "content": "<p>(PR at <a href=\"https://github.com/leanprover-community/batteries/pull/1693\">https://github.com/leanprover-community/batteries/pull/1693</a>)</p>",
        "id": 575180274,
        "sender_full_name": "Moritz R",
        "timestamp": 1771784061
    },
    {
        "content": "<p>We could for instance instead generate</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun4</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermWithImplicit</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">TermWithImplicit</span><span class=\"bp\">.</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hPremiseOrder</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hPremiseOrder</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hLeftBigger</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">hLeftBigger</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>Cons : Lines quickly get long since they are all duplicated<br>\nPros: One can quickly delete unneeded arguments, robust against permutation, everything fillled in already</p>",
        "id": 575180319,
        "sender_full_name": "Moritz R",
        "timestamp": 1771784109
    },
    {
        "content": "<p>or</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myfun4</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermWithImplicit</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">TermWithImplicit</span><span class=\"bp\">.</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">l</span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hPremiseOrder</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hLeftBigger</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>Cons : One needs to write a bunch of the implcit names again until one can start using them which kind of defeats the purpose<br>\nPros : Very short One can quickly delete unneeded arguments, robust against permutation</p>",
        "id": 575180336,
        "sender_full_name": "Moritz R",
        "timestamp": 1771784127
    },
    {
        "content": "<ul>\n<li>Or we go with the one shown in the gif, with <code>@</code><br>\nCons : if the args in the def are renamed, this will not be noticed (but won't break), also not robust to permutation<br>\nPros : decently short, one can directly continue with writing the code</li>\n</ul>",
        "id": 575180553,
        "sender_full_name": "Moritz R",
        "timestamp": 1771784366
    },
    {
        "content": "<p>I would love to have some opinions of what would be most <em>useful</em> to auto-generate for you.</p>",
        "id": 575180624,
        "sender_full_name": "Moritz R",
        "timestamp": 1771784430
    },
    {
        "content": "<p>I prefer the <code>(l := l)</code> version for reasons of robustness and being able to delete stuff, and hopefully most other constructors use shorter names so it won't be so long</p>",
        "id": 575200462,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771801577
    }
]