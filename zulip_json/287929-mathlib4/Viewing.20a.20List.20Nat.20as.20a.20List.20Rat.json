[
    {
        "content": "<p>Here's my example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Finsupp</span><span class=\"bp\">.</span><span class=\"n\">Multiset</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">coe_list</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">↑</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Why does the theorem typecheck? It's taking a List Nat and coercing it to a List Rat, seemingly, even though the coercion doesn't seem to exist. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">synth</span><span class=\"w\"> </span><span class=\"n\">CoeTC</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>fails, although maybe I should be looking for something else?</p>\n<p>And the coercion has a weird form: when I'm doing maths and I put the rat/nat in the wrong place, seeing <code>do</code> notation with a <code>pure</code> isn't what I expect!</p>",
        "id": 497512840,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738609710
    },
    {
        "content": "<p>It's because of <code>List.instMonad</code>, yeah. I thought we got rid of that, or maybe that was only for Set</p>",
        "id": 497513192,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738609843
    },
    {
        "content": "<p>I don't see how that could cause this. I also think it's definitely a good idea to keep the monad instance for lists!</p>",
        "id": 497513368,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738609913
    },
    {
        "content": "<p>i think we <em>did</em> make that a non-instance... weird that it shows up</p>",
        "id": 497513372,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738609914
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=List.instMonad#doc\">docs#List.instMonad</a> it's an instance</p>",
        "id": 497513554,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738609974
    },
    {
        "content": "<p>maybe it was removed from core or something?</p>",
        "id": 497513685,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738610022
    },
    {
        "content": "<p>maybe we are getting confused because <code>List.bind</code> was renamed to <code>List.flatMap</code></p>",
        "id": 497513844,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738610071
    },
    {
        "content": "<p>(and <code>List.join</code> to <code>List.flatten</code>)</p>",
        "id": 497513887,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738610093
    },
    {
        "content": "<p>Losing do-notation for lists would be very unfortunate, in my opinion, so I sincerely hope that <code>Monad List</code> is not going anywhere</p>",
        "id": 497514020,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738610150
    },
    {
        "content": "<p>it'd be ok if it were namespaced, imo</p>",
        "id": 497514153,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738610187
    },
    {
        "content": "<p>Why is it that this instance is showing up at all in this goal though?</p>",
        "id": 497514543,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738610340
    },
    {
        "content": "<p>It's <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Internal.coeM#doc\">docs#Lean.Internal.coeM</a>, no?</p>",
        "id": 497515022,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738610524
    },
    {
        "content": "<p>because lean needs to coerce <code>List N</code> to <code>List Q</code> rather than <code>N</code> to <code>Q</code></p>",
        "id": 497515057,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738610542
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Viewing.20a.20List.20Nat.20as.20a.20List.20Rat/near/497515022\">said</a>:</p>\n<blockquote>\n<p>It's <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Internal.coeM#doc\">docs#Lean.Internal.coeM</a>, no?</p>\n</blockquote>\n<p>I see, that was hard to find because it got inlined!</p>",
        "id": 497515096,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738610557
    },
    {
        "content": "<p>Yeah, found it in the end by loogling for <code>Bind.bind, \"Coe\"</code> and then looking at the source of Mathlib.Data.Set.Functor</p>",
        "id": 497515442,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738610682
    },
    {
        "content": "<p>I'm also surprised that's defined using bind rather than fmap: I suppose they can be different for a non-lawful-monad, but it means that the coercion isn't even in simp normal form for specific monads like <code>List</code></p>",
        "id": 497515670,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738610781
    },
    {
        "content": "<p>It's pretty much never going to be in simp-normal form because <a href=\"http://Functor.map\">Functor.map</a> is not as universe polymorphic as <a href=\"http://List.map\">List.map</a></p>",
        "id": 497520441,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1738612656
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Viewing.20a.20List.20Nat.20as.20a.20List.20Rat/near/497514543\">said</a>:</p>\n<blockquote>\n<p>Why is it that this instance is showing up at all in this goal though?</p>\n</blockquote>\n<p>The coercion system tries two things: finding a direct coercion, or recognizing that there's a monad lift available (here, the identity lift) and then coercing under the monad.</p>",
        "id": 497522859,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1738613596
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Viewing.20a.20List.20Nat.20as.20a.20List.20Rat/near/497522859\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Viewing.20a.20List.20Nat.20as.20a.20List.20Rat/near/497514543\">said</a>:</p>\n<blockquote>\n<p>Why is it that this instance is showing up at all in this goal though?</p>\n</blockquote>\n<p>The coercion system tries two things: finding a direct coercion, or recognizing that there's a monad lift available (here, the identity lift) and then coercing under the monad.</p>\n</blockquote>\n<p>Makes sense, thanks.</p>",
        "id": 497535646,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1738618361
    }
]