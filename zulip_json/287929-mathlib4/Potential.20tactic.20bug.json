[
    {
        "content": "<p>I've been training a ML model to prove theorems in Lean. The good news is that in a stupendous feat of engineering (and after many epochs of incremental progress) my model's performance rocketed up to a sizzling 99.83% on miniF2F. The bad news is that all the proofs leverage the same bug displayed in the MWE below:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">BigOperators</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Topology</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">amc12a_2019_p21</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℂ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">I</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">Real</span><span class=\"bp\">.</span><span class=\"n\">sqrt</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"o\">((</span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Icc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">Icc</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exfalso</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">lt_irrefl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">lt_of_lt_of_le</span>\n<span class=\"w\">  </span><span class=\"n\">bound</span>\n<span class=\"w\">  </span><span class=\"n\">positivity</span>\n</code></pre></div>\n<p>The message in the InfoView at the end says\"No Goals\" which allowed my model to cheat, but there is a red underline under the theorem name that reads the following error:</p>\n<p>\"(kernel) application type mismatch<br>\nlt_of_lt_of_le (Eq.symm h₀ ▸ Int.lt_floor_add_one 2)<br>\nargument has type<br>\n(fun z _h =&gt; 2 &lt; ↑⌊2⌋ + 1) z ⋯<br>\nbut function has type<br>\n2 &lt; 0 → 0 ≤ 2 → 2 &lt; 2\"</p>\n<p>Anyway, the message in the InfoView seems like it might be unintended behavior of some sort. Submitted for your consideration.</p>",
        "id": 542345930,
        "sender_full_name": "Andreas Gittis",
        "timestamp": 1759258024
    },
    {
        "content": "<p>i think this is a bug caused by <code>bound</code> not running <code>isDefEq</code> on the goal, or something like that? If it did, the goal after <code>bound</code> wouldn't contain <code>?b</code>, and would cause <code>positivity</code> to fail here. (an example of what this would be like is given replacing <code>bound</code> by <code>exact by bound</code>)</p>",
        "id": 542347920,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1759258821
    },
    {
        "content": "<p>Since <code>bound</code> is a mathlib tactic, this conversation should probably be moved to <a class=\"stream\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4\">#mathlib4</a></p>",
        "id": 542348528,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1759259050
    },
    {
        "content": "<p>I pinged the maintainers - this thread should get moved soon</p>",
        "id": 542349913,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1759259564
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/Potential.20tactic.20bug\">#lean4 &gt; Potential tactic bug</a> by <span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span>.</p>",
        "id": 542350870,
        "sender_full_name": "Notification Bot",
        "timestamp": 1759259955
    },
    {
        "content": "<p>alternatively to my previous suggestion (assigning the metavariable) of what would be expected behaviour, maybe the more desirable behaviour for tactics of this sort is throwing an error when run on a goal with unassigned metavariables?</p>",
        "id": 542360852,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1759263656
    },
    {
        "content": "<p>Checking to see that you have proved what you were supposed to have proved is a very subtle question and there have been plenty of discussions about it in the <a class=\"stream\" data-stream-id=\"219941\" href=\"/#narrow/channel/219941-Machine-Learning-for-Theorem-Proving\">#Machine Learning for Theorem Proving</a> channel.</p>",
        "id": 542462917,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1759315623
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Potential.20tactic.20bug/near/542462917\">said</a>:</p>\n<blockquote>\n<p>Checking to see that you have proved what you were supposed to have proved is a very subtle question and there have been plenty of discussions about it in the <a class=\"stream\" data-stream-id=\"219941\" href=\"/#narrow/channel/219941-Machine-Learning-for-Theorem-Proving\">#Machine Learning for Theorem Proving</a> channel.</p>\n</blockquote>\n<p>Hm, what do you mean by that? It's true that there isn't a formal way to verify the problem you've formalized is the problem you want to prove, but in this case the Lean kernel knows that the proof is incorrect but the Lean InfoView doesn't. I don't think there is any ambiguity in the case of rejection by the kernel.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Potential.20tactic.20bug/near/542360852\">said</a>:</p>\n<blockquote>\n<p>alternatively to my previous suggestion (assigning the metavariable) of what would be expected behaviour, maybe the more desirable behaviour for tactics of this sort is throwing an error when run on a goal with unassigned metavariables?</p>\n</blockquote>\n<p>I guess this is considered a tactic bug, but is it intended behavior for Lean not to send information of a failed proof in the kernel back to the InfoView? If that's a design choice, what's the motivation for it?</p>",
        "id": 542787249,
        "sender_full_name": "Andreas Gittis",
        "timestamp": 1759423149
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"622464\">Andreas Gittis</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Potential.20tactic.20bug/near/542787249\">said</a>:</p>\n<blockquote>\n<p>Hm, what do you mean by that? It's true that there isn't a formal way to verify the problem you've formalized is the problem you want to prove, but in this case the Lean kernel knows that the proof is incorrect but the Lean InfoView doesn't. I don't think there is any ambiguity in the case of rejection by the kernel.</p>\n</blockquote>\n<p>I mean that there are entire repos such as <a href=\"https://github.com/GasStationManager/SafeVerify\">https://github.com/GasStationManager/SafeVerify</a> devoted to the problem of checking whether something is a proof of a theorem.</p>",
        "id": 542835715,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1759441839
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"622464\">Andreas Gittis</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Potential.20tactic.20bug/near/542787249\">said</a>:</p>\n<blockquote>\n<p>Is it intended behavior for Lean not to send information of a failed proof in the kernel back to the InfoView? If that's a design choice, what's the motivation for it?</p>\n</blockquote>\n<p>I'm not quite sure what you mean? if you put the cursor on the declaration name, it shows the kernel error in the infoview, no?</p>",
        "id": 542837861,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1759443194
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Potential.20tactic.20bug/near/542837861\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"622464\">Andreas Gittis</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Potential.20tactic.20bug/near/542787249\">said</a>:</p>\n<blockquote>\n<p>Is it intended behavior for Lean not to send information of a failed proof in the kernel back to the InfoView? If that's a design choice, what's the motivation for it?</p>\n</blockquote>\n<p>I'm not quite sure what you mean? if you put the cursor on the declaration name, it shows the kernel error in the infoview, no?</p>\n</blockquote>\n<p>Ah yes you're right it does show next to the theorem name. I've always checked proofs by putting the cursor at the end of the last tactic in the proof and nothing shows up in the InfoView there (except \"No Goals\").</p>",
        "id": 542851759,
        "sender_full_name": "Andreas Gittis",
        "timestamp": 1759452134
    }
]