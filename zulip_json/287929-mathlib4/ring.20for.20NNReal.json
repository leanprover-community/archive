[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span>, now that <a href=\"https://github.com/leanprover-community/mathlib4/pull/9915\">#9915</a> (<code>norm_num</code> for <code>NNRat</code>-algebras) has been merged, is it on your radar to do the same generalization for <code>ring</code>? For example,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- currently fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">ring</span>\n</code></pre></div>",
        "id": 534664969,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755269054
    },
    {
        "content": "<p>The reality is that I got norm_num mostly working with <a href=\"https://github.com/leanprover-community/mathlib4/pull/9915\">#9915</a>, lost motivation, then <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> fixed up the ring stuff to not crash with my changes</p>",
        "id": 534665676,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755269323
    },
    {
        "content": "<p>And in the end, the extent of my review of the changes to ring were \"yes, this is still correct\"</p>",
        "id": 534665746,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755269347
    },
    {
        "content": "<p>But I didn't spend any time thinking about how to generalize <code>ring</code>!</p>",
        "id": 534665796,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755269365
    },
    {
        "content": "<p>It looks pretty straightforward to adapt <a href=\"https://github.com/leanprover-community/mathlib4/blob/77ee539f65bc808ccd55f88bf61870dc200326f5/Mathlib/Tactic/Ring/Basic.lean#L1027-L1056\">https://github.com/leanprover-community/mathlib4/blob/77ee539f65bc808ccd55f88bf61870dc200326f5/Mathlib/Tactic/Ring/Basic.lean#L1027-L1056</a></p>",
        "id": 534666159,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755269510
    },
    {
        "content": "<p>This weekend is a bad time for me, so it's all yours if you want <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>!</p>",
        "id": 534666251,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755269550
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/28494\">#28494</a></p>",
        "id": 534703414,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755286617
    },
    {
        "content": "<p>OK, that was clearly too easy! :). Do you want to do <code>linarith</code> next??? </p>\n<p>(I think the idea would be to write a <code>nnrealToReal</code> preprocessor, mimicking <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Tactic.Linarith.natToInt#doc\">docs#Mathlib.Tactic.Linarith.natToInt</a>.)</p>",
        "id": 534705714,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755287844
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/channel/287929-mathlib4/topic/ring.20for.20NNReal/near/534705714\">said</a>:</p>\n<blockquote>\n<p>OK, that was clearly too easy! :). Do you want to do <code>linarith</code> next???</p>\n</blockquote>\n<p>Knowing how <code>linarith</code> works, that might be, complicated</p>",
        "id": 534705949,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755287966
    },
    {
        "content": "<p>Which part? I was thinking the preprocessor would do this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- preprocess</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"bp\">.</span><span class=\"n\">coe_le_coe</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">  </span><span class=\"n\">push_cast</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"bp\">.</span><span class=\"n\">zero_le_coe</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">NNReal</span><span class=\"bp\">.</span><span class=\"n\">zero_le_coe</span>\n<span class=\"w\">  </span><span class=\"c1\">-- now can work in `ℝ`</span>\n<span class=\"w\">  </span><span class=\"n\">linarith</span>\n</code></pre></div>\n<p>IIUC that's how the Nat-to-Int preprocessor works.</p>",
        "id": 534706203,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755288095
    },
    {
        "content": "<p>oh are we special-casing <code>NNReal</code>?</p>",
        "id": 534706222,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288110
    },
    {
        "content": "<p>will we also have to special-case all the other ordered semifields?</p>",
        "id": 534706431,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288233
    },
    {
        "content": "<p>We already special-case <code>Nat</code>, so there's a precedent. <code>NNReal</code> will be 95% of the use cases, so I don't think we should let the perfect be the enemy of the good.</p>",
        "id": 534706499,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755288272
    },
    {
        "content": "<p>I guess I can try it</p>",
        "id": 534706589,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288330
    },
    {
        "content": "<p>You could write something for general cancellative semirings, but that's actually not as good for special cases like <code>Nat</code> and <code>NNReal</code>, because it doesn't let you move into a concrete other ring (<code>Int</code> or <code>Real</code>) where the context might already contain relevant additional hypotheses.</p>",
        "id": 534706711,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755288377
    },
    {
        "content": "<p>I would argue that collecting facts from different types might be starting to get a little out of scope for <code>linarith</code></p>",
        "id": 534706854,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288449
    },
    {
        "content": "<p>Wait, what? It already does it right?</p>",
        "id": 534706886,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755288463
    },
    {
        "content": "<p>I thought it does it once for each type</p>",
        "id": 534706919,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288476
    },
    {
        "content": "<p>maybe I worded that badly</p>",
        "id": 534707006,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288513
    },
    {
        "content": "<p><code>linarith</code> won't take two facts in two different types, and use both of them to prove a goal I think</p>",
        "id": 534707101,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288554
    },
    {
        "content": "<p>it only works on one type, and if there are facts from different types in the context then it will try each type independently and take the first success</p>",
        "id": 534707215,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288608
    },
    {
        "content": "<p>It preprocesses <em>before</em> splitting by type. See <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Tactic.Linarith.runLinarith#doc\">docs#Mathlib.Tactic.Linarith.runLinarith</a></p>",
        "id": 534707227,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755288615
    },
    {
        "content": "<p>did I get that right?</p>",
        "id": 534707232,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288617
    },
    {
        "content": "<p>preprocessor is different</p>",
        "id": 534707269,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288633
    },
    {
        "content": "<p>Anyways if I'm doing this for <code>linarith</code> then where should I put it? I doubt the linarith file imports <code>NNReal</code>.</p>",
        "id": 534707533,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755288779
    },
    {
        "content": "<p>The principled answer would be to create an environment extension for linarith preprocessors. But I think that's overcomplicated here, where there's literally one piece of extensibility needed. Instead, perhaps you could use a trick I have seen in the <code>ring</code> code, although I'm not quite sure how it works:</p>",
        "id": 534707957,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755288983
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/3fb2e061618391cf00f768e5d9c4e98e4540e6c6/Mathlib/Tactic/Ring/Basic.lean#L1211-L1216\">https://github.com/leanprover-community/mathlib4/blob/3fb2e061618391cf00f768e5d9c4e98e4540e6c6/Mathlib/Tactic/Ring/Basic.lean#L1211-L1216</a></p>",
        "id": 534707976,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755288992
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/3fb2e061618391cf00f768e5d9c4e98e4540e6c6/Mathlib/Tactic/Ring/RingNF.lean#L122-L124\">https://github.com/leanprover-community/mathlib4/blob/3fb2e061618391cf00f768e5d9c4e98e4540e6c6/Mathlib/Tactic/Ring/RingNF.lean#L122-L124</a></p>",
        "id": 534708011,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755289011
    },
    {
        "content": "<p>Or the cheap version is to make people call it under a new name/syntax (<code>linarith≥0</code> ...)</p>",
        "id": 534708358,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755289170
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/ring.20for.20NNReal/near/534705714\">said</a>:</p>\n<blockquote>\n<p>OK, that was clearly too easy! :). Do you want to do <code>linarith</code> next??? </p>\n<p>(I think the idea would be to write a <code>nnrealToReal</code> preprocessor, mimicking <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Tactic.Linarith.natToInt#doc\">docs#Mathlib.Tactic.Linarith.natToInt</a>.)</p>\n</blockquote>\n<p>I have an open PR that fixes a potential bug in this processor</p>",
        "id": 534708536,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755289266
    },
    {
        "content": "<p>I see (<a href=\"https://github.com/leanprover-community/mathlib4/pull/28290\">#28290</a>).  OK, maybe we need to wait until that one's merged before writing variants.</p>",
        "id": 534708623,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1755289324
    }
]