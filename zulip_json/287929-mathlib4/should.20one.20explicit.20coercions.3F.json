[
    {
        "content": "<p>In many cases, mathlib has a coercion function that applies whenever needed (and appropriately detected). </p>\n<p>Example in algebra : a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingEquiv#doc\">docs#RingEquiv</a> <code>f : M â‰ƒ+* N</code> has an associated <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingHom#doc\">docs#RingHom</a>, <code>f.toRingHom</code>, but it can also be obtained by coercion, as <code>(f : M â†’+* N)</code> and is indicated by an uparrow <code>â†‘f</code>.</p>\n<p>Is there a preferred form?</p>\n<p>Indeed, this sometimes brings the necessity to have two theorems, one where the coercion is applied, and one with the explicit original function. Maybe this reflects a lack of a <code>simp</code> lemma that would prefer one form to the other.</p>",
        "id": 558909350,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1763918668
    },
    {
        "content": "<p>I think we're getting rid of the coercions in favor of explicit invocation of <code>.ofClass</code>, see <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Mathlib.27s.20morphism.20hierarchy/near/554383157\">#mathlib4 &gt; Mathlib's morphism hierarchy @ ðŸ’¬</a>. I think we should probably also get rid of <code>RingEquiv.toRingHom</code> etc. It's been <a href=\"https://github.com/leanprover-community/mathlib4/pull/11966#issuecomment-2041499719\">observed before</a> that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=LinearEquiv.toLinearMap#doc\">docs#LinearEquiv.toLinearMap</a> isn't reducibly defeq to the coercion and it caused problems, for example.</p>",
        "id": 558911760,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1763921150
    },
    {
        "content": "<p>No, the plan is to get rid of the coercions and make <code>RingEquiv.toRingHom</code> the simp NF. The <code>.ofClass</code> constructors should only be used in general lemmas about <code>FooHomClass</code>.</p>",
        "id": 558914063,
        "sender_full_name": "Christian Merten",
        "timestamp": 1763923477
    },
    {
        "content": "<p>Are you sure? We certainly won't be able to get rid of structure projections, but <code>RingEquiv.toRingHom</code> is not one; if we want to keep it I think we should make it an abbrev of <code>.ofClass</code>, and the same applies to <code>LinearEquiv.toLinearMap</code>.</p>",
        "id": 558916184,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1763925465
    },
    {
        "content": "<p>I think that the coercions we want to get rid of are those from toÂ <code>FooHomClass</code> to <code>FooHom</code>, not those from <code>FooHom</code> to <code>BarHom</code>.</p>",
        "id": 558916788,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1763926080
    },
    {
        "content": "<p>The coercions from <code>FooHom</code> to <code>BarHom</code> are given by the <code>BarHomClass FooHom</code> instances, no? Structure projections (from <code>extends</code>) like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=RingHom.toAddMonoidHom#doc\">docs#RingHom.toAddMonoidHom</a> or manually defined RingEquiv.toRingHom/LinearEquiv.toLinearMap are not coercions.</p>",
        "id": 558918603,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1763927924
    },
    {
        "content": "<p>Oh, I finally remembered what is particularly egregious about the LinearEquiv/LinearMap coercion: there's a manually defined <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Module/Equiv/Defs.html#LinearEquiv.instCoeLinearMap\">LinearEquiv.instCoeLinearMap</a> which is not reducibly defeq to the coercion from LinearEquiv being LinearMapClass ...</p>",
        "id": 558918923,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1763928230
    },
    {
        "content": "<p>Let me ping <span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> that surely know what is the plan</p>",
        "id": 558919537,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1763928875
    },
    {
        "content": "<p>Indeed the plan is to get rid of the generic (ie the ones that trigger in the presence of a hom class instance) coercions and add the specific (ie between two concrete types) coercions</p>",
        "id": 558921929,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1763930949
    },
    {
        "content": "<p>Once that is done, Antoine's original problem is no more: the coercion will syntactically be the same as <code>.toRingHom</code></p>",
        "id": 558921965,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1763930995
    },
    {
        "content": "<p>That was one of the coercions I had in mind, the other one is related to quotients, I rapidly fell onto equalities such as <code>âŸ¦xâŸ§ = â†‘x</code> where <code>rfl</code> showed they coincided but <code>rw?</code> found nothing.</p>",
        "id": 558922970,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1763932082
    },
    {
        "content": "<p>That's a completely separate refactor which <span class=\"user-mention\" data-user-id=\"455791\">@Yuyang Zhao</span> was doing</p>",
        "id": 558923362,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1763932475
    }
]