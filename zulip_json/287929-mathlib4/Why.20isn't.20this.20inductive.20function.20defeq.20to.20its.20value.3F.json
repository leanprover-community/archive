[
    {
        "content": "<p>I'm trying to update <a href=\"https://github.com/leanprover-community/mathlib4/pull/12750\">#12750</a>, and I encountered something quite strange. In this code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">â†’</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">+</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">decreasing_by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- doesn't work</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">show_term</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- Eq.refl (grayCodeInv 0)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- doesn't work</span>\n</code></pre></div>\n<p>What's going on?</p>",
        "id": 453983944,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1721922541
    },
    {
        "content": "<p>I see it's not mathlib related, could someone move it to <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/stream/270676-lean4\">#lean4</a> ?</p>",
        "id": 453985003,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1721922891
    },
    {
        "content": "<p>it might be something to do with inductive definitions typically being irreducable?</p>",
        "id": 453988081,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1721923466
    },
    {
        "content": "<p>Does tactic mode affect the reducibility settings?</p>",
        "id": 453988440,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1721923536
    },
    {
        "content": "<p>No, but even <code>example : grayCodeInv 0 = 0 := by exact Eq.refl (grayCodeInv 0)</code> doesn't work.</p>",
        "id": 453988669,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1721923569
    },
    {
        "content": "<p>Functions defined by well-founded recursion (the <code>decreasing_by</code>) have recently become irreducible by default. You can use <code>@[semireducible] def grayCodeInv ...</code> to make this one reducible again, or you can use <code>unseal</code> to locally make it reducible. The fact that <code>by rfl</code> works is apparently a bug.</p>",
        "id": 453990097,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1721923830
    },
    {
        "content": "<p>What is considered better style?</p>",
        "id": 453990629,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1721923935
    },
    {
        "content": "<p>Don't know whether there is a Mathlib convention. My personal take is that this irreducibility business is a performance optimisation, so if the performance is good enough, I see no reason not to go for <code>@[semireducible]</code>.</p>",
        "id": 453993059,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1721924362
    },
    {
        "content": "<p>I thought we were supposed to be doing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">grayCodeInv</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 453996081,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1721924992
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Why.20isn't.20this.20inductive.20function.20defeq.20to.20its.20value.3F/near/453990097\">said</a>:</p>\n<blockquote>\n<p>The fact that <code>by rfl</code> works is apparently a bug.</p>\n</blockquote>\n<p>I wonder how many of the 287 occurrences of <code>by rfl</code> in mathlib will break when this bug is fixed...</p>",
        "id": 453997430,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1721925339
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Why.20isn't.20this.20inductive.20function.20defeq.20to.20its.20value.3F/near/453996081\">said</a>:</p>\n<blockquote>\n<p>I thought we were supposed to be doing</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">grayCodeInv</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">grayCodeInv</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Right, that's definitely more idiomatic. Sorry.</p>",
        "id": 454002810,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1721926966
    }
]