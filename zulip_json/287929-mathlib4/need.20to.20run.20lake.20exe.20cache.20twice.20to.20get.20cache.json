[
    {
        "content": "<p>Is this related to the fact that I can never get cache for <a href=\"https://github.com/leanprover-community/mathlib4/pull/30989\">#30989</a> ? I always get some spurious error \"This usually means that your local checkout of mathlib4 has diverged from upstream.\" and then have to build 1500 files manually.</p>",
        "id": 553274871,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1762118503
    },
    {
        "content": "<p>Oh wow, I don't know if it's related to the sporadic errors in CI but something weird is going on there. </p>\n<p>I was able to get the cache but I had to run <code>lake exe cache get</code> twice (once to grab files from the default cache for <code>leanprover-community/mathlib4</code> and once with <code>--repo=kckennylau/mathlib4</code> like <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/18951148273/job/54118686067#step:4:2\">our CI does</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>gh<span class=\"w\"> </span>pr<span class=\"w\"> </span>checkout<span class=\"w\"> </span><span class=\"m\">30989</span>\nlake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get<span class=\"w\"> </span><span class=\"c1\"># this gets 6055 files and complains about missing files</span>\nlake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>--repo<span class=\"o\">=</span>kckennylau/mathlib4<span class=\"w\"> </span>get<span class=\"w\"> </span><span class=\"c1\"># this gets the remaining 1386 files</span>\nlake<span class=\"w\"> </span>build<span class=\"w\"> </span><span class=\"c1\"># this is fast</span>\n</code></pre></div>\n<p>If I try getting <code>lake exe cache --repo=kckennylau/mathlib4 get</code> first then it only gets 1386 files and complains about missing files, and I have to run <code>lake exe cache get</code> after that for <code>lake build</code> to be fast again. </p>\n<p>I remember that after we switched to forks, we just had to switch to running <code>lake exe cache --repo=name-of-fork/mathlib4 get</code> for the cache to work properly, but now it looks like the required files can end up being split across the caches for two repos instead of being available just from one.</p>\n<p><span class=\"user-mention\" data-user-id=\"306577\">@Matthew Ballard</span> I seem to recall that you worked on / looked at this part of cache around when we switched to forks? Is this intended?</p>",
        "id": 553295210,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762139944
    },
    {
        "content": "<p>I'm not at a computer now, but when I run <code>lake exe cache get</code> there are usually two phases, one where it downloads files from master and one where it uses the branch.  I don't have to do anything special for that, though.</p>",
        "id": 553318269,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1762156401
    },
    {
        "content": "<p>Odd, it doesn't seem to work for me for that branch. I just tested again. First I cleared all caches:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>rm -rf .lake\nrm -rf ~/.cache/mathlib\n</code></pre></div>\n<p>Here's the output of <code>lake exe cache get</code> and <code>lake build --no-build</code> afterwards, showing that only one repo is tried:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>&gt; lake exe cache get\ninfo: plausible: cloning https://github.com/leanprover-community/plausible\ninfo: plausible: checking out revision '8864a73bf79aad549e34eff972c606343935106d'\ninfo: LeanSearchClient: cloning https://github.com/leanprover-community/LeanSearchClient\ninfo: LeanSearchClient: checking out revision '2ed4ba69b6127de8f5c2af83cccacd3c988b06bf'\ninfo: importGraph: cloning https://github.com/leanprover-community/import-graph\ninfo: importGraph: checking out revision '451499ea6e97cee4c8979b507a9af5581a849161'\ninfo: proofwidgets: cloning https://github.com/leanprover-community/ProofWidgets4\ninfo: proofwidgets: checking out revision 'fb8ed0a85a96e3176f6e94b20d413ea72d92576d'\ninfo: aesop: cloning https://github.com/leanprover-community/aesop\ninfo: aesop: checking out revision '1fa48c6a63b4c4cda28be61e1037192776e77ac0'\ninfo: Qq: cloning https://github.com/leanprover-community/quote4\ninfo: Qq: checking out revision '95c2f8afe09d9e49d3cacca667261da04f7f93f7'\ninfo: batteries: cloning https://github.com/leanprover-community/batteries\ninfo: batteries: checking out revision '43f271c492f815dbbb9a4b753d6ccc9d19b5609a'\ninfo: Cli: cloning https://github.com/leanprover/lean4-cli\ninfo: Cli: checking out revision '72ae7004d9f0ddb422aec5378204fdd7828c5672'\ninstalling leantar 0.1.16\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n100  884k  100  884k    0     0  2513k      0 --:--:-- --:--:-- --:--:-- 2513k\n\nFetching ProofWidgets cloud release... done!\nCurrent branch: teichmuller-cdvr\nUsing cache (Azure) from upstream: leanprover-community/mathlib4\nAttempting to download 7441 file(s) from leanprover-community/mathlib4 cache\nDownloaded: 6055 file(s) [attempted 7441/7441 = 100%, 212 KB/s]\nWarning: some files were not found in the cache.\nThis usually means that your local checkout of mathlib4 has diverged from upstream.\nIf you push your commits to a branch of the mathlib4 repository, CI will build the oleans and they will be available later.\nAlternatively, if you already have pushed your commits to a branch, this may mean the CI build has failed part-way through building.\nDecompressing 6055 file(s)\nUnpacked in 6901 ms\nCompleted successfully!\n&gt; lake build --no-build\n✖ [1636/2915] Building Mathlib.Algebra.CharP.Lemmas\nerror: target is out-of-date and needs to be rebuilt\n✖ [2825/2915] Building Mathlib.Algebra.CharP.Quotient\nerror: target is out-of-date and needs to be rebuilt\n✖ [3172/4152] Building Mathlib.LinearAlgebra.SModEq.Basic\nerror: target is out-of-date and needs to be rebuilt\nSome required targets logged failures:\n- Mathlib.Algebra.CharP.Lemmas\n- Mathlib.Algebra.CharP.Quotient\n- Mathlib.LinearAlgebra.SModEq.Basic\n</code></pre></div>\n<p>It looks like <code>master</code> was merged into that branch fairly recently so there shouldn't be a difference in <code>Cache</code> versions?</p>",
        "id": 553373434,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1762174267
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.22verify.20that.20everything.20was.20available.20in.20the.20cache.22.20fails.20CI/near/553295210\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> I seem to recall that you worked on / looked at this part of cache around when we switched to forks? Is this intended?</p>\n</blockquote>\n<p>The assumptions made about <code>git</code> states in the logic are bad. We need to identify the use cases we care about and then write behavior tests to assure things work as expected.</p>",
        "id": 553374025,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1762174458
    },
    {
        "content": "<p>5 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/.22verify.20that.20everything.20was.20available.20in.20the.20cache.22.20fails.20CI/with/553260110\">#mathlib4 &gt; \"verify that everything was available in the cache\" fails CI</a> by <span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span>.</p>",
        "id": 553502041,
        "sender_full_name": "Notification Bot",
        "timestamp": 1762214654
    }
]