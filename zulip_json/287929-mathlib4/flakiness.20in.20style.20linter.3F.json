[
    {
        "content": "<p>Today a number of bors batches ended up failing due to a style problems coming from code in <code>master</code>, see e.g. <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/10795565667/job/29942539860s\">this log</a>. This was fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/16677\">#16677</a>, but the underlying issue of how this code snuck past the style linter is still unresolved.</p>\n<p>If anyone can help investigate this, it would be greatly appreciated! It looks like this time the culprit PR was <a href=\"https://github.com/leanprover-community/mathlib4/pull/16317\">#16317</a>. It seems to have passed all the checks before merging, and got a green check on <code>master</code> as well. What's also strange is that not all of the bors batches failed, e.g. <a href=\"https://github.com/leanprover-community/mathlib4/pull/16611\">#16611</a> was merged successfully.</p>\n<p>Note that a similar incident occurred a few weeks ago with <a href=\"https://github.com/leanprover-community/mathlib4/pull/16255\">#16255</a> getting merged with style issues and <a href=\"https://github.com/leanprover-community/mathlib4/pull/16292\">#16292</a> fixing them.</p>",
        "id": 469155605,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1725987574
    },
    {
        "content": "<p>I'll try to take a look, but it will likely be tomorrow.</p>",
        "id": 469156283,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1725987678
    },
    {
        "content": "<p>I could only take a quick look, but I can see that the failed linter step in the log that you linked to is <em>preceded</em> by a (failed? not executed?) <code>install Python</code> check.</p>",
        "id": 469218255,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726003950
    },
    {
        "content": "<p>Today there was an <a href=\"#narrow/stream/287929-mathlib4/topic/CI.20install.20bibtools\">issue with CI</a> that made other similar installation steps take long and maybe timeout and fail.</p>",
        "id": 469218366,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726004010
    },
    {
        "content": "<p>I still think that CI should have picked this up, but maybe it is an indication that there was some unusual <em>external</em> condition that made CI pass even with the linter warnings?</p>",
        "id": 469218534,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726004068
    },
    {
        "content": "<p>I think skipping <code>install Python</code> is expected, per <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/10795565667/workflow#L59\">this line in the workflow</a>.</p>",
        "id": 469218594,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1726004102
    },
    {
        "content": "<p>Ah, ok.  Back to debugging...  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 469218925,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726004244
    },
    {
        "content": "<p>I don't have more time today, I'll try to investigate more tomorrow.</p>",
        "id": 469219366,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726004456
    },
    {
        "content": "<p>Thanks very much for taking this on!</p>",
        "id": 469219520,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1726004530
    },
    {
        "content": "<p>In case it helps to localize the issue, I think I already had this 2 weeks ago here:</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16257\">https://github.com/leanprover-community/mathlib4/pull/16257</a></p>",
        "id": 469227810,
        "sender_full_name": "Adomas Baliuka",
        "timestamp": 1726008414
    },
    {
        "content": "<p>Yes, it looks like your PR was one of the victims from <a href=\"https://github.com/leanprover-community/mathlib4/pull/16255\">#16255</a> sneaking past the linter somehow.</p>",
        "id": 469228087,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1726008560
    },
    {
        "content": "<p>This is very confusing: the tests work on the same code... sometimes!</p>\n<p>I wonder whether it is caused by the fact that there are different scripts for the linters floating around and these are PRs that use a temporary faulty script, that is no longer in master, but is somehow used by CI?</p>",
        "id": 469287614,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726032951
    },
    {
        "content": "<p>Hmm, but when each PR is sent to bors it should be placed on top of <code>master</code> which should always have the latest version of the scripts, right?</p>",
        "id": 469289207,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1726033917
    },
    {
        "content": "<p>Just brainstorming some possible sources of non-determinism before bed (without ever having studied the style linter code), but:</p>\n<p>Whenever style linting is run, it is run on every single file in mathlib, right? There shouldn't be any circumstances when we skip linting some files due to some caching or something?</p>\n<p>The order that files are linted in shouldn't affect the results of style linting, right?</p>",
        "id": 469289696,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1726034123
    },
    {
        "content": "<p>I have not written the text-based linters (which check, for instance, wrong indentation and ending whitespace), but my understanding is that indeed they run on every file and each file is a completely separate and independent run.</p>",
        "id": 469291593,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726034990
    },
    {
        "content": "<p>Here is a possible explanation.</p>\n<ol>\n<li>The text-based linters are run in a workflow <em>separate</em> from the main build;</li>\n<li>the text-based linters use the content of <code>{Mathlib Archive Counterexamples}.lean</code> to decide what to lint;</li>\n<li>the <code>mk_all</code> script is in the main build and takes some time to run;</li>\n<li>by the time the lint workflow reaches the actual linting, it may or may not be the case that the <code>mk_all</code> script has added all the new files to <code>Mathlib.lean</code>;</li>\n<li>if the files are missing from <code>Mathlib.lean</code>, the linting does not inspect them.</li>\n</ol>",
        "id": 469297650,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726037490
    },
    {
        "content": "<p>Given that the text-based linters use <code>Mathlib.lean</code>, I am tempted to add anyway a <code>lake exe mk_all</code> step to the <code>Lint style</code> workflow, just in case it matters.</p>",
        "id": 469298706,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726037858
    },
    {
        "content": "<p>Damiano, if it's a separate workflow, whatever <code>mk_all</code> does in the main workflow is completely irrelevant: it's probably running on different machine!</p>",
        "id": 469299328,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726038069
    },
    {
        "content": "<p>Ah, that would also explain the flakiness!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 469299431,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726038099
    },
    {
        "content": "<p>Let me add the <code>mk_all</code> step anyway, since it will make it at least lint all the mathlib files anyway.</p>",
        "id": 469299520,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726038126
    },
    {
        "content": "<p>Oh, sorry, it is not a different <em>workflow</em> it is a different <em>step</em> in the same workflow.</p>",
        "id": 469299673,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726038202
    },
    {
        "content": "<p>(Not sure about the exact name: it is in the same file, but it is run independently of the <code>build</code> step.)</p>",
        "id": 469299847,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726038245
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16696\">#16696</a></p>",
        "id": 469300449,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726038467
    },
    {
        "content": "<p>In that case it is operating on the same local files.</p>",
        "id": 469307269,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1726040018
    },
    {
        "content": "<p>Ok, I'm not sure that my explanation for why some CI runs fail to identify linter failures is correct, but I do think that adding <code>lake exe mk_all</code> before linting makes the linting step more reliable.</p>",
        "id": 469309529,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726040575
    },
    {
        "content": "<p>That makes no sense to me. If <code>mk_all</code> changes something, bors shouldn't merge</p>",
        "id": 469320592,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726042955
    },
    {
        "content": "<p>I have seen a situation where a first run of bors fails, it bisects the PRs, runs again and now it is successful due to some modification that happened in the previous run.  I wonder if maybe this is an explanation?</p>",
        "id": 469321869,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726043141
    },
    {
        "content": "<p>(Anyway, I am just brainstorming at the moment, I do not understand what is going on.)</p>",
        "id": 469322206,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726043201
    },
    {
        "content": "<p>(The entire situation makes no sense to me either)</p>",
        "id": 469324067,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726043551
    },
    {
        "content": "<p>Also the failures in <a href=\"https://github.com/leanprover-community/mathlib4/pull/16317\">#16317</a> should have been caught by the python linter, which doesn't seem to read Mathlib.lean at all</p>",
        "id": 469329232,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726044468
    },
    {
        "content": "<p>Oh hmm.</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>./scripts/print-style-errors.sh\nxargs:<span class=\"w\"> </span>unmatched<span class=\"w\"> </span>single<span class=\"w\"> </span>quote<span class=\"p\">;</span><span class=\"w\"> </span>by<span class=\"w\"> </span>default<span class=\"w\"> </span>quotes<span class=\"w\"> </span>are<span class=\"w\"> </span>special<span class=\"w\"> </span>to<span class=\"w\"> </span>xargs<span class=\"w\"> </span>unless<span class=\"w\"> </span>you<span class=\"w\"> </span>use<span class=\"w\"> </span>the<span class=\"w\"> </span>-0<span class=\"w\"> </span>option\n</code></pre></div>",
        "id": 469329720,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726044552
    },
    {
        "content": "<p>Two comments from the peanut gallery. I sadly won't have time to look into this for two weeks.<br>\nNice robustness improvement! I'm not sure if it will help, though: the text-based linter calls <code>lint-style.py</code> via <code>print-style-errors.sh</code> --- which uses <code>find</code> and not <code>Mathlib.lean</code> for determining which files to lint.</p>\n<p>In terms of recent bugfixes/changes to the handling of Python linters: did the PR include <a href=\"https://github.com/leanprover-community/mathlib4/pull/15954\">#15954</a> already?<br>\nPut differently: if you can reproduce the error in local testing, does running <code>lint-style.py</code> on the affected file find it? Does running <code>print-style-errors.sh</code> find it? (If the answer is yes and yes, but <code>lake exe lint-style</code> does not, that sounds like <a href=\"https://github.com/leanprover-community/mathlib4/pull/15954\">#15954</a>.)</p>",
        "id": 469330021,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1726044630
    },
    {
        "content": "<p>Great find!  I'm still not sure why it later decided to do the right thing, once stuff was in master, but finding an error is a good thing!</p>",
        "id": 469330087,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726044640
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/287929-mathlib4/topic/flakiness.20in.20style.20linter.3F/near/469329720\">said</a>:</p>\n<blockquote>\n<p>Oh hmm.</p>\n<p><div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>./scripts/print-style-errors.sh\nxargs:<span class=\"w\"> </span>unmatched<span class=\"w\"> </span>single<span class=\"w\"> </span>quote<span class=\"p\">;</span><span class=\"w\"> </span>by<span class=\"w\"> </span>default<span class=\"w\"> </span>quotes<span class=\"w\"> </span>are<span class=\"w\"> </span>special<span class=\"w\"> </span>to<span class=\"w\"> </span>xargs<span class=\"w\"> </span>unless<span class=\"w\"> </span>you<span class=\"w\"> </span>use<span class=\"w\"> </span>the<span class=\"w\"> </span>-0<span class=\"w\"> </span>option\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I saw that in local testing also (and sadly have <em>no</em> idea where this comes from). Running <code>lake exe lint-style</code> still errored for me, though - so this shouldn't matter. (Unless I'm wrong :-))</p>",
        "id": 469330264,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1726044671
    },
    {
        "content": "<p>It's probably <code>Mathlib.Tactic.LinearCombination'</code></p>",
        "id": 469330317,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726044685
    },
    {
        "content": "<p>Let's see if I can verify that...</p>",
        "id": 469330516,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726044728
    },
    {
        "content": "<p>So, besides the <code>'</code> linter for declaration names, there is also the need for a <code>'</code> linter for <em>file</em> names!</p>",
        "id": 469330563,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726044743
    },
    {
        "content": "<p>which can be purely text-based :-)</p>",
        "id": 469330705,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1726044767
    },
    {
        "content": "<p>There is already a check that filenames are unique up to capitalization.  Maybe filenames should consist just of upper/lower case letters?</p>",
        "id": 469331089,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726044841
    },
    {
        "content": "<p>Bingo!</p>",
        "id": 469331191,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726044857
    },
    {
        "content": "<p>If <code>Mathlib/Tactic/LinearCombination'.lean</code> comes before the offending file in the <code>find</code> output, it fails to fail (heh), otherwise it finds the issue</p>",
        "id": 469331518,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726044915
    },
    {
        "content": "<p>So, an alternative could be to rename <code>Mathlib/Tactic/LinearCombination'.lean</code> to <code>Mathlib/Z/Tactic/LinearCombination'.lean</code>.</p>",
        "id": 469331836,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726044973
    },
    {
        "content": "<p>Or <code>Mathlib/ZZZZZZZZZZZZZZZZZZZZZZZ/Tactic/LinearCombination'.lean</code>, just to be safe.</p>",
        "id": 469332226,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1726045030
    },
    {
        "content": "<p>Fix incoming</p>",
        "id": 469332394,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726045066
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16699\">#16699</a></p>",
        "id": 469333219,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726045226
    },
    {
        "content": "<p>Wow, thanks for getting to the bottom of this!</p>",
        "id": 469385182,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1726057980
    },
    {
        "content": "<p>It's annoying that <code>IO.Process.run</code> just drops the stderr on the floor</p>",
        "id": 469386321,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726058312
    },
    {
        "content": "<p>Use <code>Process.output</code>?</p>",
        "id": 469387859,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1726058780
    },
    {
        "content": "<p>Then I'd have to basically inline <code>run</code>, right?</p>",
        "id": 469393576,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1726060313
    },
    {
        "content": "<p>I don't really know what your requirements are. But it's not much to inline.</p>",
        "id": 469394365,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1726060528
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16709\">#16709</a> fixes this, and is just three added lines</p>",
        "id": 469409214,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1726063509
    }
]