[
    {
        "content": "<p>Just saw this in the output of the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/13633695415/job/38107125156\">current staging CI run</a>, under \"Print the sizes of the oleans\":</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Run</span><span class=\"w\"> </span><span class=\"n\">du</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"This code should be unreachable\"</span>\n<span class=\"w\">  </span><span class=\"n\">du</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"This code should be unreachable\"</span>\n<span class=\"w\">  </span><span class=\"n\">shell</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">usr</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">bash</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">env</span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">LAKE_NO_CACHE</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"n\">du</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">access</span><span class=\"w\"> </span><span class=\"bp\">'.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib'</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n<span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">unreachable</span>\n</code></pre></div>\n<p>This clearly shouldn't be happening, although it doesn't seem to be doing any actual harm. (Apologies if this has been reported before.)</p>",
        "id": 503056379,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741016044
    },
    {
        "content": "<p>I had never seen it and I did think that the code marked as unreachable was unreachable (or, more realistically, I hoped that it would be).</p>",
        "id": 503060030,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741016933
    },
    {
        "content": "<p>Those checks were there in any case precisely to make sure that s <code>Print the oleans</code> step would not prevent CI from passing.</p>",
        "id": 503060224,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741016980
    },
    {
        "content": "<p>The PR that you linked is a toolchain bump.  I am not sure why the script should fail there.  The failure seems to be because the dir <code>.lake/build/lib/Mathlib</code> does not exist, but if I checkout the branch and type the <code>du ...</code> command, it works.</p>",
        "id": 503063001,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741017677
    },
    {
        "content": "<p>It moved to <code>.lake/build/lib/lean/Mathlib</code> I think</p>",
        "id": 503063636,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741017789
    },
    {
        "content": "<p>Ah, so the path should be updated?</p>",
        "id": 503063778,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741017831
    },
    {
        "content": "<p>So, maybe, when I checked out the branch, the command picked up the path that existed on my computer, but was not the one to where lake would have saved the oleans?</p>",
        "id": 503063976,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741017865
    },
    {
        "content": "<p>Yes, indeed, <code>lake build</code> now stores the files inside a further <code>lean</code> dir.</p>",
        "id": 503065342,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741018140
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22506\">#22506</a></p>",
        "id": 503069106,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741018898
    },
    {
        "content": "<p>I realised that there is also a step that removes the old cache files that is now removing the old path, but not the new one.  I updated the PR above to fix that as well.</p>",
        "id": 503222994,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741081911
    }
]