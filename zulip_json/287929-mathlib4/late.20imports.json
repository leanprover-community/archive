[
    {
        "content": "<p>This isn't a \"technical debt\" metric (so perhaps we should move this to a new topic), but I think the following is very interesting:</p>\n<ol>\n<li>Turn on <code>linter.minImports</code> globally:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"c1\">--git a/lakefile.lean b/lakefile.lean</span>\n<span class=\"n\">index</span><span class=\"w\"> </span><span class=\"mi\">2296</span><span class=\"n\">f7f90db</span><span class=\"bp\">..</span><span class=\"n\">a553d8a3789</span><span class=\"w\"> </span><span class=\"mi\">100644</span>\n<span class=\"c1\">--- a/lakefile.lean</span>\n<span class=\"bp\">+++</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">/</span><span class=\"n\">lakefile</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">@@</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">39</span><span class=\"o\">,</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"mi\">39</span><span class=\"o\">,</span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"bp\">@@</span><span class=\"w\"> </span><span class=\"kn\">abbrev</span><span class=\"w\"> </span><span class=\"n\">mathlibOnlyLinters</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">LeanOption</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">   </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.longFile</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"mi\">1500</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">   </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.missingEnd</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">   </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.multiGoal</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"bp\">-</span><span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.setOption</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span>\n<span class=\"bp\">+</span><span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.style.setOption</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"bp\">+</span><span class=\"w\">  </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.minImports</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span>\n<span class=\"w\"> </span><span class=\"o\">]</span>\n\n<span class=\"w\"> </span><span class=\"sd\">/-- These options are passed as `leanOptions` to building mathlib, as well as the</span>\n</code></pre></div>\n<ol start=\"2\">\n<li><code>lake build &gt; minImport</code></li>\n<li><code>grep \"warning: .*Imports increased by [0-9][0-9]\" minImports | sort -t':' -k3,3nr | head -n 20</code> reports</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Module</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">2408</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Module</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">2356</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Matrix</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">2260</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">79</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Computability</span><span class=\"bp\">/</span><span class=\"n\">TuringMachine</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">2119</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Asymptotics</span><span class=\"bp\">/</span><span class=\"n\">Asymptotics</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1932</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">19</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Set</span><span class=\"bp\">/</span><span class=\"n\">Lattice</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1810</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">75</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Asymptotics</span><span class=\"bp\">/</span><span class=\"n\">Asymptotics</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1802</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Category</span><span class=\"bp\">/</span><span class=\"n\">Profinite</span><span class=\"bp\">/</span><span class=\"n\">Nobeling</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1756</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">65</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">InnerProductSpace</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1635</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">UniformSpace</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1617</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">23</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">DFinsupp</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1603</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Order</span><span class=\"bp\">/</span><span class=\"n\">Floor</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1583</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">SetTheory</span><span class=\"bp\">/</span><span class=\"n\">Cardinal</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1576</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Geometry</span><span class=\"bp\">/</span><span class=\"n\">Manifold</span><span class=\"bp\">/</span><span class=\"n\">SmoothManifoldWithCorners</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1493</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">206</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Analysis</span><span class=\"bp\">/</span><span class=\"n\">Asymptotics</span><span class=\"bp\">/</span><span class=\"n\">Asymptotics</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1470</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">ContinuousMap</span><span class=\"bp\">/</span><span class=\"n\">Bounded</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1390</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">MeasureTheory</span><span class=\"bp\">/</span><span class=\"n\">MeasurableSpace</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1388</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Category</span><span class=\"bp\">/</span><span class=\"n\">Profinite</span><span class=\"bp\">/</span><span class=\"n\">Nobeling</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1361</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">127</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Topology</span><span class=\"bp\">/</span><span class=\"n\">Category</span><span class=\"bp\">/</span><span class=\"n\">Profinite</span><span class=\"bp\">/</span><span class=\"n\">Nobeling</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">1356</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"n\">to</span>\n</code></pre></div>\n<p>This is identifying files in Mathlib where an import is \"newly used\" very late in a file, and substantially increasing the number of transitive imports.</p>",
        "id": 480391152,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730709271
    },
    {
        "content": "<p>e.g. this is saying that up to line 2408(!!) of <code>Mathlib/Topology/Algebra/Module/Basic.lean</code> there is some import that has not been necessary so far in the file, but becomes necessary at this point and pulls in a total of 17 transitive imports.</p>",
        "id": 480391317,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730709344
    },
    {
        "content": "<p>I feel like these are great targets for splitting --- the overlap of \"large files\" and \"files with lots of content that do not use some of the imports\".</p>",
        "id": 480391444,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730709377
    },
    {
        "content": "<p>I'd love to see us make regular progress on reducing that <code>2408</code>.</p>",
        "id": 480391496,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730709397
    },
    {
        "content": "<p>I wonder whether this should be a linter.</p>",
        "id": 480391566,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730709431
    },
    {
        "content": "<p>I don't think this makes sense as an always on linter. More a regular zulip bot.</p>",
        "id": 480391639,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730709464
    },
    {
        "content": "<p>Yes, I agree.  It may probably also post what is the latest import.</p>",
        "id": 480392022,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730709608
    },
    {
        "content": "<p>I remember running a similar experiment while testing the linter, but I cannot find the thread now.</p>",
        "id": 480392051,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730709632
    },
    {
        "content": "<p><a href=\"#narrow/channel/144837-PR-reviews/topic/.2314437.20--.20the.20.60.23min_imports.60.20command/near/450361940\">Found it</a>.</p>",
        "id": 480392469,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730709808
    },
    {
        "content": "<p>9 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Technical.20Debt.20Counters\">#mathlib4 &gt; Technical Debt Counters</a> by <span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span>.</p>",
        "id": 480392686,
        "sender_full_name": "Notification Bot",
        "timestamp": 1730709902
    },
    {
        "content": "<p>Is there a way to get this report without having to rebuild all of mathlib?</p>",
        "id": 480392718,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730709915
    },
    {
        "content": "<p>probably not</p>",
        "id": 480392792,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730709951
    },
    {
        "content": "<p>Often I have wanted to have an option for linters that they could be turned on \"after the fact\".</p>",
        "id": 480392817,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730709961
    },
    {
        "content": "<p>This is maybe not reasonable, but could there not be a version of a \"weak linter\" that is guaranteed to just log information and therefore does not require rebuilding?</p>",
        "id": 480392989,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730710024
    },
    {
        "content": "<p>Looking at the thread, it looks like Kim already suggested working this statistics into the tech-debts report and that I had volunteered to do it!</p>",
        "id": 480394449,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730710587
    },
    {
        "content": "<p>I guess that I better get to work! <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 480394452,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730710589
    },
    {
        "content": "<p>I still do not understand how to set <code>weak</code> options.</p>\n<p>I thought that running</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>lake<span class=\"w\"> </span>build<span class=\"w\">  </span>-Kweak.linter.minImports<span class=\"o\">=</span><span class=\"nb\">true</span>\n</code></pre></div>\n<p>would build <code>Mathlib</code> setting the <code>linter.minImports</code> option to true.  However, the build simply uses the available cache.  What am I doing wrong?</p>",
        "id": 480411507,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730715674
    },
    {
        "content": "<p>I guess that <code>-K</code> options get ignored for computing the traces...</p>",
        "id": 480418061,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730717743
    },
    {
        "content": "<p>I was just adding the option in the lakefile.</p>",
        "id": 480418082,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730717750
    },
    {
        "content": "<p>(thereby invalidating the traces)</p>",
        "id": 480418098,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730717757
    },
    {
        "content": "<p>Ok, I thought that it would have been more principled to use the command-line option, but it seems like modifying the lakefile is the more robust way forward, thanks!</p>",
        "id": 480418772,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730717941
    },
    {
        "content": "<p>Naive question: can this information not be \"read off from the oleans\" in some way, rather than recompiling everything?</p>",
        "id": 480485968,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1730739005
    },
    {
        "content": "<p>Most of it, probably yes, although I do not think that the oleans store any information about tactics used, for instance.</p>",
        "id": 480486939,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730739313
    },
    {
        "content": "<p>Or notation.</p>",
        "id": 480486977,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730739326
    },
    {
        "content": "<p>So, you can reconstruct information of how to write the explicit term of each proof, probably.</p>",
        "id": 480487156,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730739368
    },
    {
        "content": "<p>Ah, there is also the issue that I do not think that there is a meaningful ordering to the declarations appearing in the oleans, but I am less sure about this.</p>",
        "id": 480487342,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730739427
    },
    {
        "content": "<p>this is true, but the oleans do have declaration ranges, so you can try to work out where in the file they were defined that way</p>",
        "id": 480503812,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1730745222
    },
    {
        "content": "<p>Ok, thanks for confirming!</p>",
        "id": 480504115,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730745349
    },
    {
        "content": "<p>Also, the linter does make use of the environment, so it is using the oleans already for the purely expression part.</p>",
        "id": 480504221,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730745383
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18631\">#18631</a> has a (primitive) CI workflow that could post something like what is below on Zulip.</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left;\">File</th>\n<th style=\"text-align: right;\">Line</th>\n<th style=\"text-align: right;\">Import increase</th>\n<th style=\"text-align: left;\">New imports</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Topology/Algebra/Module/Basic.lean</td>\n<td style=\"text-align: right;\">2527</td>\n<td style=\"text-align: right;\">17</td>\n<td style=\"text-align: left;\">[Mathlib.Topology.Algebra.Group.Quotient]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Data/Matrix/Basic.lean</td>\n<td style=\"text-align: right;\">2260</td>\n<td style=\"text-align: right;\">80</td>\n<td style=\"text-align: left;\">[Mathlib.Algebra.Star.Module]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Data/Set/Lattice.lean</td>\n<td style=\"text-align: right;\">1810</td>\n<td style=\"text-align: right;\">75</td>\n<td style=\"text-align: left;\">[Mathlib.Logic.Pairwise]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Topology/Category/Profinite/Nobeling.lean</td>\n<td style=\"text-align: right;\">1756</td>\n<td style=\"text-align: right;\">66</td>\n<td style=\"text-align: left;\">[Mathlib.Algebra.Category.ModuleCat.Free]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Topology/UniformSpace/Basic.lean</td>\n<td style=\"text-align: right;\">1617</td>\n<td style=\"text-align: right;\">22</td>\n<td style=\"text-align: left;\">[Mathlib.Topology.Compactness.Compact, Init.Data.List.Nat.Pairwise]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Algebra/Order/Floor.lean</td>\n<td style=\"text-align: right;\">1583</td>\n<td style=\"text-align: right;\">12</td>\n<td style=\"text-align: left;\">[Mathlib.Data.Int.Lemmas]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Topology/ContinuousMap/Bounded.lean</td>\n<td style=\"text-align: right;\">1390</td>\n<td style=\"text-align: right;\">24</td>\n<td style=\"text-align: left;\">[Mathlib.Analysis.CStarAlgebra.Basic]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/MeasureTheory/MeasurableSpace/Basic.lean</td>\n<td style=\"text-align: right;\">1388</td>\n<td style=\"text-align: right;\">16</td>\n<td style=\"text-align: left;\">[Mathlib.Order.LiminfLimsup]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/RingTheory/TensorProduct/Basic.lean</td>\n<td style=\"text-align: right;\">1270</td>\n<td style=\"text-align: right;\">84</td>\n<td style=\"text-align: left;\">[Mathlib.RingTheory.Finiteness]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/RingTheory/Polynomial/Basic.lean</td>\n<td style=\"text-align: right;\">1233</td>\n<td style=\"text-align: right;\">13</td>\n<td style=\"text-align: left;\">[Mathlib.RingTheory.Polynomial.Content]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/LinearAlgebra/QuadraticForm/Basic.lean</td>\n<td style=\"text-align: right;\">1207</td>\n<td style=\"text-align: right;\">10</td>\n<td style=\"text-align: left;\">[Init.Data.ULift, Mathlib.LinearAlgebra.FiniteDimensional, Init.Data.Fin.Fold]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Topology/PartialHomeomorph.lean</td>\n<td style=\"text-align: right;\">1191</td>\n<td style=\"text-align: right;\">21</td>\n<td style=\"text-align: left;\">[Mathlib.Topology.Sets.Opens]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Algebra/Order/Module/Defs.lean</td>\n<td style=\"text-align: right;\">1173</td>\n<td style=\"text-align: right;\">22</td>\n<td style=\"text-align: left;\">[Mathlib.Tactic.Positivity.Core]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/GroupTheory/FreeGroup/Basic.lean</td>\n<td style=\"text-align: right;\">1145</td>\n<td style=\"text-align: right;\">31</td>\n<td style=\"text-align: left;\">[Mathlib.Data.Fintype.Basic]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/Algebra/Module/LocalizedModule.lean</td>\n<td style=\"text-align: right;\">1141</td>\n<td style=\"text-align: right;\">97</td>\n<td style=\"text-align: left;\">[Mathlib.Algebra.Exact]</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">Mathlib/SetTheory/Ordinal/Notation.lean</td>\n<td style=\"text-align: right;\">1140</td>\n<td style=\"text-align: right;\">19</td>\n<td style=\"text-align: left;\">[Mathlib.Tactic.NormNum.Pow]</td>\n</tr>\n</tbody>\n</table>",
        "id": 480550246,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730765727
    },
    {
        "content": "<p>Does this look useful?  The CI step also contains the full report, not just the \"top offenders\".</p>",
        "id": 480550329,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730765763
    },
    {
        "content": "<p>I think I'd prefer that the post to zulip only reports things with a \"significant\" (e.g. &gt;=10) increase in number of transitive imports. Just adding one new import late in a file is not really a problem. (If it's just one transitive import, it is clearly introducing something that is very close in subject matter, so there's not going to be an interesting split available.)</p>",
        "id": 480550853,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730766106
    },
    {
        "content": "<p>Sure, that is an easy enough filter!</p>",
        "id": 480550921,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730766132
    },
    {
        "content": "<p>I updated the list above to only contain the first few \"late-importers\" that increased the number of imports by at least 10.</p>",
        "id": 480551310,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730766398
    },
    {
        "content": "<p>(Looks like the PR deleted build.yml?)</p>",
        "id": 480551585,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730766542
    },
    {
        "content": "<p>Yes, I deleted build so that it would only build mathlib once, with the linter.</p>",
        "id": 480551681,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730766602
    },
    {
        "content": "<p>I am planning to restore the usual CI and put this one in a cron job.</p>",
        "id": 480551731,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730766616
    },
    {
        "content": "<p>Sounds good. We can also hopefully run it manually, after PRs that improve the table.</p>",
        "id": 480551782,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730766642
    },
    {
        "content": "<p>Yes, I know that Bryan has a trick to make CI actions be activated manually: I'll look at how those are done.</p>",
        "id": 480551846,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730766683
    },
    {
        "content": "<p>Claiming</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Matrix</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"mi\">2260</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Star</span><span class=\"bp\">.</span><span class=\"n\">Module</span>\n</code></pre></div>",
        "id": 480553048,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730767421
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/480551846\">said</a>:</p>\n<blockquote>\n<p>Yes, I know that Bryan has a trick to make CI actions be activated manually: I'll look at how those are done.</p>\n</blockquote>\n<p>You can just put <code>workflow_dispatch</code> as one of the triggers under the <code>on:</code> section (<a href=\"https://github.com/leanprover-community/mathlib4/blob/8bad983b8e4adf7e111ef16e32e757bb95ef63e3/.github/workflows/technical_debt_metrics.yml#L6\">Random example</a>). Generally this is only useful for workflows that are run on a schedule since for e.g. workflows run on push, the \"workflow_dispatch\" event won't contain data about the PR / commit.</p>",
        "id": 480554734,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1730768473
    },
    {
        "content": "<p>I updated the PR:</p>\n<ul>\n<li><code>workflow dispatch</code> should mean that the workflow can be run manually (not really sure how, though);</li>\n<li>it will post on Mondays on the same schedule as the Technical Debt Metrics, but in a separate channel (and later, since the workflow lasts longer).</li>\n</ul>",
        "id": 480554744,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768479
    },
    {
        "content": "<p>Ok, so I did the right thing, without knowing what I am doing!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 480554774,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768511
    },
    {
        "content": "<p>If you prefer that the report is run on a different day or posts to the same thread as the other one, let me know.</p>",
        "id": 480554864,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768559
    },
    {
        "content": "<p>Otherwise, <a href=\"https://github.com/leanprover-community/mathlib4/pull/18631\">#18631</a> is ready!</p>",
        "id": 480554873,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768566
    },
    {
        "content": "<p>It would be good is someone started the workflow manually, just to check that everything works as intended: there are many moving parts and lots of places for stuff to go wrong!</p>",
        "id": 480554905,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768602
    },
    {
        "content": "<p>However, the run takes about 2 hours and I am about to go to bed!</p>",
        "id": 480554929,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768633
    },
    {
        "content": "<p>What little I know about <code>workflow_dispatch</code> is the first two or three sentences here: <a href=\"https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#workflow_dispatch\">https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#workflow_dispatch</a><br>\n(Reading further now for the first time, it looks like there are a bunch of fancy options I never knew about!)</p>",
        "id": 480555013,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1730768678
    },
    {
        "content": "<p>Btw, I am not sure about whether all the preparation steps before <code>lake build</code> are really necessary: feel free to prune what is not needed!</p>",
        "id": 480555051,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768706
    },
    {
        "content": "<p>I suspect that the workflow can only be dispatched if it is merged in master already?</p>",
        "id": 480555252,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768862
    },
    {
        "content": "<p>Yeah, I think that's right.</p>",
        "id": 480555341,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1730768915
    },
    {
        "content": "<p>OK, I am going to push a branch where the action is actually active and maybe in a couple of hours it will post a report: does that sound reasonable?</p>",
        "id": 480555431,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730768994
    },
    {
        "content": "<p>Yeah sure! I've started looking at the workflow code and will try and leave some comments for when you wake up again <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 480555566,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1730769080
    },
    {
        "content": "<p>This is the test PR: <a href=\"https://github.com/leanprover-community/mathlib4/pull/18636\">#18636</a>.</p>",
        "id": 480555658,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730769148
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/480553048\">said</a>:</p>\n<blockquote>\n<p>Claiming</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Matrix</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\"> </span><span class=\"mi\">2260</span><span class=\"w\"> </span><span class=\"mi\">80</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Star</span><span class=\"bp\">.</span><span class=\"n\">Module</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18643\">#18643</a></p>",
        "id": 480583338,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730786692
    },
    {
        "content": "<p>That's a very reasonable split <span aria-label=\"peace sign\" class=\"emoji emoji-270c\" role=\"img\" title=\"peace sign\">:peace_sign:</span></p>",
        "id": 480585820,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730788211
    },
    {
        "content": "<p>Claiming</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">TensorProduct</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\">     </span><span class=\"mi\">1270</span><span class=\"w\">    </span><span class=\"mi\">84</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">Finiteness</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 480658924,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730793076
    },
    {
        "content": "<p>Here's one I came across organically: the file defining <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.prod#doc\">docs#Finset.prod</a> imports <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sym2#doc\">docs#Finset.sym2</a> (8 extra imports) on line 2260. <a href=\"https://github.com/leanprover-community/mathlib4/pull/18650\">#18650</a></p>",
        "id": 480663197,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1730794639
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/480663197\">said</a>:</p>\n<blockquote>\n<p>Here's one I came across organically: the file defining <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.prod#doc\">docs#Finset.prod</a> imports <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sym2#doc\">docs#Finset.sym2</a> (8 extra imports) on line 2260. <a href=\"https://github.com/leanprover-community/mathlib4/pull/18650\">#18650</a></p>\n</blockquote>\n<p>Nice, 2600 files with 6 fewer imports.</p>",
        "id": 480673048,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730798011
    },
    {
        "content": "<p>Once the dust settles, we may consider adding a CI step on PRs that flags late importers just among the modified files.</p>",
        "id": 480674968,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730798669
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/480658924\">said</a>:</p>\n<blockquote>\n<p>Claiming</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">TensorProduct</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\">     </span><span class=\"mi\">1270</span><span class=\"w\">    </span><span class=\"mi\">84</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">RingTheory</span><span class=\"bp\">.</span><span class=\"n\">Finiteness</span><span class=\"o\">]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18653\">#18653</a></p>",
        "id": 480687520,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730802439
    },
    {
        "content": "<p>Claiming</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Module</span><span class=\"bp\">/</span><span class=\"n\">LocalizedModule</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"w\">     </span><span class=\"mi\">1141</span><span class=\"w\">    </span><span class=\"mi\">97</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Exact</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 480688236,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730802637
    },
    {
        "content": "<blockquote>\n<p>chore: split Algebra.Module.LocalizedModule <a href=\"https://github.com/leanprover-community/mathlib4/pull/18657\">#18657</a></p>\n</blockquote>\n<p>[switching to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Late.20importers.20report\">#mathlib4 &gt; Late importers report</a> now]</p>",
        "id": 480702464,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1730807461
    },
    {
        "content": "<p>I just moved a few declarations from the end of a 1000-line-long file (<code>Mathlib/Algebra/Group/Submonoid/Operations.lean</code>) into a short new file in <a href=\"https://github.com/leanprover-community/mathlib4/pull/21067\">#21067</a> with fewer imports (in preparation for a minor refactor which is of no relevance here) and then I imported the short file back into the long file (the short file  compiled without needing to import the long file). Then lake shake got very excited. Turns out that a couple of files in mathlib (<code>Mathlib/GroupTheory/GroupAction/Defs.lean</code>, <code>Mathlib/GroupTheory/OreLocalization/Basic.lean</code>) were importing the entire 1000-line-long file just because they needed those few declarations which I moved. This to me feels like the opposite of \"late imports\", it's more like \"late exports\", i.e. \"this mathlib file imported a huge thing but all it really wanted was the independent bit at the end, which it possibly used throughout\". Could one write a variant of the ideas being used in this thread to look for other instances of this phenomenon? Is there a chance that it could also be used to e.g. decrease the longest pole?</p>",
        "id": 495921797,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1737855547
    },
    {
        "content": "<p>Is this (roughly) what you are looking for:</p>\n<ul>\n<li>loop over all declarations in a file</li>\n<li>for each decl <code>d</code>, find its immediate dependencies, by inspecting its type and value</li>\n<li>if none of these dependencies are declared in the same file, then <code>d</code> is a \"late export\"</li>\n<li>get excited if a \"late export\" occurs at line number &gt; 500</li>\n</ul>",
        "id": 497032582,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1738337554
    },
    {
        "content": "<p>For the purpose of refactoring, any declaration that does not depend on the previous ones is a potential candidate for being moved to a different file.  So, it may be useful to simply flag \"exports\", not necessarily late.  Then it is up to the human to figure out a reasonable cut-off for what counts as being \"late enough to warrant a separate file\".</p>",
        "id": 497034898,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738338221
    },
    {
        "content": "<p>(Or maybe, 500 lines could be the default, but it could be useful that the user has the option of providing a different number.)</p>",
        "id": 497035267,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738338320
    },
    {
        "content": "<p>Yeah, I think we should just flag all of them. But of course there is no use in getting excited about the first decl in the file being flagged.</p>",
        "id": 497045391,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1738341447
    },
    {
        "content": "<p>My experience in developing is that sometimes you're working on a leaf file, or a file near the leaves, and you find some missing API which you need and which clearly should not be in the leafy file, so you think \"OK I'll be a good citizen and put it in the right place\", and then you decide that the right place maybe 1000 lines into some 1500-line-long file so you write a couple of lemmas and bung them in randomly. I've certainly done this before. The question is whether actually moving those lemmas into a new file makes the import tree nicer and it's not immediately obvious that it does, but lake shake convinced me that in this one example above I did. </p>\n<p>I guess one issue with Johan's proposal is that the last theorem in a file will always be a late export. Maybe it would be more interesting to find declarations which are (a) in large files (b) at least 500 lines <em>from the end</em> (c) are not used in the rest of the large file (so are candidates for removal) (d) are used in another file and (e) there are only two or three declarations from the large file used in the other file. </p>\n<p>Maybe the most naive question is this: can we find a file which imports a large file and the reason it does so is for precisely one theorem (say), and this one theorem it can be moved from the large file into a new file which doesn't need to import the large file? In other words, can we find theorems for which there is evidence that the theorem is \"in the wrong file\"?</p>",
        "id": 497055820,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738345022
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span> No, the <em>first</em> declaration will always be a late export. (Unless I'm misunderstanding the algorithm I wrote down.) What I intend is that decls get flagged if they don't use anything from the file they are in.</p>",
        "id": 497056186,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1738345149
    },
    {
        "content": "<p>Here's some data, from running Mathlib with <code>set_option linter.upstreamableDecl true</code> globally.</p>\n<p>Here are the files with declaration after line 500 that doesn't depend on anything in the file: <a href=\"https://gist.github.com/kim-em/5e40320da4e9962208b4285bf6218d21\">https://gist.github.com/kim-em/5e40320da4e9962208b4285bf6218d21</a></p>\n<p>Here's the full output: <a href=\"https://gist.github.com/kim-em/a020497289a0ebeb1de7e49abdb36758\">https://gist.github.com/kim-em/a020497289a0ebeb1de7e49abdb36758</a></p>\n<p>(<span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>)</p>",
        "id": 497406153,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738581974
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, the upstreamableDecl linter would be much more useful if it did not flag any <code>defs</code>. Could we have that?</p>",
        "id": 497407755,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738582402
    },
    {
        "content": "<p>Or I guess have two variants <code>upstreamableDecl</code> with the current behaviour, and <code>upstreamableThm</code> which only flags theorems.</p>",
        "id": 497407870,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738582441
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, it would also be helpful to not flag <code>private</code> declarations.</p>",
        "id": 497408208,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738582539
    },
    {
        "content": "<p>and, <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, while we're here, a bug report: <code>set_option linter.upstreamableDecl true</code> flags <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.le_add_left#doc\">docs#MeasureTheory.Measure.le_add_left</a> as movable to <code>Mathlib.Algebra.Order.Monoid.Canonical.Defs</code>, but that is clearly impossible as the <em>signature</em> of the theorem mentions <code>MeasurableSpace</code>.</p>\n<p>(Arguably, this theorem shouldn't exist because it is a needless specialization, but nevertheless this linter report is incorrect.)</p>",
        "id": 497409285,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738582813
    },
    {
        "content": "<p>(This problem seems quite widespread in the report.)</p>",
        "id": 497409558,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738582895
    },
    {
        "content": "<p>Unflagging <code>def</code>s and <code>private</code> declarations is very easy and I can look into that, though likely not before Wednesday.</p>",
        "id": 497420162,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738585660
    },
    {
        "content": "<p>As for the bug, I will have to look again at the implementation to see what is going on.</p>",
        "id": 497420619,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738585777
    },
    {
        "content": "<p>Most of the linter was written by <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span>: flagging you, in case you are not already watching this!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 497420626,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738585779
    },
    {
        "content": "<p>I have some time now to add a <code>upstreamableThm</code> mode. (<code>private</code> should be excluded from both versions, right?)</p>",
        "id": 497425452,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738587044
    },
    {
        "content": "<p>Anne, why not add two separate options, one for <code>private</code> and one for <code>def</code>?</p>",
        "id": 497425624,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738587086
    },
    {
        "content": "<p>That would allow users to make a choice, based on the situation.</p>",
        "id": 497425815,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738587124
    },
    {
        "content": "<p>I think that <code>def</code> and <code>private</code> are by default not linted, but can be opt-in.</p>",
        "id": 497425985,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738587159
    },
    {
        "content": "<p>True, but I think the best default is to exclude <code>private</code>. Since even if you might want to upstream it, the downstream breaks easily.</p>",
        "id": 497426242,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738587187
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/497409558\">said</a>:</p>\n<blockquote>\n<p>(This problem seems quite widespread in the report.)</p>\n</blockquote>\n<p>This is unfortunately a limitation of the syntax linter approach: we don't see any implicit arguments. So since the <code>MeasurableSpace</code> isn't listed explicitly, the linter doesn't realize it's required. And if the linter worked by terms, then we'd have <code>shake</code>'s issue of missing out on all the tactics and notation...</p>",
        "id": 497426869,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738587326
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21374\">#21374</a> adds two options: for including <code>defs</code> and for <code>private</code> decls.</p>",
        "id": 497438266,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738590092
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/497426869\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/497409558\">said</a>:</p>\n<blockquote>\n<p>(This problem seems quite widespread in the report.)</p>\n</blockquote>\n<p>This is unfortunately a limitation of the syntax linter approach: we don't see any implicit arguments. So since the <code>MeasurableSpace</code> isn't listed explicitly, the linter doesn't realize it's required. And if the linter worked by terms, then we'd have <code>shake</code>'s issue of missing out on all the tactics and notation...</p>\n</blockquote>\n<p>Can't we do both?</p>",
        "id": 497452286,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738593448
    },
    {
        "content": "<p>I don't know enough about the linter framework to do so, but if you have a stub I can surely fill it out.</p>",
        "id": 497456746,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738594466
    },
    {
        "content": "<p>Actually, for <code>theorem</code>s (as opposed to <code>def</code>s), the inclusion mechanism takes care of doing this for you: the variables that you see when you start the proof, are exactly the ones that make it into the environment constant.</p>",
        "id": 497493620,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738603335
    },
    {
        "content": "<p>So, it is hard to get reliable information about the variables used by a definition that make it into the environment, but the (in progress) <code>unusedVariableCommand</code> linter does a pretty good job with variables used in <code>theorem</code>s.</p>",
        "id": 497493866,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738603423
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17715\">#17715</a> is the linter.  Let me narrow it down to something more specific!</p>",
        "id": 497494115,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738603500
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/17715/files#diff-acc249ccb4fe8d80bafc836184bbfd75835a9b39d9a22f707c97d8f52bf77be3R157\"><code>includedVariables</code></a> is a <code>TermElabM</code> function for getting the unique names of variables that a theorem uses.</p>",
        "id": 497494580,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738603645
    },
    {
        "content": "<p>If I remember correctly, the environment records enough correspondences between unique <code>variable</code> names, <code>variable</code> usernames and <code>syntax</code> to figure out most of the rest.</p>",
        "id": 497494853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738603728
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, I don't think this has anything to do with <code>variables</code>. The problem is just that <code>upstreamableDecl</code> is not looking at the type signature of the definition.</p>",
        "id": 497590514,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738649814
    },
    {
        "content": "<p>Ah, I see.</p>",
        "id": 497607019,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738657881
    },
    {
        "content": "<p>I talked with Kim and they came up with an approach to also include the type signature: we already determine the name/ConstInfo of the declaration being linted, so we can take the union of the \"syntactically required modules\" with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Name.requiredModules#doc\">docs#Lean.Name.requiredModules</a> or <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.NameSet.transitivelyRequiredModules#doc\">docs#Lean.NameSet.transitivelyRequiredModules</a>, to feed into <code>irredundantImports</code>.</p>",
        "id": 497636685,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738666851
    },
    {
        "content": "<p>Great, thanks!  I have very little lean time this week, so I could not really look into this seriously!</p>",
        "id": 497637051,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738666965
    },
    {
        "content": "<p>I'll try this out sometime later this week, when I'm waiting for concrete categories to compile :)</p>",
        "id": 497637165,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738667005
    },
    {
        "content": "<p>It looks like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Command.MinImports.getAllDependencies#doc\">docs#Mathlib.Command.MinImports.getAllDependencies</a> already tries to figure out the decl name and uses that to inspect the terms (see also  <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Command.MinImports.getVisited#doc\">docs#Mathlib.Command.MinImports.getVisited</a>). So maybe the issue is more that it can't reliably figure out names for declarations?</p>",
        "id": 498112047,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738845772
    },
    {
        "content": "<p>Indeed, it thinks <code>protected theorem le_add_left</code> refers to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=le_add_left#doc\">docs#le_add_left</a> instead of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.le_add_left#doc\">docs#MeasureTheory.Measure.le_add_left</a>.</p>",
        "id": 498113615,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738846292
    },
    {
        "content": "<p>I had to reimplement some of the elaboration logic (since that is interwoven with updating the environment, and would complain that the declaration already exists), but now it seems to work much more reliably to figure out declaration names from a bit of syntax!</p>",
        "id": 498127852,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738850567
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/late.20imports/near/497409285\">said</a>:</p>\n<blockquote>\n<p>and, <span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span>, while we're here, a bug report: <code>set_option linter.upstreamableDecl true</code> flags <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MeasureTheory.Measure.le_add_left#doc\">docs#MeasureTheory.Measure.le_add_left</a> as movable to <code>Mathlib.Algebra.Order.Monoid.Canonical.Defs</code>, but that is clearly impossible as the <em>signature</em> of the theorem mentions <code>MeasurableSpace</code>.</p>\n<p>(Arguably, this theorem shouldn't exist because it is a needless specialization, but nevertheless this linter report is incorrect.)</p>\n</blockquote>\n<p>This now reports:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.MeasureTheory.Measure.NullMeasurable</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Init.Data.List.Nat.Pairwise</span>\n</code></pre></div>\n<p>which seems much more realistic!</p>",
        "id": 498128183,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738850651
    },
    {
        "content": "<p>After a bit more fixing in <code>upstreamableDecl</code>: <a href=\"https://github.com/leanprover-community/mathlib4/pull/21505\">#21505</a></p>",
        "id": 498136924,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1738852893
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span>, I think the lines</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">skipDef</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">getLinterValue</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">upstreamableDecl</span><span class=\"bp\">.</span><span class=\"n\">defs</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">skipPrivate</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">getLinterValue</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">upstreamableDecl</span><span class=\"bp\">.</span><span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>in UpstreamableDecl.lean count as a bug. Using <code>Linter.getLinterValue</code> means that if someone sets <code>set_option linter.all true</code>, then these options will be turned on.</p>",
        "id": 498869271,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739223605
    },
    {
        "content": "<p>Aha! We might not even want the <code>linter.upstreamableDecl</code> itself to be activated on <code>linter.all</code>, since its output is probably not very actionable in general?</p>",
        "id": 498876123,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1739226006
    },
    {
        "content": "<p>Arguably, this isn't a linter, its output is informational</p>",
        "id": 498876302,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1739226078
    }
]