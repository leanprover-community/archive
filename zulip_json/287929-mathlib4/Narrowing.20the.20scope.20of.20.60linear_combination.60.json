[
    {
        "content": "<p>I would like to propose narrowing the scope of <code>linear_combination</code>, and this topic is to allow for discussion.</p>\n<p>As a reminder: When you are faced with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_1</span>\n<span class=\"n\">inst</span><span class=\"bp\">✝</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span>\n<span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span>\n<span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span>\n<span class=\"bp\">⊢</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>and write <code>linear_combination e * h1 + a * h2</code>, the tactic:</p>\n<ol>\n<li>Formally performs the specified operation on the provided hypotheses, i.e. here generates a proof P of the equation </li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"o\">)</span>\n</code></pre></div>\n<ol start=\"2\">\n<li>Forms the expression (goal-LHS - goal-RHS) - (P-LHS - P-RHS) (let's call it E) and applies a lemma which says the goal would follow from showing E is zero</li>\n<li>Runs <code>ring1</code> to prove that E = 0.</li>\n</ol>",
        "id": 462845249,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723836525
    },
    {
        "content": "<p>Originally (<a href=\"https://github.com/leanprover-community/mathlib3/pull/11646\">mathlib3#11646</a>, <a href=\"https://github.com/leanprover-community/mathlib3/pull/14229\">mathlib3#14229</a>) the only operations supported were adding/subtracting/negating hypotheses and multiplication/division of a hypothesis by a constant.  In the port (<a href=\"https://github.com/leanprover-community/mathlib4/pull/605\">#605</a>), <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> added some new operations: adding/subtracting a constant to a hypothesis, multiplying two hypotheses together, and dividing by a hypothesis or inverting a hypothesis.  I propose disabling these new operations.</p>",
        "id": 462845310,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723836550
    },
    {
        "content": "<p>First, let me argue that we don't lose much: as of <a href=\"https://github.com/leanprover-community/mathlib4/pull/2544\">#2544</a> (by <span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>), the <code>congr(...)</code> syntax now permits the user to form <em>arbitrary</em> operations on hypotheses.  So the linear combination in the example above can be written, not <em>too</em> much more inconveniently, as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">eq_of_add</span><span class=\"w\"> </span><span class=\"n\">congr</span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">h2</span><span class=\"o\">)</span>\n<span class=\"n\">ring</span>\n</code></pre></div>\n<p>and this method also works fine if one wants to consider even wild operations like <code>congr(exp $h1 + $h1 * $h2 - 3)</code>.</p>",
        "id": 462845420,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723836601
    },
    {
        "content": "<p>Second, let me argue that we <em>gain</em> something by restricting the scope in this way. One advantage of restricting to genuine linear operations is that it provides implementation robustness.  Currently the algorithm is:</p>\n<blockquote>\n<p>1) form the operation on the hypotheses, 2) move everything in this expression and in the goal from RHS to LHS, and finally 3) compare ring-normalized results.</p>\n</blockquote>\n<p>But there's another conceivable implementation:</p>\n<blockquote>\n<p>1) move everything in hypotheses and goal from RHS to LHS, 2) form the operation on the hypotheses, 3) compare ring-normalized results.</p>\n</blockquote>\n<p>Which operations <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi></mrow><annotation encoding=\"application/x-tex\">f</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span></span> do the same thing for both implementations?  Precisely those for which <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mo stretchy=\"false\">(</mo><msub><mi>a</mi><mn>1</mn></msub><mo>−</mo><msub><mi>b</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>a</mi><mn>2</mn></msub><mo>−</mo><msub><mi>b</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><msub><mi>a</mi><mi>n</mi></msub><mo>−</mo><msub><mi>b</mi><mi>n</mi></msub><mo stretchy=\"false\">)</mo><mo>=</mo><mi>f</mi><mo stretchy=\"false\">(</mo><msub><mi>a</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>a</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><msub><mi>a</mi><mi>n</mi></msub><mo stretchy=\"false\">)</mo><mo>−</mo><mi>f</mi><mo stretchy=\"false\">(</mo><msub><mi>b</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>b</mi><mn>2</mn></msub><mo separator=\"true\">,</mo><mo>…</mo><msub><mi>b</mi><mi>n</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">f(a_1- b_1, a_2 - b_2, \\ldots a_n - b_n)=f(a_1, a_2, \\ldots a_n)-f(b_1, b_2, \\ldots b_n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\">…</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">b</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span>, i.e. <code>ℤ</code>-linear operations.</p>",
        "id": 462845544,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723836636
    },
    {
        "content": "<p>This implementation robustness is useful in its own right (for example, <code>linarith</code> uses the second implementation I described, and I have some ambitions to unify <code>linear_combination</code> more closely with <code>linarith</code>, so it would be convenient to keep open the possibility of switching).</p>\n<p>Just as importantly, I believe this implementation robustness is psychologically useful for users. Both are plausible ways to think about this kind of task, and the tactic is made more canonical/predictable/user-friendly by disabling the operations on which they behave differently.  Conversely, providing the nonlinear syntax is bad, because there are several plausible guesses for its meaning (does <code>linear_combination h ^ 2</code> for <code>h : x = y</code> produce a proof of <code>x ^ 2 - y ^ 2 = 0</code> or <code>(x - y) ^ 2 = 0</code>?).</p>",
        "id": 462845783,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723836732
    },
    {
        "content": "<p>A PR is at <a href=\"https://github.com/leanprover-community/mathlib4/pull/15899\">#15899</a>.  The nonlinear syntax is currently used only twice in the libary.</p>",
        "id": 462845912,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723836807
    },
    {
        "content": "<p>To what extent could we drop <code>linear_combination</code> entirely in favor of something like <code>exact mod_ring congr(2*$h1 + $h2)</code>?</p>",
        "id": 462846528,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723837124
    },
    {
        "content": "<p>Is your <code>mod_ring</code> a term elaborator which moves everything to the LHS and then applies <code>ring</code>?  And has an optional normalization argument (like <code>linear_combination</code> does) to allow for different normalization tactics?</p>\n<p>That term elaborator sounds like it would have the same predictability/user-friendliness issues that I was objecting to in the current <code>linear_combination</code>.</p>",
        "id": 462847049,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723837388
    },
    {
        "content": "<p>I think the predictability issue goes away if you take only a single fully-formed expression?</p>",
        "id": 462847212,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723837466
    },
    {
        "content": "<p>Why?</p>",
        "id": 462847253,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723837490
    },
    {
        "content": "<p>Because the syntax enforces that the order is \"first build the expression, then move everything to the LHS\"</p>",
        "id": 462847398,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723837563
    },
    {
        "content": "<p>I think that addresses literal predictability, but not the point I was trying to make about \"psychological\" predictability.</p>",
        "id": 462847567,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723837666
    },
    {
        "content": "<p>But another obstacle to the <code>exact mod_ring congr(2*$h1 + $h2)</code> idea is that I will shortly be PR-ing <code>linear_combination</code>-for-inequalities, which doesn't allow for a <code>congr(...)</code> implementation.</p>",
        "id": 462847645,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723837701
    },
    {
        "content": "<p>IIRC when we talked about this in Bonn I made the same suggestion as Eric, just move the current <code>linear_combination</code> to something built on top of the <code>congr()</code> term elaborator</p>",
        "id": 462851626,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723839829
    },
    {
        "content": "<p>it would be nice if congr got support for <code>&lt;- h</code> hypotheses though</p>",
        "id": 462851800,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723839915
    },
    {
        "content": "<p>Could there be a <code>gcongr()</code> elaborator for the inequality case?</p>",
        "id": 462852319,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723840203
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/462851800\">said</a>:</p>\n<blockquote>\n<p>it would be nice if congr got support for <code>&lt;- h</code> hypotheses though</p>\n</blockquote>\n<p>What would be the syntax for this exactly? I feel like anywhere I put a <code>←</code> makes the expression hard to parse. I guess maybe <code>congr($(h₁) + ←$(h₂))</code>?</p>",
        "id": 462855567,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723841850
    },
    {
        "content": "<p>You're always free to write <code>congr($h₁ + $h₂.symm)</code></p>",
        "id": 462855689,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723841908
    },
    {
        "content": "<p>I suppose there could be a special case for <code>congr($h₁ + $(← h₂))</code></p>",
        "id": 462855735,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1723841939
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/462855735\">said</a>:</p>\n<blockquote>\n<p>I suppose there could be a special case for <code>congr($h₁ + $(← h₂))</code></p>\n</blockquote>\n<p>that's basically what linear combination is doing</p>",
        "id": 462857040,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1723842702
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/462852319\">said</a>:</p>\n<blockquote>\n<p>Could there be a <code>gcongr()</code> elaborator for the inequality case?</p>\n</blockquote>\n<p>This would be a huge project, and I don't want to delay <code>linear_combination</code>-for-inequalities for it.  (I'm sure you can imagine that it's much easier to support four hard-coded operations than to support arbitrary operations.)</p>",
        "id": 462857950,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723843247
    },
    {
        "content": "<p>But also, I believe it requires a rather subtle adjustment of the <code>gcongr</code> tagging system: since it would reason forward rather than backwards, you'd want to parse and key <code>@[gcongr]</code> lemmas according to what they did to hypotheses, not according to what they did to the goal.  It might not even end up being the same class of lemmas.</p>",
        "id": 462858175,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1723843386
    },
    {
        "content": "<p>My question was more \"is this a good longer-term goal?\", not \"should we build this instead\"</p>",
        "id": 462872240,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723853085
    },
    {
        "content": "<p>But also, we could reserve the notation <code>gcongr(...)</code> now, but have it only implement those four hard-coded operations to start with!</p>",
        "id": 462872498,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723853351
    },
    {
        "content": "<blockquote>\n<p>It might not even end up being the same class of lemmas.</p>\n</blockquote>\n<p>I guess this is a good argument for not jumping on the name <code>gcongr(</code> though</p>",
        "id": 462872522,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723853387
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> I like your narrowing-scope proposal. Will that also make it easier for <code>linear_combination</code> to start working in modules, instead of just rings? You mention <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Z</mi></mrow><annotation encoding=\"application/x-tex\">\\Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">Z</span></span></span></span>-linear combinations, but I guess <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>R</mi></mrow><annotation encoding=\"application/x-tex\">R</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span></span></span></span>-linear ones could also be in scope right?</p>\n<ul>\n<li>It would need a bit of support for SMul</li>\n<li>You can no longer use <code>ring</code> to cancel all the terms, but hopeful a combination of <code>abel</code> and <code>ring_nf</code> + a bit of extra juice can still work.</li>\n</ul>",
        "id": 462931230,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1723868639
    },
    {
        "content": "<p>Can I renew the discussion on this proposal to narrow the scope of <code>linear_combination</code>?  As a reminder, the draft PR is <a href=\"https://github.com/leanprover-community/mathlib4/pull/15899\">#15899</a>, and I have some extensions to <code>linear_combination</code> which I would like to PR once this proposal is settled:</p>\n<ul>\n<li>supporting inequalities</li>\n<li>supporting a self-replacing <code>linarith?</code>-to<code>linear_combination</code></li>\n<li>supporting modules (as mentioned by <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> -- although to be really useful this also requires a module-normalization tactic, which I will start a separated discussion for [EDIT: <a href=\"#narrow/stream/287929-mathlib4/topic/Feature.20request.3A.20.22module_nf.22/near/464775865\">here</a>]).</li>\n</ul>\n<p><a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/462845544\">Here</a> is my main argument for narrowing the scope.</p>\n<p>The main discussion above so far (from <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> and <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>) was about whether <code>linear_combination</code> should be rewritten entirely as a lightweight wrapper for the <code>congr(...)</code> term elaborator -- but as discussed above, this is not compatible with my proposed extension to support inequalities.</p>",
        "id": 464458953,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724353204
    },
    {
        "content": "<p>I think it makes sense having more restrictive congruence-like tactics. You're able to do things like propagate types (and improve performance in that way we discovered recently, by elaborating leaf terms) that <code>congr(...)</code> is not suited for. Plus, <code>congr(...)</code> is <em>very</em> general and has no domain-specific knowledge of any kind, and isn't particularly efficient in the way it generates proofs. Users might also write weird non-linear things and not realize it.</p>\n<p>If someone wants the power of <code>congr(...)</code>, I would suggest making a separate tactic. Perhaps <code>ring_convert h</code> could handle taking an equality <code>h</code>, bring everything to one side, do <code>convert</code>, and try to solve the goal with <code>ring</code>? Then, paired with <code>congr(...)</code>, you could write <code>ring_convert congr(2 * $h1 + 3 * $h2)</code> for instance.</p>",
        "id": 464462906,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724354360
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> I think I agree with everything you wrote, but just checking, is this intended as an argument for <a href=\"https://github.com/leanprover-community/mathlib4/pull/15899\">#15899</a>, or against it, or just as a remark?</p>",
        "id": 464464378,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724354782
    },
    {
        "content": "<p>It's meant to be a vote in favor :-)</p>",
        "id": 464466165,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724355351
    },
    {
        "content": "<p>I don’t have any technical opinion about this. I only want to express my enthusiastic support for any initiative towards having <code>linear_combination</code> for inequalities and a <code>module</code> tactic.</p>",
        "id": 464467763,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724355950
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> You can try out <code>linear_combination</code>-for-inequalities and <code>linarith?</code> at <a href=\"https://github.com/leanprover-community/mathlib4/tree/HM-linear-combination\">branch#HM-linear-combination</a> !</p>",
        "id": 464468062,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724356054
    },
    {
        "content": "<p>We really need a cheerleader emoji.</p>",
        "id": 464468168,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724356085
    },
    {
        "content": "<p>How can I test? Can I simply use the <code>linear_combination</code> syntax?</p>",
        "id": 464468298,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724356146
    },
    {
        "content": "<p>Yes, you can look at the test file to get started:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/blob/19903e8d9be678a21ec437004fe23e48ff1fcbcf/test/linear_combination.lean#L230-L285\">https://github.com/leanprover-community/mathlib4/blob/19903e8d9be678a21ec437004fe23e48ff1fcbcf/test/linear_combination.lean#L230-L285</a></p>",
        "id": 464468576,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724356256
    },
    {
        "content": "<p>Re-raising a point from the PR to avoid discussion fragmenting; <a href=\"https://github.com/leanprover-community/mathlib4/pull/15899\">#15899</a> also drops support for semirings from <code>linear_combination</code> (and presumably the module version being discussed above doesn't work on semimodules), which I'd argue isn't beneficial.</p>\n<p>I think restricting to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">N</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{N}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">N</span></span></span></span>-linear operation has the same semantic effect as reducing to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Z</mi></mrow><annotation encoding=\"application/x-tex\">\\mathbb{Z}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6889em;\"></span><span class=\"mord mathbb\">Z</span></span></span></span> linear. Once we restrict things to be linear (which I agree is good), it becomes irrelevant whether everything gets moved to a single subtraction on the LHS or the two sides are handled separately - and so this can now be an implementation detail, preferring the implementation that works most generally.</p>",
        "id": 464493690,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724366783
    },
    {
        "content": "<p>I agree that this would be nice to have.</p>",
        "id": 464526270,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724382453
    },
    {
        "content": "<p>I would argue that the current quick'n'dirty mechanism for supporting semirings is not even the best quick'n'dirty mechanism.  For example, here are two problems being solved using <code>linear_combination2</code> (the semiring version) on current Mathlib:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_right_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination2</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_right_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination2</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"n\">h2</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 464696310,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724432629
    },
    {
        "content": "<p>A different semiring mechanism (which <a href=\"https://github.com/leanprover-community/mathlib4/commit/df19f9a4c16562ca7ed4e13718c7077168ee09ac\">I just wrote up</a>) would be to treat \"formal subtraction\" as addition on the other side of the equation.  This is much more user-friendly!</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n</code></pre></div>",
        "id": 464696571,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724432700
    },
    {
        "content": "<p>There are also other possible implementations, for example:</p>\n<ul>\n<li>what is done in <code>linarith</code>: don't handle general semirings, but handle <code>ℕ</code> by <code>zify</code>-ing any <code>ℕ</code> equation encountered</li>\n<li>store all coefficients with a boolean flag indicating whether they are \"formally positive\" or \"formally negative\"</li>\n<li>if initially working over a cancel-semiring <code>R</code>, search for a ring <code>S</code> which is the \"negation closure\" of <code>S</code> (basically \"additive localization\", though I don't know if we have this algebraic theory developed), and transfer all equations from <code>R</code> to <code>S</code>; arrange things so that if <code>R</code> is a true ring then the <code>S</code> produced is just <code>R</code></li>\n</ul>",
        "id": 464699666,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724433589
    },
    {
        "content": "<p>I would also like to get this* working eventually (since it will be needed to have a full self-replacing <code>linarith?</code>):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>\n<p>This is an analogous issue, just with division rather than subtraction: one wants a \"formal\" syntax for the operation even when it is not literally available in the semiring considered.</p>\n<p>*Currently you have to write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">mul_right_cancel₀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">norm_num1</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n</code></pre></div>",
        "id": 464701287,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724433957
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/464696571\">said</a>:</p>\n<blockquote>\n<p>A different semiring mechanism (which <a href=\"https://github.com/leanprover-community/mathlib4/commit/df19f9a4c16562ca7ed4e13718c7077168ee09ac\">I just wrote up</a>) would be to treat \"formal subtraction\" as addition on the other side of the equation.  This is much more user-friendly!</p>\n</blockquote>\n<p>I opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a> for this.  <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span> is this acceptable to you?</p>\n<p>This change makes the tactic more powerful over semirings.  It also eliminates the need to support a special syntax for them (which should make it easier to proceed with the other planned refactors).</p>",
        "id": 464743438,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724446425
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> Thanks! I like that quite a lot. But I suppose it only works in semirings in which the addition is cancellative? Because those will inject into their \"ring closure\" (aka additive localization, yadda yadda).</p>",
        "id": 464797324,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1724480415
    },
    {
        "content": "<p>That's true.  But <code>linear_combination(2)</code> is currently not even used in Mathlib on Nat or NNReal, let alone on a non-cancellative semiring ...</p>",
        "id": 464797467,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724480527
    },
    {
        "content": "<p>I forgot to report that I tried on <a href=\"https://github.com/leanprover-community/mathlib4/tree/HM-linear-combination\">branch#HM-linear-combination</a> </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">hy</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"bp\">/</span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"bp\">/</span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">*</span><span class=\"n\">hy</span>\n</code></pre></div>\n<p>and it makes me very happy. This makes me confident that the current state of this branch is enough for my teaching.</p>",
        "id": 464812821,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1724490328
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/464696571\">said</a>:</p>\n<blockquote>\n<p>A different semiring mechanism (which <a href=\"https://github.com/leanprover-community/mathlib4/commit/df19f9a4c16562ca7ed4e13718c7077168ee09ac\">I just wrote up</a>) would be to treat \"formal subtraction\" as addition on the other side of the equation.  This is much more user-friendly!</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This is cool, but strikes me as perhaps a little too magic: after new users have tripped over <code>-</code> on Nat everywhere, I think it makes things confusing to then say \"oh, except in linear_combination where it actually does mean what you meant\"</p>",
        "id": 464814068,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724490999
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Since the existing version (which requires writing</p>\n<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/464696310\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_right_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination2</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">h2</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_right_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination2</span><span class=\"w\"> </span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"n\">h2</span><span class=\"o\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>) has literally never been used in Mathlib, it seems worthwhile to me to change to a syntax which is a bit more \"magic\" ... and a bit less work for the user.</p>",
        "id": 464863729,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724513754
    },
    {
        "content": "<p>By the way, the change also allows <code>polyrith</code> to work on <code>ℕ</code>!  Previously, it would fail on the above problems, or on something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">polyrith</span>\n</code></pre></div>\n<p>with the error message</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>polyrith found the following certificate, but it failed to close the goal:\ne * h1 - 1 * a * h2\n</code></pre></div>\n<p>With the change, <code>polyrith</code> solves them without comment.</p>",
        "id": 464864159,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724513864
    },
    {
        "content": "<p>Thinking ahead, can I ask if you also have qualms about this syntax?<br>\n<span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/464701287\">said</a>:</p>\n<blockquote>\n<p>I would also like to get this* working eventually (since it will be needed to have a full self-replacing <code>linarith?</code>):</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linear_combination</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">h2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>This was what I had planned to have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">linarith?</span>\n</code></pre></div>\n<p>self-replace to.</p>",
        "id": 464864736,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724514114
    },
    {
        "content": "<p>This one is arguably not problematic, as even integer division would have the right meaning</p>",
        "id": 464866324,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724515077
    },
    {
        "content": "<p>So I guess actually <code>linear_combination h1 - h2</code> is not problematic either, and it would be only <code>-(h2 - h1)</code> that I would (rather weakly) object to (both because the subtraction \"should\" truncate, and negation doesn't exist on naturals).</p>",
        "id": 464866414,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724515152
    },
    {
        "content": "<p>Maybe a weak argument here is that <code>linear_combination</code> is for <em>linear</em> combinations, and truncating subtraction and negation are non-linear.</p>",
        "id": 464869682,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724516544
    },
    {
        "content": "<p>Yes, an alternative would be to require the <code>linear_combination2 h1 + (←h2)</code> spelling (edit: or <code>h1 + (h2.symm)</code>?) but teach linear_combination to do cancellation</p>",
        "id": 464869807,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724516597
    },
    {
        "content": "<p>That really seems like a loss to me.  We then have to support a separate syntax through several refactors, teach users about this syntax, and teach <code>polyrith</code> and <code>linarith?</code> about this syntax.</p>",
        "id": 464869966,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724516664
    },
    {
        "content": "<p>The documentation could say that <code>linear_combination</code> operates as-if the expression is \"ring-ified\" (i.e., embedded in the enveloping ring)</p>",
        "id": 464870024,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724516700
    },
    {
        "content": "<p>Then there's definitely no harm in pretending that <code>-</code> is fine for Nat</p>",
        "id": 464870052,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724516716
    },
    {
        "content": "<p>In the generalization where <code>linear_combination</code> works for modules, it would be nice to be able to hover over the <code>-</code>s in the tactic and see which ring / module they belong to</p>",
        "id": 464870105,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724516738
    },
    {
        "content": "<p>I would argue that <code>(←h2)</code> has the advantage of consistency with the treatment of Nat elsewhere in mathlib, but <code>-h2</code> has the advantage of internal consistency for the tactic itself.</p>",
        "id": 464870133,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724516751
    },
    {
        "content": "<p>(Just to clarify my comment three comments up about nonlinearity, I meant it in support of using <code>-</code> here.)</p>",
        "id": 464870268,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724516799
    },
    {
        "content": "<p>Sorry for the tangent, but does <code>linear_combination</code> support using something like <code>h1.trans h2</code> as one of the hypotheses?</p>",
        "id": 464870386,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724516858
    },
    {
        "content": "<p>Yes.</p>",
        "id": 464870408,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724516869
    },
    {
        "content": "<p>So the <code>symm</code> version at least comes for free, even if the <code>←</code> one doesn't?</p>",
        "id": 464870504,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724516900
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Can you expand a bit on this comment?  Are you proposing that we allow <code>linear_combination h1 - h2</code> over Nat, but support neither <code>linear_combination -h</code> nor <code>linear_combination (←h)</code>, and instead have the user write <code>linear_combination h.symm</code>?</p>",
        "id": 464879315,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724521427
    },
    {
        "content": "<p>(If so, I could live with this, but as I mentioned above, it seems like a shame to lose the \"free\" polyrith support for Nat. And it seems like it still wouldn't eliminate potential user confusion: here the tricky point would be explaining that <code>linear_combination</code> supports subtraction but not negation.)</p>",
        "id": 464879411,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724521489
    },
    {
        "content": "<p>I am somewhat with Heather here. The <code>-</code> is cute enough that I am happy for it not to exactly correspond to the operation of the base (semi)ring</p>",
        "id": 464879866,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1724521811
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/464879315\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> Can you expand a bit on this comment?  Are you proposing that we allow <code>linear_combination h1 - h2</code> over Nat, but support neither <code>linear_combination -h</code> nor <code>linear_combination (←h)</code>, and instead have the user write <code>linear_combination h.symm</code>?</p>\n</blockquote>\n<p>Yes, but if this is an unpopular opinion I'm not going to push hard for it. I don't really care about &lt;-, but removing it reduces the amount of syntax to document.</p>",
        "id": 464898362,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724531364
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/464870133\">said</a>:</p>\n<blockquote>\n<p>I would argue that <code>(←h2)</code> has the advantage of consistency with the treatment of Nat elsewhere in mathlib, but <code>-h2</code> has the advantage of internal consistency for the tactic itself.</p>\n</blockquote>\n<p>I think internal consistency for the tactic itself, and simplicity of input notation, are the most important things here!</p>",
        "id": 464902115,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1724533459
    },
    {
        "content": "<p>(Also very excited to see <code>linarith?</code> coming <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span>)</p>",
        "id": 464902129,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1724533480
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/464870024\">said</a>:</p>\n<blockquote>\n<p>The documentation could say that <code>linear_combination</code> operates as-if the expression is \"ring-ified\" (i.e., embedded in the enveloping ring)</p>\n</blockquote>\n<p>I rewrote the documentation as Kyle suggested -- <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> hopefully this partially mitigates your concern:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/pull/16103/commits/d3b48e03c894e4216d05a682a8cc7d5ec6788168\">https://github.com/leanprover-community/mathlib4/pull/16103/commits/d3b48e03c894e4216d05a682a8cc7d5ec6788168</a></p>",
        "id": 464903966,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724535326
    },
    {
        "content": "<p>Can we pick up the <code>linear_combination</code> discussion again?  <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> can you live with the streamlined syntax proposed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a> (for which I count weak support from Johan, Kyle, Yaël and Rob)?</p>\n<p>If we can go ahead with <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a>, that will unblock <a href=\"https://github.com/leanprover-community/mathlib4/pull/15899\">#15899</a>, which will unblock the new features!</p>",
        "id": 465255524,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724699044
    },
    {
        "content": "<p>I think it would be easiest if you just moved the old linear_combination out of the way instead of proposing to remove it</p>",
        "id": 465255612,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724699096
    },
    {
        "content": "<p>it makes things awkward when people have to decide between getting a shiny new tactic and removing a potentially useful different tactic</p>",
        "id": 465255668,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724699132
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> Just checking, is this for <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a> or <a href=\"https://github.com/leanprover-community/mathlib4/pull/15899\">#15899</a>?  I believe <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a> is a strict increase in scope (well, except for non-cancellative semirings ...)</p>",
        "id": 465255922,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724699249
    },
    {
        "content": "<p>I'll take another look when I'm back from vacation, if someone else doesn't beat me to it</p>",
        "id": 465256050,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724699304
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> both AFAICT</p>",
        "id": 465256107,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724699333
    },
    {
        "content": "<p>my proposal is to do both changes to the original <code>linear_combination</code>, but copy paste the old file and rename the old <code>linear_combination</code> to <code>linear_combination'</code> (and see whether all existing uses can just use the new <code>linear_combination</code> without modification). We can revisit this once people have experienced the various tactics in practice</p>",
        "id": 465256437,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724699470
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/465256437\">said</a>:</p>\n<blockquote>\n<p>(and see whether all existing uses can just use the new <code>linear_combination</code> without modification)</p>\n</blockquote>\n<p>Regarding this: for <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a> yes, for <a href=\"https://github.com/leanprover-community/mathlib4/pull/15899\">#15899</a> yes except for two uses.</p>",
        "id": 465256584,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724699526
    },
    {
        "content": "<p>and use <code>linear_combination'</code> for those two uses</p>",
        "id": 465256620,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724699546
    },
    {
        "content": "<p>OK, that seems fine to me.  Would you be willing to merge a PR which does that?</p>",
        "id": 465256723,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724699607
    },
    {
        "content": "<p>Also: given that <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a> does not require any changes to mathlib, how do you feel about merging it <em>before</em> the copy-paste operation?</p>",
        "id": 465256902,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724699695
    },
    {
        "content": "<p>I think that would not be a good idea, it's not backward compatible</p>",
        "id": 465257127,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724699807
    },
    {
        "content": "<p>OK, and one more question: how do you feel about doing this</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/462851626\">said</a>:</p>\n<blockquote>\n<p>IIRC when we talked about this in Bonn I made the same suggestion as Eric, just move the current <code>linear_combination</code> to something built on top of the <code>congr()</code> term elaborator</p>\n</blockquote>\n<p>to shorten <code>linear_combination'</code> after we duplicate?</p>",
        "id": 465257284,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724699886
    },
    {
        "content": "<p>And one more one more question: we could name it <code>compare_mod_ring</code> rather than <code>linear_combination'</code>, since it's not <em>linear</em>?</p>",
        "id": 465257433,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724699965
    },
    {
        "content": "<p>The main reason for keeping it with the original name (more or less) is to assist with people upgrading mathlib and debugging a random error in <code>linear_combination</code>  they didn't ask for</p>",
        "id": 465258459,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724700475
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/16166\">#16166</a> is the bifurcation PR.</p>",
        "id": 465268298,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724704907
    },
    {
        "content": "<p>10 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/Special-casing.20the.20unusedTactic.20linter\">#mathlib4 &gt; Special-casing the unusedTactic linter</a> by <span class=\"user-mention silent\" data-user-id=\"260507\">Heather Macbeth</span>.</p>",
        "id": 465271999,
        "sender_full_name": "Notification Bot",
        "timestamp": 1724706609
    },
    {
        "content": "<p>Now that the bifurcation is merged, hopefully <a href=\"https://github.com/leanprover-community/mathlib4/pull/16103\">#16103</a> is uncontroversial (at least in its general idea -- it still needs a review).  I have merged master on it.</p>",
        "id": 465306057,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1724725198
    },
    {
        "content": "<p>I just discovered this topic from the elliptic curves files --- should I replace the existing legacy <code>linear_combination'</code> with the suggested <em>linear</em> output from <code>polyrith</code> that <span class=\"user-mention\" data-user-id=\"260507\">@Heather Macbeth</span> added in the PR comments?</p>",
        "id": 470236185,
        "sender_full_name": "David Ang",
        "timestamp": 1726353384
    },
    {
        "content": "<p>I believe <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span>'s <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/465256620\">opinion</a> is that we should leave those two uses on the legacy <code>linear_combination'</code> tactic for now ... then at some later point</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Narrowing.20the.20scope.20of.20.60linear_combination.60/near/465256437\">said</a>:</p>\n<blockquote>\n<p>revisit this once people have experienced the various tactics in practice</p>\n</blockquote>",
        "id": 470237816,
        "sender_full_name": "Heather Macbeth",
        "timestamp": 1726354846
    }
]