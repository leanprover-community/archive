[
    {
        "content": "<p>I just did a little experiment introducing a TC loop:</p>\n<blockquote>\n<p>chore(Algebra/Group/Action/Defs): make SMulCommClass.symm an instance <a href=\"https://github.com/leanprover-community/mathlib4/pull/23941\">#23941</a></p>\n</blockquote>\n<p>This introduces an instance <code>SMulCommClass A B C -&gt; SMulCommClass B A C</code>.<br>\nOn <code>master</code>, that is a lemma.</p>\n<p>The results by bench do not look good. Whereas I would have hoped that this is the sort of loop that is detected almost instantaneously...</p>",
        "id": 511631807,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744372469
    },
    {
        "content": "<p>Here's an explanation of why this is expensive:</p>\n<ul>\n<li>We have a graph of instance that derive <code>SMulCommClass A B (F C)</code> from <code>SMulCommClass A B C</code></li>\n<li>Your new instance effectively creates a copy of this graph with A and B swapped, and adds bidirectional crosslinks between the two graphs</li>\n<li>While the search isn't following loops, the number of non-looping paths has still increased by O(2^graph_depth)</li>\n</ul>",
        "id": 511632485,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744372683
    },
    {
        "content": "<p>Ah, thanks!</p>",
        "id": 511632717,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744372753
    },
    {
        "content": "<p>I must say that it is quite inconvenient that we can't have this instance <span aria-label=\"cry\" class=\"emoji emoji-1f622\" role=\"img\" title=\"cry\">:cry:</span></p>",
        "id": 511632826,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744372789
    },
    {
        "content": "<p>Eg, if I want to synthesize <code>SMulCommClass A B (ULift (ULIft X))</code>, previously the path was uniquely:</p>\n<ul>\n<li><code>SMulCommClass A B C</code><br>\n<code>SMulCommClass A B (ULift X)</code><br>\n<code>SMulCommClass A B (ULift (ULift X))</code></li>\n</ul>\n<p>but now there are lots of paths</p>\n<ul>\n<li>\n<p><code>SMulCommClass A B C</code><br>\n<code>SMulCommClass A B (ULift X)</code><br>\n<code>SMulCommClass A B (ULift (ULift X))</code></p>\n</li>\n<li>\n<p><code>SMulCommClass A B C</code><br>\n<code>SMulCommClass B A C</code><br>\n<code>SMulCommClass B A (ULift X)</code><br>\n<code>SMulCommClass A B (ULift X)</code><br>\n<code>SMulCommClass A B (ULift (ULift X))</code></p>\n</li>\n<li>\n<p><code>SMulCommClass A B C</code><br>\n<code>SMulCommClass B A C</code><br>\n<code>SMulCommClass B A (ULift X)</code><br>\n<code>SMulCommClass B A (ULift (ULift X))</code><br>\n<code>SMulCommClass A B (ULift (ULift X))</code></p>\n</li>\n</ul>",
        "id": 511633033,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744372834
    },
    {
        "content": "<p>This probably gets even worse because <code>SMulCommClass</code> is a dependent typeclass, and the instances it is passed are themselves likely to depend on `SMulCommClass.</p>",
        "id": 511633668,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744372995
    },
    {
        "content": "<p>Example of why this is inconvenient: If we want to do representation theory purely by typeclasses then this means that we need to choose, and to stick to, either <code>[SMulCommClass k G V]</code> or <code>[SMulCommClass G k V]</code>.</p>",
        "id": 511634108,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744373133
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/TC.20loops/near/511632826\">said</a>:</p>\n<blockquote>\n<p>I must say that it is quite inconvenient that we can't have this instance <span aria-label=\"cry\" class=\"emoji emoji-1f622\" role=\"img\" title=\"cry\">:cry:</span></p>\n</blockquote>\n<p>Maybe the answer is to consume <code>[SMulCommClass A B C]</code> but declare <code>instance : SymmSMulCommClass A B C</code>, where the latter implies the former in both directions</p>",
        "id": 511634130,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744373141
    },
    {
        "content": "<p>This doesn't help with choosing variables though in Kevin's situation</p>",
        "id": 511634279,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744373173
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/TC.20loops/near/511632826\">said</a>:</p>\n<blockquote>\n<p>I must say that it is quite inconvenient that we can't have this instance <span aria-label=\"cry\" class=\"emoji emoji-1f622\" role=\"img\" title=\"cry\">:cry:</span></p>\n</blockquote>\n<p>I think TC search needs native support for \"this class is symmetric, so force an arbitrary order on its parameters\"</p>",
        "id": 511634369,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744373198
    },
    {
        "content": "<p>Or framed another way, <code>SMulCommClass.symm</code> is an \"<code>instance_proc</code>\" which only fires if <code>B_expr.lt A_expr</code></p>",
        "id": 511634473,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744373228
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/TC.20loops/near/511634108\">said</a>:</p>\n<blockquote>\n<p>Example of why this is inconvenient: If we want to do representation theory purely by typeclasses then this means that we need to choose, and to stick to, either <code>[SMulCommClass k G V]</code> or <code>[SMulCommClass G k V]</code>.</p>\n</blockquote>\n<p>That's exactly the source of my experiment. But (my new design plan for) <code>[Representation k G V]</code> can have instances to both. So the issue isn't very pressing for me right now.</p>",
        "id": 511634619,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744373271
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Representation#doc\">docs#Representation</a></p>",
        "id": 511634778,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744373304
    },
    {
        "content": "<p>See <a class=\"message-link\" href=\"/#narrow/channel/116395-maths/topic/Representation.20Theory/near/511633929\">#maths &gt; Representation Theory @ ðŸ’¬</a></p>",
        "id": 511634915,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744373347
    },
    {
        "content": "<p>(comment moved to that thread)</p>",
        "id": 511635067,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744373388
    },
    {
        "content": "<p>I've added some TC loops for topological space properties a while ago (e.g., <code>T0Space X -&gt; RegularSpace X -&gt; T3Space X</code>). Should I try to remove them, fix compile, and <code>!bench</code> to see how much do they hurt performance?</p>",
        "id": 511729527,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1744403701
    },
    {
        "content": "<p>It would be interesting to see!</p>",
        "id": 511785898,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744442151
    }
]