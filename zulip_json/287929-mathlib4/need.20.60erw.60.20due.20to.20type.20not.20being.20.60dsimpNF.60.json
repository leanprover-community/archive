[
    {
        "content": "<p>I have noticed cases of needing <code>erw</code> because <code>(d)simp</code> has simplified the type of some expression (but not visibly the expression itself).</p>\n<p>Basically, if my lemma is called <code>lemma</code>, then the following workaround avoids <code>erw [lemma]</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kn\">lemma</span>\n<span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">this</span>\n<span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">this</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Have people thought how to get around this?</p>\n<p>My first guess would just be to manually specify the type in the lemma statement so that it has <code>dsimpNF</code>, but I am not sure how to do this. This is from <a href=\"https://github.com/leanprover-community/mathlib4/pull/18197\">#18197</a>, where <code>extendScalarsComp_hom_app_one_tmul</code> causes the need for many <code>erw</code>s (which would be nice to avoid). The type of the LHS is: <code>((extendScalars f₁₂ ⋙ extendScalars f₂₃).obj M)</code>, which is not in <code>dsimpNF</code>, and is what is causing the issues with <code>erw</code>. However I can't seem to manually specify the type by restating the lemma as:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">extendScalarsComp_hom_app_one_tmul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ModuleCat</span><span class=\"w\"> </span><span class=\"n\">R₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"o\">((</span><span class=\"n\">extendScalarsComp</span><span class=\"w\"> </span><span class=\"n\">f₁₂</span><span class=\"w\"> </span><span class=\"n\">f₂₃</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">hom</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R₃</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊗ₜ</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">extendScalars</span><span class=\"w\"> </span><span class=\"n\">f₂₃</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">extendScalars</span><span class=\"w\"> </span><span class=\"n\">f₁₂</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">obj</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R₃</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊗ₜ</span><span class=\"o\">[</span><span class=\"n\">R₂</span><span class=\"o\">,</span><span class=\"n\">f₂₃</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">⊗ₜ</span><span class=\"o\">[</span><span class=\"n\">R₁</span><span class=\"o\">,</span><span class=\"n\">f₁₂</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n</code></pre></div>\n<p>In the first line of the proof, hovering over the LHS still gives the type <code>((extendScalars f₁₂ ⋙ extendScalars f₂₃).obj M)</code>.</p>\n<p>I also feel that some automation should be able to get around this, and potentially save a lot of <code>erw</code>s in the future (i.e. by automatically putting the type of the lemma in <code>dsimpNF</code>).</p>",
        "id": 479428571,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1730191837
    },
    {
        "content": "<p>Yes, a cast like that doesn't actually change the type in any way, it just checks that the types agree.</p>",
        "id": 479443063,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730196701
    },
    {
        "content": "<p>I think a <code>dsimp%</code> elaborator is needed here, perhaps?</p>",
        "id": 479443084,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730196712
    },
    {
        "content": "<p>(relatedly, we might consider replacing <code>by simpa using h</code> with an elaborator <code>simp% h</code>??)</p>",
        "id": 479443228,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730196753
    },
    {
        "content": "<p>Another thread that might be relevant: <a href=\"#narrow/channel/287929-mathlib4/topic/Fixing.20the.20.60erw.60.20hell.20around.20concrete.20categories\">https://leanprover.zulipchat.com/#narrow/channel/287929-mathlib4/topic/Fixing.20the.20.60erw.60.20hell.20around.20concrete.20categories</a></p>",
        "id": 479444001,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1730197057
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/need.20.60erw.60.20due.20to.20type.20not.20being.20.60dsimpNF.60/near/479443084\">said</a>:</p>\n<blockquote>\n<p>I think a <code>dsimp%</code> elaborator is needed here, perhaps?</p>\n</blockquote>\n<p>Yes, this would be a good idea!</p>",
        "id": 479461775,
        "sender_full_name": "Calle Sönne",
        "timestamp": 1730203132
    }
]