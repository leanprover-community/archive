[
    {
        "content": "<p>Dear category theorists of Mathlib,</p>\n<p>With <a href=\"https://github.com/leanprover-community/mathlib4/pull/30797\">#30797</a> merged it is now possible to use <code>Category* C</code> when declaring category instances. The following</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>should behave essentially equivalently to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>I encourage anyone declaring universe polymorphic category instances to use it in new developments. We may eventually refactor existing code to use <code>Category*</code> thereby removing various <code>universe</code> parameter declarations, but this is low priority at the moment.</p>",
        "id": 561309004,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1764639723
    },
    {
        "content": "<p>Why is the syntax not the more expectable (and probably more generalisable) <code>Category.{*}</code>?</p>",
        "id": 561323548,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764650314
    },
    {
        "content": "<p>The difference is that <code>Category*</code> does some fancy universe reordering, putting the <code>v</code> from <code>Category* C</code> in front of the  <code>u</code> from <code>C : Type*</code>.</p>",
        "id": 561323680,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764650410
    },
    {
        "content": "<p>Why couldn't the hypothetical <code>Category.{*} C</code> notation do exactly that too? From the signature of <code>C</code>, it even has access to the fact that the <code>*</code> should be a universe level defined before the <code>u</code> in <code>C : Type u</code>.</p>",
        "id": 561323962,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764650618
    },
    {
        "content": "<p>My understanding of <code>Category.{*}</code> is that it will introduce a new universe parameter for the <code>*</code> in the same way as <code>Type*</code>, and hence these will appear in the order in which the <code>*</code>s are elaborated.</p>",
        "id": 561324264,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1764650845
    },
    {
        "content": "<p>If we had a generic <code>*</code> then I presume that would mean that <code>Category.{*}</code> should elaborate as well, and in this case the universe <code>*</code> comes at the end.</p>",
        "id": 561327492,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1764653126
    },
    {
        "content": "<p>But why does it have to be that way?</p>",
        "id": 561327922,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764653446
    },
    {
        "content": "<p>I think the convention around universes in <code>Category C</code> is fairly special. What do you propose the generic behaviour should be?</p>",
        "id": 561328130,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1764653599
    },
    {
        "content": "<p>I propose that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>(and variants thereof) elaborates as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">w</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 561328608,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764653909
    },
    {
        "content": "<p>That means you still need the <code>u</code>.</p>",
        "id": 561328969,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764654150
    },
    {
        "content": "<p>In other words, uses of <code>*</code> are resolved so that all the declaration's universes are in order. Since every use of <code>*</code> is unique (the universe variable can't be reused), it is always possible to do so, at least so long as the explicitly declared universe levels are themselves in order, ie we can't solve things here:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bar</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}]</span>\n</code></pre></div>",
        "id": 561329005,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764654179
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Category*/near/561328969\">said</a>:</p>\n<blockquote>\n<p>That means you still need the <code>u</code>.</p>\n</blockquote>\n<p>No? That is included in the \"variants thereof\"</p>",
        "id": 561329045,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764654205
    },
    {
        "content": "<p>Aha, I see what you mean now.</p>",
        "id": 561329154,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764654288
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">YaÃ«l Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Category*/near/561329005\">said</a>:</p>\n<blockquote>\n<p>we can't solve things here:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Foo</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Bar</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}]</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>In such situations (which I expect are very rare), it is okay to do best effort and solve, say, the conflicts on a first-come first-served basis.</p>",
        "id": 561329226,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764654328
    },
    {
        "content": "<p>More abstractly, we have a preorder of universe variables where <code>u &lt;= v</code> means \"there is some constant in the context such <code>u</code> appears before <code>v</code> as a universe level in that declaration\" and the task is to add some elements to that poset where each element needs only satisfy two constraints at most and involving existing elements of the preorder.</p>",
        "id": 561329559,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764654575
    },
    {
        "content": "<p>Assuming there are no indistinguishable elements (<code>u &lt;= v</code> and <code>v &lt;= u</code>, such as in <code>[Foo.{u, v}] [Bar.{v, u}]</code>), this problem is solvable very efficiently. In the presence of indistinguishable elements, one could simply break ties by eg ordering each class of indistinguishable elements alphabetically or by order of declaration or whatever.</p>",
        "id": 561329862,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764654780
    },
    {
        "content": "<p>YÃ¤el's proposal is also generic: no hard-coding of <code>Category</code>, and so it's even possible to imagine making it a lean4 feature, thereby avoiding what we're doing with <code>Category*</code>, making a language dialect (namely <code>Type*</code>) even more incompatible..</p>",
        "id": 561411636,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1764682021
    },
    {
        "content": "<p>Yes, at some point, core should take this over. I have noticed that handling of level meta variables has improved since last checking but there are still advantages to instantiating parameters.</p>",
        "id": 561412705,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764682263
    },
    {
        "content": "<p><span aria-label=\"working on it\" class=\"emoji emoji-1f6e0\" role=\"img\" title=\"working on it\">:working_on_it:</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/32374\">#32374</a></p>",
        "id": 561541542,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1764719674
    },
    {
        "content": "<p>Another win for whining on Zulip...? <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 561572749,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764744484
    },
    {
        "content": "<p>(Bhavik is better than me at this)</p>",
        "id": 561572996,
        "sender_full_name": "YaÃ«l Dillies",
        "timestamp": 1764744663
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Category*/near/561541542\">said</a>:</p>\n<blockquote>\n<p><span aria-label=\"working on it\" class=\"emoji emoji-1f6e0\" role=\"img\" title=\"working on it\">:working_on_it:</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/32374\">#32374</a></p>\n</blockquote>\n<p>This should be ready for review. To avoid clutter here, I made a new thread: <a class=\"message-link\" href=\"/#narrow/channel/144837-PR-reviews/topic/.2332374/near/561768424\">#PR reviews &gt; #32374 @ ðŸ’¬</a></p>",
        "id": 561768553,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1764804428
    }
]