[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/20818\">#20818</a>, shake tells me to remove an import, but removing that import breaks the file. What can I do to fix the CI?</p>",
        "id": 496612150,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1738173388
    },
    {
        "content": "<p>You can use the <code>--update</code> flag</p>",
        "id": 496612857,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738173606
    },
    {
        "content": "<p>From <code>lake exe shake --help</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"c1\">--update</span>\n<span class=\"w\">    </span><span class=\"n\">Assume</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">issues</span><span class=\"w\"> </span><span class=\"n\">we</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"n\">positives</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">config</span>\n<span class=\"w\">    </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">them</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 496612950,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738173636
    },
    {
        "content": "<p>I find shake pretty frequently breaks my build, which ideally it would not do <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span>. If shake was doing multiple things, you can also try reinserting the import and rerunning shake, sometimes I think when shake makes multiple changes they step on each other's toes.</p>",
        "id": 496613557,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738173812
    },
    {
        "content": "<p>Breaks it how?</p>",
        "id": 496622352,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738176797
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/shake.20spurious.20failure/near/496622352\">said</a>:</p>\n<blockquote>\n<p>Breaks it how?</p>\n</blockquote>\n<p>Not sure what you're asking - I will often run <code>lake exe shake --fix</code> and I will find that when I build again, files are not importing things they need to import, leading to errors about how things were not found.</p>\n<p>For example here is an error I experienced today when trying to split, happy to get insights:</p>\n<div class=\"codehilite\" data-code-language=\"Todotxt\"><pre><span></span><code>&gt; lake build ; lake exe shake --fix ; lake build\nBuild completed successfully.\nThe following changes will be made automatically:\n././././Mathlib/Data/List/TakeDrop.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.Basic]\n<span class=\"err\">  </span>add #[Mathlib.Order.Basic, Mathlib.Data.Nat.Defs, Mathlib.Data.List.Defs]\n<span class=\"err\">  </span>instead\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Forall2\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Lattice\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Perm.Subperm\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Infix\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Flatten\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Lex\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.MinMax\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.InsertIdx\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Palindrome\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.Stream.Init\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.DropRight\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Enum\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.Indexes\n<span class=\"err\">    </span>import [Mathlib.Data.List.Basic] in Mathlib.Data.List.ReduceOption\n././././Mathlib/Data/List/Forall2.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n<span class=\"err\">  </span>instead\n<span class=\"err\">    </span>import [Mathlib.Data.List.TakeDrop] in Mathlib.Data.List.Nodup\n././././Mathlib/Data/List/Lattice.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/Perm/Subperm.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/Flatten.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/Lex.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/ProdSigma.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Defs]\n././././Mathlib/Data/List/MinMax.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/InsertIdx.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/Palindrome.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/Stream/Init.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/Enum.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/Indexes.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\n././././Mathlib/Data/List/ReduceOption.lean:\n<span class=\"err\">  </span>remove #[Mathlib.Data.List.TakeDrop]\n<span class=\"err\">  </span>add #[Mathlib.Data.List.Basic]\nSuccessfully applied 17 suggestions.\n✖ [1627/5991] Building Mathlib.Data.List.ProdSigma\ntrace: .&gt; LEAN_PATH=././.lake/packages/Cli/.lake/build/lib:././.lake/packages/batteries/.lake/build/lib:././.lake/packages/Qq/.lake/build/lib:././.lake/packages/aesop/.lake/build/lib:././.lake/packages/proofwidgets/.lake/build/lib:././.lake/packages/importGraph/.lake/build/lib:././.lake/packages/LeanSearchClient/.lake/build/lib:././.lake/packages/plausible/.lake/build/lib:././.lake/build/lib DYLD_LIBRARY_PATH= /Users/boltonbailey/.elan/toolchains/leanprover--lean4---v4.16.0-rc2/bin/lean -Dpp.unicode.fun=true -DautoImplicit=false -Dweak.linter.docPrime=false -Dweak.linter.hashCommand=true -Dweak.linter.oldObtain=true -Dweak.linter.refine=true -Dweak.linter.style.cdot=true -Dweak.linter.style.dollarSyntax=true -Dweak.linter.style.header=true -Dweak.linter.style.lambdaSyntax=true -Dweak.linter.style.longLine=true -Dweak.linter.style.longFile=1500 -Dweak.linter.style.missingEnd=true -Dweak.linter.style.multiGoal=true -Dweak.linter.style.setOption=true ././././Mathlib/Data/List/ProdSigma.lean -R ./././. -o ././.lake/build/lib/Mathlib/Data/List/ProdSigma.olean -i ././.lake/build/lib/Mathlib/Data/List/ProdSigma.ilean -c ././.lake/build/ir/Mathlib/Data/List/ProdSigma.c --json\nerror: ././././Mathlib/Data/List/ProdSigma.lean:48:3: unknown tactic\nerror: ././././Mathlib/Data/List/ProdSigma.lean:47:49: unsolved goals\nα : Type u_1\nβ : Type u_2\nl₁ : List α\nl₂ : List β\n⊢ (l₁ ×ˢ l₂).length = l₁.length * l₂.length\nerror: ././././Mathlib/Data/List/ProdSigma.lean:83:3: unknown tactic\nerror: ././././Mathlib/Data/List/ProdSigma.lean:82:69: unsolved goals\nα : Type u_1\nσ : α → Type u_3\nl₁ : List α\nl₂ : (a : α) → List (σ a)\n⊢ (l₁.sigma l₂).length = Nat.sum (map (fun a ↦ (l₂ a).length) l₁)\nerror: ././././Mathlib/Data/List/ProdSigma.lean:92:3: unknown tactic\nerror: ././././Mathlib/Data/List/ProdSigma.lean:91:47: unsolved goals\nα : Type u_1\nβ : Type u_2\nx : α\ny : β\nxs : List (α × β)\n⊢ (y, x) ∈ map Prod.swap xs ↔ (x, y) ∈ xs\nerror: Lean exited with code 1\n</code></pre></div>",
        "id": 496655724,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738190095
    },
    {
        "content": "<p>Oh, this is because shake doesn't know what tactics are used, so ProdSigma just needs a <code>Mathlib.Tactic.Cases</code> import for <code>induction'</code></p>",
        "id": 496656294,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738190376
    },
    {
        "content": "<p>Ok great, making this work automatically sounds like a good candidate for an issue/PR to the Shake tool.</p>",
        "id": 496656558,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738190505
    },
    {
        "content": "<p>Not to be too ungrateful to the people who brought us this software, but I have another complaint about shake evinced by this terminal output:</p>\n<div class=\"codehilite\" data-code-language=\"Todotxt\"><pre><span></span><code>~/Desktop/mathlibcontribution/mathlib4 master !13 ?1 ...................................... INT 30s 08:49:16\n&gt; lake build Mathlib.Algebra.Algebra.Subalgebra.Rank\nBuild completed successfully.                                                                           /0.4s\n\n~/Desktop/mathlibcontribution/mathlib4 master !13 ?1 .............................................. 08:49:21\n&gt; lake exe shake Mathlib.Algebra.Algebra.Subalgebra.Rank\nThere are out of date oleans. Run `lake build` or `lake exe cache get` first                            /1.2s\n</code></pre></div>\n<p>Seems to me that it shouldn't be too hard for shake to succeed on a particular module if that module has been built, but for whatever reason, that was not happening for me.</p>",
        "id": 496656900,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738190648
    },
    {
        "content": "<p>I think in that case it's impossible to do the interesting half of what shake does - fix the imports in files that import <code>Mathlib.Algebra.Algebra.Subalgebra.Rank</code>; just fixing the imports in that file can be done (manually) with <code>#min_imports</code></p>",
        "id": 496657661,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738190976
    },
    {
        "content": "<p>Then why is there an option for it?</p>",
        "id": 496658117,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738191183
    },
    {
        "content": "<p>I don't know</p>",
        "id": 496658197,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1738191226
    },
    {
        "content": "<p>Ah, perhaps I am misunderstanding. Maybe the point is that it shakes not on everything below, but on everything above or everything above and below the provided module, but not unrelated files?</p>",
        "id": 496658332,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738191282
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Arguments</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"bp\">&lt;</span><span class=\"n\">MODULE</span><span class=\"bp\">&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"n\">like</span><span class=\"w\"> </span><span class=\"ss\">`Mathlib</span><span class=\"bp\">`.</span><span class=\"w\"> </span><span class=\"n\">All</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"w\"> </span><span class=\"n\">transitively</span><span class=\"w\"> </span><span class=\"n\">reachable</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">the</span>\n<span class=\"w\">    </span><span class=\"n\">provided</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">checked</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 496658355,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738191297
    },
    {
        "content": "<p>What would perhaps be most ideal is to be able to shake on just those things &lt;4 or so hops away from the file in question, so that I don't have to spend 20 minutes rebuilding the library multiple times per PR.</p>",
        "id": 496660447,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1738192200
    },
    {
        "content": "<p>I'm not sure how to do what is being suggested given that I can't build all of Mathlib locally on my laptop. It's the central CI that's failing.</p>",
        "id": 496688964,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1738209606
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"400289\">@Artie Khovanov</span>, after CI fails because of <code>shake</code>, you can then run <code>lake exe cache get</code> locally, followed by <code>lake exe shake --fix</code> or <code>lake exe shake --update</code>.</p>",
        "id": 496693318,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738212794
    }
]