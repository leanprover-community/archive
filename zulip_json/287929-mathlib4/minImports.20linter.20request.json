[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, how hard would it be to have the <code>minImports</code> warning include the change in total transitive imports, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Imports</span><span class=\"w\"> </span><span class=\"n\">increased</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"n\">to</span>\n<span class=\"o\">[</span><span class=\"n\">Aesop</span><span class=\"bp\">.</span><span class=\"n\">Frontend</span><span class=\"bp\">.</span><span class=\"n\">Attribute</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Aesop</span><span class=\"bp\">.</span><span class=\"n\">Frontend</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Combinatorics</span><span class=\"bp\">.</span><span class=\"n\">Quiver</span><span class=\"bp\">.</span><span class=\"n\">Basic</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 478816338,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729813847
    },
    {
        "content": "<p>This would be really helpful for identifying bigger jumps, without requiring intimate knowledge of the library (and remembering/checking what the previous warning said).</p>",
        "id": 478816397,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729813883
    },
    {
        "content": "<p>All the information is there, since the imports that the linter suggests are a subset of the available ones.  I guess the only function that is missing is one that computes the number of transitive imports with input an array of imports.</p>",
        "id": 478856457,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729841006
    },
    {
        "content": "<p>For that, Johan wrote a python script that the PR summary uses, but I imagine that it would not be hard to update that to a Lean version.</p>",
        "id": 478856582,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729841055
    },
    {
        "content": "<p><del>As a side comment, if you are using the <code>minImports</code> linter, maybe I can also import it <em>somewhere</em> in the mathlib hierarchy, say in <code>Tactic.Common</code>?</del> I see that it is already imported in <code>Tactic.Common</code>!</p>",
        "id": 478856843,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729841174
    },
    {
        "content": "<p>I'll take a look at what is in <code>ImportGraph</code> to see whether transitive import counts are \"close\".</p>",
        "id": 478857473,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729841424
    },
    {
        "content": "<p>The linter currently stores the \"surface\" imports, that is what you obtain from <em>all</em> imports so far by removing the redundant ones.</p>",
        "id": 478868917,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729845595
    },
    {
        "content": "<p>I get easily confused by this, but \"transitive imports\" means \"number of edges in the transitive closure\", right?</p>",
        "id": 478869021,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729845619
    },
    {
        "content": "<p>Sure. How many more files are in the environment as a result of the change in imports.</p>",
        "id": 478896159,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729854910
    },
    {
        "content": "<p>There's a function <code>Lean.NameMap.transitiveClosure</code> provided in <code>import-graph</code>. Applying that to <code>Lean.Environment.importGraph</code> should give you what you want.</p>",
        "id": 478896403,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729855004
    },
    {
        "content": "<p>So I think one that just takes the union of the values of that map, over the imports that <code>minImports</code> prints in the warning, and compute the difference in the size of that union, before and after.</p>",
        "id": 478896542,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1729855063
    },
    {
        "content": "<p>Ok, yes that is simpler than figuring out numbers of edges and, as you say, it uses functions that already exist.  I'll try to get it done today!</p>",
        "id": 478901679,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1729856860
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/18303\">#18303</a></p>",
        "id": 479169572,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730067650
    },
    {
        "content": "<p>I find the <code>ImportGraph</code> API a little confusing: the new reports are probably slower than they could be and I can see that what I am doing is likely repeating quite a few computations, but I am not really sure how to streamline it.</p>",
        "id": 479169612,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730067699
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, why not stash <code>env.importGraph</code>, as well as the transitive closure of that, in an IO.Ref too? These data do not change throughout the file, and so need not be recomputed.</p>",
        "id": 479172357,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730070265
    },
    {
        "content": "<p>Ok, I'll try that.</p>",
        "id": 479173020,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730070928
    },
    {
        "content": "<p>I added the import graph to the <code>IO.Ref</code> and it does appear snappier.  I did not time it, but the difference is noticeable.</p>",
        "id": 479174300,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730072169
    },
    {
        "content": "<p>Thanks! I left some more comments.</p>",
        "id": 479175246,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730073075
    },
    {
        "content": "<p>Comments accepted, except for one that I do not know how to implement.  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 479177003,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730074638
    },
    {
        "content": "<p>I've clarified!</p>",
        "id": 479178211,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730075527
    }
]