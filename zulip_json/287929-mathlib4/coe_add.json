[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ideal</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp?</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">-</span><span class=\"n\">Submodule</span><span class=\"bp\">.</span><span class=\"n\">coe_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">AddMemClass</span><span class=\"bp\">.</span><span class=\"n\">coe_add</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>These two names seem suboptimal, didn't we have <code>Subtype.coe_add</code> at one point? Also with the current de facto standard I would have assumed that it would be <code>Subtype.add_coe</code>?</p>",
        "id": 554073227,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431028
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> you probably have something to say about this</p>",
        "id": 554073242,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431037
    },
    {
        "content": "<p>Does rfl work?</p>",
        "id": 554073351,
        "sender_full_name": "Edison Xie",
        "timestamp": 1762431083
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"699016\">@Edison Xie</span> not for <code>rw</code> purposes</p>",
        "id": 554073425,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431114
    },
    {
        "content": "<p>Ideal is defeq to submodule so Submodule.coe_add should just work?</p>",
        "id": 554073628,
        "sender_full_name": "Edison Xie",
        "timestamp": 1762431171
    },
    {
        "content": "<p>I don't think that <code>coe</code> as postfix in names is the standard?</p>",
        "id": 554073651,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762431177
    },
    {
        "content": "<p>It's <em>de facto</em> standard</p>",
        "id": 554073698,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431193
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"699016\">Edison Xie</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073628\">said</a>:</p>\n<blockquote>\n<p>Ideal is defeq to submodule so Submodule.coe_add should just work?</p>\n</blockquote>\n<p>I'm saying that it shouldn't be in the Submodule namespace because it puts extra work on the user to figure out which add-submonoid-class the user happens to be in</p>",
        "id": 554073807,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431233
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073651\">said</a>:</p>\n<blockquote>\n<p>I don't think that <code>coe</code> as postfix in names is the standard?</p>\n</blockquote>\n<p>when 1000 lemmas all have coe as postfix (because of simps), then the user (i.e. me) will learn that coe goes at the end. It is not reasonable to expect otherwise.</p>",
        "id": 554073883,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431263
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073698\">said</a>:</p>\n<blockquote>\n<p>It's <em>de facto</em> standard</p>\n</blockquote>\n<p>I don't think I've ever seen it with <code>coe</code> as postfix, can you point to some theorems that are named like that?</p>",
        "id": 554073972,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762431294
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073807\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"699016\">Edison Xie</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073628\">said</a>:</p>\n<blockquote>\n<p>Ideal is defeq to submodule so Submodule.coe_add should just work?</p>\n</blockquote>\n<p>I'm saying that it shouldn't be in the Submodule namespace because it puts extra work on the user to figure out which add-submonoid-class the user happens to be in</p>\n</blockquote>\n<p>Is there not Ideal.coe_add or similar lemmas? If not we should probly have them</p>",
        "id": 554074042,
        "sender_full_name": "Edison Xie",
        "timestamp": 1762431313
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073972\">said</a>:</p>\n<blockquote>\n<p>I don't think I've ever seen it with <code>coe</code> as postfix, can you point to some theorems that are named like that?</p>\n</blockquote>\n<p><a href=\"https://loogle.lean-lang.org/?q=%22_apply_coe%22%2C+Subtype.val+_+%3D+_\">https://loogle.lean-lang.org/?q=%22_apply_coe%22%2C+Subtype.val+_+%3D+_</a></p>",
        "id": 554074233,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431383
    },
    {
        "content": "<p>and <a href=\"https://loogle.lean-lang.org/?q=%22_coe%22%2C+DFunLike.coe+_+%3D+_\">https://loogle.lean-lang.org/?q=%22_coe%22%2C+DFunLike.coe+_+%3D+_</a> with coeFn instead of Subtype.val</p>",
        "id": 554074339,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431419
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073883\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554073651\">said</a>:</p>\n<blockquote>\n<p>I don't think that <code>coe</code> as postfix in names is the standard?</p>\n</blockquote>\n<p>when 1000 lemmas all have coe as postfix (because of simps), then the user (i.e. me) will learn that coe goes at the end. It is not reasonable to expect otherwise.</p>\n</blockquote>\n<p>Probably Mathlib is inconsistent, but it's hard to say it's the standard. <code>coe</code> is configured as a prefix for 43 structures/classes in Mathlib (search <code>as_prefix coe</code>). Also, I find ~484 result where <code>coe</code> is probably a prefix (search <code>^lemma[a-zA-Z_. ]*[ .]coe_</code>) and ~130 where it is probably a postfix (search <code>^lemma[a-zA-Z_. ]*_coe </code> including trailing space)</p>",
        "id": 554074663,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762431536
    },
    {
        "content": "<p>(Loogle also gives twice as many results for <code>\"coe_\"</code> as for <code>\"_coe\"</code>)</p>",
        "id": 554074842,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762431598
    },
    {
        "content": "<p>ah, maybe it's because we interact with different typeclasses, and the ones I interact with have not configured coe to be prefix?</p>",
        "id": 554075011,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431645
    },
    {
        "content": "<p>I'm just saying that I see coe as postfix all the time</p>",
        "id": 554075077,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431665
    },
    {
        "content": "<p>Yes, there are plenty that are not configured as prefix as well. Feel free to add <code>as_prefix coe</code> to more <code>initialize_simps_projections</code> commands (With deprecations).</p>",
        "id": 554075189,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762431699
    },
    {
        "content": "<p>I think there's an ongoing discussion about this so I don't think I should just suddenly make a PR in the middle of that</p>",
        "id": 554075295,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431736
    },
    {
        "content": "<p>for projection notation I agree that there is a discussion. I don't think for coercions there is anyone proposing that it <em>should</em> be a postfix(?)</p>",
        "id": 554075462,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1762431780
    },
    {
        "content": "<p>no, again I'm saying that that's a pattern I have learnt from interacting with mathlib theorems</p>",
        "id": 554075605,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431819
    },
    {
        "content": "<p>and, coe <em>is</em> a projection</p>",
        "id": 554075747,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762431858
    },
    {
        "content": "<p>coe is not a field in the structure so it is not the projection. The projection is <code>carrier</code>/<code>val</code>.</p>",
        "id": 554075970,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1762431918
    },
    {
        "content": "<p>The notation also comes before the argument so under every convention that has appeared in that thread <code>coe</code> should be a prefix.</p>",
        "id": 554076211,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1762431984
    },
    {
        "content": "<p><code>\"_apply_coe\"</code> is a common pattern, see <a href=\"https://loogle.lean-lang.org/?q=%22_apply_coe%22\">https://loogle.lean-lang.org/?q=%22_apply_coe%22</a></p>",
        "id": 554076588,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762432070
    },
    {
        "content": "<p>I retract my point above about coeFn, but apply_coe still stands</p>",
        "id": 554076653,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762432092
    },
    {
        "content": "<p>Kenny, this just needs <code>as_prefix coe</code>, please add it wherever you note that it's missing.</p>",
        "id": 554220381,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762478692
    },
    {
        "content": "<p>Doesn't this lead to 1000's of deprecations</p>",
        "id": 554220461,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762478739
    },
    {
        "content": "<p>Yes, perhaps. Maybe <span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> is interested in writing some meta code to auto generate the necessary deprecations? I think he mentioned this in a another thread.</p>",
        "id": 554220835,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762478931
    },
    {
        "content": "<p>yeah, so I don't think I should do it</p>",
        "id": 554220922,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1762478969
    },
    {
        "content": "<p>I think it might be reasonable (and easiest) to simply extend the <code>initialize_simps_projections</code> syntax to allow something like <code>as_prefix (since := \"&lt;date&gt;\") coe</code> (or something more explicit that mentions deprecation, if desired), and perform the deprecation within <code>@[simps]</code> (rather than having separate deprecations).</p>\n<p>Happy to PR this code so it can be used when relevant! :) (I’ll personally remain silent on whether it should actually be used here, though—not my area of expertise. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span>)</p>",
        "id": 554223293,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1762480152
    },
    {
        "content": "<p>I think incorporating the deprecation into <code>simps</code> is not ideal. It widens the surface of the deprecation code, and then that won't be caught by the new auto-removal of old deprecations. I think the ideal thing would be to use something like Leaff to determine all the moves automatically, and then generate the deprecations from that diff. However, I'm not sure Leaff is even usable currently.</p>",
        "id": 554223676,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762480482
    },
    {
        "content": "<p>It can definitely be caught by auto-removal of deprecations, simply by extending what that code removes!</p>\n<p>Not sure what you mean by “widens the surface of the deprecation code” here?</p>",
        "id": 554223815,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1762480606
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554223815\">said</a>:</p>\n<blockquote>\n<p>simply by extending what that code removes!</p>\n</blockquote>\n<p>Right, but then you are making extra work.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554223815\">said</a>:</p>\n<blockquote>\n<p>Not sure what you mean by “widens the surface of the deprecation code” here?</p>\n</blockquote>\n<p>I mean there is more code that implements deprecations, so that there are more things that need to be changed when you modify deprecation code.</p>\n<p>This idea of changing the <code>simps</code> code in my mind totally violates the principle that tools should do one thing and do it well. <code>simps</code> is for generating simp lemmas, not for generating deprecations. But having said my piece, I'll shut up and let someone else agree or disagree with you about this. At the very least, I'm not offering to implement it myself and you (I think) are, so your opinion probably matters a bit more.</p>",
        "id": 554224433,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762480961
    },
    {
        "content": "<p>I feel like <code>@[simps]</code> isn't even good at making simp lemmas</p>",
        "id": 554224885,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1762481281
    },
    {
        "content": "<p>I do want to understand what you’re saying, because maybe you’re right, and I haven’t considered something! <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span> I am just a bit confused about what you mean by “when you modify deprecation code” here. Are you still talking about deprecation removal, or does “deprecation code” mean the API for marking something as deprecated itself? (Which I didn’t get the sense was unstable—is it?)</p>",
        "id": 554224898,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1762481293
    },
    {
        "content": "<p>Right, I mean that if we allow deprecations to do more sophisticated things, e.g., something more than just date tracking and referencing the replacements, then we'll need to update that in the <code>simps</code> code too, which is weird. At the moment, the deprecation API is not unstable, but that doesn't mean we won't change it or improve it.</p>",
        "id": 554225419,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1762481690
    },
    {
        "content": "<p>A couple points, just to put them out there:</p>\n<ul>\n<li>The extra work for adjusting deprecation removal code is real, but (if I’m right about how it’s implemented!) quite small. We should definitely take care to adjust both at once, though.</li>\n<li>Deprecating inside <code>@[simps]</code> means that downstream libraries using it get deprecations for free! :)</li>\n<li>To my mind, if a tool gives one the ability to manage the generation of lemmas, it’s reasonable for it to give one the ability to manage changes in the generation of lemmas too. I’m not so much intending to disagree with the philosophy you put forward here, as with the notion that deprecation shouldn’t be considered part of the “thing” it’s doing—especially because all the information necessary for name generation and the information of which declaration replaces which other one is present inside <code>simps</code>. It’s kind of awkward and difficult (and therefore not as maintainable, in some ways) to try to infer that information from outside <code>simps</code>.</li>\n</ul>",
        "id": 554226351,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1762482089
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/channel/287929-mathlib4/topic/coe_add/near/554225419\">said</a>:</p>\n<blockquote>\n<p>Right, I mean that if we allow deprecations to do more sophisticated things, e.g., something more than just date tracking and referencing the replacements, then we'll need to update that in the <code>simps</code> code too, which is weird. At the moment, the deprecation API is not unstable, but that doesn't mean we won't change it or improve it.</p>\n</blockquote>\n<p>Ah, okay. I agree, then—I think considering long-term changes here is important!</p>\n<p><del>What if we passed the full deprecation attribute syntax to <code>initialize_simps_projections</code>? Then, presumably, it would be as easy to update as every other instance of the syntax, and not require changes to <code>simps</code> (which would just be passing the attribute syntax along).</del> Ah, we’d need some placeholder for the name if we did this, which is ugly. Perhaps passing components of the syntax is enough, and <code>simps</code> could still simply pass it along, in such a way that it’s not <em>too</em> costly to keep it in sync if the syntax changes or is extended. This lowers the cost, but you’re right that it’s still an extra cost, then.</p>\n<p>My sense is that this infrequent maintenance cost is worth it to have the tool be a “good citizen” about taking responsibility for the declarations it creates, but it’s fair for opinions to differ here. :)</p>",
        "id": 554226537,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1762482267
    },
    {
        "content": "<p>I did not understand what the suggestion about deprecations is, but the code that auto-removes them uses that a declaration has been added to the deprecation extension and the date that is present there.  Is the issue that these deprecations would not have a date associated to them?</p>",
        "id": 554256190,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1762501360
    },
    {
        "content": "<p>Rather that it's new syntax for the tool to deal with, perhaps</p>",
        "id": 554256280,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762501399
    },
    {
        "content": "<p>The tool does not inspect the syntax, it inspects the environment that is present with <code>import Mathlib</code>.</p>",
        "id": 554256369,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1762501438
    },
    {
        "content": "<p>The removal does eventually happen at the level of bytes in a file, though</p>",
        "id": 554256618,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1762501555
    },
    {
        "content": "<p>Yes, the code finds the deprecations and the ranges of the corresponding declarations from the environment and then removes those ranges from the files.</p>",
        "id": 554256743,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1762501612
    },
    {
        "content": "<p>If the range assignments are handled correctly, then the deprecations should be removed.</p>",
        "id": 554256807,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1762501641
    },
    {
        "content": "<p>Having said that, I am also aware that all automated software has plenty of bugs, so it would definitely require making sure that it really works!  <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 554256930,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1762501693
    }
]