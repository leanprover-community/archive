[
    {
        "content": "<p>I literally cannot find a library note. My algorithm usually is just \"search for the name of the note and spot it in the search results\" but I just tried searching for <code>[lower instance priority]</code> in order to figure out why an instance was prio 100 (this library note was mentioned) and the search just gives 500 results. What's the trick to find the actual library note rather than just the 499 things telling us to look at it? NB ideally this would not involve having to remember the name of a file because I am really bad at this.</p>",
        "id": 510522900,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743975647
    },
    {
        "content": "<p>How about search for <code>library_note \"lower instance priority\"</code></p>",
        "id": 510523020,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1743975754
    },
    {
        "content": "<p>There's this handy command I wrote called <code>#help note</code> which will let you search and display the appropriate note</p>",
        "id": 510523024,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743975762
    },
    {
        "content": "<p>Am I not using <code>#help note</code> properly or is it not in master or do I have to import something?</p>",
        "id": 510523196,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743975929
    },
    {
        "content": "<p>It should be available wherever help commands are</p>",
        "id": 510523254,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743975963
    },
    {
        "content": "<p>The search <em>is</em> limited by imports though</p>",
        "id": 510523279,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743975987
    },
    {
        "content": "<p>aah searching for <code>libary_note</code> seems to work. Lol <code>Mathlib.Algebra.HeirarchyDesign</code> is only imported by <code>Mathlib</code> :-)</p>",
        "id": 510523337,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743976071
    },
    {
        "content": "<p>(it's just a file full of library notes so who needs to import it?)</p>",
        "id": 510523410,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1743976128
    },
    {
        "content": "<p>That sounds like somethin that can be fixed, right?</p>",
        "id": 510523426,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743976152
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/library.20notes/near/510523410\">said</a>:</p>\n<blockquote>\n<p>(it's just a file full of library notes so who needs to import it?)</p>\n</blockquote>\n<p>The files which refer to the notes, of course</p>",
        "id": 510523443,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1743976177
    },
    {
        "content": "<p>Why aren't <code>library_note</code>s designed with a ctrl+click feature? This shouldn't be that hard to implement, right? And this would force the library note to be imported where it is referenced.</p>",
        "id": 510533481,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743984800
    },
    {
        "content": "<p>Although it may be annoying to make <code>shake</code> aware that the imports aren't unnecessary.</p>",
        "id": 510533563,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1743984848
    },
    {
        "content": "<p>I'm inclined to have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LibraryNote</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">String</span>\n</code></pre></div>\n<p>And then in certain files</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LibraryNote</span><span class=\"bp\">.</span><span class=\"n\">lowerInstancePriority</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LibraryNote</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"bla bla bla\"</span>\n</code></pre></div>\n<p>And then in other files</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">library_note</span><span class=\"w\"> </span><span class=\"n\">lowerInstancePriority</span>\n</code></pre></div>\n<p>Or some variation on that design.</p>",
        "id": 510568104,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744005917
    },
    {
        "content": "<p>I should say that it's not the first time I've failed to find a library note and I remember at least one other occasion when someone asked how to find them. My mistake this time was including the square brackets in my search string</p>",
        "id": 510568638,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744006163
    },
    {
        "content": "<p>Repeating what I hear: so your proposal is to</p>\n<ul>\n<li>make a new definition `LibraryNote := String</li>\n<li>defining a new library changes from <code>#library_note \"lower instance priority\" \"Text of the library note\" to </code>def LibraryNote.lowerInstancePriority := \"Text of the library note\" (and similarly for all notes)</li>\n<li>referencing a library note becomes <code>#libraryNote LibraryNote.lowerInstancePriority</code> (which is a no-op command, but enforces that the declaration is a <code>LibraryNote</code>, enabling Ctrl-Click)</li>\n</ul>\n<p>I wonder if writing <code>See </code>LibraryNote.lowerInstancePriority`` would also be a suitable alternative: doc-gen would (hopefully) linkify that, so we'd have library notes in the generated documentation. You cannot Ctrl-click it, but you could #print LibraryNote.lowerInstancePriority, which is perhaps good enough.</p>\n<p>I presume you'd also want to </p>\n<ul>\n<li>change <code>#help note LibraryNote.lowerInstancePriority</code> to look up all <code>LibraryNote</code> declarations in the environment. (Or perhaps still allow \"lower instance priority\", all lower-cased, and manually do name processing? Not a big deal implementation-wise.)</li>\n</ul>",
        "id": 510613137,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744018949
    },
    {
        "content": "<p>Do note (hah) that the implementation for these things is in <em>batteries</em>, not mathlib</p>",
        "id": 510613732,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744019077
    },
    {
        "content": "<p>For #help note: yes, I know. But I presume that's an issue one could deal with.</p>",
        "id": 510613844,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744019102
    },
    {
        "content": "<p>if we're going the direction of defining a type <code>LibraryNote</code>, we might as well define it as <code>Unit</code> and have the contents be actual docstrings which show on hover</p>",
        "id": 510614740,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744019300
    },
    {
        "content": "<p>One downside of my proposal is that you don't see the value of the library note in the hover tooltip.</p>",
        "id": 510614761,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744019306
    },
    {
        "content": "<p>I wanted to make the <code>Unit</code> suggestion, and then Edward posted it already <span aria-label=\"rofl\" class=\"emoji emoji-1f923\" role=\"img\" title=\"rofl\">:rofl:</span></p>",
        "id": 510614882,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744019335
    },
    {
        "content": "<p>great minds think alike <span aria-label=\"rolling on the floor laughing\" class=\"emoji emoji-1f923\" role=\"img\" title=\"rolling on the floor laughing\">:rolling_on_the_floor_laughing:</span></p>",
        "id": 510614944,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744019351
    },
    {
        "content": "<p>fools never differ... <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 510615077,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744019391
    },
    {
        "content": "<p>i guess the question becomes if this is going to be a mathlib specific definition, or if we want to upstream this change to batteries, if batteries maintainers think this is a good idea</p>",
        "id": 510615251,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744019429
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a> is a prototype for this change: it might not build yet (then I'll need to add <code>import Mathlib.Tactic.Basic</code>; this is where I chose to stick the <code>LibraryNote</code> definition for now), and I have only replaced ~one sixth of the <code>see note [library note name]</code> references. That said: opinions on that change are welcome!</p>",
        "id": 510623645,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744021478
    },
    {
        "content": "<p>i have some ideas for possible style requirements for library notes, if we make this change:</p>\n<ul>\n<li>all library notes should be in the <code>LibraryNote</code> namespace</li>\n<li>library notes should not become part of any declarations (so no putting <code>def foo : Unit := LibraryNote.someNote</code>) or such shenanigans. This could be tracked using linters?</li>\n<li>library notes should be marked <code>protected</code>, so it is clear whenever it is referred to that it is a note</li>\n</ul>",
        "id": 510626782,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744022322
    },
    {
        "content": "<p>Will <code>protected</code> play well with a potential <code>#library_note fooBar</code>? Or will we then need <code>#library_note LibraryNote.fooBar</code>?</p>",
        "id": 510627242,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744022450
    },
    {
        "content": "<p>where <code>#library_note</code> is a command <em>adding</em> the note or <em>searching for</em> the note?</p>",
        "id": 510627879,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744022625
    },
    {
        "content": "<p>if it's the first, i imagine we can just make it a macro. if it's the second, i imagine that would just be written <code>#check LibraryNote.[autocomplete]</code></p>",
        "id": 510628326,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744022756
    },
    {
        "content": "<p>When referencing the library note.<br>\nAt the moment we have <code>See LibaryNote.fooBar</code> as a substring of other docstrings. But then you can't get the hover text.<br>\nSo I'm imagining that we just leave a <code>#library_note fooBar</code> next to the docstring instead.</p>",
        "id": 510628395,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744022765
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510628326\">said</a>:</p>\n<blockquote>\n<p>if it's the first, i imagine we can just make it a macro. if it's the second, i imagine that would just be written <code>#check LibraryNote.[autocomplete]</code></p>\n</blockquote>\n<p>Right, so it's the third (-;</p>",
        "id": 510628471,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744022786
    },
    {
        "content": "<p>i don't think removing the reference from the docstring is very useful? i imagine it is commonly really part of the text, and i don't think there's a good place to add <code>#library_note fooBar</code> around a declaration which might reference it... Therefore, if it is going to be used, it's going to be written locally by the user when they want to check it, at which point you've rediscovered <code>#help note</code>. All of which is to say, it would really just be a lot easier if the hovers <em>do</em> show up for declarations referenced in docstrings.</p>",
        "id": 510629402,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023051
    },
    {
        "content": "<p>I don't see the need to change the current syntax too much. We could still have</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">library_note</span><span class=\"w\"> </span><span class=\"s2\">\"name of note\"</span><span class=\"sd\">/--</span>\n<span class=\"sd\">Actual note</span>\n<span class=\"sd\">-/</span>\n</code></pre></div>\n<p>and then referring to the note could become</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">see_note</span><span class=\"w\"> </span><span class=\"s2\">\"name of note\"</span>\n</code></pre></div>\n<p>And we could have an environment extension with a <code>HashMap String String</code> to keep track of the notes.</p>\n<p>To achieve the hovering and ctrl+clicking would just be a meta-programming excercise.</p>",
        "id": 510629714,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744023125
    },
    {
        "content": "<p>this is what currently exists</p>",
        "id": 510629799,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023145
    },
    {
        "content": "<p>Except for the <code>#see_note</code> command that allows hovering to see the note, and ctrl+clicking to go to the note.</p>",
        "id": 510629930,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744023187
    },
    {
        "content": "<p>And I propose replacing all occurences of <code>-- see note [name of note]</code> by <code>#see_note \"name of note\"</code></p>",
        "id": 510630204,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744023256
    },
    {
        "content": "<p>well... since <code>#help note \"name of note\"</code> calls <code>logInfo</code>, i think it does get a hover displaying the contents of the note?</p>",
        "id": 510630284,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023282
    },
    {
        "content": "<p>try it out:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"bp\">#</span><span class=\"n\">help</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"w\"> </span><span class=\"s2\">\"low\"</span>\n</code></pre></div>",
        "id": 510630365,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023310
    },
    {
        "content": "<p>That's very nice. The only thing missing is ctrl+click to go the the library note.</p>\n<p>And I don't like the name <code>#help note</code> for something that lives in Mathlib permanently, since it suggests a call for help. So rather something similar to <code>-- see note</code></p>",
        "id": 510630928,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744023456
    },
    {
        "content": "<p>welllllll this was a whole discussion when i wrote this command</p>",
        "id": 510631126,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023501
    },
    {
        "content": "<p>and the batteries maintainers insisted upon it</p>",
        "id": 510631188,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023522
    },
    {
        "content": "<p>So what was the discussion about? Is there a disadvantage to ctrl+click?</p>",
        "id": 510631361,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744023566
    },
    {
        "content": "<p>no, the name</p>",
        "id": 510631381,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023574
    },
    {
        "content": "<p>i do agree that ctrl+click would be beneficial to have, but i don't know how one might implement it</p>",
        "id": 510631673,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023636
    },
    {
        "content": "<p>particularly since you're not adding a declaration if you just store the info in an environment extension</p>",
        "id": 510631866,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023687
    },
    {
        "content": "<p>The name <code>#help</code> makes sense for its current use, which is to have  a user type this out to ask for help. However in the use that I'm envisioning, it's just a reference, so <code>#see_note</code> makes more sense.</p>",
        "id": 510632072,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744023727
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510631866\">said</a>:</p>\n<blockquote>\n<p>particularly since you're not adding a declaration if you just store the info in an environment extension</p>\n</blockquote>\n<p>Yeah, we could secretly add some declaration to help with this, but a more principled way would be to store the <a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Data/DeclarationRange.html#Lean.DeclarationLocation\">Lean.DeclarationLocation</a> in the environment extension.</p>",
        "id": 510632788,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744023891
    },
    {
        "content": "<p>again, i agree with you there, so let me tell you more about approximately how this came to be:</p>\n<ul>\n<li>be me, can't find library notes</li>\n<li>decide to make a command which displays them</li>\n<li>make such a command, named <code>#find_note</code> or <code>#check_note</code></li>\n<li>get feedback saying \"maybe it's also nice if it just displays all of the notes with the provided prefix, instead of just the ones which match exactly\"</li>\n<li>implement this</li>\n<li>get feedback saying \"this really is a lot like #help attr\" and other help commands, so it should be a <code>#help</code> command</li>\n<li>reluctantly change the name</li>\n</ul>",
        "id": 510633192,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744023980
    },
    {
        "content": "<p>which is to say, since a <code>#see_note</code> command is made redundant by the <code>#help note</code> command, no such command exists</p>",
        "id": 510633448,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744024042
    },
    {
        "content": "<p>Maybe <code>#see_note</code> isn't fully redundant.</p>\n<ol>\n<li><code>#help note \"nam\"</code> will also show notes where the name starts with \"nam\". But I want <code>#see_note</code> to only show the exact note it refers to.</li>\n<li><code>#help note</code> logs a message, but if we will have <code>#see_note</code> permanently in mathlib, it shouldn't log a message (but still have a hover message). Or maybe it can show a message in the infoview only if the cursor is on it?</li>\n</ol>",
        "id": 510634681,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744024340
    },
    {
        "content": "<p>And for <code>#see_note \"name of note\"</code>, we could also have hovering over <code>\"name of note\"</code> show the note, while hovering over <code>#see_note</code> gives information about library notes, and about the commands <code>#see_note</code> and <code>#help note</code>. This would massively improve the discoverability.</p>",
        "id": 510635259,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744024483
    },
    {
        "content": "<p>i don't believe there is a nice way to use <code>#see_note</code> when relevant, in a way that it can stick around in mathlib... i believe that these references need to be in the docstring, not next to it.</p>",
        "id": 510635820,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744024630
    },
    {
        "content": "<p>and if someone wants to know the content, they can use <code>#help note</code>, or if we proceed with the earlier suggestion, <code>#check LibraryNote.foo</code></p>",
        "id": 510636078,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744024688
    },
    {
        "content": "<p>I don't know, but all I see in mathlib is <code>-- See note [lower instance priority]</code>, which very much can be replaced by <code>#see_note \"lower instance priority\"</code>.</p>",
        "id": 510636295,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744024736
    },
    {
        "content": "<p>And as long as we can't have hovers or ctrl+click inside of docstrings, I think a <code>#see_note</code> command is a clear improvement.</p>",
        "id": 510636463,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744024778
    },
    {
        "content": "<p>Maybe it's worth pointing out that VSCode exposure of notes is only half the problem, we also want them visible and linked in doc-gen like they were in Lean 3</p>",
        "id": 510636499,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744024788
    },
    {
        "content": "<p>Right, so then I think referring to them via a command would be a good first step. Although I don't know how lean 3 did it.</p>",
        "id": 510638074,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744025190
    },
    {
        "content": "<p>Lean 3 had native support for library notes in the vscode extension and doc-gen</p>",
        "id": 510639380,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744025515
    },
    {
        "content": "<p>Where the native support in the extension was, apparently, just a regex</p>",
        "id": 510639533,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744025551
    },
    {
        "content": "<p>Let me try to summarize the discussion. We are talking about four distinct operations.</p>\n<ul>\n<li>(1) define a new library note</li>\n<li>(2) reference a library note in other files</li>\n<li>(3) view a library notes/search for library notes</li>\n<li>(4) expose library notes in the generated documentation</li>\n</ul>\n<p>As I understand it, the <strong>current status</strong> is:</p>\n<ul>\n<li>(1) use <code>#library_note /-- definition -/</code> in the relevant mathlib file. This works well enough.</li>\n<li>\n<p>(2) done manually using <code>See note [lower instance priority]</code><br>\nIssues: to see the note's content, you need to <code>#help note \"lower\"</code> separately. You cannot use go to definition (neither on the doc-string nor on the help output). The generated documentation does not   </p>\n</li>\n<li>\n<p>(3) <code>#help note lower</code> does this; hovering over the output shows the note. No go-to-definition.</p>\n</li>\n<li>(4) completely missing; not ported form Lean 3</li>\n</ul>\n<p><strong>Issues</strong> with the current design:</p>\n<ul>\n<li>finding the definition of notes: just searching for \"[lower instance priority]\" yields too many hits; you need to know about #help note. And even then, you will only find the library notes imported so far. (Requiring library note references to be imported upon reference would help.)</li>\n<li>show a note: <code>#help note \"lower\"</code> shows the note upon hover (nice), but you cannot go to definition.</li>\n<li>the generated documentation does not show library notes <strong>at all</strong> (that feature was not translated)</li>\n<li>documentation references \"see note [lower instance priority]\" do not point anywhere.</li>\n</ul>\n<p>Is this a complete summary so far? If so, I'll look at the various proposals in this thread next.</p>",
        "id": 510650890,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744028177
    },
    {
        "content": "<p>I think that's about right</p>",
        "id": 510651925,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744028427
    },
    {
        "content": "<p>I think that's about right</p>",
        "id": 510652044,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744028462
    },
    {
        "content": "<p>Modulo the precise syntax of <code>#help note</code></p>",
        "id": 510652045,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744028462
    },
    {
        "content": "<p>I think that's about right</p>",
        "id": 510653125,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744028699
    },
    {
        "content": "<p>Modulo the precise syntax of <code>#help note</code></p>",
        "id": 510653126,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744028699
    },
    {
        "content": "<h2>Proposal 1: a #see_note command</h2>\n<p>Remove references in the docs, and add a command <code>#see_note lowerInstancePriority</code> (or perhaps <code>#see_note \"lower instance priority\"</code>) instead.<br>\nThat command would (1) check that the relevant library note exists (resolving the discovery/imports problem), (2) show hover text (by re-using the logic of <code>#help note</code>).</p>\n<p>Migration effort: all documentation references (so ~1500 lines, but fairly automatable; can be done incrementally)</p>\n<p>Advantanges</p>\n<ul>\n<li>Solves the imports/discovery problem; prevents typos</li>\n<li>Go to definition is still missing.</li>\n</ul>\n<p>Disadvantage: documentation handling needs custom handling in doc-gen --- both for displaying the library notes and showing references to them.</p>\n<p>Open questions: should this live in batteries also? And should this re-use #help note, or replace it?</p>",
        "id": 510653545,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744028789
    },
    {
        "content": "<h1>Proposal 2a: make library notes a definition</h1>\n<p>Create a new type <code>LibraryNote</code> - which is a <code>Unit</code>type, whose doc-string will be the note's contents. <a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a> prototypes this.</p>\n<p>Migration effort: all library notes (done already, &lt; 100 lines diff overall) + modifying #help note<br>\n(Plus migrating library note references: part of proposal 2b; similar to proposal 1.)</p>\n<p>Advantages</p>\n<ul>\n<li>solves the \"definition\" half of the imports/discovery problem; prevents typos</li>\n<li>hovers and go to definition are included</li>\n<li>doc-gen displays library notes \"for free\"</li>\n</ul>\n<p>Disadvantages</p>\n<ul>\n<li>syntax changes, migration effort</li>\n<li>is this necessary? can the #library_note command also achieve this? (Yes, it can. But that requires work elsewhere.)</li>\n</ul>",
        "id": 510655097,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744029121
    },
    {
        "content": "<h1>Proposal 2b: additionally, change library notes in doc-strings</h1>\n<p>Change library note references to <code>See LibraryNote.lowerInstancePriority</code> in doc-strings.</p>\n<p>Migration effort: all documentation references (similarly automatable to the above)</p>\n<p>Advantages</p>\n<ul>\n<li>doc-gen will allow go to definition in the generated documentation for free</li>\n</ul>\n<p>Disadvantages</p>\n<ul>\n<li>cannot hover over a doc-string to show a library note (but could do #check LibraryNote.lowerInstancePriority and hover over 'that' output)</li>\n<li>import problem for library note references unsolved</li>\n</ul>",
        "id": 510655598,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744029233
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a> implements proposal 2a; <a href=\"https://github.com/leanprover-community/mathlib4/pull/23786\">#23786</a> also implements most of 2b.</p>",
        "id": 510655828,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744029281
    },
    {
        "content": "<p>Is that a fair summary of the above? If not, please add points I forgot!</p>",
        "id": 510656036,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744029326
    },
    {
        "content": "<p>To me it seems that proposal 2a lets us piggy-back on a lot of existing infrastructure, instead of building bespoke versions.</p>",
        "id": 510667688,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744031866
    },
    {
        "content": "<p>For proposal 2, we can still have a macro <code>library_note nameOfNote</code> that expands to <code>def LibraryNote.nameOfNote : LibraryNote := ()</code></p>",
        "id": 510671372,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744032648
    },
    {
        "content": "<p>A minor point on naming: if there ends up a custom command for flagging library notes, the command should probably not start with <code>#</code>, since there is a fairly widespread convention that commands starting with <code>#</code> are transient and not intended to stay in final code (and the <code>hashCommand</code> linter will flag them).</p>",
        "id": 510681652,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744034750
    },
    {
        "content": "<p>So, I would suggest using something like <code>see_note</code>, as opposed to <code>#see_note</code>, if that ends up being the final implementation.</p>",
        "id": 510681853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744034782
    },
    {
        "content": "<p>I have now pared <a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a> down to step 2a, i.e. making library notes a definition. I have a macro <code>library_note nameOfNote</code> that expands to <code>def LibraryNote.nameOfNote : LibraryNote := ()</code>- but would like to extend that to add in the doc-string. Help with that is welcome, feel free to push right to my branch.</p>",
        "id": 510688876,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744036253
    },
    {
        "content": "<p>What's wrong with just writing the docstring above <code>library_note nameOfNote</code>?</p>",
        "id": 510694536,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744037639
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510694536\">said</a>:</p>\n<blockquote>\n<p>What's wrong with just writing the docstring above <code>library_note nameOfNote</code>?</p>\n</blockquote>\n<p>In fact that's exactly how I envisioned Lean 4 would do it, before I saw the actual syntax</p>",
        "id": 510697485,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744038295
    },
    {
        "content": "<p>Try it: writing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- test -/</span>\n<span class=\"n\">library_note</span><span class=\"w\"> </span><span class=\"sd\">/-- test -/</span><span class=\"w\"> </span><span class=\"ss\">`lowerInstancePriority</span>\n</code></pre></div>\n<p>will error with <code>unexpected token 'library_note'; expected 'lemma'</code>.</p>",
        "id": 510697692,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744038346
    },
    {
        "content": "<p>Well I assume that Jovan's question doesn't call for the answer \"Because that's not how it's done right now\" <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 510698013,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744038423
    },
    {
        "content": "<p>Yes, I meant to implement and use the <code>library_note nameOfNote</code> macro in your PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a>.</p>",
        "id": 510698776,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744038614
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510671372\">said</a>:</p>\n<blockquote>\n<p>For proposal 2, we can still have a macro <code>library_note nameOfNote</code> that expands to <code>def LibraryNote.nameOfNote : LibraryNote := ()</code></p>\n</blockquote>\n<p>This one</p>",
        "id": 510698849,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744038636
    },
    {
        "content": "<p>Can't wait for <code>exact?</code> to return <code>Try this: exact lowerInstancePriority</code></p>",
        "id": 510698995,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744038676
    },
    {
        "content": "<p>That's a separate problem that already exists, where <code>exact?</code> gives suggestions appearing inside stuff like the <code>Tactic</code> namespace (or lemmas used for <code>omega</code>). So we would have to exclude those and also the <code>LibraryNote</code> namespace.</p>",
        "id": 510699572,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1744038827
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510697692\">said</a>:</p>\n<blockquote>\n<p>Try it: writing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- test -/</span>\n<span class=\"n\">library_note</span><span class=\"w\"> </span><span class=\"sd\">/-- test -/</span><span class=\"w\"> </span><span class=\"ss\">`lowerInstancePriority</span>\n</code></pre></div>\n<p>will error with <code>unexpected token 'library_note'; expected 'lemma'</code>.</p>\n</blockquote>\n<p>Something like this works</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LibraryNote</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"c1\">-- XXX: how to add the doc-string into the generated macro?</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">dc</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"w\"> </span><span class=\"s2\">\" library_note \"</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dc</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"w\"> </span><span class=\"ss\">`LibraryNote</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LibraryNote</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"sd\">/-- hello -/</span><span class=\"w\"> </span><span class=\"n\">library_note</span><span class=\"w\"> </span><span class=\"n\">D</span>\n\n<span class=\"sd\">/-- info: hello -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findDocString?</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`LibraryNote.D</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">doc</span>\n</code></pre></div>",
        "id": 510701141,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744039216
    },
    {
        "content": "<p>Although probably the command should make <code>LibraryNote</code> be the \"outermost\" namespace of the library note?</p>",
        "id": 510701661,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744039356
    },
    {
        "content": "<p>And maybe it should be declared an implementation detail?</p>",
        "id": 510702329,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744039516
    },
    {
        "content": "<p>I think this is one of those things that it makes sense to put in the <code>Mathlib</code> namespace. Other repos can also have <code>LibraryNote</code>s since this is/will be in <code>Batteries</code>.</p>",
        "id": 510702614,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744039572
    },
    {
        "content": "<p>That is, I'm advocating for <code>Mathlib.LibraryNote.nameOfNote</code> or even <code>⟨LakeProjectName⟩.LibraryNote.nameOfNote</code></p>",
        "id": 510702770,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744039612
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510681652\">said</a>:</p>\n<blockquote>\n<p>A minor point on naming: if there ends up a custom command for flagging library notes, the command should probably not start with <code>#</code>, since there is a fairly widespread convention that commands starting with <code>#</code> are transient and not intended to stay in final code (and the <code>hashCommand</code> linter will flag them).</p>\n</blockquote>\n<p>Really? What about <code>#guard_msgs</code>?</p>",
        "id": 510703068,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744039681
    },
    {
        "content": "<p>I think material specific for tests is exempt from this requirement.</p>",
        "id": 510704243,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744039951
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510701141\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510697692\">said</a>:</p>\n<blockquote>\n<p>Try it: writing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- test -/</span>\n<span class=\"n\">library_note</span><span class=\"w\"> </span><span class=\"sd\">/-- test -/</span><span class=\"w\"> </span><span class=\"ss\">`lowerInstancePriority</span>\n</code></pre></div>\n<p>will error with <code>unexpected token 'library_note'; expected 'lemma'</code>.</p>\n</blockquote>\n<p>Something like this works</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">LibraryNote</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Unit</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"c1\">-- XXX: how to add the doc-string into the generated macro?</span>\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"n\">dc</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"w\"> </span><span class=\"s2\">\" library_note \"</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">dc</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">append</span><span class=\"w\"> </span><span class=\"ss\">`LibraryNote</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LibraryNote</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">())</span>\n\n<span class=\"sd\">/-- hello -/</span><span class=\"w\"> </span><span class=\"n\">library_note</span><span class=\"w\"> </span><span class=\"n\">D</span>\n\n<span class=\"sd\">/-- info: hello -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">run_cmd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findDocString?</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`LibraryNote.D</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">doc</span>\n<span class=\"bp\">`````</span>\n\n<span class=\"n\">Ah</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">:</span><span class=\"n\">docComment</span><span class=\"ss\">`was</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">missing</span><span class=\"w\"> </span><span class=\"n\">part</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"w\"> </span><span class=\"n\">think!</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 510707687,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744040834
    },
    {
        "content": "<p>In order to somewhat maintain backwards compatibility, can we keep the doc-comment <em>after</em> <code>library_note</code>?</p>",
        "id": 510710077,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744041495
    },
    {
        "content": "<p>I don't know, it's very off with all the other syntaxes, plus <code>library_note</code> is only used in mathlib as far as I'm aware</p>",
        "id": 510710559,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1744041621
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510653545\">said</a>:</p>\n<blockquote>\n<h2>Proposal 1: a #see_note command</h2>\n<p>Remove references in the docs, and add a command <code>#see_note lowerInstancePriority</code> (or perhaps <code>#see_note \"lower instance priority\"</code>) instead.<br>\nThat command would (1) check that the relevant library note exists (resolving the discovery/imports problem), (2) show hover text (by re-using the logic of <code>#help note</code>).</p>\n<p>Migration effort: all documentation references (so ~1500 lines, but fairly automatable; can be done incrementally)</p>\n<p>Advantanges</p>\n<ul>\n<li>Solves the imports/discovery problem; prevents typos</li>\n<li>Go to definition is still missing.</li>\n</ul>\n<p>Disadvantage: documentation handling needs custom handling in doc-gen --- both for displaying the library notes and showing references to them.</p>\n<p>Open questions: should this live in batteries also? And should this re-use #help note, or replace it?</p>\n</blockquote>\n<p>You can let <code>#see_note</code> command injects a custom module docstring (<code>/-! ... -/</code>) to current place.</p>",
        "id": 510721844,
        "sender_full_name": "Jz Pan",
        "timestamp": 1744044711
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510710077\">said</a>:</p>\n<blockquote>\n<p>In order to somewhat maintain backwards compatibility, can we keep the doc-comment <em>after</em> <code>library_note</code>?</p>\n</blockquote>\n<p>I independently reached the same conclusion, for slightly different reasons: with a long library note, having some trailing identifier after the doc-string feels more confusing than helpful.</p>",
        "id": 510723479,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744045197
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a> is updated with the recent discussions: doc-strings are integrated, library notes are in the <code>Mathlib.LibraryNote</code> namespace, everything uses the macro. From my side, the main remaining question is \"should we change the definition in batteries instead\"/ do we need some kind of backwards compatibility there? (For now, I used a <code>library_note2</code> command, which is not great.)</p>",
        "id": 510723766,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744045270
    },
    {
        "content": "<p>Once this thread has converged on the details for proposal 2a; I'll re-examine proposals 1 and 2b.</p>",
        "id": 510724000,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744045333
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510639533\">said</a>:</p>\n<blockquote>\n<p>Where the native support in the extension was, apparently, just a regex</p>\n</blockquote>\n<p>I would argue that the use of \"just a regex\" here actually results in a much better scenario, even better than what <code>#see_note</code> would give us, because it means you can use these comments anywhere, including in the middle of declarations or doc strings, and get go to def all the same. This is the part that is missing in lean 4</p>",
        "id": 510727219,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1744046362
    },
    {
        "content": "<p>Until we get go-to-def on decl names in docstrings (-;</p>",
        "id": 510728961,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744046905
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510703068\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510681652\">said</a>:</p>\n<blockquote>\n<p>A minor point on naming: if there ends up a custom command for flagging library notes, the command should probably not start with <code>#</code>, since there is a fairly widespread convention that commands starting with <code>#</code> are transient and not intended to stay in final code (and the <code>hashCommand</code> linter will flag them).</p>\n</blockquote>\n<p>Really? What about <code>#guard_msgs</code>?</p>\n</blockquote>\n<p>Linters are special-cased with <code>#guard_msgs</code>, since they caused a bit of a headache with parsing multiple times the same command.  See <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.elabCommandTopLevel#doc\">docs#Lean.Elab.Command.elabCommandTopLevel</a> and <a href=\"https://github.com/leanprover/lean4/blob/fafd381c90598fe9969f3cb8f1df9b3d1b87a219/src/Lean/Elab/Command.lean#L587\">this line</a> in particular.</p>",
        "id": 510733470,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744048315
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510723479\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510710077\">said</a>:</p>\n<blockquote>\n<p>In order to somewhat maintain backwards compatibility, can we keep the doc-comment <em>after</em> <code>library_note</code>?</p>\n</blockquote>\n<p>I independently reached the same conclusion, for slightly different reasons: with a long library note, having some trailing identifier after the doc-string feels more confusing than helpful.</p>\n</blockquote>\n<p>This would be automatic with <code>def LibraryNote := String</code>.</p>\n<p>Of course, then we wouldn't get tooltips to display the library note automatically...</p>",
        "id": 510845676,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744092590
    },
    {
        "content": "<p>I've only skimmed parts of the conversation, but if the syntax was something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">add_note</span><span class=\"w\"> </span><span class=\"n\">lowerInstancePriority</span><span class=\"w\"> </span><span class=\"n\">My</span><span class=\"bp\">.</span><span class=\"n\">declaration</span>\n</code></pre></div>\n<p>you could use the existing infrastructure to append a note about that to the docstring of the declaration if desirable. I forgot the name of the command, is it <code>#extend_doc</code> or something?</p>",
        "id": 510909934,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1744112809
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510845676\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510723479\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510710077\">said</a>:</p>\n<blockquote>\n<p>In order to somewhat maintain backwards compatibility, can we keep the doc-comment <em>after</em> <code>library_note</code>?</p>\n</blockquote>\n<p>I independently reached the same conclusion, for slightly different reasons: with a long library note, having some trailing identifier after the doc-string feels more confusing than helpful.</p>\n</blockquote>\n<p>This would be automatic with <code>def LibraryNote := String</code>.</p>\n<p>Of course, then we wouldn't get tooltips to display the library note automatically...</p>\n</blockquote>\n<p>Correct. But my impression is that having a macro generating the LibraryNote definitions also  handles this.</p>",
        "id": 510911401,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744113247
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span> <a href=\"#narrow/channel/287929-mathlib4/topic/library.20notes/near/510909934\">said</a>:</p>\n<blockquote>\n<p>I've only skimmed parts of the conversation, but if the syntax was something like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">add_note</span><span class=\"w\"> </span><span class=\"n\">lowerInstancePriority</span><span class=\"w\"> </span><span class=\"n\">My</span><span class=\"bp\">.</span><span class=\"n\">declaration</span>\n</code></pre></div>\n<p>you could use the existing infrastructure to append a note about that to the docstring of the declaration if desirable. I forgot the name of the command, is it <code>#extend_doc</code> or something?</p>\n</blockquote>\n<p>This is about the \"how to refer to an existing library note in a declaration\", right?</p>",
        "id": 510911483,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744113275
    },
    {
        "content": "<p>yes, about how to get the library note link into the hover in VSCode and into the docgen page for the declaration which has the note</p>",
        "id": 510912079,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1744113438
    },
    {
        "content": "<p>This thread seems to have stalled. It seems the first part (\"proposal 2a\") had no objections, and the only open questions are about 1/2b, i.e. referencing library notes. Can I ping <a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a> (which implements the first part) for review again?</p>\n<p>In terms of landing this, I'm envisioning (barring any reasons to change plans, as usual):</p>\n<ul>\n<li>review on the mathlib PR, to see if there are any substantial issues; that PR gets merged</li>\n<li>I'll make a PR to batteries, changing the definition of library notes to the proposed design in <a href=\"https://github.com/leanprover-community/mathlib4/pull/23767\">#23767</a></li>\n<li>a mathlib PR switches mathlib to the batteries definition<br>\nThis avoids complicated adaptations.</li>\n</ul>\n<p>I'm happy to make the second two PRs, if there's an indication of support for this plan.</p>",
        "id": 512361699,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1744733522
    }
]