[
    {
        "content": "<p>I seem to have stumbled into a diamond of some sorts, what's going on here?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Order</span><span class=\"bp\">.</span><span class=\"n\">ConditionallyCompleteLattice</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">LinearOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">WellFoundedLT</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∉</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Iio</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">a</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">OrderBot</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WellFoundedLT</span><span class=\"bp\">.</span><span class=\"n\">toOrderBot</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">WellFoundedLT</span><span class=\"bp\">.</span><span class=\"n\">conditionallyCompleteLinearOrderBot</span><span class=\"w\"> </span><span class=\"n\">α</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">mem_Iio</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- synthesized type class instance is not definitionally equal...</span>\n</code></pre></div>",
        "id": 527758091,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752002037
    },
    {
        "content": "<p>clearly, there is a diamond</p>",
        "id": 527758346,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752002160
    },
    {
        "content": "<p>I suspect there's something wrong with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WellFoundedLT.conditionallyCompleteLinearOrderBot#doc\">docs#WellFoundedLT.conditionallyCompleteLinearOrderBot</a>, but I don't know what it is</p>",
        "id": 527758576,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752002263
    },
    {
        "content": "<p>oh you used <code>have</code> instead of <code>let</code>, this one is your fault</p>",
        "id": 527758604,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752002278
    },
    {
        "content": "<p>Oh yeah of course my bad</p>",
        "id": 527758635,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752002294
    },
    {
        "content": "<p>That was easy</p>",
        "id": 527758644,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1752002299
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"459227\">Violeta Hernández</span> has marked this topic as resolved.</p>",
        "id": 527758655,
        "sender_full_name": "Notification Bot",
        "timestamp": 1752002305
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.E2.9C.94.20Diamond.20with.20.60ConditionallyCompleteLinearOrderBot.60/near/527758604\">said</a>:</p>\n<blockquote>\n<p>oh you used <code>have</code> instead of <code>let</code>, this one is your fault</p>\n</blockquote>\n<p>I wouldn’t say that. I would say we do not have a linter for that yet. But everybody is welcome to help, because this is a very very common trap.</p>",
        "id": 527767421,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1752006354
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110031\">@Patrick Massot</span> This one is tricky, for example with <code>have : OrderBot α := WellFoundedLT.toOrderBot</code>, there is not already any <code>OrderBot</code> instance on <code>α</code>, so no chance of a diamond, and I don't think this one should be linted. I suspect any such linter will have to do something similar to <code>assumeInstancesCommute</code> from <a href=\"https://github.com/leanprover-community/quote4\">Quote4</a>.</p>",
        "id": 527767863,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1752006560
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib%2FTactic%2FLinter%2FHaveLetLinter.lean\">There is</a> a linter for have/let, it is just not active by default.</p>",
        "id": 527769616,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752007399
    },
    {
        "content": "<p>I think that it only flags <code>have</code>s that should be <code>let</code>, not the other way round.  That was a later PR that never got merged, if I remember correctly.</p>",
        "id": 527769764,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752007466
    },
    {
        "content": "<p>It's <code>have</code>s that should be <code>let</code>s which are the common source of user confusion. Why is this not enabled by default?</p>",
        "id": 527769856,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1752007512
    },
    {
        "content": "<p>I don't remember, maybe it was slow.</p>",
        "id": 527770099,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752007618
    },
    {
        "content": "<p>I don't think the rule is so clear when it \"should be let\"</p>",
        "id": 527771772,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752008427
    },
    {
        "content": "<p>Maybe the relevant rule is \"emit a linter warning if there is a defeq check that fails which references the `have``\"</p>",
        "id": 527771821,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1752008451
    },
    {
        "content": "<p>The rule is clear -- it is \"have for a type should be let unless the user knows what they're doing in which case they can just follow the instructions in the warning to turn the linter off for that declaration\"</p>",
        "id": 527772109,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1752008577
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.E2.9C.94.20Diamond.20with.20.60ConditionallyCompleteLinearOrderBot.60/near/527770099\">said</a>:</p>\n<blockquote>\n<p>I don't remember, maybe it was slow.</p>\n</blockquote>\n<p>I believe it was disabled because it had some bug; IIRC there is a comment pointing to the bug.</p>",
        "id": 527773000,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1752009065
    },
    {
        "content": "<p>The linter was already silent on correct proofs.  It was only emitting a warning on incomplete proofs, precisely so that if you \"know what you are doing and Lean agrees with you\", then it is fine.</p>",
        "id": 527773111,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1752009119
    }
]