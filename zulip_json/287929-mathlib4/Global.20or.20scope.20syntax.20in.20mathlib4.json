[
    {
        "content": "<p>Mathlib4 defines lots of global syntaxes like this one:</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/StacksAttribute.lean#L134\">https://github.com/leanprover-community/mathlib4/blob/master/Mathlib/Tactic/StacksAttribute.lean#L134</a></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">StacksTag</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"stacks\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stacksTagDB</span>\n</code></pre></div>\n<p>With just <code>import Mathlib.Tactic</code>, the Lean parser effectively treats <code>stacks</code> as a reserved keyword.<br>\nIn a file <code>Foo.lean</code>, I had something like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">   </span><span class=\"n\">stacks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span>\n</code></pre></div>\n<p>Ok, no problem so far; elsewhere, I had:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Foo</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">kaboum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">   </span><span class=\"n\">stacks</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n</code></pre></div>\n<p>Now, I get confusing error messages:</p>\n<ul>\n<li>at \"where\": Fields missing: <code>stacks</code></li>\n<li>at \"stacks\": unexpected token 'stacks'; expected command</li>\n</ul>\n<p>There are at least two ways to work around this:</p>\n<p>1) Escape the symbol when <code>Mathlib.Tactic</code> is imported</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">kaboum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">   </span><span class=\"bp\">«</span><span class=\"n\">stacks</span><span class=\"bp\">»</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n</code></pre></div>\n<p>2) Globally scope the syntax definition</p>\n<p>In <code>Mathlib/Tactic/StacksAttribute.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">StacksTag</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"n\">global</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"stacks\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stacksTagDB</span>\n</code></pre></div>\n<p>However, this would require an explicit <code>open Mathlib.StacksTag</code> for the parser to recognize it.</p>\n<p>With 183 definitions of \"syntax ...\" in Mathlib.Tactic, there's a high likelihood that someone else will trip on this name collision.</p>\n<p>What should we do about this?</p>",
        "id": 567862397,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1768340020
    },
    {
        "content": "<p>make it non-reserved</p>",
        "id": 567863267,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768340483
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> Can you elaborate what this means?</p>",
        "id": 567863839,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1768340779
    },
    {
        "content": "<p>Non-reserved means don't treat <code>stacks</code> as a keyword but instead make it parse from the identifier \"stacks\".</p>",
        "id": 567864940,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1768341036
    },
    {
        "content": "<p>it means you can use it in the syntax without becoming a reserved token (so you can also use it as just a name), for example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Tactic.tacticRfl#doc\">docs#Lean.Parser.Tactic.tacticRfl</a> is a tactic but it's nonreserved so <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=rfl#doc\">docs#rfl</a> is a term and you can refer to it without having a conflict<br>\nsee also <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.ParserDescr.nonReservedSymbol#doc\">docs#Lean.ParserDescr.nonReservedSymbol</a> <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.nonReservedSymbol#doc\">docs#Lean.Parser.nonReservedSymbol</a> <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Syntax.nonReserved#doc\">docs#Lean.Parser.Syntax.nonReserved</a> <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.LeadingIdentBehavior#doc\">docs#Lean.Parser.LeadingIdentBehavior</a></p>",
        "id": 567864971,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768341039
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span> Thanks for the pointers.</p>\n<p>If I understand well, the suggestion would be to change the way Mathlib.Tactic syntactic symbols are defined.</p>\n<p>Instead of:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"stacks\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stacksTagDB</span>\n</code></pre></div>\n<p>We'd have:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nonReservedSymbol</span><span class=\"w\"> </span><span class=\"s2\">\"stacks\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stacksTagDB</span>\n</code></pre></div>\n<p>or:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">stacksDB</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">nonReservedSymbol</span><span class=\"w\"> </span><span class=\"s2\">\"stacks\"</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">stacksDB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stacksTagDB</span>\n</code></pre></div>\n<p>There are pros/cons to <code>scoped</code> vs. <code>nonReservedSymbol</code>:</p>\n<table>\n<thead>\n<tr>\n<th>Approach</th>\n<th>Pros</th>\n<th>Cons</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>scoped syntax</code></td>\n<td>Explicit opt-in</td>\n<td>Requires <code>open</code> everywhere the attribute is used</td>\n</tr>\n<tr>\n<td><code>nonReservedSymbol</code></td>\n<td>Works globally, doesn't break identifiers</td>\n<td>Slightly more complex syntax definition</td>\n</tr>\n</tbody>\n</table>\n<p>Should we apply this change to all <strong>183</strong> Mathlib.Tactic syntax definitions?</p>\n<p>(do <code>grep -r '^syntax ' Mathlib/Tactic/**/*.lean</code> in your copy of Mathlib4)</p>",
        "id": 567867879,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1768342179
    },
    {
        "content": "<p>I'm thinking we should instead change the leading ident behavior of the syntax category <code>stacksTagDB</code></p>",
        "id": 567868027,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1768342244
    },
    {
        "content": "<p>By the way, <code>stacks</code> is only used for attributes, right?</p>",
        "id": 567868995,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1768342693
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Global.20or.20scope.20syntax.20in.20mathlib4/near/567868995\">said</a>:</p>\n<blockquote>\n<p>By the way, <code>stacks</code> is only used for attributes, right?</p>\n</blockquote>\n<p>I'm not an expert on Mathlib Tatics; hopefully someone can answer that question.</p>\n<p>Regarding the proposition to use a non-reserved symbol, the proper incantation w/ Lean 4.27.0-rc1 is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- makes \"stack\" a non-reserved symbol</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"bp\">&amp;</span><span class=\"s2\">\"stacks\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stacksTagDB</span>\n</code></pre></div>",
        "id": 567873173,
        "sender_full_name": "Nicolas Rouquette",
        "timestamp": 1768344927
    },
    {
        "content": "<p>Did this get fixed? A PR would be great.</p>",
        "id": 570453571,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1769564444
    },
    {
        "content": "<p>I guess I'll put something toger</p>",
        "id": 570454482,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769565253
    },
    {
        "content": "<p>well I tried it and it doesn't work</p>",
        "id": 570455269,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769565887
    },
    {
        "content": "<p>doing <code>&amp;\"stacks\"</code> instead of <code>\"stacks\"</code> fails because it parses it as a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Attr.simple#doc\">docs#Lean.Parser.Attr.simple</a></p>",
        "id": 570455331,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769565951
    },
    {
        "content": "<p>and doing <code>(behavior := symbol)</code> or <code>(behavior := both)</code> leads to ambiguous parsing when you have stuff like <code>@[kerodon 0X12]</code> in which there's no additional comment and the tag can be interpreted as either an identifier or a number literal (or more generally anything of syntax category <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Category.prio#doc\">docs#Lean.Parser.Category.prio</a>) (this is also due to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.Attr.simple#doc\">docs#Lean.Parser.Attr.simple</a>)</p>",
        "id": 570455560,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769566139
    },
    {
        "content": "<p>and this gives you the wonderful error \"Unknown attribute <code>[choice]</code>\" because the parser wraps the two options in a <code>choice</code> node and for some reason it's interpreted as the name of the attribute</p>",
        "id": 570455619,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1769566184
    }
]