[
    {
        "content": "<p>Hi all, Thanks to some downstream discussions in <a class=\"stream\" data-stream-id=\"513188\" href=\"/#narrow/channel/513188-CSLib\">#CSLib</a> I discovered that mathlib's <code>WriterT</code> uses a <code>Monoid</code> instance on its log type. I have made a PR to fix this to <code>AddMonoid</code>. Here is the PR : <a href=\"https://github.com/leanprover-community/mathlib4/pull/35578\">mathlib4#35578</a></p>\n<p>Arguments in favour of this change:</p>\n<ol>\n<li>This is the actual intended meaning of the Writer monad. Haskell uses <code>Monoid</code> because it makes no distinction between <code>AddMonoid</code> and <code>Monoid</code>. The writer monad is supposed to act like a log. So for instance it might be collecting a list of log-records, the natural writer monad operation is to concatenate to this list, not take element-wise pairs. It might be counting events, in which case the count needs to be increased additively.</li>\n<li>This change only affects one other file in mathlib, the <code>ContT</code> monad, which I have naturally fixed in the PR.</li>\n<li>It would be super useful in <a href=\"https://github.com/leanprover/cslib/pull/275\">cslib#275</a> to handle cost functions as well as replace the so-called <code>Time</code> monad which is just a writer monad in disguise.</li>\n</ol>",
        "id": 574990415,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771606926
    },
    {
        "content": "<p>CC : <span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span></p>",
        "id": 574990535,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771606958
    },
    {
        "content": "<p>I'd be very grateful if we could reach a fast consensus on this, since it would potentially help us kickstart formalizing algorithms in cslib soon.</p>",
        "id": 574992745,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771607673
    },
    {
        "content": "<p>Relatedly I wonder if we should remove the duplication for <code>EmptyCollection</code>/<code>Zero</code>, and force users who want to use <code>List X</code> as their log type to use <code>Free(Add)Monoid X</code> instead</p>",
        "id": 574996771,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771608997
    },
    {
        "content": "<blockquote>\n<p>the natural writer monad operation is to concatenate to this list, not take element-wise pairs</p>\n</blockquote>\n<p>Neither <code>*</code> nor <code>+</code> mean concatenate in Lean, so this argument doesn't seem to favor either <code>Monoid</code> or <code>AddMonoid</code>. Unless of course you use <code>Free(Add)Monoid</code>, and then both mean concatenate!</p>",
        "id": 574996950,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771609050
    },
    {
        "content": "<p>Yeah, but morally it is an addition operation. The choice of notation <code>++</code> is close enough</p>",
        "id": 574997128,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771609093
    },
    {
        "content": "<p>The best argument I can see to prefer <code>Monoid</code> is that the log concatenation is typically non-commutative, and in mathematics we prefer to use <code>*</code> instead of <code>+</code> when the operation is non-commutative.</p>",
        "id": 574997186,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771609111
    },
    {
        "content": "<p>Yes, but as I pointed out in the PR comment, we actually have a separate class for that <code>AddCommMonoid</code>, which indicates that non-commutative uses of <code>+</code> have already been anticipated</p>",
        "id": 574997329,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771609156
    },
    {
        "content": "<p>But I do see the appeal in using <code>+</code> for convenience for CSLib, and in the absence of any other users it seems harmless enough to change it.</p>",
        "id": 574997491,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771609217
    },
    {
        "content": "<p>A perhaps more conservative approach would be to define <code>AddWriterT</code> and use <code>to_additive</code> to manage the duplication</p>",
        "id": 575003506,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771611290
    },
    {
        "content": "<p>Given that writer is currently hardly  used anywhere is Mathlib, I think we should let the default writer be additive and create a MulWriter if necessary</p>",
        "id": 575010145,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771613811
    },
    {
        "content": "<p><a href=\"https://ncatlab.org/nlab/show/action+monad\">https://ncatlab.org/nlab/show/action+monad</a> uses multiplicative monoids in the first part and switches to additive notation in section 5 when discussing the \"logging-effect in computer science\".</p>",
        "id": 575010756,
        "sender_full_name": "Christian Merten",
        "timestamp": 1771614079
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/574990415\">said</a>:</p>\n<blockquote>\n<ol start=\"3\">\n<li>It would be super useful in <a href=\"https://github.com/leanprover/cslib/pull/275\">cslib#275</a> to handle cost functions as well as replace the so-called <code>Time</code> monad which is just a writer monad in disguise.</li>\n</ol>\n</blockquote>\n<p>I don't know the details about either monad, but can't CSLib do <code>TimeM := WriterT &lt;| Multiplicative ℕ</code>? (or <code>TimeM := WriterT &lt;| Multiplicative T</code> after Eric's latest change)</p>",
        "id": 575018037,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771617059
    },
    {
        "content": "<p>It’s tedious and and tbh writer monads have a default meaning in CS. They w is additive.</p>",
        "id": 575019640,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771617707
    },
    {
        "content": "<p>What, how is a single line more tedious than a monad definition from scratch?</p>",
        "id": 575020727,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771618235
    },
    {
        "content": "<p>Every monoid property or theorm has to be applied with toMultiplicative</p>",
        "id": 575021951,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771618794
    },
    {
        "content": "<p>And as I point out the moral definition is additive. The change is not huge. This monad is not even being used in mathlib beyond the Cont monad</p>",
        "id": 575022030,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771618825
    },
    {
        "content": "<p>I honestly don’t even see why this is controversial. Even  ncatlab prefers the name Action monad for the multiplicative version.</p>",
        "id": 575022173,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771618889
    },
    {
        "content": "<p>Even the documentation for this module refers to the Haskell definition and there the primary usage is definitely with additive operations.</p>",
        "id": 575022470,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771619010
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/575022173\">said</a>:</p>\n<blockquote>\n<p>I honestly don’t even see why this is controversial</p>\n</blockquote>\n<p>To be clear: I do not have an opinion on the Mathlib change, I suggested a way to unblock CSLib</p>",
        "id": 575030581,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1771622833
    },
    {
        "content": "<p>I think merging this PR soon would be a great help in simplifying CSLib. It seems to be practically a neglected leaf node as far as mathlib goes.</p>",
        "id": 575034916,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771625007
    },
    {
        "content": "<p>Why don't we just move the <code>WriterT</code> definition to CSLib altogether, and let them do with it what they want? To me the writer monad seems hardly useful when you can use a state monad instead.</p>",
        "id": 575045047,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771631600
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> : given the sparse API for writer I am inclined to take this option as a practical route but with a change: I’ll copy WriterT as AddWriterT into a CSLib for now.</p>",
        "id": 575045204,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771631754
    },
    {
        "content": "<p>Fwiw I think writerT should still be fixed here and StateT is <strong>not</strong> a replacement for WriterT. However I need to make progress faster than we can reach consensus here.</p>",
        "id": 575045517,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771632004
    },
    {
        "content": "<p>I view this \"port\" as a stopgap</p>",
        "id": 575045555,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771632028
    },
    {
        "content": "<blockquote>\n<p>I’ll copy WriterT as AddWriterT into a CSLib for now.</p>\n</blockquote>\n<p>I'd be inclined to keep it as TimeM until we need the generality</p>",
        "id": 575046648,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771632821
    },
    {
        "content": "<p>I am really keen to avoid the TimeM dependency. Anyway, an additive writer monad is essential CS material. We can have something in Cslib until mathlib's slow process catches up</p>",
        "id": 575046737,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771632895
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/575046737\">said</a>:</p>\n<blockquote>\n<p>Anyway, an additive writer monad is essential CS material</p>\n</blockquote>\n<p>According to haskell, only the <code>++</code>/<code>empty</code> version is CS material. I'm not sure where the \"CS is +, Math is *\" divide is coming from here.</p>",
        "id": 575046942,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1771633127
    },
    {
        "content": "<p>I am referring to this ncatlab entry on the action monad which Christian cited</p>",
        "id": 575047127,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771633316
    },
    {
        "content": "<p>That seems to be some pure math stuff</p>",
        "id": 575047136,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771633326
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/cslib/pull/360\">https://github.com/leanprover/cslib/pull/360</a></p>",
        "id": 575047151,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771633334
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/575010756\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://ncatlab.org/nlab/show/action+monad\">https://ncatlab.org/nlab/show/action+monad</a> uses multiplicative monoids in the first part and switches to additive notation in section 5 when discussing the \"logging-effect in computer science\".</p>\n</blockquote>\n<p>See this</p>",
        "id": 575048990,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771635048
    },
    {
        "content": "<p>Anyway this thread should continue to be about WriterT being multiplicative by default, and whether it should be additive by default or whether there's some other way to allow both <code>Monoid</code> and <code>AddMonoid</code> versions.</p>",
        "id": 575049089,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771635157
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/575003506\">said</a>:</p>\n<blockquote>\n<p>A perhaps more conservative approach would be to define <code>AddWriterT</code> and use <code>to_additive</code> to manage the duplication</p>\n</blockquote>\n<p>This seems to be the best solution to me.</p>",
        "id": 575049492,
        "sender_full_name": "Christian Merten",
        "timestamp": 1771635600
    },
    {
        "content": "<p>Just seeing this thread, thanks for linking from the CSLib PR, Eric. From the discussion above, the <code>to_additive</code> approach seems nice in providing either choice. Regarding this comment:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/575046737\">said</a>:</p>\n<blockquote>\n<p>We can have something in Cslib until mathlib's slow process catches up</p>\n</blockquote>\n<p>This feels a bit premature for a PR opened just today, and I don't want to leap to duplicating anything downstream. (I also think this could be communicated a bit more graciously)</p>",
        "id": 575049547,
        "sender_full_name": "Chris Henson",
        "timestamp": 1771635640
    },
    {
        "content": "<p>The discussion here could equally be described as <em>deliberate</em> (as opposed to slow). This is not about a week-long delay where this PR is completely unnoticed.</p>",
        "id": 575066540,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1771657066
    },
    {
        "content": "<p>Okay I accept that I have been hasty. Apologies. But I do think it helps to have some additive version of the writer monad while we discuss  mathlib’s API</p>",
        "id": 575079255,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771671641
    },
    {
        "content": "<p>Also <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> this is not just about the discussion here. A PR can take several weeks  to reach the first page of the review queue</p>",
        "id": 575079359,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771671755
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/575079359\">said</a>:</p>\n<blockquote>\n<p>Also <span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> this is not just about the discussion here. A PR can take several weeks  to reach the first page of the review queue</p>\n</blockquote>\n<p>I know (and agree that faster reviews would be great - the mathlib initiative has already made perceptable inroads to me). That said, a lot of this comes down to \"are there reviewers for this particular area\". It doesn't make sense for e.g. me to review deep category theory or <code>t-computability</code>. Complaining about slow reviews is easy (and still justified to some extent), changing this is harder :-)</p>",
        "id": 575079607,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1771671988
    },
    {
        "content": "<p>Also it is not as if CSLib is immune to this, we just have the luxury of smaller scale for the time being. The areas where I am truly comfortable reviewing are lambda calculi metatheory and metaprogramming. Anything else is me mainly addressing technical issues and pushes at the limits of both my competency and time constraints. I've gratefully accepted help from Eric and others in areas that are on the border between Mathlib and CSLib, and we will have our own growing pains of bootstrapping the expansion of CSLib reviewers/maintainers.</p>",
        "id": 575082042,
        "sender_full_name": "Chris Henson",
        "timestamp": 1771674684
    },
    {
        "content": "<p>Accepted. For what it’s worth, I found that the docstring linter is stricter in CSLib than mathlib. Is this  something that is expected?</p>",
        "id": 575099195,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771692021
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"466334\">Shreyas Srinivas</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Writer.20should.20use.20an.20additive.20monoid/near/575099195\">said</a>:</p>\n<blockquote>\n<p>Accepted. For what it’s worth, I found that the docstring linter is stricter in CSLib than mathlib. Is this  something that is expected?</p>\n</blockquote>\n<p>I don't have permission to move messages from here, but we should take discussion to the CSLib channel to keep on topic. But to answer your question, you mean the <code>docBlame</code>environment linter? We inherit this from batteries, so it should work the same.</p>",
        "id": 575102378,
        "sender_full_name": "Chris Henson",
        "timestamp": 1771695271
    },
    {
        "content": "<p>Maybe you are talking about the <code>set_option linter.missingDocs true</code> linter? This one is off in mathlib, and on in batteries. This is the syntax linter, not the environment linter. I wonder why there is this discrepancy between mathlib and batteries.</p>",
        "id": 575102904,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1771695908
    },
    {
        "content": "<p>No idea, but mathlib’s WriterT passes all linters clearly while in <a href=\"https://github.com/leanprover/cslib/pull/360\">cslib#360</a>, I had to add more docstrings. They are nearly identical.</p>",
        "id": 575103011,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771696034
    },
    {
        "content": "<p>What kind of linter errors did you get? Yellow squiggles as you were writing code, or errors when typing #lint/in the \"lint cslib\" step of CI? (If the later, it's an environment linter.)</p>",
        "id": 575103352,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1771696462
    },
    {
        "content": "<p>lake lint</p>",
        "id": 575103375,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771696489
    },
    {
        "content": "<p>And CI</p>",
        "id": 575103386,
        "sender_full_name": "Shreyas Srinivas",
        "timestamp": 1771696502
    },
    {
        "content": "<p><code>lake lint</code> AFAICT does <code>lake exe runLinter</code>, which runs environment linters.</p>",
        "id": 575103436,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1771696558
    },
    {
        "content": "<p>In CSLib we have <code>lintDriver = \"batteries/runLinter\"</code> in our lakefile, while in Mathlib <code>lake exe runLinter</code> is run in CI. Is there some difference?</p>",
        "id": 575106701,
        "sender_full_name": "Chris Henson",
        "timestamp": 1771699889
    },
    {
        "content": "<p>Oh, Mathlib's <code>scripts/nolints.json</code> has several <code>docBlame</code> exceptions for <code>WriterT</code>, pretty sure that's it.</p>",
        "id": 575106868,
        "sender_full_name": "Chris Henson",
        "timestamp": 1771700049
    }
]