[
    {
        "content": "<p>Try adding<br>\n<code>import Mathlib.Tactic.Linter.UpstreamableLinter</code> and <code>set_option linter.upstreamableDecl true</code> in <code>Mathlib.Algebra.Group.Equiv.Basic</code>.</p>\n<p>This incorrectly reports that </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">protected</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">congr_arg</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MulEquiv</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x'</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">DFunLike</span><span class=\"bp\">.</span><span class=\"n\">congr_arg</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>\n<p>can be moved up to <code>Mathlib.Data.FunLike.Basic</code>, despite <code>MulEquiv</code> only being defined in the current file.</p>\n<p>(<span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>, <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span>)</p>",
        "id": 483790949,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1732224186
    },
    {
        "content": "<p>I'll try to take a look tomorrow: my suspect is that <code>MulEquiv</code> is a structure and not a <code>def</code> and that may be confusing the linter.  But I'm not at a computer now.</p>",
        "id": 483796274,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732226374
    },
    {
        "content": "<p>My <code>dbg_trace</code> agrees with <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>: all the definitions in the current file this depends on are <code>structure</code>s and <code>instance</code>s, not <code>def</code>s.</p>",
        "id": 483796509,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1732226439
    },
    {
        "content": "<p>Still, shouldn't this theorem transitively depend on an <code>EquivLike</code> instance, whose type is not available in <code>Funlike.Basic</code>?</p>",
        "id": 483796633,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1732226487
    },
    {
        "content": "<p>The list of directly-depended on decls fir <code>congr_arg</code> is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">deps</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">Lean.Parser.Command.declId</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Term.attributes</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">congrArg</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Command.theorem</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Term.typeSpec</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Eq.rec</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"bp\">«</span><span class=\"n\">term_</span><span class=\"bp\">=</span><span class=\"n\">_</span><span class=\"bp\">»</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Command.declSig</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Term.implicitBinder</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Term.attrInstance</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Term.attrKind</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Command.declaration</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Termination.suffix</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">congr_arg</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Term.app</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">MulEquiv</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Eq.refl</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Command.declValSimple</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Command.protected</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Command.declModifiers</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Lean.Parser.Term.arrow</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">toAdditiveRest</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">to_additive</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"o\">,</span>\n<span class=\"w\"> </span><span class=\"n\">DFunLike.congr_arg</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 483796870,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1732226566
    },
    {
        "content": "<p>It would probably be useful to expand the API a bit to have that trace split into <code>def</code>s <code>theorem</code>s,... and the <code>syntax</code>, <code>tactic</code>s (not exactly sure how granular to make it).</p>",
        "id": 483797193,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732226701
    },
    {
        "content": "<p>I may have time for this tomorrow, though I'm not sure.</p>",
        "id": 483797275,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732226740
    },
    {
        "content": "<p>Actually, picking some other declarations in that file at random, it seems like quite a few instances are missing. For example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MulEquivClass.map_mul#doc\">docs#MulEquivClass.map_mul</a> doesn't report any instances except <code>instHMul</code>...</p>",
        "id": 483797444,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1732226797
    },
    {
        "content": "<p>Fix for the originally reported issue, where declarations depending on structures like <code>MulEquiv</code> shouldn't get warnings: <a href=\"https://github.com/leanprover-community/mathlib4/pull/19360\">#19360</a>.</p>",
        "id": 483879474,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1732270932
    }
]