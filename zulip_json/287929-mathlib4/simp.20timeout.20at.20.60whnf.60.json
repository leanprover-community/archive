[
    {
        "content": "<p>I have the following simplified code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">injective_unit_pow</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">is_prime</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Units</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Function</span><span class=\"bp\">.</span><span class=\"n\">Injective</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"bp\">¬∑</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">p_order</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">orderOf_eq_card_powers</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">p_order</span>\n</code></pre></div>\n<p>Lean works several seconds on <code>simp</code>, then aborts with this error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">simp'</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">nested</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span>\n<span class=\"o\">(</span><span class=\"n\">deterministic</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">timeout</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"ss\">`whnf</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">number</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">200000</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"n\">num</span><span class=\"bp\">&gt;`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">limit</span><span class=\"bp\">.</span>\n<span class=\"n\">Additional</span><span class=\"w\"> </span><span class=\"n\">diagnostic</span><span class=\"w\"> </span><span class=\"n\">information</span><span class=\"w\"> </span><span class=\"n\">may</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">available</span><span class=\"w\"> </span><span class=\"kn\">using</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 494502783,
        "sender_full_name": "thielema",
        "timestamp": 1737194529
    },
    {
        "content": "<p>Have you tried the suggestion <code>set_option diagnostics true</code> that is shown in the error message yet? What does it say?</p>",
        "id": 494506170,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1737197203
    },
    {
        "content": "<p>If I open this code in the web editor there's no problem with it (other than the fact that the lemma is false); there's no timeout. So maybe update your mathlib? You don't need <code>import Lean</code> by the way, you're not doing metaprogramming here.</p>",
        "id": 494649381,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1737299256
    },
    {
        "content": "<p>It happened in Lean-4.14. Seems to have gone in 4.15.</p>",
        "id": 494650347,
        "sender_full_name": "thielema",
        "timestamp": 1737299941
    },
    {
        "content": "<p>Here is a similar occurrence:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"n\">natDegree</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">c'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">aeval</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c'</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>times out (and <code>set_option diagnostics true</code> does not seem to give helpful output), but replacing the import by</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">AlgebraMap</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n</code></pre></div>\n<p>makes it work. Adding <code>import Mathlib.Tactic</code> to that makes it time out again. Let me try to find the culprit...</p>",
        "id": 516747386,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746644389
    },
    {
        "content": "<p>Here is the minimized version:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">AlgebraMap</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"c1\">-- from Mathlib.Algebra.Polynomial.GroupRingAction:</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Monoid</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Semiring</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"c1\">-- remove the attribute to avoid the time out below</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">smul_X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">--</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>So it seems that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.smul_X#doc\">docs#Polynomial.smul_X</a> is a bad <code>simp</code> lemma?<br>\n(Without the <code>simp</code> attribute on that result, <code>simp</code> makes no progress here because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.smul_eq_C_mul#doc\">docs#Polynomial.smul_eq_C_mul</a> is not a <code>simp</code> lemma.)</p>\n<p>Or maybe the problem is that lean goes on a wild goose chase to see whether <code>c ‚Ä¢ X</code> can come from a <code>MulSemiringAction</code>?</p>",
        "id": 516753324,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746646732
    },
    {
        "content": "<p><code>simp only [smul_X]</code> already times out; there seems to be an infinite loop...</p>",
        "id": 516754453,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746647130
    },
    {
        "content": "<p>The typeclass synth trace shows lots of</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Meta.synthInstance] ‚ùåÔ∏è MulSemiringAction ‚ÑÇ ‚ÑÇ ‚ñ∂\n</code></pre></div>",
        "id": 516754716,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746647229
    },
    {
        "content": "<p>The first two expanded:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Meta.synthInstance] ‚ùåÔ∏è MulSemiringAction ‚ÑÇ ‚ÑÇ ‚ñº\n  [] no instances for MulSemiringAction ‚ÑÇ ‚ÑÇ ‚ñº\n    [instances] #[]\n  [] result &lt;not-available&gt;\n[Meta.synthInstance] ‚ùåÔ∏è MulSemiringAction ‚ÑÇ ‚ÑÇ ‚ñº\n  [] result &lt;not-available&gt; (cached)\n</code></pre></div>\n<p>(the following ones are like the second one).</p>",
        "id": 516755202,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746647406
    },
    {
        "content": "<p><code>set_option trace.Meta.Tactic.simp.all true</code> does not show anything. Is there a way to get trace output for what <code>simp</code> does here?</p>",
        "id": 516755606,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746647559
    },
    {
        "content": "<p>(I have to <span aria-label=\"in bed\" class=\"emoji emoji-1f6cc\" role=\"img\" title=\"in bed\">:in_bed:</span> <span aria-label=\"zzz\" class=\"emoji emoji-1f4a4\" role=\"img\" title=\"zzz\">:zzz:</span> now, but maybe somebody can take the investigation up from here...)</p>",
        "id": 516755886,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746647658
    },
    {
        "content": "<p><code>MulSemiringAction ‚ÑÇ ‚ÑÇ</code> is failing quickly, I don't think that's the issue. I am not often faced with debugging <code>simp</code> issues. The questions at this point are:<br>\n1) why does this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Polynomial</span><span class=\"bp\">.</span><span class=\"n\">GroupRingAction</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">smul_X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- why does this time out?</span>\n</code></pre></div>\n<p>time out? and (2) what debugging options are available for answering this kind of question?</p>\n<p>aah, it's not even a simp issue:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">smul_X</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>times out.</p>\n<p>Oh, answer to (2): even though things are timing out, stuff like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n</code></pre></div>\n<p>works fine.</p>",
        "id": 516761518,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746650012
    },
    {
        "content": "<p>So here's an interesting trace:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">                  </span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.259843</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                    </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.259617</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                      </span><span class=\"o\">[</span><span class=\"n\">delta</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.259594</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">instHSMul</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                        </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.259541</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">SMulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                          </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.259469</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">SMulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">SMulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                            </span><span class=\"o\">[</span><span class=\"n\">delta</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.259457</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">SMulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">SMulZeroClass</span><span class=\"bp\">.</span><span class=\"n\">toSMul</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                              </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">7.259431</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">smulZeroClass</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">smulZeroClass</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000024</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000007</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000003</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000002</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000002</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000002</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000002</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000002</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000029</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>0.000002 seconds is tiny, it's not the reason it's slow, but I'm beginning to understand why Lean keeps asking this question hundreds of times. Let's look at the exploding typeclass instance search which is taking 7 seconds to give up. If you switch implicits on with <code>pp.explicit true</code> then there are holes in the right hand side terms in that exploding search. For example<br>\n<code>[delta] [7.259594] üí•Ô∏è instHSMul =?= instHSMul ‚ñº</code> expands to</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>                      [delta] [7.658977] üí•Ô∏è @instHSMul Complex (@Polynomial Complex Complex.instSemiring)\n                            (@Algebra.toSMul Complex (@Polynomial Complex Complex.instSemiring) Complex.instCommSemiring\n                              (@semiring Complex Complex.instSemiring)\n                              (@algebraOfAlgebra Complex Complex Complex.instCommSemiring Complex.instSemiring\n                                (@Algebra.id Complex\n                                  Complex.instCommSemiring))) =?= @instHSMul Complex\n                            (@Polynomial Complex Complex.instSemiring)\n                            (@SMulZeroClass.toSMul Complex (@Polynomial Complex Complex.instSemiring)\n                              (@zero Complex Complex.instSemiring)\n                              (@smulZeroClass Complex Complex.instSemiring Complex\n                                (@DistribSMul.toSMulZeroClass Complex Complex\n                                  (@AddMonoid.toAddZeroClass Complex\n                                    (@AddMonoidWithOne.toAddMonoid Complex\n                                      (@AddCommMonoidWithOne.toAddMonoidWithOne Complex\n                                        (@NonAssocSemiring.toAddCommMonoidWithOne Complex\n                                          (@Semiring.toNonAssocSemiring Complex Complex.instSemiring)))))\n                                  (@DistribMulAction.toDistribSMul Complex Complex ?m.230\n                                    (@AddMonoidWithOne.toAddMonoid Complex\n                                      (@AddCommMonoidWithOne.toAddMonoidWithOne Complex\n                                        (@NonAssocSemiring.toAddCommMonoidWithOne Complex\n                                          (@Semiring.toNonAssocSemiring Complex Complex.instSemiring))))\n                                    (@MulSemiringAction.toDistribMulAction Complex Complex ?m.230 Complex.instSemiring\n                                      ?m.233)))))\n</code></pre></div>\n<p>and the right hand side of that term has two metavariables in. Here <code>?m.230 : Monoid Complex</code> (which is in mathlib) and <code>?m.233 : @MulSemiringAction Complex Complex ?m.230 Complex.instSemiring</code> a.k.a. <code>MulSemiringAction ‚ÑÇ ‚ÑÇ</code>. </p>\n<p>But note that there is no instance of <code>MulSemiringAction ‚ÑÇ ‚ÑÇ</code> in mathlib, the natural action of the complexes on itself doesn't satisfy the <code>MulSemiringAction</code> axiom. </p>\n<p>So in fact what's happening is that with this line <code>[] [7.567531] üí•Ô∏è instHSMul =?= instHSMul</code>, Lean is trying to prove that two instances of <code>HSMul ‚ÑÇ ‚ÑÇ[X] ‚ÑÇ[X]</code> are equal. The first is an instance which actually exists: it's coming from <code>Algebra ‚ÑÇ ‚ÑÇ[X]</code> which itself comes from <code>algebraOfAlgebra [Algebra R A] : Algebra R A[X]</code>.</p>\n<p>But the second is an instance which does not exist. It's coming from <code>smulZeroClass [SMulZeroClass S R] ‚Üí SMulZeroClass S R[X]</code> which reduces us to <code>SMulZeroClass ‚ÑÇ ‚ÑÇ</code>, which <em>does</em> exist, but for some reason Lean tries to find it via <code>MulSemiringAction ‚ÑÇ ‚ÑÇ</code> which does not exist. </p>\n<p>After trying to do this for a bit, Lean suddenly realises it needs this <code>MulSemiringAction ‚ÑÇ ‚ÑÇ</code>, fails to find it, and then makes the hideous mistake of deciding that perhaps the best way to work on <code>smulZeroClass =?= smulZeroClass</code> (which is where it had got up to; these are both instances of <code>SMulZeroClass ‚ÑÇ ‚ÑÇ[X]</code>) is to unfold it (despite the fact that the RHS has still got this <code>?m.233 : MulSemiringAction ‚ÑÇ ‚ÑÇ</code> term in it). So it's now faced with</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>                                [] [7.465669] üí•Ô∏è { smul := fun r p ‚Ü¶ { toFinsupp := r ‚Ä¢ p.toFinsupp },\n                                      smul_zero :=\n                                        ‚ãØ } =?= { smul := fun r p ‚Ü¶ { toFinsupp := r ‚Ä¢ p.toFinsupp }, smul_zero := ‚ãØ } ‚ñ∂\n</code></pre></div>\n<p>(with <code>?m.223</code> now deeply embedded in the RHS) and now the whole thing explodes into finsupps and decidability, all doomed to failure because <code>?m.233</code> will never be synthesized. The first bifurcation is</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>                                          [delta] [4.865229] ‚ùåÔ∏è r ‚Ä¢ p.toFinsupp =?= r ‚Ä¢ p.toFinsupp ‚ñ∂\n                                          [] [2.695273] üí•Ô∏è instHSMul.1 r p.toFinsupp =?= instHSMul.1 r p.toFinsupp ‚ñ∂\n</code></pre></div>\n<p>but nothing can ever work because the RHSs all have this unassigned <code>?m.233 : MulSemiringAction ‚ÑÇ ‚ÑÇ</code>. Every now and then Lean remembers it and you get a superfast burst of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">                                                      </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000004</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                                      </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000005</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"w\">                                                      </span><span class=\"o\">[</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.000003</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚ùåÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MulSemiringAction</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>20 or so times, and then it goes back to unfolding.</p>",
        "id": 516769960,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746653834
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"mi\">800000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">smul_X</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"c1\">-- tactic 'rewrite' failed, did not find instance of the pattern in the target expression</span>\n</code></pre></div>",
        "id": 516770793,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746654222
    },
    {
        "content": "<p>This is a relatively common problem in unification of type classes in the presence of metavariables. The unification algorithm tries to unify the same expressions in different ways (e.g. unify the arguments directly, or first unfold the head constant and then unify the arguments), but because there is a metavariable, doesn't do enough caching. This causes unification to be exponentially slow. Usually this is not a problem, but only if the hierarchy of definitions becomes too large, the exponential slowness become noticeable.</p>\n<p>In this particular case, it can be sped up by 50x with <code>seal Finsupp.mapRange</code>. This constant appears in the instance <code>AddMonoidAlgebra.smulZeroClass</code></p>",
        "id": 517077307,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746785972
    },
    {
        "content": "<p>How did you find this fix <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> ? I can confirm that it makes the rewrite fail much more quickly (just to be clear, the rewrite should fail because the lemma is not applicable, the conclusion of the lemma is <code>c ‚Ä¢ X = X</code> because the hypotheses of the lemma imply <code>c ‚Ä¢ 1 = 1</code>, whereas in this situation <code>c ‚Ä¢ X = c * X</code>; the correct lemma to be rewriting with is <code>smul_eq_C_mul</code>.)</p>",
        "id": 517100314,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746793976
    },
    {
        "content": "<p>To see what the unification does, use <code>set_option trace.Meta.isDefEq true</code>.</p>\n<p>To also see the time of each node, use <code>set_option trace.profiler true</code> and <code>set_option trace.profiler.threshhold 10000000</code>. This turns on the profiler without actually adding more nodes to the trace.</p>\n<p>Then you can keep clicking on the nodes that take the most time, and observe the exponential blowup, and at some point we get to the constant Finsupp.mapRange.</p>",
        "id": 517103581,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746794974
    },
    {
        "content": "<p><del><code>smul_X (R := ‚ÑÇ[X])</code></del> D'oh, I had <code>R</code> and <code>M</code> switched and this doesn't help<br>\n<code>simp only [smul_X (R := ‚ÑÇ) (M := ‚ÑÇ)]</code> should be right</p>",
        "id": 517107637,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746796121
    },
    {
        "content": "<p>Elaboration tends to have a lot of trouble with polynomials</p>",
        "id": 517107701,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746796143
    },
    {
        "content": "<p>It shouldn't be right because the lemma doesn't apply</p>",
        "id": 517119545,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746799454
    },
    {
        "content": "<p>Right as in the type of the expression is correct, not as in it applies</p>",
        "id": 517120021,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746799573
    },
    {
        "content": "<p>Lean can't figure out which <code>?R</code> we want when invoking <code>(X : ?R[X])</code>. Ideally it could.</p>",
        "id": 517120325,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746799655
    },
    {
        "content": "<p>No, the problem is the isntance that it can't find (and doesn't exist)</p>",
        "id": 517123840,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746800654
    },
    {
        "content": "<p>That is where the metavariables come from which leads to the crazy searches</p>",
        "id": 517124189,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746800754
    },
    {
        "content": "<p>I wouldn't call it a search (like type class search). Instead it is exponentially slow unification.</p>",
        "id": 517124552,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746800840
    },
    {
        "content": "<p>Fair, I was thinking of searching for the value to instantiate the metavariable</p>",
        "id": 517124808,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746800896
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Algebra.Polynomial.GroupRingAction</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Data.Complex.Basic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n\n<span class=\"kd\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">‚Ä¢</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">[</span><span class=\"n\">X</span><span class=\"o\">]))</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- simp only [smul_X c] -- why does this time out?</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">smul_X</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)]</span><span class=\"w\"> </span><span class=\"c1\">-- this doesn't time out and fails quickly</span>\n</code></pre></div>\n<p>Generally if you throw very unconstrained metavariables into the machine, then you are going to have a bad time</p>",
        "id": 517125687,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746801117
    },
    {
        "content": "<p>Another example is the declaration <code>foo</code> itself where you need to provide an explicit type ascription</p>",
        "id": 517125991,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746801206
    },
    {
        "content": "<p>Also, I would not have thought that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Polynomial.smul_X#doc\">docs#Polynomial.smul_X</a> had the type it does if I was just guessing from the name</p>",
        "id": 517126569,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746801384
    },
    {
        "content": "<p>Of course the problem is that <code>smul_X</code> is a simp lemma so typically we don't have the option to supply the type hints.</p>",
        "id": 517128513,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1746801933
    },
    {
        "content": "<p>There are <code>unif_hint</code>'s</p>",
        "id": 517129992,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746802299
    },
    {
        "content": "<p>No idea about their utility here at the moment</p>",
        "id": 517130141,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1746802336
    },
    {
        "content": "<p>Thanks everybody for investigating!</p>\n<p>I don't think having to (remember to) write <code>seal Finsupp.mapRange</code> before a <code>simp</code> call is a viable option. So I'm wondering if there is a way to avoid the problem (without doing much harm elsewhere).</p>",
        "id": 517138474,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746804739
    },
    {
        "content": "<p>The easiest is to disable the simp lemma with <code>simp [-smul_X]</code></p>",
        "id": 517163156,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746813685
    },
    {
        "content": "<p>But this only helps if you realize that in the specific situation this specific lemma might cause a problem. (In particular you'd need to remember its name.)</p>",
        "id": 517165744,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746814727
    },
    {
        "content": "<p>Yeah, I agree it's not a great solution, but besides unsimping the lemma, there is no obvious way to fix the situation. And you'll notice something is wrong if <code>simp</code> takes 40 seconds ;).</p>",
        "id": 517166340,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1746814977
    },
    {
        "content": "<p>Can we speed things up by extracting the <code>support</code> of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finsupp.mapRange#doc\">docs#Finsupp.mapRange</a> into a sealed definition?</p>",
        "id": 518404806,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747345068
    },
    {
        "content": "<p>And in fact, probably the support of all Finsupp arithmetic</p>",
        "id": 518404963,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747345148
    },
    {
        "content": "<p>The defeq of the function is important, but the defeq of the support is classical and irrelevant</p>",
        "id": 518405031,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747345191
    },
    {
        "content": "<p>Attempted in <a href=\"https://github.com/leanprover-community/mathlib4/pull/24944\">#24944</a></p>",
        "id": 518407748,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747346514
    },
    {
        "content": "<p><code>Mathlib.Algebra.Category.ModuleCat.Presheaf.Free</code> becomes 4x faster!</p>",
        "id": 518417938,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747352626
    },
    {
        "content": "<p><a href=\"#narrow/channel/287929-mathlib4/topic/simp.20timeout.20at.20.60whnf.60/near/516747386\">The example above</a> takes 48615 heartbeats on that PR vs 590152 at its diffbase.</p>\n<p>Still not fast, but much better. Only 17743 with <code>seal Finsupp.mapRange</code>, but that isn't safe to apply globally.</p>",
        "id": 518419732,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747353622
    },
    {
        "content": "<p>Are there more functions that could use a similar refactor with <code>irreducible_def</code>?</p>",
        "id": 518499592,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1747388645
    },
    {
        "content": "<p>I think tensor products? But the refactor will probably be tricky. And I don't really know what I'm talking about, just that you <em>never</em> want to unfold the definition of a tensor product.</p>",
        "id": 518499911,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1747388742
    },
    {
        "content": "<p>There is <a href=\"https://github.com/leanprover-community/mathlib4/pull/24752\">#24752</a> that looks at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Real.sqrt#doc\">docs#Real.sqrt</a> . (Prompted by its use in the definition of the norm on complex numbers.)</p>",
        "id": 518500603,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1747388933
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/simp.20timeout.20at.20.60whnf.60/near/518499911\">said</a>:</p>\n<blockquote>\n<p>I think tensor products? But the refactor will probably be tricky. And I don't really know what I'm talking about, just that you <em>never</em> want to unfold the definition of a tensor product.</p>\n</blockquote>\n<p>But I really like having the defeq <code>lift f (mk x y) = f x y</code> :(. I don't think we can keep that if we make other things irreducible, though I'd be happy to be proven wrong.</p>",
        "id": 518504894,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747390186
    },
    {
        "content": "<p>I took a run at making <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=TensorProduct#doc\">docs#TensorProduct</a> <code>irreducible</code> and then at using at <code>irreducible_def</code> somewhere I think... The former helped some. I suspect the later would help more but my main conclusion is that more tooling is needed around <code>irreducible_def</code> before we deploy it in more sustained fashion.</p>",
        "id": 518528821,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1747397611
    },
    {
        "content": "<p>I took a look at <a href=\"https://github.com/leanprover-community/mathlib4/pull/24944\">#24944</a> and I think the original sin for the performance regression is <a href=\"mailto:docs@ModuleCat.free\">docs@ModuleCat.free</a> specifically <code>free R-module with generators x : X, implemented as the type X ‚Üí‚ÇÄ R</code></p>",
        "id": 520073940,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1748012523
    },
    {
        "content": "<ul>\n<li>This seems common elsewhere too when one needs an implementation of a free module. Should there be some abstraction boundary? </li>\n<li>I would like more transparency into the kernel. What is the SOTA? Can I run lean4lean as a proxy? </li>\n<li>Even with the above, I am ok merging <a href=\"https://github.com/leanprover-community/mathlib4/pull/24944\">#24944</a> and will do so unless waived off.</li>\n</ul>",
        "id": 520076662,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1748013313
    }
]