[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"651332\">@Sven Manthe</span> reported the following to me:<br>\nThe <code>count_heartbeats</code> command seems to increase Lean's CPU usage when editing the proof until you restart the file.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">CountHeartbeats</span>\n\n<span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- type some junk in the next line to increase Lean's CPU usage until you restart the file</span>\n<span class=\"w\">  </span><span class=\"c1\">--</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 463398309,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1724072347
    },
    {
        "content": "<p>Does this have anything to do with incremental compilation being enabled?</p>",
        "id": 463399675,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724072758
    },
    {
        "content": "<p>Maybe. Is there an option to turn it off?</p>",
        "id": 463401359,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1724073300
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/count_heartbeats.20CPU.20usage/near/463399675\">said</a>:</p>\n<blockquote>\n<p>Does this have anything to do with incremental compilation being enabled?</p>\n</blockquote>\n<p>Probably: I often realized this recently (in non-minimalized situations), but never before incremental proofs were introduced</p>",
        "id": 463406154,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724074676
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/count_heartbeats.20CPU.20usage/near/463401359\">said</a>:</p>\n<blockquote>\n<p>Maybe. Is there an option to turn it off?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span></p>",
        "id": 463408336,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1724075146
    },
    {
        "content": "<p>It shouldn't directly be relevant, <code>count_heartbeats</code> does not opt into incrementality. But also I can't reproduce, CPU quickly subsides after typing on that line</p>",
        "id": 463422539,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724078294
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/count_heartbeats.20CPU.20usage/near/463399675\">said</a>:</p>\n<blockquote>\n<p>Does this have anything to do with incremental compilation being enabled?</p>\n</blockquote>\n<p>It seems not, this also blows up CPU usage for me:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Util</span><span class=\"bp\">.</span><span class=\"n\">CountHeartbeats</span>\n\n<span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"c1\">-- type some junk in the next line to increase Lean's CPU usage until you restart the file</span>\n<span class=\"w\">  </span><span class=\"c1\">--</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 463439574,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1724082353
    },
    {
        "content": "<p>Sven, can you remind me: are you on Windows as well? Given that Sebastian cannot reproduce it, it would be good to see if it reproduces on all OSes, or whether it is a Windows-only issue.</p>",
        "id": 463440093,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1724082433
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/287929-mathlib4/topic/count_heartbeats.20CPU.20usage/near/463440093\">said</a>:</p>\n<blockquote>\n<p>Sven, can you remind me: are you on Windows as well? Given that Sebastian cannot reproduce it, it would be good to see if it reproduces on all OSes, or whether it is a Windows-only issue.</p>\n</blockquote>\n<p>No, I don't use Windows. More precisely, my VS Code \"About\" outputs:<br>\nVersion: 1.74.3<br>\nCommit: 97dec172d3256f8ca4bfb2143f3f76b503ca0534<br>\nDate: 2023-01-13T15:24:47.250Z<br>\nElectron: 19.1.8<br>\nChromium: 102.0.5005.167<br>\nNode.js: 16.14.2<br>\nV8: 10.2.154.15-electron.0<br>\nOS: Linux x64 5.15.0-118-generic<br>\nSandboxed: No</p>",
        "id": 463443839,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724083114
    },
    {
        "content": "<p>Could this be related to the VSCode version?</p>\n<p>I observed a while ago that in some cases threads were continuing to run using 100% of a core after editing in a file (e.g., in docstrings), and this was building up over time so that my laptop became sluggish (and hot). (\"Restart file\" helped in this situation.) This behavior began after a new version of VSCode was installed (Linux, in my case) and ended a couple of VSCode versions later.</p>",
        "id": 463443887,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1724083123
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/stream/287929-mathlib4/topic/count_heartbeats.20CPU.20usage/near/463443887\">said</a>:</p>\n<blockquote>\n<p>This behavior began after a new version of VSCode was installed (Linux, in my case) and ended a couple of VSCode versions later.</p>\n</blockquote>\n<p>What is your current version (then I could try whether updating fixes this for me)?</p>",
        "id": 463444316,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724083230
    },
    {
        "content": "<p>My VSCode version is 1.92.2; so this may be unrelated.</p>",
        "id": 463444330,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1724083232
    },
    {
        "content": "<p>It could perhaps be some interaction between the VSCode version and the version of the language server.</p>",
        "id": 463444507,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1724083278
    },
    {
        "content": "<p>I just installed a more recent version of VS Code (1.92.1) from another package manager (both of them seem to be inofficial; I didn't check details) and can't reproduce it with this one</p>",
        "id": 463447041,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724083743
    },
    {
        "content": "<p>Some new observations: I could reproduce the issue of increasing CPU usage while editing a proof in a file not containing count_heartbeats. A visible effect that sometimes occurs is that the yellow markers of incremental proofs reset to the beginning of the proof or file at the moment when the CPU usage increases. In contrast to the count_heartbeats problem, this also occurred in the recent version of VS Code. Creating a MWE would be much effort, but if anyone is interested, I can provide non-minimized code that reproduces the issue</p>",
        "id": 464359529,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724329892
    },
    {
        "content": "<p>That would be great, I am definitely interested</p>",
        "id": 464361017,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724330393
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/287929-mathlib4/topic/count_heartbeats.20CPU.20usage/near/464361017\">said</a>:</p>\n<blockquote>\n<p>That would be great, I am definitely interested</p>\n</blockquote>\n<p>I invited you to the corresponding gitlab repository and created a separate branch for this issue (the relevant file is mwe3.lean. This file reproduced this issue several times, although I cannot give a precise sequence of steps required for this. I put more details in a comment close to the end of the file)</p>",
        "id": 464391037,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724336382
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"651332\">@Sven Manthe</span> This doesn't look to be connected to incrementality. Note that when CPU usage spikes despite the orange bar being gone, the header of the info view turns yellow, meaning the time is spent in rendering (at least in this case) the goal, which seems to be very expensive between the <code>conv</code> and <code>dsimp</code> (the <code>dsimp</code> itself seems to be expensive too, just less so, which is probably connected). The odd thing is that this is happening in pretty printing code activated by <code>pp.beta</code>, but I don't see that option being set anywhere. If you could file an issue with public code, that would be great.</p>",
        "id": 464845093,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724505014
    },
    {
        "content": "<p>Thank you for having a look, and it's good to know that these problems are not related with the other one. The <code>dsimp</code> being slow can be fixed by adding <code>generalize_proofs</code> before and may be related to <a href=\"https://github.com/leanprover/lean4/issues/5108\">https://github.com/leanprover/lean4/issues/5108</a>. (There are also other things happening that may be worth reporting in this project. E.g., linting a single theorem needs &gt;20s.) If that helps, I could publish all the code together with some description of the issues (and I would definitely be happy if some of the performance issues in this project could be fixed on the language/library level), but currently I don't want to create MWEs for issues.</p>",
        "id": 464880662,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724522438
    },
    {
        "content": "<p>Ah, I did not make the connection to that issue. Indeed both seems to be bottlenecked on proof term size. Does this description I added to the issue describe your example as well (I didn't look closely)?</p>\n<blockquote>\n<p>filling in proof <em>arguments</em> of functions like <code>help</code> with expensive (big proof-producing) tactics like <code>omega</code>.</p>\n</blockquote>",
        "id": 464970913,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724578307
    },
    {
        "content": "<p>Yes. To avoid XY-problems, let me give an unnecessarily detailed description of my situation.<br>\nIn this project, I did not follow the mathlib convention of using unbundled types and \"junk\" values. For example, I defined a type <code>Strategy</code> not as roughly <code>List A -&gt; A</code>, but as <code>(x : List A) -&gt; P x -&gt; {a : A | Q x a}</code> for predicates P, Q. This leads to many propositional arguments to functions. Later in the project I used terms like <code>by omega</code> to fill these arguments, leading to the described performance issues. (Also, the simplifier struggles to work with these kinds of definitions, but this can mostly be fixed by adding manual <code>congr</code>-lemmas and <code>no_index</code> annotations.)<br>\nNa√Øvely, the following might be a quite general metaprogramming solution to all my performance issues and also to <a href=\"https://github.com/leanprover/lean4/issues/5108\">https://github.com/leanprover/lean4/issues/5108</a>: Whenever a term of a <code>Prop</code> is generated with <code>by \"tactics\"</code> as a subterm of a term T, create a new opaque auxiliary definition of the required type and use this definition instead in T. It seems preferable to e.g. tweaking <code>omega</code> to not reuse these proof terms in the issue etc. (Of course, without knowledge of the system or metaprogramming, I don't know how feasible this would be to implement. In some sense it would implement your suggested solution not to use expensive tactics outside of opaque proofs, but would shift the burden from the end user to a metaprogram; at least in my project it becomes infeasible to extract all those proof terms by hand since the statements are much shorter than the proof terms but much longer than the tactic sequences.)</p>",
        "id": 465000538,
        "sender_full_name": "Sven Manthe",
        "timestamp": 1724586913
    },
    {
        "content": "<p>Indeed, a tactic based on <code>Lean.Meta.abstractNestedProofs</code> may do the trick</p>",
        "id": 465012062,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1724592614
    }
]