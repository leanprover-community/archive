[
    {
        "content": "<p>Should <code>apply?</code> get this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">def</span> <span class=\"n\">re</span> <span class=\"o\">(</span><span class=\"n\">n</span> <span class=\"n\">m</span> <span class=\"o\">:</span> <span class=\"n\">‚Ñï</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span> <span class=\"o\">:=</span> <span class=\"n\">n</span> <span class=\"bp\">=</span> <span class=\"n\">m</span>\n\n<span class=\"kd\">instance</span> <span class=\"n\">reSetoid</span> <span class=\"o\">:</span> <span class=\"n\">Setoid</span> <span class=\"n\">‚Ñï</span> <span class=\"n\">where</span>\n  <span class=\"n\">r</span>     <span class=\"o\">:=</span> <span class=\"n\">re</span>\n  <span class=\"n\">iseqv</span> <span class=\"o\">:=</span> <span class=\"o\">‚ü®</span><span class=\"n\">Eq.refl</span><span class=\"o\">,</span> <span class=\"n\">Eq.symm</span><span class=\"o\">,</span> <span class=\"n\">Eq.trans</span><span class=\"o\">‚ü©</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:</span> <span class=\"n\">‚Ñï</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">Quotient.mk'</span> <span class=\"n\">a</span> <span class=\"bp\">=</span> <span class=\"n\">Quotient.mk'</span> <span class=\"n\">b</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">re</span> <span class=\"n\">a</span> <span class=\"n\">b</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">apply</span><span class=\"bp\">?</span>\n</code></pre></div>\n<p><code>Quotient.exact h</code> works.</p>",
        "id": 401639397,
        "sender_full_name": "Nir Paz",
        "timestamp": 1699822210
    },
    {
        "content": "<p>No, because <code>apply?</code> isn't allowed to look at how you defined <code>re</code></p>",
        "id": 401648994,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1699832595
    },
    {
        "content": "<p>If you replace it with <code>abbrev re</code> instead of <code>def re</code>, which <code>apply?</code> is allowed to look through, then it works</p>",
        "id": 401649009,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1699832630
    },
    {
        "content": "<p>What about this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">(</span><span class=\"n\">P</span> <span class=\"n\">Q</span> <span class=\"o\">:</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">P</span> <span class=\"bp\">‚Üí</span> <span class=\"n\">Q</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h'</span> <span class=\"o\">:</span> <span class=\"bp\">¬¨</span><span class=\"n\">Q</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"bp\">¬¨</span><span class=\"n\">P</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">exact</span><span class=\"bp\">?</span>\n</code></pre></div>",
        "id": 402534407,
        "sender_full_name": "Nir Paz",
        "timestamp": 1700160619
    },
    {
        "content": "<p>I think this is simply not stated in Mathlib.</p>",
        "id": 402535856,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1700161156
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=mt#doc\">docs#mt</a> I thought</p>",
        "id": 402535900,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1700161173
    },
    {
        "content": "<p>But I thought this may be the performance optimisation stuff</p>",
        "id": 402535986,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1700161199
    },
    {
        "content": "<p>Eric is right and I was wrong.</p>",
        "id": 402536070,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1700161210
    },
    {
        "content": "<p>Eric, Patrick, and I were all wrong. In fact it was a bug (one of the horsemen!) fixed now in <a href=\"https://github.com/leanprover/std4/pull/368\">std4#368</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/8458\">#8458</a>.</p>",
        "id": 402596458,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1700186331
    },
    {
        "content": "<p>Cool! Is there a rule of thumb for when it's ok for apply to not find a single-theorem-solution, like due to \"optimization stuff\"?</p>",
        "id": 402610913,
        "sender_full_name": "Nir Paz",
        "timestamp": 1700194027
    },
    {
        "content": "<p>Because I always think of that as a problem and I guess sometimes it's not</p>",
        "id": 402611020,
        "sender_full_name": "Nir Paz",
        "timestamp": 1700194093
    },
    {
        "content": "<p>(Excluding things like my first example with <code>def</code>s)</p>",
        "id": 402611084,
        "sender_full_name": "Nir Paz",
        "timestamp": 1700194173
    },
    {
        "content": "<p>As far as I know, after <a href=\"https://github.com/leanprover-community/mathlib4/pull/8458\">#8458</a> and <a href=\"https://github.com/leanprover-community/mathlib4/pull/8459\">#8459</a> land, I think the claim is:</p>\n<blockquote>\n<p>if you can prove a goal via <code>apply X; solve_by_elim*</code> for some <code>X</code>, then <code>exact?</code> should work</p>\n</blockquote>\n<p>and </p>\n<blockquote>\n<p>if you can prove a collection of goals via <code>apply X; apply Y; ...; apply Z</code>, where all the <code>X Y Z</code> are hypotheses, then <code>solve_by_elim*</code> should work</p>\n</blockquote>\n<p>These are probably wrong, but I'd be happy to see more examples where they are wrong!</p>",
        "id": 402611369,
        "sender_full_name": "Scott Morrison",
        "timestamp": 1700194386
    },
    {
        "content": "<p>Great way to phrase the specification for these tactics. Maybe could be part of the docstring?</p>",
        "id": 402626691,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1700204079
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Tactic.LibrarySearch</span>\n<span class=\"kn\">import</span> <span class=\"n\">Mathlib.Order.RelIso.Basic</span>\n\n<span class=\"kd\">example</span> <span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"o\">}</span> <span class=\"o\">(</span><span class=\"n\">r</span> <span class=\"n\">s</span> <span class=\"n\">t</span> <span class=\"o\">:</span> <span class=\"n\">Œ±</span> <span class=\"bp\">‚Üí</span> <span class=\"n\">Œ±</span> <span class=\"bp\">‚Üí</span> <span class=\"kt\">Prop</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"o\">:</span> <span class=\"n\">s</span> <span class=\"bp\">‚âÉ</span><span class=\"n\">r</span> <span class=\"n\">r</span><span class=\"o\">)</span> <span class=\"o\">(</span><span class=\"n\">h'</span> <span class=\"o\">:</span> <span class=\"n\">r</span> <span class=\"bp\">‚âÉ</span><span class=\"n\">r</span> <span class=\"n\">t</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Œ±</span> <span class=\"bp\">‚Ü™</span> <span class=\"n\">Œ±</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span>\n  <span class=\"k\">have</span> <span class=\"o\">:=</span> <span class=\"n\">h.injective</span>\n  <span class=\"k\">have</span> <span class=\"o\">:=</span> <span class=\"n\">h'.injective</span>\n  <span class=\"n\">use</span> <span class=\"k\">fun</span> <span class=\"n\">a</span> <span class=\"bp\">‚Ü¶</span> <span class=\"n\">h'</span> <span class=\"o\">(</span><span class=\"n\">h</span> <span class=\"n\">a</span><span class=\"o\">)</span>\n  <span class=\"n\">exact</span><span class=\"bp\">?</span> <span class=\"c1\">--fails</span>\n</code></pre></div>\n<p>fails,  but works with <code>use fun a ‚Ü¶ (h' ‚àò h) a</code>. (<code>apply Function.Injective.comp; solve_by_elim*</code> works in both cases)</p>\n<p>So does <code>exact?</code> not try all theorems with results defeq to the goal? If that's how it works then there must be lots of cases where it can't close goals where a single <code>apply</code> would work.</p>",
        "id": 419929286,
        "sender_full_name": "Nir Paz",
        "timestamp": 1707167728
    },
    {
        "content": "<p>So this is not what it does. It used to do it in Lean 3 and it became unusable because Mathlib is now too large. So it uses some indexing now and this will not see through definitional equality.</p>",
        "id": 419934495,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1707169870
    },
    {
        "content": "<p>Another way to say this: <code>exact?</code> in Lean 4 now requires that matches satisfy a stricter equality constraint.</p>",
        "id": 419964969,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1707187370
    },
    {
        "content": "<p>Is there a tactic that does what the old <code>exact</code> did? I often spend &gt;2 minutes loogling and find a single theorem proof, and when it's obvious that what I want is somewhere in the library I'd rather just let that run for a minute.</p>",
        "id": 420352854,
        "sender_full_name": "Nir Paz",
        "timestamp": 1707344309
    },
    {
        "content": "<p>You presumably mean <code>exact?</code> in your message. Yes it would be nice sometimes to have an <code>exact?!</code> or <code>eexact?</code> which tried harder.</p>",
        "id": 420354068,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1707344880
    },
    {
        "content": "<p>Let me resurrect this thread, even though it is not clear to me whether the following is actually a failure of <code>apply?</code> proper. The following code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">CStarAlgebra</span><span class=\"bp\">.</span><span class=\"n\">Classes</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">aux</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx‚ÇÅ</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hz</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">‚Äñ</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">sub_sub</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_one</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"k\">calc</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">apply?</span>\n<span class=\"w\">    </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>(the strange import is suggested by <code>#min_imports</code> when I use <code>import Mathlib</code>) results in a timeout</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>(deterministic) timeout at `isDefEq`, maximum number of heartbeats (200000) has been reached\nUse `set_option maxHeartbeats &lt;num&gt;` to set the limit.\n\nAdditional diagnostic information may be available using the `set_option diagnostics true` command.\n</code></pre></div>\n<p>and gives red squiggles <em>not</em> at <code>apply?</code>, but at <code>import</code>(!) and at <code>sorry</code>. Replacing <code>apply?</code> by <code>sorry</code> makes it go away, so the problem should be with <code>apply?</code>.<br>\nWith <code>set_option diagnostics true</code>, I see</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[diag] Diagnostics ‚ñº\n  [reduction] unfolded declarations (max: 170990, num: 11): ‚ñº\n    [] HSub.hSub ‚Ü¶ 170990\n    [] Sub.sub ‚Ü¶ 56809\n    [] Add.add ‚Ü¶ 27823\n    [] HAdd.hAdd ‚Ü¶ 27822\n    [] HMul.hMul ‚Ü¶ 723\n    [] Mul.mul ‚Ü¶ 723\n    [] DFunLike.coe ‚Ü¶ 282\n    [] Real.toNNReal ‚Ü¶ 80\n    [] max ‚Ü¶ 78\n    [] LE.le ‚Ü¶ 36\n    [] LT.lt ‚Ü¶ 27\n</code></pre></div>\n<p>which looks decidedly fishy (this is on <a href=\"http://live.lean-lang.org\">live.lean-lang.org</a> with stable Mathlib, but it is similar with latest Mathlib).</p>\n<p>So:</p>\n<ul>\n<li><strong>Question 1.</strong> Why does <code>apply?</code> time out in such a simple situation instead of suggesting <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=norm_sub_le#doc\">docs#norm_sub_le</a> ?</li>\n<li><strong>Question 2.</strong> Why does the error not appear at <code>apply?</code>, but at two seemingly unrelated locations?</li>\n</ul>\n<p>I should mention that I have observed <code>apply?</code> time out fairly regularly recently in similar straight-forward situations, which makes it all but unusable. So it would be really good to fix this...</p>",
        "id": 516740598,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746641928
    },
    {
        "content": "<p>More minimal:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">diagnostics</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply?</span>\n</code></pre></div>\n<p>So it is not related to <code>apply?</code> occurring within a <code>calc</code> block.</p>",
        "id": 516743098,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746642823
    },
    {
        "content": "<p>Replacing <code>(x : ‚Ñù)</code> by <code>(x : ‚ÑÇ)</code> makes the problem go away.</p>",
        "id": 516743892,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746643121
    },
    {
        "content": "<p>The diagnostics output is</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[diag] Diagnostics ‚ñº\n  [reduction] unfolded declarations (max: 154626, num: 14): ‚ñº\n    [] Complex.ofReal ‚Ü¶ 154626\n    [] HSub.hSub ‚Ü¶ 112444\n    [] Sub.sub ‚Ü¶ 112444\n    [] HAdd.hAdd ‚Ü¶ 33740\n    [] Add.add ‚Ü¶ 33736\n    [] HMul.hMul ‚Ü¶ 8432\n    [] Mul.mul ‚Ü¶ 8432\n    [] DFunLike.coe ‚Ü¶ 3734\n    [] Real.toNNReal ‚Ü¶ 938\n    [] max ‚Ü¶ 936\n    [] Function.comp ‚Ü¶ 66\n    [] Classical.propDecidable ‚Ü¶ 46\n    [] dite ‚Ü¶ 36\n    [] Function.invFun ‚Ü¶ 36\n  [reduction] unfolded instances (max: 33742, num: 3): ‚ñº\n    [] instHAdd ‚Ü¶ 33742\n    [] Real.instAdd ‚Ü¶ 16872\n    [] instAddNat ‚Ü¶ 16870\n  [reduction] unfolded reducible declarations (max: 179922, num: 9): ‚ñº\n    [] Complex.re ‚Ü¶ 179922\n    [] ZeroHom.toFun ‚Ü¶ 2812\n    [] Equiv.toFun ‚Ü¶ 542\n    [] Equiv.invFun ‚Ü¶ 452\n    [] Subtype.val ‚Ü¶ 96\n    [] Function.Embedding.toFun ‚Ü¶ 87\n    [] outParam ‚Ü¶ 43\n    [] Decidable.casesOn ‚Ü¶ 36\n    [] semiOutParam ‚Ü¶ 24\n  [def_eq] heuristic for solving `f a =?= f b` (max: 89962, num: 15): ‚ñº\n    [] Complex.re ‚Ü¶ 89962\n    [] HSub.hSub ‚Ü¶ 30927\n    [] Sub.sub ‚Ü¶ 30926\n    [] instHAdd ‚Ü¶ 16870\n    [] HAdd.hAdd ‚Ü¶ 16869\n    [] Add.add ‚Ü¶ 16868\n    [] HMul.hMul ‚Ü¶ 4217\n    [] Mul.mul ‚Ü¶ 4216\n    [] DFunLike.coe ‚Ü¶ 1559\n    [] ZeroHom.toFun ‚Ü¶ 1406\n    [] max ‚Ü¶ 469\n    [] Real.toNNReal ‚Ü¶ 469\n    [] Equiv.toFun ‚Ü¶ 149\n    [] Equiv.invFun ‚Ü¶ 148\n    [] Subtype.val ‚Ü¶ 43\nuse `set_option diagnostics.threshold &lt;num&gt;` to control threshold for reporting counters\n</code></pre></div>",
        "id": 516743958,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746643142
    },
    {
        "content": "<p>With <code>(x : ‚ÑÇ)</code>, the output is</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[diag] Diagnostics ‚ñº\n  [reduction] unfolded declarations (max: 644, num: 7): ‚ñº\n    [] DFunLike.coe ‚Ü¶ 644\n    [] Function.comp ‚Ü¶ 62\n    [] dite ‚Ü¶ 54\n    [] Classical.propDecidable ‚Ü¶ 54\n    [] Function.invFun ‚Ü¶ 54\n    [] norm ‚Ü¶ 25\n    [] LE.le ‚Ü¶ 22\n  [reduction] unfolded reducible declarations (max: 143, num: 6): ‚ñº\n    [] Function.Embedding.toFun ‚Ü¶ 143\n    [] Equiv.toFun ‚Ü¶ 140\n    [] Equiv.invFun ‚Ü¶ 132\n    [] Decidable.casesOn ‚Ü¶ 54\n    [] outParam ‚Ü¶ 26\n    [] Subtype.val ‚Ü¶ 26\n</code></pre></div>",
        "id": 516744325,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746643282
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">apply?</span>\n</code></pre></div>\n<p>also avoids the error.</p>",
        "id": 516744988,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746643527
    },
    {
        "content": "<p>I tried to investigate this further. In</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foof</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact?</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>\n<p>the trace looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Elab.async] [0.038708] elaborating proof of Test.foof ‚ñº\n  [definition.value] [0.038288] Test.foof ‚ñº\n    [step] [0.037860] exact? ‚ñº\n      [] [0.037828] exact? ‚ñº\n        [] [0.037404] exact? ‚ñº\n          [Tactic.librarySearch] [0.019233] ‚úÖÔ∏è ‚Äñf x + z‚Äñ ‚â§ ‚Äñf x‚Äñ + ‚Äñz‚Äñ ‚ñº\n            [] [0.018645] ‚úÖÔ∏è trying norm_add_le  ‚ñº\n              [Meta.isDefEq] [0.017767] ‚úÖÔ∏è ‚Äñ?a + ?b‚Äñ ‚â§ ‚Äñ?a‚Äñ + ‚Äñ?b‚Äñ =?= ‚Äñf x + z‚Äñ ‚â§ ‚Äñf x‚Äñ + ‚Äñz‚Äñ ‚ñº\n                [delta] [0.017692] ‚úÖÔ∏è ‚Äñ?a + ?b‚Äñ ‚â§ ‚Äñ?a‚Äñ + ‚Äñ?b‚Äñ =?= ‚Äñf x + z‚Äñ ‚â§ ‚Äñf x‚Äñ + ‚Äñz‚Äñ ‚ñº\n                  [] [0.014135] ‚úÖÔ∏è ‚Äñ?a + ?b‚Äñ =?= ‚Äñf x + z‚Äñ ‚ñº\n                    [delta] [0.014054] ‚úÖÔ∏è ‚Äñ?a + ?b‚Äñ =?= ‚Äñf x + z‚Äñ\n          [] [0.013741] exact norm_add_le (f x) z\n</code></pre></div>\n<p>In contrast, in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foocoe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">Norm</span><span class=\"bp\">.</span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact?</span><span class=\"w\"> </span><span class=\"c1\">-- times out</span>\n</code></pre></div>\n<p>I see (after some unfolding)</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Elab.async] [6.995060] elaborating proof of Test.foocoe ‚ñº\n  [definition.value] [6.991602] Test.foocoe ‚ñº\n    [step] [6.991325]\n          exact?\n          sorry ‚ñº\n      [] [6.991303]  exact?\n            sorry ‚ñº\n        [] [6.991261] exact? ‚ñº\n          [Tactic.librarySearch] [0.011504] ‚úÖÔ∏è ‚Äñ‚Üëx + z‚Äñ ‚â§ ‚Äñ‚Üëx‚Äñ + ‚Äñz‚Äñ ‚ñ∂\n          [] [6.977442] exact norm_add_le (‚Üëx) z ‚ñº\n            [] [6.977402] expected type: ‚Äñ‚Üëx + z‚Äñ ‚â§ ‚Äñ‚Üëx‚Äñ + ‚Äñz‚Äñ, term\n                norm_add_le (‚Üëx) z ‚ñº\n              [Meta.isDefEq] [6.977083] üí•Ô∏è ‚Äñ‚Üëx + z‚Äñ ‚â§ ‚Äñ‚Üëx‚Äñ + ‚Äñz‚Äñ =?= ‚Äñ?m.269 + z‚Äñ ‚â§ ‚Äñ?m.269‚Äñ + ‚Äñz‚Äñ ‚ñº\n                [delta] [6.639590] ‚ùåÔ∏è ‚Äñ‚Üëx + z‚Äñ ‚â§ ‚Äñ‚Üëx‚Äñ + ‚Äñz‚Äñ =?= ‚Äñ?m.269 + z‚Äñ ‚â§ ‚Äñ?m.269‚Äñ + ‚Äñz‚Äñ ‚ñº\n                  [] [6.639567] ‚ùåÔ∏è ‚Äñ‚Üëx + z‚Äñ =?= ‚Äñ?m.269 + z‚Äñ ‚ñº\n                    [] [6.638362] ‚ùåÔ∏è Complex.instNorm.1 (‚Üëx + z) =?= SeminormedAddGroup.toNorm.1 (?m.269 + z) ‚ñº\n                      [] [6.638310] ‚ùåÔ∏è ‚àö(Complex.normSq\n                              (‚Üëx +\n                                z)) =?= { toFun := norm, map_zero' := Complex.norm_map_zero'‚úù,\n                                add_le' := Complex.norm_add_le'‚úù, neg' := Complex.norm_neg'‚úù,\n                                eq_zero_of_map_eq_zero' := Complex.instNormedAddCommGroup._proof_1 }.toAddGroupSeminorm\n                            (?m.269 + z) ‚ñ∂\n                [] [0.337464] üí•Ô∏è Real.instLE.1 ‚Äñ‚Üëx + z‚Äñ (‚Äñ‚Üëx‚Äñ + ‚Äñz‚Äñ) =?= Real.instLE.1 ‚Äñ?m.269 + z‚Äñ (‚Äñ?m.269‚Äñ + ‚Äñz‚Äñ) ‚ñ∂\n</code></pre></div>\n<p>This looks like it tries to unify two norms on <code>‚ÑÇ</code>: the one from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Complex.instNorm#doc\">docs#Complex.instNorm</a> and the one coming via <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddGroupNorm.toNormedAddCommGroup#doc\">docs#AddGroupNorm.toNormedAddCommGroup</a>, where the <code>toFun</code> component of the argument, which is an <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddGroupNorm#doc\">docs#AddGroupNorm</a>, is defined as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Norm.norm#doc\">docs#Norm.norm</a> (so should be the same). After several more steps unfolding, it gets to (see next message)</p>",
        "id": 517169305,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746816124
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>                                              [] [6.637245] ‚ùåÔ∏è (NNReal.sqrt\n                                                      (Complex.normSq\n                                                          (‚Üëx +\n                                                            z)).toNNReal).1 =?= (NNReal.sqrt\n                                                      (Complex.normSq (?m.269 + z)).toNNReal).1 ‚ñº\n                                                [delta] [0.023862] ‚ùåÔ∏è NNReal.sqrt (Complex.normSq (‚Üëx + z)).toNNReal =?= NNReal.sqrt (Complex.normSq (?m.269 + z)).toNNReal ‚ñ∂\n                                                [delta] [0.018011] ‚ùåÔ∏è  (...)\n                                                [delta] [0.016281] ‚ùåÔ∏è (...)\n                                                [delta] [0.015544] ‚ùåÔ∏è (...)\n                                                [delta] [0.015467] ‚ùåÔ∏è (...)\n                                                [delta] [0.015251] ‚ùåÔ∏è (...)\n                                                [delta] [0.016040] ‚ùåÔ∏è (...)\n                                                [delta] [0.732600] ‚ùåÔ∏è (StrictMono.orderIso (fun x ‚Ü¶ x ^ 2) ‚ãØ).symm\n                                                      (((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                            OrderIso.Set.univ).symm\n                                                        (Complex.normSq\n                                                            (‚Üëx +\n                                                              z)).toNNReal) =?= (StrictMono.orderIso (fun x ‚Ü¶ x ^ 2)\n                                                          ‚ãØ).symm\n                                                      (((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                            OrderIso.Set.univ).symm\n                                                        (Complex.normSq (?m.269 + z)).toNNReal) ‚ñ∂\n                                                [delta] [0.697105] ‚ùåÔ∏è (StrictMono.orderIso (fun x ‚Ü¶ x ^ 2) ‚ãØ).symm.toFun\n                                                      (((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                            OrderIso.Set.univ).symm\n                                                        (Complex.normSq\n                                                            (‚Üëx +\n                                                              z)).toNNReal) =?= (StrictMono.orderIso (fun x ‚Ü¶ x ^ 2)\n                                                            ‚ãØ).symm.toFun\n                                                      (((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                            OrderIso.Set.univ).symm\n                                                        (Complex.normSq (?m.269 + z)).toNNReal) ‚ñ∂\n                                                [delta] [0.713974] ‚ùåÔ∏è (StrictMono.orderIso (fun x ‚Ü¶ x ^ 2) ‚ãØ).invFun\n                                                      (((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                            OrderIso.Set.univ).symm\n                                                        (Complex.normSq\n                                                            (‚Üëx +\n                                                              z)).toNNReal) =?= (StrictMono.orderIso (fun x ‚Ü¶ x ^ 2)\n                                                          ‚ãØ).invFun\n                                                      (((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                            OrderIso.Set.univ).symm\n                                                        (Complex.normSq (?m.269 + z)).toNNReal) ‚ñ∂\n                                                [delta] [1.433555] ‚ùåÔ∏è Function.invFun (fun x ‚Ü¶ x ^ 2)\n                                                      ‚Üë(((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                              OrderIso.Set.univ).symm\n                                                          (Complex.normSq\n                                                              (‚Üëx +\n                                                                z)).toNNReal) =?= Function.invFun (fun x ‚Ü¶ x ^ 2)\n                                                      ‚Üë(((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ ‚ãØ).trans\n                                                              OrderIso.Set.univ).symm\n                                                          (Complex.normSq (?m.269 + z)).toNNReal) ‚ñ∂\n                                                [delta] [1.478169] ‚ùåÔ∏è if h :\n                                                        ‚àÉ x_1,\n                                                          (fun x ‚Ü¶ x ^ 2) x_1 =\n                                                            ‚Üë(((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ\n                                                                        ‚ãØ).trans\n                                                                    OrderIso.Set.univ).symm\n                                                                (Complex.normSq (‚Üëx + z)).toNNReal) then\n                                                      h.choose\n                                                    else\n                                                      Classical.arbitrary\n                                                        NNReal =?= if h :\n                                                        ‚àÉ x,\n                                                          (fun x ‚Ü¶ x ^ 2) x =\n                                                            ‚Üë(((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ\n                                                                        ‚ãØ).trans\n                                                                    OrderIso.Set.univ).symm\n                                                                (Complex.normSq (?m.269 + z)).toNNReal) then\n                                                      h.choose\n                                                    else Classical.arbitrary NNReal ‚ñ∂\n                                                [] [1.460850] ‚ùåÔ∏è Decidable.rec (fun h ‚Ü¶ (fun h ‚Ü¶ Classical.arbitrary NNReal) h) (fun h ‚Ü¶ (fun h ‚Ü¶ h.choose) h)\n                                                      (Classical.propDecidable\n                                                        (‚àÉ x_1,\n                                                          (fun x ‚Ü¶ x ^ 2) x_1 =\n                                                            ‚Üë(((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ\n                                                                        ‚ãØ).trans\n                                                                    OrderIso.Set.univ).symm\n                                                                (Complex.normSq\n                                                                    (‚Üëx +\n                                                                      z)).toNNReal))) =?= Decidable.rec\n                                                      (fun h ‚Ü¶ (fun h ‚Ü¶ Classical.arbitrary NNReal) h)\n                                                      (fun h ‚Ü¶ (fun h ‚Ü¶ h.choose) h)\n                                                      (Classical.propDecidable\n                                                        (‚àÉ x,\n                                                          (fun x ‚Ü¶ x ^ 2) x =\n                                                            ‚Üë(((OrderIso.setCongr (Set.range fun x ‚Ü¶ x ^ 2) Set.univ\n                                                                        ‚ãØ).trans\n                                                                    OrderIso.Set.univ).symm\n                                                                (Complex.normSq (?m.269 + z)).toNNReal))) ‚ñ∂\n</code></pre></div>\n<p>which looks pretty horrible to me.</p>\n<p>Is this some kind of diamond?</p>",
        "id": 517169612,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746816276
    },
    {
        "content": "<p>Note that when I hover over the norm symbols in the infoview with the cursor after <code>by</code>, all of them look like <code>@norm ‚ÑÇ Complex.instNorm _ : ‚Ñù</code>. So I wonder why the other norm instance pops up.</p>",
        "id": 517170155,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746816523
    },
    {
        "content": "<p>OK; I guess it's because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=norm_add_le#doc\">docs#norm_add_le</a> has type</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">norm_add_le</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u_5</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_5</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SeminormedAddGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">a</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">b</span><span class=\"bp\">‚Äñ</span>\n</code></pre></div>\n<p>Still, this does not explain why the problem does not occur when I replace <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Complex.ofReal#doc\">docs#Complex.ofReal</a> by <code>f</code> (even with <code>abbrev f : ‚Ñù ‚Üí ‚ÑÇ := Complex.ofReal</code>).</p>",
        "id": 517170473,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746816665
    },
    {
        "content": "<p>Note also that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">SeminormedAddCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toSeminormedAddGroup</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">            </span><span class=\"bp\">@</span><span class=\"n\">NormedAddCommGroup</span><span class=\"bp\">.</span><span class=\"n\">toSeminormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"w\"> </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNormedAddCommGroup</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toNorm</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">            </span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">instNorm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>is quick.</p>",
        "id": 517172424,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746817536
    },
    {
        "content": "<p>Here is a more minimal WE:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">norm_add_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span>\n</code></pre></div>\n<p>It does work with <code>(x : ‚ÑÇ)</code> or <code>Complex.ofReal x</code> in place of <code>‚Üëx</code>.</p>\n<p>(One difference is that with <code>exact?</code> or <code>apply?</code>, the red squiggle appears at the <code>import</code> statement, whereas here it appears at <code>lemma foo ...</code>.)</p>",
        "id": 517173466,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746817990
    },
    {
        "content": "<p>Or maybe even</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">Norm</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚ÑÇ</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">norm_add_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üë</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">Complex</span><span class=\"bp\">.</span><span class=\"n\">ofReal</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">z</span><span class=\"bp\">‚Äñ</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 517174686,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746818551
    },
    {
        "content": "<p>I moved this discussion to <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Coercion.20triggers.20timeout/near/517177117\">#mathlib4 &gt; Coercion triggers timeout @ üí¨</a> ; the title of this thread does not really fit as the problem does not appear to be specific to <code>apply?</code>.</p>",
        "id": 517177251,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1746819611
    },
    {
        "content": "<p>If you have observed <code>apply?</code> or <code>exact?</code> timing out (or taking a very long time) unexpectedly, this may be related to what is described in the thread linked above, and so you may want to up-vote the issue I created for this: <a href=\"https://github.com/leanprover/lean4/pull/8364\">lean4#8364</a></p>",
        "id": 518380234,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1747336007
    }
]