[
    {
        "content": "<p>I encountered a PANIC deep into a monster Lean file.  I believe the following is a minimal \"working\" example:</p>",
        "id": 565604829,
        "sender_full_name": "Boris Alexeev",
        "timestamp": 1766972011
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">def1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">def2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">thm3</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">h_a</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">def2</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">def1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">      </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">generalize_proofs</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*;</span>\n<span class=\"w\">  </span><span class=\"n\">generalize_proofs</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">*;</span>\n</code></pre></div>",
        "id": 565604834,
        "sender_full_name": "Boris Alexeev",
        "timestamp": 1766972019
    },
    {
        "content": "<p><a href=\"https://live.lean-lang.org/#project=mathlib-v4.24.0&amp;codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOB2E+AxhOAK4xJboCmcAJrQGaMsCMcAFKnAFxwYUcrQCU/OIFRCfgF44ABjyESZMJWp02rJswBME6XzmKcaWtFohBqEAGZu+A+IFCRsuFgCeOOHFRIAN3pUAH0kfh9fODp4LHcdXUjfGLhieI5uVzEkwWF6Iw9vKKikdHQQgHMIUoBnOArafFooUuAAL1oQsCgICGY6lDgAKgBuSIamlswOrp6+gfhRnCA\">https://live.lean-lang.org/#project=mathlib-v4.24.0&amp;codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQOB2E+AxhOAK4xJboCmcAJrQGaMsCMcAFKnAFxwYUcrQCU/OIFRCfgF44ABjyESZMJWp02rJswBME6XzmKcaWtFohBqEAGZu+A+IFCRsuFgCeOOHFRIAN3pUAH0kfh9fODp4LHcdXUjfGLhieI5uVzEkwWF6Iw9vKKikdHQQgHMIUoBnOArafFooUuAAL1oQsCgICGY6lDgAKgBuSIamlswOrp6+gfhRnCA</a></p>",
        "id": 565604837,
        "sender_full_name": "Boris Alexeev",
        "timestamp": 1766972028
    },
    {
        "content": "<p>The error on the \"Lean 4 Web\" site is:</p>",
        "id": 565604851,
        "sender_full_name": "Boris Alexeev",
        "timestamp": 1766972057
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GeneralizeProofs</span><span class=\"bp\">.</span><span class=\"n\">mkLambdaFVarsUsedOnly</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GeneralizeProofs</span><span class=\"o\">:</span><span class=\"mi\">208</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unreachable</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">backtrace</span><span class=\"o\">:</span>\n<span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GeneralizeProofs</span><span class=\"bp\">.</span><span class=\"n\">mkLambdaFVarsUsedOnly</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GeneralizeProofs</span><span class=\"o\">:</span><span class=\"mi\">208</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unreachable</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">backtrace</span><span class=\"o\">:</span>\n</code></pre></div>",
        "id": 565604873,
        "sender_full_name": "Boris Alexeev",
        "timestamp": 1766972073
    },
    {
        "content": "<p>This is the unreachable code-<br>\n<a href=\"https://github.com/leanprover-community/batteries/blob/2e16f91af2a97975e5d2fac906494cd6c17ba255/Batteries/Tactic/GeneralizeProofs.lean#L210\">https://github.com/leanprover-community/batteries/blob/2e16f91af2a97975e5d2fac906494cd6c17ba255/Batteries/Tactic/GeneralizeProofs.lean#L210</a></p>",
        "id": 565604916,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766972126
    },
    {
        "content": "<p>I thought generalize proofs was in mathlib</p>",
        "id": 565604956,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766972219
    },
    {
        "content": "<p>did they move it to batteries</p>",
        "id": 565604963,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766972225
    },
    {
        "content": "<p>so the problem is once again the <code>usedLetOnly</code> option in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mkLambdaFVars#doc\">docs#Lean.Meta.mkLambdaFVars</a> being set to false by default means the result can be something other than a let or a lambda</p>",
        "id": 565605058,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766972352
    },
    {
        "content": "<p>this is <a href=\"https://github.com/leanprover-community/mathlib4/pull/14444\">#14444</a> which is still awaiting-author after more than a year</p>",
        "id": 565605138,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766972434
    },
    {
        "content": "<p>Tried to simplify the repro</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GeneralizeProofs</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">True</span>\n<span class=\"w\">    </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">generalize_proofs</span>\n</code></pre></div>",
        "id": 565605264,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766972691
    },
    {
        "content": "<p>the type-error in the 2nd <code>let</code> seems necessary</p>",
        "id": 565605295,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766972750
    },
    {
        "content": "<p>The problem did go away when I tried to fix the types.  :)</p>",
        "id": 565605339,
        "sender_full_name": "Boris Alexeev",
        "timestamp": 1766972831
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/PANIC.20at.20Mathlib.2ETactic.2EGeneralizeProofs.2EmkLambdaFVarsUsedOn/near/565605058\">said</a>:</p>\n<blockquote>\n<p>so the problem is once again the <code>usedLetOnly</code> option in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mkLambdaFVars#doc\">docs#Lean.Meta.mkLambdaFVars</a> being set to false by default means the result can be something other than a let or a lambda</p>\n</blockquote>\n<p>Do you know what's the type that is returned?</p>",
        "id": 565605427,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766972988
    },
    {
        "content": "<p>no idea what you mean by that</p>",
        "id": 565607140,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766975591
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/PANIC.20at.20Mathlib.2ETactic.2EGeneralizeProofs.2EmkLambdaFVarsUsedOn/near/565605138\">said</a>:</p>\n<blockquote>\n<p>this is <a href=\"https://github.com/leanprover-community/mathlib4/pull/14444\">#14444</a> which is still awaiting-author after more than a year</p>\n</blockquote>\n<p>I'm sure <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> wouldn't mind if someone adopted this!</p>",
        "id": 565608077,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766976935
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/PANIC.20at.20Mathlib.2ETactic.2EGeneralizeProofs.2EmkLambdaFVarsUsedOn/near/565607140\">said</a>:</p>\n<blockquote>\n<p>no idea what you mean by that</p>\n</blockquote>\n<p>We know that <code>mkLambdaFVars</code> doesn't return a let, and doesn't return a lambda. So what <em>does</em> it return?</p>",
        "id": 565608785,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766977751
    },
    {
        "content": "<p>in this case it returns the body of the <code>let</code>, since the let-variable isn't used in the body</p>",
        "id": 565608959,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766978028
    },
    {
        "content": "<p>so since the <code>let</code> is constructed from the argument <code>e</code>, it just returns <code>e</code> unchanged</p>",
        "id": 565609005,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766978091
    },
    {
        "content": "<p>in your example depending on how it's used in the implementation I think this would probably be the constant <code>True</code></p>",
        "id": 565609025,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766978112
    }
]