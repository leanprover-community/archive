[
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21449\">#21449</a> speeds up TC synthesis by re-ordering two hypotheses to a lemma --- apparently, this makes failing searches much faster. (Trying to synthesise <code>IsPrime p</code> before <code>IsArtinian R</code> for an ideal <code>p</code> in a ring <code>R</code> is more useful.) I wonder if this can be done or investigated more systematically: do others see a way to do so?</p>",
        "id": 497847390,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1738748053
    },
    {
        "content": "<p>There are several similar tricks that have been used and are not really documented.  Someone, maybe <span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span>, suggested keeping track of it and we might as well start here!</p>",
        "id": 497848879,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738748487
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/21323\">#21323</a> also has several tricks for speed ups.</p>",
        "id": 497849373,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738748633
    },
    {
        "content": "<p>So is this speedup because it just happens to be the case that <code>IsPrime</code> typically fails faster than <code>IsArtinian</code> in today's mathlib?</p>",
        "id": 497868501,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738754380
    },
    {
        "content": "<p>Yes. The only example where this makes a difference actually tries to synthesize <code>IsPrime</code>. The only instance it finds for <code>IsPrime</code> is <code>IsMaximal</code>. Then for <code>IsMaximal</code> it only finds the instance with <code>IsPrime</code> and <code>IsArtinian</code>. If it tries <code>IsPrime</code>, it finds a loop and stops.</p>",
        "id": 497869064,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738754545
    },
    {
        "content": "<p>We don't want a search for <code>IsPrime _</code> to cause a search for <code>IsArtinian</code>. Especially since when it does find <code>IsArtinian</code>, it gets into a loop immediately anyways.</p>",
        "id": 497869485,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738754677
    },
    {
        "content": "<p>I see! So this is very specific to the setup we have with these instances and the relationships between them. We could add <code>IsDomain R -&gt; Subsingleton P -&gt; IsPrime P</code> one day and mess up your argument :-)</p>",
        "id": 497870159,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738754865
    },
    {
        "content": "<p>Well, I think <code>IsDomain</code> might be less expensive that <code>IsArtinian</code>? Depending on the context of course.</p>",
        "id": 497870982,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738755110
    },
    {
        "content": "<p>And for that instance one could also think about which order is faster: first synthesize <code>IsDomain</code> or <code>Subsingleton</code>?</p>",
        "id": 497871147,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738755165
    },
    {
        "content": "<p>Just an aside here: we have the file <code>MathlibTest/TCSynth.lean</code>, and I would <em>strongly</em> encourage adding to it anytime someone achieves a typeclass search speedup, to guard against subsequent regressions.</p>",
        "id": 498010542,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738802640
    },
    {
        "content": "<p>Unfortunately this file is not very findable --- any suggestions for encouraging additions to it very welcome.</p>",
        "id": 498010634,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738802662
    },
    {
        "content": "<p>Could we make successful speedup messages from the speedcenter suggest this?</p>",
        "id": 498050539,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1738826015
    },
    {
        "content": "<p>The bench-summary bot could certainly say something in its report and might probably even be made aware of the results and comment it when appropriate.</p>\n<p>I'm not sure what would be a good measure of \"TC speedup\", though.</p>",
        "id": 498053201,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738827051
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Re-order.20typeclass.20hypotheses.20for.20performance/near/498010542\">said</a>:</p>\n<blockquote>\n<p>we have the file <code>MathlibTest/TCSynth.lean</code>, and I would <em>strongly</em> encourage adding to it anytime someone achieves a typeclass search speedup, to guard against subsequent regressions.</p>\n</blockquote>\n<p>I've added a test for the type class search that was fixed. <a href=\"https://github.com/leanprover-community/mathlib4/pull/21499\">#21499</a></p>",
        "id": 498111419,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1738845567
    }
]