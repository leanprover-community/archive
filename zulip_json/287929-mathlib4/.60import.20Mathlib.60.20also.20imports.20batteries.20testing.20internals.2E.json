[
    {
        "content": "<p>is this desirable?<br>\nfor example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: library_note \"test\"</span>\n<span class=\"sd\">* 1: This is a testnote for testing the library note feature of batteries.</span>\n<span class=\"sd\">  The `#help note` command should be able to find this note when imported.</span>\n\n<span class=\"sd\">* 2: This is a second testnote for testing the library note feature of batteries.</span>\n\n<span class=\"sd\">* 3: this is a note in a different file importing the above testnotes,</span>\n<span class=\"sd\">  but still imported by the actual testfile.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">help</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"w\"> </span><span class=\"s2\">\"test\"</span>\n\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">info: [dummy_label_attr]: A dummy label attribute, which can be used for testing.</span>\n<span class=\"sd\">-/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">help</span><span class=\"w\"> </span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"n\">dummy</span>\n</code></pre></div>\n<p>the above can be found because indirectly <code>Batteries.Test.Internal</code> contents are imported, which i'm not sure should be exposed like this...</p>",
        "id": 480411880,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730715805
    },
    {
        "content": "<p>That seems undesirable, indeed. <br>\nCan you figure out how <code>Batteries.Test.*</code> gets imported and remove the corresponding imports?</p>",
        "id": 480412191,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1730715915
    },
    {
        "content": "<p>i'm guessing that this happens because <code>Mathlib.lean</code> imports <code>Batteries</code>, and <code>Batteries.lean</code> has to import these because otherwise you can't use these files for the tests.</p>",
        "id": 480412467,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730716020
    },
    {
        "content": "<p>indeed, only importing <code>Mathlib.Tactic</code> does fix this...</p>",
        "id": 480412781,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730716119
    },
    {
        "content": "<p>... and importing <code>Batteries</code> preserves it.</p>",
        "id": 480412850,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730716144
    },
    {
        "content": "<p>i guess the way to fix this would be to have Batteries also turn its test suite into a separate module?</p>",
        "id": 480413098,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730716211
    },
    {
        "content": "<p>maybe this should be moved to the batteries channel then...</p>",
        "id": 480413243,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730716262
    },
    {
        "content": "<p>If <code>Batteries</code> imports <code>Batteries.Test</code>, we should never import the former. However, the better fix might be to not import <code>Batteries.Test</code> in <code>Batteries</code> (or we can do both).</p>",
        "id": 480416721,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1730717266
    },
    {
        "content": "<p>whatever module gets built to run the test files (currently that's just <code>Batteries</code>) has to contain these files, so splitting out a module for testing would indeed be the right solution here.</p>",
        "id": 480417080,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730717388
    },
    {
        "content": "<p>We just turned Mathlib's test suite into a library, <code>MathlibTest</code>.</p>",
        "id": 480417718,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730717620
    },
    {
        "content": "<p>We can do the same for Batteries.</p>",
        "id": 480417726,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730717625
    },
    {
        "content": "<p>right, that's exactly what i meant.</p>",
        "id": 480417790,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730717642
    },
    {
        "content": "<p>the only reason <code>Batteries.Test.Internal</code> exists is because in the main library you can import other test files, but in the ad-hoc test suite you can't.</p>",
        "id": 480417870,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730717663
    },
    {
        "content": "<p>I will merge a PR doing this! :-)</p>",
        "id": 480417888,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730717669
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60import.20Mathlib.60.20also.20imports.20batteries.20testing.20internals.2E/near/480417888\">said</a>:</p>\n<blockquote>\n<p>I will merge a PR doing this! :-)</p>\n</blockquote>\n<p>just to clarify, this means it's ok for me to write the PR? or are you doing that too?</p>",
        "id": 480418462,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730717861
    },
    {
        "content": "<p>(I would guess it's the former --- but I'm a by-stander.)</p>",
        "id": 480419139,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1730718042
    },
    {
        "content": "<p>PR at <a href=\"https://github.com/leanprover-community/batteries/pull/1024\">batteries#1024</a></p>",
        "id": 480446251,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730727580
    },
    {
        "content": "<p>i got the nice number <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 480446305,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730727600
    },
    {
        "content": "<p>note that in order to use the <code>globs</code> approach, i had to move to <code>lakefile.lean</code> instead of <code>.toml</code></p>",
        "id": 480446474,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730727652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"684366\">Edward van de Meent</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60import.20Mathlib.60.20also.20imports.20batteries.20testing.20internals.2E/near/480446474\">said</a>:</p>\n<blockquote>\n<p>note that in order to use the <code>globs</code> approach, i had to move to <code>lakefile.lean</code> instead of <code>.toml</code></p>\n</blockquote>\n<p>I use this in Aesop's <code>lakefile.toml</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[[</span><span class=\"n\">lean_lib</span><span class=\"o\">]]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"s2\">\"AesopTest\"</span>\n<span class=\"n\">globs</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"s2\">\"AesopTest.+\"</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>Would the same setup also work for Batteries?</p>",
        "id": 480448597,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1730728309
    },
    {
        "content": "<p>possibly... but i already wrote the PR... <span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span></p>",
        "id": 480448770,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730728366
    },
    {
        "content": "<p>still, thanks for the suggestion <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 480449093,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730728452
    },
    {
        "content": "<p>I have a feeling that there is a strong drift towards <code>.toml</code> format, so if that is possible, I think that it would be preferred.</p>",
        "id": 480450572,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1730728885
    },
    {
        "content": "<p>how do i modify leanOptions for a single library?</p>",
        "id": 480452318,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730729346
    },
    {
        "content": "<p>(in <code>.toml</code>)?</p>",
        "id": 480452340,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730729353
    },
    {
        "content": "<p>nvm, i think i figured it out.</p>",
        "id": 480453240,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730729639
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/h1mTf5P08sMZnuK-YZtftFJk/image.png\">image.png</a><br>\nlooks like a mathlib test depends on an internal detail of batteries <span aria-label=\"face with open eyes and hand over mouth\" class=\"emoji emoji-1fae2\" role=\"img\" title=\"face with open eyes and hand over mouth\">:face_with_open_eyes_and_hand_over_mouth:</span></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/h1mTf5P08sMZnuK-YZtftFJk/image.png\" title=\"image.png\"><img data-original-dimensions=\"1120x549\" src=\"/user_uploads/thumbnail/3121/h1mTf5P08sMZnuK-YZtftFJk/image.png/840x560.webp\"></a></div>",
        "id": 480457818,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730730870
    },
    {
        "content": "<p>for now i'll just redefine the attribute in mathlibs test files, rather than have mathlib tests depend on batteries internals.</p>",
        "id": 480472562,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730734924
    },
    {
        "content": "<p>i've taken a look at <a href=\"https://github.com/leanprover-community/mathlib4/pull/18638\">#18638</a> (the mathlib adaptation for changing batteries tests into a library), and i'm not sure it's desirable to have mathlib tests depend on batteries testing internals...</p>",
        "id": 480735501,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730817474
    },
    {
        "content": "<p>personally i think it would be preferable to have mathlib tests have their own testing attribute, allowing flexibility on both the side of mathlib and batteries for doing testing their own way without worrying about breakage.</p>",
        "id": 480735821,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730817564
    },
    {
        "content": "<p>would a PR making these tests independent be welcome?</p>",
        "id": 480735985,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730817604
    },
    {
        "content": "<p>Yes please!</p>",
        "id": 480796135,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730839059
    },
    {
        "content": "<p>PR at <a href=\"https://github.com/leanprover-community/mathlib4/pull/18674\">#18674</a></p>",
        "id": 480798916,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1730840285
    },
    {
        "content": "<p>In a similar vein, we may want to switch filenames in MathlibTest to CamelCase instead of snake_case.</p>",
        "id": 480800375,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1730840924
    }
]