[
    {
        "content": "<p>Inspired by <span class=\"user-mention\" data-user-id=\"816344\">@Aaron Liu</span>'s comments in <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/deprecate.20Mathlib.2EData.2ENat.2EPartENat.3F/near/538009243\">#mathlib4 &gt; deprecate Mathlib.Data.Nat.PartENat? @ üí¨</a> and <a class=\"message-link\" href=\"/#narrow/channel/217875-Is-there-code-for-X.3F/topic/Divergence.20monad/near/538020049\">#Is there code for X? &gt; Divergence monad @ üí¨</a> I made an attempt at constructing a monad for partial computations with a computable <code>OmegaCompletePartialOrder</code> instance (neither <code>Option</code> nor <code>Part</code> support this use case). My solution consists of three parts.</p>\n<p><strong>A computable version of <code>Quotient.choice</code>.</strong> As mentioned in <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/Quot.2Elift.20for.20dependent.20products/near/467436416\">#lean4 &gt; Quot.lift for dependent products @ üí¨</a> , the \"obvious\" computational interpretation of <code>Quotient.choice : (‚àÄi:I, @Quotient (A i) ‚Ä¶) ‚Üí @Quotient (‚àÄi:I, A i)</code> is not sound. However, we _can_ provide a sound computational interpretation when we restrict <code>I</code> to <code>‚Ñï</code>: </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Quotient.countableChoice_impl</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Setoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Quotient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">Quotient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Quotient.lift‚ÇÇ</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"bp\">‚ü¶</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">‚üß</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">z‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">s‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">z‚ÇÇ</span><span class=\"w\"> </span><span class=\"n\">s‚ÇÇ</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">      </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">sound</span>\n<span class=\"w\">      </span><span class=\"n\">rintro</span><span class=\"w\"> </span><span class=\"o\">‚ü®</span><span class=\"n\">_</span><span class=\"bp\">|</span><span class=\"n\">n</span><span class=\"o\">‚ü©</span>\n<span class=\"w\">      </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÅ</span>\n<span class=\"w\">      </span><span class=\"bp\">¬∑</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">h‚ÇÇ</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">countableChoice_impl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚Ü¶</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">n.succ</span><span class=\"o\">))</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">Quotient.countableChoice_impl</span><span class=\"kd\">]</span>\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">Quotient.countableChoice</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Setoid</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)}</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Quotient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">Quotient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">infer_instance</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">Quotient.choice</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>\n<p>My justification for the soundness of this implementation comes from the fact that only uses existing (sound and computable) functions + general recursion. The implementation is found <a href=\"https://github.com/YellPika/mathlib4/blob/99d38f164a97c7aa225283ef6016f0279419a994/Mathlib/Data/Quot.lean#L430\">here</a> (it uses <code>unquot</code> instead of recursion for performance reasons, but should be equivalent).</p>\n<p><strong>A type of semi-computable propositions.</strong> Next, I define a type of semi-computable propositions <code>Œ©Prop</code> as a quotient of the type of boolean sequences <code>(‚Ñï ‚Üí Bool) / ‚âà</code>, where <code>p ‚âà q ‚âù (‚àÉn, p n) ‚Üî (‚àÉn, q n)</code>. A sequence is interpreted as \"true\" if at least one element in the sequence is <code>true</code>, and the quotient relation ensures that we cannot observe the difference between different \"true\" sequences. The <code>Œ©Prop</code> type has a (computable) <code>OmegaCompletePartialOrder</code>, and <code>Quotient.countableChoice</code> is used in the implementation of <code>œâSup</code>.</p>\n<p>The implementation of this type is <a href=\"https://github.com/YellPika/mathlib4/blob/quot-choice-compute/Mathlib/Data/OmegaProp.lean\">here</a>.</p>\n<p><strong>A type of semi-computable computations.</strong> Finally, I define the type <code>Œ©Part A</code> of semi-computable computations returning a value of type <code>A</code>. The definition of <code>Œ©Part</code> is the same as <code>Part</code> with <code>Œ©Prop</code> swapped for <code>Prop</code>. Again, <code>Œ©Part A</code> has a (computable) <code>OmegaCompletePartialOrder</code> instance. The implementation can be found <a href=\"https://github.com/YellPika/mathlib4/blob/quot-choice-compute/Mathlib/Data/OmegaPart.lean\">here</a>.</p>\n<p>This was mainly just a fun experiment and the code is not ready to be (or perhaps should not be) put in mathlib. I thought I should post it here to see if 1) there is any interest or 2) an implementation already exists that has escaped my notice.</p>",
        "id": 569619800,
        "sender_full_name": "Anthony Vandikas",
        "timestamp": 1769132204
    },
    {
        "content": "<p>Since you've written this in mathlib itself, it would probably be easiest to look at if you opened a draft PR; you can make it clear in the description that you don't actually intend it to be merged.</p>",
        "id": 569622974,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769134274
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/A.20monad.20for.20partial.20computations/near/569622974\">said</a>:</p>\n<blockquote>\n<p>Since you've written this in mathlib itself, it would probably be easiest to look at if you opened a draft PR; you can make it clear in the description that you don't actually intend it to be merged.</p>\n</blockquote>\n<p>Good idea! I have made a PR at <a href=\"https://github.com/leanprover-community/mathlib4/pull/34291\">#34291</a>.</p>",
        "id": 569630459,
        "sender_full_name": "Anthony Vandikas",
        "timestamp": 1769140283
    }
]