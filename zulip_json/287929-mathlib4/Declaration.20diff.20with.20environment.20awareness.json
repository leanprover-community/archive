[
    {
        "content": "<p>I have a prototype for a declaration diff that takes the actual environment into account, rather than the text-based script that is currently running in CI: <a href=\"https://github.com/leanprover-community/mathlib4/pull/22464\">#22464</a>.</p>",
        "id": 503318854,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107671
    },
    {
        "content": "<p>What I view as the main disadvantage with this script is that it requires a successful CI run to post its output.  For this reason, I would not remove the old script, at least not yet, and would simply add another self-updating comment that contains the \"real\" declaration diff, when it is available.</p>",
        "id": 503318877,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107678
    },
    {
        "content": "<p>If you want to see a sample outcome, this is how I would convert into Zulip-formatting what the output looks like in CI:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p><strong>Declaration diff in Lean</strong></p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">&lt; Add.decls_in_master.txt'</span>\n<span class=\"gi\">&gt; Add.decls_in_PR.txt'</span>\n<span class=\"gi\">&gt; FFF</span>\n<span class=\"gd\">&lt; Mul.decls_in_master.txt'</span>\n<span class=\"gi\">&gt; Mul.decls_in_PR.txt'</span>\n</code></pre></div>\n<p>PR: <a href=\"https://github.com/leanprover-community/mathlib4/commit/d25d65c286081ddb3f72f5b66e4d036933cea4b7\">d25d65c</a></p>\n<p>Master: <a href=\"https://github.com/leanprover-community/mathlib4/commit/7191d1e197aaa5e3f6aea68593237adef8e8cdd4\">7191d1e</a></p>\n</div></div>",
        "id": 503318897,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107682
    },
    {
        "content": "<p>You can see the actual comment on the testing branch <a href=\"https://github.com/leanprover-community/mathlib4/pull/22497\">#22497</a>.</p>",
        "id": 503318924,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107688
    },
    {
        "content": "<p>The remaining issue is that this is, as far as I know, the first action in the mathlib repository that is contingent on another action being successful.  This of course means lots of new ways of script failing in CI.  In particular, the action can only be tested if the workflow files are already in master.</p>",
        "id": 503319246,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107767
    },
    {
        "content": "<p>The fact it hijacked a mergify comment seems like a second remaining issue!</p>",
        "id": 503319408,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741107817
    },
    {
        "content": "<p>So, if someone is familiar with <code>workflow_run</code> in CI, please do let me know if I am doing something wrong!  Otherwise, it will have to be tested with multiple iterations!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 503319602,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107862
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Declaration.20diff.20with.20environment.20awareness/near/503319408\">said</a>:</p>\n<blockquote>\n<p>The fact it hijacked a mergify comment seems like a second remaining issue!</p>\n</blockquote>\n<p>Actually, that is my doing: I did not want to have to scroll up or down all the time, so I made the script overwrite the first available comment, that happened to be by mergify,</p>",
        "id": 503319733,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107906
    },
    {
        "content": "<p>If you look at the commit whose message has a unicode character, that is where I rewrote the mergify message.</p>",
        "id": 503319981,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741107974
    },
    {
        "content": "<p>This is a great tool to have around! Do you think you can also make it available as some sort of <code>lake exe diff {git-hash}</code>?</p>",
        "id": 503429751,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741154109
    },
    {
        "content": "<p>And yes, let's just post two diff reports in the PR summary for the time being.</p>",
        "id": 503429772,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741154125
    },
    {
        "content": "<p>I would have to experiment a bit with the command line lean executable, but I can easily extract a command-line option for the script.</p>",
        "id": 503438532,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741158812
    },
    {
        "content": "<p>It would still have to switch branches and download the two caches and then run for a couple of minutes.</p>",
        "id": 503438629,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741158846
    },
    {
        "content": "<p>I think that it may be a bit unwieldy.</p>",
        "id": 503438655,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741158860
    },
    {
        "content": "<p>Currently, there is no heuristic that just inspects the modified files: the script load all the oleans and looks at all declarations.</p>",
        "id": 503438760,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741158916
    },
    {
        "content": "<p>I can write a modification of the script that only inspects the declarations contained in the <em>modified</em> files.  This would be probably a good heuristic and would definitely be quicker.</p>",
        "id": 503439550,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741159247
    },
    {
        "content": "<p>However, if you change, for instance, the naming scheme of <code>to_additive</code>, you would not notice the difference downstream.</p>",
        "id": 503439630,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741159291
    },
    {
        "content": "<p>So, there could be a quick-and-dirty version that just inspects the declarations in the modified files and a thorough-but-slow version that inspects the whole environment.</p>",
        "id": 503439757,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741159343
    },
    {
        "content": "<p>Having those two options sounds good to me.</p>",
        "id": 503440989,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741159863
    },
    {
        "content": "<p>And switching branches + downloading cache is not a problem. I happy to wait for a few seconds, to get this accurate information.</p>",
        "id": 503441086,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741159901
    },
    {
        "content": "<p>How about the per-file-diff comes as a next PR?</p>",
        "id": 503442459,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741160483
    },
    {
        "content": "<p>I'm keen to test that the workflow action works...</p>",
        "id": 503442502,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741160505
    },
    {
        "content": "<p>Also, it's more than a few seconds: CI takes 5 minutes.</p>",
        "id": 503442661,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741160567
    },
    {
        "content": "<p>So, here is a plan.</p>",
        "id": 503451532,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741163805
    },
    {
        "content": "<p>I'm going to add the option of passing to the script a list of modules and a flag that can be</p>\n<ul>\n<li><code>upstream</code>, meaning diff in the given modules and anything that imports them (good for, e.g. <code>to_additive</code> changes);</li>\n<li><code>downstream</code>, meaning diff in the given modules and anything that they import (good for, e.g. detecting upstreaming to <code>Batteries</code>);</li>\n<li><code>only</code>, meaning diff just the declarations defined in the given module (quick, but not fully reliable).</li>\n</ul>",
        "id": 503451545,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741163810
    },
    {
        "content": "<p>If nothing is passed, then the default is the current behaviour: import all of mathlib and its libraries and compute the huge diff of everything.</p>",
        "id": 503451550,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741163812
    },
    {
        "content": "<p>That sounds like a good plan. Although my picture of up/downstream is the opposite of yours.<br>\nAnd 5 minutes is maybe a bit much. Could <code>only</code> be the option that we run in CI on every PR?</p>",
        "id": 503463599,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741167393
    },
    {
        "content": "<p>Then commenting <code>!decl_diff all</code> or <code>!decl_diff upstream</code> could maybe trigger a more complete diff.</p>",
        "id": 503463677,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741167423
    },
    {
        "content": "<p>The CI run is separate from the main build and, ideally, is triggered by the main build becoming green.</p>",
        "id": 503467561,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741168491
    },
    {
        "content": "<p>Anyway, once I have the new script, I may also optimise it a little bit: currently, it just dumps <em>all</em> the declarations in the two environments to two files and computes the diff of the files.</p>",
        "id": 503467846,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741168574
    },
    {
        "content": "<p>It can probably ignore all declarations in \"common\" modules and be quicker.</p>",
        "id": 503467962,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741168610
    },
    {
        "content": "<p>I probably won't have time to look at this until later this Friday, though.</p>",
        "id": 503468053,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741168639
    },
    {
        "content": "<p>I wonder if the difference between <code>upstream</code> and <code>downstream</code> is just one of perspective:</p>\n<ul>\n<li>I was thinking of <code>upstream</code> as \"the <em>declarations</em> that see that there have been upstream changes\", whereas</li>\n<li>I think that you were thinking of <code>upstream</code> as \"the <em>modules</em> that are upstream of the changes\".</li>\n</ul>\n<p>I'll see if there is a less confusing terminology that makes it clear whose perspective is taken into account!</p>",
        "id": 503485994,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741173751
    },
    {
        "content": "<p>Aah, yep, that explains the confusion (-;</p>",
        "id": 503490855,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1741175299
    }
]