[
    {
        "content": "<p>I believe that our current definition of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=EMetricSpace#doc\">docs#EMetricSpace</a> is broken (same with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=PseudoEMetricSpace#doc\">docs#PseudoEMetricSpace</a>). We require that the topology (and uniformity) of the space is defined by the distance. In particular, points with distance <code>∞</code> from every other point must be isolated points.</p>\n<p>I think this is highly undesirable in practice. For example, <code>ℝ≥0∞</code> is not an <code>EMetricSpace</code>, since <code>∞</code> is not an isolated point. In fact, we have <strong>no</strong> instances of <code>PseudoEMetricSpace</code> besides instances that come from <code>PseudoMetricSpace</code> or instances that already assume <code>(Pseudo)EMetricSpace</code> on some other type.</p>\n<p>I'm not sure how to best \"fix\" this. Presumably there's a bunch of lemmas that require <code>EMetricSpace</code> and talk about the topology of the space? (If not, we can simply remove the uniformity from the data of an <code>EMetricSpace</code>.)<br>\nI would like <code>ℝ≥0∞</code> to be an <code>EMetricSpace</code> (if it isn't, then what is?), but I think it cannot be equipped with a nice uniformity? If so, then we should just remove the uniformity from <code>EMetricSpace</code>. However, we want it to work well with the topology (I think), so maybe we should redefine <code>PseudoEMetricSpace</code> to include an axiom that the topology plays well with <code>edist</code> something like this</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">EMetric</span><span class=\"bp\">.</span><span class=\"n\">ball</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">EDist</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"bp\">∞</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">edist</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">ε</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">PseudoEMetricSpace</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">TopologicalSpace</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">EDist</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">edist_self</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">edist</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">edist_comm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">edist</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">edist</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">edist_triangle</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">edist</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">edist</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">edist</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">z</span>\n<span class=\"w\">  </span><span class=\"n\">isOpen_ball</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"bp\">≥</span><span class=\"mi\">0</span><span class=\"bp\">∞</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">IsOpen</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">EMetric</span><span class=\"bp\">.</span><span class=\"n\">ball</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Maybe we want a stronger condition on the topology, e.g. that on all balls (also of infinite radius) the topology coincides with the topology given by <code>edist</code>, so that only the topology between the balls of infinite radius is left unspecified.</p>\n<p>Earlier somewhat related discussion <a href=\"#narrow/channel/116395-maths/topic/Nontrivial.20example.20of.20emetric.20space\">here</a></p>",
        "id": 497955635,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738779468
    },
    {
        "content": "<p>(I brought this up in the discussion of <a href=\"https://github.com/leanprover-community/mathlib4/pull/21422\">#21422</a>)</p>",
        "id": 497956328,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738779704
    },
    {
        "content": "<p>I wouldn't call it \"broken\". There are 2 examples that work with our definition: <code>Closeds</code> and <code>Lp</code> emetric on the space of all measurable functions.</p>",
        "id": 497959370,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1738780757
    },
    {
        "content": "<p>Is there a consensus in the literature on what should be called an extended metric space?</p>",
        "id": 497959468,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1738780787
    },
    {
        "content": "<p>Definitely, we can have a typeclass between <code>EDist</code> and the current <code>EMetricSpace</code>. BTW, <code>ENNReal</code>s won't be <code>EMetricSpace</code> in terms of your definition, because <code>ball ∞ 1</code> isn't open.</p>",
        "id": 497959806,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1738780887
    },
    {
        "content": "<p>+1 example: max edistance on functions that aren't assumed to be bounded.</p>",
        "id": 497959988,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1738780949
    },
    {
        "content": "<p>+1: evariation on paths that aren't assumed to have bounded variation.</p>",
        "id": 497960147,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1738781007
    },
    {
        "content": "<p>We can define <code>EDist ENNReal</code>, then see what properties are still true, then decide if we want to have a typeclass for this.</p>",
        "id": 497960364,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1738781072
    },
    {
        "content": "<p>Maybe I am a bit too harsh with my words, but I'm wondering if we can weaken the type-class assumptions to make this class more widely useful.</p>",
        "id": 497963237,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738782033
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/EMetricSpace.20is.20broken/near/497959806\">said</a>:</p>\n<blockquote>\n<p>Definitely, we can have a typeclass between <code>EDist</code> and the current <code>EMetricSpace</code>. BTW, <code>ENNReal</code>s won't be <code>EMetricSpace</code> in terms of your definition, because <code>ball ∞ 1</code> isn't open.</p>\n</blockquote>\n<p>You are completely correct that <code>ball ∞ 1</code> isn't open, so my suggestion doesn't work for the goal I intended. Thanks for spotting that. <br>\nMaybe <code>ℝ≥0∞</code> really is ill-behaved enough to not be something like this...</p>",
        "id": 497963296,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738782055
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/EMetricSpace.20is.20broken/near/497960364\">said</a>:</p>\n<blockquote>\n<p>We can define <code>EDist ENNReal</code>, then see what properties are still true, then decide if we want to have a typeclass for this.</p>\n</blockquote>\n<p>Somewhat related, in the Carleson project I'm defining a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ENorm#doc\">docs#ENorm</a> on <code>ENNReal</code>, and I'm trying to figure out what precise class I want this enorm to satisfy. Probably this: <a href=\"https://florisvandoorn.com/carleson/docs/find/?pattern=ENormedSpace#doc\">carleson#ENormedSpace</a>.</p>",
        "id": 497963566,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738782152
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/EMetricSpace.20is.20broken/near/497959370\">said</a>:</p>\n<blockquote>\n<p>I wouldn't call it \"broken\". There are 2 examples that work with our definition: <code>Closeds</code> and <code>Lp</code> emetric on the space of all measurable functions.</p>\n</blockquote>\n<p>Both of these require that the space you start with is already an <code>EMetricSpace</code>, and in both cases (I think?) if you start with a metric space you get a metric space out. So that still doesn't provide any EMetric spaces used in Mathlib that are not Metric spaces.</p>",
        "id": 497964097,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738782342
    },
    {
        "content": "<p>In your extra examples, are the topologies given by the emetric-space actually useful though?</p>",
        "id": 497964294,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738782417
    },
    {
        "content": "<p><code>Closeds</code> on the real line aren't a <code>MetricSpace</code>. E.g., the Hausdorff distance between <code>{4 ^ n | n : Nat}</code> and <code>{2 * 4 ^ n | n : Nat}</code> is infinity.</p>",
        "id": 497967116,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1738783322
    },
    {
        "content": "<p>I don't think our definition is broken: it does exactly what it is designed for. The standard example is indeed <code>L^p</code> (even when the base space is a nice metric space): the edistance between two functions is the integral of <code>|f - g|</code>, which can be infinite. Two functions which are at infinite distance are really not comparable in any way, so you really want them to be in different connected components of the <code>L^p</code> space.</p>",
        "id": 497967303,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1738783392
    },
    {
        "content": "<p>Thanks for your input! It's clear that I was wrong (sorry for the provocative title), and that EMetricSpace works fine. Maybe I'll investigate at some later point if there is a class between <code>EDist</code> and <code>EMetricSpace</code> where <code>ENNReal</code> fits nicely.</p>\n<p>The reason I started this discussion is by PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/21422\">#21422</a>, where we add classes <code>ENormedAddCommMonoid</code>, which is supposed to be satisfied by both <code>NormedAddCommGroup</code> and <code>ENNReal</code>. <code>NormedAddCommGroup </code> is defined in terms of <code>MetricSpace</code>, so I was wondering to what extend we could have <code>ENormedAddCommMonoid</code> extend <code>EMetricSpace</code>.</p>",
        "id": 497969087,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1738784053
    },
    {
        "content": "<p>Isn't what Floris is actually saying, that no amount of metric or emetric stuff with d(x,infty)=infty will ever give the right topology on <code>ENNReal</code>, which presumably is the topology making it homeomorphic to the closed interval.</p>",
        "id": 497971721,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738785111
    },
    {
        "content": "<p>So somehow maybe the conclusion is that ENNReal should not actually be an emetric space, because this doesn't even give the right notion of convergence, e.g. 1+1+1+1+1+1+... does not converge to infinity in the emetric, even though this is clearly desirable</p>",
        "id": 497971919,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738785180
    }
]