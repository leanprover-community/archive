[
    {
        "content": "<p>Currently <code>lake exe cache get</code> downloads all the oleans it needs, and then after this is finished starts decompressing them. I'm often waiting on this, and it would be lovely if we could parallelize (particularly as one step is network limited and the other is CPU limited).</p>\n<p>Would anyone be interested in looking into this?</p>",
        "id": 496444262,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738108456
    },
    {
        "content": "<p>I'll keep it in mind when looking at the partial cache tomorrow<span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> (although I know nothing about parallelisatio  in Lean, yet)</p>",
        "id": 496446957,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738110035
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60lake.20exe.20cache.60.20could.20download.20and.20decompress.20in.20parallel/near/496444262\">said</a>:</p>\n<blockquote>\n<p>it would be lovely if we could parallelize (particularly as one step is network limited and the other is CPU limited).</p>\n</blockquote>\n<p>I have a draft for this at <a href=\"https://github.com/leanprover-community/mathlib4/pull/21275\">#21275</a>. In this attempt, I used the parallelisation of the file download and decompress each file directly after it's downloaded. And after the download finished it decompresses any remaining files that did not need download. It's probably not the best parallelisation possible but it's what was available without bigger changes (most changes in there are from the dependent PR, you should probably only look at <a href=\"https://github.com/leanprover-community/mathlib4/pull/21275/commits/aa1e53dd3c32d7655c8522f66ffe392834cc4821\">the diff of the last commit</a>).</p>\n<p>Idk, I think this could be tested in practice to see if that's actually faster by any means... (it works on my machine even though the CI fails currently)</p>",
        "id": 496870186,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738271860
    },
    {
        "content": "<p>Just double checking --- starting the decompression of already existing files at the same time as starting the downloads is not easily possible?</p>",
        "id": 496879187,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738275602
    },
    {
        "content": "<p>Thanks for all this work! It looks promising, but of course scary to deploy. I left some comments at <a href=\"https://github.com/leanprover-community/mathlib4/pull/21238\">#21238</a>.</p>",
        "id": 496881000,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738276395
    },
    {
        "content": "<p>Would it make sense to keep the old cache, so that <code>lake exe cache' get</code> still works with the old code, while the new code gets tested in production?</p>",
        "id": 496881261,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738276523
    },
    {
        "content": "<p>A bit messy... I think it's okay to just cut over \"live\" once we're ready, but perhaps we'll coordinate the time to have a few people around to put out fires.</p>",
        "id": 496881437,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738276603
    },
    {
        "content": "<p>btw, if I do <code>lake build --no-build Mathlib.Init</code> and it says something about <code>running batteries:optBarrel</code>, does that mean one file from <code>Batteries</code> is not in the right place? or what is an <code>optBarrel</code>?</p>",
        "id": 496883628,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738277714
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60lake.20exe.20cache.60.20could.20download.20and.20decompress.20in.20parallel/near/496883628\">said</a>:</p>\n<blockquote>\n<p>btw, if I do <code>lake build --no-build Mathlib.Init</code> and it says something about <code>running batteries:optBarrel</code>, does that mean one file from <code>Batteries</code> is not in the right place? or what is an <code>optBarrel</code>?</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, I thought we agreed that <code>optBarrel</code> was not going to be user visible? Did this not happen?</p>",
        "id": 496883799,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738277787
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60lake.20exe.20cache.60.20could.20download.20and.20decompress.20in.20parallel/near/496879187\">said</a>:</p>\n<blockquote>\n<p>Just double checking --- starting the decompression of already existing files at the same time as starting the downloads is not easily possible?</p>\n</blockquote>\n<p>it might be possible, idk. I have to say I don't fully understand parallelisation in Lean. Parallel download comes from <code>Cache.IO.runCurlStreaming</code> (<a href=\"https://github.com/leanprover-community/mathlib4/blob/344e1cfc04c1c3b0aef8dc9f66e3153a4c38823a/Cache/IO.lean#L163\">def</a> and <a href=\"https://github.com/leanprover-community/mathlib4/blob/344e1cfc04c1c3b0aef8dc9f66e3153a4c38823a/Cache/Requests.lean#L90\">usage</a>) the other seems to be in <code>leantar</code> (<a href=\"https://github.com/leanprover-community/mathlib4/blob/344e1cfc04c1c3b0aef8dc9f66e3153a4c38823a/Cache/IO.lean#L361-L370\">source</a>). But I don't know of any Lean function which says something like \"run these two <code>IO</code> programs in parallel\".</p>",
        "id": 496884583,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738278151
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60lake.20exe.20cache.60.20could.20download.20and.20decompress.20in.20parallel/near/496883799\">said</a>:</p>\n<blockquote>\n<p><code>optBarrel</code> was not going to be user visible? Did this not happen?</p>\n</blockquote>\n<p>to be fair, manually messing with the content of <code>.lake</code> folders might hardly be a \"normal use case\".</p>\n<p>I think <code>--no-build</code> just cancels as soon as it realises there is something to build, and the <code>optBarrel</code> might be a red hering. Concretely it's displayed here:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>jon@computer<span class=\"w\"> </span>mathlib4<span class=\"w\"> </span>%<span class=\"w\"> </span>lake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get<span class=\"w\"> </span>Mathlib/Init.lean\ninfo:<span class=\"w\"> </span>plausible:<span class=\"w\"> </span>cloning<span class=\"w\"> </span><span class=\"o\">[</span>..<span class=\"w\"> </span>all<span class=\"w\"> </span>the<span class=\"w\"> </span>cloning<span class=\"w\"> </span>..<span class=\"o\">]</span>\nNo<span class=\"w\"> </span>files<span class=\"w\"> </span>to<span class=\"w\"> </span>download\nDecompressing<span class=\"w\"> </span><span class=\"m\">21</span><span class=\"w\"> </span>file<span class=\"o\">(</span>s<span class=\"o\">)</span>\nUnpacked<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">16</span><span class=\"w\"> </span>ms\nCompleted<span class=\"w\"> </span>successfully!\njon@computer<span class=\"w\"> </span>mathlib4<span class=\"w\"> </span>%<span class=\"w\"> </span>lake<span class=\"w\"> </span>build<span class=\"w\"> </span>--no-build<span class=\"w\"> </span>Mathlib.Init\nâ£¾<span class=\"w\"> </span><span class=\"o\">[</span><span class=\"m\">10</span>/24<span class=\"o\">]</span><span class=\"w\"> </span>Running<span class=\"w\"> </span>batteries:optBarrel<span class=\"w\"> </span><span class=\"o\">(</span>+<span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span>more<span class=\"o\">)</span>%\njon@computer<span class=\"w\"> </span>mathlib4<span class=\"w\"> </span>%\n</code></pre></div>",
        "id": 496885164,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738278443
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=IO.asTask#doc\">docs#IO.asTask</a></p>",
        "id": 496885443,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1738278586
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span> <a href=\"#narrow/channel/287929-mathlib4/topic/.60lake.20exe.20cache.60.20could.20download.20and.20decompress.20in.20parallel/near/496884583\">said</a>:</p>\n<blockquote>\n<p>But I don't know of any Lean function which says something like \"run these two <code>IO</code> programs in parallel\".</p>\n</blockquote>\n<p>Actually, I guess one could completely combine the two functions I've linked above to get it more parallel <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 496885736,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738278723
    },
    {
        "content": "<p>Yes, you don't need parallel tasks to have parallel processes</p>",
        "id": 496941061,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738307322
    },
    {
        "content": "<p>Should I dust off <a href=\"https://github.com/digama0/lean-cache\"><code>lean-cache</code></a>? It implemented this by linking to curl and using its callback API</p>",
        "id": 499839709,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739570833
    },
    {
        "content": "<p>My understanding is that <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> intends to completely replace <code>cache</code> (next quarter? not sure here). So while hopefully <code>lean-cache</code> can be a helpful datapoint, I don't think it makes sense to switch it out at the moment.</p>",
        "id": 500059224,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1739752170
    }
]