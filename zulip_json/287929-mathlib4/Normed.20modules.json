[
    {
        "content": "<p>Is there a typeclass in mathlib for normed modules over a normed ring satisfying <code>‚àÄ a x, ‚Äña ‚Ä¢ x‚Äñ = ‚Äña‚Äñ * ‚Äñx‚Äñ</code> (rather than just the inequality <code>‚àÄ a x, ‚Äña ‚Ä¢ x‚Äñ ‚â§ ‚Äña‚Äñ * ‚Äñx‚Äñ</code> which is what you get with <code>BoundedSMul</code>)? The two assumptions are equivalent if the ring is a normed <em>division</em> ring, but I'd like to use this for <code>‚Ñ§_[p]</code>-modules.</p>",
        "id": 504407199,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741536534
    },
    {
        "content": "<p>(FWIW I think a <code>BoundedSMul</code> example where this stronger axiom fails would be the module <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"double-struck\">Z</mi><mi mathvariant=\"normal\">/</mi><mi>p</mi><mi mathvariant=\"double-struck\">Z</mi></mrow><annotation encoding=\"application/x-tex\">\\Z/p\\Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathbb\">Z</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathbb\">Z</span></span></span></span> with the trivial norm <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"normal\">‚à£</mi><mi>v</mi><mi mathvariant=\"normal\">‚à£</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">|v|=1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">‚à£</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord\">‚à£</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span> for <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mo>=Ã∏</mo><mn>0</mn></mrow><annotation encoding=\"application/x-tex\">v\\not=0</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\"><span class=\"mord vbox\"><span class=\"thinbox\"><span class=\"rlap\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"inner\"><span class=\"mord\"><span class=\"mrel\">ÓÄ†</span></span></span><span class=\"fix\"></span></span></span></span></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.3669em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">0</span></span></span></span>)</p>",
        "id": 504408119,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741537189
    },
    {
        "content": "<p>Sure; it wasn't my intention to suggest that every module (or every interesting module) satisfying <code>BoundedSMul</code> has this stronger property ‚Äì¬†a possibly more natural example is to take any Banach algebra that's not an integral domain, and consider it as a module over itself. </p>\n<p>However, I do feel that modules satisfying this stronger property are useful enough that it would be nice to have a way of spelling the condition in mathlib.</p>",
        "id": 504408629,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741537614
    },
    {
        "content": "<p>I think we're also missing the analogous typeclass for <code>norm_mul</code> over rings like <code>Int</code></p>",
        "id": 504408768,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741537706
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/504408768\">said</a>:</p>\n<blockquote>\n<p>I think we're also missing the analogous typeclass for <code>norm_mul</code> over rings like <code>Int</code></p>\n</blockquote>\n<p>I agree. I think there are quite a few theorems being stated for <code>NormedDivisionRing</code> where the division isn't actually relevant, just in order to have <code>norm_mul</code> or <code>norm_smul</code> holding.</p>",
        "id": 504409054,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741537930
    },
    {
        "content": "<p>I wonder what a good name for this would be? Maybe a ring with a strictly multiplicative norm can be a <code>StrictNormedRing</code>, and analogously <code>StrictNormedModule</code>?</p>",
        "id": 504409873,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741538571
    },
    {
        "content": "<p>I like <code>Strict</code> but right now this word is used in the naming convention in order theory to mean things like \"preserves <code>&lt;</code>\". I guess you can argue that strict just means \"stronger than &lt;=\" in both cases :-) I do feel like it's a good word mathematically for this concept.</p>",
        "id": 504411427,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741539767
    },
    {
        "content": "<p>I had a look into defining <code>StrictNormedRing</code> but got sidetracked because the existing library file <code>Analysis/Normed/Field/Basic</code> is overdue a refactor anyway (it lives in a subdirectory <code>Field</code> but it contains the definition of a normed ring...) . I will make a pure refactor PR moving things to more sensible places, and then have a go at defining <code>StrictNormedRing</code> on top of that.</p>",
        "id": 504411898,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741540142
    },
    {
        "content": "<p>It looks like we do have a name for the \"unbundled\" version of this (<code>MulRingNorm</code> for the strictly multiplicative version vs <code>RingNorm</code> for the sub-multiplicative one); just not for the version where it is bundled as \"the\" norm.</p>",
        "id": 504416486,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741543487
    },
    {
        "content": "<p>Another option here is a mixin typeclass that says the norm bound for SMul is tight, rather than inserting something into the typeclass hierarchy</p>",
        "id": 504416494,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741543494
    },
    {
        "content": "<p>(since if we do that we have to add all the Comm / Nonunital / Seminormed(?) versions too)</p>",
        "id": 504416545,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741543532
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/504416494\">said</a>:</p>\n<blockquote>\n<p>Another option here is a mixin typeclass that says the norm bound for SMul is tight, rather than inserting something into the typeclass hierarchy</p>\n</blockquote>\n<p>That's a really good idea actually, it will make it much less painful.</p>",
        "id": 504416562,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741543544
    },
    {
        "content": "<p>So <code>StrictBoundedSMul</code>, which would provide a <code>toBoundedSMul</code> instance</p>",
        "id": 504416652,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741543593
    },
    {
        "content": "<p>Or <code>IsStrictBoundedSMul</code>? Is it supposed to be a Prop?</p>",
        "id": 504416681,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741543624
    },
    {
        "content": "<p>If we want to go down that path I think we should rename BoundedSMul first</p>",
        "id": 504416717,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741543659
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"644391\">@loogle</span> BoundedSMul</p>",
        "id": 504416858,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741543734
    },
    {
        "content": "<p><span aria-label=\"search\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"search\">:search:</span> <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/MetricSpace/Algebra.html#BoundedSMul\">BoundedSMul</a>, <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Topology/MetricSpace/Algebra.html#NNReal.boundedSMul\">NNReal.boundedSMul</a>, and <a href=\"https://loogle.lean-lang.org/?q=BoundedSMul\">209 more</a></p>",
        "id": 504416859,
        "sender_full_name": "loogle",
        "timestamp": 1741543735
    },
    {
        "content": "<p>That's quite a lot of renames, but hopefully very few deprecations</p>",
        "id": 504416894,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741543764
    },
    {
        "content": "<p>I would be happy not to open that can of worms, to be honest. The community still seems to be to be pretty divided on when we do and do not use <code>Is</code>. There is now some kind of official policy but I am not at all convinced that it is adhered to in practice.</p>",
        "id": 504417196,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741543984
    },
    {
        "content": "<p>I would rather this rename be delayed at least until I have finished refactoring <code>Analysis/Normed/*</code> in order to disentangle normed rings and normed fields.</p>",
        "id": 504417323,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741544079
    },
    {
        "content": "<p>I think there's a rough consensus that <code>Is</code> is good, but a lot of legacy code  from before this was established</p>",
        "id": 504423436,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741548381
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/504417323\">said</a>:</p>\n<blockquote>\n<p>I would rather this rename be delayed at least until I have finished refactoring <code>Analysis/Normed/*</code> in order to disentangle normed rings and normed fields.</p>\n</blockquote>\n<p>PR up at <a href=\"https://github.com/leanprover-community/mathlib4/pull/22744\">#22744</a>.</p>",
        "id": 504436960,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741558219
    },
    {
        "content": "<p>Given that we have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormOneClass#doc\">docs#NormOneClass</a> as a mixin, would it make sense to have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormMulClass%3F#doc\">docs#NormMulClass?</a> And then for normed modules use NormedSpace?</p>",
        "id": 504437365,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741558524
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"308899\">Yakov Pechersky</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/504437365\">said</a>:</p>\n<blockquote>\n<p>Given that we have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormOneClass#doc\">docs#NormOneClass</a> as a mixin, would it make sense to have <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NormMulClass%3F#doc\">docs#NormMulClass?</a> And then for normed modules use NormedSpace?</p>\n</blockquote>\n<p>Even if the ring satisfies <code>NormMulClass</code>, it doesn't imply that all normed modules over that ring satisfy the stronger condition (think <code>F_p</code> as a module over <code>Z_p</code>). So we need an extra mixin typeclass for the modules too, <code>NormedSpace</code> isn't enough.</p>",
        "id": 504437677,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741558748
    },
    {
        "content": "<p>I guess the names could be <code>NormMulClass</code> and <code>NormSMulClass</code>.</p>",
        "id": 504437834,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741558892
    },
    {
        "content": "<p>I think it's even worse because if I understood correctly, in your norm_M (r smul x) example, you'd want that to be equal to norm_M r * norm_M x, or abs_R r * norm_M x? If the former, wouldn't you get that from NormMulClass via <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.algebraMap_eq_smul_one#doc\">docs#Algebra.algebraMap_eq_smul_one</a> : edited, probably not...? And if the latter, wouldn't work with, for example, Q_p over Q, unless we include the \"WithAbs\" twist somehow.</p>",
        "id": 504441177,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741561532
    },
    {
        "content": "<p>Do we want this for metric spaces too like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=BoundedSMul#doc\">docs#BoundedSMul</a> ? If so I think we should not use Norm in the name</p>",
        "id": 504441584,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741561849
    },
    {
        "content": "<p>Okay, how about saying that smul is IsUniformInducing?</p>",
        "id": 504441745,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741561971
    },
    {
        "content": "<p>My guess is that that \"combinatorial\" or \"topological\" assumption is weaker than being norm-preserving.</p>",
        "id": 504441785,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1741562015
    },
    {
        "content": "<p>Or something that's the right way of saying that smul scales the uniformity in the expected manner. Which would work for metric spaces etc, iiuc</p>",
        "id": 504441862,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741562059
    },
    {
        "content": "<p>Tangentially; what's the deal with the generality of BoundedSMul? What's an example of a metric space that has a canonical zero but no norm?</p>",
        "id": 504441899,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1741562097
    },
    {
        "content": "<p><a href=\"https://math.stackexchange.com/a/170307\">https://math.stackexchange.com/a/170307</a></p>",
        "id": 504442118,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741562244
    },
    {
        "content": "<p>But that's a NormedSpace argument, sorry.</p>",
        "id": 504442207,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741562294
    },
    {
        "content": "<p>Maybe this? <a href=\"https://math.stackexchange.com/a/3519913\">https://math.stackexchange.com/a/3519913</a></p>",
        "id": 504442288,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741562379
    },
    {
        "content": "<p>I suspect the generality of <code>BoundedSMul</code> is determined by applications to NNReal, which explains why it assumes a zero but not an add group structure.</p>",
        "id": 504493414,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741592200
    },
    {
        "content": "<p>I've recorded the counterexample in <a href=\"https://github.com/leanprover-community/mathlib4/pull/22810\">#22810</a>.</p>",
        "id": 504681278,
        "sender_full_name": "Yakov Pechersky",
        "timestamp": 1741638702
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/504436960\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/504417323\">said</a>:</p>\n<blockquote>\n<p>I would rather this rename be delayed at least until I have finished refactoring <code>Analysis/Normed/*</code> in order to disentangle normed rings and normed fields.</p>\n</blockquote>\n<p>PR up at <a href=\"https://github.com/leanprover-community/mathlib4/pull/22744\">#22744</a>.</p>\n</blockquote>\n<p>Now that <a href=\"https://github.com/leanprover-community/mathlib4/pull/22744\">#22744</a> is merged, I have made a PR that renames the Prop-valued typeclasses <code>BoundedSMul</code> and <code>IsometricSMul / VAdd</code> to <code>IsXXX</code>. See <a href=\"https://github.com/leanprover-community/mathlib4/pull/22797\">#22797</a>. It touches a lot of files so I would be grateful for a quick review.</p>",
        "id": 504771152,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741681759
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover-community/mathlib4/pull/22842\">#22842</a> for a PR introducing a \"NormMulClass\" mixin typeclass for rings with a strictly multiplicative norm.</p>",
        "id": 505088959,
        "sender_full_name": "David Loeffler",
        "timestamp": 1741775379
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23787\">#23787</a> has the <code>NormSMulClass</code> mixin, but is not ideal performance-wise. I think we still want it, but it would be nice to track down if any of the performance loss is easily recoverable.</p>",
        "id": 511459907,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744303538
    },
    {
        "content": "<p>I wonder if the performance problems we are having are related to the slightly indirect way that <code>NormedSpace</code> (over normed fields) is defined: that the definition of the class requires  <code>‚àÄ a x, ‚Äña ‚Ä¢ x‚Äñ ‚â§ ‚Äña‚Äñ * ‚Äñx‚Äñ</code>, but then we immediately show that this actually <em>implies</em> the a priori stronger condition <code>‚àÄ a x, ‚Äña ‚Ä¢ x‚Äñ = ‚Äña‚Äñ * ‚Äñx‚Äñ</code>. This makes it difficult to integrate <code>NormedSpace</code> into a typeclass hierarchy which provides typeclasses describing both of these conditions for more general normed rings (where they are definitely not equivalent):¬†situations like this, \"A trivially implies B, but B in fact implies A under some auxiliary hypothesis C\", seem to cause performance pain for typeclass resolution.</p>\n<p>If we changed the definition of <code>NormedSpace</code> so exact multiplicativity <code>‚àÄ a x, ‚Äña ‚Ä¢ x‚Äñ = ‚Äña‚Äñ * ‚Äñx‚Äñ</code> was baked into the definition, and provided a lemma ‚Äì¬†<em>not</em> an instance ‚Äì¬†allowing one to construct NormedSpace instances given sub-multiplicativity, would that perhaps solve some of the problems? Then all the instances would \"go downhill\" so to speak; the \"uphill\" step, proving that the a-priori weaker condition actually implies the stronger one, wouldn't be part of the typeclass system.</p>\n<p>Of course, there's a trade-off in that it means one needs to prove more when defining <code>NormedSpace</code> instances on concrete types. But I'm not sure it actually comes up that often: how frequent is it that one has a normed vector space for which it is really genuinely harder to prove <code>‚Äña ‚Ä¢ x‚Äñ = ‚Äña‚Äñ * ‚Äñx‚Äñ</code> than <code>‚Äña ‚Ä¢ x‚Äñ ‚â§ ‚Äña‚Äñ * ‚Äñx‚Äñ</code>?</p>",
        "id": 511489457,
        "sender_full_name": "David Loeffler",
        "timestamp": 1744311599
    },
    {
        "content": "<p>I don't think changing the field inside <code>NormedSpace</code> will have any effect on performance, or on what instance paths we can pick. Notions of downhill and uphill should be about the typeclass itself, not its implementation details</p>",
        "id": 511505714,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744318209
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Normed.20modules/near/511489457\">said</a>:</p>\n<blockquote>\n<p>But I'm not sure it actually comes up that often: how frequent is it that one has a normed vector space for which it is really genuinely harder to prove <code>‚Äña ‚Ä¢ x‚Äñ = ‚Äña‚Äñ * ‚Äñx‚Äñ</code> than <code>‚Äña ‚Ä¢ x‚Äñ ‚â§ ‚Äña‚Äñ * ‚Äñx‚Äñ</code>?</p>\n</blockquote>\n<p>I would say pretty much all the time. If you've set your type up in full generality, it's likely that you first provided a very general <code>IsBoundedSMul</code> instance. If you've done that anyway, the <code>le</code> proof is \"free\", while the new one requires some work. Of course, if you've also instantiated the <code>NormMulClass</code> in full generality, then by the time you get to NormedSpace both are free anyway.</p>",
        "id": 511506219,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744318435
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/511489457\">said</a>:</p>\n<blockquote>\n<p>how frequent is it that one has a normed vector space for which it is really genuinely harder to prove <code>‚Äña ‚Ä¢ x‚Äñ = ‚Äña‚Äñ * ‚Äñx‚Äñ</code> than <code>‚Äña ‚Ä¢ x‚Äñ ‚â§ ‚Äña‚Äñ * ‚Äñx‚Äñ</code>?</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/511506219\">said</a>:</p>\n<blockquote>\n<p>I would say pretty much all the time.</p>\n</blockquote>\n<p>Eric's response surprised me, so I decided to check in the library. So far, with only one single exception (operator norms on linear maps), the proofs of the <code>norm_smul_le</code> field of <code>NormedSpace</code> consist of proving equality and then using <code>le_rfl</code> or <code>le_of_eq</code>.  So I think the evidence does not support Eric's assertion.</p>",
        "id": 511576610,
        "sender_full_name": "David Loeffler",
        "timestamp": 1744355170
    },
    {
        "content": "<p>I was thinking of the ~10 cases where we prove the <code>NormedSpace</code> instance with <code>norm_smul_le := norm_smul_le</code></p>",
        "id": 511643700,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744375772
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/511489457\">said</a>:</p>\n<blockquote>\n<p>If we changed the definition of <code>NormedSpace</code> so exact multiplicativity <code>‚àÄ a x, ‚Äña ‚Ä¢ x‚Äñ = ‚Äña‚Äñ * ‚Äñx‚Äñ</code> was baked into the definition</p>\n</blockquote>\n<p>In case it's relevant, this ends up reverting <a href=\"https://github.com/leanprover-community/mathlib/pull/2693\">!3#2693</a>.</p>",
        "id": 511644140,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744375901
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/511643700\">said</a>:</p>\n<blockquote>\n<p>I was thinking of the ~10 cases where we prove the <code>NormedSpace</code> instance with <code>norm_smul_le := norm_smul_le</code></p>\n</blockquote>\n<p>A lot of those just become <code>norm_smul := norm_smul</code> (or disappear entirely).</p>",
        "id": 511657344,
        "sender_full_name": "David Loeffler",
        "timestamp": 1744379416
    },
    {
        "content": "<p>See the current version of <a href=\"https://github.com/leanprover-community/mathlib4/pull/23787\">#23787</a> for an attempt at changing <code>NormedSpace</code> to require <code>norm_smul</code> rather than <code>norm_smul_le</code>. Benchmarking now.</p>",
        "id": 511657913,
        "sender_full_name": "David Loeffler",
        "timestamp": 1744379593
    },
    {
        "content": "<p>What's the best way forward here? It seems that my proposal of adjusting the definition of <code>NormedSpace</code> doesn't worsen the slow-down caused by introducing <code>NormSMulClass</code>, but it doesn't solve it either (consistently with Eric's remark that the speed of instance search is independent of how the individual typeclasses are implemented). So we are at a standstill. </p>\n<p>It's very frustrating to be blocked from adding new capabilities to mathlib because of the apparent impossibility of doing so without slowing down the existing functionality. Can we live with the slowdown? (~15% for the worst-affected files, but those are quite short; 0.3% overall slowdown across the whole of mathlib.) I'm afraid that I do not have the expertise to work out why the slowdown is occurring, or whether anything can be done to avoid it.</p>",
        "id": 511669114,
        "sender_full_name": "David Loeffler",
        "timestamp": 1744382528
    },
    {
        "content": "<p>Here's my workflow for diagnosing slowdowns. Start with the github output of bench which is <a href=\"https://github.com/leanprover-community/mathlib4/pull/23787#issuecomment-2797059569\">here</a>. Next fire up two mathlibs, and check out the two commits mentioned at the top of that message (lake exe cache get works fine). Note that I am doing this on a machine with two monitors and 32 gigs of ram! Then go to a file which has suffered a lot (e.g. <code>Mathlib.Analysis.Analytic.Basic</code> in this case) and just do some completely dumb things (e.g. press a key in the module docstring in each file to get both versions of the file to recompile) and stare and hope you see something fishy. This part is very much hit-and-miss.</p>\n<p>So let's try hitting and missing. I thought I saw <code>HasFPowerSeriesWithinOnBall.tendsto_partialSum_prod</code> taking a long time so let's look at that. On line 873 I add <code>#count_heartbeats in</code> in both files and we see that it's 4708 on master and 5607 on the branch, which is about a 20% speedup. But this is quite a big proof. Let's try something smaller -- <code>radius</code> is on line 117 and it's 3966 heartbeats on master and 4865 on the branch, and it's only one line long so this looks like much easier to take apart. But it's a def. The first theorem about it, <code>le_radius_of_bound</code> is 2729 on the branch and 2279 (note: not the same number) on master so that's also a 20% speedup and it's a one-line proof so this is definitely somewhere where we could start.</p>\n<p>So delete <code>#count_heartbeats in</code> on line 120 and replace it with </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10000</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n</code></pre></div>\n<p>in both files. The <code>set_option profiler.threshold 10000 in</code> option might not do anything, you could not use heartbeats and instead use times in seconds but heartbeats are in my experience a more robust measurement (even though they will change from run to run, you can only trust them to a couple of sig figs for some reason). Clicking on the blue underline on the docstring gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">command</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">4127190.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"sd\">/-- If `‚Äñp‚Çô‚Äñ r‚Åø` is bounded in `n`, then the radius of `p` is at least `r`. -/</span>\n<span class=\"w\">    </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">le_radius_of_bound</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"bp\">‚àû</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">radius</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">le_iSup_of_le</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">le_iSup_of_le</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">le_iSup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"bp\">‚àû</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>on the branch and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">command</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">3458114.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"sd\">/-- If `‚Äñp‚Çô‚Äñ r‚Åø` is bounded in `n`, then the radius of `p` is at least `r`. -/</span>\n<span class=\"w\">    </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">le_radius_of_bound</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">‚àÄ</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">‚Äñ</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">‚Äñ</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"bp\">‚àû</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">‚â§</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">radius</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">      </span><span class=\"n\">le_iSup_of_le</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">le_iSup_of_le</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">le_iSup</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">‚â•</span><span class=\"mi\">0</span><span class=\"bp\">‚àû</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>so indeed there's definitely something fishy going on. What is it? Start unfolding in both VS Code windows. Timings for almost everything are almost the same except that </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">step</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">2751455.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u_3</span><span class=\"w\"> </span><span class=\"n\">u_2</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"w\">      </span><span class=\"n\">FormalMultilinearSeries</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>has become</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">step</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">3419812.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">u_3</span><span class=\"w\"> </span><span class=\"n\">u_2</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">term</span>\n<span class=\"w\">      </span><span class=\"n\">FormalMultilinearSeries</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">F</span>\n</code></pre></div>\n<p>and here the gap is even wider in relative terms, so we're on the right track. Unfold again. The big thing that stands out now is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">706260.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">ContinuousConstSMul</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span>\n</code></pre></div>\n<p>which has become</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">1068033.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">ContinuousConstSMul</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"bp\">‚ñ∂</span>\n</code></pre></div>\n<p>and this is now more like a 40% slowdown. Continuing to dig we have that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">80524.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">NormedSpace</span><span class=\"bp\">.</span><span class=\"n\">isBoundedSMul</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">IsBoundedSMul</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span>\n</code></pre></div>\n<p>has become</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">292007.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">NormSMulClass</span><span class=\"bp\">.</span><span class=\"n\">toIsBoundedSMul</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">IsBoundedSMul</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">E</span>\n</code></pre></div>\n<p>etc etc. Keep going! This is the killer:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">35.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MonoidWithZero</span><span class=\"bp\">.</span><span class=\"n\">toMonoid</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">MonoidWithZero</span><span class=\"bp\">.</span><span class=\"n\">toMonoid</span>\n</code></pre></div>\n<p>on master vs</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">34667.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">MonoidWithZero</span><span class=\"bp\">.</span><span class=\"n\">toMonoid</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">MonoidWithZero</span><span class=\"bp\">.</span><span class=\"n\">toMonoid</span>\n</code></pre></div>\n<p>on the branch. So it looks like there are two monoid instances which are less defeq than before and that typeclass inference now explodes them on your branch. I don't have an immediate fix but this looks like something which it might be possible to fix (sorry, I have a meeting in 1 minute so need to stop). But this (on your branch) is never good:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">11343.000000</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">‚úÖÔ∏è</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"bp\">.</span><span class=\"n\">npow</span><span class=\"w\"> </span><span class=\"bp\">=?=</span><span class=\"w\"> </span><span class=\"n\">Semiring</span><span class=\"bp\">.</span><span class=\"n\">npow</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n</code></pre></div>",
        "id": 511686343,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744387182
    },
    {
        "content": "<p>There seems to be a misplaced \"```\" in your message...</p>",
        "id": 511697251,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1744390950
    },
    {
        "content": "<p>When was this merged with master last?</p>",
        "id": 511698877,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744391551
    },
    {
        "content": "<p>Pretty recently I think. Merging master will invalidate our previous benchmarks unfortunately</p>",
        "id": 511699058,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744391627
    },
    {
        "content": "<p>We've had significant changes to the instance graph in the interim which could possibly interact with these changes in new ways.</p>",
        "id": 511704448,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744393508
    },
    {
        "content": "<p>I will merge latest master on this PR, and split off some changes that are<br>\nnot relevant to the speed issues; but it might take me a day or so! ‚Äî<br>\nRegards, David</p>",
        "id": 511727859,
        "sender_full_name": "David Loeffler",
        "timestamp": 1744402940
    },
    {
        "content": "<p>I merged master.</p>",
        "id": 511730009,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744403914
    },
    {
        "content": "<p>I don't think de-tangling the order stuff helps much but perhaps <code>IsSeminormedGroup</code>and friends might</p>",
        "id": 511730292,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744404037
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/6r8GfQ9HdqhgytUPUAbEwzWa/Screenshot-2025-04-11-at-4.45.43PM.png\">One Zero</a><br>\n<a href=\"/user_uploads/3121/70_F-qXVQrVjxRFCpVwwJRWP/Screenshot-2025-04-11-at-4.44.19PM.png\">Another Zero</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/6r8GfQ9HdqhgytUPUAbEwzWa/Screenshot-2025-04-11-at-4.45.43PM.png\" title=\"One Zero\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1812x840\" src=\"/user_uploads/thumbnail/3121/6r8GfQ9HdqhgytUPUAbEwzWa/Screenshot-2025-04-11-at-4.45.43PM.png/840x560.webp\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/3121/70_F-qXVQrVjxRFCpVwwJRWP/Screenshot-2025-04-11-at-4.44.19PM.png\" title=\"Another Zero\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2250x860\" src=\"/user_uploads/thumbnail/3121/70_F-qXVQrVjxRFCpVwwJRWP/Screenshot-2025-04-11-at-4.44.19PM.png/840x560.webp\"></a></div><p>Two ways to get to the <code>Zero</code> for a <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NontriviallyNormedField#doc\">docs#NontriviallyNormedField</a>. They are defeq but not immediately so. Previously only the path through <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=NonUnitalNonAssocCommSemiring#doc\">docs#NonUnitalNonAssocCommSemiring</a> was seen because we were always looking in this context. But in the context of<code>NormSMulClass.toIsBoundedSMul</code> we don't take that path to <code>Zero</code>. Lean has to check these are defeq a few times.</p>",
        "id": 511732201,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744404978
    },
    {
        "content": "<p>Decoupling algebraic typeclasses from <code>Normed*</code> is my next step to speed up searching in the algebraic typeclass hierarchy. But maybe not using Prop-valued typeclasses, rather something like <a href=\"https://github.com/leanprover-community/mathlib/pull/18462\">!3#18462</a>. Otherwise we would have to write <code>[Norm E] [PseudoMetricSpace E] [AddCommGroup E] [IsNormedAddGroup E]</code> for <code>SeminormedAddCommGroup E</code>.</p>",
        "id": 511748204,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1744412809
    },
    {
        "content": "<p>If we have to use Prop-valued typeclasses, maybe we need two new typeclasses to avoid <code>[Norm E] [(Pseudo)MetricSpace E]</code>.</p>",
        "id": 511748851,
        "sender_full_name": "Yuyang Zhao",
        "timestamp": 1744413242
    },
    {
        "content": "<p>I was coming to exactly this sort of conclusion for local fields, wondering if <code>[Field K] [Preorder K] [UniformSpace K]</code> plus some Prop-valued mixins was going to be the way to go</p>",
        "id": 511785458,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744441737
    },
    {
        "content": "<p>(in that theory we don't need the real numbers so the norm is replaced by a preorder and the metric by a uniformity. Here the preorder is defined by  a &lt;= b iff |a|&lt;=|b| where |x| is a nonarchimedean valuation)</p>",
        "id": 511785554,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744441814
    },
    {
        "content": "<p>I left some comments about traces on Eric's PR. I've still not got to the bottom of things.</p>\n<p>If the slowdown is actually about the exact moment that one drops the norm when moving from our \"normed algebra\" typeclass hierarchy to our algebra hierarchy (and more specifically about the fact that <code>NonUnitalNormedCommRing-&gt;NonUnitalCommRing</code> and <code>SeminormedRing-&gt;Ring</code> are different places to cross the border) then I would argue that this is evidence that there is a lot to be gained (not just in this PR but in mathlib in general) from decoupling our normed hierarchy from our algebra hierarchy, just as there was a lot to be gained from the recent decoupling of the algebra hierarchy from the order hierarchy. In fact the same argument would seem to suggest that we should even decouple commutativity of multiplication from the algebra heirarchy and have <code>[Ring R] [IsCommutativeMul R]</code> instead of <code>[Ring R]</code> and <code>[CommRing R]</code>.</p>",
        "id": 511939756,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744576044
    },
    {
        "content": "<p>With current library design (if indeed it is designed as opposed to just being how it is by default) what is the logic behind where we are encouraging the border crossing? Should <code>SeminormedRing.toRing</code> also be low priority? <a href=\"https://github.com/leanprover-community/mathlib4/blob/9f26568c7f5756c52686ff553169277121f65db8/Mathlib/Analysis/Normed/Ring/Basic.lean#L30-L136\">here</a> is what we currently have in mathlib: we have no fewer than 8 classes <code>{NonUnital}{Semi}normed{Comm}Ring</code> intertwined with 12 instances all flagged with the <code>[lower instance priority]</code> note.</p>",
        "id": 511941779,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744577791
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/wfNagE4dWp81klZs5HwIlSwW/IMG_20250413_222335365_HDR.jpg\">IMG_20250413_222335365_HDR.jpg</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/wfNagE4dWp81klZs5HwIlSwW/IMG_20250413_222335365_HDR.jpg\" title=\"IMG_20250413_222335365_HDR.jpg\"><img data-original-content-type=\"image/jpeg\" data-original-dimensions=\"4096x3072\" src=\"/user_uploads/thumbnail/3121/wfNagE4dWp81klZs5HwIlSwW/IMG_20250413_222335365_HDR.jpg/840x560.webp\"></a></div><p>I think that's what mathlib looks like currently, regarding {NonUnital/unital}{non-comm/Comm}{no norm/Seminorm/Norm}ed rings (so non-unital rings in the bottom left up to normed commutative rings in the top right, with seminormed rings in the middle). A red X means that the instance is present but has priority 100. The slightly curvy lines are <code>NonUnitalNormedCommRing.toNonUnitalCommRing</code> (i.e. skip the non-unital seminormed commutative ring) and <code>NormedCommRing.toCommRing</code>. A notable absentee is <code>Seminormed Ring.toRing</code> which presumably has default prio and which Matt explicitly flagged as perhaps causing a problem in the PR (note that SeminormedCommRing.toCommRing has prio 100). I don't know how to find the priority of <code>SeminormedRing.toRing</code>, I guess it could have prio lowered elsewhere. </p>\n<p>What should the logic of the diagram be? Are we being inconsistent and paying for it now?</p>\n<p>Is the picture supposed to be saying \"Here are 12 classes but we really really really don't want you to deduce any of them from any of the others, except that you are allowed to deduce X from CommX\"? Because that it what it says right now. It seems like a very weird set-up to me.</p>",
        "id": 511944669,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744580087
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24011\">#24011</a> for an attempt to at least make the picture symmetric (i.e. \"all lines exist and all but the ones dropping Comm have prio 100\")</p>",
        "id": 511945355,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744580644
    },
    {
        "content": "<p>For what it's worth, in Lean 3 the rule was \"every <code>X.toY</code> instance has priority 100, and only the concrete instances get the default priority\"</p>",
        "id": 511945982,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744581194
    },
    {
        "content": "<p>When we ported that, it became \"<code>X.toY</code> instances not implemented with <code>extends</code> get priority 100\" because that was what mathport did and what Lean 4 supported at the time</p>",
        "id": 511946015,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744581230
    },
    {
        "content": "<p>My initial take is that those curvy lines in your diagram are bad and should be deleted</p>",
        "id": 511946088,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744581284
    },
    {
        "content": "<p>You can't delete <code>NormedCommRing.toCommRing</code> (the top curvy line) because <code>NormedCommRing</code> extends <code>CommRing</code>.</p>",
        "id": 511946162,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744581360
    },
    {
        "content": "<p>It's the normed to seminormed lines which \"aren't really there\" and we're adding them with code like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- see Note [lower instance priority]</span>\n<span class=\"sd\">/-- A normed commutative ring is a seminormed commutative ring. -/</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">priority</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">NormedCommRing</span><span class=\"bp\">.</span><span class=\"n\">toSeminormedCommRing</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">NormedCommRing</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">SeminormedCommRing</span><span class=\"w\"> </span><span class=\"n\">Œ±</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">Œ≤</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 511946297,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744581475
    },
    {
        "content": "<p>Ah, I guess removing those lines is one of the things that (a redo of) <a href=\"https://github.com/leanprover-community/mathlib4/pull/9642\">#9642</a> would address</p>",
        "id": 511946366,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744581517
    },
    {
        "content": "<p>But I guess if we follow that road, we should also delete <code>Semiring.toAddCommMonoid</code> and make it go through unital/assoc classes</p>",
        "id": 511946402,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744581550
    },
    {
        "content": "<p>There is an undrawn curvy <code>NormedRing.toRing</code> line which has prio 1000 if I got my first ever piece of metacode right:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">getInstancePriority?</span><span class=\"w\"> </span><span class=\"ss\">``NormedRing.toRing</span><span class=\"w\"> </span><span class=\"c1\">-- some 1000</span>\n</code></pre></div>\n<p>so we made the 100 prio instance from NormedRing to SeminormedRing but if you're trying to get to Ring you can just go directly there at prio 1000.</p>",
        "id": 511946575,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744581670
    },
    {
        "content": "<p>I can't wait until Jireh tells us that he wants non-associative normed rings because then the number of classes in <code>Mathlib/Analysis/Normed/Ring/Basic.lean</code> goes up from 8 to 16. And then maybe Junyan will insist that we do it all for semirings (note: that's different to seminorms) so we can go up to 32.</p>",
        "id": 511946803,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744581852
    },
    {
        "content": "<p>Then it will be much harder to draw the diagram.</p>",
        "id": 511946836,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744581890
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/511946803\">said</a>:</p>\n<blockquote>\n<p>I can't wait until Jireh tells us that he wants non-associative normed rings because then the number of classes in <code>Mathlib/Analysis/Normed/Ring/Basic.lean</code> goes up from 8 to 16. And then maybe Junyan will insist that we do it all for semirings (note: that's different to seminorms) so we can go up to 32.</p>\n</blockquote>\n<p>Maybe some of these should be mixins then</p>",
        "id": 511960517,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744592673
    },
    {
        "content": "<p>It probably won't be me, but what do you think a JB*-algebras is?</p>",
        "id": 511976380,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744603299
    },
    {
        "content": "<p>Well it's not so easy to make some of them mixins because in the world of rings they're not mixins and this is extending rings.</p>",
        "id": 511997912,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744613874
    },
    {
        "content": "<p>I'm looking forward to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Neg</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Topology</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Uniformity</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Dist</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Norm</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsNormedCommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 512028209,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744622328
    },
    {
        "content": "<p>Full disclosure: I'm not sure whether <span aria-label=\"up\" class=\"emoji emoji-2b06\" role=\"img\" title=\"up\">:up:</span> is me being serious or joking.</p>",
        "id": 512028284,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744622353
    },
    {
        "content": "<p>you sure we won't break it down into <code>NormedMul</code> and <code>IsRing</code> etc instead? <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 512036981,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1744624702
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112680\">@Johan Commelin</span>, you forgot <code>IntCast R</code>, <code>NatCast R</code>, <code>SMul Int R</code>, <code>SMul Nat R</code>, <code>Pow R Nat</code>, <code>Sub R</code>, <code>NNDist R</code> ...</p>",
        "id": 512038539,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744625089
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512038539\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span>, you forgot <code>IntCast R</code>, <code>NatCast R</code>, <code>SMul Int R</code>, <code>SMul Nat R</code>, <code>Pow R Nat</code>, <code>Sub R</code>, <code>NNDist R</code> ...</p>\n</blockquote>\n<p>Those can be added as needed, I know most theorems don't use a natpow</p>",
        "id": 512039937,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744625522
    },
    {
        "content": "<p>This sounds like a catastrophic step backwards in terms of usability.</p>",
        "id": 512040671,
        "sender_full_name": "David Loeffler",
        "timestamp": 1744625758
    },
    {
        "content": "<p>Aaron, only if you're willing to write <code>... [Pow R Nat] [IsRing R] [IsLawfulNatPow R]</code> etc, which is now even worse.</p>",
        "id": 512040845,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744625806
    },
    {
        "content": "<p>I'm not saying this is a good idea</p>",
        "id": 512041011,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744625856
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"481963\">David Loeffler</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512040671\">said</a>:</p>\n<blockquote>\n<p>This sounds like a catastrophic step backwards in terms of usability.</p>\n</blockquote>\n<p><span aria-label=\"100\" class=\"emoji emoji-1f4af\" role=\"img\" title=\"100\">:100:</span> So we would need good elaborator support before considering this approach.<br>\nBut if it actually massively improves TC performance, then I think we should seriously consider how to make this a step forwards in terms of usability.</p>",
        "id": 512045923,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744627592
    },
    {
        "content": "<p>After seeing what happened with ordered algebra, I think this might also be a 40% drop in TC but no one's tried it yet because it massively hurts usability.</p>",
        "id": 512048029,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744628293
    },
    {
        "content": "<p>Eric raised the possibility of <code>variable [Zero R] [One R] [Add R] [Neg R] [Mul R] ...</code> a while ago (i.e. over a year ago). I am beginning to wonder whether Lean 4's typeclass inference system is pushing us towards such a design pattern. </p>\n<p>Having spent many hours over the weekend trying and failing to speed up David's PR, I'm now wondering whether we should bite the bullet and merge it and just note that uncoupling norms from algebra will almost certainly give us the speedup back.</p>",
        "id": 512053598,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744630000
    },
    {
        "content": "<p>I have a few things I'd like to try over the next few days, but otherwise I agree merging soon is reasonable</p>",
        "id": 512054149,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1744630161
    },
    {
        "content": "<p>I mentioned this in another thread (in the context of <code>T2Space</code> vs. <code>R1Space</code> + <code>T0Space</code>), but I think we need to make <code>variable alias</code> (or something like it) standard and usable in practice. The problem with <code>variable?</code> right now is that it does the replacement, and I would prefer it didn't. It would also make Mathlib much more familiar to new users (cf. there was a recent thread about <code>HilbertSpace ùïú E</code> and why that doesn't exist).</p>\n<p>If we did this, then we could still write nice <code>variable</code>lines even if they get expanded to <code>[SomeAlgbraicStructure] [SomeNormStructure] [SomeOrderStructure]</code> (or even further) under the hood.</p>",
        "id": 512154969,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744657878
    },
    {
        "content": "<p>With the (not-so-)new behavior of <code>variable</code> and how they are included in declarations, this wouldn't be too much of a problem. The worst offenders might be things where you have a <code>Module ùïú E</code>, but the statement only references elements of <code>E</code>, and then you would need to <code>include {ùïú}</code>. I'm not sure how widespread an issue that would be.</p>",
        "id": 512155451,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744658026
    },
    {
        "content": "<p>I really pushed for <code>VectorSpace</code> in Lean 3 and eventually we gave it a go, but Lean 3 typeclass wasn't up to the job so it got reverted. If we get <code>variable alias</code> working then we could go back to this idea (and then it would save me telling generations of undergrads that <code>Module</code> is just French for vector space)</p>",
        "id": 512156929,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744658560
    },
    {
        "content": "<p>To be clear, I think we should make this happen regardless of whether we separate everything into atomic classes or not. Simply splitting the algebra, order, analysis hierarchies would be sufficient reason, not to mention Kevin's issue of making everything more readable for the uninitiated.</p>",
        "id": 512157813,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744658882
    },
    {
        "content": "<p>The main design question that I see is how you want to create new instances:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">FooBar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>now has to become</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">FooBar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">FooBar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Add</span><span class=\"w\"> </span><span class=\"n\">FooBar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>How should the elaborator treat</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">HilbertSpace</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span>\n</code></pre></div>",
        "id": 512233093,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744697398
    },
    {
        "content": "<p>Here is a design possibility just for variable declaration. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]]</span>\n</code></pre></div>\n<p>goes through the typeclass assumptions of <code>Module k E</code> (here <code>[Semiring k] [AddCommMonoid E]</code>), checks for each of them if it is available as an instance, and otherwise declares it. So here it would declare under the hood <code>[Semiring k] [AddCommMonoid E] [Module k E]</code>, but in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]]</span>\n</code></pre></div>\n<p>it would only declare <code>[Semiring k] [Module k E]</code>.</p>\n<p>Additionally, one would have a command</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">variable_alias</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">RClike</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">SeminormedAddCommGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">InnerProductSpace</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CompleteSpace</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">HilbertSpace</span>\n</code></pre></div>\n<p>When declaring </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">HilbertSpace</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]]</span>\n</code></pre></div>\n<p>it would do the same as above, i.e., go one by one though the typeclass assumptions in the <code>variable_alias</code> line, and declare them if they can not be synthetized from the context.</p>",
        "id": 512234387,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1744697963
    },
    {
        "content": "<p>As for Johan's question, I would just forbid <code>instance : HilbertSpace k E</code>. To me, this should just be a mechanism for variable declaration. Ideally, it should work both in <code>variable</code> lines and in def or theorem statements, by the way.</p>\n<p>And in an even more ideal world, when hovering over such a declaration one should get the list of the genuine typeclass assumptions that are generated through it.</p>",
        "id": 512234885,
        "sender_full_name": "S√©bastien Gou√´zel",
        "timestamp": 1744698193
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">S√©bastien Gou√´zel</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512234885\">said</a>:</p>\n<blockquote>\n<p>As for Johan's question, I would just forbid <code>instance : HilbertSpace k E</code>. To me, this should just be a mechanism for variable declaration. Ideally, it should work both in <code>variable</code> lines and in def or theorem statements, by the way.</p>\n</blockquote>\n<p>That is fine with me. Especially if the notation in the <code>variable</code> line makes it clear that we're not assuming an ordinary instance.</p>",
        "id": 512237370,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744699311
    },
    {
        "content": "<p>The tricky bit is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">]</span>\n\n<span class=\"c1\">-- stuff happens here</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]]</span>\n</code></pre></div>\n<p>Now we have <code>[Semiring k]</code> and we already have an existing <code>[AddCommGroup k]</code>.</p>",
        "id": 512237900,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1744699453
    },
    {
        "content": "<p>It seems that is an orthogonal problem, for which we are already desperately overdue a linter for! :-)</p>",
        "id": 512242167,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744700787
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512233093\">said</a>:</p>\n<blockquote>\n<p>The main design question that I see is how you want to create new instances:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"n\">FooBar</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">zero</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">one</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p><code>instances</code> which synthesizes the appropriate instance parameters from the environment and the data fields supplied by the user and then builds the <code>Ring</code> instance from those? </p>\n<p>Also, I think the rule of thumb is to ask whether when you go hunting for an instance via a projection you are likely to succeed more often than not across in the library. Mathematically, <code>Norm</code> and <code>TopologicalSpace</code> seem to generally stand a good chance of appearing together so bundling them is reasonable. But <code>Norm</code> and <code>Field</code> is more niche to unbundling is better.</p>",
        "id": 512322456,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744724142
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110050\">S√©bastien Gou√´zel</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512234885\">said</a>:</p>\n<blockquote>\n<p>As for Johan's question, I would just forbid <code>instance : HilbertSpace k E</code>. To me, this should just be a mechanism for variable declaration. Ideally, it should work both in <code>variable</code> lines and in def or theorem statements, by the way.</p>\n<p>And in an even more ideal world, when hovering over such a declaration one should get the list of the genuine typeclass assumptions that are generated through it.</p>\n</blockquote>\n<p>Couldn't have communicated it better myself. S√©bastien's proposal is exactly what I envision.</p>",
        "id": 512331591,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744726286
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512242167\">said</a>:</p>\n<blockquote>\n<p>It seems that is an orthogonal problem, for which we are already desperately overdue a linter for! :-)</p>\n</blockquote>\n<p>I had a linter that was flagging when a typeclass assumption in <code>variable</code> was syntesizable from the <code>variable</code>s already present.</p>",
        "id": 512331963,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744726359
    },
    {
        "content": "<p>This happens <em>everywhere</em>, though...</p>",
        "id": 512332008,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744726369
    },
    {
        "content": "<p>Let me find the branch</p>",
        "id": 512332072,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744726384
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14731\">#14731</a> is the linter.</p>",
        "id": 512332545,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744726482
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24086\">#24086</a> tries to avoid the path through <code>toComm(Semi)Ring</code> when possible. <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 512356434,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1744732054
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512332008\">said</a>:</p>\n<blockquote>\n<p>This happens <em>everywhere</em>, though...</p>\n</blockquote>\n<p>It does? That seems like not something we want. I'm confused.</p>",
        "id": 512358639,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1744732688
    },
    {
        "content": "<p>Let me revise this a little: it is not too widespread and I mention something in <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/recyclable.20variables/near/512361862\">#mathlib4 &gt; recyclable variables @ üí¨</a>.</p>",
        "id": 512362524,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744733756
    },
    {
        "content": "<p>I think that there are <del>168</del>154 such situations, at least these are the ones that the linter notices.</p>",
        "id": 512362663,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1744733790
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Normed.20modules/near/512054149\">said</a>:</p>\n<blockquote>\n<p>I have a few things I'd like to try over the next few days, but otherwise I agree merging soon is reasonable</p>\n</blockquote>\n<p>Soon was a lie, but I managed to shave off 1% (as a fraction of the overhead, not the total build time)</p>",
        "id": 515627740,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746155573
    }
]