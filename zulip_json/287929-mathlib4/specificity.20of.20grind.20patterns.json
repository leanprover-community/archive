[
    {
        "content": "<p>How should I be thinking about whether a grind pattern is specific enough?</p>\n<p>I am working with finsets right now but I see</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">activated</span><span class=\"w\"> </span><span class=\"ss\">`Multiset.notMem_zero</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">Membership</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">OfNat</span><span class=\"bp\">.</span><span class=\"n\">ofNat</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">activated</span><span class=\"w\"> </span><span class=\"ss\">`Set.mem_insert_iff</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">Membership</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">activated</span><span class=\"w\"> </span><span class=\"ss\">`Set.subset_insert</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">]</span>\n<span class=\"o\">[</span><span class=\"n\">grind</span><span class=\"bp\">.</span><span class=\"n\">ematch</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">activated</span><span class=\"w\"> </span><span class=\"ss\">`Multiset.mem_add</span><span class=\"bp\">`</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">@</span><span class=\"n\">Membership</span><span class=\"bp\">.</span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">HAdd</span><span class=\"bp\">.</span><span class=\"n\">hAdd</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">2</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>looks like those do not have <code>Multiset</code> or <code>Set</code> anywhere in the pattern. Is that OK? And how does grind determine to put <code>Set</code> / <code>Multiset</code> in the pattern vs not?</p>",
        "id": 540569399,
        "sender_full_name": "Lawrence Wu (llllvvuu)",
        "timestamp": 1758356259
    },
    {
        "content": "<p>So those only cost my theorem 9 heartbeats, but in contrast I put a grind annotation I thought was reasonable (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finsupp.mem_support_iff#doc\">docs#Finsupp.mem_support_iff</a>, which yielded the innocuous-looking-to-me grind pattern <code>[@Membership.mem #4 (Finset _) _ (@support _ #3 #2 #1) #0]</code>) and it blew up some theorems, like <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=MonoidAlgebra.support_single_mul_eq_image#doc\">docs#MonoidAlgebra.support_single_mul_eq_image</a> from 1340 to 3874 heartbeats, with the main changes in the <code>trace.grind.debug</code> output being things like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">IntModule</span><span class=\"bp\">.</span><span class=\"n\">OfNatModule</span><span class=\"bp\">.</span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">55</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"mi\">55</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">toGrindNatModule</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">56</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"mi\">56</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">NonUnitalNonAssocSemiring</span><span class=\"bp\">.</span><span class=\"n\">toAddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">11</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"mi\">57</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">AddCommMonoid</span><span class=\"bp\">.</span><span class=\"n\">toZero</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">58</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"mi\">58</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">NatModule</span><span class=\"bp\">.</span><span class=\"n\">toAddCommMonoid</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">59</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"mi\">59</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">IntModule</span><span class=\"bp\">.</span><span class=\"n\">toNatModule</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">60</span>\n<span class=\"w\">    </span><span class=\"bp\">#</span><span class=\"mi\">60</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Grind</span><span class=\"bp\">.</span><span class=\"n\">IntModule</span><span class=\"bp\">.</span><span class=\"n\">OfNatModule</span><span class=\"bp\">.</span><span class=\"n\">ofNatModule</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"mi\">55</span>\n</code></pre></div>\n<p>Is there a way I can get better at predicting these things?</p>",
        "id": 540573165,
        "sender_full_name": "Lawrence Wu (llllvvuu)",
        "timestamp": 1758360913
    },
    {
        "content": "<p>Interestingly, the generated patterns are different for <code>Set</code> and <code>Finset</code>s:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">mem_insert_iff</span>\n<span class=\"c1\">-- @Membership.mem α (Set α) Set.instMembership (insert a s) x</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_insert</span>\n<span class=\"c1\">-- @Membership.mem α (Finset α) Finset.instMembership (insert b s) a</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">grind?</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">mem_insert_iff</span>\n<span class=\"c1\">-- Set.mem_insert_iff: [@Membership.mem #3 _ _ (@insert _ _ _ #1 #0) #2]</span>\n<span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">grind?</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_insert</span>\n<span class=\"c1\">-- Finset.mem_insert: [@Membership.mem #4 (Finset _) _ (@insert _ (Finset _) _ #0 #2) #1]</span>\n</code></pre></div>\n<p>What are the rules for which implicit parameters get into the grind pattern? I couldn't find that in the reference manual</p>",
        "id": 540696143,
        "sender_full_name": "Lawrence Wu (llllvvuu)",
        "timestamp": 1758503060
    },
    {
        "content": "<p>Oh, could it be that <code>grind</code> is unfolding <code>Set α</code>, into <code>α → Prop</code>?</p>",
        "id": 540741992,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758530671
    },
    {
        "content": "<p>Good argument for packaging that into a struct...</p>",
        "id": 540831085,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1758553938
    },
    {
        "content": "<p>That refactor is going to be a nightmare though</p>",
        "id": 540831465,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758554016
    },
    {
        "content": "<p>I suppose for similar reasons it is having trouble with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Multiset</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Quotient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"bp\">.</span><span class=\"n\">isSetoid</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 540832288,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1758554192
    }
]