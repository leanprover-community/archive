[
    {
        "content": "<p>It seems that <code>#allow_unused_tactic</code> that allows to silence the unused tactic linter does not work across files. I want to define a tactic and make sure it is never flagged.</p>",
        "id": 491417684,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735661740
    },
    {
        "content": "<p>Is this possible?</p>",
        "id": 491417694,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735661748
    },
    {
        "content": "<p>Actually, the unxy-ed version is I would be very happy if this linter would consider that anything that changes the tactic state is used, even if it is the same up to defeq. The current implementation of the linter explicitly whitelists <code>change</code>.</p>",
        "id": 491417839,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735661832
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span></p>",
        "id": 491583021,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735809744
    },
    {
        "content": "<p>First, an answer the original question.</p>\n<p>I had thought about making a persistent <code>#allow_unused_tactic</code>: I think that this would be useful at least downstream.  For instance, I used <code>by ... done</code> when I teach and right now I have to <code>allow</code> <code>done</code> in every file.</p>",
        "id": 491709243,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735883714
    },
    {
        "content": "<p>The persistent version could be implemented by adding an environment extension that stores the unused tactics that are allowed.  This would mean that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Tactic.allowedRef#doc\">docs#Mathlib.Tactic.allowedRef</a> (the <code>IO.Ref</code> that currently stores the allowed tactics) could be removed in favour of a dynamic implementation, by allowing each tactic at the point of definition, rather than up front, when the linter is defined.</p>",
        "id": 491709248,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735883719
    },
    {
        "content": "<p>I still think that the current file-only exclusion is valuable, so my preference would be to add <code>#allow_unused_tactic!</code> that is persistent, while keeping also the current <code>#allow_unused_tactic</code> unchanged.</p>",
        "id": 491709257,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735883723
    },
    {
        "content": "<p>For the second part, the implementation does not actually use <code>isDefEq</code>, but looks at whether there is a change in the list of metavariables (i.e. their <em>name</em>) and tactics such as <code>change</code> actually do modify the metavariable.</p>",
        "id": 491711767,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735885517
    },
    {
        "content": "<p>Can you give an example of a situation where you would like the linter to not flag a tactic as unused?  I would probably consider this a bug in the linter, rather than a tactic that should be allowed.</p>",
        "id": 491711772,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735885522
    },
    {
        "content": "<p>In fact, <a href=\"https://github.com/leanprover-community/mathlib4/pull/20412\">#20412</a> removes <code>change</code> from the allowed tactics: let's see if the linter flags something that it should not in mathlib!</p>",
        "id": 491711775,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735885527
    },
    {
        "content": "<p>I just looked at the first 3 exceptions flagged by the linter with <code>change</code> being in scope, and they are all situations where the infoview shows no difference.</p>",
        "id": 491712200,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735885832
    },
    {
        "content": "<p>I went through all the exceptions and they were all situations where the infoview showed no difference before and after <code>change</code>.</p>",
        "id": 491715526,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735888477
    },
    {
        "content": "<p>In one situation, this allowed the removal of a porting note.</p>",
        "id": 491715547,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735888501
    },
    {
        "content": "<p>The PR above incorporates also the cleanup.</p>",
        "id": 491715559,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735888506
    },
    {
        "content": "<p>Looks great!</p>",
        "id": 491727338,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735895476
    },
    {
        "content": "<p>Thanks Damiano! I’m very happy that this question helped cleaning up a bit.</p>",
        "id": 491737275,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735900514
    },
    {
        "content": "<p>Patrick, are you still interested in the persistent form of <code>#allow_unused_tactic</code>?</p>",
        "id": 491754341,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735909132
    },
    {
        "content": "<p>Sure!</p>",
        "id": 491754589,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735909244
    },
    {
        "content": "<p>I cannot really check that the latest change to the linter is enough for me because I haven’t updated Verbose Lean to Lean 4.15.0-rc1 because of the token issue with white spaces.</p>",
        "id": 491754706,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735909302
    },
    {
        "content": "<p>But I’m sure this is a useful command anyway.</p>",
        "id": 491754741,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735909318
    },
    {
        "content": "<p>You mentioned a custom tactic: maybe you could test on Mathlib's master where you add a stub of your tactic.</p>",
        "id": 491754835,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735909345
    },
    {
        "content": "<p>(However, the current version of <code>#allow_unused_tactic</code> is certainly not persistent and it only works in the file where it is written.)</p>",
        "id": 491754927,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735909380
    },
    {
        "content": "<p>With respect to the persistent unused tactic issue: should I completely remove the current exceptions <code>IO.Ref</code>, in favor of extending the to-be-created environment extension?</p>",
        "id": 491756178,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735909962
    },
    {
        "content": "<p>Mathlib master doesn’t help with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"rename_bvar' \"</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"s2\">\" → \"</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"n\">loc?</span><span class=\"o\">:(</span><span class=\"n\">location</span><span class=\"o\">)</span><span class=\"bp\">?</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"n\">rename_bvar</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">old</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">[</span><span class=\"bp\">$</span><span class=\"n\">loc?</span><span class=\"o\">]</span><span class=\"bp\">?</span><span class=\"o\">)</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hnk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∃</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rename_bvar'</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hnk</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 491756574,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735910146
    },
    {
        "content": "<p>Using <code>rename_bvar</code> instead of <code>rename_bvar'</code> works because it is whitelisted.</p>",
        "id": 491756657,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735910174
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20438\">#20438</a> implements the persistent version of <code>#allow_unused_tactic</code>.  The PR contains both versions:</p>\n<ul>\n<li><code>#allow_unused_tactic ids</code>, the non-persistent command that is already in Mathlib;</li>\n<li><code>#allow_unused_tactic! ids</code> the persistent command that is new to the PR.</li>\n</ul>",
        "id": 491764413,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735913948
    },
    {
        "content": "<p>The persistence is achieved through an environment extension, which means that in order to use it, it needs to be in a separate file.  All of Mathlib serves as a test for persistence, since I used <code>#allow_unused_tactic! ids</code> for a few tactics that before were in the <code>IO.Ref</code>.</p>",
        "id": 491764421,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735913952
    },
    {
        "content": "<p>Besides moving code around, the PR basically introduces the extension and uses it almost minimally.  I opted for not moving the exceptions to the files where the tactics are defined.</p>",
        "id": 491764427,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735913955
    },
    {
        "content": "<p>If this is something that is used frequently, then maybe we can also think a little about how to input the tactics that should be ignored: the <code>SyntaxNodeKind</code> is not really how I would identify a tactic and there is a layer of obscurity between wanting to allow <code>refine</code> to be unused and realizing that it is really <code>Lean.Parser.Tactic.refine</code> that should be used.</p>",
        "id": 491766636,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735915165
    },
    {
        "content": "<p>Even something as simple-minded as</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#show_kind \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">t</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"The `SyntaxNodeKind` is '{stx.raw.getKind}'\"</span>\n\n<span class=\"c1\">--  The `SyntaxNodeKind` is 'Lean.Parser.Tactic.refine'</span>\n<span class=\"bp\">#</span><span class=\"n\">show_kind</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>could be useful.</p>",
        "id": 491766904,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735915317
    },
    {
        "content": "<p>Ironically, this PR doesn’t pass linting CI.</p>",
        "id": 491777022,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735920081
    },
    {
        "content": "<p>I also realized from the other thread that I probably want to simply disable (all?) linters in my course material.</p>",
        "id": 491777107,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1735920118
    },
    {
        "content": "<p>I pushed what I think is a fix for the linting!</p>",
        "id": 491777554,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735920327
    },
    {
        "content": "<p>CI passed and I also added the <code>#show_kind</code> command to the PR.</p>",
        "id": 491783596,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735923417
    },
    {
        "content": "<p>The persistent form of <code>#allow_unused_tactic</code> just made it into mathlib <code>master</code>.  Using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">allow_unused_tactic!</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">done</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">skip</span>\n</code></pre></div>\n<p>should make the linter ignore <code>done</code> and <code>skip</code> from where the command is issued onwards, also on files imported by the file where the command is issued.</p>",
        "id": 498770003,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739196237
    }
]