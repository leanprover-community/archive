[
    {
        "content": "<p>Right now on master, this commit</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">commit</span><span class=\"w\"> </span><span class=\"mi\">258</span><span class=\"n\">b485d4252a0cb5049ee25e87107830f13b7d1</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">HEAD</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">master</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">upstream</span><span class=\"bp\">/</span><span class=\"n\">update</span><span class=\"bp\">-</span><span class=\"n\">dependencies</span><span class=\"bp\">-</span><span class=\"n\">bot</span><span class=\"bp\">-</span><span class=\"n\">use</span><span class=\"bp\">-</span><span class=\"n\">only</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">upstream</span><span class=\"bp\">/</span><span class=\"n\">master</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">upstream</span><span class=\"bp\">/</span><span class=\"n\">HEAD</span><span class=\"o\">)</span>\n<span class=\"n\">Author</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Kim</span><span class=\"w\"> </span><span class=\"n\">Morrison</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"mi\">477956</span><span class=\"bp\">+</span><span class=\"n\">kim</span><span class=\"bp\">-</span><span class=\"n\">em</span><span class=\"bp\">@</span><span class=\"n\">users</span><span class=\"bp\">.</span><span class=\"n\">noreply</span><span class=\"bp\">.</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">&gt;</span>\n<span class=\"n\">Date</span><span class=\"o\">:</span><span class=\"w\">   </span><span class=\"n\">Tue</span><span class=\"w\"> </span><span class=\"n\">Oct</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"o\">:</span><span class=\"mi\">15</span><span class=\"o\">:</span><span class=\"mi\">21</span><span class=\"w\"> </span><span class=\"mi\">2025</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"mi\">1100</span>\n\n<span class=\"w\">    </span><span class=\"n\">chore</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">bump</span><span class=\"bp\">/</span><span class=\"n\">v4</span><span class=\"bp\">.</span><span class=\"m\">25</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"mi\">30740</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I tried <code>rm -rf .lake</code> and then <code>lake exe cache get</code> and then <code>lake build</code> and I'm getting</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@IC-HWDXTW69VR Mathlib % lake build\n✖ [28/478] Replaying ImportGraph.RequiredModules\nerror: no such file or directory (error code: 2)\n  file: /Users/buzzard/Lean/Projects/Mathlib/.lake/packages/importGraph/.lake/build/lib/lean/ImportGraph/RequiredModules.ir\n✖ [56/478] Replaying Qq.Macro\nerror: no such file or directory (error code: 2)\n  file: /Users/buzzard/Lean/Projects/Mathlib/.lake/packages/Qq/.lake/build/lib/lean/Qq/Macro.ir\n✖ [426/1574] Replaying Plausible.Arbitrary\nerror: no such file or directory (error code: 2)\n  file: /Users/buzzard/Lean/Projects/Mathlib/.lake/packages/plausible/.lake/build/lib/lean/Plausible/Arbitrary.ir\n✖ [435/1574] Replaying LeanSearchClient.Basic\nerror: no such file or directory (error code: 2)\n  file: /Users/buzzard/Lean/Projects/Mathlib/.lake/packages/LeanSearchClient/.lake/build/lib/lean/LeanSearchClient/Basic.ir\nSome required targets logged failures:\n- ImportGraph.RequiredModules\n- Qq.Macro\n- Plausible.Arbitrary\n- LeanSearchClient.Basic\nerror: build failed\nbuzzard@IC-HWDXTW69VR Mathlib %\n</code></pre></div>\n<p>Can anyone else reproduce?</p>",
        "id": 546193405,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761041508
    },
    {
        "content": "<p>This also seems to be the reason for all of the failures in <a class=\"stream-topic\" data-stream-id=\"116290\" href=\"/#narrow/channel/116290-rss/topic/mathlib.20bors.20notifications/with/546193054\">#rss &gt; mathlib bors notifications</a> so mathlib is standing still right now. We might have to revert the bump to 4.25.0 until we understand what's going wrong here. cc <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span></p>",
        "id": 546193757,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1761041627
    },
    {
        "content": "<p>Hi there,<br>\nI just pushed a small commit to <a href=\"https://github.com/leanprover-community/mathlib4/pull/30130\">#30130</a> but CI failed (after an hour). But strangely, there were no build errors. It just said that it wasn't able to \"verify that everything is available in the cache\".<br>\n<a href=\"/user_uploads/3121/Hsuo8fQ6FAbK-xiD1Ygmdb1d/image.png\">image.png</a><br>\n To me, this seems like somethings that could be fixed by just rerunning CI, but I can't find the button that does this... (Does a normal user even have the permission to do this?).</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Hsuo8fQ6FAbK-xiD1Ygmdb1d/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"815x204\" src=\"/user_uploads/thumbnail/3121/Hsuo8fQ6FAbK-xiD1Ygmdb1d/image.png/840x560.webp\"></a></div>",
        "id": 546193909,
        "sender_full_name": "Christian Krause",
        "timestamp": 1761041688
    },
    {
        "content": "<p>Note that if you skip the <code>lake exe cache get</code> step it seems to build just fine.</p>",
        "id": 546194067,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1761041738
    },
    {
        "content": "<p>Yes, there were some significant changes to the cache as part of the 4.25.0 bump</p>",
        "id": 546194257,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1761041804
    },
    {
        "content": "<p>Probably related to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/compilation.20error.20on.20master.3F/with/546194257\">#mathlib4 &gt; compilation error on master?</a></p>",
        "id": 546194424,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1761041853
    },
    {
        "content": "<p>Ohh, yes, probably, I did not see the topic before writing this</p>",
        "id": 546194570,
        "sender_full_name": "Christian Krause",
        "timestamp": 1761041905
    },
    {
        "content": "<p>I've put <a href=\"https://github.com/leanprover-community/mathlib4/pull/30747\">#30747</a> (reverting the bump) on the queue with high priority. If it fails to go through we may have to merge manually.</p>",
        "id": 546199465,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1761043438
    },
    {
        "content": "<p>Thanks all, just back at my computer now and taking a look.</p>",
        "id": 546200985,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761043971
    },
    {
        "content": "<p>I'm pretty sure I see what has happened. </p>\n<p>Current (broken) master is <code>258b485d4252</code>, while the (successful) commit on <code>nightly-testing</code> that was the culmination of getting everything ready for <code>v4.25.0-rc1</code> was <code>1b84b44509b73ac56eccb48879e3956a6d0b4b03</code>.</p>\n<p>The diff between these is </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"c1\">--git a/Cache/IO.lean b/Cache/IO.lean</span>\n<span class=\"n\">index</span><span class=\"w\"> </span><span class=\"mi\">82</span><span class=\"n\">c2d7e1682</span><span class=\"bp\">..</span><span class=\"m\">1438</span><span class=\"n\">cc079f3</span><span class=\"w\"> </span><span class=\"mi\">100644</span>\n<span class=\"c1\">--- a/Cache/IO.lean</span>\n<span class=\"bp\">+++</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">/</span><span class=\"n\">Cache</span><span class=\"bp\">/</span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">@@</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">90</span><span class=\"o\">,</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"mi\">90</span><span class=\"o\">,</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"bp\">@@</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getLeanTar</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\"> </span><span class=\"sd\">/-- Bump this number to invalidate the cache, in case the existing hashing inputs are insufficient.</span>\n<span class=\"sd\"> It is not a global counter, and can be reset to 0 as long as the lean githash or lake manifest has</span>\n<span class=\"sd\"> changed since the last time this counter was touched. -/</span>\n<span class=\"bp\">-</span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rootHashGeneration</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">3</span>\n<span class=\"bp\">+</span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">rootHashGeneration</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">UInt64</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"w\"> </span><span class=\"sd\">/--</span>\n<span class=\"sd\"> `CacheM` stores the following information:</span>\n<span class=\"sd\">@@ -321,10 +321,10 @@ def mkBuildPaths (mod : Name) : CacheM &lt;| List (FilePath × Bool) := do</span>\n<span class=\"sd\">     (packageDir / LIBDIR / path.withExtension \"olean.private.hash\", false),</span>\n<span class=\"sd\">     (packageDir / LIBDIR / path.withExtension \"ilean\", true),</span>\n<span class=\"sd\">     (packageDir / LIBDIR / path.withExtension \"ilean.hash\", true),</span>\n<span class=\"sd\">-    (packageDir / LIBDIR / path.withExtension \"ir\", false),</span>\n<span class=\"sd\">-    (packageDir / LIBDIR / path.withExtension \"ir.hash\", false),</span>\n<span class=\"sd\">     (packageDir / IRDIR  / path.withExtension \"c\", true),</span>\n<span class=\"sd\">     (packageDir / IRDIR  / path.withExtension \"c.hash\", true),</span>\n<span class=\"sd\">+    -- (packageDir / LIBDIR / path.withExtension \"ir\", true),</span>\n<span class=\"sd\">+    -- (packageDir / LIBDIR / path.withExtension \"ir.hash\", true),</span>\n<span class=\"sd\">     (packageDir / LIBDIR / path.withExtension \"extra\", false)]</span>\n\n<span class=\"sd\"> /-- Check that all required build files exist. -/</span>\n</code></pre></div>",
        "id": 546201959,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044276
    },
    {
        "content": "<p>I'm not quite sure how I managed to get that into the PR I squash merged into <code>master</code>... :-(</p>",
        "id": 546202039,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044303
    },
    {
        "content": "<p>But it would explain neatly the observed failure.</p>",
        "id": 546202069,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044311
    },
    {
        "content": "<p>So I propose pulling <a href=\"https://github.com/leanprover-community/mathlib4/pull/30747\">#30747</a> off, and just applying that diff to master.</p>",
        "id": 546202149,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044336
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/30748\">#30748</a></p>",
        "id": 546202788,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044535
    },
    {
        "content": "<p>Sad, that is failing. :-(</p>",
        "id": 546203187,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044677
    },
    {
        "content": "<p>Not my day.</p>",
        "id": 546203203,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044681
    },
    {
        "content": "<p>Putting <a href=\"https://github.com/leanprover-community/mathlib4/pull/30747\">#30747</a> back on the queue ...</p>",
        "id": 546203358,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044726
    },
    {
        "content": "<p>Try bumping <code>rootHashGeneration</code> as part of <a href=\"https://github.com/leanprover-community/mathlib4/pull/30748\">#30748</a> to get rid of the bad cache?</p>",
        "id": 546203503,
        "sender_full_name": "Markus Himmel",
        "timestamp": 1761044768
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/30748\">#30748</a> was already doing that!</p>",
        "id": 546203547,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044783
    },
    {
        "content": "<p>AH.</p>",
        "id": 546203552,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044785
    },
    {
        "content": "<p>The problem is that we are using the old <code>cache</code> in CI.</p>",
        "id": 546203583,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044794
    },
    {
        "content": "<p>So I think we actually just have to be brave and trust that <a href=\"https://github.com/leanprover-community/mathlib4/pull/30748\">#30748</a> is actually right, and merge it without CI.</p>",
        "id": 546203634,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044811
    },
    {
        "content": "<p>Lovely.</p>",
        "id": 546203667,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044818
    },
    {
        "content": "<p>(This is a consequence of our new security procedures not allowing changes to <code>cache</code> in the same PR!)</p>",
        "id": 546203760,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044844
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/30748\">#30748</a> <em>should</em> make master identical to a commit on nightly-testing that succeeded...</p>",
        "id": 546203900,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044894
    },
    {
        "content": "<p>So I think I'm going to go for it. :-)</p>",
        "id": 546203931,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044906
    },
    {
        "content": "<p>We'll then know approximately ~45 minutes later, as CI will run on the push to master, with the new <code>cache</code>.</p>",
        "id": 546204121,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761044975
    },
    {
        "content": "<p>We really need to work out a workflow here so that a maintainer can override the restriction about not using <code>cache</code> from the PR...</p>",
        "id": 546204191,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761045000
    },
    {
        "content": "<p>Okay, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/18681884710/job/53264697924\">https://github.com/leanprover-community/mathlib4/actions/runs/18681884710/job/53264697924</a> is the workflow run on for the new attempt at <code>master</code>.</p>",
        "id": 546204461,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761045077
    },
    {
        "content": "<p><span aria-label=\"popcorn\" class=\"emoji emoji-1f37f\" role=\"img\" title=\"popcorn\">:popcorn:</span></p>",
        "id": 546204481,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761045084
    },
    {
        "content": "<p>And now <code>lake exe cache get; lake build</code> works! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 546208427,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1761046195
    },
    {
        "content": "<p>Thank you all!</p>",
        "id": 546209392,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761046469
    },
    {
        "content": "<p>Same here!</p>",
        "id": 546212707,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1761047278
    },
    {
        "content": "<p>I find it odd that <code>lake build</code> now takes 11 seconds for the \"computing jobs\" step, even if to do nothing. (It used to be faster, my computer uses Linux and is quite good.) But this is clearly not an error about the cache.</p>",
        "id": 546212883,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1761047321
    },
    {
        "content": "<p>Is it actually single-threaded during those 11 seconds?</p>",
        "id": 546214415,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761047663
    },
    {
        "content": "<p>Oh I've been having this problem on my new Mac laptop, it drives me nuts! Edit: actually the thing which drives me nuts is the 10 second pause <em>before</em> \"computing jobs\" even appears.</p>",
        "id": 546309929,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1761073894
    },
    {
        "content": "<p>In my system tray (GNOME on Debian trixie), I see all CPUs are (close to) 100% utilisation for that time. Apparently, I have 20 of them. (Not sure if that's physical or logical cores; you get the idea.) That means \"no, not single-threaded\", right?</p>",
        "id": 546327543,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1761080619
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 546327706,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1761080699
    },
    {
        "content": "<p>The output of <code>time lake build</code> (on 3218e4a7b146eea135d23dbeccdf73f7a1921a32 a.k.a. current head, after getting cache) confirms this: 182s of <code>user</code> time.</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Full output</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>$ time lake build<br>\n⡿ [2559/2647] Running Mathlib.CategoryTheory.Bicategory.LocallyDiscrete (+ 17 mo⣾ [2919/3096] Running Mathlib.CategoryTheory.Preadditive.Projective.Preserves (+⣷ [3015/3157] Running Mathlib.RingTheory.UniqueFactorizationDomain.FactorSet (+ ⣽ [3509/4651] Running Mathlib.AlgebraicTopology.SimplexCategory.Augmented.Basic ⣾ [4099/5127] Running Mathlib.CategoryTheory.Preadditive.Yoneda.Projective (+ 19⣯ [4242/5214] Running Mathlib.CategoryTheory.Abelian.SerreClass.MorphismProperty⣻ [4496/5448] Running Mathlib.CategoryTheory.Localization.LocallySmall (+ 17 mor⣽ [4550/5497] Running Mathlib.CategoryTheory.Monoidal.OfHasFiniteProducts (+ 20 ⣯ [5552/6621] Running Mathlib.Topology.Algebra.Constructions.DomMulAct (+ 19 mor⣟ [5601/6667] Running Mathlib.NumberTheory.ClassNumber.AdmissibleAbsoluteValue (⡿ [5653/6728] Running Mathlib.RingTheory.Ideal.IsPrincipalPowQuotient (+ 19 more⢿ [5709/6771] Running Mathlib.Topology.Algebra.InfiniteSum.GroupCompletion (+ 18⣾ [5855/6919] Running Mathlib.Probability.ProbabilityMassFunction.Basic (+ 19 mo⣟ [5990/7085] Running Mathlib.RingTheory.LocalRing.ResidueField.Fiber (+ 19 more⣻ [6453/7248] Running Mathlib.Topology.Maps.Proper.CompactlyGenerated (+ 19 more⣾ [6737/7336] Running Mathlib.Topology.Separation.LinearUpperLowerSetTopology (+⣯ [6852/7389] Running Mathlib.Topology.MetricSpace.HausdorffDimension (+ 20 more⣯ [7180/7396] Running Mathlib.Probability.Process.PartitionFiltration (+ 17 more⣟ [7214/7396] Running Mathlib.Probability.Process.PartitionFiltration (+ 18 more⡿ [7257/7396] Running Mathlib.Probability.Moments.CovarianceBilinDual (+ 18 more⣻ [7321/7396] Running Mathlib.Probability.Moments.CovarianceBilinDual (+ 10 moreBuild completed successfully (7396 jobs).</p>\n<p>real    0m17,836s<br>\nuser    3m2,266s<br>\nsys 0m2,300s</p>\n</div></div>",
        "id": 546328758,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1761081134
    },
    {
        "content": "<p>I have Intel i7-12700H CPUs, i.e. not \"ancient and slow\".</p>",
        "id": 546328858,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1761081177
    },
    {
        "content": "<p>I came across the same issue with my PR that I started before the update. Merging the most recent version of the master branch seems to have fixed it. I don't really understand the discussion here, but as a tl;dr for folks like me - is merging to a newer version of master the right thing to do?</p>",
        "id": 546990759,
        "sender_full_name": "joseph hua",
        "timestamp": 1761335635
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133584\">joseph hua</span> <a href=\"#narrow/channel/287929-mathlib4/topic/compilation.20error.20on.20master.3F/near/546990759\">said</a>:</p>\n<blockquote>\n<p>is merging to a newer version of master the right thing to do?</p>\n</blockquote>\n<p>the usual right thing to do is to go to zulip and see if someone else already reported it (90% of the case the answer will be yes) and then follow that thread until Kim figures out how to fix the problem and then celebrate by merging mathlib master</p>",
        "id": 546993118,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761336717
    }
]