[
    {
        "content": "<p>Is this expected? I assumed <code>Rat.divInt</code> was an implementation detail.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ ↑a * ↑b / ↑c = 1</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"c1\">-- expecting : ↑(a * b) / ↑c = 1</span>\n<span class=\"w\">  </span><span class=\"c1\">-- actual result:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ Rat.divInt (a * b) c = 1</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 498505316,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739023845
    },
    {
        "content": "<p>I've got an issue filled for something pretty similar</p>",
        "id": 498506287,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1739024696
    },
    {
        "content": "<p>That was <a href=\"https://github.com/leanprover-community/mathlib4/pull/11573\">#11573</a></p>",
        "id": 498506327,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1739024734
    },
    {
        "content": "<p>darn it, I already thumbsed it up :-) I searched for <code>Rat.divInt</code> before posting but yours was <code>Int.negSucc</code> :-)</p>",
        "id": 498510418,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739028033
    },
    {
        "content": "<p>I ran into a third form of this problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ ↑a + ↑b - ↑c = 1</span>\n<span class=\"w\">  </span><span class=\"n\">norm_cast</span>\n<span class=\"w\">  </span><span class=\"c1\">-- expecting : ↑(a + b) - ↑c = 1</span>\n<span class=\"w\">  </span><span class=\"c1\">-- actual result:</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ Int.subNatNat (a + b) c = 1</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Even more surprisingly, <code>push_cast</code> doesn't get rid of the <code>Int.subNatNat</code>.</p>\n<p>The relevant lemma is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">norm_cast</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cast_subNatNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">subNatNat</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℤ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 499072607,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1739298318
    },
    {
        "content": "<p>This latter example works as expected (<code>↑(a + b) - ↑c = 1</code>) in <code>Mathlib.Algebra.Ring.Int.Defs</code> just before <code>instance instCommRing : CommRing ℤ where ...</code> and gives the wacky answer just after. Changing <code>norm_cast</code> to <code>norm_cast squash</code> in <code>cast_subNatNat</code> does not seem to fix it. Note that <code>cast_subNatNat</code> is defined in <code>Mathlib.Data.Int.Cast.Basic</code>, which is imported by <code>Mathlib.Algebra.Ring.Int.Defs</code> so you don't see the effect immediately, you also need to import the ring instance on Int for the problems to start.</p>",
        "id": 499077560,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739299986
    },
    {
        "content": "<p>None of <code>norm_cast squash</code>, <code>norm_cast move</code> and <code>norm_cast elim</code> seem to have any effect on the issue.</p>",
        "id": 499077995,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1739300139
    }
]