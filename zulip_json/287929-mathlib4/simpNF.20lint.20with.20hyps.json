[
    {
        "content": "<p>For <code>linter claims that LHS doesn't simplify, but it does</code>, it seems that the <code>simpNF</code> linter runs <code>simp</code> instead of <code>simp [*]</code>, which is why <code>simpNF</code> can't simplify the LHS. Should this be changed?</p>",
        "id": 514787769,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745839546
    },
    {
        "content": "<p>That sounds good to me</p>",
        "id": 514796379,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745842007
    },
    {
        "content": "<p>Would a patch like this make sense?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"c1\">--git a/Batteries/Tactic/Lint/Simp.lean b/Batteries/Tactic/Lint/Simp.lean</span>\n<span class=\"n\">index</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"n\">e83431d</span><span class=\"bp\">..</span><span class=\"n\">ce585f5d</span><span class=\"w\"> </span><span class=\"mi\">100644</span>\n<span class=\"c1\">--- a/Batteries/Tactic/Lint/Simp.lean</span>\n<span class=\"bp\">+++</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">/</span><span class=\"n\">Batteries</span><span class=\"bp\">/</span><span class=\"n\">Tactic</span><span class=\"bp\">/</span><span class=\"n\">Lint</span><span class=\"bp\">/</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n<span class=\"bp\">@@</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">109</span><span class=\"o\">,</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"mi\">109</span><span class=\"o\">,</span><span class=\"mi\">18</span><span class=\"w\"> </span><span class=\"bp\">@@</span><span class=\"w\"> </span><span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">.</span><span class=\"n\">github</span><span class=\"bp\">.</span><span class=\"n\">io</span><span class=\"bp\">/</span><span class=\"n\">mathlib_docs</span><span class=\"bp\">/</span><span class=\"n\">notes</span><span class=\"bp\">.</span><span class=\"n\">html</span><span class=\"bp\">#</span><span class=\"n\">simp</span><span class=\"bp\">-</span><span class=\"n\">normal</span><span class=\"bp\">%</span><span class=\"mi\">20</span><span class=\"n\">for</span>\n<span class=\"w\">   </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">     </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isSimpTheorem</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">     </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"bp\">.</span><span class=\"n\">mkDefault</span>\n<span class=\"bp\">-</span><span class=\"w\">    </span><span class=\"n\">checkAllSimpTheoremInfos</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">lhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">isConditional</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"bp\">+</span><span class=\"w\">    </span><span class=\"n\">checkAllSimpTheoremInfos</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"bp\">+</span><span class=\"w\">      </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">lhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">isConditional</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hyps</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"bp\">+</span><span class=\"w\">      </span><span class=\"c1\">-- add the local hypotheses to the simp context</span>\n<span class=\"bp\">+</span><span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">simpTheorems</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">simpTheorems</span>\n<span class=\"bp\">+</span><span class=\"w\">      </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">hyps</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"bp\">+</span><span class=\"w\">        </span><span class=\"n\">simpTheorems</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">simpTheorems</span><span class=\"bp\">.</span><span class=\"n\">addTheorem</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">fvar</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">fvarId!</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">h</span>\n<span class=\"bp\">+</span><span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctxHyps</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"bp\">.</span><span class=\"n\">setSimpTheorems</span><span class=\"w\"> </span><span class=\"n\">simpTheorems</span>\n<span class=\"w\">       </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">isRfl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isRflTheorem</span><span class=\"w\"> </span><span class=\"n\">declName</span>\n<span class=\"w\">       </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lhs'</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">proof?</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">prf1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">..</span><span class=\"w\"> </span><span class=\"o\">},</span><span class=\"w\"> </span><span class=\"n\">prf1Stats</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">         </span><span class=\"n\">decorateError</span><span class=\"w\"> </span><span class=\"s2\">\"simplify fails on left-hand side:\"</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">           </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">!</span><span class=\"n\">isRfl</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"bp\">-</span><span class=\"w\">            </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">ctx</span>\n<span class=\"bp\">+</span><span class=\"w\">            </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">&lt;|&gt;</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">ctxHyps</span>\n<span class=\"w\">           </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">             </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">dsimp</span><span class=\"w\"> </span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">ctx</span>\n<span class=\"w\">             </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 514835392,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745851940
    },
    {
        "content": "<p>3 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Technical.20Debt.20Counters/with/443678155\">#mathlib4 &gt; Technical Debt Counters</a> by <span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span>.</p>",
        "id": 514835468,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745851963
    },
    {
        "content": "<p>Why wouldn't we just overwrite <code>ctx</code> with the extended context?</p>",
        "id": 514838552,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745852785
    },
    {
        "content": "<p>Maybe there is value in checking if something can be simped unconditionally?</p>",
        "id": 514839668,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745853066
    },
    {
        "content": "<p>But maybe we actually don't care.</p>",
        "id": 514839733,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745853082
    },
    {
        "content": "<p>You might want to add an <code>isProp</code> check (to the free variable type) before <code>simpTheorems.addTheorem</code>. <code>hyps</code> contains all of the free variables. (I think you'll get an error otherwise)</p>",
        "id": 514841042,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745853432
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/pull/1214\">https://github.com/leanprover-community/batteries/pull/1214</a> contains my attempt.</p>",
        "id": 514841738,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745853617
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/simpNF.20lint.20with.20hyps/near/514841042\">said</a>:</p>\n<blockquote>\n<p>You might want to add an <code>isProp</code> check (to the free variable type) before <code>simpTheorems.addTheorem</code>. <code>hyps</code> contains all of the free variables. (I think you'll get an error otherwise)</p>\n</blockquote>\n<p>Good idea. Pushed that to the PR.</p>",
        "id": 514842007,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745853702
    },
    {
        "content": "<p>I'm removing 3 <code>@[simp]</code> attributes that are now flagged by the linter.</p>\n<p>I tested, and indeed, these lemmas do not fire on their own LHS, even with <code>simp [*]</code>.</p>\n<p><a href=\"https://github.com/leanprover-community/batteries/pull/1214/commits/8e47a2ac82ea7d0ccaaa2dbb5eaf1c516c491999\">https://github.com/leanprover-community/batteries/pull/1214/commits/8e47a2ac82ea7d0ccaaa2dbb5eaf1c516c491999</a></p>",
        "id": 514854779,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745857058
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> I've tested this out on mathlib, and we get 184 new linter warnings.<br>\nFor example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- The product of `f` over `insert a s` is the same as</span>\n<span class=\"sd\">the product over `s`, as long as `f a = 1`. -/</span>\n<span class=\"kd\">@[</span><span class=\"n\">to_additive</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"The sum of `f` over `insert a s` is the same as</span>\n<span class=\"s2\">the sum over `s`, as long as `f a = 0`.\"</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">prod_insert_one</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∏</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">∏</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">prod_insert_of_eq_one_if_not_mem</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">h</span>\n\n<span class=\"c1\">-- Indeed, this lemma can be proven using `simp [*]` but not by `simp`.</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">prod_insert_one'</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">DecidableEq</span><span class=\"w\"> </span><span class=\"n\">ι</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∏</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">∏</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">*</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 514862929,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745859626
    },
    {
        "content": "<p>So, I guess a general question for people to chime in on: do we want lemmas like <code>prod_insert_one</code> in our simp set, if <code>simp [*]</code> can already prove them...</p>",
        "id": 514863080,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745859675
    },
    {
        "content": "<p>Isn't this lemma overshadowed by <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.prod_insert_of_eq_one_if_not_mem#doc\">docs#Finset.prod_insert_of_eq_one_if_not_mem</a> ? I seems like it should clearly not have a @[simp] tag.</p>",
        "id": 514867283,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745860972
    },
    {
        "content": "<p>Indeed, that is exactly what the linter now reports:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">BigOperators</span><span class=\"bp\">/</span><span class=\"n\">Group</span><span class=\"bp\">/</span><span class=\"n\">Finset</span><span class=\"bp\">/</span><span class=\"n\">Basic</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">51</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">prod_insert_one</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">prove</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">implies_true</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">prod_insert_of_eq_one_if_not_mem</span><span class=\"o\">]</span>\n<span class=\"n\">One</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">lemmas</span><span class=\"w\"> </span><span class=\"n\">above</span><span class=\"w\"> </span><span class=\"n\">could</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">duplicate</span><span class=\"bp\">.</span>\n<span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">that's</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">try</span><span class=\"w\"> </span><span class=\"n\">reordering</span><span class=\"w\"> </span><span class=\"n\">lemmas</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">adding</span><span class=\"w\"> </span><span class=\"kd\">@[</span><span class=\"n\">priority</span><span class=\"kd\">]</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 514957105,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745903671
    },
    {
        "content": "<p>For the record, here is the full linter output: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/14712661498/job/41288687885#step:25:21\">https://github.com/leanprover-community/mathlib4/actions/runs/14712661498/job/41288687885#step:25:21</a></p>",
        "id": 514960990,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745904487
    },
    {
        "content": "<p>I think many of the new warnings are valid warnings, however it mistakenly chokes on <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Equiv.Perm.support_subtype_perm#doc\">docs#Equiv.Perm.support_subtype_perm</a>, because it has a hypothesis <code>h : ∀ (x : α), x ∈ s ↔ f x ∈ s)</code>. And then <code>simp [h]</code> loops forever.</p>",
        "id": 515033258,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745925272
    },
    {
        "content": "<p>I think <code>simp</code> should have an option that determines whether local simp theorems that are equalities (or iff) are turned into rewriting simp theorem, or just theorems that simplify a statement into true. Then we can use it in <code>simpNF</code> to avoid these kinds of looping rewrites with hypotheses that weren't meant for rewriting.</p>",
        "id": 515045459,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745928747
    },
    {
        "content": "<p>I've pushed a whole bunch of fixes to <a href=\"https://github.com/leanprover-community/mathlib4/tree/batteries-pr-testing-1214\">branch#batteries-pr-testing-1214</a></p>",
        "id": 515054535,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745931140
    },
    {
        "content": "<p>Many of those can be backported to master indep of this linter change.</p>",
        "id": 515054636,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745931161
    },
    {
        "content": "<p>It seems that any \"higher order\" simp theorem gets flagged by the new linter, e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">monovaryOn_inv_left₀</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hf</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">∀</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MonovaryOn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">⁻¹</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">AntivaryOn</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>\n<p>which has a hypothesis that has a hypothesis. It seems like this simp lemma should be able to apply to itself, but the problem is that <code>contextual</code> is set to false by default. This means that when simplifying <code>0 &lt; f i</code>, the discharger doesn't have access to the <code>i ∈ s</code> hypothesis that is needed to apply <code>hf</code>. It does get solved by <code>simp +contextual [*]</code>.</p>",
        "id": 515063653,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745933275
    },
    {
        "content": "<p>So... should the linter also try <code>+contextual</code>?<br>\nOr should we just not have such higher order simp lemmas in the default set?</p>",
        "id": 515064229,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745933402
    },
    {
        "content": "<p>We could put the <code>@[simp]</code> tag on a simpler version of the theorem without the <code>i ∈ s</code> hypothesis. On the other hand, the extra hypothesis doesn't do any harm, and is beneficial if we have <code>+contextual</code>.</p>",
        "id": 515065112,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745933624
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/channel/287929-mathlib4/topic/simpNF.20lint.20with.20hyps/near/515064229\">said</a>:</p>\n<blockquote>\n<p>So... should the linter also try <code>+contextual</code>?</p>\n</blockquote>\n<p>I think that would be a reasonable workaround.</p>",
        "id": 515067342,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745934162
    },
    {
        "content": "<p>Interestingly, if we have a \"higher higher order\" simp theorem (having a hypothesis in a hypothesis in a hypothesis), then the linter will complain due to <code>maxDischargeDepth := 2</code> :)</p>",
        "id": 515067577,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745934228
    },
    {
        "content": "<p>Clearly we should draw a line somewhere. <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 515067798,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745934277
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> btw, please feel free to push to the batteries PR if you have some ideas</p>",
        "id": 515082522,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745937591
    },
    {
        "content": "<p>I don't have write access for batteries. But the change I wanted to make is replacing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"bp\">.</span><span class=\"n\">mkDefault</span>\n</code></pre></div>\n<p>with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Simp</span><span class=\"bp\">.</span><span class=\"n\">mkContext</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">contextual</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"o\">})</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">simpTheorems</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getSimpTheorems</span><span class=\"o\">)])</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">congrTheorems</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getSimpCongrTheorems</span><span class=\"o\">))</span>\n</code></pre></div>",
        "id": 515115125,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745945634
    },
    {
        "content": "<p>Thanks, I pushed that change.</p>",
        "id": 515127540,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1745949384
    },
    {
        "content": "<p>It looks like there are some further linting failures on <a href=\"https://github.com/leanprover-community/mathlib4/tree/batteries-pr-testing-1214\">branch#batteries-pr-testing-1214</a>.</p>",
        "id": 515159899,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745961674
    },
    {
        "content": "<p>Ping me when when you'd like this merged.</p>",
        "id": 515159917,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1745961683
    },
    {
        "content": "<p>The awkward thing about setting <code>contextual</code> to <code>true</code>, is that a lemma like <code>not_imp_self : ¬a → a ↔ a</code> now gets solved by <code>simpNF</code> (because it introduces <code>¬a</code> to its context, thus simplifying <code>a</code> to <code>False</code>).</p>\n<p>As a workaround, we could only set <code>contextual</code> to true if we detect that the lemma is higher order.</p>",
        "id": 515165163,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745964141
    }
]