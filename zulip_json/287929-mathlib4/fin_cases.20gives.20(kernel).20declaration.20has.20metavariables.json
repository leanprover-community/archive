[
    {
        "content": "<p>The following code gives a <code>(kernel) declaration has metavariables 'cc'</code> messages:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\"> </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">IsSquare</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">fin_cases</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">simp</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">fin_cases</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">repeat</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">    </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>\n<p>Sorry if this is repeated topic. How to prove this result while avoiding this type of messages?</p>",
        "id": 510550184,
        "sender_full_name": "Luis Berlioz",
        "timestamp": 1743995722
    },
    {
        "content": "<p>If you use a version of Lean before v4.19.0-rc1, this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">IsSquare</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">decide</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"n\">kernel</span>\n</code></pre></div>",
        "id": 510551724,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1743996672
    },
    {
        "content": "<p>For instance, on v4.18.0, this works: <a href=\"https://live.lean-lang.org/#project=mathlib-stable&amp;codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQO0Cm0BIcAxmXAFxwDeAHnIBBEcAYsAHYDOBMAdFCQcA5gTgBWOAB84ASS4BlAI4BXJFDH0AvnAC8dAAwAaOAEYTAFh1V9WAJ444cACYEywV3ADUAawJQOAnQcIA\">https://live.lean-lang.org/#project=mathlib-stable&amp;codez=JYWwDg9gTgLgBAWQIYwBYBtgCMBQO0Cm0BIcAxmXAFxwDeAHnIBBEcAYsAHYDOBMAdFCQcA5gTgBWOAB84ASS4BlAI4BXJFDH0AvnAC8dAAwAaOAEYTAFh1V9WAJ444cACYEywV3ADUAawJQOAnQcIA</a></p>",
        "id": 510551951,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1743996800
    },
    {
        "content": "<p>Wooah was this breakage in 4.19rc intentional?</p>",
        "id": 510569768,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744006653
    },
    {
        "content": "<p>I would guess this is a consequence of making well-founded proofs opaque, so the kernel can't reduce them (which very often goes badly wrong).</p>\n<p>See <a href=\"https://github.com/leanprover/lean4/pull/5182\">lean#5182</a>, which advises adding <code>@[semireducible]</code> (although I think it is often not obvious <em>where</em>).</p>\n<p><span class=\"user-mention\" data-user-id=\"470149\">@Joachim Breitner</span> is on holiday at the moment this week.</p>",
        "id": 510577000,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1744009450
    },
    {
        "content": "<p>I guess this is an independent issue to the broken proof above</p>",
        "id": 510577399,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744009579
    },
    {
        "content": "<p>Yes, it is. The broken proof starting this thread is clearly a bug in <code>fin_cases</code>.</p>",
        "id": 510580507,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744010557
    },
    {
        "content": "<p>This error message means some tactic dropped some goals. You can get the  same message with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"bad_tactic\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">replaceMainGoal</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">IsSquare</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">bad_tactic</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">bad_tactic</span>\n</code></pre></div>",
        "id": 510581072,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744010723
    },
    {
        "content": "<p>And in the original proof you can see how <code>fin_cases</code> creates only one goal.</p>",
        "id": 510581235,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744010765
    },
    {
        "content": "<p>You can avoid the <code>fin_cases</code> failure while keeping the same spirit with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">cc</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">range</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">IsSquare</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">k</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Finset</span><span class=\"bp\">.</span><span class=\"n\">mem_filter</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Iff</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">rcases</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">hk</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hk'</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">fin_cases</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">fin_cases</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">    </span><span class=\"n\">all_goals</span><span class=\"w\"> </span><span class=\"n\">simp</span>\n<span class=\"w\">    </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>",
        "id": 510581546,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1744010868
    },
    {
        "content": "<p>Yes, it's independent of the issue above but still answers the question of how to prove the result without errors. The semireducible fix in this case is a change to batteries: <a href=\"https://github.com/leanprover-community/batteries/pull/1194#issuecomment-2782006920\">https://github.com/leanprover-community/batteries/pull/1194#issuecomment-2782006920</a>. But decide+kernel should ignore reducibility settings, so it still feels like something else has gone wrong.</p>",
        "id": 510624338,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1744021667
    }
]