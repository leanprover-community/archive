[
    {
        "content": "<p>This might be a less used feature (at least to me), but the summtation (and also product) notations actually support more kinds of syntax:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Finset</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"c1\">-- ∑ i ∈ s with i + 3 = 5, i * i : ℕ</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"c1\">-- (Finset.filter (fun i =&gt; Eq (HAdd.hAdd i 3) 5) s).sum fun i =&gt; HMul.hMul i i : Nat</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"bp\">∑</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">∈</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"c1\">-- ∑ i ∈ s, if h : i + 3 = 5 then i * i else 0 : ℕ</span>\n</code></pre></div>\n<p>Are these behaviours good enough? I personally have the following concerns:</p>\n<ol>\n<li><code>with</code> and <code>with h :</code> produce very different results syntactically, the former uses <code>Finset.filter</code> and the latter is <code>dite</code>.</li>\n<li>The <code>with h :</code> fails the pretty-printer round-trip (but on the other hand if we just print every sum-dite epxression using <code>with h :</code> then it might also produce some false-positives</li>\n</ol>",
        "id": 543112524,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759607240
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span></p>",
        "id": 543112612,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759607342
    },
    {
        "content": "<p>I think this is <span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span>'s baby</p>",
        "id": 543112628,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1759607362
    },
    {
        "content": "<p>aha, the <code>with h :</code> is <a href=\"https://github.com/leanprover-community/mathlib4/pull/11563\">#11563</a> which was merged last month</p>",
        "id": 543112718,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759607474
    },
    {
        "content": "<p>delab for <code>with</code> is <a href=\"https://github.com/leanprover-community/mathlib4/pull/22048\">#22048</a></p>",
        "id": 543112748,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759607513
    },
    {
        "content": "<p>Yeah, the first issue is something I mentioned a few times in <a href=\"https://github.com/leanprover-community/mathlib4/pull/11563\">#11563</a>, I'd very much like to see that changed.</p>",
        "id": 543124180,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759621574
    },
    {
        "content": "<p>Perhaps that's easy enough to just change though?</p>",
        "id": 543124250,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759621662
    },
    {
        "content": "<p>There's also a bug with the delaborator for <code>with</code>, it doesn't give the correct spacing, I think this is still an issue?</p>",
        "id": 543124270,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759621685
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Finset.20sum.20notation/near/543124270\">said</a>:</p>\n<blockquote>\n<p>There's also a bug with the delaborator for <code>with</code>, it doesn't give the correct spacing, I think this is still an issue?</p>\n</blockquote>\n<p>I just fixed this in <a href=\"https://github.com/leanprover-community/mathlib4/pull/30194\">#30194</a> (merged)</p>",
        "id": 543124295,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759621711
    },
    {
        "content": "<p>Just spotted that too, thanks!!</p>",
        "id": 543124305,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759621723
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Finset.20sum.20notation/near/543124180\">said</a>:</p>\n<blockquote>\n<p>the first issue</p>\n</blockquote>\n<p>but then one question is also whether that's actually fine, since filter seems preferrable, and then <code>h :</code> is impossible without dite</p>",
        "id": 543124316,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759621738
    },
    {
        "content": "<p>Oh no, I think we should use <code>ite</code> in the first case. As well as being consistent, I think this is actually the more convenient thing to expand to. For instance, when commuting sums, it's usually easier to push everything into an <code>ite</code> and into the inner-most point in a sum</p>",
        "id": 543124360,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759621807
    },
    {
        "content": "<p>well one issue with ite is the \"else 0\" that it produces, maybe</p>",
        "id": 543124388,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759621838
    },
    {
        "content": "<p>I don't think that's an issue. In fact I think that's a good thing :)</p>",
        "id": 543124405,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759621859
    },
    {
        "content": "<p>well if you add two of them you might get <code>0 + 0</code></p>",
        "id": 543124423,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759621876
    },
    {
        "content": "<p>Sure, that just means we need to change a lemma's proof slightly, that's not really an issue. Essentially my proposed change is to make <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sum_filter#doc\">docs#Finset.sum_filter</a> use notation on the rhs not lhs. And as I say, I think this is more convenient in practice as a choice.</p>",
        "id": 543124481,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759621960
    },
    {
        "content": "<p>The big issue with Bhavik's idea, ie the reason it is taking so long to implement, is that it makes <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sum_ite#doc\">docs#Finset.sum_ite</a> useless as a simp lemma (even locally)</p>",
        "id": 543132168,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759633023
    },
    {
        "content": "<p>I still don't know how to solve the problem of splitting up a sum according to a property. Would a simproc checking whether the right side of the ite is zero not loop still?</p>",
        "id": 543132338,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759633271
    },
    {
        "content": "<p>The matter is further complicated by the fact that <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ite_not#doc\">docs#ite_not</a> is a simp lemma, and one can also note that the new <code>with h :</code> notation is unsuited for use in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.expect#doc\">docs#Finset.expect</a></p>",
        "id": 543132382,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759633351
    },
    {
        "content": "<p>Why not use a sum over <code>(s.filter p).attach</code>?</p>",
        "id": 543138455,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1759641762
    },
    {
        "content": "<p>(I didn't think a lot about this, so probably it's a bad idea for an obvious reason)</p>",
        "id": 543138477,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1759641792
    },
    {
        "content": "<p>This is precisely what I had originally in <a href=\"https://github.com/leanprover-community/mathlib4/pull/11563\">#11563</a> before Bhavik got his way with the <code>if h : ... then ... else ...</code> spelling</p>",
        "id": 543142778,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759647862
    },
    {
        "content": "<p>The main issue with the <code>attach</code> spelling is that it is quite weird to obtain the <code>h</code> from it</p>",
        "id": 543142881,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759647964
    },
    {
        "content": "<p>The attach versions are almost always far more annoying than useful, in part because obtaining <code>h</code> is awkward, but also because it leads very easily to DTT hell, particularly when modifying <code>s</code> or <code>p</code> as part of a rewrite sequence (which is a very common operation to do). I think we should have the lemmas saying that the <code>ite</code> sum is equal to the <code>attach</code> sum, but I think it's fairly clear that the <code>ite</code> version is by far the most useful in practice.</p>",
        "id": 543165484,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759673617
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Finset.20sum.20notation/near/543132168\">said</a>:</p>\n<blockquote>\n<p>The big issue with Bhavik's idea, ie the reason it is taking so long to implement, is that it makes <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Finset.sum_ite#doc\">docs#Finset.sum_ite</a> useless as a simp lemma (even locally)</p>\n</blockquote>\n<p>This isn't a simp lemma already, and throughout mathlib it's only used in <code>simp</code> twice, so I don't think this is a big issue.</p>",
        "id": 543165609,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759673728
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Finset.20sum.20notation/near/543132338\">said</a>:</p>\n<blockquote>\n<p>I still don't know how to solve the problem of splitting up a sum according to a property. Would a simproc checking whether the right side of the ite is zero not loop still?</p>\n</blockquote>\n<p>What exactly is \"the problem\" here? The choice of notation has no impact here, we can rewrite in exactly the same way before or after these changes.</p>",
        "id": 543165853,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759674004
    },
    {
        "content": "<p>the problem is \"loop\"ing i think</p>",
        "id": 543166004,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759674168
    },
    {
        "content": "<p>if you have the wrong lemma to split a sum</p>",
        "id": 543166009,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759674173
    },
    {
        "content": "<p>That's already an issue! Again, the lemma statements aren't changing, we're just having more convenient and consistent notation for it</p>",
        "id": 543166174,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759674334
    },
    {
        "content": "<p>well we're debating here about the correct simp-NF forms, and that has an impact on what the statements look like</p>",
        "id": 543166207,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759674370
    },
    {
        "content": "<p>Why do you think the simp-NF forms are changing?</p>",
        "id": 543166330,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759674483
    },
    {
        "content": "<p>actually I would like to retract some of my statements, I don't think \"splitting a sum on cases\" should be a simp lemma, mainly because there's no way to infer the condition</p>",
        "id": 543166454,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759674593
    },
    {
        "content": "<p>so I assume we're talking about a statement of the form:</p>\n<ul>\n<li>sum of f(x) = sum of f(x) for P(x) + sum of f(x) for not P(x)</li>\n</ul>",
        "id": 543166505,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759674625
    },
    {
        "content": "<p>if our chosen representation for \"sum of f(x) for P(x)\" changes, then the statement also changes</p>",
        "id": 543166531,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759674651
    },
    {
        "content": "<p>by representation I mean something like:</p>\n<ul>\n<li>sum over filter</li>\n<li>sum over attached</li>\n<li>sum ite</li>\n</ul>",
        "id": 543166586,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759674687
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Finset.20sum.20notation/near/543166505\">said</a>:</p>\n<blockquote>\n<p>so I assume we're talking about a statement of the form:</p>\n<ul>\n<li>sum of f(x) = sum of f(x) for P(x) + sum of f(x) for not P(x)</li>\n</ul>\n</blockquote>\n<p>No, that's not what I am talking about. I am instead thinking of the statement <code>∑ i ∈ s, if p i then f i else g i = ∑ i ∈ s with p i, f i + ∑ i ∈ s with ¬ p i, g i</code></p>",
        "id": 543167032,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759675142
    },
    {
        "content": "<p>aha</p>",
        "id": 543167051,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759675166
    },
    {
        "content": "<p>yeah that also applies, we also need to stop it from looping</p>",
        "id": 543167071,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759675194
    },
    {
        "content": "<p>There are two things going on here:</p>\n<ul>\n<li>Under Bhavik's proposal, this lemma would loop.</li>\n<li>Under Bhavik's proposal, the simp normal form of <code>∑ i ∈ s with ¬ p i, g i</code> is <code>∑ i ∈ s, if p i then 0 else g i</code>, ie simp would <em>remove</em> notation</li>\n</ul>",
        "id": 543167162,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759675278
    },
    {
        "content": "<p>I think this just shouldn't be a simp-lemma! It's already barely used as such: it's not tagged <code>simp</code> currently, and it's used locally as a simp lemma only twice in mathlib.</p>",
        "id": 543167177,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759675299
    },
    {
        "content": "<p>I never said that! It's clearly a sort of distributivity lemma. But equally I don't think it should be banned from being used in simp</p>",
        "id": 543167220,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759675341
    },
    {
        "content": "<p>Perhaps, but I think the concern of \"this particular lemma makes notation go away if I put it in simp\" is quite a bit smaller than the consistency and convenience of the notation here.</p>",
        "id": 543167335,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1759675489
    },
    {
        "content": "<p>well, we can just have <code>without</code>...</p>",
        "id": 543167409,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1759675543
    },
    {
        "content": "<p>That's actually not such a bad idea!</p>",
        "id": 543167454,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1759675577
    }
]