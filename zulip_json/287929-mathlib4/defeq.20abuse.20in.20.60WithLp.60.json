[
    {
        "content": "<p>A few months ago, I helped <span class=\"user-mention silent\" data-user-id=\"462733\">Jon Bannon</span> clean up some defeq abuse related to <code>EuclideanSpace ùïú n</code> in files relating to Hermitian elements. This was causing tremendous pain.</p>\n<p>Just this weekend, I realized there is a lot of defeq abuse that occurs in <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WithLp#doc\">docs#WithLp</a>, and moreover, it's intentional! For instance, given <code>x : WithLp 2 (E √ó F)</code>, we write <code>x.fst</code> <em>even though <code>WithLp.fst</code> doesn't exist</em>. Instead, Lean sees through the type synonym and applies <code>Prod.fst</code> instead, which, in my opinion, is terrible type hygiene. We then have a <a href=\"https://github.com/leanprover-community/mathlib4/blob/34f13c7489a482e92c4b4d7bf0e91df69aed4b73/Mathlib/Analysis/Normed/Lp/ProdLp.lean#L49-L96\">series of lemmas</a> which copy the usual <code>Prod</code> simplification lemmas from <code>Prod</code> to this defeq abused <code>WithLp</code>.</p>\n<p>This then concludes with <a href=\"https://github.com/leanprover-community/mathlib4/blob/34f13c7489a482e92c4b4d7bf0e91df69aed4b73/Mathlib/Analysis/Normed/Lp/ProdLp.lean#L100-L121\">these <code>simp</code> lemmas</a> which transform type-correct terms into the defeq abused ones (presumably so that the lemmas just stated previously will then apply).</p>\n<p>I will grant that some care has been taken here, as it includes the comment:</p>\n<blockquote>\n<p>/-! Note that the unapplied versions of these lemmas are deliberately omitted, as they break<br>\nthe use of the type synonym. -/</p>\n</blockquote>\n<p>However, to me, this just seems like design that is liable to cause headaches down the line. I'm asking because I'm creating a type synonym for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=CStarModule#doc\">docs#CStarModule</a>, and I noticed these abuses when copying some of the code from <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WithLp#doc\">docs#WithLp</a>.</p>",
        "id": 462136240,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723560875
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> I would like your opinion specifically on the topic above.</p>",
        "id": 462136301,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723560897
    },
    {
        "content": "<p>This <code>f.fst</code> stuff for <code>f : WithLp 2 (E √ó F)</code> is indeed somewhat abusive, and was copied from the prior <code>f 0</code> stuff for <code>f : WithLp 2 (Fin 2 -&gt; F)</code></p>",
        "id": 462138139,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723561382
    },
    {
        "content": "<p>I think there's arguably something special about defeq abuse of function application (we also use it for matrices, <code>Injective</code>, etc), and so we took <code>.fst</code> and <code>.snd</code> along for the ride for consistency</p>",
        "id": 462138332,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723561428
    },
    {
        "content": "<p>Hmmm.... It's <em>exactly</em> the function application defeq abuse that was causing the pain with <code>EuclideanSpace</code>.</p>",
        "id": 462139008,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723561586
    },
    {
        "content": "<p>Was it? I thought it was the function <em>introduction</em> defeq (via <code>fun _ =&gt; _</code>or <code>![_, _, ...]</code>) that caused the pain</p>",
        "id": 462139173,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723561630
    },
    {
        "content": "<p>And we <em>don't</em> use it for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Function.Injective#doc\">docs#Function.Injective</a>, right? The underlying object gets <em>coerced</em> to a function, so there's no abuse.</p>",
        "id": 462139407,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723561671
    },
    {
        "content": "<p>Sure we do, we write <code>hinj hxy</code> when <code>hinj : Function.Injective f</code> and <code>hxy : x = y</code>, and there's no coercion there</p>",
        "id": 462139890,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723561727
    },
    {
        "content": "<p>I think Jireh means <code>Injective ‚áëf</code></p>",
        "id": 462140107,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1723561758
    },
    {
        "content": "<p>oh, that's what you mean.</p>",
        "id": 462140122,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723561759
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462138332\">said</a>:</p>\n<blockquote>\n<p>I think there's arguably something special about defeq abuse of function application (we also use it for matrices, <code>Injective</code>, etc), and so we took <code>.fst</code> and <code>.snd</code> along for the ride for consistency</p>\n</blockquote>\n<p>I guess <code>Injective</code> is quite different to <code>Matrix</code> and <code>WithLp</code>, since the latter two are data and so defeq matters</p>",
        "id": 462140497,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723561824
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462139173\">said</a>:</p>\n<blockquote>\n<p>Was it? I thought it was the function <em>introduction</em> defeq (via <code>fun _ =&gt; _</code>or <code>![_, _, ...]</code>) that caused the pain</p>\n</blockquote>\n<p>I think it was that we only had one direction of the <code>Equiv</code> around (the other deleted by defeq abuse), and so things wouldn't cancel properly.</p>",
        "id": 462140655,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723561856
    },
    {
        "content": "<p>So regardless of \"which direction\" goes away, both are problematic.</p>",
        "id": 462140797,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723561881
    },
    {
        "content": "<p>I don't fully remember the situation you're thinking of, but I think we fixed it by adding some missing <code>simp</code> lemmas? I think this defeq abuse is sufficiently convenient that we should have a concrete example of the issue it causes on master before spending lots of effort to change the defeq and make things less convenient.</p>",
        "id": 462141443,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723562042
    },
    {
        "content": "<p>The defeq abuse that matters with <code>WithLp</code> is that we never want to end up with <code>@norm (WithLp p V) _ v</code> where <code>v : V</code></p>",
        "id": 462141658,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723562094
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462141443\">said</a>:</p>\n<blockquote>\n<p>but I think we fixed it by adding some missing <code>simp</code> lemmas?</p>\n</blockquote>\n<p>no, we fixed it by adding a <code>CoeFun</code> instance to <code>PiLp</code> and explicitly using <code>‚áë</code> where needed so that Lean <em>didn't</em> see through the type synonym automatically.</p>",
        "id": 462142087,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723562197
    },
    {
        "content": "<p>But it's possible it only mattered in situations where the \"function\" was unapplied.</p>",
        "id": 462142232,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723562236
    },
    {
        "content": "<p>I guess the difference is that we have <code>CoeToFun</code> but not <code>CoeToProd</code></p>",
        "id": 462143234,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1723562426
    },
    {
        "content": "<p>Well, sure, you don't have a convenient way to state it, but that's sort of beside the point. You could still write the equiv in there manually.</p>",
        "id": 462145486,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723562786
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462142087\">said</a>:</p>\n<blockquote>\n<p>no, we fixed it by adding a <code>CoeFun</code> instance to <code>PiLp</code> and explicitly using <code>‚áë</code> where needed so that Lean <em>didn't</em> see through the type synonym automatically.</p>\n</blockquote>\n<p>Did we? Where's the instance?</p>",
        "id": 462147412,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723563280
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=instCoeFunPiLpForall#doc\">docs#instCoeFunPiLpForall</a></p>",
        "id": 462147581,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723563334
    },
    {
        "content": "<p>I think probably the difference between the two situations is exactly what the comment in the <code>WithLp</code> file is getting at: when it's <em>applied</em> (i.e., with <code>fst</code> or <code>snd</code>, or an argument to the function), it's (maybe?) okay to commit the defeq abuse (because the type of the complete expression is the same with or without the abuse, but without it we would have to create new <code>def</code>s on the synonym in order for it to make sense), but when it's <em>unapplied</em>, then it would just be blatant defeq abuse (and the types of the resulting expression are different) and could lead to problems like you mentioned above with the norm.</p>",
        "id": 462148500,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723563624
    },
    {
        "content": "<p>Thanks, I had forgotten about <a href=\"https://github.com/leanprover-community/mathlib4/pull/11943\">#11943</a>. <del>I agree the situation is less compelling for the prod case then.</del></p>",
        "id": 462148648,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723563671
    },
    {
        "content": "<p>In the case of <code>EuclideanSpace</code>, we we definitely dealing with the unapplied situation a lot, because we were consider eigenvectors as terms in <code>EuclideanSpace ùïú n</code>, but then sometimes the defeq abuse was leading them to be considered as terms of type <code>n ‚Üí ùïú</code>.</p>",
        "id": 462148710,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723563702
    },
    {
        "content": "<p>Eric, we still have the corresponding lemmas for <code>PiLp</code> (i.e., the <code>PiLp</code> versions of the lemmas I mentioned in the original post).</p>",
        "id": 462151004,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723564511
    },
    {
        "content": "<p>I think I'm going to <em>tentatively</em> stick with the <code>WithLp</code> approach of mild defeq abuse here. It does seem to work okay.</p>",
        "id": 462151554,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723564703
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462151004\">said</a>:</p>\n<blockquote>\n<p>Eric, we still have the corresponding lemmas for <code>PiLp</code> (i.e., the <code>PiLp</code> versions of the lemmas I mentioned in the original post).</p>\n</blockquote>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Analysis/Normed/Lp/PiLp.html#WithLp.equiv_pi_apply\">WithLp.equiv_pi_apply</a>, you mean? From the source code it looks to me like the <code>CoeFun</code> instance is useless and doesn't actually ever apply.</p>",
        "id": 462151734,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723564784
    },
    {
        "content": "<p>No, the lemmas directly above that.</p>",
        "id": 462151966,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723564841
    },
    {
        "content": "<p>Note, the <code>CoeFun</code> instance is useless <em>for applied functions</em> because of the lemma you mentioned. It's <em>not useless</em> so that you can write <code>‚áëx</code> to get from <code>x : WithLp p (Œ† i, V i)</code> to <code>Œ† i, V i</code> without writing <code>WithLp.equiv p _ x</code> (assuming Lean can infer the type correctly there).</p>",
        "id": 462152443,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723564947
    },
    {
        "content": "<p>I don't think it's useless because of those lemmas, but rather because <code>x i</code> elaborates without ever doing an instance search</p>",
        "id": 462152654,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723565019
    },
    {
        "content": "<p>But good point about the <code>‚áëf</code> coercion being handy</p>",
        "id": 462152699,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723565032
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462152654\">said</a>:</p>\n<blockquote>\n<p>I don't think it's useless because of those lemmas, but rather because <code>x i</code> elaborates without ever doing an instance search</p>\n</blockquote>\n<p>indeed, also that.</p>",
        "id": 462153439,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723565210
    },
    {
        "content": "<p>What do you think about making <code>WithLp</code> a one-field structure, or even split it back into <code>WithLpPi</code> and <code>WithLpProd</code> (both structures)?</p>",
        "id": 462156581,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723565990
    },
    {
        "content": "<p>My reason: the distance on <code>WithLp 0 _</code> defines a topology that doesn't agree with the usual one.</p>",
        "id": 462157211,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723566139
    },
    {
        "content": "<p>Also, as we discussed some time ago, we may want to redefine the distance on <code>WithLp p _</code>, <code>p &lt; 1</code>, so that it becomes an additive normed group which is a <code>p</code>-space.</p>",
        "id": 462157344,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723566186
    },
    {
        "content": "<p>This way we'll get a normed group for all <code>p</code>.</p>",
        "id": 462157416,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723566210
    },
    {
        "content": "<p>And a homeomorphism to the usual (indexed) product for <code>p ‚â† 0</code>.</p>",
        "id": 462157471,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723566224
    },
    {
        "content": "<p>From my experience, dealing with type synonyms is super hard when writing tactics. Things just break randomly and it is super hard to fix. For the purpose of automatic differentiation I gave up on using <code>WithLp</code> and <code>Id</code> monad. I would strongly prefer those to be one element structures.</p>",
        "id": 462157664,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1723566274
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"346070\">@Tomas Skrivan</span> that sounds (to me, though I'm not particularly experienced) that you're just dealing with things at the wrong level of transparency. If you're dealing with everything at reducible transparency, as I think there has been <em>some</em> consensus that automated tactics should do, this wouldn't be a problem.</p>",
        "id": 462159857,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723566837
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462156581\">said</a>:</p>\n<blockquote>\n<p>What do you think about making <code>WithLp</code> a one-field structure, or even split it back into <code>WithLpPi</code> and <code>WithLpProd</code> (both structures)?</p>\n</blockquote>\n<p>A one-field structure would be okay with me, but I really don't think we should split it.</p>",
        "id": 462160152,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723566903
    },
    {
        "content": "<p>I think we should develop some more metaprogramming infrastructure for one-field structures before investing the effort of making WithLp (and Matrix?) such a structure</p>",
        "id": 462160495,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723566987
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462157211\">said</a>:</p>\n<blockquote>\n<p>My reason: the distance on <code>WithLp 0 _</code> defines a topology that doesn't agree with the usual one.</p>\n</blockquote>\n<p>I don't see what that has to do with making it a one-field structure.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462157344\">said</a>:</p>\n<blockquote>\n<p>Also, as we discussed some time ago, we may want to redefine the distance on <code>WithLp p _</code>, <code>p &lt; 1</code>, so that it becomes an additive normed group which is a <code>p</code>-space.</p>\n</blockquote>\n<p>This is fine, but we need to define quasi-metrics and quasi-norms first. And I also don't see what it has to do with making <code>WithLp</code> a structure.</p>",
        "id": 462160600,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723567014
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462160495\">said</a>:</p>\n<blockquote>\n<p>I think we should develop some more metaprogramming infrastructure for one-field structures before investing the effort of making WithLp (and Matrix?) such a structure</p>\n</blockquote>\n<p>Don't we have a <code>transfer</code> tactic for things like this?</p>",
        "id": 462161026,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723567119
    },
    {
        "content": "<p>I'm thinking more machinery to generate all the rfl lemmas about the canonical equivalence</p>",
        "id": 462164242,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723568231
    },
    {
        "content": "<p><code>transfer</code> is pretty useless, I think.</p>",
        "id": 462164268,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723568247
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462160600\">said</a>:</p>\n<blockquote>\n<p>Yury G. Kudryashov <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/462157211\">said</a>:</p>\n<blockquote>\n<p>My reason: the distance on <code>WithLp 0 _</code> defines a topology that doesn't agree with the usual one.</p>\n</blockquote>\n<p>I don't see what that has to do with making it a one-field structure.</p>\n</blockquote>\n<p>Currently, we abuse the definitional equality of <code>TopologicalSpace</code> instances here and there (at least, we used to do it in the manifold library in Mathlib 3). Using one field structures will force us to avoid it, and it will print readable error messages instead of \"these things that look the same aren't equal\".</p>",
        "id": 462176400,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723572062
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 462176577,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723572109
    },
    {
        "content": "<p>About <code>p &lt; 1</code>: why do we need quasimetric? If we redefine the norm to be <code>‚àë i, ‚Äñx i‚Äñ^p</code> for <code>0 &lt; p &lt; 1</code>, then we get a usual normed group which is a <code>p</code>-space instead of a <code>NormedSpace</code>.</p>",
        "id": 462177608,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723572390
    },
    {
        "content": "<p><del>no we don't? It doesn't satisfy the triangle inequality if <code>0 &lt; p &lt; 1</code>.</del></p>",
        "id": 462178154,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723572565
    },
    {
        "content": "<p>oh sorry, I misread / assumed I knew what you wrote.</p>",
        "id": 462178426,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723572636
    },
    {
        "content": "<p>If you want to refactor the definition of the distance and norm on <code>WithLp</code> to do a case split on <code>p &lt; 1</code> vs. <code>1 ‚â§ p</code>, I'm okay with that if we get some buy-in from other maintainers.</p>",
        "id": 462179143,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1723572803
    },
    {
        "content": "<p>Recently, <span class=\"user-mention\" data-user-id=\"890057\">@ZhiKai Pong</span> is trying to prove some basic theorems about vector calculus is it very easy to get yourself into a corner by abusing defeq between <code>EuclideanSpace ‚Ñù (Fin 3)</code> and <code>Fin 3 ‚Üí ‚Ñù</code>. </p>\n<p>For example it took quite some time before we figured out how to prove</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"bp\">.</span><span class=\"n\">contDiff_apply</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Œπ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Fintype</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">ContDiff</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">ùïú</span><span class=\"w\"> </span><span class=\"n\">Œπ</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>(discussed in <a href=\"#narrow/channel/113489-new-members/topic/How.20to.20do.20differentiation.20on.20concrete.20multivariable.20function\">How to do differentiation on concrete multivariable function</a>)</p>\n<p>Or in this example it is all too easy to apply <code>fderiv_pi</code> and then be baffled why simp can't apply <code>ContinuousLinearMap.pi_apply</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">notation</span><span class=\"w\"> </span><span class=\"s2\">\"‚Ñù¬≥\"</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">InnerProductSpace</span>\n<span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">curl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">¬≥</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">¬≥</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">‚Ñù</span><span class=\"bp\">¬≥</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">¬≥</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"c1\">-- get i-th component of `f`</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fi</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü™</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">EuclideanSpace</span><span class=\"bp\">.</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">‚Ñù</span><span class=\"o\">)</span><span class=\"bp\">‚ü´_</span><span class=\"n\">‚Ñù</span>\n<span class=\"w\">  </span><span class=\"c1\">-- derivative of i-th component in j-th coordinate</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ‚àÇf·µ¢/‚àÇx‚±º</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fderiv</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fi</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">EuclideanSpace</span><span class=\"bp\">.</span><span class=\"n\">single</span><span class=\"w\"> </span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">‚Ñù</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">df</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">x</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">ft</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">¬≥</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">¬≥</span><span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"bp\">¬≥</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">curl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fderiv</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ft</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">fderiv</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">curl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ft</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">fderiv_pi</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Œπ</span><span class=\"o\">:=</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"o\">:=</span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ContinuousLinearMap</span><span class=\"bp\">.</span><span class=\"n\">pi_apply</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>(discussed in <a href=\"#narrow/channel/113489-new-members/topic/simplify.20a.20match.20pattern.20nested.20within.20another.20function\">simplify a match pattern nested within another function</a>)</p>\n<p>Also one should write <code>(WithLp.equiv 2 (Fin 3 ‚Üí ‚Ñù)).symm fun i =&gt;</code> in the definition of <code>curl</code> but it does not save you from anything as <code>rw [fderiv_pi]</code> will be applied anyway.</p>\n<p>Not sure what the solution or lesson is here. Is it a problem of missing API? Is the problem the defeq abuse? I'm just leaving it here as an evidence that people hit this problem and it should be dealt with one way or another.</p>",
        "id": 513456505,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1745263204
    },
    {
        "content": "<p>I am very skeptical of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=EuclideanSpace#doc\">docs#EuclideanSpace</a> being an <code>abbrev</code>...</p>",
        "id": 513456716,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745263310
    },
    {
        "content": "<p>Yeah <code>EuclideanSpace</code> is abbrev of <code>PiLp</code> which is abbrev of <code>WithLp</code> which I think is fine. However, I personally think that <code>WithLp</code> should be one field structure and we should have proper tooling to deal with such structures. In the process, we will realize that writing <code>(WithLp.equiv p (Fin n ‚Üí ‚Ñù)).symm fun i =&gt; ...</code> instead of <code>fun i =&gt; ...</code> is really painful and we will be forced to come up with a solution that combines the best of both worlds. (The same for product type)</p>",
        "id": 513457449,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1745263657
    },
    {
        "content": "<p>For a start, I do not know why <code>WithLp.equiv</code> takes explicit arguments. Compare to eg <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OrderDual.toDual#doc\">docs#OrderDual.toDual</a> whose arguments are all implicit</p>",
        "id": 513462881,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745266091
    },
    {
        "content": "<p>Secondly, the interesting equiv is usually the forward one (from the original space to the type synonym), because it is overall more common to have an element of the original generic type, and turn it into an element of the type synonym. So turn <code>WithLp.equiv</code> around.</p>",
        "id": 513463120,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745266218
    },
    {
        "content": "<p>I've had this feeling before too. Let me find the thread where we discussed it.</p>",
        "id": 513463162,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1745266246
    },
    {
        "content": "<p>Thirdly, the name of the equivalence should be <code>toSynonym</code>/<code>ofSynonym</code>, or a shortening thereof. Here, <code>WithLp.toLp</code> would be a great name which is as short as four characters once you <code>open WithLp</code>.</p>",
        "id": 513463244,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745266304
    },
    {
        "content": "<p>oh wait, that's this thread. <span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span></p>",
        "id": 513463328,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1745266335
    },
    {
        "content": "<p>Finally, it's sometimes useful to have the reverse equivalence too. I am not sure we want it badly here, but in case we do it could be <code>WithLp.ofLp</code></p>",
        "id": 513463404,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1745266377
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Ya√´l Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/513462881\">said</a>:</p>\n<blockquote>\n<p>For a start, I do not know why <code>WithLp.equiv</code> takes explicit arguments. Compare to eg <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OrderDual.toDual#doc\">docs#OrderDual.toDual</a> whose arguments are all implicit</p>\n</blockquote>\n<p>I‚Äôd be happy to have a go at fixing that! (edit: started here: <a href=\"https://github.com/leanprover-community/mathlib4/pull/24261\">#24261</a>)</p>",
        "id": 513465691,
        "sender_full_name": "Paul Lezeau",
        "timestamp": 1745267510
    },
    {
        "content": "<p>If we're going to rename anyway it would be less annoying for downstream code if we leave things explicit in the old name</p>",
        "id": 513466794,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745268024
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/513466794\">said</a>:</p>\n<blockquote>\n<p>If we're going to rename anyway it would be less annoying for downstream code if we leave things explicit in the old name</p>\n</blockquote>\n<p>Is your suggestion to add a <code>WithLp.toLp</code>, and keep <code>WithLp.equiv</code> (possibly with a deprecation warning) ?</p>",
        "id": 513468469,
        "sender_full_name": "Paul Lezeau",
        "timestamp": 1745268870
    },
    {
        "content": "<p>I think, that's reasonable. Also, I like the idea of making <code>WithLp</code> a 1-field structure.</p>",
        "id": 513470406,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745269837
    },
    {
        "content": "<p>I think we should do the structure refactor separately, rather than at the same time</p>",
        "id": 513470657,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745269955
    },
    {
        "content": "<p>I agree, separating refactors increase chances of both of them going through.</p>",
        "id": 513472085,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745270671
    },
    {
        "content": "<p>Do we have this problem with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lex#doc\">docs#Lex</a> too? I'm wondering if all parametric type synonyms which use <code>Œ† i, X i</code> should actually be 1-field structures?</p>",
        "id": 513475441,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1745272405
    },
    {
        "content": "<p>Matrix too</p>",
        "id": 513477793,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745273740
    },
    {
        "content": "<p>What's the advantage of turning it into a 1-field structure?</p>",
        "id": 514133923,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1745503213
    },
    {
        "content": "<p>It makes it impossible to defeq abuse</p>",
        "id": 514134055,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745503245
    },
    {
        "content": "<p>We normally catch defeq abuse in review, but this doesn't stop it tripping up new users</p>",
        "id": 514134125,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745503261
    },
    {
        "content": "<p>For functions that eat a function, you get to use a funlike coercion instead of defeq abuse by default</p>",
        "id": 514134159,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1745503266
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/stream/287929-mathlib4/topic/defeq.20abuse.20in.20.60WithLp.60/near/514134159\">said</a>:</p>\n<blockquote>\n<p>For functions that eat a function, you get to use a funlike coercion instead of defeq abuse by default</p>\n</blockquote>\n<p>Also having explicit coercion like this makes it easier to write tactics.</p>",
        "id": 514136810,
        "sender_full_name": "Tomas Skrivan",
        "timestamp": 1745503684
    }
]