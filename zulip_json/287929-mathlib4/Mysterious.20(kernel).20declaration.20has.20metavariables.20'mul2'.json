[
    {
        "content": "<p>Where do the metavariables in this definition come from?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">-- (kernel) declaration has metavariables 'mul2'</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mul2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">↪</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_right_injective₀</span><span class=\"w\"> </span><span class=\"n\">nofun</span><span class=\"bp\">⟩</span>\n\n<span class=\"c1\">-- (kernel) declaration has metavariables 'mul2''</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mul2'</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">↪</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toFun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">inj'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mul_right_injective₀</span><span class=\"w\"> </span><span class=\"n\">nofun</span>\n</code></pre></div>\n<p>it works when using <code>(by nofun)</code> instead of a plain <code>nofun</code></p>",
        "id": 486237519,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733381877
    },
    {
        "content": "<p>Here's a Mathlib-free minimization:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">opaque</span><span class=\"w\"> </span><span class=\"n\">Injective</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">β</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mul_right_injective</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">M₀</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Mul</span><span class=\"w\"> </span><span class=\"n\">M₀</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Zero</span><span class=\"w\"> </span><span class=\"n\">M₀</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M₀</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">≠</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">  </span><span class=\"n\">Injective</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">M₀</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- (kernel) declaration has metavariables 'mul2'</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mul2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">//</span><span class=\"w\"> </span><span class=\"n\">Injective</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_right_injective</span><span class=\"w\"> </span><span class=\"n\">nofun</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 486238154,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733382238
    },
    {
        "content": "<p>In this case, it seems that <code>nofun</code> makes a metavariable:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">step</span><span class=\"bp\">.</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">proofs</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">[Elab.step.result]</span>\n<span class=\"cm\">  { toFun := fun x =&gt; 2 * x,</span>\n<span class=\"cm\">    inj' := mul_right_injective₀ fun a =&gt; mul2.match_1 MulZeroClass.toZero ?m.768 (fun a =&gt; False) a }</span>\n<span class=\"cm\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mul2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">↪</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_right_injective₀</span><span class=\"w\"> </span><span class=\"n\">nofun</span><span class=\"bp\">⟩</span>\n</code></pre></div>\n<p>This is an issue of Lean, <del>I will create an issue</del>.</p>",
        "id": 486261719,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1733391525
    },
    {
        "content": "<p>The issue was already created: <a href=\"https://github.com/leanprover/lean4/pull/5925\">lean4#5925</a></p>",
        "id": 486262664,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1733391813
    },
    {
        "content": "<p>Is this the same issue?</p>",
        "id": 486265126,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733392558
    },
    {
        "content": "<p>Not exactly the same issue, but similar in that <code>nofun</code> is creating a metavariable.<br>\nI have commented our example to <a href=\"https://github.com/leanprover/lean4/pull/5925\">lean4#5925</a> now.</p>",
        "id": 486266391,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1733392940
    },
    {
        "content": "<p>Is this the same issue?</p>",
        "id": 486322928,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1733410222
    },
    {
        "content": "<p>I thought it would be better to comment our example in the same issue instead of creating different issues, since the name of <a href=\"https://github.com/leanprover/lean4/pull/5925\">lean4#5925</a> is 'A “declaration has metavariables” error', which is the same as this situation.<br>\n<span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span>  Would it be better to create different issues?</p>",
        "id": 486429231,
        "sender_full_name": "Miyahara Kō",
        "timestamp": 1733452685
    }
]