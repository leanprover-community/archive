[
    {
        "content": "<p>Is there something missing in <code>positivity</code> for <code>mul_nonneg</code> to apply in <code>IsOrderedRing</code>?<br>\nThis fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">PartialOrder</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">IsOrderedRing</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">mul_nonneg</span><span class=\"w\"> </span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hy</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">positivity</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>\n<p>It works if <code>IsOrderedRing</code> is strengthened to <code>IsStrictOrderedRing</code>, but the example is true without that extra assumption</p>",
        "id": 516270014,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1746469902
    },
    {
        "content": "<p>I would guess we did a typeclass refactor without modifying positivity</p>",
        "id": 516283790,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1746474778
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/24868\">#24868</a></p>",
        "id": 517949711,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747185217
    },
    {
        "content": "<p>That doesn't look quite right to me either; if the two arguments are positive but the ring isn't strictly ordered, that concludes nothing?</p>",
        "id": 517950434,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1747185694
    },
    {
        "content": "<p>Oh, I should probably fall back in that case</p>",
        "id": 517950570,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747185779
    },
    {
        "content": "<p>Is instance synthesis cached?</p>",
        "id": 517951954,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747186775
    },
    {
        "content": "<p>Yes</p>",
        "id": 517952217,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1747186973
    },
    {
        "content": "<p>Is the cache reverted when you <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.SavedState.restore#doc\">docs#Lean.Meta.SavedState.restore</a> the state? (it looks like it is <span aria-label=\"frown\" class=\"emoji emoji-1f641\" role=\"img\" title=\"frown\">:frown:</span>)</p>",
        "id": 517953067,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1747187565
    },
    {
        "content": "<p>I recently discovered that it doesn't revert the cache :). You can see in the code what it does restore:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Restore backtrackable parts of the state. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SavedState</span><span class=\"bp\">.</span><span class=\"n\">restore</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SavedState</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">core</span><span class=\"bp\">.</span><span class=\"n\">restore</span>\n<span class=\"w\">  </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">mctx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">zetaDeltaFVarIds</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">zetaDeltaFVarIds</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">postponed</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">meta</span><span class=\"bp\">.</span><span class=\"n\">postponed</span><span class=\"w\"> </span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 517953206,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1747187660
    }
]