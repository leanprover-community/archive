[
    {
        "content": "<p>I noticed that <code>extend_docs</code> doesn't necessarily persist a docstring change across imports!</p>\n<p>This is because of extension trickiness: the docstring extension maintains a <code>List (Name × String)</code> alongside a <code>NameMap String</code>; the <code>NameMap</code> is used for state, while the <code>List</code> is used for exports. <code>addDocString</code> calls out to a function which implicitly assumes that no docstring is being added twice, and simply prepends the new entry to the <code>List</code>, regardless of whether the name already appears in a pair there; a <code>qsort</code> with respect to the name  that is used during serialization then might rearrange the entries. After import, when we conduct binary search through the entries associated with the module to retrieve the docstring, we might land on the wrong one.</p>\n<p>Since this bug sensitive to the vagaries of <code>qsort</code> and <code>binSearch</code>, it doesn't always happen. For example, <code>foo</code> is necessary in the following:</p>\n<p><strong>Mathlib.Tactic.Test</strong>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">ExtendDoc</span>\n\n<span class=\"sd\">/-- A docstring. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">inherit_doc</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">5</span>\n\n<span class=\"n\">extend_docs</span><span class=\"w\"> </span><span class=\"n\">bar</span>\n<span class=\"w\">  </span><span class=\"n\">before</span><span class=\"w\"> </span><span class=\"s2\">\"Sorry I'm late to the docstring—what'd I miss?\"</span>\n</code></pre></div>\n<p><strong>Other file</strong>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Test</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"w\"> </span><span class=\"c1\">-- Hover: \"A docstring.\"</span>\n<span class=\"c\">/-</span><span class=\"cm\"> Should be:</span>\n<span class=\"cm\">Sorry I'm late to the docstring—what'd I miss?</span>\n\n<span class=\"cm\">A docstring. -/</span>\n</code></pre></div>",
        "id": 472139513,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727073016
    },
    {
        "content": "<p>PR: <a href=\"https://github.com/leanprover-community/mathlib4/pull/17043\">#17043</a></p>",
        "id": 472139576,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727073038
    },
    {
        "content": "<p>Thanks for digging into this!</p>",
        "id": 472143257,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727074432
    },
    {
        "content": "<p>When i wrote <code>extend_docs</code>, my \"real\" motivation was to be able to extend the docs of <code>rw</code> by adding to it the docs of <code>rewrite</code>.  However, I found out that I was not able to extend the docs of a declaration that was not in the present file.</p>",
        "id": 472143452,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727074500
    },
    {
        "content": "<p>Do you think that you could implement that as a modification of what you are doing now?</p>",
        "id": 472143505,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727074514
    },
    {
        "content": "<p>E.g., can you <code>extend_docs</code> for a declaration that is in the environment, but not in the current file?</p>",
        "id": 472143609,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727074536
    },
    {
        "content": "<p>Sadly I don't think so—when a declaration is from another module, we find its docstring via binary search through the <code>qsort</code>ed array of entries associated with that module, without even constructing the <code>NameMap</code>. (I'm now realizing my explanation was slightly wrong on the \"reconstruction of the <code>NameMap</code>\" point, by the way—that never happens! I've now edited the original message.)</p>",
        "id": 472144228,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727074769
    },
    {
        "content": "<p>Ok, thanks for the explanation, though!</p>",
        "id": 472144515,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1727074840
    },
    {
        "content": "<p>I'm late to the party, but I'm seeing some code about \"tactic extensions\" and \"tactic alternatives\" which seems to have landed relatively recently, though. Maybe that's a path to an ultimate solution somehow for <code>rw</code>? <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span> (I think this is <a href=\"https://github.com/leanprover/lean4/pull/4490\">lean4#4490</a>)</p>",
        "id": 472145706,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1727075224
    }
]