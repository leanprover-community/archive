[
    {
        "content": "<p>Consider the following (tested using current Mathlib, right now at <a href=\"https://github.com/leanprover-community/mathlib4/tree/b40a06417b06ce02e2cc5f687bb8649ff3d5a42d\">b40a064</a> and most recent VSCode extension):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Order.Defs.LinearOrder</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Order.Notation</span>\n\n<span class=\"kd\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"kd\">theorem</span><span class=\"w\"> </span><span class=\"n\">nonsense</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Min</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">nonsense</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>The code compiles without problems (except for the <code>sorry</code> of course, ignore the mathematically nonsensical statement).</p>\n<p>But: Hovering over <code>nonsense</code> in <code>rw [nonsense]</code> causes a server error message<br>\n<code>PANIC at Lean.MetavarContext.getLevelDepth Lean.MetavarContext:874:14: unknown metavariable</code><br>\n(There is no error when hovering over <code>nonsense</code> in its declaration.)</p>\n<p>Now this doesn't seem like a big deal and this error doesn't really bother me too much, but I'm trying to use this as an excuse to learn something about Lean internals and the surrounding infrastructure. I'd be happy if someone could give me some hints about what might be going on here, or hints on how to figure it out. So far my methods are pretty much limited to inserting <code>dbg_trace</code> at various places.. </p>\n<p>Here is what I found so far:</p>\n<ul>\n<li>\n<p>The metavariable at fault is a universe metavariable (an <code>LMVarId</code>; this is consistent with the error disappearing when we remove <code>u</code> from the \"theorem\").</p>\n</li>\n<li>\n<p>The error seems to be related to the delaborator <a href=\"https://github.com/leanprover-community/mathlib4/blob/b40a06417b06ce02e2cc5f687bb8649ff3d5a42d/Mathlib/Order/Notation.lean#L127\"><code>delabInf</code></a> in <code>Mathlib.Order.Notation</code>. There might not be anything wrong with this code, but the error message does disappear if we just call <code>failure</code> in that method when <code>u</code> on line 129 is a <code>.mvar</code> and that it doesn't have a <code>Nat</code> assigned to it in the hash table. What is the intended behavior in this scenario? Another thing that confused me was that<code>delabInf</code> seems to be called twice here when hovering (is it supposed to be called twice and why is that?). Only one of the two calls results in panic. Where is the Lean server code that performs these calls?</p>\n</li>\n<li>\n<p>If we remove either of the two imports (or both), the code still compiles (of course, because <code>Min</code> of <code>Nat</code>s is in prelude), but the error message disappears. This doesn't surprise me for removing the second import, because that's where <code>delabInf</code> lives, but I can't figure out why it disappears if we remove the first import (I have also tried to minimize these imports).</p>\n</li>\n</ul>\n<p>My apologies if this isn't the right channel (and feel free to move this thread).</p>",
        "id": 515628070,
        "sender_full_name": "Joris Roos",
        "timestamp": 1746155769
    }
]