[
    {
        "content": "<p>Hi, I have multiple locally cloned GitHub repositories hosting distinct Lean projects having Mathlib as a dependency. </p>\n<p>How can I efficiently use the same compiled version of Mathlib for all projects without re-building it and decompressing it in the .lake folder occupying about 5GB for each one?</p>",
        "id": 429411490,
        "sender_full_name": "Pietro Monticone",
        "timestamp": 1711374632
    },
    {
        "content": "<p>Maybe you can tag <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> (if I'm not mistaken), since this is arguably a lake feature</p>",
        "id": 429419661,
        "sender_full_name": "Luigi Massacci",
        "timestamp": 1711376524
    },
    {
        "content": "<p>Unfortunately this is barely supported. You can use relative paths when specifying dependencies (but this is not really a shareable solution if your project is in a repo others use), but people seem to have regular problems when doing so.</p>",
        "id": 429428948,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1711378597
    },
    {
        "content": "<p>Note that relative paths will only work if your projects are on <em>exactly</em> the same version of mathlib</p>",
        "id": 429445988,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711381781
    },
    {
        "content": "<p>On the subject of relative paths, <a href=\"https://github.com/leanprover-community/mathlib4/pull/8767\">#8767</a> was an attempt to add better support for them with <code>lake exe cache pack</code> and <code>lake exe cache unpack</code>, but it ran into some issues I haven't tried to diagnose</p>",
        "id": 429446628,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711381909
    },
    {
        "content": "<p>Is there any progress on this topic?</p>",
        "id": 485906446,
        "sender_full_name": "Tony Starter",
        "timestamp": 1733245681
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"434457\">@Tony Starter</span>, if you're working on a non-shared project, you can use relative paths in your <code>lakefile</code> to point to a fixed copy of Mathlib somewhere on your drive.</p>\n<p>If you're working on a shared project, I don't think anyone has even proposed a mechanism by which this might work. What happens when the project needs to update a dependency? How does your local setup know it needs to \"detach\" from the shared copy of Mathlib to move to a different version? This is why we have separate copies in the first place.</p>",
        "id": 485965576,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733264585
    },
    {
        "content": "<p>(are both <code>non-</code>s intentional Kim? It sounded like you were intending to make a comparison)</p>",
        "id": 485965705,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733264641
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/How.20to.20Efficiently.20Use.20Mathlib.20in.20Multiple.20Projects.3F/near/485965705\">said</a>:</p>\n<blockquote>\n<p>(are both <code>non-</code>s intentional Kim? It sounded like you were intending to make a comparison)</p>\n</blockquote>\n<p>editted, thanks</p>",
        "id": 485966001,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733264759
    },
    {
        "content": "<p>If you're working on a shared collection of projects, you can create a \"workspace\" repo that checks all the projects out as git submodules into a single folder structure, and have each project refer to the others via relative paths.</p>",
        "id": 485966070,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733264777
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> has custom repositories in-the-works/implemented-but-not-announced, which would avoid you having to even modify the lakefiles?</p>",
        "id": 485966207,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733264846
    },
    {
        "content": "<p>I could imagine something elan-like to cache oleans for specific versions of mathlib, and maybe using <a href=\"https://git-scm.com/docs/git-worktree\">git worktree</a> per project to save duplicating the 300MB of git history</p>",
        "id": 485966748,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1733265047
    },
    {
        "content": "<p>A low-level post-hoc solution, but it should be possible to hardlink these duplicate .olean files with tools such as <a href=\"https://github.com/pauldreik/rdfind\">https://github.com/pauldreik/rdfind</a></p>",
        "id": 486061487,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1733308845
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"385895\">@Jon Eugster</span> wrote some docs on how to re-use the same mathlib version: <a href=\"https://github.com/leanprover-community/leanprover-community.github.io/pull/510\">https://github.com/leanprover-community/leanprover-community.github.io/pull/510</a></p>",
        "id": 486065997,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1733310302
    },
    {
        "content": "<p>(Proof-reading and approving that PR is welcome, I presume.)</p>",
        "id": 486066047,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1733310315
    }
]