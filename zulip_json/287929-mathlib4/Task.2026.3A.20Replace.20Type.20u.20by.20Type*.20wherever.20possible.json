[
    {
        "content": "<p>Claiming task 26.</p>",
        "id": 513552555,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745311715
    },
    {
        "content": "<p>I think the difference is that <code>Type*</code> introduces a fresh universe, while in <code>Type _</code>, the level can be inferred by unification (or be fresh if it isn't unified to be anything else).</p>\n<p>But there might still be instances in Mathlib where this replacement is possible.</p>",
        "id": 513592518,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745323848
    },
    {
        "content": "<p><a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type.2A.20wherever.20possible/near/513552555\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/Call.20for.20help.3A.20technical.2F.20organisational.20debt/with/512346398\">#mathlib4 &gt; Call for help: technical/ organisational debt</a> by <span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span>.</p>",
        "id": 513592993,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745323993
    },
    {
        "content": "<p>Re 26: I would be very very careful with this. We have been encountering significant still-unidentified slowdowns that depend on the choice of universe name. </p>\n<p>Re 27: I would replace <code>Type _</code> </p>\n<ul>\n<li>first by <code>Type*</code> if possible </li>\n<li>second by <code>Type whatever</code> where <code>whatever</code> is the universe level it actually unifies to.</li>\n</ul>",
        "id": 513600720,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745326085
    },
    {
        "content": "<p>I would not replace <code>Type _</code> at all in cases where <code>Type*</code> doesn't work</p>",
        "id": 513601262,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1745326217
    },
    {
        "content": "<p>actually, i think that <code>Type _</code> happens precisely because arguments have <code>Type*</code>, since you don't get to refer to the universe variable created?<br>\nfor example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Foo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">Set</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>",
        "id": 513601507,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1745326290
    },
    {
        "content": "<p>There has been at least one case where <code>Type _</code> really meant <code>Type 0</code> (oops). I don't like the obfuscation if it can reasonably be avoided but it is not high up my priority list.</p>",
        "id": 513603840,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745326891
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306577\">Matthew Ballard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Call.20for.20help.3A.20technical.2F.20organisational.20debt/near/513600720\">said</a>:</p>\n<blockquote>\n<p>Re 26: I would be very very careful with this. We have been encountering significant still-unidentified slowdowns that depend on the choice of universe name. </p>\n</blockquote>\n<p>I believe readability is more important than compilation speed (having one more variable in the context increases the cognitive load for readers); however, we will benchmark the PR to check it isn't too bad.</p>",
        "id": 513604226,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745326970
    },
    {
        "content": "<p>Please be aware of <a href=\"https://github.com/leanprover-community/mathlib4/pull/12737\">#12737</a> and request my review</p>",
        "id": 513604655,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745327062
    },
    {
        "content": "<p>My understanding is that <a href=\"https://github.com/leanprover-community/mathlib4/pull/12737\">#12737</a> tracks slowdowns caused by universe metavariables. But <code>Type*</code> (unlike <code>Type _</code>) introduces a fresh universe parameter, not a metavariable. So I think going from <code>Type u</code> to <code>Type*</code> isn't bad for performance</p>",
        "id": 513620128,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745330824
    },
    {
        "content": "<p>WIP part 1 (Algebra without category theory): <a href=\"https://github.com/leanprover-community/mathlib4/pull/24285\">#24285</a></p>",
        "id": 513626822,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745332431
    },
    {
        "content": "<p>Is there any automation to replace <code>(R : Type*) (S : Type*) (M : Type*)</code> by <code>(R S M : Type*)</code> and <code>{R : Type*} {A : Type*}</code> by <code>{R A : Type*}</code>, etc.?</p>",
        "id": 513632180,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1745333683
    },
    {
        "content": "<p>I guess you could write a regex for the basic cases.</p>",
        "id": 513632968,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745333873
    },
    {
        "content": "<p>Not that I know of, but I have many times wished there was!</p>",
        "id": 513632991,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1745333877
    },
    {
        "content": "<p>I suggest not to do it in this PR (because of the way diffs are visualized).</p>",
        "id": 513633645,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745334011
    },
    {
        "content": "<p>Also note that</p>\n<ul>\n<li>category theory relies on a specific order of universe variables, so that <code>Category.{u} C</code> means \"category with morphisms in <code>Type u</code>\";</li>\n<li>definitions and theorems about <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ULift#doc\">docs#ULift</a> should use the same order of universe arguments as <code>ULift</code> does (this is not always the case at the moment), for similar reasons.</li>\n</ul>",
        "id": 513637341,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1745334955
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513620128\">said</a>:</p>\n<blockquote>\n<p>My understanding is that <a href=\"https://github.com/leanprover-community/mathlib4/pull/12737\">#12737</a> tracks slowdowns caused by universe metavariables. But <code>Type*</code> (unlike <code>Type _</code>) introduces a fresh universe parameter, not a metavariable. So I think going from <code>Type u</code> to <code>Type*</code> isn't bad for performance</p>\n</blockquote>\n<p>Yes that is a reasonable belief but see <a class=\"stream-topic\" data-stream-id=\"144837\" href=\"/#narrow/channel/144837-PR-reviews/topic/.2321099.20use.20unification.20hints.20for.20generators/with/496095368\">#PR reviews &gt; #21099 use unification hints for generators</a> normalization of levels includes sorting of names which, last I checked, behaves unexpectedly for names with more than one part or more generally outside of ASCII. If anyone has more time to track down the offending code in core and locate the proper changes, please do.</p>",
        "id": 513638427,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745335225
    },
    {
        "content": "<p>Generally if you're working in an area where the universes are an important part of the theory (like <code>ULift</code> and category theory), you should write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">Y</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>rather than <code>Type*</code></p>",
        "id": 513641555,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1745336024
    },
    {
        "content": "<p>The changes that <span class=\"user-mention\" data-user-id=\"417654\">@Martin Dvořák</span> is proposing also include removing explicit universe annotations (e.g. <code>Category.{v} C</code> -&gt; <code>Category C</code>). This does introduce universe metavariables, so this may give a slowdown.</p>",
        "id": 513641819,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745336081
    },
    {
        "content": "<p>Given the info I have just learnt, I will revert the changes related to categories.</p>",
        "id": 513642023,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745336133
    },
    {
        "content": "<p>I looked a bit further into the slowdowns from universe metavariables, and I think part of the problem is that <code>isDefEq</code> has two kinds of caches: <code>transient</code> and <code>permanent</code> (the <code>permanent</code> one is also temporary, but resets less often). Having (universe) metavariables means that the <code>permanent</code> cache cannot be used.</p>",
        "id": 513643564,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745336549
    },
    {
        "content": "<p>I think I tried using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Expr.hasExprMVar#doc\">docs#Lean.Expr.hasExprMVar</a> instead at some point for the cache. It did help a bit</p>",
        "id": 513643965,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745336661
    },
    {
        "content": "<p>That seems reasonable but I'd also worry if that can introduce bugs in <code>isDefEq</code>.</p>",
        "id": 513644651,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745336839
    },
    {
        "content": "<p>It was very much a hack which is why I didn’t pursue it at all</p>",
        "id": 513644762,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745336871
    },
    {
        "content": "<p>PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/24285\">#24285</a> is ready for review.</p>",
        "id": 513651461,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745338618
    },
    {
        "content": "<p>Benchmark +25.08% in <code>Mathlib.Algebra.Module.Presentation.Tensor</code> ...<br>\nIs it too much? Should I revert the changes in this file?<br>\nPS: I have just noticed that the file is not imported by any other Mathlib file except the sink. Are the changes I made there valid, first of all?</p>",
        "id": 513659767,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745340932
    },
    {
        "content": "<p>Interesting. This should be caused by removing the explicit universe annotation in</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">relations₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Relations</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">w₁₀</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">w₁₁</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I wonder if we should introduce a notation</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">relations₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Relations</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"bp\">*</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>In the same spirit as <code>Type*</code></p>",
        "id": 513661270,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745341306
    },
    {
        "content": "<p>I think all your changes are valid. I think the only one where you actually changed the definition is <code>Mathlib/Algebra/Quotient.lean</code>, but I agree with that change.</p>",
        "id": 513661612,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745341394
    },
    {
        "content": "<p>Ah yeah, this is the one I was worried about the most.</p>",
        "id": 513662230,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745341550
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> had thought about a <code>Category*</code> version in the past. </p>\n<p>I haven’t looked yet but this sounds like a smaller scale incident of what I described before.</p>",
        "id": 513662244,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745341558
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/tree/mrb%2Fmerge_type_stars\">branch#mrb/merge_type_stars</a> merges some <code>Type*</code>’s Please feel free to PR but not that there is currently a Python script to understand the chances. It should probably be removed in the end. </p>\n<p>I will be unavailable for 24-48 hours.</p>",
        "id": 513662467,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1745341635
    },
    {
        "content": "<p>Thanks! Another automation target is to remove declared universe variables that are no longer used.</p>",
        "id": 513663630,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1745342039
    },
    {
        "content": "<p>Absolutely! There are plenty.</p>",
        "id": 513663875,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1745342115
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513620128\">said</a>:</p>\n<blockquote>\n<p>So I think going from <code>Type u</code> to <code>Type*</code> isn't bad for performance</p>\n</blockquote>\n<p>Matthew mentioned an issue (though I'm not sure about the ASCII part, since <code>Type*</code> only creates names of the form <code>u_1</code>, <code>u_2</code>, ...), but another is that <code>Type*</code> adds the new level parameter to the end of the level parameter list, which may result in a different order. Yury mentioned this in the context of API, but I'm mentioning this as something that could cause performance differences (though I don't know if this can cause significant problems).</p>\n<p>(I like the idea of <code>*</code> as a fresh universe level parameter. If it makes it to core, I think it would need to be rethought — it's odd how <code>Type*</code> creates non-hygienic level variables — you can refer to <code>u_1</code> for example.)</p>",
        "id": 513665236,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745342539
    },
    {
        "content": "<p>Yes, I think the implementation of introducing a fresh universe level on the fly should be redone. Although the issue of universe hygiene is more fundamental; that also exists when using <code>Type _</code>.</p>",
        "id": 513666060,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745342784
    },
    {
        "content": "<p>A couple options:</p>\n<ul>\n<li><code>*</code> could create an inaccessible name, and these names can be cleaned in a pass before the declaration is added to the environment.</li>\n<li><code>*</code> could create a level metavariable along with a record in the TermElab state that it is an error if this metavariable unifies with anything (there would be a pass at the end checking for this, flagging the place where the level was introduced along with what it unified to). This is nice since it works just like <code>Type _</code> except for the fact it can throw an error when the uniqueness assumption isn't met.</li>\n</ul>",
        "id": 513666539,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745342943
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513666060\">said</a>:</p>\n<blockquote>\n<p>that also exists when using <code>Type _</code></p>\n</blockquote>\n<p>What hygiene issue are you talking about?</p>",
        "id": 513666583,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745342957
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Eq</span><span class=\"bp\">.</span><span class=\"n\">refl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u_1</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I think this is what you were referring to: the universe level <code>u_1</code> is valid here.</p>",
        "id": 513667202,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745343189
    },
    {
        "content": "<p>Yeah, that's related, and it's using the same system as <code>Type*</code> too. (<code>Type*</code> works by creating a metavariable and immediately using <code>levelMVarToParam</code> on it, rather than waiting for it to be applied at a later elaboration checkpoint. For theorems, that's before elaborating the body.)</p>",
        "id": 513667876,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745343423
    },
    {
        "content": "<p>I think <code>*</code> should create a level parameter, not a metavariable, because we need the function <code>Expr.hasMVar</code> to return false for the better <code>isDefEq</code> cache to be used</p>",
        "id": 513668372,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745343596
    },
    {
        "content": "<p>With my second bulleted option (metavariables), this would also give a better error messages than this one without having to add checks everywhere in the language:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- error is on the whole `theorem` line</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">weird</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">error: AddConstAsyncResult.commitConst: constant has level params [u_1] but expected []</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Compare to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">not_so_weird</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">    </span><span class=\"c1\">--~~ error position</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">failed to infer universe levels in 'have' declaration type</span>\n<span class=\"cm\">  Type (?u.635 + 1)</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 513668575,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745343670
    },
    {
        "content": "<p>That doesn't seem right. If we make it a <code>def</code>, <code>not_so_weird</code> should compile correctly (in the hypothetical implementation of <code>*</code>), but using a metavariable will trigger this error.</p>",
        "id": 513669476,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745344007
    },
    {
        "content": "<p>I think it should have the same effect as the current <code>Type*</code>, appart from issues around naming and hygiene.</p>",
        "id": 513669895,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745344153
    },
    {
        "content": "<p>I noticed some interesting behaviour regarding when universe metavariables get abstracted and when not:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- a : Type ?u.5</span>\n<span class=\"c1\">-- b : Type u_1</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- a : Type u_2</span>\n<span class=\"c1\">-- b : Type u_1</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n\n<span class=\"c1\">-- b : Type u_1</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test''</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>It seems that universe metavariables are not abstracted inside the body if they are introduced via <code>variable</code> and do not (at first) appear in the type, and if we are in a <code>def</code>.</p>\n<p>The file that slowed down by 25% contains <code>isPresentationCoreTensor</code>, which satisfies all these conditions. You can see the offending metavariables with <code>set_option pp.universes true</code></p>",
        "id": 513670440,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745344346
    },
    {
        "content": "<p>Also, the universe names are in a weird order when combining <code>variable</code> and normal arguments:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n<span class=\"c1\">-- a₁ : Type u_3</span>\n<span class=\"c1\">-- a₂ : Type ?u.11</span>\n<span class=\"c1\">-- b₁ : Type u_1</span>\n<span class=\"c1\">-- b₂ : Type u_2</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b₁</span><span class=\"w\"> </span><span class=\"n\">b₂</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 513671045,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745344542
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513665236\">said</a>:</p>\n<blockquote>\n<p>Matthew mentioned an issue (though I'm not sure about the ASCII part, since <code>Type*</code> only creates names of the form <code>u_1</code>, <code>u_2</code>, ...), but another is that <code>Type*</code> adds the new level parameter to the end of the level parameter list, which may result in a different order. Yury mentioned this in the context of API, but I'm mentioning this as something that could cause performance differences (though I don't know if this can cause significant problems).</p>\n</blockquote>\n<p>You know about the 29% speedup in the (unmerged!) <a href=\"https://github.com/leanprover-community/mathlib4/pull/21129\">#21129</a> caused by changing the alphabetical order of the universes, right?</p>\n<p>We have not had the benefit of that speed-up literally thousands of times since then.</p>",
        "id": 513675139,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745345788
    },
    {
        "content": "<p>I didn't <span class=\"user-mention\" data-user-id=\"110038\">@Kevin Buzzard</span>; and I guess that proves that changing universe variable orders could have caused a 29% slowdown (assuming we had a good order from the beginning).</p>",
        "id": 513678911,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745346872
    },
    {
        "content": "<p>Just to be clear, this wasn't \"physical\" universe order changing, this was literally renaming of the universes so that alphabetically they were in a different order. But if that can cause a 29% effect then I'm sure that reordering them can!</p>",
        "id": 513679475,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745347040
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513669476\">said</a>:</p>\n<blockquote>\n<p>If we make it a <code>def</code>, <code>not_so_weird</code> should compile correctly</p>\n</blockquote>\n<p>Declarations with universe levels that can't be inferred from the type are a very special case, and such definitions are harder to use (since you have to provide universe levels). I don't think I'd mind if you had to opt in with an explicit universe level.</p>\n<p>Plus: Is there any case of a universe level that's used only in the body of a declaration that couldn't just be replaced by <code>0</code>?</p>",
        "id": 513680344,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745347325
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513670440\">said</a>:</p>\n<blockquote>\n<p>I noticed some interesting behaviour regarding when universe metavariables get abstracted and when not:</p>\n</blockquote>\n<p>Additionally, for <code>def</code> it also depends on whether the type is a proposition or not. If it's not, everything appears to remain as level metavariables.</p>",
        "id": 513682193,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745347963
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, using explicit universes also gives the error you said is weird:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">u</span>\n\n<span class=\"c1\">-- error is on the whole `theorem` line</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">weird</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"w\"> </span><span class=\"n\">u</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>So I think the problem here is just that  Lean's universe error messages have room for improvement. (Although this isn't a common scenario in practice anyways)</p>",
        "id": 513715193,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745351015
    },
    {
        "content": "<p>It looks like <code>theorem</code> is not removing the <code>universe</code> levels that don't appear in the header. I'd expect \"unknown universe level 'u'\", just like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">notWeird</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"c1\">-- unknown identifier 'x'</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>\n<p>(Ideally it would say a bit more about how these were variables unused in the header.)</p>",
        "id": 513716202,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745351441
    },
    {
        "content": "<p>Like this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- unused universe parameter 'u'</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">goodError</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">u</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 513716587,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1745351609
    },
    {
        "content": "<p>No, in the context of Jovan's example, one direct fix would cause it to say just \"unknown universe level 'u'\" but it could say something more informative like \"universe level 'u' was not used in the theorem header, so it was not included\" with more work.</p>",
        "id": 513716986,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745351765
    },
    {
        "content": "<p>What do we think of a <code>set_option</code> that makes lean throw an error if there are universe metavariables left after elaboration? It would be false by default, but turned on in Mathlib, similar to autoImplicit. This would force the replacement of <code>Type _</code> by <code>Type*</code> when possible. It would be beneficial for performance, but also for readability, because it forces universes to be introduced explicitly (either with a named level, or with the new <code>*</code> syntax for simple cases).</p>",
        "id": 513854618,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1745410346
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/514076519\">said</a>:</p>\n<blockquote>\n<p>The culprits are declarations such as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Extension#doc\">docs#Algebra.Extension</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra.Generators#doc\">docs#Algebra.Generators</a> .</p>\n</blockquote>\n<p>Oops, I hope I didn't cause a diversion in the discussion here. I meant to say \"is there any case of a universe level parameter that's used only in the body of a definition or theorem that couldn't just be replaced by <code>0</code>?\" Structures definitely make use of this sometimes for a seemingly legitimate reason, as you point out. (And that certainly doesn't change the fact that <code>structure</code>s doing this are harder to use!)</p>\n<p>I was thinking about this at some point because one rule Lean could take with the \"failed to infer universe levels\" error is to set them to zero.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">PUnit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"c1\">--         ~~~~~~~~~~</span>\n<span class=\"w\">  </span><span class=\"n\">true</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">failed to infer universe levels in 'let' declaration type</span>\n<span class=\"cm\">  List.{?u.2513} PUnit.{?u.2513 + 1}</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>Indeed, when this error happens, Lean sets the level metavariables to 0 so that it can make progress with the rest of the file.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp</span><span class=\"bp\">.</span><span class=\"n\">universes</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">f</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">def f : Bool :=</span>\n<span class=\"cm\">let xs := List.nil.{0};</span>\n<span class=\"cm\">true</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>\n<p>I don't think this could solve any of the universe level slowness you bring up in any way, unfortunately.</p>",
        "id": 514123293,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1745500617
    },
    {
        "content": "<p>17 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/JacobiZariski.20is.20slow.2E/with/496225223\">#mathlib4 &gt; JacobiZariski is slow.</a> by <span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span>.</p>",
        "id": 514128780,
        "sender_full_name": "Notification Bot",
        "timestamp": 1745501923
    },
    {
        "content": "<blockquote>\n<p>Oops, I hope I didn't cause a diversion in the discussion here.</p>\n</blockquote>\n<p>You did, but that's not a bad thing! Clogging up this discussion is though (and this is my fault not yours), so I moved the relevant posts to the \"JacobiZariski is slow\" thread.</p>",
        "id": 514129316,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1745502059
    },
    {
        "content": "<p>I would like to return to this refactor. Is there an agreement of what the result should look like? Last time I proposed it I had an impression that not everybody had the same idea.</p>",
        "id": 525451025,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1750747537
    },
    {
        "content": "<p>Note that there is also some value in adding universe annotations to e.g. <code>Category</code>. This is the same performance issue we described above, but mathlib is not consistent with this. In <a href=\"https://github.com/leanprover-community/mathlib4/pull/25453\">#25453</a>, all I did was explicitly annotate the universes, and it gives a big speedup:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"n\">Benchmark</span><span class=\"w\">                                                    </span><span class=\"n\">Metric</span><span class=\"w\">         </span><span class=\"n\">Change</span>\n<span class=\"w\">  </span><span class=\"bp\">==================================================================================</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Homology</span><span class=\"bp\">.</span><span class=\"n\">HomotopyCategory</span><span class=\"bp\">.</span><span class=\"n\">DegreewiseSplit</span><span class=\"w\">   </span><span class=\"n\">instructions</span><span class=\"w\">   </span><span class=\"bp\">-</span><span class=\"mf\">36.3</span><span class=\"bp\">%</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Homology</span><span class=\"bp\">.</span><span class=\"n\">HomotopyCategory</span><span class=\"bp\">.</span><span class=\"n\">MappingCone</span><span class=\"w\">       </span><span class=\"n\">instructions</span><span class=\"w\">   </span><span class=\"bp\">-</span><span class=\"mf\">18.9</span><span class=\"bp\">%</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">~</span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Homology</span><span class=\"bp\">.</span><span class=\"n\">HomotopyCategory</span><span class=\"bp\">.</span><span class=\"n\">Triangulated</span><span class=\"w\">      </span><span class=\"n\">instructions</span><span class=\"w\">   </span><span class=\"bp\">-</span><span class=\"mf\">52.0</span><span class=\"bp\">%</span>\n</code></pre></div>\n<p>To aid with this kind of performance improvement, we could add a set_option (false by default) which gives you a warning if a <code>def</code> has to abstract univese metavariables after elaboration. Then one can turn this option on on a branch, and then fix many of these kinds of slowdowns.</p>",
        "id": 525473942,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750756233
    },
    {
        "content": "<p>In category theory and its applications, we also have definitions/lemmas for which we sometimes need to specify the universes explicitly: replacing <code>Type u</code> by <code>Type*</code> in the code would probably lead to uncontrolled permutations of the universe parameters. Then, please do not replace <code>Type u</code> by <code>Type*</code> wherever possible.</p>",
        "id": 525552951,
        "sender_full_name": "Joël Riou",
        "timestamp": 1750781553
    },
    {
        "content": "<p>My experience matches Jovan’s. Before submitting <a href=\"https://github.com/leanprover-community/mathlib4/pull/26366\">#26366</a>, it was stated using <code>Type*</code> to look cool. I just specified universes everywhere and got a ~27% speedup, this is rather impressive. I don’t think I’ll use <code>Type*</code> ever again, even if it means ending up with things like <a href=\"https://github.com/leanprover-community/mathlib4/blob/edf2cbec036cbc703268107faad1b6b16f216c3f/Mathlib/CategoryTheory/Functor/TwoSquare.lean#L33\">this</a> (I wonder how bad the perf on this one would be if we were to <code>Type*</code> everything).</p>",
        "id": 525554316,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1750782031
    },
    {
        "content": "<p>Anecdote: I was told that at one point Coq (when it was called that) took 2/3's of its time dealing with universes. (Details beyond this I don't have but maybe someone has more.)</p>\n<p>Begs the analogous question. Until that is answered, it is hard to lock in to one particular convention.</p>",
        "id": 525555055,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750782331
    },
    {
        "content": "<p>Banishing <code>Type*</code> in general is too harsh. The important thing is to write explicit universe parameters in constants that require them explicitly (<code>Category</code> is the poster child here). But when working with something simple like a <code>Group</code>, using <code>Type*</code> is completely fine.</p>",
        "id": 525557419,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750783266
    },
    {
        "content": "<p>What de people think about using this compromise that uses <code>Type*</code>, but still preserving the better performance:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">v</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span>\n</code></pre></div>\n<p>The universes from <code>Type*</code> always come after the ones from <code>universe</code> commands, which is exactly what we want here. So we end up with lemmas like <code>foo.{v, u_1}</code>.</p>",
        "id": 525558617,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750783706
    },
    {
        "content": "<p>This isn't great. What happens if you want to specify multiple categories?</p>",
        "id": 525558793,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1750783756
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 525558900,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1750783785
    },
    {
        "content": "<p>Oh maybe that's okay!</p>",
        "id": 525558952,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1750783806
    },
    {
        "content": "<p>I presume you mean</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Category</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"n\">v2</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 525559148,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750783868
    },
    {
        "content": "<p>I think even in this case, when doing category theory you very often want to control universe parameters explicitly. For example some times you need to specify universe parameters explicitly in some constructions related to existence of (co)limits, and in those situations, if you use <code>Type*</code>, it's possible you would need to track down the universe's name to be able to write <code>someConstruction.{u_7}</code>.</p>",
        "id": 525560158,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1750784220
    },
    {
        "content": "<p>I think in such a case, writing <code>someConstruction.{_}</code> (or just <code>someConstruction</code>) would suffice, because the universe <code>.{_}</code> would be filled in by unification immediately.</p>",
        "id": 525560514,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750784365
    },
    {
        "content": "<p>But of course if you think it is clearer with the explicit universe annotation, avoid <code>Type*</code> :)</p>",
        "id": 525560677,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750784431
    },
    {
        "content": "<p>My opinion here is that people should be free to use <code>Type*</code> or <code>Type u</code> as they see fit, maybe with these guidelines:</p>\n<ul>\n<li>If you are working in an area where universe levels need to be controlled (like category theory), prefer <code>Type u</code></li>\n<li>If you are working in an area where it's important to avoid accidental universe monomorphism (e.g. avoiding accidentally using <code>u</code> for multiple types when they could have had their own levels), prefer <code>Type*</code></li>\n<li>When reviewing, we shouldn't require using one style or the other, unless it's going to cause an issue (e.g. not using explicit levels in a category theory definition whose levels can't be inferred from any of the arguments). We can politely suggest changes like usual though.</li>\n</ul>",
        "id": 525560812,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750784478
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"286014\">Robin Carlier</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/525554316\">said</a>:</p>\n<blockquote>\n<p>Before submitting <a href=\"https://github.com/leanprover-community/mathlib4/pull/26366\">#26366</a>, it was stated using <code>Type*</code> to look cool. I just specified universes everywhere and got a ~27% speedup, this is rather impressive.</p>\n</blockquote>\n<p>Do we know why this is happening?</p>\n<p>Is this fundamental to <code>Type*</code>, or is there some underlying issue that can be fixed?</p>",
        "id": 525561711,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750784813
    },
    {
        "content": "<p>The issue isn't <code>Type*</code> vs <code>Type u</code>. The issue is <code>Category.{v}</code> vs <code>Category</code>.</p>",
        "id": 525561844,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750784866
    },
    {
        "content": "<p>I'll rebenchmark with Type* + <code>Category.{v}</code>, but at this point if I need to specify, I don't see the advantage of Type* beyond gaining 1 character on a few lines...</p>",
        "id": 525562508,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1750785125
    },
    {
        "content": "<p>(I also don't know how to get precise benchmarks, my way of benchmarking is to grab the compilation command via <code>lake build -v</code> and feed it to hyperfine)</p>",
        "id": 525562620,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1750785180
    },
    {
        "content": "<p>You can leave a comment saying \"!bench\" on your PR. Once with this version, and once after you push the change.</p>",
        "id": 525562819,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750785273
    },
    {
        "content": "<p>Ok, good to know <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>.</p>\n<p>Side note: I wonder if the elaborator should have concepts of explicit universe parameters, implicit universe parameters, and universe outparams?</p>\n<ul>\n<li>In <code>Category</code>, the fact that the first parameter can only be inferred by usage of the category instance leads to all these unfortunate performance problems, where if the elaborator enforced writing <code>Category.{v}</code> (or at least <code>Category.{_}</code>) you'd either solve the issue or know that there's a metavariable involved.</li>\n<li>In <code>HasDerivedCategory</code>, I saw someone struggle a lot with the fact that one of the levels is actually sort of an 'outparam', and it's unclear from the interface that this is the case. The consequence is that if you use a <code>sorry</code>ed-out <code>HasDerivedCategory</code> instance, your theorems get a mysterious extra universe level. Ideally the status of this mysterious extra universe level could be more explicit, that it's meant to be determined by the other parameters and the specific arguments to the constant.</li>\n</ul>",
        "id": 525562823,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1750785279
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479299\">Jovan Gerbscheid</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/525562819\">said</a>:</p>\n<blockquote>\n<p>You can leave a comment saying \"!bench\" on your PR. Once with this version, and once after you push the change.</p>\n</blockquote>\n<p>I know, but I'd rather waste my electricity and compute than other's for my tests, and I'd really prefer if it there was a way to get similarly detailed info locally.</p>",
        "id": 525563164,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1750785435
    },
    {
        "content": "<p>Re-tested with <code>Type*</code> + <code>Category.{v}</code> confirms <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span>’s prediction: perfs are identical compared to the ones with explicitly named universes. So <code>[Category]</code> is the bad child here.<br>\nShould we go on a hunt to see if we can speed up the lib?</p>",
        "id": 525571136,
        "sender_full_name": "Robin Carlier",
        "timestamp": 1750788761
    },
    {
        "content": "<p>Don't forget to also do the JacobiZariski file, where there are <code>Algebra.Extension</code>s which don't have specified universes (which may or may not make this file very slow).</p>",
        "id": 525583866,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1750794105
    },
    {
        "content": "<p>I don't think this is the problem in JacobiZarisky, sadly.</p>",
        "id": 525584492,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750794408
    },
    {
        "content": "<p>My instinct is that that file has many problems and we're solving them one by one</p>",
        "id": 525585885,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1750795024
    },
    {
        "content": "<p>Maybe, but I think that list excludes this one</p>",
        "id": 525585986,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750795066
    },
    {
        "content": "<p>Maybe. That weird speed-up we got when we rearranged universe alphabetical order is still something I'm baffled by.</p>",
        "id": 525591557,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1750797512
    },
    {
        "content": "<p>Because it is a total hack</p>",
        "id": 525591651,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750797552
    },
    {
        "content": "<p>Most likely, the terms that get sent to the kernel are extremely sensitive to level perturbations or permutations.</p>",
        "id": 525591837,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750797636
    },
    {
        "content": "<p>is it known if this is an issue in the kernel or the elaborator?</p>",
        "id": 525594273,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750798665
    },
    {
        "content": "<p>I suspect there is some overlap but the larger problem is the kernel itself.</p>",
        "id": 525594805,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750798899
    },
    {
        "content": "<p>if you (or anyone) can make a reproducible example I can play with it in lean4lean and maybe give some more concrete feedback</p>",
        "id": 525595000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1750798991
    },
    {
        "content": "<p>Please, I tried to do this but had limited time and failed.  I would start at <code>RingTheory.Kaehler.JacobiZariski</code></p>",
        "id": 525595222,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750799090
    },
    {
        "content": "<p>Maybe someone else has had success minimizing since the long ago</p>",
        "id": 525595275,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1750799110
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/525562823\">said</a>:</p>\n<blockquote>\n<p>Side note: I wonder if the elaborator should have concepts of explicit universe parameters, implicit universe parameters, and universe outparams?</p>\n</blockquote>\n<p>I've wanted this quite often for the pp_with_univ pretty-printer, in the simplified form of \"just show the first n parameters\"</p>",
        "id": 525595429,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1750799194
    },
    {
        "content": "<p>For explicit/implicit universe parameters, do you mean that we could mark this by hand, or that a parameter is explicit whenever it cannot be inferred from the arguments (like in Category or PUnit)?</p>",
        "id": 525595874,
        "sender_full_name": "Jovan Gerbscheid",
        "timestamp": 1750799416
    },
    {
        "content": "<p>16 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/JacobiZariski.20in.20lean4lean/with/525597095\">#mathlib4 &gt; JacobiZariski in lean4lean</a> by <span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span>.</p>",
        "id": 525665077,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750841755
    },
    {
        "content": "<p>Couldn't there just be a linter warning that could be disactivated either locally or globally if needed?</p>",
        "id": 525797540,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1750889559
    },
    {
        "content": "<p>I apologize for the long silence. I need to submit my Ph.D. thesis by the end of this year, then I will have time to open a new attempt at solving Task 26.</p>",
        "id": 561884819,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1764856890
    },
    {
        "content": "<p>I would strongly advise against doing this in the near-to-intermediate future.</p>",
        "id": 561909471,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764862346
    },
    {
        "content": "<p>Have the community's preferences changed? Or are there too many open PRs that would get a collision?</p>",
        "id": 561940603,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1764870226
    },
    {
        "content": "<p><a href=\"#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513600720\">https://leanprover.zulipchat.com/#narrow/channel/287929-mathlib4/topic/Task.2026.3A.20Replace.20Type.20u.20by.20Type*.20wherever.20possible/near/513600720</a> <br>\nThe top of the thread already calls for caution.</p>",
        "id": 561941030,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1764870339
    },
    {
        "content": "<p>We also have related elaborators under consideration. <a href=\"https://github.com/leanprover-community/mathlib4/pull/32374\">#32374</a> </p>\n<p>Even if this is merged, we will need time to discuss adaptation.</p>",
        "id": 561941466,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1764870468
    },
    {
        "content": "<p>Anyways... I will ask again in a month.</p>",
        "id": 561941479,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1764870472
    },
    {
        "content": "<p>Is there a consensus what should be changed? Should I create a new PR?</p>",
        "id": 566574965,
        "sender_full_name": "Martin Dvořák",
        "timestamp": 1767715721
    },
    {
        "content": "<p>Haven't read everything, but I believe this change is not always desirable. All the theories that involve universes (anything that pen-and-paper math would call a proper class) do sometimes need specified explicit universes. This includes but is not limited to categories, ordinals/cardinals, and anything about ULift/Shrink</p>",
        "id": 566876638,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1767855079
    },
    {
        "content": "<p>If you're in some file like <code>Order.Basic</code> then yeah, I think this change at least reduces some minimal amount of noise.</p>",
        "id": 566877036,
        "sender_full_name": "Violeta Hernández",
        "timestamp": 1767855290
    }
]