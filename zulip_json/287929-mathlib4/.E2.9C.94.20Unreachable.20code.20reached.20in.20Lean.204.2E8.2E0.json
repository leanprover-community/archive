[
    {
        "content": "<p>I've hit a strange bug where, after writing <code>generalize_proofs</code>, the Lean Goal panel would completely ignore whatever happens afterwards. Writing more tactics doesn't change the goal, no errors are produced, even if writing something that should blatantly raise an error (ie. <code>simp; simp</code>).</p>\n<p>I've then tried to directly compile the project, in case this was an LSP issue, and I got the error message:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">PANIC</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GeneralizeProofs</span><span class=\"bp\">.</span><span class=\"n\">mkLambdaFVarsUsedOnly</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">GeneralizeProofs</span><span class=\"o\">:</span><span class=\"mi\">206</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unreachable</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">reached</span>\n<span class=\"n\">backtrace</span><span class=\"o\">:</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>I've tried to make a MWE out of it, but it's excruciatingly painful to do so when triggering the bug breaks your editor, if you don't have better debuging tools / have an idea of what exactly triggers the bug. So, instead, I'll just give the repo: <a href=\"https://github.com/jthulhu/2ltt\">https://github.com/jthulhu/2ltt</a>. The bug can be reproduced by going at the line 664 of the file <code>Tltt/DirectCategories.lean</code>, and uncomment <code>generalize_proofs</code>.</p>",
        "id": 449286780,
        "sender_full_name": "jthulhu",
        "timestamp": 1720177964
    },
    {
        "content": "<p>fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/14444\">#14444</a> (probably), can you verify that the error does not reproduce on that branch?</p>",
        "id": 449289959,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720179256
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/stream/270676-lean4/topic/Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0\">#lean4 &gt; Unreachable code reached in Lean 4.8.0</a> by <span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span>.</p>",
        "id": 449290005,
        "sender_full_name": "Notification Bot",
        "timestamp": 1720179293
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449289959\">said</a>:</p>\n<blockquote>\n<p>fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/14444\">#14444</a> (probably), can you verify that the error does not reproduce on that branch?</p>\n</blockquote>\n<p>You're pretty reactive to fix bugs <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span><br>\nI'll try to reproduce, but it'll take some time to build that version of mathlib on my machine.</p>",
        "id": 449290650,
        "sender_full_name": "jthulhu",
        "timestamp": 1720179472
    },
    {
        "content": "<p>if you give it an hour or so it will finish building in CI and then you can just download the cache from it</p>",
        "id": 449290865,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720179558
    },
    {
        "content": "<p>Incidentally, just out of curiosity, what was the issue (assuming that your fix actually patches my problem)?</p>",
        "id": 449291078,
        "sender_full_name": "jthulhu",
        "timestamp": 1720179641
    },
    {
        "content": "<p>Never mind, someone else explained it to me.</p>",
        "id": 449298686,
        "sender_full_name": "jthulhu",
        "timestamp": 1720181567
    },
    {
        "content": "<p>What version of Lean do I need to have to check that that branch works?</p>",
        "id": 449310975,
        "sender_full_name": "jthulhu",
        "timestamp": 1720185049
    },
    {
        "content": "<p>Normally, <code>elan</code> just figures that out for you. The version you need is whatever the <code>lean-toolchain</code> file contains.</p>",
        "id": 449318447,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720187645
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449318447\">said</a>:</p>\n<blockquote>\n<p>Normally, <code>elan</code> just figures that out for you. The version you need is whatever the <code>lean-toolchain</code> file contains.</p>\n</blockquote>\n<p>I try to use my package manager instead of <code>elan</code> when possible. I've checked the <code>lean-toolchain</code> file as you suggested and installed the corresponding Lean version, 4.10.0-rc1.</p>\n<p>Besides a few modifications that I had to do to the project for it to compile, as there are some API changes between Lean 4.8.0 and Lean 4.10.0, it failed to compile with the following error message:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">âœ–</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">446</span><span class=\"bp\">/</span><span class=\"mi\">4513</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Fetching</span><span class=\"w\"> </span><span class=\"n\">proofwidgets</span><span class=\"o\">:</span><span class=\"n\">release</span>\n<span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">proofwidgets</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">wanted</span><span class=\"w\"> </span><span class=\"n\">prebuilt</span><span class=\"w\"> </span><span class=\"n\">release</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">revision</span>\n<span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">fetch</span><span class=\"w\"> </span><span class=\"n\">cloud</span><span class=\"w\"> </span><span class=\"n\">release</span>\n<span class=\"o\">[</span><span class=\"bp\">...</span><span class=\"o\">]</span>\n<span class=\"n\">Some</span><span class=\"w\"> </span><span class=\"n\">builds</span><span class=\"w\"> </span><span class=\"n\">logged</span><span class=\"w\"> </span><span class=\"n\">failures</span><span class=\"o\">:</span>\n<span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">proofwidgets</span><span class=\"o\">:</span><span class=\"n\">release</span>\n</code></pre></div>\n<p>I don't know what that error message means, so I have no idea how to solve this issue.</p>",
        "id": 449330996,
        "sender_full_name": "jthulhu",
        "timestamp": 1720191633
    },
    {
        "content": "<p>Delete .lake and try again? This fixes some proofwidgets issues. Also make sure your lean-toolchain is the same as mathlib's.</p>",
        "id": 449344882,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720195472
    },
    {
        "content": "<p>Incidentally, this is not really related to the rest of the issue, but I guess this is a good time to ask: when I compile Lean projects, I see a lot of warnings</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">info</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">gcc</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">vgzmgmppvpb6gqlc56jhcn007cjn7xg9</span><span class=\"bp\">-</span><span class=\"n\">gmp</span><span class=\"bp\">-</span><span class=\"k\">with</span><span class=\"bp\">-</span><span class=\"n\">cxx</span><span class=\"bp\">-</span><span class=\"mf\">6.3</span><span class=\"bp\">.</span><span class=\"m\">0</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libgmp</span><span class=\"bp\">.</span><span class=\"n\">so</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">unused</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">linking</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">done</span>\n</code></pre></div>\n<p>one for each module built. That's mildly annoying, as it makes significantly harder to find relevant error messages (especially when there are thousands of modules being built, such as for Mathlib). Is there a way to remove these warnings?</p>\n<p>Also, when I tried to <code>lake exe cache get</code> to get Mathlib from the binary cache, but the error message I get is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Attempting</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">download</span><span class=\"w\"> </span><span class=\"mi\">4776</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">attempted</span><span class=\"w\"> </span><span class=\"mi\">4776</span><span class=\"bp\">/</span><span class=\"mi\">4776</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"o\">)</span>\n<span class=\"n\">Warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"w\"> </span><span class=\"n\">were</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"bp\">.</span>\n<span class=\"n\">This</span><span class=\"w\"> </span><span class=\"n\">usually</span><span class=\"w\"> </span><span class=\"n\">means</span><span class=\"w\"> </span><span class=\"n\">that</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"n\">checkout</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">diverged</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">upstream</span><span class=\"bp\">.</span>\n<span class=\"n\">If</span><span class=\"w\"> </span><span class=\"n\">you</span><span class=\"w\"> </span><span class=\"n\">push</span><span class=\"w\"> </span><span class=\"n\">your</span><span class=\"w\"> </span><span class=\"n\">commits</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">branch</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">mathlib4</span><span class=\"w\"> </span><span class=\"n\">repository</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">CI</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">oleans</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">they</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">available</span><span class=\"w\"> </span><span class=\"n\">later</span><span class=\"bp\">.</span>\n<span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">cache</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">decompress</span>\n</code></pre></div>\n<p>and, indeed, when I <code>lake build</code>, it does build Mathlib \"from scratch\". I'm not sure whether this is the expected behavior.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449344882\">said</a>:</p>\n<blockquote>\n<p>Delete .lake and try again? This fixes some proofwidgets issues. Also make sure your lean-toolchain is the same as mathlib's.</p>\n</blockquote>\n<p>I've checked that both <code>lean-toolchain</code> contain the same text, so that should be ok. I've delete the <code>.lake</code> and trying to rebuild, but, since I haven't managed to fetch prebuilt Mathlib binaries from the cache, this is going to take a while.</p>",
        "id": 449351081,
        "sender_full_name": "jthulhu",
        "timestamp": 1720196868
    },
    {
        "content": "<p>Do you have a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> for this problem so that we can add it as a test case to Mario's PR?</p>",
        "id": 449356523,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720198962
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449356523\">said</a>:</p>\n<blockquote>\n<p>Do you have a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> for this problem so that we can add it as a test case to Mario's PR?</p>\n</blockquote>\n<p>No, as said in the original post, I tried making one, but it was too long, because the bug manifests itself by breaking the text editor, so the feedback loop of removing things and try if that still makes the bug trigger is much less tight that it usually is. I might pour a couple of hours this week-end in trying again, but, in the meantime, the (non-minimal) example is available in the repository, at <a href=\"https://github.com/jthulhu/2ltt/commit/6736a1232a33f2314b008d5f71ac10d9ea9c1005\">this commit</a>.</p>",
        "id": 449358195,
        "sender_full_name": "jthulhu",
        "timestamp": 1720199301
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"674423\">@jthulhu</span> The cache is probably not working since it seems that you are building a custom version of Lean. So then the hashes might be different from the hashes in the cache...</p>",
        "id": 449359331,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720199503
    },
    {
        "content": "<p>I left a message on <a href=\"https://github.com/leanprover-community/mathlib4/pull/14444\">#14444</a> with an example that triggers an \"unreachable code has been reached\" bug. If it's the same one, then probably no need to make a mwe.</p>",
        "id": 449360973,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720200034
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449359331\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"674423\">jthulhu</span> The cache is probably not working since it seems that you are building a custom version of Lean. So then the hashes might be different from the hashes in the cache...</p>\n</blockquote>\n<p>Is there a way to overwrite this behavior? I'm using the version of Lean packaged by my distribution (or at least through the package manager of my distribution, when it is not yet packaged, as for Lean 4.10.0-rc1), which applies some very minor patches (ie it changes some paths so that Lean finds what it looks for where it actually is).</p>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449360973\">said</a>:</p>\n<blockquote>\n<p>I left a message on <a href=\"https://github.com/leanprover-community/mathlib4/pull/14444\">#14444</a> with an example that triggers an \"unreachable code has been reached\" bug. If it's the same one, then probably no need to make a mwe.</p>\n</blockquote>\n<p>As far as I understand it, your example gives the same error I was witnessing.<br>\nThe build of Mathlib has finally finished and the patch solves the issue on my end.</p>\n<p>Besides, I have to say, I am greatly impressed by your efficiency, the PR fixing the bug I witnessed was opened about 20 minutes after the bug report (which was not of very high quality)!!!!</p>",
        "id": 449367587,
        "sender_full_name": "jthulhu",
        "timestamp": 1720202325
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"674423\">jthulhu</span> has marked this topic as resolved.</p>",
        "id": 449367596,
        "sender_full_name": "Notification Bot",
        "timestamp": 1720202328
    },
    {
        "content": "<p>We very much recommend against that</p>",
        "id": 449373581,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720204073
    },
    {
        "content": "<p>Surely you don't mean recommending against being impressed by efficiency, right <span class=\"user-mention\" data-user-id=\"307953\">@Ruben Van de Velde</span>?</p>",
        "id": 449374570,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720204586
    },
    {
        "content": "<p>Efficiency only gets you more work, celebrate being inefficient <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 449376015,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720205200
    },
    {
        "content": "<p>Just to clarify, Ruben is pointing out that it's strongly recommended to use <code>elan</code> and avoid all distro package managers; our entire ecosystem is set up under this assumption. We discourage people from packaging versions of Lean in their distros (not least because the packaging system is usually unable to keep up with the release schedule).</p>",
        "id": 449401190,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720215276
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449401190\">said</a>:</p>\n<blockquote>\n<p>Just to clarify, Ruben is pointing out that it's strongly recommended to use <code>elan</code> and avoid all distro package managers; our entire ecosystem is set up under this assumption. We discourage people from packaging versions of Lean in their distros (not least because the packaging system is usually unable to keep up with the release schedule).</p>\n</blockquote>\n<p>This is completely understandable (Lean IMO should have no obligation to support distro packaging), though it is especially difficult for Nix users since its purpose lies in reproducibility integrated with the OS that is kind of a special case. As I've mentioned before, Nix does have <code>elan</code> as a package which allows you to sidestep this, at the cost of the usual Nix workflow. Past that, I think it'll have to wait until there is more interest/intersection in skills of Lean developers and Nix users. (Though I occasionally see some PRs mentioning Nix, I'm not sure what exactly is being worked on)</p>",
        "id": 449402158,
        "sender_full_name": "Chris Henson",
        "timestamp": 1720215916
    },
    {
        "content": "<p>I think that &gt; 25% people at the Lean FRO are using Nix... so there is quite some intersection already. But I also think that they all happily use <code>elan</code> and let it do its magic.</p>",
        "id": 449436773,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720240337
    },
    {
        "content": "<p>I also don't see any problems with using <code>elan</code> from a reproducibility point of view. It actually helps. People using elan have lean projects that are so reproducible that they can share a build cache that is content-addressed.</p>",
        "id": 449436838,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720240441
    },
    {
        "content": "<p>I didn't at all mean to imply there is not reproducibility, just that from the Nix point of view it's a little different to allow <code>elan</code> to handle things. (I do this myself, but I'm probably a less \"hardcore\" Nix user than some). In my mind I was comparing to for instance Rust's Nix overlays or haskell.nix, which to my knowledge there is not a Lean equivalent. As an analogy, I'd compare it to using rustup or cabal's Nix package to manage everything. There's still a level of reproducibility, but it runs a little counter to declaratively specifying dependencies via Nix.</p>",
        "id": 449440249,
        "sender_full_name": "Chris Henson",
        "timestamp": 1720243422
    },
    {
        "content": "<p>I can see why people would discourage from using their package manager, favouring <code>elan</code> instead, but there are also many reasons why I would personally choose to stick with Nix, even if that involves not having an \"out-of-the-box experience\".</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449401190\">said</a>:</p>\n<blockquote>\n<p>We discourage people from packaging versions of Lean in their distros (not least because the packaging system is usually unable to keep up with the release schedule).</p>\n</blockquote>\n<p>For me specifically, this is not a problem, as I have bumped nixpkgs' Lean version when I needed a more recent one, and I also know how to do build Lean locally through Nix (that's what I did to install Lean 4.10.0-rc1). Eventually, I'd like to automate the process of version bumping of Lean in nixpkgs so that the delay for availability of Lean in nix can be further reduced (currently, landing a PR in nixpkgs can take some time). I'd also like to package Mathlib in Nix (among other things, to have a prebuilt cache of the <em>stable</em> version of Mathlib, not just nightly, which, if I understand correctly, is currently the case), but that seems to be a bit more involved.</p>\n<p>IMO, Lean has no obligation to package itself for any distribution, it still should make it easy to packagers to do their job, by decoupling as much as possible what is done that could be done by a package manager instead, and what should be done by a Lean tool anyways. This way, it's easier to just swap out a part of your tooling with a package manager.</p>",
        "id": 449440350,
        "sender_full_name": "jthulhu",
        "timestamp": 1720243509
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"112680\">Johan Commelin</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449436838\">said</a>:</p>\n<blockquote>\n<p>I also don't see any problems with using <code>elan</code> from a reproducibility point of view. It actually helps. People using elan have lean projects that are so reproducible that they can share a build cache that is content-addressed.</p>\n</blockquote>\n<p>I don't have any specific example for <code>elan</code> in particular, as I am very new to Lean and its tooling, but in general, the problems of these tools are:</p>\n<ul>\n<li>they have a very limited scope (what happens if I need to specify a dependency that is <em>not</em> a Lean project? what happens if my build step requires more than just calling the Lean compiler with the right arguments on the right files? what happens if I build software using Lean and I want to distribute it, hopefully making it available to everyone no matter the package manager they use?)</li>\n<li>they implement less functionalities than Nix, or same functionalities but done worse (does <code>elan</code> give the same reproducibility guarantees as Nix? does it allow aggressive sharing of duplicated dependency artifacts? does it ensure that the required system libraries are available and of the correct version? does it consistently avoid getting in weird internal states where to only solution is to wipe out everything and start over? [this last point is one that I see very consistently among different language-specific package managers, including <code>elan</code> and <code>cargo</code> for instance])</li>\n</ul>\n<p>Most users don't care about these details, especially for Lean where most (some? I don't know the proportions) users are mathematicians which are not very tech-savvy. But hopefully this gives you an idea about why certain users would prefer using their package manager when possible in place of `elan'. And, in a broader picture, it is normal to expect less of a package manager which is only a byproduct of a programming language than of a package manager which is the main software developed by those who do it.</p>",
        "id": 449441625,
        "sender_full_name": "jthulhu",
        "timestamp": 1720244585
    },
    {
        "content": "<p>I'm generally on your side here, but \"mathematicians which are not very tech-savvy\" is a bit tactless. There are lots of different backgrounds here, no need to stereotype.</p>",
        "id": 449442203,
        "sender_full_name": "Chris Henson",
        "timestamp": 1720245173
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"687698\">Chris Henson</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449442203\">said</a>:</p>\n<blockquote>\n<p>I'm generally on your side here, but \"mathematicians which are not very tech-savvy\" is a bit tactless. There are lots of different backgrounds here, no need to stereotype.</p>\n</blockquote>\n<p>My sentence was meant to be parsed as \"most users are (mathematicians which are not very tech-savvy)\", not \"most users are mathematicians, which are not very tech-savvy\". I'm sorry if that was unclear. I'm saying this because, after discussing similar topics with the developers of Agda, it turned out that the main reason for wanting an \"out-of-the-box experience\" was that they also wanted Agda to be accessible to mathematicians which are not to be tech-savvy (which is not all mathematicians, of course).</p>",
        "id": 449442556,
        "sender_full_name": "jthulhu",
        "timestamp": 1720245565
    },
    {
        "content": "<p>Something that I've noticed is that tech-savvy users somehow get their systems into very \"custom\" states, which is not fun to help remotely debug. It's very helpful when everyone has basically the same setup to make sure that when people come here with questions, they're definitely Lean questions and not I-have-a-very-subtle-setup-issues questions.</p>\n<p>When you're starting to learn Lean, the primary focus should be on the language, not on whether you have the right version of Lean, the right version of the libraries, and the right version of a learning project (like Mathematics in Lean). That's independent of whether the user is tech-savvy.</p>\n<p>It's fair wanting control over how Lean is installed and setup, but unless that's all being handled say by some correctly configured packaging system, so far it seems this is only for those who are both tech- and Lean-savvy at the moment.</p>",
        "id": 449542366,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720290563
    },
    {
        "content": "<p>I should say that while I don't use nix when developing Lean on my personal machine, I do use nix via the Lean CI. For me at least, that sort of reproducibility guarantee is enough, and I'm not sure what I'd gain personally with local reproducible builds (that's partly thinking about how the Lean ecosystem looks at the moment and working with bleeding-edge mathlib, and partly ignorance about nix).</p>",
        "id": 449545116,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1720292738
    },
    {
        "content": "<p>My understanding is that the biggest benefit of nix for lean devs specifically is that it has a fine-grained distributed build cache not unlike <code>lake exe cache</code>, but for lean core builds (which takes me about a half hour to do normally). I've never installed or tried to use nix, but I am majorly tempted to figure out how to scale the mountain if that payoff is real</p>",
        "id": 449545844,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720293089
    },
    {
        "content": "<p>I think nixpkgs lean should work fine with <code>lake exe cache get</code> if you override <code>src</code> to fetch by sha1 instead of fetching by tag. At some point, nixpkgs switched to using <code>\"-DUSE_GITHASH=OFF\"</code> and mishandling the <code>GIT_SHA1</code> replacement (presumably for convenience?), but that's not enough for <code>lake exe cache get</code>.</p>",
        "id": 449548065,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1720293635
    },
    {
        "content": "<p>(Also, on my opinion, people overuse the <code>finalAttrs</code> pattern on Nixpkgs these days)</p>",
        "id": 449548263,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1720293687
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449545844\">said</a>:</p>\n<blockquote>\n<p>My understanding is that the biggest benefit of nix for lean devs specifically is that it has a fine-grained distributed build cache not unlike <code>lake exe cache</code>, but for lean core builds (which takes me about a half hour to do normally). I've never installed or tried to use nix, but I am majorly tempted to figure out how to scale the mountain if that payoff is real</p>\n</blockquote>\n<p>No, there isn't a distributed cache anymore as even I stopped using it and it only slows down CI. Querying and fetching the cache in Nix is slow and building locally is ~30% slower than without Nix, so when you rebuild Lean frequently you easily end up being slower with Nix.</p>",
        "id": 449548537,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1720293751
    },
    {
        "content": "<p>I don't think using nixpkgs lean will ever be viable for mathlib development without overrides, though, since mathlib tracks release candidates and presumably Nixpkgs would like to stay on stable versions.</p>",
        "id": 449548742,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1720293809
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449548537\">said</a>:</p>\n<blockquote>\n<p>No, there isn't a distributed cache anymore as even I stopped using it and it only slows down CI. Querying and fetching the cache in Nix is slow and building locally is ~30% slower than without Nix, so when you rebuild Lean frequently you easily end up being slower with Nix.</p>\n</blockquote>\n<p>Would Mario benefit from nix-less ccache? I don't remember if it's enabled by default (whenever the <code>ccache</code> package is installed, of course).</p>\n<p>Edit: Apparently it is! Sorry for the noise.</p>",
        "id": 449549116,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1720293897
    },
    {
        "content": "<p>my guess is that in my usual use case <code>make</code> alone is sufficient; it's not that often that I need to reuse a build result after clobbering it with something else</p>",
        "id": 449549623,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720294073
    },
    {
        "content": "<p>if I was doing more frequent bugfix PRs I can imagine that being more useful e.g. to go back and forth between master and bugfix PRs</p>",
        "id": 449549733,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720294117
    },
    {
        "content": "<p>but usually master has moved on after every such PR so I have to rebuild anyway</p>",
        "id": 449549765,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1720294138
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"325367\">Mauricio Collares</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449548742\">said</a>:</p>\n<blockquote>\n<p>I don't think using nixpkgs lean will ever be viable for mathlib development without overrides, though, since mathlib tracks release candidates and presumably Nixpkgs would like to stay on stable versions.</p>\n</blockquote>\n<p>But for Rust Nix overlays for instance, you are for instance able to specify a nightly compiler. I don't know how the internals work exactly (maybe it only uses nixpkgs for stable releases, or uses another source directly?) but I'm sure you could build some Lean equivalent. If a motivated Nix user wants something like this, I'm sure they <em>could</em> build it themselves, but it's not something I recall seeing discussion of, so maybe not a high priority even among Nix users. </p>\n<p>My use case for nix is maybe less sophisticated than all of the discussion of caching. I just like the fact that I can count on my fingers the things I've installed outside of Nix on my computer. So if I move to a new machine, I just install Nix, clone my config, and let it install everything. Maybe it is a bit of using a sledgehammer to crack a nut in my case.</p>",
        "id": 449556531,
        "sender_full_name": "Chris Henson",
        "timestamp": 1720297104
    },
    {
        "content": "<p>You're welcome to run your computer how you like it, of course. You just run the risk that very few people will be able to help you if things don't work</p>",
        "id": 449557769,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720297424
    },
    {
        "content": "<p>If this is turning into a valuable discussion about nix then for future visibility someone might want to split this discussion off from the rest of the thread.</p>",
        "id": 449557999,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1720297474
    },
    {
        "content": "<p>For the reproducibility of your setup, which I appreciate as a goal (NixOS user here myself) using <code>elan</code> from nix and then let elan fetch the lean toolchains as needed isn't too bad actually. There is usually no relevant state managed by elan, and if you wipe your <code>~/.elan</code> or move to a new machine, it'll basically just work, thanks to the lean-toolchain files in each project.  It would be nice to not have layers on layers of build systems, but pragmatically it's fine. And getting lean any other way is going to be an uphill battle for the foreseeable future.</p>",
        "id": 449564073,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1720302278
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449542366\">said</a>:</p>\n<blockquote>\n<p>Something that I've noticed is that tech-savvy users somehow get their systems into very \"custom\" states, which is not fun to help remotely debug. It's very helpful when everyone has basically the same setup to make sure that when people come here with questions, they're definitely Lean questions and not I-have-a-very-subtle-setup-issues questions.</p>\n</blockquote>\n<p>From my experience with other language/framework-specific package managers, this is directly related to how everything is coupled together. Basically, if the language package manager is tightly coupled with every other aspects of the toolchain, and there is no clear distinction between fetching dependencies, finding them on the filesystem, and building, then packagers (for the package manager of your distribution) will resort to a lot more hacks to get things done, which in turn makes debugging hard. But, on the other hand, the more these components are decoupled, the more straightforward the packaging is, and also the easier the remote debugging is, because no tool in the toolchain was cheated or hacked around to make things work.</p>\n<blockquote>\n<p>When you're starting to learn Lean, the primary focus should be on the language, not on whether you have the right version of Lean, the right version of the libraries, and the right version of a learning project (like Mathematics in Lean). That's independent of whether the user is tech-savvy.</p>\n</blockquote>\n<p>Yes, of course. Not everyone values having fine-grained control over how stuff is installed on their computers, and it's probably fair to say they shouldn't pay the extra complexity just for the sake of very few people (comparatively speaking) who do value it. I'm not saying there shouldn't an automagical tool that does everything uniformly for you, and that is also promoted as the standard way of installing Lean.</p>\n<blockquote>\n<p>It's fair wanting control over how Lean is installed and setup, but unless that's all being handled say by some correctly configured packaging system, so far it seems this is only for those who are both tech- and Lean-savvy at the moment.</p>\n</blockquote>\n<p>Yes, but beware of making circular arguments: the toolchain currently being hard to customize with external components right now doesn't mean it <em>has</em> to be. Ideally, you wouldn't have to face as much complexity as you do today to be able to use whatever tool you want in place of <code>elan</code>.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449545116\">said</a>:</p>\n<blockquote>\n<p>I should say that while I don't use nix when developing Lean on my personal machine, I do use nix via the Lean CI. For me at least, that sort of reproducibility guarantee is enough, and I'm not sure what I'd gain personally with local reproducible builds (that's partly thinking about how the Lean ecosystem looks at the moment and working with bleeding-edge mathlib, and partly ignorance about nix).</p>\n</blockquote>\n<p>Reproducibility is just one of the reasons you might want to use Nix instead of elan, as an end-user. Not that you <em>should</em> use Nix. What I mean is that someone using Nix and stating they'd prefer to use it rather than elan doesn't necessarily say so for reproducibility reasons.</p>\n<p>To give you an (additional) example, imagine you have just read that a very serious exploit has been discovered in a certain version of a library, and it's crucial that you avoid executing code from that version of that library on your computer. A patched version has been released, that is compatible in every way with the previous version except it doesn't have the exploit, and you have to update every project you have on your machine to this version of the library. Scenario 1: for every language / combination of languages / framework, you have used their specific package manager. This is a mess: you have to go in each project one by one, and, depending on the capabilities of the package manager, it's more or less of a hassle to understand if that particular library is a transitive dependency, and how to update it (maybe it's a dependency of dependency A, and dependency A hasn't updated they dependencies yet, so you need to learn how to <em>overwrite</em> dependencies of dependencies, assuming the language-specific manager even has that feature). It's long, tedious, and, in the end, how can you be sure that the library in question is still not somewhere? These tools don't have some magical command that aggregates for you everything they manage, so maybe it's still installed for some reasons unknown to you, because you are not knowledgeable enough with those tools. Scenario 2: you use Nix everywhere. For every project, you pin the current version of nixpkgs, which itself has swaped out the library for you (presumably, because it's urgent) or, if they haven't done that yet, you quickly write your own overlay, and deploy it in every project. Easy, straightforward, and scriptable. Because you have a global index of everything that is installed, you can <em>check</em> whether the library is still available somewhere. If it is, maybe because some project had some special quirks you were not aware of, you can ask Nix to pinpoint which projects exactly for you, and to tell you <em>why</em> something still depends on that library, which can always be explicitly overwritten.</p>\n<p>Hopefully, this should help you understand why, from my point of view at least, every language-specific package manager makes things easier for the language, but is a burden for the user (even if they might not realize so). And this is independent from Nix and reproducibility: the same argument could have been made with any distro package manager (more or less).</p>\n<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Unreachable.20code.20reached.20in.20Lean.204.2E8.2E0/near/449557769\">said</a>:</p>\n<blockquote>\n<p>You're welcome to run your computer how you like it, of course. You just run the risk that very few people will be able to help you if things don't work</p>\n</blockquote>\n<p>Yes, of course. This is an additional motivation for me to understand what I'm doing, both Nix-wise and Lean-wise (which is not necessarily currently the case...), so that if someone needs help and is in this niche situation, I could try to help them. But I do understand that, for the Lean community, it might be too much of a burden to keep track of every niche setup and being capable of providing helpful advice in these cases. I'm not dogmatic about it: if I really were stuck with Nix, and no one could help me, I would switch to using elan (which is what happens for Mathlib anyways).</p>",
        "id": 449607720,
        "sender_full_name": "jthulhu",
        "timestamp": 1720330267
    },
    {
        "content": "<p>I imagine we'd welcome a page in the (mathlib?) documentation somewhere that explains how to work with lean, but we might be less happy about having to maintain it</p>",
        "id": 449611000,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1720332387
    }
]