[
    {
        "content": "<p>A proposal for the style guide. Let's avoid </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">)</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>in favour of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>",
        "id": 502439340,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740695244
    },
    {
        "content": "<p>I would propose that this is \"encouraged\" rather than required for now, but also that we investigate the possibility of a linter for this.</p>",
        "id": 502440965,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740695311
    },
    {
        "content": "<p>I find this style both easier to read, and easier to maintain.</p>",
        "id": 502441396,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740695328
    },
    {
        "content": "<p>(I think anytime you need to change the explicitness for two or more consecutive declarations, there should not be any recommendation between repeated <code>variable ... in</code> and changing twice. This can be left up to individual judgement. It's just switching back and forth for a single declaration which I'd like to discourage.)</p>",
        "id": 502443738,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740695423
    },
    {
        "content": "<p>I assume we are still fine with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"o\">}</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"kn\">section</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">)</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"kn\">end</span>\n\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>for when a whole group of declarations want explicit arguments?</p>",
        "id": 502456203,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740696643
    },
    {
        "content": "<p>Yes, certainly. This proposal is <em>only</em> about switching the explicitness back and forth before and after a single declaration.</p>",
        "id": 502459180,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740698067
    },
    {
        "content": "<p>This isn't something we can lint for because it spans multiple commands, right?</p>",
        "id": 502460955,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1740699057
    },
    {
        "content": "<p>It would require more complicated linting mechanisms, at least. :-)</p>",
        "id": 502461644,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740699451
    },
    {
        "content": "<p>Similar linting mechanisms already exist, though they tend to be brittle to editing code.</p>",
        "id": 502512411,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740728233
    },
    {
        "content": "<p>Would it be possible to have a version of <code>Linter</code> that skips the \"revert the environment\" step?  That would allow <em>much</em> better tooling for things such as this one.</p>",
        "id": 502512586,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740728312
    },
    {
        "content": "<p>Actually, <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.Scope#doc\">docs#Lean.Elab.Command.Scope</a> stores the <code>Syntax</code> of the latest variable.  Hence, if the linters had access to the scope <em>before</em> a binder update (and there is an RFC that even more than that will become accessible to the linters), then linting this would be probably more robust.</p>",
        "id": 502526837,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740733107
    },
    {
        "content": "<p>In case it was too implicit, the <code>Syntax</code> stores position as well, so then you can meaningfully compare the position of the <code>variable</code> commands and the positions of the declarations added in-between them.</p>",
        "id": 502526974,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740733164
    },
    {
        "content": "<p>This can be done in an \"untouched file\" currently.  So, it could be a CI linter, or a local one, in case you want to turn it on, but refresh the file if you modify and want up-to-date information.</p>",
        "id": 502527173,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740733222
    },
    {
        "content": "<p>There is a prototype at <a href=\"https://github.com/leanprover-community/mathlib4/pull/22389\">#22389</a>.</p>",
        "id": 502541258,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740737581
    },
    {
        "content": "<p>The first flagged issue appears to be <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Subgroup.gi#doc\">docs#Subgroup.gi</a>.</p>",
        "id": 502541303,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740737593
    },
    {
        "content": "<p>Next flags are: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=QuotientGroup.leftRel_apply#doc\">docs#QuotientGroup.leftRel_apply</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=QuotientGroup.rightRel_apply#doc\">docs#QuotientGroup.rightRel_apply</a>, that also look like correct suggestions from the linter!</p>",
        "id": 502542532,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740737995
    },
    {
        "content": "<p>The linter flagged 218 exceptions in mathlib.</p>",
        "id": 502567136,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740745822
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22396\">#22396</a> is a first batch of replacements.</p>",
        "id": 502571188,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740747095
    },
    {
        "content": "<p>I did it by hand, to make sure that there were no surprises and I think that I can \"trust\" the linter.</p>",
        "id": 502571232,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740747117
    },
    {
        "content": "<p>So, if these changes look ok, I will automate them and produce a second PR with <em>all</em> the exceptions automatically performed.</p>",
        "id": 502571352,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740747148
    },
    {
        "content": "<p>These all look completely reasonable to me. One slightly odd case is in <a href=\"https://github.com/leanprover-community/mathlib4/pull/22396/files#diff-0300e937246e2c2df8beadd533f7ef501eec68b7ee24aba2d24f7f10883a31ad\">https://github.com/leanprover-community/mathlib4/pull/22396/files#diff-0300e937246e2c2df8beadd533f7ef501eec68b7ee24aba2d24f7f10883a31ad</a>. The previous version was clearly bad, switching back and forth four times, but I wonder if there's a cleaner replacement? I suspect not, but I wanted to mention it anyway in case others have ideas.</p>",
        "id": 502572627,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1740747579
    },
    {
        "content": "<p>Bhavik, thanks!  I have not checked, but maybe I can disentangle the declarations, so that first come all with one setting, then all the others.</p>",
        "id": 502572968,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740747675
    },
    {
        "content": "<p>Curiously, this is also the only place where I added a modification that had not been flagged by the linter, since the final variable update involved more than one variable, but the linter only focuses on single variable updates.</p>",
        "id": 502573278,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740747752
    },
    {
        "content": "<p>Independently of the linter <a href=\"https://github.com/leanprover-community/mathlib4/pull/22396\">#22396</a> is clearly an improvement. I've delegated it. Feel free to merge or wait if you want more time to test the linter.</p>",
        "id": 502574177,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1740748025
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/style.20proposal.3A.20avoid.20.60variable.20.7BX.7D.20.2E.2E.2E.20variable.20.28X.29.60/near/502573278\">said</a>:</p>\n<blockquote>\n<p>Curiously, this is also the only place where I added a modification that had not been flagged by the linter, since the final variable update involved more than one variable, but the linter only focuses on single variable updates.</p>\n</blockquote>\n<p>Just to make sure I'm understanding you correctly, the linter flagged the other two, and this one was added manually?</p>",
        "id": 502574593,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1740748168
    },
    {
        "content": "<p>Bhavik, that is correct.  The linter \"saw\"</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- flag</span>\n<span class=\"n\">decl</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">k</span><span class=\"o\">}</span><span class=\"w\">  </span><span class=\"c1\">-- flag</span>\n<span class=\"n\">decl</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\">  </span><span class=\"c1\">-- no flag</span>\n<span class=\"n\">decl</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"bp\">...</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">...</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>and the comments on the <code>variable</code> lines tell you the flags.</p>",
        "id": 502575070,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740748324
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/channel/287929-mathlib4/topic/style.20proposal.3A.20avoid.20.60variable.20.7BX.7D.20.2E.2E.2E.20variable.20.28X.29.60/near/502574177\">said</a>:</p>\n<blockquote>\n<p>Independently of the linter <a href=\"https://github.com/leanprover-community/mathlib4/pull/22396\">#22396</a> is clearly an improvement. I've delegated it. Feel free to merge or wait if you want more time to test the linter.</p>\n</blockquote>\n<p>Thanks!  I'll merge, since there are several hundred exceptions still to test the linter!</p>",
        "id": 502575211,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740748372
    },
    {
        "content": "<p>Thanks for the clarification Damiano!</p>",
        "id": 502575512,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1740748471
    },
    {
        "content": "<p>Essentially, if there is a pattern</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"o\">)</span>\n<span class=\"n\">declaration</span>\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">X</span><span class=\"o\">}</span>\n</code></pre></div>\n<p>the linter will flag the first <code>variable</code>.  The linter ignores the binder types, just makes sure that there is a single variable in the two <code>variable</code> commands and that this variable is the same.</p>",
        "id": 502575586,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740748502
    },
    {
        "content": "<p>Since it seems that the suggestions of the linter are good, I'll automate the replacement.  If all goes well, this could be a good test for an \"auto-correcting linter\" that runs in CI only, as the implementation is not robust for \"live\" actioning.</p>",
        "id": 502576496,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740748812
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22406\">#22406</a> contains the automatic fixes to the warnings that the linter flagged.</p>",
        "id": 502617405,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740760106
    },
    {
        "content": "<p>These next PRs should contain the bulk of all the replacements:</p>",
        "id": 502670446,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740778398
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22412\">#22412</a></p>",
        "id": 502670452,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740778401
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22413\">#22413</a></p>",
        "id": 502670463,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740778405
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22414\">#22414</a></p>",
        "id": 502670472,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740778407
    },
    {
        "content": "<p>Riccardo, thanks for the quick delegations!  <span aria-label=\"thank you\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"thank you\">:thank_you:</span></p>",
        "id": 502672878,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740779501
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/22423\">#22423</a> with the (hopefully final!) adaptation PR.</p>",
        "id": 502711911,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740805668
    },
    {
        "content": "<p>The next issue is whether the linter should be merged or not.</p>",
        "id": 502711979,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1740805696
    }
]