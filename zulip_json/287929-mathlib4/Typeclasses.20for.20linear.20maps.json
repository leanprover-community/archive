[
    {
        "content": "<p>I have a rather annoying problem with the typeclass system, which I have a hard time finding a solution for: we have a typeclass for special functions (the Fourier transform, directional derivatives) that are linear (on bundled functions). So the current design is to have a basic class just for the notation (for example <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FourierTransform#doc\">docs#FourierTransform</a>), and then one for addition and one for scalar multiplication. In principle that should be enough, but then you end up with the problem that you can't have a general <code>simp</code> lemma for negation or finite sums, because you have to choose a scalar field (and <code>simp</code> doesn't want to do that). The obvious solutions would be to introduce more parameters in the <code>add</code> class to prove all of the additional lemmas in that class, but it involves proving more lemmas that are a bit silly, the other option would be to have a class with addition and <code>smul</code> for a fixed field (probably the reals), but that seems rather clunky. Is there any better solution? I feel like this should have come up somewhere else before.</p>",
        "id": 568717738,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1768796054
    },
    {
        "content": "<p>I don't understand what you say. Linear map is a structure, not a class. Are you suggesting it should be a class?</p>",
        "id": 568758576,
        "sender_full_name": "Martin Dvo≈ô√°k",
        "timestamp": 1768815843
    },
    {
        "content": "<p>No, I am using classes for specific linear maps. The class <code>FourierTransform E F</code> says that there is a map <code>E ‚Üí F</code> called the Fourier transform (whatever that is) and we have notation <code>ùìï f</code> for <code>f : E</code>. Then there are additional type classes that state algebraic properties of <code>ùìï</code>, which amount to it being a continuous linear map. These additional type classes are a bit of a pain.</p>",
        "id": 568762999,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1768817158
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"412682\">Moritz Doll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Typeclasses.20for.20linear.20maps/near/568717738\">said</a>:</p>\n<blockquote>\n<p>you can't have a general <code>simp</code> lemma for negation or finite sums, because you have to choose a scalar field</p>\n</blockquote>\n<p>This doesn't make sense to me. Can you show me the problem?</p>",
        "id": 568902439,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1768859491
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=FourierTransform.fourier_zero#doc\">docs#FourierTransform.fourier_zero</a> shows the problem: the theorem needs a ring, but obviously the ring does not play a role.</p>",
        "id": 568918830,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1768864842
    },
    {
        "content": "<p>Can you make <code>FourierTransform E F</code> an instance of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ZeroHomClass#doc\">docs#ZeroHomClass</a> ?</p>",
        "id": 568919535,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1768865362
    },
    {
        "content": "<p>I don't know how that could work since <code>FourierTransform E F</code> is a class and <code>FourierTransform.fourier</code> is a function, not a type. I guess I would have to wrap it in a set type or something?</p>",
        "id": 568920770,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1768866507
    },
    {
        "content": "<p>Hmm yes it doesn't quite fit does it :-/</p>",
        "id": 568921852,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1768867401
    },
    {
        "content": "<p>i guess this just suggests we need a <code>FourierZero</code> class (and <code>FourierInvZero</code> class)? or is this a silly suggestion?</p>",
        "id": 568922456,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1768867803
    },
    {
        "content": "<p>at the very least this would seem to be the way the current design around <code>FourierTransform</code> suggests to fix this issue...</p>",
        "id": 568922528,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1768867874
    },
    {
        "content": "<p>Yeah, this would be a solution, but it feels like a lot of overhead when in the end you construct the Fourier transform as a (continuous) linear map or linear isometry. Especially, since it would end up declaring a lot of instances in each applications. I would love to have a solution with less boilerplate in each application.</p>",
        "id": 568922908,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1768868264
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"412682\">@Moritz Doll</span> why do you need the <code>Semi</code> veresions of everything in <code>FourierTransform.fourier_zero</code>? Are you ever working in settings where <code>E</code> or <code>F</code> is <em>not</em> and <code>AddGroup</code>? If not, then just switch to that and then:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Analysis</span><span class=\"bp\">.</span><span class=\"n\">Fourier</span><span class=\"bp\">.</span><span class=\"n\">Notation</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FourierTransform</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">FourierAdd</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">]</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"n\">FourierTransform</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">fourier_zero</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùìï</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_left_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ùìï</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">FourierAdd</span><span class=\"bp\">.</span><span class=\"n\">fourier_add</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">fourier_neg</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ùìï</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"o\">(</span><span class=\"n\">ùìï</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_left_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ùìï</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">FourierAdd</span><span class=\"bp\">.</span><span class=\"n\">fourier_add</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 569030519,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1768917042
    },
    {
        "content": "<p>I mean, really this is just saying that an <code>AddHom</code> between additive groups is an <code>AddMonoidHom</code>.</p>",
        "id": 569031575,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1768917303
    },
    {
        "content": "<p>I've been wondering whether we should go back to having an <code>IsAddMonoidHom</code> type class that takes an individual morphism, but that we hardly ever / never instantiate it globally, except for <code>‚àÄ f : F, IsAddMonoidHom f</code>, where <code>AddMonoidHomClass F _ _</code>. But the point would be that we can have local or scoped instances like <code>IsAddMonoidHom ùì£</code>.</p>",
        "id": 569036646,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1768918375
    },
    {
        "content": "<p>Do we have the upgrade from <code>AddHom</code> to <code>AddMonoidHom</code>? That would be enough to have all of the lemmas as term one-liners, which I think is good enough for the moment.</p>",
        "id": 569134682,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1768946030
    },
    {
        "content": "<p>Alternatively, we could add</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Hom</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">variable</span><span class=\"w\">  </span><span class=\"o\">{</span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">FunLike</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddGroup</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddHomClass</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">map_zero'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_left_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">map_add</span><span class=\"o\">]</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">map_neg'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">add_left_cancel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">map_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">map_zero'</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 569135893,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1768946607
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"197836\">@Jireh Loreaux</span> do you have a preference here? (just adding a few lemmas vs a definition for upgrading an <code>AddHom</code> to an <code>AddMonoidHom</code>?)</p>",
        "id": 569396614,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1769049230
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/34283\">#34283</a></p>",
        "id": 569602920,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1769122206
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=AddMonoidHom.mk%27#doc\">docs#AddMonoidHom.mk'</a></p>",
        "id": 569611138,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1769126617
    },
    {
        "content": "<p>Perfect - that makes the PR obsolete <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 569611823,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1769126885
    },
    {
        "content": "<p>Sure, with Lean Together going on I missed this.</p>",
        "id": 569831120,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1769223992
    },
    {
        "content": "<p>No worries. Also thank you (and of course also Patrick, Markus and Remy) so much for organizing the meeting</p>",
        "id": 569907280,
        "sender_full_name": "Moritz Doll",
        "timestamp": 1769293154
    }
]