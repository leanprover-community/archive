[
    {
        "content": "<p>I need results about adeles, and hence infinite adeles, for FLT. These are defined as products of infinite completions of number fields, and <code>Mathlib.NumberTheory.NumberField.Completion</code> uses <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WithAbs#doc\">docs#WithAbs</a>, a type synonym for a field (or semiring) which gives it a canonical normed structure for typeclass inference. </p>\n<p>Sometimes these type synonyms are defined as one-field structures in mathlib (e.g. <code>Opposite</code>, <code>MulOpposite</code> etc) but here this is not the case;  <code>WithAbs (v : AbsoluteValue K ℝ)</code> is just defined to be <code>K</code> and we have the principled <code>WithAbs.equiv v : WithAbs v ≃+* K</code> (which is rfl) to move between the object with the canonical norm and the object without it.</p>\n<p>So now I want to develop theory so for example if L is a K-algebra and I have valuations <code>w</code> and <code>v</code> on them I want <code>WithAbs w</code> to be a <code>WithAbs v</code>-algebra, so it's tempting to write</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsoluteValue</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsoluteValue</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithAbs</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithAbs</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"bp\">‹</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"bp\">›</span>\n</code></pre></div>\n<p>but should I really be writing</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">noncomputable</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsoluteValue</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">w</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AbsoluteValue</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"n\">ℝ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithAbs</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithAbs</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">RingHom</span><span class=\"bp\">.</span><span class=\"n\">toAlgebra</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithAbs</span><span class=\"bp\">.</span><span class=\"n\">equiv</span><span class=\"w\"> </span><span class=\"n\">w</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">symm</span><span class=\"bp\">.</span><span class=\"n\">toRingHom</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">‹</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"n\">L</span><span class=\"bp\">›.</span><span class=\"n\">algebraMap</span><span class=\"bp\">.</span><span class=\"n\">comp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">WithAbs</span><span class=\"bp\">.</span><span class=\"n\">equiv</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toRingHom</span>\n</code></pre></div>\n<p>? The latter seems like such a mess; but I'm just unclear about whether the former will cause me problems later or whether I'm fussing about nothing.</p>",
        "id": 494646476,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1737297139
    },
    {
        "content": "<p>I believe the former would be fine if you add the proper <code>smul_def</code> and <code>algebraMap_eq</code> lemmas.</p>",
        "id": 494647040,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1737297557
    },
    {
        "content": "<p>There is an open PR (<a href=\"https://github.com/leanprover-community/mathlib4/pull/20642\">#20642</a>) that adds <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Module#doc\">docs#Module</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Algebra#doc\">docs#Algebra</a> instances for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=WithAbs#doc\">docs#WithAbs</a> (using essentially the first approach).</p>",
        "id": 494647725,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1737298082
    }
]