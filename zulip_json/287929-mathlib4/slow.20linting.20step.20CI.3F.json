[
    {
        "content": "<p>For my recent PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/32646\">#32646</a>, the bors staging CI run took a really remarkably long time to finish, getting hung up on the \"lint style\" step. Since the PR adds a new linter, I was worried I'd done something wrong, but it looks like the slowness is something else: here's the relevant part of the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20072255577/job/57577335149\">CI log</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Get</span><span class=\"o\">:</span><span class=\"mi\">29</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">azure</span><span class=\"bp\">.</span><span class=\"n\">archive</span><span class=\"bp\">.</span><span class=\"n\">ubuntu</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span><span class=\"w\"> </span><span class=\"n\">noble</span><span class=\"bp\">/</span><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"n\">lmodern</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"mf\">2.005</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">9542</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"o\">]</span>\n<span class=\"n\">Get</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">azure</span><span class=\"bp\">.</span><span class=\"n\">archive</span><span class=\"bp\">.</span><span class=\"n\">ubuntu</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span><span class=\"w\"> </span><span class=\"n\">noble</span><span class=\"bp\">/</span><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"n\">mupdf</span><span class=\"bp\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"mf\">1.23</span><span class=\"bp\">.</span><span class=\"m\">10</span><span class=\"bp\">+</span><span class=\"n\">ds1</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"n\">build3</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">49.3</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"o\">]</span>\n<span class=\"n\">Get</span><span class=\"o\">:</span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">azure</span><span class=\"bp\">.</span><span class=\"n\">archive</span><span class=\"bp\">.</span><span class=\"n\">ubuntu</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span><span class=\"w\"> </span><span class=\"n\">noble</span><span class=\"bp\">/</span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"n\">t1utils</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"mf\">1.41</span><span class=\"bp\">-</span><span class=\"mi\">4</span><span class=\"n\">build3</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">61.3</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"o\">]</span>\n<span class=\"n\">Get</span><span class=\"o\">:</span><span class=\"mi\">32</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">azure</span><span class=\"bp\">.</span><span class=\"n\">archive</span><span class=\"bp\">.</span><span class=\"n\">ubuntu</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span><span class=\"w\"> </span><span class=\"n\">noble</span><span class=\"bp\">/</span><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"n\">texlive</span><span class=\"bp\">-</span><span class=\"n\">binaries</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"mf\">2023.20230311</span><span class=\"bp\">.</span><span class=\"m\">66589</span><span class=\"bp\">-</span><span class=\"mi\">9</span><span class=\"n\">build3</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">8529</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"o\">]</span>\n<span class=\"n\">Get</span><span class=\"o\">:</span><span class=\"mi\">33</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">azure</span><span class=\"bp\">.</span><span class=\"n\">archive</span><span class=\"bp\">.</span><span class=\"n\">ubuntu</span><span class=\"bp\">.</span><span class=\"n\">com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span><span class=\"w\"> </span><span class=\"n\">noble</span><span class=\"bp\">/</span><span class=\"kn\">universe</span><span class=\"w\"> </span><span class=\"n\">amd64</span><span class=\"w\"> </span><span class=\"n\">texlive</span><span class=\"bp\">-</span><span class=\"n\">base</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"mf\">2023.20240207</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">21.7</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"o\">]</span>\n<span class=\"n\">Preconfiguring</span><span class=\"w\"> </span><span class=\"n\">packages</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"n\">Fetched</span><span class=\"w\"> </span><span class=\"mi\">118</span><span class=\"w\"> </span><span class=\"n\">MB</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">46</span><span class=\"n\">min</span><span class=\"w\"> </span><span class=\"mi\">34</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mf\">42.1</span><span class=\"w\"> </span><span class=\"n\">kB</span><span class=\"bp\">/</span><span class=\"n\">s</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This is some Ubuntu auto-update step, downloading new texlive packages, which presumably shouldn't be happening afresh on every CI run! I hope this was just a one-off glitch, but I'm reporting it here in case some action is needed.</p>",
        "id": 562762483,
        "sender_full_name": "David Loeffler",
        "timestamp": 1765304089
    },
    {
        "content": "<p>Very strange. My best guess is some kind of network hiccup. It doesn't look like something we have control over, unfortunately.</p>",
        "id": 562764063,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1765304504
    },
    {
        "content": "<p>Another instance: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20100617503/job/57670221999?pr=32690\">https://github.com/leanprover-community/mathlib4/actions/runs/20100617503/job/57670221999?pr=32690</a></p>",
        "id": 562966589,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1765376457
    },
    {
        "content": "<p>I have one that beats both of these combined:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20384108818/job/58581312606?pr=33111\">https://github.com/leanprover-community/mathlib4/actions/runs/20384108818/job/58581312606?pr=33111</a><br>\n4 hours and counting</p>",
        "id": 564798787,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766200827
    },
    {
        "content": "<p>Now it says \"cancelled after 6h 5m\"</p>",
        "id": 564801821,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766205522
    },
    {
        "content": "<p>Oh there's a time limit<br>\n<a href=\"/user_uploads/3121/dreBpEi7qey5Eq5fDSu8y2AY/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/dreBpEi7qey5Eq5fDSu8y2AY/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"954x90\" src=\"/user_uploads/thumbnail/3121/dreBpEi7qey5Eq5fDSu8y2AY/image.png/840x560.webp\"></a></div>",
        "id": 564801941,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766205668
    },
    {
        "content": "<p>Looks like a similar issue caused <a href=\"https://github.com/leanprover-community/mathlib4/pull/32559\">#32559</a> to fail as well: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20396174623/job/58611998166\">https://github.com/leanprover-community/mathlib4/actions/runs/20396174623/job/58611998166</a></p>",
        "id": 564866682,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766285434
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/33140\">#33140</a> is going through this as well.</p>",
        "id": 564867848,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1766287563
    },
    {
        "content": "<p>Could this be GitHub's <a href=\"https://github.com/actions/runner/issues/3792\">safe sleep</a> debacle?</p>",
        "id": 564868127,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766288061
    },
    {
        "content": "<p>It seems like the issue reported there was fixed recently. Are you suggesting that something is wrong with their fix?</p>\n<p>I just remembered that we have been seeing similar issues with linters never terminating in downstream projects for a while, cf. <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/runLinter.20in.20github.20workflow.20not.20terminating/with/554699497\">#general &gt; runLinter in github workflow not terminating</a> and <a class=\"stream-topic\" data-stream-id=\"113488\" href=\"/#narrow/channel/113488-general/topic/CI.20stuck.20at.20Lint.20project.20step/with/554703717\">#general &gt; CI stuck at Lint project step</a>.</p>",
        "id": 564868272,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766288265
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/564868272\">said</a>:</p>\n<blockquote>\n<p>It seems like the issue reported there was fixed recently. Are you suggesting that something is wrong with their fix?</p>\n</blockquote>\n<p>Are the runners v2.329.0 or newer? (idk if these are Mathlib's runners or if we're using GitHub's own runners which are probably always up to date)</p>\n<p>I don't think the fix for the <code>!=</code> vs <code>&lt;=</code> problem is wrong, but IIUC that script historically caused multiple problems related to sleeping.</p>",
        "id": 564873348,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766296019
    },
    {
        "content": "<p>Mathlib's CI runs on self-hosted runners, but the runners keep themselves automatically up to date (<a href=\"https://docs.github.com/en/actions/reference/runners/self-hosted-runners#communication\">see the docs</a>). You can also see the version of the runner in the \"Set up job\" step, it looks like it's <code>2.330.0</code> for all the recent failures (since Dec. 19).</p>",
        "id": 564875386,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766298695
    },
    {
        "content": "<p>This seems to have caused <a href=\"https://github.com/leanprover-community/mathlib4/pull/32701\">#32701</a> to fail as well <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20407376484/job/58639104912\">https://github.com/leanprover-community/mathlib4/actions/runs/20407376484/job/58639104912</a></p>",
        "id": 564900434,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766331554
    },
    {
        "content": "<p>Several more CI runs seem to have failed overnight with this error, of the linting getting stuck forever and being automatically killed after 6h. Here's an example on <a href=\"https://github.com/leanprover-community/mathlib4/pull/33187\">#33187</a>, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20418281106\">https://github.com/leanprover-community/mathlib4/actions/runs/20418281106</a>, and here on <a href=\"https://github.com/leanprover-community/mathlib4/pull/33155\">#33155</a>, <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20414682705\">https://github.com/leanprover-community/mathlib4/actions/runs/20414682705</a></p>",
        "id": 564945053,
        "sender_full_name": "David Loeffler",
        "timestamp": 1766387584
    },
    {
        "content": "<p>Here also on <a href=\"https://github.com/leanprover-community/mathlib4/pull/30089\">#30089</a> <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20413164116/attempts/1?pr=30089\">https://github.com/leanprover-community/mathlib4/actions/runs/20413164116/attempts/1?pr=30089</a></p>",
        "id": 564945284,
        "sender_full_name": "David Loeffler",
        "timestamp": 1766387681
    },
    {
        "content": "<p>I checked the logs above and it seems like the issue isn't just restricted to one or two of the machines. </p>\n<p>I wonder if we should add more detailed logs to our linters temporarily to try and identify the culprit? Not entirely sure how to do this -- maybe one of our linting experts can weigh in?</p>",
        "id": 565003376,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766410062
    },
    {
        "content": "<p>This is somewhat mysterious: on my computer, the step that times out in CI takes under 3 minutes to complete.</p>",
        "id": 565018658,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766414955
    },
    {
        "content": "<p>It seems to happen randomly with a low probability even in CI -- so far re-running the job has fixed it.</p>",
        "id": 565018871,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766415031
    },
    {
        "content": "<p>Could it be that there is some lock in place and, if there are two <code>push</code>es within a small period of time, then the linting step on the second one gets caught in a lock?</p>",
        "id": 565020814,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766415688
    },
    {
        "content": "<p>In at least two of the time outs above, the push before the one that times out happened less than 10 minutes earlier.</p>",
        "id": 565020990,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766415739
    },
    {
        "content": "<p>Another one <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20450551667/job/58762462708?pr=32870\">https://github.com/leanprover-community/mathlib4/actions/runs/20450551667/job/58762462708?pr=32870</a></p>",
        "id": 565102923,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1766470071
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/565020990\">said</a>:</p>\n<blockquote>\n<p>In at least two of the time outs above, the push before the one that times out happened less than 10 minutes earlier.</p>\n</blockquote>\n<p>This is interesting, but I'm still not sure how this could lead to what we're seeing. Were the CI jobs for the earlier pushes assigned to the same runners as the CI for the later pushes? (I'd be surprised if they were because as far as I know, jobs are assigned fairly randomly to available runners.)</p>",
        "id": 565105375,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766472222
    },
    {
        "content": "<p>Bryan, I do not have any evidence.  In particular, I do not even know how to check which runner was used!</p>",
        "id": 565126610,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766483332
    },
    {
        "content": "<p>Is there a way to list all actions that were re-ran?</p>",
        "id": 565126637,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766483342
    },
    {
        "content": "<p>Under \"set up job\", there's a line like \"Runner name: 'hoskinson6'\"</p>",
        "id": 565129176,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1766484438
    },
    {
        "content": "<p>Ah, thanks!</p>",
        "id": 565130292,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766484958
    },
    {
        "content": "<p>The first example that I looked of consecutive commits, they were both on <code>hoskinson9</code>.  In fact, all 3:</p>\n<ol>\n<li>the first push (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20418257319/job/58665173117\">https://github.com/leanprover-community/mathlib4/actions/runs/20418257319/job/58665173117</a>),</li>\n<li>the one that cancelled the previous one and timed out (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20418281106/attempts/1\">https://github.com/leanprover-community/mathlib4/actions/runs/20418281106/attempts/1</a>), and</li>\n<li>the re-run (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20418281106\">https://github.com/leanprover-community/mathlib4/actions/runs/20418281106</a>).</li>\n</ol>",
        "id": 565130683,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766485115
    },
    {
        "content": "<p>I am also not convinced that this \"lock\" is the reason, but if it were, then it would explain why it is not consistent behaviour: the second run needs to happen on the same runner as the previous one, introducing a possible randomness.</p>",
        "id": 565131061,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1766485259
    },
    {
        "content": "<p>Unfortunately whatever's going on it doesn't seem that this is the only criterion. Looking at the example from <a href=\"https://github.com/leanprover-community/mathlib4/pull/33155\">#33155</a>, it looks like:</p>\n<ol>\n<li>CI was triggered on the previous push at 18:41 UTC and ran on <code>hoskinson2</code>. This failed due to a long line: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20414169316\">https://github.com/leanprover-community/mathlib4/actions/runs/20414169316</a></li>\n<li>CI was triggered on a push at 19:24 UTC and ran on <code>hoskinson5</code>. This ended up timing out in the linting step: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20414169316\">https://github.com/leanprover-community/mathlib4/actions/runs/20414169316</a></li>\n</ol>\n<p>It's a good idea to see if there are some patterns like this though.</p>",
        "id": 565161923,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766498725
    },
    {
        "content": "<p>Another example: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20470049395/job/58823025523\">https://github.com/leanprover-community/mathlib4/actions/runs/20470049395/job/58823025523</a></p>",
        "id": 565230279,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766538448
    },
    {
        "content": "<p>Still happening: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20525480899/job/58967951672?pr=33267\">https://github.com/leanprover-community/mathlib4/actions/runs/20525480899/job/58967951672?pr=33267</a></p>",
        "id": 565474340,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766787010
    },
    {
        "content": "<p>Things that jump out at me (but with no guarantee of relevance!):</p>\n<ul>\n<li>There are a couple spawned tasks in <code>runLinterOnModule</code> to build the necessary targets if they don't exist. I don't think this is where things go awry, but it would be nice to have a <code>--no-build</code> flag to <code>runLinter</code> to throw instead of doing this just in case.</li>\n<li>There are some warnings in the docstrings of <code>enableInitializerExecutions</code> and <code>withImporting</code> about not accessing global references on multiple execution threads and ensuring that everything matches exactly if loaded twice. It makes me wonder if we need to be careful in a way we're not.</li>\n<li>We use <code>BaseIO.asTask</code> to run linters in <code>lintCore</code>, together with a blocking <code>Task.get</code>. This seems suspicious? Note also that the docstring for <code>BaseIO.asTask</code> mentions that it continues to run even if the last reference to it is dropped. Not sure if it's possible for that to be an issue here.</li>\n</ul>\n<p>It would be nice to add tracing to <code>runLinter</code> in choice spots to see how far we get‚Äîwould that come through in the logs, or does the timeout somehow obliterate things? I'd be happy to PR that to batteries if it would help. :)</p>",
        "id": 565497136,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766822759
    },
    {
        "content": "<p>Adding more tracing certainly sounds worth trying! I think chances are good we'll learn something new about what's going on: the runners don't seem to be losing their connection with GitHub during the timeout (otherwise we'd get different error messages), so we should be able to read them in the logs. (Worst case, we can also ssh into the runners and check the logs there.)</p>",
        "id": 565512788,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766844049
    },
    {
        "content": "<p>This seems to be another example:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20542058792/job/59007727248\">https://github.com/leanprover-community/mathlib4/actions/runs/20542058792/job/59007727248</a></p>",
        "id": 565526831,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1766863406
    },
    {
        "content": "<p>It is also happening to bors batches now<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20553310113/job/59033959466\">https://github.com/leanprover-community/mathlib4/actions/runs/20553310113/job/59033959466</a></p>\n<p>Maybe bors batches should have tighter timeout limits?</p>",
        "id": 565580169,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1766941901
    },
    {
        "content": "<p>There is a setting for it: <a href=\"https://github.com/leanprover-community/mathlib4/blob/88c480406bd423b91b691ee43655057aa1f8db63/bors.toml#L3\">https://github.com/leanprover-community/mathlib4/blob/88c480406bd423b91b691ee43655057aa1f8db63/bors.toml#L3</a> </p>\n<p>I think we've always just set it to the max since back in the mathlib3 days our builds really were taking that long. Looking at the first few pages of builds <a href=\"https://github.com/leanprover-community/mathlib4/actions/workflows/bors.yml\">here</a>, the longest build (without the linting issue) took about 1h18m, so 2 hours might be a reasonable limit now (leaving some room for mathlib to grow a bit).</p>",
        "id": 565583147,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1766946182
    },
    {
        "content": "<p>Some basic tracing: <a href=\"https://github.com/leanprover-community/batteries/pull/1583\">batteries#1583</a></p>",
        "id": 565602386,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766967713
    },
    {
        "content": "<p>(This means we should call <code>runLinter --trace</code> in mathlib CI once that lands, and possibly <code>runLinter --no-build --trace</code>!)</p>",
        "id": 565602415,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766967758
    },
    {
        "content": "<p>I also have decl-level tracing in the wings, but figured the PR was already large enough! :) We may get enough information from this very simple tracing alone, after all.</p>",
        "id": 565602434,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1766967796
    },
    {
        "content": "<p>in bors <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20586447955/job/59123654008\">https://github.com/leanprover-community/mathlib4/actions/runs/20586447955/job/59123654008</a></p>",
        "id": 565762621,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1767084988
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/565602386\">said</a>:</p>\n<blockquote>\n<p>Some basic tracing: <a href=\"https://github.com/leanprover-community/batteries/pull/1583\">batteries#1583</a></p>\n</blockquote>\n<p>Looks like this has been merged (thanks!) and will make it into mathlib soon (after <a href=\"https://github.com/leanprover-community/mathlib4/pull/33426\">#33426</a> is merged). Do we just need to add <code>--trace</code> to our <code>lake exe runLinter</code> steps?</p>",
        "id": 565877817,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767172647
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/565583147\">said</a>:</p>\n<blockquote>\n<p>There is a setting for it: <a href=\"https://github.com/leanprover-community/mathlib4/blob/88c480406bd423b91b691ee43655057aa1f8db63/bors.toml#L3\">https://github.com/leanprover-community/mathlib4/blob/88c480406bd423b91b691ee43655057aa1f8db63/bors.toml#L3</a> </p>\n<p>I think we've always just set it to the max since back in the mathlib3 days our builds really were taking that long. Looking at the first few pages of builds <a href=\"https://github.com/leanprover-community/mathlib4/actions/workflows/bors.yml\">here</a>, the longest build (without the linting issue) took about 1h18m, so 2 hours might be a reasonable limit now (leaving some room for mathlib to grow a bit).</p>\n</blockquote>\n<p>I've opened <a href=\"https://github.com/leanprover-community/mathlib4/pull/33427\">#33427</a> for this.</p>",
        "id": 565878013,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767172774
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/33474\">#33474</a> adds tracing to the linting steps and makes an adjustment to the build wrapper script to make output get printed without buffering.</p>",
        "id": 566007578,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767313582
    },
    {
        "content": "<p>I think <code>--trace</code> broke PRs with a cryptic error message (e.g. <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20701110864/job/59423426873\">https://github.com/leanprover-community/mathlib4/actions/runs/20701110864/job/59423426873</a>), which will probably be fixed by them merging master. IIUC the problem is the CI scripts are always fetched from master, which pass <code>--trace</code>, but the PR might not have an updated Batteries so the linter doesn't know what <code>--trace</code> is. Is there a way of synchronizing these? (<code>--trace</code> iff updated Batteries)</p>",
        "id": 566259949,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1767572677
    },
    {
        "content": "<p>Ah, unfortunately not... this would have been another good place to apply the hypothetical <code>please-merge-master</code> label (<a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/CI.20failure/near/539759905\">#mathlib4 &gt; CI failure @ üí¨</a>) to all of our PRs.</p>",
        "id": 566260195,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767572939
    },
    {
        "content": "<p>Here's another one that looks like it is timeing out:</p>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20703941509/job/59430805978?pr=33577\">https://github.com/leanprover-community/mathlib4/actions/runs/20703941509/job/59430805978?pr=33577</a></p>",
        "id": 566289436,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767598642
    },
    {
        "content": "<p>Note that it says <code>-- Linting passed for Mathlib.</code>, but the step doesn't terminate.</p>",
        "id": 566289501,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1767598659
    },
    {
        "content": "<p>cc: <span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> maybe this rings a bell?</p>",
        "id": 566343568,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767616676
    },
    {
        "content": "<p>That is really weird. Is there any way of logging all running <code>Task</code>s? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> I'll think about this...</p>",
        "id": 566412313,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767636424
    },
    {
        "content": "<p>(Aside: I've also made miscellaneous improvements to the tracing at <a href=\"https://github.com/leanprover-community/batteries/pull/1599\">batteries#1599</a>. However, these will not help us diagnose the issue.)</p>",
        "id": 566412578,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767636523
    },
    {
        "content": "<p>Oh, and to clarify: after checking manually, it does indeed look like all listed linters finished via tracing. I was hoping one of them might be a task that hadn't resolved, but...</p>",
        "id": 566414623,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1767637339
    },
    {
        "content": "<p>4 messages were moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/runLinter.20--update/with/566425534\">#mathlib4 &gt; runLinter --update</a> by <span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span>.</p>",
        "id": 566425536,
        "sender_full_name": "Notification Bot",
        "timestamp": 1767641850
    },
    {
        "content": "<p>A message was moved from this topic to <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/runLinter.20--update/with/566425581\">#mathlib4 &gt; runLinter --update</a> by <span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span>.</p>",
        "id": 566425583,
        "sender_full_name": "Notification Bot",
        "timestamp": 1767641867
    },
    {
        "content": "<p>One thing comes to mind is that there could be a strange interaction between <a href=\"https://github.com/leanprover-community/mathlib4/blob/master/scripts/lake-build-wrapper.py\">the python wrapper script that collapses lake output</a> and the linter process somehow. However, there are downstream projects that also ran into this issue (linked at <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/564868272\">#mathlib4 &gt; slow linting step CI? @ üí¨</a>) which don't use this script.</p>\n<p>In any case, we could also try removing the wrapper script from the linting step in CI and see if that helps.</p>",
        "id": 566456174,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767656596
    },
    {
        "content": "<p>I happened to see a few of these in progress and decided to log into the runners to see if anything was going on. </p>\n<p>Here's the first <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20727626887/job/59507072122\">log</a>. I logged into the runner and got the following in the motd (the output of <a href=\"https://manpages.ubuntu.com/manpages/bionic/man1/landscape-sysinfo.1.html\">landscape-sysinfo</a>, apparently):</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code> System information as of Tue Jan  6 01:39:49 UTC 2026\n\n  System load:  0.0                Processes:               309\n  Usage of /:   84.7% of 97.26GB\n  Memory usage: 91%\n  Swap usage:   100%\n</code></pre></div>\n<p>Here's the same for another one stuck in the linting step (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20729851141/job/59514790058\">log at</a>):</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>  System load:  0.07               Processes:               282\n  Usage of /:   79.1% of 97.26GB   Users logged in:         1\n  Memory usage: 89%\n  Swap usage:   100%\n</code></pre></div>\n<p>For comparison, here's what we see on another runner that's currently idle:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code> System information as of Tue Jan  6 01:52:18 UTC 2026\n\n  System load:  2.01               Processes:               272\n  Usage of /:   51.7% of 97.26GB\n  Memory usage: 15%\n  Swap usage:   100%\n</code></pre></div>\n<p>And one which is currently in the middle of the build step (<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20735022538/job/59530569188\">log</a>):</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>  System load:  1.3                Processes:               283\n  Usage of /:   88.2% of 97.87GB\n  Memory usage: 67%\n  Swap usage:   100%\n</code></pre></div>\n<p>The only thing I can see is that the system load is low and the memory usage is around 90% for the ones that are stuck?</p>",
        "id": 566467121,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767665001
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/566456174\">said</a>:</p>\n<blockquote>\n<p>In any case, we could also try removing the wrapper script from the linting step in CI and see if that helps.</p>\n</blockquote>\n<p>This is done in <a href=\"https://github.com/leanprover-community/mathlib4/pull/33646\">#33646</a>. Worth trying IMO!</p>",
        "id": 566468080,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767665868
    },
    {
        "content": "<p>Unfortunately removing the wrapper doesn't seem to have helped: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20749857182/job/59576122164\">https://github.com/leanprover-community/mathlib4/actions/runs/20749857182/job/59576122164</a></p>\n<p>Now the log output seems to stop after the build step.</p>",
        "id": 566555937,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767710163
    },
    {
        "content": "<p>Am I meeting same problem here? <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20742219875/job/59551216119?pr=26212\">https://github.com/leanprover-community/mathlib4/actions/runs/20742219875/job/59551216119?pr=26212</a></p>",
        "id": 566557151,
        "sender_full_name": "Nailin Guan",
        "timestamp": 1767710516
    },
    {
        "content": "<p>Yeah, looks like it. I maybe should have said this earlier, but when you see the linting step run for longer than say 30 minutes, then it's likely you're hitting this and it should be fine to cancel the run and then restart it.</p>",
        "id": 566585628,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767718949
    },
    {
        "content": "<p>Is this a certified GitHub moment, or is it something wrong with the Mathlib tooling?</p>",
        "id": 567048795,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1767914300
    },
    {
        "content": "<p>I think there's something wrong with the linters, but we haven't been able to figure out what yet.</p>",
        "id": 567049377,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767914758
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/566555937\">said</a>:</p>\n<blockquote>\n<p>Unfortunately removing the wrapper doesn't seem to have helped: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20749857182/job/59576122164\">https://github.com/leanprover-community/mathlib4/actions/runs/20749857182/job/59576122164</a></p>\n<p>Now the log output seems to stop after the build step.</p>\n</blockquote>\n<p>Following a suggestion from <span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> in DMs, <a href=\"https://github.com/leanprover-community/mathlib4/pull/33783\">#33783</a> uses <code>stdbuf</code> to change the buffering to line buffering so that we can hopefully see the linting log output in real-time.</p>",
        "id": 567055336,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1767919299
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20885756973/job/60008669811?pr=30658\">https://github.com/leanprover-community/mathlib4/actions/runs/20885756973/job/60008669811?pr=30658</a> seems to be another instance (in <a href=\"https://github.com/leanprover-community/mathlib4/pull/30658\">#30658</a>): the linting itself passed (according to the logs), but the CI step never finished and apparently got cancelled by the time-out.</p>",
        "id": 567376853,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1768121434
    },
    {
        "content": "<p>Basically the same situation: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20895707567/job/60033883160?pr=32027\">https://github.com/leanprover-community/mathlib4/actions/runs/20895707567/job/60033883160?pr=32027</a> It's been 3h 52m and I'm gonna cancel/restart it.</p>",
        "id": 567403970,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1768151866
    },
    {
        "content": "<p>Here's <a href=\"https://gist.github.com/alreadydone/bfb267648a51573d005a4fb690972956\">Copilot's diagnosis</a> just in case it offers some debugging inspirations.</p>",
        "id": 567663968,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1768262826
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/567376853\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20885756973/job/60008669811?pr=30658\">https://github.com/leanprover-community/mathlib4/actions/runs/20885756973/job/60008669811?pr=30658</a> seems to be another instance (in <a href=\"https://github.com/leanprover-community/mathlib4/pull/30658\">#30658</a>): the linting itself passed (according to the logs), but the CI step never finished and apparently got cancelled by the time-out.</p>\n</blockquote>\n<p>This seems to be happening increasingly often for the \"staging\" runs too (that CI hangs indefinitely at the end of the linting stage). I just cancelled two such CI runs (and someone else did the same yesterday).</p>",
        "id": 567808388,
        "sender_full_name": "David Loeffler",
        "timestamp": 1768321540
    },
    {
        "content": "<p>Apologies for the inconvenience, everyone.</p>\n<p><span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> has made some progress diagnosing what's going on but we still haven't pinned it down. I'm working on a workflow to automatically cancel jobs that appear stuck, which should hopefully reduce the runner congestion.</p>",
        "id": 567812188,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768322506
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123965\">Bryan Gin-ge Chen</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/567812188\">said</a>:</p>\n<blockquote>\n<p>I'm working on a workflow to automatically cancel jobs that appear stuck, which should hopefully reduce the runner congestion.</p>\n</blockquote>\n<p>adding a reasonable <code>timeout-minutes</code> to the step should achieve this, no?</p>",
        "id": 567813643,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768322872
    },
    {
        "content": "<p>Oh, good call! Not sure how I missed that.</p>",
        "id": 567814494,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768323129
    },
    {
        "content": "<p>I've created <a href=\"https://github.com/leanprover-community/mathlib4/pull/33922\">#33922</a> for this.</p>",
        "id": 567815666,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768323464
    },
    {
        "content": "<p>Can anyone take a look at <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/20949859110/job/60200416389\">https://github.com/leanprover-community/mathlib4/actions/runs/20949859110/job/60200416389</a> ? The runner reported \"The job has exceeded the maximum execution time of 6h0m0s\" (which is on linting stage), so I suspect it might be relevant to this thread. <br>\nBy the way, is there a way to manually restart CI without pushing another commit? It seems that I can't find the \"retry task\" button now.</p>",
        "id": 567987774,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1768397880
    },
    {
        "content": "<p>I'd be happy to restart CI for you. In general, just making noise on zulip is fine; if you tell us your PR number, it's even faster. That said, in this case it probably makes more sense if you merge master --- recent changes to CI will cancel the job much faster (after 30 minutes for the linting step, instead of 6 hours) next time.</p>",
        "id": 567988683,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1768398140
    },
    {
        "content": "<p>Since the job didn't have the new 30min timeout, surely you have an \"update branch\" button in your PR (at the bottom)</p>",
        "id": 567988707,
        "sender_full_name": "Snir Broshi",
        "timestamp": 1768398149
    },
    {
        "content": "<p>I think even just restarting the job will re-run it with the 30 min timeout (the version of the workflow that runs is the one on <code>master</code>, and from the log link it looks like that job was started before <a href=\"https://github.com/leanprover-community/mathlib4/pull/33922\">#33922</a> was merged).</p>",
        "id": 567989452,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768398358
    },
    {
        "content": "<p>I've gone ahead and restarted the job.</p>",
        "id": 567989568,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768398389
    },
    {
        "content": "<p>Thanks! It's PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/31613\">#31613</a>, and I've merged master now.</p>",
        "id": 567991735,
        "sender_full_name": "Wang Jingting",
        "timestamp": 1768399009
    },
    {
        "content": "<p>Is this thread at all related to what's happening in <a href=\"https://github.com/leanprover-community/mathlib4/pull/33873\">#33873</a>? Linting succeeds but times out: <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/21011593498/job/60407581598\">https://github.com/leanprover-community/mathlib4/actions/runs/21011593498/job/60407581598</a></p>",
        "id": 568140583,
        "sender_full_name": "Ya√´l Dillies",
        "timestamp": 1768463008
    },
    {
        "content": "<p>FYI: behind the scenes <span class=\"user-mention\" data-user-id=\"123965\">@Bryan Gin-ge Chen</span>, <span class=\"user-mention\" data-user-id=\"548935\">@Thomas Murrills</span> and <span class=\"user-mention\" data-user-id=\"439514\">@Marcelo Lynch</span> are working hard to fix this bug. But it's a very elusive one.</p>",
        "id": 568154766,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1768468104
    },
    {
        "content": "<p>The current CI run on <a href=\"https://github.com/leanprover-community/mathlib4/pull/33893\">#33893</a> seems to be stuck in the \"lint Mathlib\" step at</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[Mathlib] - simpComm: (1/2) Getting...\n[Mathlib] - simpComm: (2/2) Passed!\n[Mathlib] - simpNF: (1/2) Getting...\n</code></pre></div>",
        "id": 568263659,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1768495727
    },
    {
        "content": "<p>I'll try to capture a memory dump of this before it times out, please don't cancel the job</p>",
        "id": 568264315,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768495887
    },
    {
        "content": "<p>If it turns out 30 mins is too short of a timeout to catch these ‚Äúlive‚Äù, we can increase the timeout to, say, an hour per <a href=\"https://github.com/leanprover-community/mathlib4/pull/33922\">#33922</a></p>",
        "id": 568267838,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768496772
    },
    {
        "content": "<p>Yeah, I was thinking about that too. Interestingly enough it seems like there was <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/21037992782/job/60491346855?pr=33893\">a bunch of stdout when the timeout hits</a> finishing with \"Linting passed for Mathlib\". It'd be interesting to see if this holds in other instances, it might narrow down where we suspect the hang is ocurring.</p>",
        "id": 568270331,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768496944
    },
    {
        "content": "<p>When I tried to view that PR initially, I got a github webpage error saying the page was taking too long to load. Maybe the hang was our fault, but stdout not coming through immediately was github's fault?</p>",
        "id": 568271013,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768497119
    },
    {
        "content": "<p>Github is having issues today <a href=\"https://www.githubstatus.com/\">https://www.githubstatus.com/</a></p>",
        "id": 568271113,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768497142
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"548935\">Thomas Murrills</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/568271013\">said</a>:</p>\n<blockquote>\n<p>stdout not coming through immediately was github's fault?</p>\n</blockquote>\n<p>maybe... although I would still make the same conclusion if that were the case</p>",
        "id": 568271668,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768497288
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/21046709934/job/60522855501?pr=33893\">This run</a> looks similar (7 minutes into linting right now).</p>",
        "id": 568315306,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1768512820
    },
    {
        "content": "<p>The full text output of the linting step is</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Run cd pr-branch\n+ cd pr-branch\n+ env LEAN_ABORT_ON_PANIC=1 stdbuf -oL lake exe runLinter --trace Mathlib\n+ tee .lake/lint_output.txt\n‚úî [19/22] Built Batteries.Data.Array.Basic:c.o (264ms)\n‚úî [20/22] Built runLinter (1.4s)\n‚úî [21/22] Built runLinter:c.o (686ms)\n‚úî [22/22] Built runLinter:exe (480ms)\nRunning linter on specified module: Mathlib\n[Mathlib] Starting lint...\n[Mathlib] Running linters:\n  checkType\n  checkUnivs\n  defLemma\n  deprecatedNoSince\n  docBlame\n  dupNamespace\n  impossibleInstance\n  nonClassInstance\n  simpComm\n  simpNF\n  simpVarHead\n  structureInType\n  synTaut\n  tacticDocs\n  unusedArguments\n  unusedHavesSuffices\n[Mathlib] - checkType: (0/2) Starting...\n[Mathlib] - checkUnivs: (0/2) Starting...\n[Mathlib] - defLemma: (0/2) Starting...\n[Mathlib] - deprecatedNoSince: (0/2) Starting...\n[Mathlib] - docBlame: (0/2) Starting...\n[Mathlib] - dupNamespace: (0/2) Starting...\n[Mathlib] - impossibleInstance: (0/2) Starting...\n[Mathlib] - nonClassInstance: (0/2) Starting...\n[Mathlib] - simpComm: (0/2) Starting...\n[Mathlib] - simpNF: (0/2) Starting...\n[Mathlib] - simpVarHead: (0/2) Starting...\n[Mathlib] - structureInType: (0/2) Starting...\n[Mathlib] - synTaut: (0/2) Starting...\n[Mathlib] - tacticDocs: (0/2) Starting...\n[Mathlib] - unusedArguments: (0/2) Starting...\n[Mathlib] - unusedHavesSuffices: (0/2) Starting...\n[Mathlib] - checkType: (1/2) Getting...\n[Mathlib] - checkType: (2/2) Passed!\n[Mathlib] - checkUnivs: (1/2) Getting...\n[Mathlib] - checkUnivs: (2/2) Passed!\n[Mathlib] - defLemma: (1/2) Getting...\n[Mathlib] - defLemma: (2/2) Passed!\n[Mathlib] - deprecatedNoSince: (1/2) Getting...\n[Mathlib] - deprecatedNoSince: (2/2) Passed!\n[Mathlib] - docBlame: (1/2) Getting...\n[Mathlib] - docBlame: (2/2) Failed with 256 messages, but these may include declarations in `nolints.json`.\n[Mathlib] - dupNamespace: (1/2) Getting...\n[Mathlib] - dupNamespace: (2/2) Passed!\n[Mathlib] - impossibleInstance: (1/2) Getting...\n[Mathlib] - impossibleInstance: (2/2) Passed!\n[Mathlib] - nonClassInstance: (1/2) Getting...\n[Mathlib] - nonClassInstance: (2/2) Passed!\n[Mathlib] - simpComm: (1/2) Getting...\n[Mathlib] - simpComm: (2/2) Passed!\n[Mathlib] - simpNF: (1/2) Getting...\n</code></pre></div>\n<p>where this was also the output visible after a few minutes.</p>",
        "id": 568318921,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1768514542
    },
    {
        "content": "<p>The next run (after re-starting the workflow) only shows</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Run cd pr-branch\n+ cd pr-branch\n+ env LEAN_ABORT_ON_PANIC=1 stdbuf -oL lake exe runLinter --trace Mathlib\n+ tee .lake/lint_output.txt\n‚úî [19/22] Built Batteries.Data.Array.Basic:c.o (641ms)\n‚úî [20/22] Built runLinter (1.6s)\n‚úî [21/22] Built runLinter:c.o (714ms)\n‚úî [22/22] Built runLinter:exe (1.7s)\nRunning linter on specified module: Mathlib\n[Mathlib] Starting lint...\n[Mathlib] Running linters:\n  checkType\n  checkUnivs\n  defLemma\n  deprecatedNoSince\n  docBlame\n  dupNamespace\n  impossibleInstance\n  nonClassInstance\n  simpComm\n  simpNF\n  simpVarHead\n  structureInType\n  synTaut\n  tacticDocs\n  unusedArguments\n  unusedHavesSuffices\n[Mathlib] - checkType: (0/2) Starting...\n[Mathlib] - checkUnivs: (0/2) Starting...\n[Mathlib] - defLemma: (0/2) Starting...\n[Mathlib] - deprecatedNoSince: (0/2) Starting...\n[Mathlib] - docBlame: (0/2) Starting...\n[Mathlib] - dupNamespace: (0/2) Starting...\n[Mathlib] - impossibleInstance: (0/2) Starting...\n[Mathlib] - nonClassInstance: (0/2) Starting...\n[Mathlib] - simpComm: (0/2) Starting...\n[Mathlib] - simpNF: (0/2) Starting...\n[Mathlib] - simpVarHead: (0/2) Starting...\n[Mathlib] - structureInType: (0/2) Starting...\n</code></pre></div>\n<p>but is successful.</p>",
        "id": 568321102,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1768515522
    },
    {
        "content": "<p>Now they all end with <code>-- Linting passed for Mathlib.</code>, so I suspect this is a github-based delay in forwarding stdout <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 568321554,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768515719
    },
    {
        "content": "<p>...which likely makes it hard to figure out from the output where it hangs.</p>",
        "id": 568322695,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1768516222
    },
    {
        "content": "<p>It's especially mysterious because these tracing steps happen strictly after all of the \"obvious\" top-level <code>runLinter</code> <code>Task.get</code>\"s have been called, meaning that those <code>runLinter</code>-started tasks are actually finished! But we do have a hypothesis, which we're trying to catch...</p>",
        "id": 568322948,
        "sender_full_name": "Thomas Murrills",
        "timestamp": 1768516336
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439514\">Marcelo Lynch</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/568270331\">said</a>:</p>\n<blockquote>\n<p>Yeah, I was thinking about that too. Interestingly enough it seems like there was <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/21037992782/job/60491346855?pr=33893\">a bunch of stdout when the timeout hits</a> finishing with \"Linting passed for Mathlib\". It'd be interesting to see if this holds in other instances, it might narrow down where we suspect the hang is ocurring.</p>\n</blockquote>\n<p>Given this, plus a <a href=\"https://chatgpt.com/share/e/69680995-104c-800c-b4a1-904e7c96ee96\">backtrace that Thomas shared</a> showing that a worker was stuck in lean_finalize_task_manager, maybe a quick workaround to this could be to force an exit in runLinter? I wonder if just sticking <code>IO.Process.exit 0</code> at the end of main would avoid this teardown or not...  </p>\n<p>Not sure if this is the best idea as these hacks tends to stick and the concurrency bug would still be lurking :)  But it would narrow it down</p>",
        "id": 568477638,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768581806
    },
    {
        "content": "<p>I haven‚Äôt contributed to that part of batteries before but at this point it‚Äôs worth a shot I think!</p>",
        "id": 568480694,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768582723
    },
    {
        "content": "<blockquote>\n<p><a href=\"https://chatgpt.com/share/e/69680995-104c-800c-b4a1-904e7c96ee96\">backtrace that Thomas shared</a></p>\n</blockquote>\n<p>can't access this ChatGPT link ...</p>\n<p>I was just impacted by a <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/21091148043/job/60662480378\">bors run</a> with additional outputs after <code>-- Linting passed for Mathlib.</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"bp\">=</span><span class=\"mi\">124</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">grep</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"n\">arguments'</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">lint_output_attempt_2</span><span class=\"bp\">.</span><span class=\"n\">txt</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"mi\">124</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"mi\">124</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">]</span><span class=\"bp\">'</span>\n<span class=\"n\">runLinter</span><span class=\"w\"> </span><span class=\"n\">timed</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attempt</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">.</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">runLinter</span><span class=\"w\"> </span><span class=\"n\">timed</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">attempt</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"bp\">.'</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">[</span><span class=\"bp\">'</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">lt</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"o\">]</span><span class=\"bp\">'</span>\n<span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"mi\">124</span>\n<span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Process</span><span class=\"w\"> </span><span class=\"n\">completed</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mf\">124.</span>\n</code></pre></div>",
        "id": 568575185,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1768643616
    },
    {
        "content": "<p>That output is expected after <span class=\"user-mention\" data-user-id=\"439514\">@Marcelo Lynch</span>'s <a href=\"https://github.com/leanprover-community/mathlib4/pull/34059\">#34059</a> which retries the linting step twice now. Unfortunately it seems that some builds are still getting stuck twice...</p>",
        "id": 568585832,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1768655182
    },
    {
        "content": "<p>I queried the CI runs from the last couple of days, and it looks like 80% of the instances of the timeout (48 out of 60 (!))  have benefited from the retry, but the other 20% hit a new timeout even upon retry (like Junyan's example above). It's good news, even though we're still not quite healthy.</p>",
        "id": 568830914,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768837343
    },
    {
        "content": "<p>I have opened this PR in batteries which will presumably bypass the deadlock if I understood Sebastian correctly - as in IO.Process.exit will just exit(0) without any cleanup<br>\n<a href=\"https://github.com/leanprover-community/batteries/pull/1621\">https://github.com/leanprover-community/batteries/pull/1621</a></p>",
        "id": 569074545,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768926557
    },
    {
        "content": "<p>The PR went in, though I believe people need to rebase mathlib to get the latest batteries in the CI.</p>\n<p>In any case, data from the last couple of days show that retries have been mostly helpful except for some unlucky runs. <br>\n<a href=\"/user_uploads/3121/6EkmbVCAY-viEPmbNuBKmVGY/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/6EkmbVCAY-viEPmbNuBKmVGY/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1500x750\" src=\"/user_uploads/thumbnail/3121/6EkmbVCAY-viEPmbNuBKmVGY/image.png/840x560.webp\"></a></div>",
        "id": 569143763,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1768950604
    },
    {
        "content": "<p>It seems that there are only a few different times for a successful linting step. Is there an obvious explanation for this?</p>",
        "id": 569302729,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1769013763
    },
    {
        "content": "<p>Some updates on this issue:</p>\n<ul>\n<li>looking at the bors CIs, which should be using the latest version of mathlib/master (hence the updated batteries), there have been no timeouts since the change went in. If this holds for the next couple of days I would say we're good in that respect, and as forks start getting this we should be in a good state</li>\n<li>I was able to reproduce the concurrency issue that <a href=\"https://github.com/leanprover/lean4/pull/12052\">lean4#12052</a> is trying to fix by running <code>runLinter</code> in a loop. It took quite a number of iterations (the issue seems a lot more likely in our CIs for whatever reason), but still I think it's a good explanation for the backtraces we were seeing in <code>gdb</code>, so it might just be it</li>\n</ul>",
        "id": 569303023,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1769013849
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20linting.20step.20CI.3F/near/569302729\">said</a>:</p>\n<blockquote>\n<p>It seems that there are only a few different times for a successful linting step. Is there an obvious explanation for this?</p>\n</blockquote>\n<p>I wonder what makes it \"fast\" (namely the ones at the bottom). The ~5min runtime is the same as  the ~20min one because 20 = 15 (timeout of the first attempt) + 5</p>",
        "id": 569303398,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1769013952
    },
    {
        "content": "<p>The fast ones might be where the mathlib4 build already failed, so the linting step just prints those build errors and exits.</p>",
        "id": 569303633,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1769014014
    },
    {
        "content": "<p>Ah, yes, that makes total sense</p>",
        "id": 569304086,
        "sender_full_name": "Marcelo Lynch",
        "timestamp": 1769014092
    }
]