[
    {
        "content": "<p>Is there a way to obtain a heartbeats count for every declaration in a file without having to add <code>count_heartbeats in</code> before every single one?<br>\nA bare <code>count_heartbeats</code> at the beginning of the file gives an error \"unexpected end of input; expected 'in'\". It would be nice if that could be made to work.</p>",
        "id": 491506081,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1735743602
    },
    {
        "content": "<p>I also wanted this for some time: <a href=\"https://github.com/leanprover-community/mathlib4/pull/20421\">#20421</a>.</p>",
        "id": 491730021,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1735896840
    },
    {
        "content": "<p>Jon reviewed the PR (thank you very much!) and raised a question of naming: should the \"persistent\" form of <code>count_heartbeats in</code> be called <code>count_heartbeats</code> or <code>set_option linter.countHeartbeats true</code>?</p>\n<p>If the command had started as a linter in the first place, I would have definitely not introduced the shorter spelling.  However, for discoverability and \"historical reasons\", I am slightly more in favor of having the <code>count_heartbeats</code> abbreviation.</p>\n<p>I'll set up a poll!</p>",
        "id": 492959172,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736518467
    },
    {
        "content": "<p>/poll What should the persistent form of <code>count_heartbeats in</code> be called?<br>\ncount_heartbeats<br>\nset_option linter.countHeartbeats</p>",
        "id": 492959598,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736518600
    },
    {
        "content": "<p>Once the poll results are in, I will in any case add pointers to all names in all relevant doc-strings.</p>",
        "id": 492959708,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736518644
    },
    {
        "content": "<p>(Notice that I missed a <code>true</code> in the poll alternative <code>set_option linter.countHeartbeats *true*</code>!)</p>",
        "id": 492960027,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736518740
    },
    {
        "content": "<p>It should be <code>#count_heartbeats</code>, shouldn't it?</p>",
        "id": 493133994,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736636171
    },
    {
        "content": "<p>An initial version of the PR had the <code>#</code>, but then it was pointed out that <code>count_heartbeats in</code> does not have the <code>#</code>, so I removed it.</p>",
        "id": 493165657,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736667600
    },
    {
        "content": "<p>Maybe I should add the hash to both commands...</p>",
        "id": 493165714,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736667618
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/493165714\">said</a>:</p>\n<blockquote>\n<p>Maybe I should add the hash to both commands...</p>\n</blockquote>\n<p>Yes please.</p>",
        "id": 493169284,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1736670724
    },
    {
        "content": "<p>Ok, I aligned the two commands: they now all use <code>#count_heartbeats ...</code>.</p>",
        "id": 493187364,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736686323
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20421\">#20421</a> has been merged.  If you write <code>#count_heartbeats</code> in most Mathlib files, each following declaration will emit a count of the heartbeats that Lean takes to process it.  This should help with figuring out speed ups/downs over whole files.</p>",
        "id": 493333666,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1736769934
    },
    {
        "content": "<p>I have the following use case: I'd like to get some kind of a measure for how much it costs to compile a file, without bothering the speedcenter and without using a command line <code>time</code>. Is this possible?</p>\n<p>I tried to count the total number of heartbeats used in everyone's favourite file RingTheory/Kaehler/JacobiZariski.lean, so I stuck <code>#countheartbeats</code> at the top expecting to get a number, but in practice I get 31 messages, most of which are claims that something either took exactly 344 heartbeats, exactly 347 heartbeats or exactly 560 heartbeats. Is this tool working correctly? This is the slowest file in mathlib, I would have expected some of these numbers to be much bigger especially given that some declarations take many seconds to compile. For example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">'</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">compEquiv'</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"mi\">347</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n</code></pre></div>\n<p>but the profiler says that this declaration takes 2.8 seconds.</p>",
        "id": 496303652,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738060562
    },
    {
        "content": "<p>that clearly does not look right. I think <a href=\"https://github.com/leanprover-community/mathlib4/blob/3228d1d68564e0aa9de5a446cf85d9b6bf51eb1e/Mathlib/Util/CountHeartbeats.lean#L225\">this line</a> picks out the wrong message</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"n\">count_heartbeats</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"n\">stx</span><span class=\"bp\">⟩</span><span class=\"o\">)))</span>\n<span class=\"n\">msgs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">messages</span><span class=\"bp\">.</span><span class=\"n\">unreported</span><span class=\"bp\">.</span><span class=\"n\">toArray</span><span class=\"bp\">.</span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">severity</span><span class=\"w\"> </span><span class=\"bp\">!=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>but I don't understand yet what's happening. I believe it's displaying the number from the first declaration of a given section/namespace over and over again.</p>",
        "id": 496338002,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738071842
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/496303652\">said</a>:</p>\n<blockquote>\n<p>I have the following use case: I'd like to get some kind of a measure for how much it costs to compile a file, without bothering the speedcenter and without using a command line <code>time</code>. Is this possible?</p>\n<p>I tried to count the total number of heartbeats used in everyone's favourite file RingTheory/Kaehler/JacobiZariski.lean, so I stuck <code>#countheartbeats</code> at the top expecting to get a number, but in practice I get 31 messages, most of which are claims that something either took exactly 344 heartbeats, exactly 347 heartbeats or exactly 560 heartbeats. Is this tool working correctly? This is the slowest file in mathlib, I would have expected some of these numbers to be much bigger especially given that some declarations take many seconds to compile. For example</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">'</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">compEquiv'</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"mi\">347</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n</code></pre></div>\n<p>but the profiler says that this declaration takes 2.8 seconds.</p>\n</blockquote>\n<p>Does Sebastian's suggestion, i.e.<code>lake env perf stat lean Mathlib/RingTheory/Kaehler/JacobiZariski.lean</code> not work for you? That gives you numbers of instructions.</p>",
        "id": 496340904,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738072694
    },
    {
        "content": "<p>(a) no not out of the box: after struggling to install <code>perf</code> I got</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Error:\nAccess to performance monitoring and observability operations is limited.\nConsider adjusting /proc/sys/kernel/perf_event_paranoid setting to open\naccess to performance monitoring and observability operations for processes\nwithout CAP_PERFMON, CAP_SYS_PTRACE or CAP_SYS_ADMIN Linux capability.\nMore information can be found at 'Perf events and tool security' document:\nhttps://www.kernel.org/doc/html/latest/admin-guide/perf-security.html\nperf_event_paranoid setting is 4:\n  -1: Allow use of (almost) all events by all users\n      Ignore mlock limit after perf_event_mlock_kb without CAP_IPC_LOCK\n&gt;= 0: Disallow raw and ftrace function tracepoint access\n&gt;= 1: Disallow CPU event access\n&gt;= 2: Disallow kernel profiling\nTo make the adjusted perf_event_paranoid setting permanent preserve it\nin /etc/sysctl.conf (e.g. kernel.perf_event_paranoid = &lt;setting&gt;)\n</code></pre></div>\n<p>(which is unfortunately too intimidating for me) and (b) in this particular case, Sebastian's suggestion was made after I'd opened the PR to mathlib to run the benchmark bot anyway :-)</p>",
        "id": 496342876,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738073174
    },
    {
        "content": "<p>More importantly, after Jon's observation I can confirm that <code>#count_heartbeats</code> at the top of the file gives me (amongst other things) </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">'</span><span class=\"n\">CotangentSpace</span><span class=\"bp\">.</span><span class=\"n\">compEquiv'</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"mi\">347</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n</code></pre></div>\n<p>but <code>#count_heartbeats in</code> directly before the <code>CotangentSpace.compEquiv</code> declaration gives</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Used</span><span class=\"w\"> </span><span class=\"mi\">58933</span><span class=\"w\"> </span><span class=\"n\">heartbeats</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">less</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">current</span><span class=\"w\"> </span><span class=\"n\">maximum</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"mf\">200000.</span>\n</code></pre></div>\n<p>so there's definitely something up with the global option.</p>",
        "id": 496343544,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738073356
    },
    {
        "content": "<p>Ah I think it is trying to re-elaborate an existing theorem and the <code>343</code> heartbeats are how long it takes lean to conclude</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"n\">kerCompPreimage'</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">declared</span>\n</code></pre></div>",
        "id": 496346143,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738074026
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"385895\">Jon Eugster</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/496346143\">said</a>:</p>\n<blockquote>\n<p>Ah I think it is trying to re-elaborate an existing theorem and the <code>343</code> heartbeats are how long it takes lean to conclude</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Generators</span><span class=\"bp\">.</span><span class=\"n\">kerCompPreimage'</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">been</span><span class=\"w\"> </span><span class=\"n\">declared</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I thought that I had taken care of this, since I distinctly remember seeing that it still elaborated the declaration and only when it was adding it to the environment it checked that it was already present.</p>",
        "id": 496347885,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738074458
    },
    {
        "content": "<p>I may have picked the wrong heartbeat count, though.</p>",
        "id": 496347960,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738074476
    },
    {
        "content": "<p>(And it might also be that this is another situation where <code>Elab.async</code> is giving me a headache!)</p>",
        "id": 496348091,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738074499
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/496347885\">said</a>:</p>\n<blockquote>\n<p>distinctly remember seeing that it still elaborated the declaration and only when it was adding it to the environment it checked that it was already present.</p>\n</blockquote>\n<p>That's interesting, did that maybe change recently? I also don't see any interactive goal states in the infoview, suggesting that the proof is not elaborated:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">  </span><span class=\"n\">done</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"c1\">-- error: 'A' has already been declared</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span><span class=\"w\">     </span><span class=\"c1\">-- no goal state here</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"bp\">.</span><span class=\"n\">intro</span>\n<span class=\"w\">  </span><span class=\"n\">done</span>\n</code></pre></div>\n<p>I've created <a href=\"https://github.com/leanprover-community/mathlib4/pull/21182\">#21182</a> which just puts the declaration inside a namespace before re-elaboration, which seems to work. I'll test it on Kevin's favourite file once CI is done.</p>",
        "id": 496358173,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738076958
    },
    {
        "content": "<p>I have used the namespace trick, it works most of the times, but interacts weirdly with autonamespacing, self-referentiality and a couple of other edge cases.</p>\n<p>Anyway, better than failing always!</p>",
        "id": 496369673,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738080073
    },
    {
        "content": "<p>You're right, maybe that's not good enough. Do you have a better approach usually?</p>\n<p>Also, i noticed that the linter does not go into <code>open ... in</code> or <code>variable ... in</code> either yet.</p>",
        "id": 496389263,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738085801
    },
    {
        "content": "<p>I do not have a better approach, though I have a combination of approaches that covers most(?) cases!  Anyway, I also stopped worrying about such issues since there should be at some point there is the hope that <a href=\"https://github.com/leanprover/lean4/pull/6076\">lean4#6076</a> will magically give access to quite a bit more of information, and possibly the ability to elaborate its code <em>before</em> the command being elaborated is actually elaborated.</p>",
        "id": 496399454,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738088990
    },
    {
        "content": "<p>Should that happen, you would simply elab the heartbeats inside a <code>withoutModifyingEnvironment</code> and then continue with the rest.</p>",
        "id": 496399597,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738089033
    },
    {
        "content": "<p>The conclusion is that all the workarounds that I know fail in some way or another, so I would not worry too much about making this perfect.</p>",
        "id": 496399685,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738089069
    },
    {
        "content": "<p>If it warns about the cases where there was an error, it is still better to add manually a <code>#count_heartbeats in</code> before the offending declarations anyway.</p>",
        "id": 496399771,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738089103
    },
    {
        "content": "<p>(In case you are curious, in some branch, I also have a <code>Syntax --&gt; Syntax</code> transformation that converts declarations to <code>example</code>s, to avoid messing with the environment... needless to say, that is also fallible!)</p>",
        "id": 496400077,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738089204
    },
    {
        "content": "<p>However, recursive calls, dot-notation, previously opened namespaces and the declaration that was just added to the environment all conspire against any of these solutions really working robustly.</p>",
        "id": 496400423,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738089321
    },
    {
        "content": "<p>If the goal is to find slow definitions, have you considered using the trace profiler? No need to reelaborate anything, or to think in heartbeats</p>",
        "id": 496406537,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1738091457
    },
    {
        "content": "<p>(to be explicit, that's <code>set_option trace.profiler true</code> at the top of the file which gives you time in seconds for individual declarations)</p>",
        "id": 496421621,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738097353
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/496340904\">said</a>:</p>\n<blockquote>\n<p>Does Sebastian's suggestion, i.e.<code>lake env perf stat lean Mathlib/RingTheory/Kaehler/JacobiZariski.lean</code> not work for you? That gives you numbers of instructions.</p>\n</blockquote>\n<p>I bravely opened a file as root and changed a number to a random smaller number and now it seems to be working...</p>",
        "id": 496427704,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738099868
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/496427704\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"648495\">Christian Merten</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/496340904\">said</a>:</p>\n<blockquote>\n<p>Does Sebastian's suggestion, i.e.<code>lake env perf stat lean Mathlib/RingTheory/Kaehler/JacobiZariski.lean</code> not work for you? That gives you numbers of instructions.</p>\n</blockquote>\n<p>I bravely opened a file as root and changed a number to a random smaller number and now it seems to be working...</p>\n</blockquote>\n<p>I have this line</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">kernel</span><span class=\"bp\">.</span><span class=\"n\">perf_event_paranoid</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>in my <code>/etc/sysctl.conf</code> which enables <code>perf</code> for non-root users. I don't know the security implications of this though. After that you need to do <code>sysctl --system</code> to reload the <code>sysctl</code> variables.</p>",
        "id": 496428124,
        "sender_full_name": "Christian Merten",
        "timestamp": 1738100057
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/23905\">#23905</a> tracks the broken <code>linter.countHeartbeats</code> issue.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/496406537\">said</a>:</p>\n<blockquote>\n<p>If the goal is to find slow definitions, have you considered using the trace profiler? No need to reelaborate anything, or to think in heartbeats</p>\n</blockquote>\n<p>The trace profiler is not a good solution to the problem I'm currently trying to analyse. The question is: did a certain commit make a file quite a bit faster because the speedcenter is reporting this and it's unexpected; if it's true I'd like to understand more. Manually checking heartbeats on many declarations it seems that most of them are unchanged, but a few did get 10% quicker. The profiler will however report different timings for every declaration due to noise. </p>\n<p>A precise question: did <code>Mathlib.Algebra.Order.Field.Basic</code> actually just get 9.7% faster (see <a href=\"https://github.com/leanprover-community/mathlib4/pull/23892#issuecomment-2791371352\">here</a>) and if so, why?</p>\n<p><code>lake env perf stat lean Mathlib/Algebra/Order/Field/Basic.lean</code> only gives me per-file stats, getting a per-declaration heartbeat count really seems like the way to analyse such questions, especially because most declarations did not change (and because of course I don't have any understanding of the output of <code>lake env perf stat</code>, I am looking for changes in typeclass inference behaviour and not something low-level)</p>",
        "id": 511346746,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744274099
    },
    {
        "content": "<p>If by \"actually ... faster\" you mean wall-clock time (i.e. the only time metric we're interested in the end as humans), I'm not sure heartbeats will be helpful either. You might want to start by measuring the time <code>lake lean</code> takes on the file in both commits, repeatedly, e.g. using <code>hyperfine</code></p>",
        "id": 511350000,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744275012
    },
    {
        "content": "<p>Do note that the trace profiler can measure heartbeats as well if wall time is too noisy. Measuring instructions would be an interesting extension that should be feasible at least on Linux.</p>",
        "id": 511350606,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744275157
    },
    {
        "content": "<p>I want to measure an approximation of how long Lean takes on each declaration so I can see precisely which declarations got quicker. The profiler is too noisy. Most of the time the heartbeats won't change, or will change by a very small percentage, but occasionally there will be a big jump. I suspect that what I want is a resolution of <a href=\"https://github.com/leanprover-community/mathlib4/pull/23905\">#23905</a> .</p>",
        "id": 511357828,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744277086
    },
    {
        "content": "<p>And that's not covered by trace.profiler.useHeartbeats?</p>",
        "id": 511377137,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744283376
    },
    {
        "content": "<p>There is one papercut here: You'll likely want to adjust trace.profiler.threshold as well when enabling that option as otherwise the profiling overhead might be too large. \"10\" is a reasonable threshold in ms but not in heartbeats!</p>",
        "id": 511377371,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744283449
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/count_heartbeats.20for.20all.20declarations.20in.20a.20file.3F/near/511377137\">said</a>:</p>\n<blockquote>\n<p>And that's not covered by trace.profiler.useHeartbeats?</p>\n</blockquote>\n<p>Good to see Lean reporting integers to 6 decimal places here!</p>",
        "id": 511377899,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744283620
    },
    {
        "content": "<p>Can never rule out heart palpitations</p>",
        "id": 511378315,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744283755
    },
    {
        "content": "<p>Right now putting</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">useHeartbeats</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p><code>at the top of Mathlib/Algebra/Order/Field/Basic.lean</code> gives squiggly blue line output for the first 300 or so lines of this 900 line file, and then it stops</p>",
        "id": 511378388,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1744283767
    },
    {
        "content": "<p>It's just the squigglies that give up, the trace is still there for me <br>\n<a href=\"/user_uploads/3121/_9CkGv9gm2xR3qj2qHwN-jG0/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/_9CkGv9gm2xR3qj2qHwN-jG0/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2772x143\" src=\"/user_uploads/thumbnail/3121/_9CkGv9gm2xR3qj2qHwN-jG0/image.png/840x560.webp\"></a></div>",
        "id": 511380092,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1744284295
    },
    {
        "content": "<p>Maybe you reached the squiggle limit for that file</p>",
        "id": 511380390,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744284394
    },
    {
        "content": "<p>It looks like the limit is 500 squiggles / file</p>",
        "id": 511381013,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1744284509
    }
]