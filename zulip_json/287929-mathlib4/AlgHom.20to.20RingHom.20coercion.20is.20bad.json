[
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Üí‚Çê</span><span class=\"o\">[</span><span class=\"n\">‚Ñ§</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+*</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+*</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>\n<p>(<del>I think I can potentially minimise the <code>import Mathlib</code> away</del> edit: i tried and failed)<br>\nso basically I think this fails because Lean doesn't know which base ring for the algebra to try?</p>",
        "id": 522829512,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749234864
    },
    {
        "content": "<p>Then the problem this creates is that I would manually type in <code>foo.toRingHom</code> and then the simp linter and co. wouldn't like this</p>",
        "id": 522830454,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749235270
    },
    {
        "content": "<p>looking at the trace, for whatever reason typeclass instance synthesis complains it can't find <code>FunLike (‚Ñù ‚Üí‚Çê[‚Ñ§] ‚Ñö) ?_ ?_</code> (even though <code>#synth</code> succeeds for this?)</p>",
        "id": 522833738,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749236832
    },
    {
        "content": "<p>Actually it has nothing to do with the extra variable, even RingEquiv to RingHom is bad:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ+*</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+*</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+*</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- works</span>\n</code></pre></div>",
        "id": 522833844,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749236886
    },
    {
        "content": "<p>the entire chain of coercion in this tree is basically unusable</p>",
        "id": 522833869,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749236897
    },
    {
        "content": "<p>if you use <code>set_option trace.Meta.synthInstance true</code>, you'll see that indeed it finds the coersion induced by the <code>RingHomClass</code> instance for <code>AlgHom</code> and <code>RingEquiv</code> respectively, but fails to apply the appropriate <code>FunLike</code> or <code>EquivLike</code> instance</p>",
        "id": 522834170,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237058
    },
    {
        "content": "<p>i.e. we get trace like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"n\">tryResolve</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">üí•Ô∏è</span><span class=\"w\"> </span><span class=\"n\">EquivLike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ+*</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">50</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">51</span><span class=\"w\"> </span><span class=\"bp\">‚âü</span><span class=\"w\"> </span><span class=\"n\">EquivLike</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1154</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ+*</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1155</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1154</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">m</span><span class=\"bp\">.</span><span class=\"m\">1155</span>\n</code></pre></div>",
        "id": 522834385,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237181
    },
    {
        "content": "<p>which seems like it should unify</p>",
        "id": 522834422,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237201
    },
    {
        "content": "<p>looking at the universes of these, maybe there's some issue there? the lhs <code>Equivlike</code> lives in the simple <code>Type (max ?u.49 ?u.48)</code>, while the rhs lives in the more complicated <code>Type (max (max (max 0 ?u.1153 ?u.1152) ?u.1152) ?u.1153)</code> for whatever reason</p>",
        "id": 522834907,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237442
    },
    {
        "content": "<p>maybe the issue is that lean can't figure out what values the universe levels should have, and so just shuts down completely?</p>",
        "id": 522835138,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237555
    },
    {
        "content": "<p>(i'm not at all familiar with the precise specs of unification, i'm just pointing at things which look weird)</p>",
        "id": 522835305,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237613
    },
    {
        "content": "<p>hmm, do you know anyone who might know about this?</p>",
        "id": 522835651,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749237738
    },
    {
        "content": "<p>i have the suspicion that <span class=\"user-mention silent\" data-user-id=\"238446\">Anne Baanen</span>  knows a lot about these design decisions and instance inference subtleties, but they might be very busy with other things... i think if we wait someone else might provide insight</p>",
        "id": 522836080,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237916
    },
    {
        "content": "<p>(and from the top of my head i don't know who else i would ask)</p>",
        "id": 522836215,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749237980
    },
    {
        "content": "<p>Here is an excerpt of a more detailed trace:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>        [isDefEq] [0.000447] üí•Ô∏è EquivLike (‚Ñù ‚âÉ+* ‚Ñö) ?m.50 ?m.51 =?= EquivLike (?m.536 ‚âÉ+* ?m.537) ?m.536 ?m.537 ‚ñº\n          [] [0.000357] ‚úÖÔ∏è ‚Ñù ‚âÉ+* ‚Ñö =?= ?m.536 ‚âÉ+* ?m.537 ‚ñº\n            [] [0.000026] ‚úÖÔ∏è ‚Ñù =?= ?m.536 ‚ñ∂\n            [] [0.000017] ‚úÖÔ∏è ‚Ñö =?= ?m.537 ‚ñ∂\n            [] [0.000055] ‚úÖÔ∏è Real.instMul =?= ?m.538 ‚ñ∂\n            [] [0.000041] ‚úÖÔ∏è Rat.instMul =?= ?m.539 ‚ñ∂\n            [] [0.000053] ‚úÖÔ∏è Real.instAdd =?= ?m.540 ‚ñ∂\n            [] [0.000067] ‚úÖÔ∏è Rat.instAdd =?= ?m.541 ‚ñ∂\n          [] [0.000006] üí•Ô∏è ?m.50 =?= ‚Ñù ‚ñº\n            [] ?m.50 [nonassignable] =?= ‚Ñù [nonassignable]\n</code></pre></div>\n<p>The problem seems to be that the metavariable here is \"nonassignable\", causing the unification to fail. I'm not sure where this comes from, but it may have some relation to <a href=\"https://github.com/leanprover/lean4/pull/8364\">lean4#8364</a> (where something similar happens with an explicit coercion arrow).</p>",
        "id": 522836448,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749238089
    },
    {
        "content": "<p>how did you get that detailed trace? is there some option?</p>",
        "id": 522836965,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1749238342
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">synthInstance</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">trace</span><span class=\"bp\">.</span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñù</span><span class=\"w\"> </span><span class=\"bp\">‚âÉ+*</span><span class=\"w\"> </span><span class=\"n\">‚Ñö</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">‚Üí+*</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"c1\">-- fails</span>\n</code></pre></div>",
        "id": 522839383,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1749239630
    },
    {
        "content": "<p>push... do other people dealing with ring homs and ring equivs have the same issue?</p>",
        "id": 523167482,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749503114
    },
    {
        "content": "<p>yeah, I just put <code>.toRingHom</code></p>",
        "id": 523170987,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1749505009
    },
    {
        "content": "<p>yes, and then the simp linter complains that you haven't put it in simp normal form</p>",
        "id": 523172177,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749505227
    },
    {
        "content": "<p>Oh well then just add the source and target types?</p>",
        "id": 523172984,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1749505394
    },
    {
        "content": "<p>then the statement becomes bigger</p>",
        "id": 523173128,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749505422
    },
    {
        "content": "<p>is the logic one of these silly \"yes I know you want to coerce <code>‚Ñù ‚âÉ+* ‚Ñö</code> to <code>X ‚Üí+* Y</code> but my typeclass inference system is so flexible that as far as I know <code>X</code> and <code>Y</code> can be anything so I'll just give up now\"?</p>",
        "id": 523174470,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1749505770
    },
    {
        "content": "<p>well Michael Stoll tried to read the trace and reached a \"nonassignable\" metavariable but i have no idea what any of those mean</p>",
        "id": 523175188,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749506247
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/287929-mathlib4/topic/AlgHom.20to.20RingHom.20coercion.20is.20bad/near/523172177\">said</a>:</p>\n<blockquote>\n<p>yes, and then the simp linter complains that you haven't put it in simp normal form</p>\n</blockquote>\n<p>You use <code>RingHomClass.toRingHom</code> instead. But people seem to be phasing this out.</p>",
        "id": 523201250,
        "sender_full_name": "Andrew Yang",
        "timestamp": 1749527333
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> <a href=\"#narrow/channel/287929-mathlib4/topic/AlgHom.20to.20RingHom.20coercion.20is.20bad/near/522836448\">said</a>:</p>\n<blockquote>\n<p>Here is an excerpt of a more detailed trace:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>        [isDefEq] [0.000447] üí•Ô∏è EquivLike (‚Ñù ‚âÉ+* ‚Ñö) ?m.50 ?m.51 =?= EquivLike (?m.536 ‚âÉ+* ?m.537) ?m.536 ?m.537 ‚ñº\n          [] [0.000357] ‚úÖÔ∏è ‚Ñù ‚âÉ+* ‚Ñö =?= ?m.536 ‚âÉ+* ?m.537 ‚ñº\n            [] [0.000026] ‚úÖÔ∏è ‚Ñù =?= ?m.536 ‚ñ∂\n            [] [0.000017] ‚úÖÔ∏è ‚Ñö =?= ?m.537 ‚ñ∂\n            [] [0.000055] ‚úÖÔ∏è Real.instMul =?= ?m.538 ‚ñ∂\n            [] [0.000041] ‚úÖÔ∏è Rat.instMul =?= ?m.539 ‚ñ∂\n            [] [0.000053] ‚úÖÔ∏è Real.instAdd =?= ?m.540 ‚ñ∂\n            [] [0.000067] ‚úÖÔ∏è Rat.instAdd =?= ?m.541 ‚ñ∂\n          [] [0.000006] üí•Ô∏è ?m.50 =?= ‚Ñù ‚ñº\n            [] ?m.50 [nonassignable] =?= ‚Ñù [nonassignable]\n</code></pre></div>\n<p>The problem seems to be that the metavariable here is \"nonassignable\", causing the unification to fail. I'm not sure where this comes from, but it may have some relation to <a href=\"https://github.com/leanprover/lean4/pull/8364\">lean4#8364</a> (where something similar happens with an explicit coercion arrow).</p>\n</blockquote>\n<p>I believe what happens is that <code>?m.50</code> is the metavariable created by the underscores in <code>_ ‚Üí+* _</code>. Then a new context is created at some point in the search for a coercion, and metavariables outside of that context become nonassignable. The motivation for this is that you wouldn't want <code>(‚Üëx : _)</code>, where the expected type is unknown, to commit to the first coercion it finds, if later on the expected type is figured out.</p>",
        "id": 523234096,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1749543899
    },
    {
        "content": "<p>Of course, here the resulting type is in fact determined by the incoming type, but that is not the case for every coercion.</p>",
        "id": 523234367,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1749543983
    },
    {
        "content": "<p>Would it be an idea to have a <code>fun_coe%</code> elaborator that picks the right coercion here?</p>",
        "id": 523234458,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1749544015
    },
    {
        "content": "<p>You enter a unification step for a <code>FunLike</code> instance which bumps the meta context up by one and then you want to assign the original metavariable from the <code>_</code> which is now at the wrong depth to do this.</p>",
        "id": 523238137,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1749545132
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"439483\">Andrew Yang</span> <a href=\"#narrow/channel/287929-mathlib4/topic/AlgHom.20to.20RingHom.20coercion.20is.20bad/near/523201250\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/stream/287929-mathlib4/topic/AlgHom.20to.20RingHom.20coercion.20is.20bad/near/523172177\">said</a>:</p>\n<blockquote>\n<p>yes, and then the simp linter complains that you haven't put it in simp normal form</p>\n</blockquote>\n<p>You use <code>RingHomClass.toRingHom</code> instead. But people seem to be phasing this out.</p>\n</blockquote>\n<p>well i'm afraid this might be the best option for now, thanks for teaching me this; what do you mean by people phasing this out?</p>",
        "id": 523241052,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1749545983
    },
    {
        "content": "<p>Although here all meta variables at the new depth are already assigned‚Ä¶</p>",
        "id": 523241162,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1749546012
    }
]