[
    {
        "content": "<p>The (scoped) coercion from a commutative semiring to an algebra over this semiring is registered as <code>Algebra.cast</code>, which is reducibly defeq to <code>algebraMap</code>, but not syntactically or <code>simp</code>-equal. In fact, absolutely nothing is proved about <code>Algebra.cast</code> except that it commutes with ring operations.</p>\n<p>This makes it annoying to state lemmas about algebras because you have to either write <code>algebraMap _</code> everywhere or rewrite away the casts. I therefore propose to either</p>\n<ol>\n<li>add a <code>simp</code> lemma <code>Algebra.cast_eq_algebraMap</code>, or</li>\n<li>remove <code>Algebra.cast</code> and change the scoped coercion to be <code>algebraMap</code>.</li>\n</ol>\n<p>What are people's thoughts?</p>",
        "id": 563954155,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765850831
    },
    {
        "content": "<p>I prefer <a href=\"https://github.com/leanprover-community/mathlib4/pull/2\">#2</a></p>",
        "id": 563954717,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765851346
    },
    {
        "content": "<p>we don't need more nothing-definitions</p>",
        "id": 563954738,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1765851367
    },
    {
        "content": "<p>I also prefer the second option. Note that this should stay scoped, as in the very common case <code>R</code> is <code>‚Ñ§</code> there is already a coercion <code>‚Ñ§ ‚Üí A</code>.</p>",
        "id": 563994607,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1765876569
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/32991\">#32991</a></p>",
        "id": 564173825,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765948033
    },
    {
        "content": "<p>Here is a problem with option 2: <code>@[coe]</code> can only be applied to function type declarations. Therefore it doesn't work for <code>algebraMap</code>, which is bundled. This breaks the delaborator, which is fine - but it also breaks <code>norm_cast</code>, which is an issue. I want to register <code>coe</code> for the expression <code>@DFunLike.coe (R ‚Üí+* A) R (fun x ‚Ü¶ A) RingHom.instFunLike (algebraMap R A)</code>. Working up to reducible defeq by defining <code>Algebra.cast</code> is not good enough because Mathlib tactics care about syntactic equality (ie, status quo / option 1 is bad).</p>",
        "id": 564283389,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765986374
    },
    {
        "content": "<p>In my opinion we should live with the fact that <code>algebraMap</code> is not a coercion. We already do so in most of the library, and even if it is not the perfect solution it works in practice.</p>",
        "id": 564286318,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1765987118
    },
    {
        "content": "<p>In that case we should add a <code>simp</code> lemma to convert between <code>Algebra.cast</code> and <code>algebraMap</code>. The current situation is very bad: we have a nothing-definition with no API!</p>",
        "id": 564286902,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1765987258
    },
    {
        "content": "<p>Maybe Riccardo is suggesting:</p>\n<ol start=\"3\">\n<li>remove <code>Algebra.cast</code></li>\n</ol>",
        "id": 564401928,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1766045914
    },
    {
        "content": "<p>Yes, honestly I don't see why it's there. The idea is nice, but in practice it doesn't work. Is it used a lot?</p>",
        "id": 564403116,
        "sender_full_name": "Riccardo Brasca",
        "timestamp": 1766046330
    },
    {
        "content": "<p>It's there because it was part of a larger development that got reverted by the port</p>",
        "id": 564404395,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766046767
    },
    {
        "content": "<p>I believe the plan was to make it the simp-normal form instead of <code>algebraMap</code> (which has the benefit of making it work for towers of monoids and groups, like the units of the rings)</p>",
        "id": 564404412,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766046774
    },
    {
        "content": "<p>The plan was a little more compelling in Lean 3 where it could replace <code>Nat.cast</code>, <code>Int.cast</code>, and <code>Rat.cast</code> at the same time</p>",
        "id": 564404566,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766046838
    },
    {
        "content": "<p>Oh OK<br>\nYeah let's remove <code>Algebra.cast</code></p>",
        "id": 564448922,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766061467
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/32991\">#32991</a> - remove <code>Algebra.cast</code></p>",
        "id": 564501144,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766074238
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130384\">Riccardo Brasca</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast/near/564403116\">said</a>:</p>\n<blockquote>\n<p>Yes, honestly I don't see why it's there. The idea is nice, but in practice it doesn't work. Is it used a lot?</p>\n</blockquote>\n<p>Places where the cast is actually used as a cast (as opposed to notation):<br>\n<code>Algebra.adjoin_insert_natCast</code><br>\n<code>div_eq_quo_add_rem_div_add_rem_div</code><br>\n(WIP)</p>",
        "id": 564518004,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766078226
    },
    {
        "content": "<p>See also <a class=\"message-link\" href=\"/#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast.20and.20algebraMap/near/449430597\">#mathlib4 &gt; Algebra.cast and algebraMap @ üí¨</a></p>",
        "id": 564595680,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766105001
    },
    {
        "content": "<p>ah, an old question<br>\nI would really suggest having a <code>simp</code> lemma for now and then we can decide whether to go ahead with ripping out the coercion in future</p>",
        "id": 564595826,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766105082
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> what do you mean when you say the following:<br>\n<a href=\"/user_uploads/3121/8UIeCOoktv4IAZZIanbegA6r/image.png\">image.png</a><br>\nIf there is some way to make <code>algebraMap</code> work with <code>norm_cast</code>, then we should just do that.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/8UIeCOoktv4IAZZIanbegA6r/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"770x176\" src=\"/user_uploads/thumbnail/3121/8UIeCOoktv4IAZZIanbegA6r/image.png/840x560.webp\"></a></div>",
        "id": 564595975,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766105174
    },
    {
        "content": "<p>(note you can quote messages from other threads rather than screenshotting)</p>",
        "id": 564596875,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766105769
    },
    {
        "content": "<p>So.. what <em>does</em> that message mean? <em>Is</em> there some way to make <code>algebraMap</code> work with <code>norm_cast</code>?</p>",
        "id": 564781934,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766182154
    },
    {
        "content": "<p>I thought <code>@[coe]</code> was just a pretty printer thing</p>",
        "id": 564782027,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766182205
    },
    {
        "content": "<p>why is it messing up <code>norm_cast</code></p>",
        "id": 564782053,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766182220
    },
    {
        "content": "<p><code>norm_cast</code> looks for coercion instances. It is not possible to register a bundled function as a coercion.</p>",
        "id": 564782240,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766182322
    },
    {
        "content": "<p>No, <code>norm_cast</code> looks for <code>@[coe]</code> attributes, not coercion instances, those attributes don't just affect pretty-printing.</p>",
        "id": 564783452,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1766183173
    },
    {
        "content": "<p>In particular, since Lean inserts the function underlying a coercion (via coercion instances) during elaboration, the fact that they were / are a coercion would be lost in the resulting <code>Expr</code>, so we need the attribute to tell Lean \"hey, when you see <code>Subtype.val</code>, that's a coercion.\"</p>",
        "id": 564783586,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1766183263
    },
    {
        "content": "<p>Ah, thanks for the correction! The situation is the same though right? It sounds like there's no way to make this work, then?</p>",
        "id": 564785620,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766184851
    },
    {
        "content": "<p>I think there's a request here for a version <code>norm_cast</code> that accepts an explicit list of names rather than just everything tagged with <code>coe</code></p>",
        "id": 564785855,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766184998
    },
    {
        "content": "<p><code>norm_cast</code> could be a shorthand for <code>norm_fun [Coe.coe]</code> or similar</p>",
        "id": 564785901,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766185035
    },
    {
        "content": "<p>Or alternatively a request to allow coercion functions to be bundled, via a <code>CoeFun</code> instance.</p>",
        "id": 564785954,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185078
    },
    {
        "content": "<p>Or both tbh <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span></p>",
        "id": 564785973,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185089
    },
    {
        "content": "<p>I think we have exactly one function we want to do that with (<code>algebraMap</code>), but if we decided to</p>\n<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast/near/564404412\">said</a>:</p>\n<blockquote>\n<p>make [<code>Algebra.cast</code>] the simp-normal form instead of <code>algebraMap</code> (which has the benefit of making it work for towers of monoids and groups, like the units of the rings)</p>\n</blockquote>\n<p>then we would have zero of them</p>",
        "id": 564786028,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766185135
    },
    {
        "content": "<p>The issue with making it the SNF is we lose all the bundled function API<br>\nI'd rather have a bare coercion that <code>simp</code>s to <code>algebraMap</code></p>",
        "id": 564786092,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185195
    },
    {
        "content": "<p>Also we could make the <code>Nat.toInt</code> etc coercions bundled!</p>",
        "id": 564786145,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185218
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.toInt#doc\">docs#Nat.toInt</a> isn't a thing</p>",
        "id": 564786241,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766185281
    },
    {
        "content": "<p>Sorry I mean <code>Nat.cast</code></p>",
        "id": 564786442,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185449
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast/near/564786442\">said</a>:</p>\n<blockquote>\n<p>Sorry I mean <code>Nat.cast</code></p>\n</blockquote>\n<p>There are times when it makes sense to not bundle those, and there are times it makes sense to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.castRingHom#doc\">docs#Nat.castRingHom</a> etc.</p>",
        "id": 564786539,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766185513
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast/near/564782240\">said</a>:</p>\n<blockquote>\n<p>It is not possible to register a bundled function as a coercion.</p>\n</blockquote>\n<p>Why do you say this? I think it's definitely possible</p>",
        "id": 564786581,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766185553
    },
    {
        "content": "<p>you just write a <code>CoeFun</code> instance and you make the coercion part the bundled function</p>",
        "id": 564786630,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766185600
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast/near/564786539\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"400289\">Artie Khovanov</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast/near/564786442\">said</a>:</p>\n<blockquote>\n<p>Sorry I mean <code>Nat.cast</code></p>\n</blockquote>\n<p>There are times when it makes sense to not bundle those, and there are times it makes sense to use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.castRingHom#doc\">docs#Nat.castRingHom</a> etc.</p>\n</blockquote>\n<p>Well in that case we should add API to <code>Algebra.cast</code> to relate it to <code>algebraMap</code>!</p>",
        "id": 564786790,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185741
    },
    {
        "content": "<p>Like we should do <em>something</em></p>",
        "id": 564786803,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185749
    },
    {
        "content": "<p>well the difference is that I don't think it makes sense to not bundle <code>algebraMap</code></p>",
        "id": 564786823,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766185771
    },
    {
        "content": "<p>right</p>",
        "id": 564786839,
        "sender_full_name": "Artie Khovanov",
        "timestamp": 1766185783
    },
    {
        "content": "<p>like with the absolutely minimal assumptions you put that makes the definition work is still gives you enough to make it bundled</p>",
        "id": 564786852,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766185797
    },
    {
        "content": "<p>whereas there's times that <code>Nat.cast</code> is useful but the target isn't a ring</p>",
        "id": 564786879,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1766185819
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/Algebra.2Ecast/near/564786852\">said</a>:</p>\n<blockquote>\n<p>like with the absolutely minimal assumptions you put that makes the definition work is still gives you enough to make it bundled</p>\n</blockquote>\n<p>Only because the current generality is wrong; consider non-associative rings or non-commutative base rings or monoids.</p>",
        "id": 564787960,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766186837
    },
    {
        "content": "<p>e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">class</span><span class=\"w\"> </span><span class=\"n\">AlgebraCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">algebraCast</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">‚Üí</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"c1\">-- imagine that `Algebra` extended `AlgebraCast`</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AlgebraCast</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">algebraCast</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">algebraMap</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span>\n\n<span class=\"c1\">-- This can't be bundled as a ringhom</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Algebra</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">AlgebraCast</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"bp\">À£</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"bp\">À£</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">algebraCast</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"n\">algebraCast</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">algebraCast</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"bp\">‚Åª¬π</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"gr\">sorry</span><span class=\"bp\">‚ü©</span>\n</code></pre></div>",
        "id": 564787965,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1766186842
    }
]