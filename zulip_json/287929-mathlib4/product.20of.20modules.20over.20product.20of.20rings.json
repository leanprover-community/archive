[
    {
        "content": "<p>I was surprised that we didn't have this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">-- variable (R S M N : Type*) [CommRing R] [CommRing S]</span>\n<span class=\"c1\">--     [AddCommGroup M] [Module R M] [AddCommGroup N] [Module S N] in</span>\n<span class=\"c1\">-- #synth Module (R Ã— S) (M Ã— N)-- fails</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CommRing</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">]</span>\n<span class=\"w\">    </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"n\">M</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">AddCommGroup</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">Ã—</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">M</span><span class=\"w\"> </span><span class=\"bp\">Ã—</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">smul</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rs</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"bp\">â€¢</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">.</span><span class=\"m\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"w\"> </span><span class=\"bp\">â€¢</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">.</span><span class=\"m\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">one_smul</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">exacts</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">one_smul</span><span class=\"w\"> </span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">one_smul</span><span class=\"w\"> </span><span class=\"n\">S</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">mul_smul</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"n\">rs'</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">rs'</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">mn</span>\n<span class=\"w\">    </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">mul_smul</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">smul_zero</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">smul_zero</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">smul_add</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"n\">mn'</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">mn'</span>\n<span class=\"w\">    </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">smul_add</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">add_smul</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"w\"> </span><span class=\"n\">rs'</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">rs</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">rs'</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">mn</span>\n<span class=\"w\">    </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">add_smul</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">  </span><span class=\"n\">zero_smul</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">cases</span><span class=\"w\"> </span><span class=\"n\">mn</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">ext</span><span class=\"w\"> </span><span class=\"bp\">&lt;;&gt;</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">zero_smul</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n</code></pre></div>\n<p>Is it not there for a reason?</p>",
        "id": 532797132,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1754341152
    },
    {
        "content": "<p>You get a diamond when <code>R = S</code> and <code>M = N = R Ã— S</code>, which could be a problem</p>",
        "id": 532797383,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1754341267
    },
    {
        "content": "<p>yeah this was exactly the sort of reason I was expecting :-/</p>",
        "id": 532798963,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1754341891
    },
    {
        "content": "<p>Note that <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Algebra/Module/Prod.html#Prod.instModule\">Prod.instModule</a> (<code>Module R (M Ã— N)</code>) is already a thing</p>",
        "id": 532799560,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754342120
    },
    {
        "content": "<p>so what's missing is actually the \"projection\" instances</p>",
        "id": 532799575,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754342132
    },
    {
        "content": "<p>The general rule is that <code>SMul X Y -&gt; SMul (F X) (F Y)</code> is almost always a bad idea</p>",
        "id": 532799613,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1754342157
    },
    {
        "content": "<p>which cause diamond with each other</p>",
        "id": 532799614,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1754342157
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/product.20of.20modules.20over.20product.20of.20rings/near/532799613\">said</a>:</p>\n<blockquote>\n<p>The general rule is that <code>SMul X Y -&gt; SMul (F X) (F Y)</code> is almost always a bad idea</p>\n</blockquote>\n<p>In FLT we have an instance <code>[NumberField K] [NumberField L] [Algebra K L] -&gt; [Algebra (AdeleRing (ğ“ K) K) (AdeleRing (ğ“ L) L)]</code>. Would this be an exception to the general rule? Because here the arguments of the form \"what if X = F Z\" can't apply, as X is always a number field and F X never is.</p>",
        "id": 537083774,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756723979
    },
    {
        "content": "<p>Yes, that's the kind of exception I had in mind; those are still \"bad\" in that they encourage people to write similar instances which could satisfy <code>X = F Z</code>, especially if type-classes are weakened</p>",
        "id": 537084920,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756724460
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/287929-mathlib4/topic/product.20of.20modules.20over.20product.20of.20rings/near/532797383\">said</a>:</p>\n<blockquote>\n<p>You get a diamond when <code>R = S</code> and <code>M = N = R Ã— S</code>, which could be a problem</p>\n</blockquote>\n<p>Then I'm puzzled, because it seems that the case of arbitrary products exists as <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Pi.module%27#doc\">docs#Pi.module'</a>, so that instance would probably make a diamond as well.</p>",
        "id": 537112979,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1756734015
    },
    {
        "content": "<p>It does indeed: there are two natural actions of <code>X â†’ R</code> on <code>X â†’ X â†’ R</code>. I don't think this is fixable without a convenient way to refer to module structures, but this has been discussed before (e.g in the context of representation theory).</p>",
        "id": 537114288,
        "sender_full_name": "Anatole Dedecker",
        "timestamp": 1756734448
    },
    {
        "content": "<p>Hmm. There is still a diamond problem with the instance <code>[Algebra K L] -&gt; [Algebra (ğ”¸ K) (ğ”¸ L)]</code> in FLT, namely that if <code>L = K</code> this gives two non-defeq instances of <code>[Algebra (ğ”¸ K) (ğ”¸ L)]</code> (here <code>ğ”¸ K := AdeleRing (ğ“ K) K)</code>). Should I be (a) striving to make them defeq or (b) giving up on the idea of being able to write this very natural-looking mathematics in Mathlib at all or (c) doing instance priority hacks to get around it (basically ensuring that Lean tries identity stuff before this stuff)?</p>\n<p>Interestingly this issue even propogates to <code>Prop</code>-valued instances. For example we have an instance <code>IsModuleTopology (ğ”¸ K) (ğ”¸ L)</code> and my instinct would be that this couldn't cause diamonds because it's a Prop, but it instead causes typeclass timeouts because it's necessarily defined using the more general <code>[Algebra (ğ”¸ K) (ğ”¸ L)]</code> so won't fire when <code>L = K</code>.</p>",
        "id": 537469175,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756903909
    },
    {
        "content": "<p>What do people think of <a href=\"https://github.com/leanprover-community/mathlib4/pull/29315\">#29315</a> ? This ensures that synthesizing <code>IsModuleTopology (ğ”¸ K) (ğ”¸ K)</code> does not time out in FLT.</p>",
        "id": 537474442,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756905504
    },
    {
        "content": "<p>I think in general it's impossible to make them defeq unless you have some kind of <code>X.map id = X := by rfl</code> lemma, which is very rarely true by definition.</p>",
        "id": 537536338,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756925612
    },
    {
        "content": "<p>So yes, defeq  of <code>SMul (F X) (F X)</code> via the <code>SMul X Y -&gt; SMul (F X) (F Y)</code> instance vs the <code>Mul X -&gt; SMul X X</code> one is another reason that this pattern is really not a good one</p>",
        "id": 537536515,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756925688
    },
    {
        "content": "<p>I understand what you're saying but it's hard not to read it as \"Mathlib's setup makes it not very good for doing some parts of number theory\".</p>",
        "id": 537547518,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756930459
    },
    {
        "content": "<p>Let me go through this again to make sure I've got my argument straight. <code>ğ”¸</code> (pronounced \"adeles of\") is a function which eats a (number) field and spits out a commutative topological ring (which is never a field). Objections are being raised above to the instance <code>Algebra K L -&gt; Algebra (ğ”¸ K) (ğ”¸ L)</code> so that's fine, this doesn't have to an instance, it can be something which can be switched on manually.</p>\n<p>A nontrivial and interesting theorem which we're working towards in FLT is that if <code>Algebra K L</code> then the topology on <code>ğ”¸ L</code> is the <code>ğ”¸ K</code>-module topology. This is stated as a typeclass <code>IsModuleTopology R M</code> in Mathlib, where M is an R-module. So to even state the theorem we're going for in mathlib we need an instance <code>Module (ğ”¸ K) (ğ”¸ L)</code> so this instance needs to be inserted into the system somehow, and it has to come from <code>Algebra K L</code>. In particular, when we ask typeclass inference to find <code>IsModuleTopology (ğ”¸ K) (ğ”¸ L)</code>, the instance it finds must use an instance of <code>Module (ğ”¸ K) (ğ”¸ L)</code> so it must use an instance of <code>Algebra K L</code>, so the proof must use the construction <code>Algebra K L -&gt; Algebra (ğ”¸ K) (ğ”¸ L)</code> (whether or not this construction itself is an instance). However when <code>K = L</code> this construction which will necessarily be used does not (and probably cannot) give us something defeq to <code>Algebra.id (ğ”¸ K)</code> for <code>Algebra (ğ”¸ K) (ğ”¸ K)</code>. This is likely to manifest itself in typeclass inference timing out.</p>\n<p>My proposal in <a href=\"https://github.com/leanprover-community/mathlib4/pull/29315\">#29315</a> is simply to slightly raise the priority of <code>IsTopologicalSemiring.toIsModuleTopology R : IsModuleTopology R R</code> so that <code>IsModuleTopology (ğ”¸ K) (ğ”¸ K)</code> is solved by this instance before it finds the K = L case of the path <code>Algebra K L -&gt; Algebra (ğ”¸ K) (ğ”¸ L) -&gt; IsModuleTopology (ğ”¸ K) (ğ”¸ L)</code> (which won't unify because the algebra instance is wrong).</p>\n<p>I dug into the history of why <code>Algebra.id</code> managed to get a priority of 1100 (so higher than default). It was done in <a href=\"https://github.com/leanprover-community/mathlib4/pull/13032\">#13032</a> which was itself inspired by a far more technical discussion about adeles (which I'm about to link to). I didn't understand most of the things said about discriminant trees but I'd like to highlight <a href=\"#narrow/channel/287929-mathlib4/topic/erw.20and.20IsDedekindDomain.2EHeightOneSpectrum.2EadicCompletion/near/439435572\">this comment</a> by <span class=\"user-mention\" data-user-id=\"479299\">@Jovan Gerbscheid</span> which argued that <code>Algebra.id</code> should be tried last because of something to do with discrimination trees which I have no understanding of (indeed I'm still looking for the basic reference on discrimination trees which would tell me what they are -- blog post anyone?). People can just read Jovan's explanation so I won't attempt to copy-paste and possibly butcher it here. Is this an argument against <a href=\"https://github.com/leanprover-community/mathlib4/pull/29315\">#29315</a> ? Note that just as <a href=\"https://github.com/leanprover-community/mathlib4/pull/13032\">#13032</a> did, <a href=\"https://github.com/leanprover-community/mathlib4/pull/29315\">#29315</a> makes mathlib slightly quicker.</p>",
        "id": 537550861,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756931809
    },
    {
        "content": "<p>What about scoping all the instances you need (including <code>Algebra K L -&gt; Algebra (ğ”¸ K) (ğ”¸ L)</code>) and opening them in sections where you will never use <code>K = L</code>?</p>",
        "id": 537551511,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1756932109
    },
    {
        "content": "<p>The problem is that the <em>proof</em> of <code>IsModuleTopology (ğ”¸ K) (ğ”¸ L)</code> uses along the way the fact that <code>ğ”¸ L</code> is homeomorphic to <code>Fin n -&gt; ğ”¸ K</code> where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo>=</mo><mo stretchy=\"false\">[</mo><mi>L</mi><mo>:</mo><mi>K</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">n=[L:K]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mclose\">]</span></span></span></span> and then uses <code>IsModuleTopology R M -&gt; IsModuleTopology R (Fin n -&gt; M)</code> so in particular it uses <code>IsModuleTopology (ğ”¸ K) (ğ”¸ K)</code> :-) Indeed formalising this argument is exactly how we discovered the problem.</p>",
        "id": 537551825,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756932270
    },
    {
        "content": "<p>In Lean 3 we often used a pattern along the lines of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">someBadDataCarryingInstance</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SomePropInstanceThatNeedsIt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>though I seem to recall that this was very rarely unsafe in some versions of Lean 4 (maybe <span class=\"user-mention\" data-user-id=\"238446\">@Anne Baanen</span>  remembers), as some unwanted unification sometimes happened in typeclass search.</p>",
        "id": 537555119,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756933899
    },
    {
        "content": "<p>Maybe that's orthogonal to your point though</p>",
        "id": 537555241,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756933953
    },
    {
        "content": "<p>I don't see anything wrong with <a href=\"https://github.com/leanprover-community/mathlib4/pull/29315\">#29315</a>; in general I think we're not very principled with priority changes, and so ultimately determining if a priority change is a good idea is just a matter of measuring if the things you care about got faster without other things getting too much slower</p>",
        "id": 537555404,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756934007
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/channel/287929-mathlib4/topic/product.20of.20modules.20over.20product.20of.20rings/near/537550861\">said</a>:</p>\n<blockquote>\n<p>I'd like to highlight <a href=\"#narrow/channel/287929-mathlib4/topic/erw.20and.20IsDedekindDomain.2EHeightOneSpectrum.2EadicCompletion/near/439435572\">this comment</a> by @Jovan Gerbscheid which argued that <code>Algebra.id</code> should be tried last because of something to do with discrimination trees which I have no understanding of</p>\n</blockquote>\n<p>My reading of this was not \"it should be tried last\", but \"it will be tried last and there's nothing you can do about it\"</p>",
        "id": 537555545,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756934070
    },
    {
        "content": "<p>Mathematically, is <code>Algebra (ğ”¸ K) (ğ”¸ L)</code> subsingleton? If so you could assume that in your theorem instead and maybe the problem would go away.</p>",
        "id": 537555799,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1756934186
    },
    {
        "content": "<p>No it's not, unfortunately; if K has automorphisms then so does <code>ğ”¸ K</code>; for example complex conjuation on <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi><mo>:</mo><mo>=</mo><mi mathvariant=\"double-struck\">Q</mi><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">K:=\\mathbb{Q}(i)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">:=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathbb\">Q</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mclose\">)</span></span></span></span> will induce a nontrivial topological ring automorphism of <code>ğ”¸ K</code> and precomposing with this will give you another algebra instance.</p>",
        "id": 537556631,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756934619
    },
    {
        "content": "<p>If you just need <code>IsModuleTopology (ğ”¸ K) (ğ”¸ K)</code> in a proof, can't you just put a line <code>have : IsModuleTopology (ğ”¸ K) (ğ”¸ K) := instIdOrWhatever</code> to override what typeclass inference would do?</p>",
        "id": 537557364,
        "sender_full_name": "SÃ©bastien GouÃ«zel",
        "timestamp": 1756935045
    },
    {
        "content": "<p>Yes absolutely. The only reason I was looking into this was that the person who was writing the PR (not me) couldn't understand why typeclass inference was not doing all the work for them, because all the issues are there. I checked that their <code>sorry</code> could be replaced by <code>inferInstance</code> after <a href=\"https://github.com/leanprover-community/mathlib4/pull/29315\">#29315</a> .</p>",
        "id": 537558068,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756935483
    },
    {
        "content": "<p>If the community doesn't like that PR though, then probably either I will do this or I will lower the priority of <code>Algebra (\\A K) (\\A L)</code> to slightly less than 1000, which will have the same effect in practice.</p>",
        "id": 537558206,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1756935562
    }
]