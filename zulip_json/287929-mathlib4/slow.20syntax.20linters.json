[
    {
        "content": "<p>The syntax linters are quite slow for me. It was ~10x faster for <span class=\"user-mention\" data-user-id=\"634338\">@Michael Rothgang</span> on Linux (on a different machine of course). This is causing noticeable slowdowns when compiling a large file for me.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Core</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- linting takes about 90ms on average</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- linting takes about 75ms on average</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 499307513,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739387071
    },
    {
        "content": "<p>Floris, I am happy to try unifying at least some of the linters and see whether that helps.  I am not sure that I will have time today, though.</p>",
        "id": 499421598,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739438907
    },
    {
        "content": "<p>I will probably try a very simple-minded unification of just the linters that detect some <code>SyntaxNodeKind</code> and act on that, check that it has a measurable improvement and, if that is the case, continue to unify more.</p>",
        "id": 499421901,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739438990
    },
    {
        "content": "<p>Would you be willing to test out the initial implementation?</p>",
        "id": 499422005,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739439009
    },
    {
        "content": "<p>Yes, I can test implementations (not always within a day, though). Thanks for looking into this!</p>",
        "id": 499447789,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739446175
    },
    {
        "content": "<p>Arend and I were wondering about the performance difference - that could be OS-related. The <code>header</code> linter does some substantial IO, which could explain things.</p>",
        "id": 499465127,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739451199
    },
    {
        "content": "<p>Is the following different, disabling the <code>header</code> linter?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Core</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- linting takes about 90ms on average</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- linting takes about 75ms on average</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 499465248,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739451221
    },
    {
        "content": "<p>(Fun fact: on the playground, which runs on some fast Linux server, the above to threshold set to <code>1</code> becomes very slightly <em>slower</em> when setting the option, from 1 to 2ms per line.)</p>",
        "id": 499465516,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1739451319
    },
    {
        "content": "<p>Not significantly. In fact, the linting time seems to roughly linearly decrease in the following code snippet (with a lot of noise):</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Core</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"bp\">.</span><span class=\"n\">threshold</span><span class=\"w\"> </span><span class=\"mi\">10</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">profiler</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- linting takes about 80ms on average</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">header</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">cdot</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">dollarSyntax</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">lambdaSyntax</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">longFile</span><span class=\"w\"> </span><span class=\"mi\">10000</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">longLine</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">missingEnd</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">multiGoal</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">style</span><span class=\"bp\">.</span><span class=\"n\">setOption</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">hashCommand</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">constructorNameAsVariable</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">deprecated</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">docPrime</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">dupNamespace</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">globalAttributeIn</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">hashCommand</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">missingDocs</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">oldObtain</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">omit</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">suspiciousUnexpanderPatterns</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unnecessarySimpa</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedRCasesPattern</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedSectionVars</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedTactic</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- linting takes about 30ms on average</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 499499131,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739459687
    },
    {
        "content": "<p>An option to turn off all linters at once would be nice!</p>",
        "id": 499499218,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739459702
    },
    {
        "content": "<p>If <code>linter.all false</code> doesn't work, that's a bug in the respective linter</p>",
        "id": 499551526,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739471718
    },
    {
        "content": "<p><code>set_option linter.all false</code> is the default value for that option, so setting that probably doesn't turn off linters. The description states <code>enable all linters</code>. Maybe it should be a 3-valued setting: enable all (true), disable all (false) or default (leave it up to the linter). (There are other places where 3-valued settings make sense that are currently 2-valued.)</p>",
        "id": 499597523,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739485791
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499551526\">said</a>:</p>\n<blockquote>\n<p>If <code>linter.all false</code> doesn't work, that's a bug in the respective linter</p>\n</blockquote>\n<p>Could you comment on the long discussion we had in <a class=\"message-link\" href=\"/#narrow/channel/263328-triage/topic/PR.20.214.2319556.3A.20perf.3A.20disable.20the.20unused.20tactic.20linter/near/493957874\">#triage &gt; PR !4#19556: perf: disable the unused tactic linter @ üí¨</a> ? Is it all about bugs in the respective linters?</p>",
        "id": 499598233,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1739486075
    },
    {
        "content": "<p>In the simple example below, the unused tactic linter does seem to heed the <code>linter.all</code> option:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">UnusedTactic</span>\n\n<span class=\"c1\">-- commenting this makes the unused tactic linter flag `skip`</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 499665443,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739520082
    },
    {
        "content": "<p>Floris, I think that the options almost have the 3 states that you describe: I think that Lean knows whether the option has been explicitly set to something or is at its default value (which is different than setting it with <code>set_option</code> to its default value).</p>",
        "id": 499665714,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739520161
    },
    {
        "content": "<p>Crucially we want the option to set once and for all, not in every file.</p>",
        "id": 499670834,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1739521674
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499665714\">said</a>:</p>\n<blockquote>\n<p>Floris, I think that the options almost have the 3 states that you describe: I think that Lean knows whether the option has been explicitly set to something or is at its default value (which is different than setting it with <code>set_option</code> to its default value).</p>\n</blockquote>\n<p>I think we shouldn't treat it as having 3 values unless we can actually (manually) set the option value to all 3 values ourselves.</p>",
        "id": 499672499,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1739522144
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499670834\">said</a>:</p>\n<blockquote>\n<p>Crucially we want the option to set once and for all, not in every file.</p>\n</blockquote>\n<p>Are you saying linter.all false does not work in a lakefile?</p>",
        "id": 499676227,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739523226
    },
    {
        "content": "<p>I am preparing a single file which triggers all (or almost all) the mathlib linters and I will then add a test to mathlib that <code>linter.all</code> \"works\".</p>",
        "id": 499677102,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739523448
    },
    {
        "content": "<p>I can also add the <code>all</code> option to the lakefile of the <code>DownstreamProject</code> and add the test there as well.</p>",
        "id": 499677204,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739523480
    },
    {
        "content": "<p>This is proving much harder than I expected.</p>",
        "id": 499687411,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526109
    },
    {
        "content": "<p>I think that the inconsistencies that I am observing are due to the following differences.</p>",
        "id": 499687554,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526139
    },
    {
        "content": "<p>Some mathlib linters are by default true (e.g. the <code>unusedTactic</code> linter), others are by default false but set to true in the lakefile (e.g. the <code>hashCommand</code> linter).</p>",
        "id": 499687697,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526185
    },
    {
        "content": "<p>The ones that use their default value from the place where the option is registered, do follow the <code>linter.all</code> option as expected.</p>",
        "id": 499687820,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526221
    },
    {
        "content": "<p>However, setting the option in the lakefile <em>does count</em> as setting the option explicitly, so they <em>ignore</em> the <code>linter.all</code> option.</p>",
        "id": 499687970,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526257
    },
    {
        "content": "<p>This is made trickier by the fact that the online server appears to use <em>yet another</em> default option setting.</p>",
        "id": 499688473,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526379
    },
    {
        "content": "<p>For instance, in the example below, I get different behaviour on the online server and locally.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">false</span>\n\n<span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">skip</span>\n<span class=\"w\">  </span><span class=\"n\">trivial</span>\n</code></pre></div>",
        "id": 499688551,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526399
    },
    {
        "content": "<p>Locally, the <code>#guard</code> is <em>always</em> flagged, regardless of whether the <code>set_option</code> line is commented or not.</p>",
        "id": 499688774,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526456
    },
    {
        "content": "<p>In the online server, the <code>#guard</code> is <em>never</em> flagged, regardless of whether the <code>set_option</code> line is commented or not.</p>",
        "id": 499688806,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526468
    },
    {
        "content": "<p>The <code>skip</code> behaves as expected in both settings: it is flagged when the <code>linter.all</code> is not set and not flagged with <code>linter.all</code> set to <code>false</code>.</p>",
        "id": 499689022,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526521
    },
    {
        "content": "<p>My conclusions are the following.</p>\n<ol>\n<li>We should not trust the online server when it comes to testing linter options.</li>\n<li>Maybe, all mathlib linters should have their default value set to what is now implied by the lakefile, so that <code>linter.all</code> works as expected downstream.</li>\n</ol>",
        "id": 499689560,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526665
    },
    {
        "content": "<p>A possibly unwanted consequence of 2 is that all the <em>style</em> decisions that mathlib makes would be enforced by default on downstream projects, unless they explicitly opt out.</p>",
        "id": 499689710,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526711
    },
    {
        "content": "<p>My mental model, though, was that setting options in the lakefile was \"weaker\" than using <code>set_option</code> and was more analogous to saying \"pretend that I registered the option with this value instead of what I actually wrote\".</p>",
        "id": 499690173,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739526817
    },
    {
        "content": "<p>Here is probably a better mental model (I am writing this now mostly for my own clarity).</p>\n<p>Setting the option in the lakefile is essentially the same as writing <code>set_option whatever value</code> at the beginning of every file.</p>\n<p>It is <em>not</em> analogous to replacing the <code>defValue</code> of the option to what you want.</p>",
        "id": 499691337,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739527090
    },
    {
        "content": "<p>I think maybe the lakefile is a distraction, and already the semantics of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"c1\">-- does this override `all`?</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"c1\">-- does this override `all`?</span>\n</code></pre></div>\n<p>are confusing</p>",
        "id": 499691519,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739527138
    },
    {
        "content": "<p>Yes, the lakefile is a further twist of who sets what when.</p>",
        "id": 499691676,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739527180
    },
    {
        "content": "<p>The fact that the online server has yet another convention does not simplify the situation.</p>",
        "id": 499691966,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739527252
    },
    {
        "content": "<p>One resolution here would be to drop <code>linter.all</code> as a \"real\" option, and have it just mean \"right now, change all the other options to this value\"</p>",
        "id": 499692085,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739527287
    },
    {
        "content": "<p>I think that would clarify a lot.</p>",
        "id": 499692832,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739527477
    },
    {
        "content": "<p><del>So, basically, every option is effectively <code>linter.all &amp;&amp; linter.option</code>.</del> Not really. <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 499692995,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739527520
    },
    {
        "content": "<p>No, what you crossed out is how things are today</p>",
        "id": 499694893,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739527990
    },
    {
        "content": "<p>I think how things are today is <code>linter.option.getD (linter.all.getD linter_option_default)</code></p>",
        "id": 499741122,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739539643
    },
    {
        "content": "<p>keeping in mind that options are indeed 3-state</p>",
        "id": 499741201,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739539671
    },
    {
        "content": "<p>I would personally find it clearer if <code>set_option linter.all x</code> meant \"all options are <code>x</code>\", rather than \"all options that are not explicitly set, even in the lakefile, are <code>x</code>\".</p>",
        "id": 499749285,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739541529
    },
    {
        "content": "<p>And, if later you write <code>set_option myOption y</code>, then I would expect <code>myOption</code> to be <code>y</code> and all others <code>x</code>.</p>",
        "id": 499749454,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739541571
    },
    {
        "content": "<p>but those two statements are explicitly contradictory?</p>",
        "id": 499763157,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739545031
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499676227\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110031\">Patrick Massot</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499670834\">said</a>:</p>\n<blockquote>\n<p>Crucially we want the option to set once and for all, not in every file.</p>\n</blockquote>\n<p>Are you saying linter.all false does not work in a lakefile?</p>\n</blockquote>\n<p>I‚Äôm saying the only think that worked for me was to use <code>set_option</code> in every single file to kill the unwanted linters. In particular setting it in the lakefile of a project depending on Mathlib didn‚Äôt work.</p>",
        "id": 499769764,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1739546951
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499741201\">said</a>:</p>\n<blockquote>\n<p>keeping in mind that options are indeed 3-state</p>\n</blockquote>\n<p>Is there an <code>unset_option</code> to re-enter this third state?</p>",
        "id": 499772547,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739547689
    },
    {
        "content": "<p>Below are the 3 \"states\" that options can have.  Note that the <code>#guard_msgs</code> refer to the \"local\" values, not the ones in the online server.  For the online server, all the status reports are <code>none</code>, as though they were all unset.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">readStatus</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">os</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Options</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">os</span><span class=\"bp\">.</span><span class=\"n\">get?</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"bp\">.</span><span class=\"n\">name</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#option_status \"</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">opaqueInfo</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">leanOptionExpr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">`Lean.Option</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">`Bool</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"n\">leanOptionExpr</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">elabCommand</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span>\n<span class=\"w\">        </span><span class=\"n\">run_cmd</span>\n<span class=\"w\">          </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{Lean.Option.readStatus (‚Üê getOptions) $(‚ü®mkIdent v.name‚ü©)}\"</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"n\">logWarning</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"'{opt}' is not an option.\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">logWarning</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"'{opt}' is not an option.\"</span>\n\n<span class=\"sd\">/-- info: some (true) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">option_status</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">hashCommand</span>\n\n<span class=\"sd\">/-- info: some (false) -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">option_status</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">docPrime</span>\n\n<span class=\"sd\">/-- info: none -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">option_status</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedTactic</span>\n</code></pre></div>",
        "id": 499794398,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739554570
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499772547\">said</a>:</p>\n<blockquote>\n<p>Is there an <code>unset_option</code> to re-enter this third state?</p>\n</blockquote>\n<p>I looked for this, and I could not find an <code>unset_option</code>.</p>",
        "id": 499794514,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739554613
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499763157\">said</a>:</p>\n<blockquote>\n<p>but those two statements are explicitly contradictory?</p>\n</blockquote>\n<p>I was hoping that they would not be!</p>\n<p>What I meant to say is that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"c1\">-- here all options are `true`</span>\n<span class=\"bp\">...</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"c1\">-- here all options are `true`, except for `linter.unusedVariables`</span>\n</code></pre></div>\n<p>Is this more meaningful now?</p>",
        "id": 499794750,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739554698
    },
    {
        "content": "<p>What do you want</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"bp\">.</span><span class=\"n\">get?</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getOptions</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>to produce in those states?</p>",
        "id": 499795587,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739554993
    },
    {
        "content": "<p>First, the easy bit:</p>\n<ul>\n<li>before the first <code>set_option</code>, it should return <code>none</code>,</li>\n<li>between the two <code>set_option</code>s, it should return <code>some true</code>.</li>\n</ul>\n<p>After the second <code>set_option</code>, I am not sure.  Probably, I would still expect it to be <code>some true</code>.</p>",
        "id": 499796492,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739555315
    },
    {
        "content": "<p>And even if you systematically set all options (except <code>linter.all</code>!) to <code>false</code>, I would probably still expect the <code>linter.all</code> option to be <code>some true</code>.</p>",
        "id": 499796601,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739555358
    },
    {
        "content": "<p>My mental model is</p>\n<ul>\n<li><code>none</code> means that <code>set_option opt x</code> has not be written;</li>\n<li><code>some x</code> means that <code>set_option opt x</code> has been written above and <code>set_option opt (not x)</code> has not been written since.</li>\n</ul>",
        "id": 499796971,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739555482
    },
    {
        "content": "<p>Btw, the <code>#option_status</code> command above does not actually work as intended, as it does not seem to be aware of intervening <code>set_option</code>s.  <span aria-label=\"man facepalming\" class=\"emoji emoji-1f926-200d-2642\" role=\"img\" title=\"man facepalming\">:man_facepalming:</span></p>",
        "id": 499799135,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739556190
    },
    {
        "content": "<p>Anyway, summarising, I was also hoping that setting the <code>linter.all</code> option in the lakefile to <code>false</code> would set all linter options to <code>false</code>, whereas it seems that it only sets to false the ones that have not been set to some value in the lakefile.</p>",
        "id": 499799769,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739556424
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499796971\">said</a>:</p>\n<blockquote>\n<p>My mental model is</p>\n<ul>\n<li><code>none</code> means that <code>set_option opt x</code> has not be written;</li>\n<li><code>some x</code> means that <code>set_option opt x</code> has been written above and <code>set_option opt (not x)</code> has not been written since.</li>\n</ul>\n</blockquote>\n<p>that is correct</p>",
        "id": 499800787,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739556824
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499794750\">said</a>:</p>\n<blockquote>\n<p>What I meant to say is that</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"c1\">-- here all options are `true`</span>\n<span class=\"bp\">...</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"c1\">-- here all options are `true`, except for `linter.unusedVariables`</span>\n</code></pre></div>\n<p>Is this more meaningful now?</p>\n</blockquote>\n<p>What you should be asking is whether</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n</code></pre></div>\n<p>and</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span><span class=\"w\"> </span><span class=\"n\">false</span>\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n</code></pre></div>\n<p>result in the same state. Currently this is the case, because setting an option only sets that option, and all the logic about option interaction happens at <code>get</code> time</p>",
        "id": 499801219,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739556963
    },
    {
        "content": "<p>In both cases, the raw option state is <code>{all ‚Ü¶ true, unusedVariables ‚Ü¶ false}</code></p>",
        "id": 499801475,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739557065
    },
    {
        "content": "<p>and the way we find out whether unusedVariables is on is to check the <code>unusedVariables</code> option, and if that's not present then check the <code>all</code> option, and if that's not present either then use the default value of the <code>unusedVariables</code> option</p>",
        "id": 499801659,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739557123
    },
    {
        "content": "<p>which is what I wrote in code before</p>",
        "id": 499801682,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739557130
    },
    {
        "content": "<p>so setting <code>linter.all</code> has the effect of changing the values of any linters that are not <code>set_option</code>'d themselves (before or after the <code>set_option linter.all</code> line)</p>",
        "id": 499801782,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739557190
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499772547\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/499741201\">said</a>:</p>\n<blockquote>\n<p>keeping in mind that options are indeed 3-state</p>\n</blockquote>\n<p>Is there an <code>unset_option</code> to re-enter this third state?</p>\n</blockquote>\n<p>No but it would not be hard to write one</p>",
        "id": 499801944,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739557250
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Command</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"unset_option \"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">:</span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">identWithPartialTrailingDot</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getRef</span>\n<span class=\"w\">  </span><span class=\"n\">addCompletionInfo</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">CompletionInfo</span><span class=\"bp\">.</span><span class=\"n\">option</span><span class=\"w\"> </span><span class=\"n\">ref</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">optionName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">raw</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">eraseMacroScopes</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">toEIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ex</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Error</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">ref</span><span class=\"w\"> </span><span class=\"n\">ex</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">getOptionDecl</span><span class=\"w\"> </span><span class=\"n\">optionName</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">pushInfoLeaf</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ofOptionInfo</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">optionName</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">decl</span><span class=\"bp\">.</span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">erase</span><span class=\"w\"> </span><span class=\"n\">optionName</span>\n<span class=\"w\">  </span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">modifyScope</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">opts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">true</span>\n\n<span class=\"n\">unset_option</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"bp\">.</span><span class=\"n\">all</span>\n</code></pre></div>",
        "id": 499803353,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1739557801
    },
    {
        "content": "<p>I have a case where turning off the unusedVariables linter takes linting from 12 seconds to 117ms. I'm guessing this is unexpected behaviour?</p>",
        "id": 500264188,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1739821725
    },
    {
        "content": "<p>Can you share the example?</p>",
        "id": 500265269,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739822249
    },
    {
        "content": "<p>Of course! It's the instance on line 124 of <a href=\"https://github.com/leanprover-community/mathlib4/blob/314dd15079ad88e363cbc5f605dcb52e518cc742/Counterexamples/AharoniKorman.lean\">https://github.com/leanprover-community/mathlib4/blob/314dd15079ad88e363cbc5f605dcb52e518cc742/Counterexamples/AharoniKorman.lean</a></p>",
        "id": 500274250,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1739826375
    },
    {
        "content": "<p>I believe it should be almost trivial to make this mathlib-free: for this declaration virtually nothing from mathlib is actually needed, save for Equiv.refl and the notation for nat.</p>",
        "id": 500274473,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1739826494
    },
    {
        "content": "<p>I copied your example in the online server, but I observe virtually no difference between adding or not <code>set_option linter.unusedVariables false</code>.</p>",
        "id": 500284203,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739831456
    },
    {
        "content": "<p>(With or without the linter, it takes approximately 8-8.5s and the linter fails to notice an unused <code>x</code>.)</p>",
        "id": 500284906,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739831874
    },
    {
        "content": "<p>For me there's a pretty stark difference in the output of <code>set_option profiler true</code> when I change that option</p>",
        "id": 500289686,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1739835091
    },
    {
        "content": "<p>The absolute difference is less stark on the online server, but for me it outputs that lint took around 2.5s with the option on, and 26ms with it off, so still the same order of magnitude of relative difference.</p>",
        "id": 500290244,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1739835458
    },
    {
        "content": "<p>To make sure we're on the same page, here's the example showing a 10x slowdown in linting with that option changed: <a href=\"https://live.lean-lang.org/#codez=JYWwDg9gTgLgBAWQIYwBYBtgCMB0ARFJHAORXwFMAzAZwChaATKuACQnXQhDgC44AVAJ5hyvALxxS8AOuSUcWVPpNKcCJTYcuvVu07dASYRyZxhaZ4TgDegDskIctTBIAxqM376wGwwCuLmGAAN3c9LgB5KCYoHSkzOMV5IwTTRPgjAAUoCDBaODgAHzgYAHdgNzgAbwAPOEE4GzhfOCC4bj4pAF8dbgBqOAAmOEATIga4Iw8IqPIYgApqgBo6pZsASjhZ3yWgpZBVvMK4MrRvKtr65tb2426+WtHmo3rR1omwkEjojcXltvXN7a7fb5Io2cjVGAAfRApxqdSaLTasRQtzap3OcH6AEYRmjGpdxrotB9pnMfoJdpi4Fj/lsWkCDqDwVCkAwGGd4QTrl0dLV+s9BnAAFQbZr9ILrN7Ez4zb5LClI7G0wF/ejUchQnKBCCNMDZSjAdCymBQXzkWjqzVgbW6/WGmY4NBQRyodjsrEABmUzBgjhgOL4GSQsGASHQMpik24JVQM3N+SNcAxFiJ+gjG3UUaT/0z7zqwLgRshzso6CT4jgOGOqFOsykOCLJbLkP+9cbVGbBaLJqQNjoILgkKWQ8HS0dZQqI/H5VEkLgYgAfJXSjONlh6lxyABzJAFoojg9jleTsfV05zueL5cT0SzddqBw7vejl9T4+zsdgiHQ8/zpfTio7w3R9d0ZV9hyPG8XxwL8WTZQc/2vVcgIfbdQIHQ9oLPRoL0g1dL3/d812AtDn0wqdsIQijgBOHCEKvKsaJrRoUM3J9iNQp8wPI08mN/KdYJ/OiGMEmEWPvNj0MOHjK0o3DK0E1l2QIhTmUhJSOMksiIOg0TzzwydEIA28JJA7TwNU78xKwvi6JUmC1Os1izO4nSBMc/TLKhaz7KI5zSNciyHKszzgrg5SjL80yAowtzPzUjS3yg3yoP8rjYqCxT4Oo2iqKMrL2TSqT9zirz1Oy+KQuEwjUui9LpNKsLyuUyrwvomrkLqqSi17QJqEEEAQECpL8IM2dEK6wLZnI1Yxps3KLwmkid2Gub3Kq9q4EmjKRpPMrEqWzikFW2TbKotbDskk7GIW+bmLyq97xcHUtxiABmOAAB4AG4lyunbWqE6CiJU7aGt0hKKqQwzHuW46LQ1SEtWAHVC28X0oBwXwbF8dUGAANWDUMsCNag4EoMN1W9VRfWoGAhkDYNAjDdMsxjOMDkTZMJCjdNZlzYlswzDQ80ELtyGLDtyxTG77rrMh21LQdWwViWm2VzmJZ7PsTt2j9ofGhiorh8zMOMu7+Mi2qTd1tbAZ8q3OptgHgeSwGDqN62jtNnTZf4i7Pad73bdO26cvuxaGMoor/i6n2Lbs+3fxEjzxOd8GzbkiHvw9/8Cs0lyXfW7zQpBx3ALjkOmp83iw/y1OC5ijPfb0nCk+qg3G/qkrMob4vms282Y6r/O9cH43g6L92ob9uz65z+Dh6n/aZ9b8eva0kfIZaleIsDiv056mw+oGoaXfNsfQbhqaZrt0OI82sGe8v9vH+v8+QenvelyfoKs8vy6IFrr/1rg/K+cBno2FenAD6P0/pAPPmvABsMjrXVHgHH+18gA\">link</a></p>",
        "id": 500291283,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1739836165
    },
    {
        "content": "<p><code>trace.profiler</code> reveals</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">[</span><span class=\"mf\">5.394990</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">linters</span><span class=\"w\"> </span><span class=\"bp\">‚ñº</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">4.566265</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">UnusedVariables</span><span class=\"bp\">.</span><span class=\"n\">unusedVariables</span>\n<span class=\"w\">  </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mf\">0.816414</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">linter</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Linter</span><span class=\"bp\">.</span><span class=\"n\">globalAttributeInLinter</span><span class=\"bp\">.</span><span class=\"n\">globalAttributeIn</span>\n</code></pre></div>",
        "id": 500291946,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1739836651
    },
    {
        "content": "<p>Thanks for the reproducer, <a href=\"https://github.com/leanprover/lean4/pull/7129\">lean#7129</a> brings the overhead down to at or below other tasks that have to traverse the created expression (which as you might guess is huge in this example!)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">cumulative</span><span class=\"w\"> </span><span class=\"n\">profiling</span><span class=\"w\"> </span><span class=\"n\">times</span><span class=\"o\">:</span>\n<span class=\"w\">        </span><span class=\"kn\">attribute</span><span class=\"w\"> </span><span class=\"n\">application</span><span class=\"w\"> </span><span class=\"mf\">0.0469</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">blocked</span><span class=\"w\"> </span><span class=\"mf\">2.89</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">compilation</span><span class=\"w\"> </span><span class=\"mf\">8.79</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">elaboration</span><span class=\"w\"> </span><span class=\"mi\">741</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">fix</span><span class=\"w\"> </span><span class=\"n\">level</span><span class=\"w\"> </span><span class=\"n\">params</span><span class=\"w\"> </span><span class=\"mf\">0.508</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"mf\">37.5</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">initialization</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"n\">metavars</span><span class=\"w\"> </span><span class=\"mi\">491</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">interpretation</span><span class=\"w\"> </span><span class=\"mf\">1.38</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">linting</span><span class=\"w\"> </span><span class=\"mi\">339</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">parsing</span><span class=\"w\"> </span><span class=\"mf\">3.65</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"bp\">-</span><span class=\"n\">definitions</span><span class=\"w\"> </span><span class=\"mf\">91.4</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">share</span><span class=\"w\"> </span><span class=\"n\">common</span><span class=\"w\"> </span><span class=\"n\">exprs</span><span class=\"w\"> </span><span class=\"mi\">516</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"mf\">9.49</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"mf\">48.1</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">checking</span><span class=\"w\"> </span><span class=\"mi\">335</span><span class=\"n\">ms</span>\n<span class=\"w\">        </span><span class=\"n\">typeclass</span><span class=\"w\"> </span><span class=\"n\">inference</span><span class=\"w\"> </span><span class=\"mf\">11.7</span><span class=\"n\">ms</span>\n</code></pre></div>",
        "id": 500359189,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1739872485
    },
    {
        "content": "<p>Amazing, thank you! </p>\n<p><span class=\"user-mention silent\" data-user-id=\"110024\">Sebastian Ullrich</span> <a href=\"#narrow/channel/287929-mathlib4/topic/slow.20syntax.20linters/near/500359189\">said</a>:</p>\n<blockquote>\n<p>(which as you might guess is huge in this example!)</p>\n</blockquote>\n<p>This is a sign of my ignorance, but why is it so huge in this case? There are lots of <code>omega</code> happening and quite a few cases, but it seems to me like the expr here shouldn't be much bigger than that in some of the more advanced algebraic geometry files, for instance. My impression is that heavy tactics can cause a large proof term, but most of this declaration is in term mode already, and <code>omega</code> seems to me like one of those tactics which makes fairly nice proof terms. But clearly one of my assumptions is wrong!</p>",
        "id": 500603054,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1739957442
    },
    {
        "content": "<p>And a side question: does the unused <code>x</code> get flagged by the quicker linter?</p>",
        "id": 500655253,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1739973089
    }
]