[
    {
        "content": "<p>On this lemma from <a href=\"https://github.com/leanprover-community/mathlib4/pull/19335\">#19335</a>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">simp</span><span class=\"kd\">]</span>\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Primes</span><span class=\"bp\">.</span><span class=\"n\">prod_nat_equiv_apply</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Primes</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">prod_nat_equiv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">prime_iff</span><span class=\"bp\">.</span><span class=\"n\">mp</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"bp\">.</span><span class=\"n\">prop</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"bp\">.</span><span class=\"n\">add_one_pos</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>I get a linter error</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Error: ././././Mathlib/Data/Nat/Factorization/PrimePow.lean:171:1: error: Nat.Primes.prod_nat_equiv_apply Left-hand side simplifies from\n  Nat.Primes.prod_nat_equiv (p, k)\nto\n  Nat.Primes.prod_nat_equiv (p, k)\nusing\n  dsimp only [@Set.coe_setOf]\nTry to change the left-hand side to the simplified term!\n</code></pre></div>\n<p>which looks strange.</p>\n<p>Using <code>set_option pp.all true</code> reveals that the <code>dsimp</code> does change something: it replaces four occurrences of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Set</span><span class=\"bp\">.</span><span class=\"n\">Elem</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">setOf</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">  </span><span class=\"bp\">@</span><span class=\"n\">IsPrimePow</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">    </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">LinearOrderedCommMonoidWithZero</span><span class=\"bp\">.</span><span class=\"n\">toCommMonoidWithZero</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">instLinearOrderedCommMonoidWithZero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">))</span>\n</code></pre></div>\n<p>with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">Subtype</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">1</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">↦</span>\n<span class=\"w\">    </span><span class=\"bp\">@</span><span class=\"n\">IsPrimePow</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">LinearOrderedCommMonoidWithZero</span><span class=\"bp\">.</span><span class=\"n\">toCommMonoidWithZero</span><span class=\"bp\">.</span><span class=\"o\">{</span><span class=\"mi\">0</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">instLinearOrderedCommMonoidWithZero</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>But I don't see how I should write the left hand side so that the linter does not trigger. Any suggestions?</p>",
        "id": 483733565,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1732205108
    },
    {
        "content": "<p>Potential solution: Replace <code>↑{n : ℕ | IsPrimePow n}</code> by <code>{n : ℕ // IsPrimePow n}</code> as the target of <code>Nat.Primes.prod_nat_equiv</code>. Let's see if it works...</p>",
        "id": 483740153,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1732206867
    },
    {
        "content": "<p>Oh yes, you should definitely do that</p>",
        "id": 483741685,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1732207283
    },
    {
        "content": "<p>It did work.</p>",
        "id": 483743467,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1732207783
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479359\">Michael Stoll</span> has marked this topic as resolved.</p>",
        "id": 483743483,
        "sender_full_name": "Notification Bot",
        "timestamp": 1732207788
    },
    {
        "content": "<p>What caused this change in behavior? <br>\nI encountered the same issue in <a href=\"https://github.com/leanprover-community/mathlib4/pull/18891\">#18891</a> so I can be sure it happened between Nov 15 and Nov 20 inclusive. I find that using Subtype is more annoying because I had to fix a proof using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Set.coe_setOf#doc\">docs#Set.coe_setOf</a> backwards in order to rewrite using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Set.finite_coe_iff#doc\">docs#Set.finite_coe_iff</a>, and it's annoying that <code>simp_rw [&lt;- Set.coe_setOf]</code> causes a loop. Notice that this is the simp lemma that is now causing simpNF failures because it simplifies the type.</p>",
        "id": 483790037,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1732223777
    }
]