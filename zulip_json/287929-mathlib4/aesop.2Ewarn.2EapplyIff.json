[
    {
        "content": "<p>Aesop has just introduced a new warning in <a href=\"https://github.com/leanprover-community/aesop/commit/29cf094e84ae9852f0011b47b6ddc684ffe4be5f\">https://github.com/leanprover-community/aesop/commit/29cf094e84ae9852f0011b47b6ddc684ffe4be5f</a>, which is triggering in Mathlib, generating warnings that look like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">warning</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">././././</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Data</span><span class=\"bp\">/</span><span class=\"n\">Finset</span><span class=\"bp\">/</span><span class=\"n\">Sups</span><span class=\"bp\">.</span><span class=\"n\">lean</span><span class=\"o\">:</span><span class=\"mi\">632</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Apply</span><span class=\"w\"> </span><span class=\"n\">builder</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">conclusion</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">↔</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">You</span><span class=\"w\"> </span><span class=\"n\">probably</span><span class=\"w\"> </span><span class=\"n\">want</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">builder</span><span class=\"bp\">.</span>\n<span class=\"n\">Use</span><span class=\"w\"> </span><span class=\"ss\">`set_option</span><span class=\"w\"> </span><span class=\"n\">aesop</span><span class=\"bp\">.</span><span class=\"n\">warn</span><span class=\"bp\">.</span><span class=\"n\">applyIff</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">disable</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">warning</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>in many files.</p>\n<p>For now in <a href=\"https://github.com/leanprover-community/mathlib4/pull/17067\">#17067</a> I'm just disabling this warning in Mathlib.</p>\n<p>However I'm hoping someone could take over from here, and understand why these warnings are being generated, and if there is something we should be changing in Mathlib to avoid them.</p>",
        "id": 472358133,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727136080
    },
    {
        "content": "<p>Can you link to a CI log with those warnings?</p>",
        "id": 472359710,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727136835
    },
    {
        "content": "<p>I think this particular warning is fixed by the unmerged PR that provoked the addition of this warning flag</p>",
        "id": 472359803,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727136878
    },
    {
        "content": "<p>(<a href=\"https://github.com/leanprover-community/mathlib4/pull/16927\">#16927</a>)</p>",
        "id": 472359861,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727136910
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/aesop.2Ewarn.2EapplyIff/near/472359710\">said</a>:</p>\n<blockquote>\n<p>Can you link to a CI log with those warnings?</p>\n</blockquote>\n<p>All the recent nightly-testing <a href=\"#narrow/stream/428973-nightly-testing/topic/Mathlib.20status.20updates/near/472342833\">failures</a></p>",
        "id": 472360067,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727136993
    },
    {
        "content": "<blockquote>\n<p>You probably want to use the simp builder.</p>\n</blockquote>\n<p>This was largely not the approach used in <a href=\"https://github.com/leanprover-community/mathlib4/pull/16927\">#16927</a>. <span class=\"user-mention\" data-user-id=\"256311\">@Jannis Limperg</span>, was the approach in that PR unusual, or should the warning message suggest creating <code>alias</code>es of <code>apply</code> lemmas as another alternative?</p>",
        "id": 472360504,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727137204
    },
    {
        "content": "<p>That might be a question for me</p>",
        "id": 472408080,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727159510
    },
    {
        "content": "<p>The reason we couldn't use the simp builder here is that <code>proveFinsetNonempty</code> calls aesop with simp disabled, for performance. Whether that's an usual situation, I don't know. I would guess not.</p>",
        "id": 472412218,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727161091
    },
    {
        "content": "<p>Certainly the warning could suggest adding apply aliases as an alternative. That shouldn't hurt</p>",
        "id": 472412343,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727161129
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/287929-mathlib4/topic/aesop.2Ewarn.2EapplyIff/near/472360504\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>You probably want to use the simp builder.</p>\n</blockquote>\n<p>This was largely not the approach used in <a href=\"https://github.com/leanprover-community/mathlib4/pull/16927\">#16927</a>. <span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span>, was the approach in that PR unusual, or should the warning message suggest creating <code>alias</code>es of <code>apply</code> lemmas as another alternative?</p>\n</blockquote>\n<p>Good point, I'll add this as an alternative suggestion.</p>",
        "id": 472439540,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727168464
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/287929-mathlib4/topic/aesop.2Ewarn.2EapplyIff/near/472412218\">said</a>:</p>\n<blockquote>\n<p>The reason we couldn't use the simp builder here is that <code>proveFinsetNonempty</code> calls aesop with simp disabled, for performance. Whether that's an usual situation, I don't know. I would guess not.</p>\n</blockquote>\n<p>You could try disabling the default <code>simp</code> set (<code>aesop (config := { useDefaultSimpSet := false })</code>) and tagging the iff lemmas with <code>@[aesop simp (rule_sets := [...])]</code>. That way, Aesop's <code>simp</code> will only apply the iff lemmas, which should be quite fast. (Of course, the current strategy is even faster, but it is also a bit less powerful.)</p>",
        "id": 472440785,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727168770
    },
    {
        "content": "<p>Sorry for introducing this warning without warning. I should have notified you all of the likely breakage.</p>",
        "id": 472440932,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727168821
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256311\">Jannis Limperg</span> <a href=\"#narrow/stream/287929-mathlib4/topic/aesop.2Ewarn.2EapplyIff/near/472440785\">said</a>:</p>\n<blockquote>\n<p>Of course, the current strategy is even faster, but it is also a bit less powerful.</p>\n</blockquote>\n<p>Given that <code>proveFinsetNonempty</code> is used in <code>positivity</code> (every time some finset operation appears, like <code>Finset.sum</code>), which is itself used in <code>gcongr</code>, I think I want to keep disabling simp entirely for now. Once we have more uses of positivity on finset operations, we will be able to run some benchmark.</p>",
        "id": 472448160,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1727170766
    },
    {
        "content": "<p>Makes sense. <code>simp</code> is indeed by far the most expensive thing Aesop does.</p>",
        "id": 472462610,
        "sender_full_name": "Jannis Limperg",
        "timestamp": 1727174927
    }
]