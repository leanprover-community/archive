[
    {
        "content": "<p>I am trying to use the new syntax for setting options in the lakefile, but there is something that I do not understand: what is wrong with this?</p>\n<p>I set to <code>false</code> the default value of the <code>Mathlib.Linter.linter.hashCommand</code> option.  Then,  in the lakefile:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">leanOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`pp.unicode.fun</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"c1\">-- pretty-prints `fun a ↦ b`</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`autoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`relaxedAutoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`weak.Mathlib.Linter.linter.hashCommand</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n</code></pre></div>\n<p>However, the test file for the <code>hashCommandLinter</code> now fails, since the linter never fires.</p>",
        "id": 457293451,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723103657
    },
    {
        "content": "<p><a href=\"#narrow/stream/287929-mathlib4/topic/New.20syntax.20for.20weak.20options/near/457293451\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/stream/287929-mathlib4/topic/Improper.20firing.20of.20linter.2Ehashcommand\">#mathlib4 &gt; Improper firing of linter.hashcommand</a> by <span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span>.</p>",
        "id": 457294040,
        "sender_full_name": "Notification Bot",
        "timestamp": 1723103824
    },
    {
        "content": "<p>The test files aren't affected by these options, I believe</p>",
        "id": 457300048,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723105354
    },
    {
        "content": "<p>I tried also in a <code>Mathlib</code> file importing the linter, but it still does not work...</p>",
        "id": 457307961,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723107254
    },
    {
        "content": "<p>And another thing that is suspicious about my setup is this</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>lake<span class=\"w\"> </span>build<span class=\"w\"> </span>-Dweak.linter.hashCommand\nerror:<span class=\"w\"> </span>unknown<span class=\"w\"> </span>short<span class=\"w\"> </span>option<span class=\"w\"> </span><span class=\"s1\">'-D'</span>\n</code></pre></div>",
        "id": 457309730,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723107674
    },
    {
        "content": "<p>(I have the updated to the current master before all these attempts, in case you are wondering.)</p>",
        "id": 457309862,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723107711
    },
    {
        "content": "<p>lake build does not take Lean options, that is correct. I assume the name of the option is <code>linter.hashCommand</code> and not <code>Mathlib.Linter.linter.hashCommand</code>?</p>",
        "id": 457318912,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723110268
    },
    {
        "content": "<p>I tried with both <code>linter.hashCommand</code> (the one that <code>set_option</code> accepts) and <code>Mathlib.Linter.linter.hashCommand</code> (the actual fully qualified name of the option).  I was not able to get either to work.</p>",
        "id": 457319430,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723110456
    },
    {
        "content": "<p>I think something changed around option qualified names recently; I was caught by this in a lean bump</p>",
        "id": 457319989,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723110609
    },
    {
        "content": "<p>It is quite confusing how <code>register_option linter.hashCommand</code> creates <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Mathlib.Linter.linter.hashCommand#doc\">docs#Mathlib.Linter.linter.hashCommand</a> (inside the active namespace), but the way to use it is <code>set_option linter.hashCommand</code> (without the namespacing)</p>",
        "id": 457320368,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723110714
    },
    {
        "content": "<p><code>register_option _root_.foo</code> is even more bizarre, which creates a <code>foo</code> declaration, but (I think) registers an option called <code>_root_.foo</code></p>",
        "id": 457321130,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723110927
    },
    {
        "content": "<p>In case you are wondering, this is my attempt: <a href=\"https://github.com/leanprover-community/mathlib4/pull/15609\">#15609</a>.</p>",
        "id": 457321854,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723111089
    },
    {
        "content": "<p>Oh, in CI the linter works, but locally it does not.</p>",
        "id": 457324070,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723111629
    },
    {
        "content": "<p>Oh. <code>weak</code> may not work in the server yet. Try setting the option without <code>weak</code> in serverArgs, which I believe ignores unknown options</p>",
        "id": 457327883,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723112330
    },
    {
        "content": "<p>I realize that I do not understand much, but trying</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">leanOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`pp.unicode.fun</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"c1\">-- pretty-prints `fun a ↦ b`</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`autoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`relaxedAutoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`Mathlib.Linter.linter.hashCommand</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.hashCommand</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n</code></pre></div>\n<p>does not actually work: as soon as I try to build a file, lean complains that the <code>hashCommand</code>s do not exist.  I tried both of them together and also each one of them separately, but nothing worked.</p>",
        "id": 457336475,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723114400
    },
    {
        "content": "<p>I could also find no <code>serverArgs</code>, so I probably am not doing the right attempt, though.</p>",
        "id": 457336528,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723114423
    },
    {
        "content": "<p>It's <code>moreServerOptions</code>. <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> I think the documentation is wrong here, <code>moreServerOptions</code> is not passed to <code>lean --server</code>.</p>",
        "id": 457359446,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1723121183
    },
    {
        "content": "<p>This works!!!</p>",
        "id": 457359993,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723121276
    },
    {
        "content": "<p>Using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">mathlib</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">leanOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`pp.unicode.fun</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"c1\">-- pretty-prints `fun a ↦ b`</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`autoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`relaxedAutoImplicit</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"c1\">-- These are additional settings which do not affect the lake hash,</span>\n<span class=\"w\">  </span><span class=\"c1\">-- so they can be enabled in CI and disabled locally or vice versa.</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Warning: Do not put any options here that actually change the olean files,</span>\n<span class=\"w\">  </span><span class=\"c1\">-- or inconsistent behavior may result</span>\n<span class=\"w\">  </span><span class=\"c1\">-- weakLeanArgs := #[]</span>\n<span class=\"w\">  </span><span class=\"n\">moreServerOptions</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"bp\">⟨</span><span class=\"ss\">`linter.hashCommand</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"o\">]</span>\n</code></pre></div>\n<p>with the linter default value set to <code>false</code>, the test file still gets flagged by the linter!</p>",
        "id": 457360443,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723121343
    },
    {
        "content": "<p>And just to be completely explicity, it is the name that gets used by <code>set_option</code> the one that is relevant here.  In the case above, it is <code>linter.hashCommand</code>, not the fully qualified name of the option (as in, just putting the fully qualified name does <em>not</em> make the linter active).</p>",
        "id": 457361632,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723121535
    },
    {
        "content": "<p>If an option is set in <code>moreServerOptions</code> but not in <code>leanOptions</code>, then the option is not active in CI: a file that is noisy locally passes CI in <a href=\"https://github.com/leanprover-community/mathlib4/pull/15609\">#15609</a>.</p>",
        "id": 457376975,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723125475
    }
]