[
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/28532\">#28532</a> (the first commit) I added one instance <code>NonUnitalCommSemiring.toNonUnitalNonAssocCommSemiring</code> and then the file Tactic/Ring/Basic <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/17013585891/job/48232826660?pr=28532\">breaks with four similar errors</a>, where the defeq</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">NonUnitalCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"n\">Ring</span><span class=\"bp\">.</span><span class=\"n\">toNonAssocRing</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span>\n</code></pre></div>\n<p>seemingly breaks. I'm not sure how the defeq was ensured before this new instance path was added.<br>\nWith the second commit of the PR, the error becomes</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">«$</span><span class=\"n\">sα</span><span class=\"bp\">».</span><span class=\"n\">toNonAssocCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">=</span>\n<span class=\"w\">  </span><span class=\"bp\">«$</span><span class=\"n\">rα</span><span class=\"bp\">».</span><span class=\"n\">toNonAssocRing</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span>\n</code></pre></div>\n<p>and sα and rα seem to be unrelated a priori.</p>",
        "id": 534790414,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755388311
    },
    {
        "content": "<p>maybe you need an <code>assume_instances_commute</code></p>",
        "id": 534790598,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755388673
    },
    {
        "content": "<p>Do you mean <code>assumeInstancesCommute</code>? Unfortunately I can't make it work.</p>",
        "id": 534790970,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755389115
    },
    {
        "content": "<p>I can take a look after I finish a proof</p>",
        "id": 534791172,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755389417
    },
    {
        "content": "<p>It's interesting that in <code>evalCast</code>, <code>assumeInstancesCommute</code> is only used in the branches that requires only CommSemiring, but not in the branches that requires Ring, Division(Semi)ring.</p>",
        "id": 534791556,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1755390171
    },
    {
        "content": "<p>I figured out a way to make <code>evalNegProd</code> work, can you do the rest on your own?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Negates a monomial `va` to get another monomial.</span>\n\n<span class=\"sd\">* `-c = (-c)` (for `c` coefficient)</span>\n<span class=\"sd\">* `-(a₁ * a₂) = a₁ * -a₂`</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">evalNegProd</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"o\">)}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">rα</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Ring</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">va</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ExProd</span><span class=\"w\"> </span><span class=\"n\">sα</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ExProd</span><span class=\"w\"> </span><span class=\"n\">sα</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">-$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">checkSystem</span><span class=\"w\"> </span><span class=\"n\">decl_name</span><span class=\"bp\">%.</span><span class=\"n\">toString</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">va</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">za</span><span class=\"w\"> </span><span class=\"n\">ha</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkRawNatLit</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">m1</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ExProd</span><span class=\"bp\">.</span><span class=\"n\">mkNegNat</span><span class=\"w\"> </span><span class=\"n\">sα</span><span class=\"w\"> </span><span class=\"n\">rα</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">isNegNat</span><span class=\"w\"> </span><span class=\"n\">rα</span><span class=\"w\"> </span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">IsInt</span><span class=\"bp\">.</span><span class=\"n\">of_raw</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">negOfNat</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">lit</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ra</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Result</span><span class=\"bp\">.</span><span class=\"n\">ofRawRat</span><span class=\"w\"> </span><span class=\"n\">za</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">ha</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rb</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">NormNum</span><span class=\"bp\">.</span><span class=\"n\">evalMul</span><span class=\"bp\">.</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">m1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">HMul</span><span class=\"bp\">.</span><span class=\"n\">hMul</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">      </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">CommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toSemiring</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">rm</span><span class=\"w\"> </span><span class=\"n\">ra</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">zb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">hb</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rb</span><span class=\"bp\">.</span><span class=\"n\">toRatNZ</span><span class=\"bp\">.</span><span class=\"n\">get!</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">pb</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">((</span><span class=\"n\">Int</span><span class=\"bp\">.</span><span class=\"n\">negOfNat</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">nat_lit</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">rawCast</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rb</span><span class=\"bp\">.</span><span class=\"n\">toRawEq</span>\n<span class=\"w\">    </span><span class=\"c1\">-- TODO: why does `assumeInstancesCommute` not work here</span>\n<span class=\"w\">    </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">rα</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toNonAssocRing</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"n\">Q</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">sα</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toNonAssocCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocCommSemiring</span><span class=\"bp\">.</span><span class=\"n\">toNonUnitalNonAssocSemiring</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨⟩</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">b</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">zb</span><span class=\"w\"> </span><span class=\"n\">hb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">neg_one_mul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"bp\">▸</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">pb</span><span class=\"o\">))</span><span class=\"bp\">⟩</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a₁</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">va₁</span><span class=\"w\"> </span><span class=\"n\">va₂</span><span class=\"w\"> </span><span class=\"n\">va₃</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">vb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">pb</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">evalNegProd</span><span class=\"w\"> </span><span class=\"n\">rα</span><span class=\"w\"> </span><span class=\"n\">va₃</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">⟨_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"n\">va₁</span><span class=\"w\"> </span><span class=\"n\">va₂</span><span class=\"w\"> </span><span class=\"n\">vb</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">neg_mul</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a₁</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a₂</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">pb</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"bp\">⟩</span>\n</code></pre></div>",
        "id": 534796659,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1755398751
    },
    {
        "content": "<p>I think <code>assumeInstancesCommute</code> isn't very good at dealing with diamond inheritance</p>",
        "id": 534810570,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755420101
    },
    {
        "content": "<p>But ultimately all it does is add the line you added.</p>",
        "id": 534810690,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1755420293
    }
]