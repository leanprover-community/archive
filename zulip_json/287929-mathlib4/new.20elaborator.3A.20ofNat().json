[
    {
        "content": "<p>Just a heads up about:</p>\n<p><span class=\"user-mention silent\" data-user-id=\"112165\">rss-bot</span> <a href=\"#narrow/channel/116290-rss/topic/Recent.20Commits.20to.20mathlib4.3Amaster/near/491531447\">said</a>:</p>\n<blockquote>\n<p><strong><a href=\"https://github.com/leanprover-community/mathlib4/commit/9232fbe19e65abd4066b2a06f038f9082d19eec1\">refactor: add an ofNat() elaborator</a></strong> (<a href=\"https://github.com/leanprover-community/mathlib4/pull/20169\">mathlib4#20169</a>)</p>\n<p><code>ofNat(n)</code> is a shorthand for <code>no_index (OfNat.ofNat n)</code>.</p>\n</blockquote>\n<p>(click through for the full commit message)</p>\n<p>There are still stray <code>OfNat.ofNat</code>s left in mathlib, but we should try to use <code>ofNat()</code> in any new work.</p>",
        "id": 491532048,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735769089
    },
    {
        "content": "<p>If anyone fancies writing a linter to detect these and including them in our tech debt stats, that would be great!</p>",
        "id": 491532060,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735769105
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"459227\">@Violeta Hern√°ndez</span>, there are 27 matches for <code>See note [no_index around OfNat.ofNat]</code> in <code>SetTheory</code>; next time you put your tidying hat on, could you perhaps look at switching these to use <code>ofNat()</code> instead?</p>",
        "id": 491534262,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735771407
    },
    {
        "content": "<p>Sure! I've been on somewhat of a vacation but I'll keep that in mind</p>",
        "id": 491579864,
        "sender_full_name": "Violeta Hern√°ndez",
        "timestamp": 1735808013
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> Is this the counter you had in mind? Or something more subtle</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>rg<span class=\"w\"> </span><span class=\"s2\">\"OfNat.ofNat\"</span><span class=\"w\"> </span>Mathlib<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>wc<span class=\"w\"> </span>-l\n<span class=\"go\">403</span>\n</code></pre></div>\n<p>Because this one would be trivial to add to the tech debt stats.</p>",
        "id": 491581277,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735808786
    },
    {
        "content": "<p>I think that might be too aggressive; as a conservative option we could start by counting the library note</p>",
        "id": 491585053,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735810857
    },
    {
        "content": "<p>So</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span>rg<span class=\"w\"> </span><span class=\"s2\">\"See note.*OfNat.ofNat\"</span><span class=\"w\"> </span>Mathlib<span class=\"w\"> </span><span class=\"p\">|</span><span class=\"w\"> </span>wc<span class=\"w\"> </span>-l\n<span class=\"go\">97</span>\n</code></pre></div>",
        "id": 491590839,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735814077
    },
    {
        "content": "<p>Is that the same as the result for <code>\"See note \\[no_index around OfNat.ofNat\\]\"</code>? Would your regex match <code>See note&lt;100 lines follow&gt;OfNat</code>, or does <code>rg</code> operate on a per-line basis?</p>",
        "id": 491593473,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735815495
    },
    {
        "content": "<p>It is per line</p>",
        "id": 491595105,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735816373
    },
    {
        "content": "<p>The number is indeed the same if we match on the exact string.</p>",
        "id": 491595151,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735816406
    },
    {
        "content": "<p><del>btw, does that mean we also have to update the library note itself? currently (i.e. on latest mathlib on the playground) the note reads as follows:</del></p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>library_note \"no_index around OfNat.ofNat\"\n* When writing lemmas about `OfNat.ofNat` that assume `Nat.AtLeastTwo`, the term needs to be wrapped\n  in `no_index` so as not to confuse `simp`, as `no_index (OfNat.ofNat n)`.\n\n  Rather than referencing this library note, use `ofNat(n)` as a shorthand for\n  `no_index (OfNat.ofNat n)`.\n\n  Some discussion is [on Zulip here](https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20Polynomial.2Ecoeff.20example/near/395438147).\n</code></pre></div>",
        "id": 491596364,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735817045
    },
    {
        "content": "<p>What are you proposing? The purpose of the library note is:</p>\n<ul>\n<li>To explain the existing uses of <code>no_index (OfNat.ofNat</code> in the library</li>\n<li>To tell you not to write more code in this way, and use <code>ofNat(</code> instead</li>\n</ul>",
        "id": 491596522,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735817152
    },
    {
        "content": "<p>it seems i can't read <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span></p>",
        "id": 491596631,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735817195
    },
    {
        "content": "<p>indeed, the library note does explain that the shorthand should be used</p>",
        "id": 491596739,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735817254
    },
    {
        "content": "<p>Of course, really we want to delete the library note entirely, but we have to clear up the 52 (non-SetTheory in 19 files) + 27 (SetTheory in 7 files) references to it first</p>",
        "id": 491597424,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735817611
    },
    {
        "content": "<p>still, a library note as to what the <em>purpose</em> of <code>ofNat()</code> is and what the distinction is between it and <code>OfNat.ofNat</code> might be useful?</p>",
        "id": 491597602,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735817709
    },
    {
        "content": "<p>Isn't that role served by the docstring of <code>ofNat()</code>?</p>",
        "id": 491597643,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735817739
    },
    {
        "content": "<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> i think you're right</p>",
        "id": 491598009,
        "sender_full_name": "Edward van de Meent",
        "timestamp": 1735817938
    },
    {
        "content": "<p>Feel free to improve the wording there if it is unclear, but I'm pretty sure that's the right place for an explanation to be</p>",
        "id": 491598243,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1735818072
    },
    {
        "content": "<p>The problem with having the info in the docstring of <code>ofNat()</code> is that one has to know about<code>ofNat()</code> to find it. It would perhaps be good to have some info in the docstring of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=OfNat.ofNat#doc\">docs#OfNat.ofNat</a> itself, but IIRC it is not (yet?) possible to extend docstrings in a later file. (<code>OfNat.ofNat</code> is in <code>Init.Prelude</code>...)</p>",
        "id": 491599485,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1735818824
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310045\">@Eric Wieser</span> <a href=\"https://github.com/leanprover-community/mathlib4/pull/20394\">#20394</a> adds the tech debt metric</p>",
        "id": 491601522,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1735819988
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/20521\">#20521</a> replaces all occurrences of <code>no_index (ofNat _)</code> that <code>grep</code> could find with the new <code>ofNat()</code> macro.</p>",
        "id": 492136452,
        "sender_full_name": "Anne Baanen",
        "timestamp": 1736180454
    },
    {
        "content": "<p>A spinoff from this discussion: <a class=\"message-link\" href=\"/#narrow/channel/270676-lean4/topic/Writing.20theorems.20about.20ofNat/near/494695504\">#lean4 &gt; Writing theorems about ofNat @ üí¨</a></p>",
        "id": 494696256,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737332934
    },
    {
        "content": "<p>I remember saying in review at one point that I was uncomfortable with <code>ofNat(n + 1)</code>, this provides some justification for that hunch.</p>",
        "id": 494696289,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737332968
    },
    {
        "content": "<p>Could that become a parse error? So that <code>ofNat(x)</code> only parses when <code>x</code> is a variable name?</p>",
        "id": 494785171,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1737372497
    },
    {
        "content": "<p>Yes, certainly; but if we do that we should probably remove <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Real.Gamma_ofNat_eq_factorial#doc\">docs#Real.Gamma_ofNat_eq_factorial</a> which breaks the rule</p>",
        "id": 494787807,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737373238
    },
    {
        "content": "<p>I think there are quite a few places where we want to apply a theorem with a literal like <code>37</code> on one side and get <code>36</code> on the other though, so it would be nice to have a mechanism to do this that doesn't require a <code>simproc</code> each time</p>",
        "id": 494787980,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737373297
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/287929-mathlib4/topic/new.20elaborator.3A.20ofNat.28.29/near/494787807\">said</a>:</p>\n<blockquote>\n<p>Yes, certainly; but if we do that we should probably remove <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Real.Gamma_ofNat_eq_factorial#doc\">docs#Real.Gamma_ofNat_eq_factorial</a> which breaks the rule</p>\n</blockquote>\n<p>Glancing at this now is shouldn't we replace the horrid <code>[(n + 1).AtLeastTwo]</code> with <code>[NeZero n]</code>?</p>",
        "id": 494917942,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1737409211
    },
    {
        "content": "<p>I guess we might need to add:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">‚Ñï</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">NeZero</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">AtLeastTwo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">‚ü®</span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">NeZero</span><span class=\"bp\">.</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">omega</span><span class=\"bp\">‚ü©</span>\n</code></pre></div>",
        "id": 494917972,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1737409227
    },
    {
        "content": "<p>I think the <code>ofNat</code> is the bigger concern in that lemma statement</p>",
        "id": 494921267,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737410796
    },
    {
        "content": "<p>Yes absolutely, I was just noting this in passing.</p>",
        "id": 494921551,
        "sender_full_name": "Oliver Nash",
        "timestamp": 1737410952
    },
    {
        "content": "<p>I would extend my claim to (almost) every occurence of <code>(n + 1).AtLeastTwo</code> being also guilty of this ofNat gray area!</p>",
        "id": 494924944,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1737412493
    }
]