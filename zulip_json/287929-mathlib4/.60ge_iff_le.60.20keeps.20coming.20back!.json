[
    {
        "content": "<p>I continue to get cases where <code>simp?</code> tells me that <code>ge_iff_le</code> was used, even when there's no <code>≥</code> seemingly present in the goal. <br>\ncf previous discussion <a class=\"stream-topic\" data-stream-id=\"287929\" href=\"/#narrow/channel/287929-mathlib4/topic/simp.3F.20giving.20nonsense.20lemmas\">#mathlib4 &gt; simp? giving nonsense lemmas</a> , and previous (now closed) issue <a href=\"https://github.com/leanprover/lean4/pull/4534\">lean4#4534</a> with the fix <a href=\"https://github.com/leanprover/lean4/pull/4567\">lean4#4567</a>. <br>\nUnfortunately, despite those discussions and the attempted fix, I'm still running into this not infrequently. However, the cases it shows up now are weirdly difficult to minimise, for me at least. Here's the example I hit today:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">SetTheory</span><span class=\"bp\">.</span><span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↪</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Cardinal</span><span class=\"bp\">.</span><span class=\"n\">lift_mk_le'</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp?</span>\n</code></pre></div>\n<p>The <code>simp?</code> here includes <code>ge_iff_le</code>, and I don't understand why. Trying to extract the goal after the <code>rw</code> gives me a situation in which the <code>simp?</code> wouldn't include <code>ge_iff_le</code>, so the first obvious attempt to minimise doesn't appear to work. What's going on here?</p>",
        "id": 496178709,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1737999549
    },
    {
        "content": "<p>not exactly sure, but looks like trying to apply <code>ge_iff_le</code> as a simp lemma does something to the universe, <code>max 1 (u_1 + 1)</code> to <code>u_1 + 1</code>. Maybe that's one explanation why <code>simp</code> thinks the lemma was applies successfully?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.SetTheory.Cardinal.Basic</span>\n\n<span class=\"kd\">set_option</span><span class=\"w\"> </span><span class=\"n\">pp.all</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">in</span>\n\n<span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">Cardinal.mk</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">Nonempty</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Fin</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↪</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Cardinal.lift_mk_le'</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">simp_rw</span><span class=\"w\"> </span><span class=\"o\">[</span>\n<span class=\"w\">    </span><span class=\"n\">Cardinal.mk_fintype</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">Fintype.card_fin</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">Cardinal.lift_natCast</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">Cardinal.lift_uzero</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"c\">/-</span>\n<span class=\"cm\">    @LE.le.{max 1 (u_1 + 1)}</span>\n<span class=\"cm\">      Cardinal.{u_1} Cardinal.instLE.{u_1}</span>\n<span class=\"cm\">      (@Nat.cast.{max (u_1 + 1) 1} Cardinal.{u_1}</span>\n<span class=\"cm\">      Cardinal.instNatCast.{u_1} n) (Cardinal.mk.{u_1} α)</span>\n<span class=\"cm\">    -/</span>\n<span class=\"w\">    </span><span class=\"n\">ge_iff_le</span>\n<span class=\"w\">    </span><span class=\"c\">/-</span>\n<span class=\"cm\">    @LE.le.{u_1 + 1}</span>\n<span class=\"cm\">      Cardinal.{u_1} Cardinal.instLE.{u_1}</span>\n<span class=\"cm\">      (@Nat.cast.{max (u_1 + 1) 1} Cardinal.{u_1}</span>\n<span class=\"cm\">        Cardinal.instNatCast.{u_1} n) (Cardinal.mk.{u_1} α)</span>\n<span class=\"cm\">    -/</span>\n<span class=\"w\">    </span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">assumption</span>\n</code></pre></div>",
        "id": 496301765,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1738059947
    },
    {
        "content": "<p>I would be happy to conjecture that re-elaborating a term could cause a change in universe variables of this nature which might explain why it's difficult to minimise</p>",
        "id": 496302312,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1738060116
    },
    {
        "content": "<p>Is <a href=\"#narrow/channel/270676-lean4/topic/Apply.20failing.20to.20infer.20a.20function.20for.20~Finset.2Ele_sup/near/496204848\">this comment</a> related?</p>",
        "id": 496302694,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1738060226
    },
    {
        "content": "<p>I just hit that issue again, in a much simpler situation involving no universe at all when using <code>simp_all?</code>. I am reporting here for people searching for this issue. I <em>think</em> the issue is that <code>simp_all?</code> reports simplifications made to <em>all</em> assumptions, including the assumptions that are not used in the final proof. So if you have any assumption involving <code>≥</code> or <code>&gt;</code> in your context, <code>simp_all?</code> will always report those lemmas. <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> do you think it would be easy to filter those out?</p>",
        "id": 500648349,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1739971182
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≥</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp_all?</span><span class=\"w\"> </span><span class=\"c1\">-- Try this: simp_all only [ge_iff_le]</span>\n</code></pre></div>",
        "id": 500648689,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1739971278
    },
    {
        "content": "<p>Removing the assumption <code>h</code> leads to <code>Try this: simp_all only</code>.</p>",
        "id": 500648827,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1739971319
    },
    {
        "content": "<p>But <code>simp_all</code> is <em>meant</em> to simplify hypotheses, so surely it should report the lemmas it uses to do so?</p>",
        "id": 500776822,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740015600
    },
    {
        "content": "<p>I guess here you are thinking of <code>simp_all</code> as only a terminal tactic, so you don't care about changes to hypotheses.</p>",
        "id": 500776957,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1740015685
    },
    {
        "content": "<p>Sure, is there any context where <code>simp_all</code> in not used as a finishing tactic??</p>",
        "id": 500823597,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1740041168
    },
    {
        "content": "<p><a href=\"https://github.com/search?q=repo%3Aleanprover-community%2Fmathlib4+%22simp_all+only%22&amp;type=code\">https://github.com/search?q=repo%3Aleanprover-community%2Fmathlib4+%22simp_all+only%22&amp;type=code</a> finds a few uses</p>",
        "id": 500895422,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1740062335
    }
]