[
    {
        "content": "<p>I'm struggling to make Lean compute <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.primeFactors#doc\">docs#Nat.primeFactors</a> , even for small integers.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">primeFactors</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I can rewrite to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.primeFactorsList#doc\">docs#Nat.primeFactorsList</a>, and have it apply the induction hypothesis step by step, but this is a bit painful, even for <code>6</code>.</p>",
        "id": 522649674,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749148471
    },
    {
        "content": "<p>Thinking about <code>repeat</code> suggested this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Factors</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">primeFactorsList</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">    </span><span class=\"n\">repeat</span>\n<span class=\"w\">      </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">primeFactorsList</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">_</span>\n<span class=\"w\">      </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">primeFactorsList</span><span class=\"o\">]</span>\n<span class=\"w\">      </span><span class=\"n\">norm_num</span>\n</code></pre></div>\n<p>Is it the right way to do?</p>",
        "id": 522651096,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749148984
    },
    {
        "content": "<p>Probably not — What if I don't want to compute myself the right hand side ?</p>",
        "id": 522651164,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749149008
    },
    {
        "content": "<p>I think this is an instance of <a class=\"stream-topic\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4/topic/opaque.20recursion.20definitions.20break.20mergeSort.20decidability/with/511848356\">#lean4 &gt; opaque recursion definitions break mergeSort decidability</a></p>",
        "id": 522652210,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1749149434
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15420\">#15420</a></p>",
        "id": 522653734,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749150155
    },
    {
        "content": "<p>Cool! (I had started writing a fueled version of Nat.primeFactors…)</p>",
        "id": 522669073,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749157360
    },
    {
        "content": "<p>That is probably still a good idea</p>",
        "id": 522669280,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749157473
    },
    {
        "content": "<p>If you do that the simproc can become a dsimproc</p>",
        "id": 522669328,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749157494
    },
    {
        "content": "<p>Is it important that the <code>fuel</code> variable is initialized to something reasonable?<br>\nFinding all prime factors of <code>n</code> requires <code>Nat.clog 2 n</code> steps; I I have two versions, one that proves that it goes in that much steps, and another one where I initialize <code>fuel</code> as <code>n</code>.<br>\nBut the first version doesn't work as <code>rfl</code>, while the second does…</p>",
        "id": 522677908,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749162637
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">primeFactorsList2_aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">le_of_lt_succ</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">div_lt_iff_lt_mul</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">lt_of_le_of_lt</span><span class=\"w\"> </span><span class=\"n\">hn</span>\n<span class=\"w\">  </span><span class=\"n\">change</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_mul_iff_one_lt_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">hm</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_succ</span><span class=\"w\"> </span><span class=\"n\">fuel</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_of_lt</span><span class=\"w\"> </span><span class=\"n\">hm</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">primeFactorsList3</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hfuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">minFac</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">            </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"bp\">.</span><span class=\"n\">two_le</span>\n<span class=\"w\">            </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">m</span><span class=\"o\">]</span>\n<span class=\"w\">            </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">minFac_prime</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">            </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">not_or</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">            </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hn</span>\n<span class=\"w\">            </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">            </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hn</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">primeFactorsList2_aux</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hfuel</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hm</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">le_refl</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">primeFactorsList4_aux</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">¬</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hn</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">le_of_lt_succ</span>\n<span class=\"w\">  </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">div_lt_iff_lt_mul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_lt_of_lt</span><span class=\"w\"> </span><span class=\"n\">hm</span><span class=\"o\">)]</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">lt_of_le_of_lt</span><span class=\"w\"> </span><span class=\"n\">hn</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">lt_of_lt_of_le</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ_eq_add_one</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add_mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">one_mul</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">pow_succ</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">lt_succ_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">le_add_right</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul_le_mul_left</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">hm</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">primeFactorsList4</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hfuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">      </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">minFac</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">        </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">hm</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">          </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">Prime</span><span class=\"bp\">.</span><span class=\"n\">two_le</span>\n<span class=\"w\">          </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">m</span><span class=\"o\">]</span>\n<span class=\"w\">          </span><span class=\"n\">refine</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">minFac_prime</span><span class=\"w\"> </span><span class=\"bp\">?_</span>\n<span class=\"w\">          </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">not_or</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">hk</span>\n<span class=\"w\">          </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">hn</span>\n<span class=\"w\">          </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"w\">          </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">hn</span><span class=\"o\">]</span>\n<span class=\"w\">        </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">primeFactorsList4_aux</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">hk</span><span class=\"w\"> </span><span class=\"n\">hfuel</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">hm</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">clog</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">le_pow_clog</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">one_lt_two</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span>\n\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">primeFactorsList3</span><span class=\"w\"> </span><span class=\"mi\">105</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">primeFactorsList4</span><span class=\"w\"> </span><span class=\"mi\">105</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\"> </span><span class=\"c1\">-- doesn't work</span>\n</code></pre></div>",
        "id": 522678037,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749162712
    },
    {
        "content": "<p>I think the problem is that <code>clog  2 n</code> is itself missing a fuel argument?</p>",
        "id": 522678125,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749162776
    },
    {
        "content": "<p>(Note that I do not understand the what in this way of writing a proof mkes this work.)</p>",
        "id": 522678231,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749162851
    },
    {
        "content": "<p>Indeed, <code>example : Nat.clog 2 37 = (eval% Nat.clog 2 37) := rfl</code> fails</p>",
        "id": 522678285,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749162898
    },
    {
        "content": "<p>OK, so I have to <code>fuel</code> <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.clog#doc\">docs#Nat.clog</a> as well. This makes sense.</p>",
        "id": 522678331,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749162928
    },
    {
        "content": "<p>I think you want your fuel argument to be as simple as possible, because how this method works is by reducing <code>fuel</code> to applications of <code>succ</code></p>",
        "id": 522678332,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749162928
    },
    {
        "content": "<p>So we should fuel clog, but I doubt you want to use it in prime factors</p>",
        "id": 522678357,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749162950
    },
    {
        "content": "<p>Hence the first version will be the right one.</p>",
        "id": 522678392,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749162979
    },
    {
        "content": "<p>I expect so, but perhaps the right approach is:</p>\n<ul>\n<li>Fuel <code>clog</code></li>\n<li>Benchmark both versions, to see which is faster</li>\n</ul>",
        "id": 522678418,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749163007
    },
    {
        "content": "<p>OK, I'll do that. (This is fun.)</p>",
        "id": 522678482,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749163056
    },
    {
        "content": "<p>How do you benchmark something?<br>\nI tested both versions with big numbers, and crashed Lean.</p>",
        "id": 522678512,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749163075
    },
    {
        "content": "<p><code>set_option trace.profiler true in</code> is a reasonable way</p>",
        "id": 522678567,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749163108
    },
    {
        "content": "<p>Pick numbers small enough not to crash, but big enough to take more than a second</p>",
        "id": 522678579,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749163119
    },
    {
        "content": "<p>I wonder whether <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.minFac#doc\">docs#Nat.minFac</a> shouldn't be fueled as well. (I get fast results with <code>#eval</code> but Lean pretends the recursion is too high — there are less than 5 prime number.)</p>",
        "id": 522680631,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749164585
    },
    {
        "content": "<p>The change here would be to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.minFacAux#doc\">docs#Nat.minFacAux</a>, which is the one containing the recursion. The intention is, as the docstring there describes, for <code>norm_num</code> or related to be the one computing this during proves. But (as I guess you're encountering just like I have), that's not always enough when the rest of a computation works by <code>decide</code></p>",
        "id": 522681643,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1749165313
    },
    {
        "content": "<p>As an aside, Nat.sqrt is also something I'd marked semireducible for the same reason, and that one should also be fueled</p>",
        "id": 522681692,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1749165346
    },
    {
        "content": "<p>One thing to check here is that the weight of the extra fuel doesn't slow down <code>#eval</code></p>",
        "id": 522681697,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749165351
    },
    {
        "content": "<p>If it does, then there is some extra work of writing a <code>csimp</code> lemma and keeping both versions</p>",
        "id": 522681713,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749165364
    },
    {
        "content": "<p>I have a question about the docstring for <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.logC#doc\">docs#Nat.logC</a> which says</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">An</span><span class=\"w\"> </span><span class=\"n\">alternate</span><span class=\"w\"> </span><span class=\"n\">definition</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">computes</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"w\"> </span><span class=\"n\">efficiently</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">For</span><span class=\"w\"> </span><span class=\"n\">mathematical</span><span class=\"w\"> </span><span class=\"n\">purposes</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">use</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">log</span><span class=\"w\"> </span><span class=\"n\">instead</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">log_eq_logC</span><span class=\"bp\">.</span>\n</code></pre></div>\n<p>Given function extensionality, I don't understand what is really meant here. Maybe, that it is <em>easier</em> to prove a mathematical lemma using the inductive definition of  <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.log#doc\">docs#Nat.log</a> than that of <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.logC#doc\">docs#Nat.logC</a>.</p>",
        "id": 522877926,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749279101
    },
    {
        "content": "<p>I think that's indeed the purpose of that comment. Some definitions are good for proofs, others are good for computations.</p>",
        "id": 522877967,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749279154
    },
    {
        "content": "<p>i've made a preliminary fueled definition to replace <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.clog#doc\">docs#Nat.clog</a>, which takes roughly the same time as the computation using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Nat.logC#doc\">docs#Nat.logC</a>.<br>\nHowever, for large numbers, one needs to increase <code>maxRecDepth</code> to allow <code>rfl</code>  to prove the desired equality:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"mi\">900</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">clog_fueled</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">123456789012345667890123456789012345667890123456789012345667890123456789012345667890</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">277</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">rfl</span>\n</code></pre></div>\n<p>This is roughly three times the size of the output, as if the tests that the iteration must perform were only done at the end. I had tried to make my recursion as much terminal as possible, but that is apparently not enough. Any idea?</p>",
        "id": 522879212,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749280720
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"130609\">@Antoine Chambert-Loir</span> Is your fueled version on a branch somewhere, so that others can play with it?</p>",
        "id": 522879332,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749280938
    },
    {
        "content": "<p>For the moment, it's just a plain file with iterative attempts. I'll make that at once. Should I put this in <code>Mathlib.Data.Nat.Log</code> or open a new file?</p>",
        "id": 522879385,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749281007
    },
    {
        "content": "<p>New file seems fine for experiments. We can merge it into the existing files later.</p>",
        "id": 522879425,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749281064
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/25557\">#25557</a><br>\n<a href=\"https://github.com/leanprover-community/mathlib4/tree/ACL%2Ffuel_clog\">branch#ACL/fuel_clog</a></p>",
        "id": 522879836,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749281751
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"130609\">@Antoine Chambert-Loir</span> What do you think of</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">clog'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">∧</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">fuel</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">clog'</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"mi\">37</span><span class=\"w\"> </span><span class=\"c1\">-- 6</span>\n</code></pre></div>",
        "id": 522880983,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749283590
    },
    {
        "content": "<p>This was basically my first attempt. For large numbers, <code>rfl</code> doesn't work, it requires <code>maxRecDepth</code> to be roughly 10 times the size of the output.</p>",
        "id": 522881193,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749283833
    },
    {
        "content": "<p>This is why I rewrote is using an accumulator (to avoid the final <code>+ 1</code>).</p>",
        "id": 522881211,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749283869
    },
    {
        "content": "<p>I guess in the meta world it will be easy to make this much faster, because then we have access to the binary representation of <code>n</code>.</p>",
        "id": 522881847,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749284782
    },
    {
        "content": "<p>I just noticed something bizarre: with my version, #reduce requires the same recursion depth as yours, but proving equality (<code>example : ... = ... := rfl</code>) requires less.</p>",
        "id": 522882017,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749285010
    },
    {
        "content": "<p>This is the best version I could come up with in terms of keeping the recursion depth to <code>clog n + O(1)</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">clog_fueled</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">ble</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">succ</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"kn\">set_option</span><span class=\"w\"> </span><span class=\"n\">maxRecDepth</span><span class=\"w\"> </span><span class=\"mi\">286</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"bp\">#</span><span class=\"n\">reduce</span><span class=\"w\"> </span><span class=\"n\">clog_fueled</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"mi\">123456789012345667890123456789012345667890123456789012345667890123456789012345667890</span>\n</code></pre></div>",
        "id": 522894476,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301229
    },
    {
        "content": "<p>note that this is not the kernel checker doing the reduction though</p>",
        "id": 522894513,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301286
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"130609\">Antoine Chambert-Loir</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Compute.20Nat.2EprimeFactors/near/522882017\">said</a>:</p>\n<blockquote>\n<p>I just noticed something bizarre: with my version, #reduce requires the same recursion depth as yours, but proving equality (<code>example : ... = ... := rfl</code>) requires less.</p>\n</blockquote>\n<p>I would guess that <code>reduce</code> always expends all the fuel, whereas <code>rfl</code> can stop sooner?</p>",
        "id": 522894667,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749301502
    },
    {
        "content": "<p>no, the recursion depth is absurdly low, I think it's either somehow tail recursive or the recursion isn't being tracked</p>",
        "id": 522894716,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301559
    },
    {
        "content": "<p>kernel evaluation here is weird, I don't think there is a way to avoid proper recursion</p>",
        "id": 522894749,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301596
    },
    {
        "content": "<p>Does swapping the <code>rec</code> for a match cause trouble?</p>",
        "id": 522894777,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749301633
    },
    {
        "content": "<p>for the bool or the nat?</p>",
        "id": 522894788,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301649
    },
    {
        "content": "<p>The nat</p>",
        "id": 522894808,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749301674
    },
    {
        "content": "<p>for the nat it's a disaster, it triggers equation compilation and you get a brecOn and a bunch of cruft</p>",
        "id": 522894809,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301676
    },
    {
        "content": "<p>even with <code>termination_by structural</code>?</p>",
        "id": 522894828,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749301711
    },
    {
        "content": "<p>that <em>is</em> structural recursion as lean understands it</p>",
        "id": 522894836,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301727
    },
    {
        "content": "<p>oh</p>",
        "id": 522894852,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1749301744
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Compute.20Nat.2EprimeFactors/near/522894667\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"130609\">Antoine Chambert-Loir</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Compute.20Nat.2EprimeFactors/near/522882017\">said</a>:</p>\n<blockquote>\n<p>I just noticed something bizarre: with my version, #reduce requires the same recursion depth as yours, but proving equality (<code>example : ... = ... := rfl</code>) requires less.</p>\n</blockquote>\n<p>I would guess that <code>reduce</code> always expends all the fuel, whereas <code>rfl</code> can stop sooner?</p>\n</blockquote>\n<p>note that if you actually expended all the fuel it would not terminate in your lifetime</p>",
        "id": 522894985,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301897
    },
    {
        "content": "<p>since the fuel is ~2^277</p>",
        "id": 522895010,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749301917
    },
    {
        "content": "<p>True, but you know a priori that you don't need that much fuel, just the log of it.</p>",
        "id": 522902712,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749310794
    },
    {
        "content": "<p>I was thinking about that, but unfortunately it's not easy to exploit that, since you... need to compute the log in order to use that as the fuel instead</p>",
        "id": 522908518,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749317600
    },
    {
        "content": "<p>it is a bit of a shame that the computation involves constructing the numbers <code>123...7890</code>, <code>123...7889</code>, <code>123...7888</code> and so on down to n-277 since these numbers are pointlessly big. If it was a megabytes large number this would be quite expensive when actually computing the base 2 log of the number would be trivial on a normal computational system</p>",
        "id": 522908657,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749317763
    },
    {
        "content": "<p>and even computing the general base log of a huge number can slice the number down very quickly, resulting in a constant factor overhead over the input storage</p>",
        "id": 522908764,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749317881
    },
    {
        "content": "<p>But don't we have the binary representation of the number at hand, whenever we actually want to do this computation?</p>",
        "id": 522909037,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1749318198
    },
    {
        "content": "<p>yes? I'm assuming the number is being represented in binary here</p>",
        "id": 522910619,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749320145
    },
    {
        "content": "<p>that's why log2 in particular is completely trivial even if the number is gigabytes large</p>",
        "id": 522910647,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1749320177
    },
    {
        "content": "<p>Indeed, that's almost a shame to have to make these computations to get the number of binary digits. Couldn't it be more directly accessible ?</p>",
        "id": 522916641,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1749327671
    },
    {
        "content": "<p>There is apparently no GMP function for logarithm: <a href=\"https://stackoverflow.com/questions/11432436/is-there-any-gmp-logarithm-function\">https://stackoverflow.com/questions/11432436/is-there-any-gmp-logarithm-function</a><br>\nHowever, <code>mpz_gcdext</code> <a href=\"https://gmplib.org/manual/Number-Theoretic-Functions\">here</a> could potentially be used as implementation of <a href=\"https://leanprover-community.github.io/mathlib4_docs/Mathlib/Data/Int/GCD.html#Nat.xgcd\">Nat.xgcd</a>. We already have <code>extern</code> attributes on <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Nat/Gcd.html#Nat.gcd\">Nat.gcd</a> and <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Nat/Log2.html#Nat.log2\">Nat.log2</a>. (These are used for kernel reduction, right?)</p>",
        "id": 573876230,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1771056656
    }
]