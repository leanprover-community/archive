[
    {
        "content": "<h2>My motivation</h2>\n<ul>\n<li>I develop <a href=\"http://\">lean-by-example</a> repository</li>\n<li>I use Lean lib <a href=\"https://github.com/Seasawher/mk-exercise\">mk-exercise</a> in lean-by-example</li>\n<li>It takes around 600 ms in my environment to run the <code>lake exe mk_exercise</code>.  Running <code>mk_exercise.exe</code> in the <code>.lake</code> directory will finish in a few milliseconds. running <code>mk_exercise.exe</code> is by far the quickest.</li>\n<li>I think this is because when we run <code>lake exe mk_exercise</code>, the compilation is performed.</li>\n</ul>",
        "id": 466734328,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725210160
    },
    {
        "content": "<h2>My Question</h2>\n<p>How can we skip compilation?<br>\nIs there a variant of the <code>lake exe</code> command that will not compile if there is a binary in the <code>.lake</code> directory?</p>",
        "id": 466734666,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725210311
    },
    {
        "content": "<p>impossible?</p>",
        "id": 466944906,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725281809
    },
    {
        "content": "<p><code>lake exe</code> is supposed to execute the binary that is yielded by compiling the <code>lean_exe</code> target that it is followed by, what would you expect to happen?</p>",
        "id": 466947219,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725282252
    },
    {
        "content": "<p>If you have already compiled the executable fully and your thing is still taking long that is probably the overhead from <code>lake</code> itself launching, <code>lake</code> won't do any unnecessary work.</p>",
        "id": 466947583,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725282318
    },
    {
        "content": "<p>And if you have not compiled your executable with the latest version of your source files then <code>lake exe</code> compiling the executable for you is also the correct behavior given that you probably want the up to date executable</p>",
        "id": 466948208,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725282422
    },
    {
        "content": "<p>I tried <code>lake upload</code>, but running time of <code>lake run ...</code> is still slow...</p>",
        "id": 466948417,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725282466
    },
    {
        "content": "<blockquote>\n<p><code>lake exe</code> is supposed to execute the binary that is yielded by compiling the <code>lean_exe</code> target that it is followed by</p>\n</blockquote>\n<p>Thank you!</p>",
        "id": 466949234,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725282653
    },
    {
        "content": "<blockquote>\n<p>that is probably the overhead from <code>lake</code> itself launching,</p>\n</blockquote>\n<p>If so, the overhead of Lake seems to be very large...</p>",
        "id": 466949423,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725282701
    },
    {
        "content": "<p>Either that or you are recompiling the binary, I don't know your setup. You can profile it if you want to find out</p>",
        "id": 466950082,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725282860
    },
    {
        "content": "<p><code>lake exe</code> is very slow, as shown in the following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"k\">by</span><span class=\"bp\">-</span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$!</span><span class=\"o\">]</span>\n<span class=\"bp\">❯</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"bp\">-</span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">mk</span><span class=\"bp\">-</span><span class=\"n\">exercise</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">mk_exercise</span><span class=\"bp\">.</span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">Examples</span><span class=\"bp\">/</span><span class=\"n\">Solution</span><span class=\"w\"> </span><span class=\"n\">Exercise</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"n\">Days</span><span class=\"w\">              </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Hours</span><span class=\"w\">             </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Minutes</span><span class=\"w\">           </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Seconds</span><span class=\"w\">           </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Milliseconds</span><span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">19</span>\n<span class=\"n\">Ticks</span><span class=\"w\">             </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">193731</span>\n<span class=\"n\">TotalDays</span><span class=\"w\">         </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">2.24225694444444E-07</span>\n<span class=\"n\">TotalHours</span><span class=\"w\">        </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">5.38141666666667E-06</span>\n<span class=\"n\">TotalMinutes</span><span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">0.000322885</span>\n<span class=\"n\">TotalSeconds</span><span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">0.0193731</span>\n<span class=\"n\">TotalMilliseconds</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">19.3731</span>\n\n\n<span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"k\">by</span><span class=\"bp\">-</span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$!</span><span class=\"o\">]</span>\n<span class=\"bp\">❯</span><span class=\"w\"> </span><span class=\"n\">Measure</span><span class=\"bp\">-</span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">mk_exercise</span><span class=\"w\"> </span><span class=\"n\">Examples</span><span class=\"bp\">/</span><span class=\"n\">Solution</span><span class=\"w\"> </span><span class=\"n\">Exercise</span><span class=\"w\"> </span><span class=\"o\">}</span>\n\n<span class=\"n\">Days</span><span class=\"w\">              </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Hours</span><span class=\"w\">             </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Minutes</span><span class=\"w\">           </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Seconds</span><span class=\"w\">           </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">Milliseconds</span><span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">837</span>\n<span class=\"n\">Ticks</span><span class=\"w\">             </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">8375452</span>\n<span class=\"n\">TotalDays</span><span class=\"w\">         </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">9.69381018518518E-06</span>\n<span class=\"n\">TotalHours</span><span class=\"w\">        </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">0.000232651444444444</span>\n<span class=\"n\">TotalMinutes</span><span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">0.0139590866666667</span>\n<span class=\"n\">TotalSeconds</span><span class=\"w\">      </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">0.8375452</span>\n<span class=\"n\">TotalMilliseconds</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mf\">837.5452</span>\n</code></pre></div>",
        "id": 466950682,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725282988
    },
    {
        "content": "<blockquote>\n<p>I don't know your setup.</p>\n</blockquote>\n<p>Can you reproduce this issue?</p>",
        "id": 466951586,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725283239
    },
    {
        "content": "<p>Your link to lean by example above is dead so no I cant</p>",
        "id": 466966455,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725286619
    },
    {
        "content": "<p>Sorry, this is correct link:</p>\n<p><a href=\"https://github.com/lean-ja/lean-by-example\">https://github.com/lean-ja/lean-by-example</a></p>",
        "id": 466969445,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725287448
    },
    {
        "content": "<p>It takes more like 200ms for me but yeah lake exe is just doing some work to check if your binary is up to date:<br>\n<a href=\"/user_uploads/3121/OK3QMmgauTHqCwVzNMeB169T/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/OK3QMmgauTHqCwVzNMeB169T/image.png\" title=\"image.png\"><img data-original-dimensions=\"1145x1010\" src=\"/user_uploads/thumbnail/3121/OK3QMmgauTHqCwVzNMeB169T/image.png/840x560.webp\"></a></div><p>judging from that flame graph there also appears to be a call to <code>git</code> that is computing lots of  SHA sums for some reason, in <code>strace</code> I can also see that the <code>git</code> process ends up checking every single file in every dependency, that just takes a while, especially if your hardware isn't as recent.</p>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> is it really necessary to look at every file everywhere? That sounds to me like we're going to see linear growth in startup time for <code>lake</code> as people build bigger and bigger projects.</p>",
        "id": 466999149,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725295256
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> This comes from Lake's checking for local changes to dependencies (<a href=\"https://github.com/leanprover/lean4/pull/2425\">lean4#2425</a>). I agree that this edge case is probably something not worth checking on every workspace load (especially as it does not scale). I am not sure of a good heuristic on when to check it, though.</p>",
        "id": 467000427,
        "sender_full_name": "Mac Malone",
        "timestamp": 1725295600
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> Thank you!</p>",
        "id": 467000514,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725295623
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> </p>\n<p>Is it possible to give the <code>lake exe</code> command the option to simply execute an already existing binary? (without checking if it is up-to-date or not)</p>\n<p>Alternatively, if you check that the HASH in the <code>lake-manifest</code> has not changed, you obviously do not need to recompile.</p>",
        "id": 467000821,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725295709
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626349\">@Asei Inoue</span> An option to not build seems like a reasonable request. Feel free to make an RFC for it on the Lean 4 repo.</p>\n<p>I do not see how the hash in the Lake manifest would imply that an exe is up-to-date?</p>",
        "id": 467001385,
        "sender_full_name": "Mac Malone",
        "timestamp": 1725295871
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> In this case, the binaries in the .lake directory are not necessarily up-to-date. If you change the version of mk-exercise that you refer to, the executable in the .lake directory may be out of date. The only time you should re-run the compilation for an update would be if there is an update to the lake-manifest.</p>",
        "id": 467002082,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725296046
    },
    {
        "content": "<p>No, if a file that is (transitvely) imported by your binary changes your binary needs to be rebuild as well.</p>",
        "id": 467002225,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725296091
    },
    {
        "content": "<p>I made an RFC on lean4 repo <a href=\"https://github.com/leanprover/lean4/issues/5238\">https://github.com/leanprover/lean4/issues/5238</a></p>",
        "id": 467003638,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725296472
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/Omit.20compilation.20and.20run.20the.20executable.20binary.20in.20the.20.2Elake/near/467000427\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"395550\">Henrik Böving</span> This comes from Lake's checking for local changes to dependencies (<a href=\"https://github.com/leanprover/lean4/pull/2425\">lean4#2425</a>). I agree that this edge case is probably something not worth checking on every workspace load (especially as it does not scale). I am not sure of a good heuristic on when to check it, though.</p>\n</blockquote>\n<p>Maybe we could first check the condition that make does (i.e. ensure the file touch date thing) and only if files were touched check them against their expected hash? That would remove hash computation in basically all use cases.</p>",
        "id": 467153871,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1725348474
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> <span class=\"user-mention\" data-user-id=\"738745\">@Hening Xu</span> </p>\n<p>A command to install binaries in Lake would solve this problem. </p>\n<p>For example, </p>\n<ol>\n<li>running <code>lake install mk-exercise</code> will copy the <code>mk-exercise</code> pre-built binary to the <code>~/.lake/bin/mk-exercise</code> directory.</li>\n<li>Add <code>.lake/bin/mk-exercise</code> to the PATH</li>\n<li>From then on, the <code>mk-exercise</code> command can be executed without using the <code>lake exe</code>.</li>\n</ol>\n<p>Could you tell me your opinion on this? </p>\n<p>There must be others besides me who need a solution to this problem.</p>",
        "id": 468564582,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1725801375
    },
    {
        "content": "<p>There is a tracking issue for <code>lake install</code> at <a href=\"https://github.com/leanprover/lean4/pull/3423\">lean#3423</a>.</p>\n<p><strong>However</strong>, <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>'s plans for this have changed, and I don't remember what they actually are now. <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, any chance you could leave a comment on that issue with the current plan?</p>",
        "id": 468640970,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725838323
    },
    {
        "content": "<p>A command along the lines of <span class=\"user-mention\" data-user-id=\"626349\">@Asei Inoue</span>'s <code>lake install</code> is a future plan. However, it has not yet become a priority.  It is also different from the <code>lake install</code> of <a href=\"https://github.com/leanprover/lean4/pull/3423\">lean4#3423</a>, which is for binaries with Lean toolchain integration (and thus need different binaries for different oolchains), whereas the one Asei is proposing would a one-and-done binary (like <code>cargo install</code>).</p>",
        "id": 468641199,
        "sender_full_name": "Mac Malone",
        "timestamp": 1725838543
    },
    {
        "content": "<p>(<span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, could you leave that comment on the issue so it is findable?)</p>",
        "id": 468642530,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1725839591
    },
    {
        "content": "<p>Did anyone start with the implementation of this? Otherwise, I will get started.</p>",
        "id": 570793271,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1769693225
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315577\">Mac Malone</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Omit.20compilation.20and.20run.20the.20executable.20binary.20in.20the.20.2Elake/near/468641199\">zei</a>:</p>\n<blockquote>\n<p>A command along the lines of <span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span>'s <code>lake install</code> is a future plan. However, it has not yet become a priority.  It is also different from the <code>lake install</code> of <a href=\"https://github.com/leanprover/lean4/pull/3423\">lean4#3423</a>, which is for binaries with Lean toolchain integration (and thus need different binaries for different oolchains), whereas the one Asei is proposing would a one-and-done binary (like <code>cargo install</code>).</p>\n</blockquote>\n<p>Hi <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span>, what happened with your draft PR <a href=\"https://github.com/leanprover/lean4/pull/3998\">https://github.com/leanprover/lean4/pull/3998</a>?</p>",
        "id": 570795085,
        "sender_full_name": "Willem vanhulle",
        "timestamp": 1769693654
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"928352\">@Willem vanhulle</span> I replied on the PR.</p>",
        "id": 570861593,
        "sender_full_name": "Mac Malone",
        "timestamp": 1769709334
    }
]