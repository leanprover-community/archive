[
    {
        "content": "<p>Is there a way to replace the combination of <code>Nat.zero</code> and <code>Nat.succ</code> appearing in infoview with \"0, 1, 2, 3, ...\" ?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Tactic</span>\n\n<span class=\"c\">/-</span>\n<span class=\"cm\">![1, 2, 3] : Fin (Nat.succ (Nat.succ (Nat.succ 0))) → ℕ</span>\n<span class=\"cm\">-/</span>\n<span class=\"k\">#check</span> <span class=\"bp\">!</span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">,</span> <span class=\"mi\">2</span><span class=\"o\">,</span> <span class=\"mi\">3</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 434592902,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1713709842
    },
    {
        "content": "<p>Related question: <a href=\"#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20More.20convenient.20notation.20for.20.23check.20a.20FinVec/near/434055374\">https://leanprover.zulipchat.com/#narrow/stream/287929-mathlib4/topic/.E2.9C.94.20More.20convenient.20notation.20for.20.23check.20a.20FinVec/near/434055374</a></p>\n<p>The answer is that there's no pretty printer option for this. It's possible for you to write your own delaborator to pretty print these expressions in the way you want though.</p>",
        "id": 434609135,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1713723981
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 434698872,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1713777758
    },
    {
        "content": "<p>I will learn Lean more to understand this fantastic language…</p>",
        "id": 434699183,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1713777855
    },
    {
        "content": "<p>While doing some exercises from the \"Metaprogramming in Lean\"  book, I clicked on the solutions and got the following code</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Init</span><span class=\"bp\">.</span><span class=\"n\">Prelude</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"explore\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">metavarDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetavarDecl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">getDecl</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Our metavariable\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- [anonymous] : 2 = 2</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">{metavarDecl.userName} : {metavarDecl.type}\"</span>\n\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">All of its local declarations\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">localContext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocalContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">metavarDecl</span><span class=\"bp\">.</span><span class=\"n\">lctx</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">localDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocalDecl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">localContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">localDecl</span><span class=\"bp\">.</span><span class=\"n\">isImplementationDetail</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- (implementation detail) red : 1 = 1 → 2 = 2 → 2 = 2</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">(implementation detail) {localDecl.userName} : {localDecl.type}\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"c1\">-- hA : 1 = 1</span>\n<span class=\"w\">      </span><span class=\"c1\">-- hB : 2 = 2</span>\n<span class=\"w\">      </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">{localDecl.userName} : {localDecl.type}\"</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">red</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">explore</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>but in the infoview I have a bunch of <code>(OfNat.ofNat.{0} Nat 1 (instOfNatNat 1)) (OfNat.ofNat.{0} Nat 1 (instOfNatNat 1)))</code> instead of <code>1</code>. Is there a pretty printer to call so that this gets bettered rendered?</p>",
        "id": 502880044,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1740935407
    },
    {
        "content": "<p>Use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.logInfo#doc\">docs#Lean.logInfo</a> instead:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"explore\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MVarId</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">metavarDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetavarDecl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mvarId</span><span class=\"bp\">.</span><span class=\"n\">getDecl</span>\n\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"Our metavariable\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- hA : 1 = 1</span>\n<span class=\"w\">  </span><span class=\"c1\">-- hB : 2 = 2</span>\n<span class=\"w\">  </span><span class=\"c1\">-- ⊢ 2 = 2</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">mvarId</span>\n\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"All of its local declarations\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">localContext</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocalContext</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">metavarDecl</span><span class=\"bp\">.</span><span class=\"n\">lctx</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">localDecl</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LocalDecl</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">localContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">localDecl</span><span class=\"bp\">.</span><span class=\"n\">isImplementationDetail</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"c1\">-- (implementation detail) red : 1 = 1 → 2 = 2 → 2 = 2</span>\n<span class=\"w\">      </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"(implementation detail) {localDecl.userName} : {localDecl.type}\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">      </span><span class=\"c1\">-- hA : 1 = 1</span>\n<span class=\"w\">      </span><span class=\"c1\">-- hB : 2 = 2</span>\n<span class=\"w\">      </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{localDecl.userName} : {localDecl.type}\"</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">red</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hA</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hB</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">explore</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 502880725,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1740935864
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 502881156,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1740936157
    },
    {
        "content": "<p>I realise that this is still not exactly what I needed: for pedagogical purposes I am defining a tactic that add the double of any natural in scope:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib.Tactic</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">SuccNat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h.type</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">liftMetaTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mv.define</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">!</span><span class=\"s2\">\"double_{h.userName.toString}\"</span><span class=\"bp\">.</span><span class=\"n\">toName</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"o\">[])</span>\n<span class=\"w\">        </span><span class=\"o\">(</span><span class=\"n\">Lean.mkAppN</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Nat.mul</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h.toExpr</span><span class=\"o\">])</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mv.intro1P</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mv</span><span class=\"o\">]</span>\n\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"succNat\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">SuccNat</span>\n</code></pre></div>\n<p>but when I do</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">H</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"kd\">by</span>\n<span class=\"w\">  </span><span class=\"n\">succNat</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>I have in my infoview</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">double_n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat.mul</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"n\">double_m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat.mul</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">m</span>\n<span class=\"n\">double_k</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat.mul</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">k</span>\n</code></pre></div>\n<p>whereas I would like them rendered as <code>2 * n</code>, <code>2 * m</code>, etc...</p>",
        "id": 503323487,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741109013
    },
    {
        "content": "<p>Here is one way:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SuccNat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hval</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hstx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">toSyntax</span><span class=\"w\"> </span><span class=\"n\">hval</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tm</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">hstx</span><span class=\"o\">)</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tme</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">tm</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">      </span><span class=\"n\">liftMetaTactic</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"bp\">.</span><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"double_{h.userName.toString}\"</span><span class=\"bp\">.</span><span class=\"n\">toName</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">tme</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mv</span><span class=\"bp\">.</span><span class=\"n\">intro1P</span>\n<span class=\"w\">        </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mv</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 503326461,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741109928
    },
    {
        "content": "<p>Nice! Can you explain what these lines</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tm</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">term</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">hstx</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tme</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">tm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>are (in paticular the <code>term|</code> and the <code>elabTerm</code>) and why this works (or, equivalently, why the previous did not)?</p>",
        "id": 503327180,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110145
    },
    {
        "content": "<p>The first one, is generating a <code>Syntax</code> object (in fact, a <code>Term</code>) that represents <code>2 * &lt;the other&gt;</code>.</p>",
        "id": 503327442,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110232
    },
    {
        "content": "<p>Now that you have a <code>Syntax</code>, you can elaborate it and produce an expression: this is what the other line does.</p>",
        "id": 503327572,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110262
    },
    {
        "content": "<p>Oh, so  I was roughly working at the <code>Expr</code> level, and you are somewhat deeper?</p>",
        "id": 503327653,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110287
    },
    {
        "content": "<p>The main takeaway is that Lean is generating the expr for you, so you do not have to worry about what <code>mkApp</code> you should use.</p>",
        "id": 503327671,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110296
    },
    {
        "content": "<p>(Apologies for the dummy question, I am moving my first steps in this)</p>",
        "id": 503327718,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110309
    },
    {
        "content": "<p>I would actually say that my code is more <em>shallow</em>.</p>",
        "id": 503327736,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110316
    },
    {
        "content": "<p>I view \"depth\" as follows:</p>\n<ul>\n<li>text that you type -- very much on the surface;</li>\n<li>Lean converts it to syntax -- a little bit deeper;</li>\n<li>eventually, from the syntax lean produces an expr -- deep here!</li>\n</ul>",
        "id": 503327910,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110367
    },
    {
        "content": "<p>Oh, I got syntax &lt;-&gt; expr in the wrong order. Thanks!</p>",
        "id": 503328056,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110422
    },
    {
        "content": "<p>Right: I mostly view <code>Syntax</code> as a step towards producing an <code>Expr</code>, rather than the other way round.</p>",
        "id": 503328134,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110450
    },
    {
        "content": "<p>So, is it roughly correct that you try to work with syntax as much as possible and revert to <code>Expr</code> only when needed?</p>",
        "id": 503328145,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110454
    },
    {
        "content": "<p>(I am a bit confused because studying the Metaprogramming book, I feel more emphasis on Expr than on Stx)</p>",
        "id": 503328269,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110484
    },
    {
        "content": "<p>I am not sure if that is always the case: eventually, you want the <code>Expr</code> to line up, but if you can make Lean do the conversion/elaboration, that is more stable than doing it yourself.</p>",
        "id": 503328332,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110503
    },
    {
        "content": "<p>I see</p>",
        "id": 503328386,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110521
    },
    {
        "content": "<p>I would view writing directly the <code>Expr</code> as \"unfolding all the way\".</p>",
        "id": 503328450,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110541
    },
    {
        "content": "<p>Sometimes, there is no way around it and ultimately, you should be able to do things like that.</p>",
        "id": 503328507,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110554
    },
    {
        "content": "<p>In practice, though, if you can leverage some intermediate representations that takes care of the conversion for you, you are better off using them.</p>",
        "id": 503328594,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110583
    },
    {
        "content": "<p>OK, very nice. But this means in particular that the infoview is really affected by the way I produce things, and does nothing \"on its own\" like translating expressions back and forth when notation is in force?</p>",
        "id": 503328747,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110617
    },
    {
        "content": "<p>I would say that pretty-printing is very susceptible of what <em>exactly</em> you use.  This is why, if you have syntax for something, you should use it, since otherwise it will \"mean the same\", but nothing will pick it up.</p>",
        "id": 503328953,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110696
    },
    {
        "content": "<p>In the case above, you want Lean to latch onto whatever it is that uses the <code>*</code> notation.</p>",
        "id": 503329072,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110726
    },
    {
        "content": "<p>I <em>think</em> that this is the <code>HMul</code> typeclass, that, for Nat, is highjacked... maybe the <code>Nat.mul</code> that you were using, I am not sure.</p>",
        "id": 503329205,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110774
    },
    {
        "content": "<p>I see, I certainly need to get more experience, but little by little it will improve. I had indeed tried with the <code>HMul</code>, but at the <code>Expr</code>-level it is a nightmare, because it needs to be filled with all the arguments (the three types) and with the HMul instance, itselft having several arguments (and coming from <code>Mul</code> for <code>Nat</code>, that again needs arguments...)</p>",
        "id": 503329361,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110825
    },
    {
        "content": "<p>If you turn off notation, <code>2 * n</code> is printed as <code>HMul.hMul 2 n</code></p>",
        "id": 503329477,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741110851
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503329477\">said</a>:</p>\n<blockquote>\n<p>If you turn off notation, <code>2 * n</code> is printed as <code>HMul.hMul 2 n</code></p>\n</blockquote>\n<p>But my point was to turn it <em>on</em></p>",
        "id": 503329552,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110876
    },
    {
        "content": "<p>Right, if you use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">        </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">mkAppM</span><span class=\"w\"> </span><span class=\"ss\">``HMul.hMul</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">mkNatLit</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span><span class=\"o\">])</span>\n</code></pre></div>\n<p>in the appropriate line of your code, you will see that it \"works\" as is.</p>",
        "id": 503329712,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110928
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300245\">Filippo A. E. Nuccio</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503329361\">said</a>:</p>\n<blockquote>\n<p>I see, I certainly need to get more experience, but little by little it will improve. I had indeed tried with the <code>HMul</code>, but at the <code>Expr</code>-level it is a nightmare, because it needs to be filled with all the arguments (the three types) and with the HMul instance, itselft having several arguments (and coming from <code>Mul</code> for <code>Nat</code>, that again needs arguments...)</p>\n</blockquote>\n<p>Note that I used the helper <code>Meta.mkAppM</code> that have a better UX.</p>",
        "id": 503329875,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741110971
    },
    {
        "content": "<p>Yes, because <code>mkAppM</code> is more clever wrt implicit arguments, right?</p>",
        "id": 503329931,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741110987
    },
    {
        "content": "<p><code>Nat.mul</code> does not have notation, and is not the same as <code>@HMul.hMul Nat Nat Nat (@instHMul Nat instMulNat)</code></p>",
        "id": 503329957,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741110995
    },
    {
        "content": "<p>Using <code>Lean.mkAppN</code> directly is really hardcore (and really brittle).</p>",
        "id": 503329988,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741111005
    },
    {
        "content": "<p>For this I would use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.mkNatMul#doc\">docs#Lean.mkNatMul</a>, since it is specialized to this use case.</p>",
        "id": 503330119,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741111045
    },
    {
        "content": "<p>So, <code> `(syntax)</code> and <code>Meta.mkAppN</code> are more user-friendly than constructing the inductive <code>Syntax</code> and <code>Expr</code> directly.</p>",
        "id": 503330167,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741111061
    },
    {
        "content": "<p>Usually</p>",
        "id": 503330210,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741111073
    },
    {
        "content": "<p>In general, you should always prefer them over anything else and use the constructors only as a last resort.</p>",
        "id": 503330247,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741111083
    },
    {
        "content": "<p>Ah, if there is a dedicated function, then great!</p>",
        "id": 503330477,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741111164
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503330119\">said</a>:</p>\n<blockquote>\n<p>For this I would use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.mkNatMul#doc\">docs#Lean.mkNatMul</a>, since it is specialized to this use case.</p>\n</blockquote>\n<p>And this brings me to the ancillary question... how to survive the enormous zoo of functions around? I understand it is probably the same question one could ask for Mathlib, but for me the <code>Lean.Elab</code> zoo seems much wilder <span aria-label=\"lion\" class=\"emoji emoji-1f981\" role=\"img\" title=\"lion\">:lion:</span> <span aria-label=\"tiger\" class=\"emoji emoji-1f405\" role=\"img\" title=\"tiger\">:tiger:</span> I mean, should I hope to eventually learn <em>everything</em> that is in there? Are there guide(line)s? General principles to browse the library?</p>",
        "id": 503330594,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741111198
    },
    {
        "content": "<p>At any rate, thank you both for your answers ! <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>",
        "id": 503331588,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741111455
    },
    {
        "content": "<p>I think that yes, it is like with mathlib: you ask questions, you browse a little...</p>",
        "id": 503331670,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741111483
    },
    {
        "content": "<p>In the case of metaprogramming, \"proofs\", i.e. reading after the <code>:=</code>, is probably more informative than doing it in mathlib.</p>",
        "id": 503331820,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741111534
    },
    {
        "content": "<p>You could also take more advantage of <code>evalTactic</code> here. It feels less robust in some ways, but the positive to the tradeoff is that the code is a lot simpler to understand:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SuccNat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withoutRecover</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"bp\">.</span><span class=\"n\">isConstOf</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doubleIdent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">mkSimple</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"double_{h.userName.toString}\"</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hstx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">exprToSyntax</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span>\n<span class=\"w\">      </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">doubleIdent</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">hstx</span><span class=\"o\">)</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"double_nats\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">SuccNat</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">double_nats</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">a b c : Nat</span>\n<span class=\"cm\">d : Int</span>\n<span class=\"cm\">double_a : Nat := 2 * a</span>\n<span class=\"cm\">double_b : Nat := 2 * b</span>\n<span class=\"cm\">double_c : Nat := 2 * c</span>\n<span class=\"cm\">⊢ True</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 503347365,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741116531
    },
    {
        "content": "<p>Is <code>evalTactic</code> explained somewhere (perhaps in the Metaprogramming book, or elsewhere)?</p>",
        "id": 503347505,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741116585
    },
    {
        "content": "<p>I don't know whether it is or not, but it ought to be. It's one of the easiest ways to manipulate the tactic state, since it lets you run tactic scripts directly. It lets you make macros that depend on the details of the current state (here, we can't use a <code>macro</code> because we need the current local context).</p>",
        "id": 503348026,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741116735
    },
    {
        "content": "<p>Ok, thanks, I'll try to study/understand it and how it works.</p>",
        "id": 503348451,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741116869
    },
    {
        "content": "<p>I made a small modification: the additional <code>withoutRecover</code> makes sure the tactic in <code>evalTactic</code> is being run in a mode where it doesn't try to do any error recovery. For example, inserting <code>sorry</code> when there are type errors.</p>\n<p>In the automated parts of a tactic, you want recovery disabled, since you expect them to be error-free. If anything goes wrong, you want the tactic to stop with an error so you can debug it.</p>\n<p>(You can experiment with the effects of <code>withoutRecover</code> by changing the <code>evalTactic</code> line to do something bogus, like <code>let $doubleIdent : Nat := true * $hstx</code>)</p>",
        "id": 503349832,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741117345
    },
    {
        "content": "<p>I think the fact it was easy to forget to include <code>withoutRecover</code> proves the thesis that the Lean 4 metaprogramming interface is very large and difficult to keep track of.</p>\n<p>I try to keep <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Metaprogramming-gotchas\">Metaprogramming gotchas</a> updated. Just added <code>withoutRecover</code> at the end.</p>",
        "id": 503351199,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741117811
    },
    {
        "content": "<p>Thanks! If you feel like adding a paragraph about <code>evalTactic</code> (or more about <code>EvalM</code> in general... <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> ) it would be very much appreciated!</p>",
        "id": 503351357,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741117876
    },
    {
        "content": "<p>Also, for pedagogical purposes, I find the exact checking that the type of your local declarations is <code>Nat</code> very strong.  If this were a \"real\" tactic, I think that it would probably try a little harder to unify <code>h.type</code> with <code>Nat</code>, probably using <code>Meta.whnfR</code>.</p>",
        "id": 503351914,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118065
    },
    {
        "content": "<p>E.g., if you had <code>abbrev N := Nat</code> and then you had an <code>s : N</code> in your context, it may not be unreasonable to want to double <code>s</code> as well.</p>",
        "id": 503352129,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118132
    },
    {
        "content": "<p>In fact, that points to how the tactic is afflicted by one of the gotchas :-)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">True</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">  </span><span class=\"n\">double_nats</span>\n<span class=\"w\">  </span><span class=\"c1\">-- e is not doubled</span>\n</code></pre></div>",
        "id": 503352164,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741118146
    },
    {
        "content": "<p>Quiz: which gotcha is it?</p>",
        "id": 503352181,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741118154
    },
    {
        "content": "<p>This is one of the most common issues!!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 503352807,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118370
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503352181\">said</a>:</p>\n<blockquote>\n<p>Quiz: which gotcha is it?</p>\n</blockquote>\n<p>Oh nice! I'll try to do the exercise tonight <span aria-label=\"smirk\" class=\"emoji emoji-1f60f\" role=\"img\" title=\"smirk\">:smirk:</span> Thanks.</p>",
        "id": 503353082,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741118453
    },
    {
        "content": "<p>(And I still consider this kind of \"action at a distance\" very confusing, btw.)</p>",
        "id": 503353100,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118461
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300245\">Filippo A. E. Nuccio</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503353082\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503352181\">said</a>:</p>\n<blockquote>\n<p>Quiz: which gotcha is it?</p>\n</blockquote>\n<p>Oh nice! I'll try to do the exercise tonight <span aria-label=\"smirk\" class=\"emoji emoji-1f60f\" role=\"img\" title=\"smirk\">:smirk:</span> Thanks.</p>\n</blockquote>\n<p>Is it in some sense thinking that <code>e</code> must be an integer (although it shows as a <code>Nat</code> in the infoview) perhaps?</p>",
        "id": 503353453,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741118584
    },
    {
        "content": "<p>I think that even without <code>d</code>, it would still not work.</p>",
        "id": 503353763,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118692
    },
    {
        "content": "<p>But I also consider the <code>d</code> a hint for figuring out what is going on.</p>",
        "id": 503353870,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118729
    },
    {
        "content": "<p>I'm not sure <code>d</code> is related at all. It's not a metadata bug, if that's what you're thinking. (E.g., one solved by <code>consumeMData</code> on the goal type.)</p>",
        "id": 503354105,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741118797
    },
    {
        "content": "<p>No, I was not thinking of a metadata issue (although it is the first thing that I thought when I saw your example).</p>",
        "id": 503354200,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118839
    },
    {
        "content": "<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>I was thinking more of getting into the mind-set of thinking that there is something unspecified about the type of <code>e</code>.</p>\n</div></div>",
        "id": 503354468,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741118911
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503352181\">said</a>:</p>\n<blockquote>\n<p>Quiz: which gotcha is it?</p>\n</blockquote>\n<p>Is it</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>spoiler</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>uninstantiated mvars</p>\n</div></div>",
        "id": 503359582,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741120604
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"816344\">Aaron Liu</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503359582\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/pretty.20print.20of.20Nat/near/503352181\">said</a>:</p>\n<blockquote>\n<p>Quiz: which gotcha is it?</p>\n</blockquote>\n<p>Is it</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>spoiler</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>uninstantiated mvars</p>\n<p></div></div><br>\n</p>\n</blockquote>\n<p>Oh, and why so!?! Is the <code>let</code> clause creating a <code>mvar</code> for the type of <code>e</code> or something?</p>",
        "id": 503469655,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741169103
    },
    {
        "content": "<p><code>let e := 2</code> is basically shorthand for <code>let e : _ := 2</code>, and so, yes, the type of <code>e</code> is a metavariable. The metavariable is assigned very soon after it is created, but it's still there.</p>\n<p>One fix is to do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SuccNat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withoutRecover</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">htype</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">htype</span><span class=\"bp\">.</span><span class=\"n\">isConstOf</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doubleIdent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">mkSimple</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"double_{h.userName.toString}\"</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hstx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">exprToSyntax</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span>\n<span class=\"w\">      </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">doubleIdent</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">hstx</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>Another is to put it into whnf as Damiano suggested:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">SuccNat</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TacticM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withoutRecover</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">withMainContext</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getLCtx</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">lctx</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">whnfR</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">isConstOf</span><span class=\"w\"> </span><span class=\"ss\">``Nat</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">doubleIdent</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">mkIdent</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"bp\">.</span><span class=\"n\">mkSimple</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"double_{h.userName.toString}\"</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">hstx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">exprToSyntax</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"bp\">.</span><span class=\"n\">toExpr</span>\n<span class=\"w\">      </span><span class=\"n\">evalTactic</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">doubleIdent</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">hstx</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 503479930,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741171998
    },
    {
        "content": "<p>While I understand why the first solution works, I do not for Damiano's. Is <code>whnfR</code> instantiating mvars under the hood? I would have imagined it only to be able to fix problems related to <code>Nat</code> being \"locally presented\" not as <code>.const ``Nat []</code>, not to be able to manage this kind of uninstantiated mvars.</p>",
        "id": 503482367,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741172645
    },
    {
        "content": "<p>Yes, part of the definition of weak-head normal form is that there are no head metavariables that have been assigned. That is, if you have <code>?m a1 a2 ... an</code> with <code>?m</code> an assigned metavariable, it will instantiate it.</p>",
        "id": 503483613,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741173011
    },
    {
        "content": "<p>Awesome! Thanks (this probably is also worth mentioning in <a href=\"https://leanprover-community.github.io/lean4-metaprogramming-book/main/04_metam.html\">the relevant chapter</a>, no?)</p>",
        "id": 503483890,
        "sender_full_name": "Filippo A. E. Nuccio",
        "timestamp": 1741173115
    },
    {
        "content": "<p>It looks like they briefly mention it, a bit indirectly:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"c1\">-- Assuming the metavariable `?x` is unassigned, it is in WHNF.</span>\n\n<span class=\"bp\">?</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"c1\">-- Assuming `?x` is assigned (e.g. to `Nat.add`), its application is not</span>\n<span class=\"w\">          </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">WHNF</span><span class=\"bp\">.</span>\n</code></pre></div>",
        "id": 503484999,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741173439
    },
    {
        "content": "<p>In terms of \"standard tactic expectation\", I would say that mathlib tactics would normally expect using <code>whnfR</code> for normalization, than just instantiating metavariables.</p>",
        "id": 503529459,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741184474
    }
]