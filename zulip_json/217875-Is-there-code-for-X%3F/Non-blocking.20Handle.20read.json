[
    {
        "content": "<p>Is there a non-blocking way to read from a Handle, w timeout or similar?</p>\n<p>Currently I use:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proc</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">spawn</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"cmd\"</span>\n<span class=\"w\">  </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"w\">  </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"w\">  </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">proc</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">putStr</span><span class=\"w\"> </span><span class=\"s2\">\"prompt\"</span>\n<span class=\"n\">proc</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">flush</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">proc</span><span class=\"bp\">.</span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">getLine</span><span class=\"w\">  </span><span class=\"c1\">-- Non-blocking would be nice</span>\n</code></pre></div>",
        "id": 536784554,
        "sender_full_name": "Oliver Dressler",
        "timestamp": 1756472664
    },
    {
        "content": "<p>There is now an <code>Async</code>. Perhaps the following code (my attempt to learn <code>Async</code>) includes what you need:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Async</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Sync</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">writeSlow</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)(</span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt32</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Write operation completed after {n} seconds; phase: {s}\"</span>\n<span class=\"w\">  </span><span class=\"n\">count</span><span class=\"bp\">.</span><span class=\"n\">atomically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"bp\">.</span><span class=\"n\">atomically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">get</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Total writes completed: {c}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">Stream</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">background</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prio</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">Priority</span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">writeSlow</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Write operations started in phase {s}. Waiting for input. Type 'q' to quit\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"q\"</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">stdin</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">AsyncTask</span><span class=\"bp\">.</span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"n\">Async</span><span class=\"bp\">.</span><span class=\"n\">toIO</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toNat!</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\">  </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span><span class=\"bp\">.</span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">      </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"intial\"</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">stdin</span>\n</code></pre></div>",
        "id": 536977591,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1756641390
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"802311\">Oliver Dressler</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Non-blocking.20Handle.20read/near/536784554\">said</a>:</p>\n<blockquote>\n<p>Is there a non-blocking way to read from a Handle, w timeout or similar?</p>\n<p>Currently I use:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">proc</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">Process</span><span class=\"bp\">.</span><span class=\"n\">spawn</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">  </span><span class=\"n\">cmd</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"cmd\"</span>\n<span class=\"w\">  </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"w\">  </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"w\">  </span><span class=\"n\">stderr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">piped</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">proc</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">putStr</span><span class=\"w\"> </span><span class=\"s2\">\"prompt\"</span>\n<span class=\"n\">proc</span><span class=\"bp\">.</span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">flush</span>\n<span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">proc</span><span class=\"bp\">.</span><span class=\"n\">stdout</span><span class=\"bp\">.</span><span class=\"n\">getLine</span><span class=\"w\">  </span><span class=\"c1\">-- Non-blocking would be nice</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Unfortunately the async efforts haven't reached the process API yet.</p>\n<p><span class=\"user-mention silent\" data-user-id=\"266304\">Siddhartha Gadgil</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Non-blocking.20Handle.20read/near/536977591\">said</a>:</p>\n<blockquote>\n<p>There is now an <code>Async</code>. Perhaps the following code (my attempt to learn <code>Async</code>) includes what you need:</p>\n<p><div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">Async</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Sync</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Internal</span><span class=\"bp\">.</span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"n\">Std</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">writeSlow</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)(</span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toUInt32</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Write operation completed after {n} seconds; phase: {s}\"</span>\n<span class=\"w\">  </span><span class=\"n\">count</span><span class=\"bp\">.</span><span class=\"n\">atomically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">modify</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"bp\">.</span><span class=\"n\">atomically</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">·.</span><span class=\"n\">get</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Total writes completed: {c}\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">n</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">FS</span><span class=\"bp\">.</span><span class=\"n\">Stream</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Async</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">background</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prio</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Task</span><span class=\"bp\">.</span><span class=\"n\">Priority</span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">writeSlow</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">eprintln</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"Write operations started in phase {s}. Waiting for input. Type 'q' to quit\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"bp\">.</span><span class=\"n\">getLine</span>\n<span class=\"w\">  </span><span class=\"n\">unless</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"bp\">.</span><span class=\"n\">startsWith</span><span class=\"w\"> </span><span class=\"s2\">\"q\"</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"n\">inp</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">stdin</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">AsyncTask</span><span class=\"bp\">.</span><span class=\"n\">block</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">    </span><span class=\"n\">Async</span><span class=\"bp\">.</span><span class=\"n\">toIO</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">]</span><span class=\"bp\">!</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">toNat!</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\">  </span><span class=\"n\">Std</span><span class=\"bp\">.</span><span class=\"n\">Mutex</span><span class=\"bp\">.</span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stdin</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">getStdin</span>\n<span class=\"w\">      </span><span class=\"n\">loop</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"s2\">\"intial\"</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"n\">stdin</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Unfortunately that code is not at all async and will just block all over the place, <code>IO.sleep</code> is a blocking sleeping API, the one that would not block would be <code>Std.Internal.IO.Async.sleep</code> and also <code>getLine</code> is not an asynchronous but a blocking one. The <code>Async</code> monad can currently lift blocking functions from IO to do things like <code>print</code> etc. but just because your program type checks inside of the <code>Async</code> monad doesn't mean there is blocking going on.</p>\n<p>Furthermore the proper API to read with a timeout would be to use a selectable: <a href=\"https://leanprover-community.github.io/mathlib4_docs/Std/Internal/Async/Select.html#Std.Internal.IO.Async.Selectable.one\">https://leanprover-community.github.io/mathlib4_docs/Std/Internal/Async/Select.html#Std.Internal.IO.Async.Selectable.one</a> but again this API currently only works with things like sockets and not yet stdout handles.</p>",
        "id": 536978521,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1756642302
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> <br>\nWhat I tested and found was that the process in the background runs and outputs in StdErr while waiting for input, and when I input new processes are launched. </p>\n<p>This is the minimal I needed - a task running in the background while waiting for a new request, and if the new request comes then launching on another thread. The <code>background</code> function does this. </p>\n<p>Could you suggest how to improve the code? I see one in the above : I should be using <code>Std.Internal.IO.Async.sleep</code> to not block a thread (but my actual code has no `IO.sleep).</p>",
        "id": 536980088,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1756643888
    },
    {
        "content": "<p>There is no way to do it properly with actually 0 blockage right now. The <code>getLine</code> has no proper alternative</p>",
        "id": 536980130,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1756643938
    },
    {
        "content": "<p>Does that mean one thread blocks because of the <code>getLine</code>, but the other stuff can run in the background?</p>",
        "id": 536980285,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1756644117
    },
    {
        "content": "<p>Yes writeSlow will run on separate threads (assuming that you have more than 1 on your machine)</p>",
        "id": 536980335,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1756644167
    },
    {
        "content": "<p>For me losing 1 thread is an acceptable price till the <code>Async</code> API gets more goodies. Acutally the StdIO is also a hack while waiting for the http server (currently a Python server wraps StdIO and StdIn).</p>",
        "id": 536980845,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1756644660
    },
    {
        "content": "<p>Thanks for all the info! I also tried async, task and readToEnd but none fit my use case.<br>\nI can currently work around this until the async handle read is available. It just forces me to know exactly how many lines to expect.</p>",
        "id": 536984100,
        "sender_full_name": "Oliver Dressler",
        "timestamp": 1756647718
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> am I correct that if I want to poll without blocking any resources, I can use <a href=\"https://leanprover-community.github.io/mathlib4_docs/Std/Internal/Async/Timer.html#Std.Internal.IO.Async.sleep\">Std.Internal.IO.Async.sleep</a> and map the \"result\" to a recursion on a loop?</p>",
        "id": 537043140,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1756709741
    },
    {
        "content": "<p>You will still block on getLine regardless.</p>",
        "id": 537049381,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1756712331
    },
    {
        "content": "<p>I mean if I poll with a <code>curl</code> request instead of having <code>getLine</code>.</p>",
        "id": 537050056,
        "sender_full_name": "Siddhartha Gadgil",
        "timestamp": 1756712508
    }
]