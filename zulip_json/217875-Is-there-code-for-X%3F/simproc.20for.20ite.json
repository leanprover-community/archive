[
    {
        "content": "<p>First of all, I know about <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=reduceIte#doc\">docs#reduceIte</a>, but it doesn't cover what I want.<br>\nConsider</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>\n<p>Is there a simproc that will reduce the goal to <code>P</code>, by inspecting that the LHS <code>(1:Nat)</code> is equal to the true-branch of the ite, and more importantly <em>is not</em> equal to the false-branch of the ite. (And dually, reduce to <code>\\not P</code> when appropriate.)</p>\n<p>Maybe this is way to expensive, and a bad idea. But I think it could be useful in practice.</p>\n<p>E.g, this came up when running the <code>compute_degree</code> tactic on <code>natDegree (X^p - X) = p</code>, where <code>p</code> is a prime and the coefficients are a field of characteristic 0. </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Polynomial</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"bp\">*</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Field</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">CharZero</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">natDegree</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">X</span><span class=\"bp\">^</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">X</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">compute_degree</span>\n</code></pre></div>\n<p>The goal is now</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">\\</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>and it would be great if we could automatically reduce this further to <code>p \\ne 1</code>.</p>",
        "id": 450876727,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720759793
    },
    {
        "content": "<p>What about <code>simp [Ne.ite_eq_left_iff]</code>? (<a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Ne.ite_eq_left_iff#doc\">docs#Ne.ite_eq_left_iff</a>)</p>",
        "id": 450877587,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720760345
    },
    {
        "content": "<p>Did you mean to add <code>Prime p</code> to your assumptions?</p>",
        "id": 450877721,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720760405
    },
    {
        "content": "<p>In your example, it seems like you first need a simproc to bubble up the <code>ite</code> to the top of the expression. I really wish we had something like this, because <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=apply_ite#doc\">docs#apply_ite</a> is really hard to use in practice</p>",
        "id": 450877724,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720760407
    },
    {
        "content": "<p>(or at the very least <code>1 &lt; p</code>!</p>",
        "id": 450877832,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720760439
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/simproc.20for.20ite/near/450877721\">said</a>:</p>\n<blockquote>\n<p>Did you mean to add <code>Prime p</code> to your assumptions?</p>\n</blockquote>\n<p>Lean should know that when a number theorist calls a variable <code>p</code> it should be a prime <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span></p>",
        "id": 450877838,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720760441
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/simproc.20for.20ite/near/450877838\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/simproc.20for.20ite/near/450877721\">said</a>:</p>\n<blockquote>\n<p>Did you mean to add <code>Prime p</code> to your assumptions?</p>\n</blockquote>\n<p>Lean should know that when a number theorist calls a variable <code>p</code> it should be a prime <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span></p>\n</blockquote>\n<p>This should be added to the linter for common mistakes...</p>",
        "id": 450877949,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1720760470
    },
    {
        "content": "<p>I didnt intend for my examples to be provable, merely illustrative</p>",
        "id": 450878574,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720760800
    },
    {
        "content": "<p>I guess the tricky thing is that there is nothing to key on? So it doesn't fit in a discrimination tree approach?</p>",
        "id": 450901887,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720770993
    },
    {
        "content": "<p>So maybe (if at all) this should be a separate tactic...</p>",
        "id": 450901920,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720771008
    },
    {
        "content": "<p>Yes I agree that's what's tricky. Isn't the point of simprocs that they don't use the discrimination tree and are basically \"a separate tactic but integrated into simp\"?</p>",
        "id": 450911138,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720773657
    },
    {
        "content": "<p>I think that <code>simp</code> still needs to decide when to run the tactic, and it does that using disctrees. But I'm not an expert, so I might be wrong.</p>",
        "id": 450911429,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720773732
    },
    {
        "content": "<p>Let me read up about simprocs...</p>",
        "id": 450912262,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1720773972
    },
    {
        "content": "<p>Maybe what I'm looking for can also be accomplished with chaining <code>split_ifs</code> and <code>simp</code>.</p>",
        "id": 450926413,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720778261
    },
    {
        "content": "<p><code>simp</code> basically already does what you want on the first example...</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Common</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">Decidable</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">says</span><span class=\"w\"> </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">ite_eq_left_iff</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">zero_ne_add_one</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">imp_false</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Decidable</span><span class=\"bp\">.</span><span class=\"n\">not_not</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"n\">guard_target</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">P</span>\n<span class=\"w\">  </span><span class=\"gr\">sorry</span>\n</code></pre></div>",
        "id": 450926727,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720778365
    },
    {
        "content": "<p>Yeah, I think the first example is too minimal in hindsight <span aria-label=\"oops\" class=\"emoji emoji-1f643\" role=\"img\" title=\"oops\">:oops:</span></p>",
        "id": 450926941,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720778424
    },
    {
        "content": "<p>And with more aggresive simp-lemmas (e.g. <code>sub_ne_zero_iff_ne</code> the second example could also work)</p>",
        "id": 450927140,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720778485
    },
    {
        "content": "<p>I guess so. Do we want the default simp set to be able to handle this?</p>",
        "id": 450928387,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1720778854
    },
    {
        "content": "<p>I'm not sure. I've been thinking for a while now to have a single simp set (<code>extra</code>/<code>extended</code>/<code>more</code>/<code>plus</code>/...) where we can put all our lemmas that can be useful to simplify sometimes, but in other contexts might be undesirable. The user interaction I imagine is that if <code>simp</code> fails to simplify as much as you want, you can write <code>simp [plus]</code> to simplify further. But you might have to do the <code>simp? [plus]</code> -&gt; <code>simp [plus, - undesirable_lemma]</code>-dance to simplify exactly how you wish.</p>",
        "id": 450929365,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720779170
    },
    {
        "content": "<p>For a more complicated second version, you need to rewrite the goal so that the if-then-else is on one side of the equation, which lies outside the scope of simp in more complicated cases. We should have a more generic tactic <code>solve_for x</code> that solves for the term <code>x</code> (at least if the expression is linear in <code>x</code>)...</p>",
        "id": 450930480,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1720779548
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 451040672,
        "sender_full_name": "Pri",
        "timestamp": 1720807412
    }
]