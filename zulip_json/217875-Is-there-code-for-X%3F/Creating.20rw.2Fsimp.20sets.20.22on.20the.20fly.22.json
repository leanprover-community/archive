[
    {
        "content": "<p>In certain contexts, it may be useful to simplify/rewrite using a specific set of rules. Is there a way to define such a set \"on the fly\"?</p>\n<p>Something like </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">my_rule_set</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">RuleSet</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_sub</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul_neg</span><span class=\"o\">]</span>\n\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\">  </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">simp</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\">  </span><span class=\"o\">[</span><span class=\"n\">my_rule_set</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 544216903,
        "sender_full_name": "Miguel Marco",
        "timestamp": 1760116732
    },
    {
        "content": "<p>I don't see how this is \"on the fly\"</p>",
        "id": 544217175,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760116832
    },
    {
        "content": "<p>I mean you can do it in your own file, without having to go through the code of each lemma you want to use to mark them.</p>",
        "id": 544217295,
        "sender_full_name": "Miguel Marco",
        "timestamp": 1760116881
    },
    {
        "content": "<p>oh is that how it usually works (I don't really make simp sets myself so I wouldn't know)</p>",
        "id": 544217554,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760117003
    },
    {
        "content": "<p>I think so. Am I wrong?</p>",
        "id": 544217670,
        "sender_full_name": "Miguel Marco",
        "timestamp": 1760117055
    },
    {
        "content": "<p>what's the syntax to declare a simp set?</p>",
        "id": 544217745,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760117087
    },
    {
        "content": "<p>found it</p>",
        "id": 544218183,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760117271
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"461731\">@Miguel Marco</span> What about this?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"kn\">local</span><span class=\"w\"> </span><span class=\"kn\">macro</span><span class=\"w\"> </span><span class=\"s2\">\"my_rule_set\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">tactic</span><span class=\"bp\">|</span>\n<span class=\"w\">  </span><span class=\"n\">repeat</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_add</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_sub</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">rw</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">mul_neg</span><span class=\"o\">])</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">my_rule_set</span>\n</code></pre></div>\n<p>(I changed <code>Nat</code> to <code>Int</code> because <code>mul_sub</code> doesn't apply for <code>Nat</code>)</p>",
        "id": 544218230,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760117290
    },
    {
        "content": "<p><code>rw</code> isnt the same as <code>simp</code></p>",
        "id": 544218297,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760117320
    },
    {
        "content": "<p>So, that is defining a new tactic, rather  than a simpset, right?</p>",
        "id": 544218464,
        "sender_full_name": "Miguel Marco",
        "timestamp": 1760117391
    },
    {
        "content": "<p>this should definitely be possible to declare a simp extension with all its theorems at the declaring site</p>",
        "id": 544218582,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760117434
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"461731\">Miguel Marco</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Creating.20rw.2Fsimp.20sets.20.22on.20the.20fly.22/near/544218464\">said</a>:</p>\n<blockquote>\n<p>So, that is defining a new tactic, rather  than a simpset, right?</p>\n</blockquote>\n<p>yes</p>",
        "id": 544218731,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760117476
    },
    {
        "content": "<p>this happens in mathlib all the time</p>",
        "id": 544218781,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760117487
    },
    {
        "content": "<p>I think the simplest to do it (if you know metaprogramming) would be</p>\n<ul>\n<li>obtain a simp extension with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.mkSimpExt#doc\">docs#Lean.Meta.mkSimpExt</a> (unfortunately this starts you out with an empty extension)</li>\n<li>add all the theorems with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.addSimpTheorem#doc\">docs#Lean.Meta.addSimpTheorem</a></li>\n<li>register it to the simp extension map by using <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=ST.Ref.modify#doc\">docs#ST.Ref.modify</a> to <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Std.HashMap.insert#doc\">docs#Std.HashMap.insert</a> it into <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Meta.simpExtensionMapRef#doc\">docs#Lean.Meta.simpExtensionMapRef</a></li>\n</ul>",
        "id": 544220247,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1760118057
    },
    {
        "content": "<p>Well, the usual thing is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- My attribute doc-string -/</span>\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">mySimpExtension</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimpExtension</span><span class=\"w\"> </span><span class=\"bp\">‚Üê</span><span class=\"w\"> </span><span class=\"n\">registerSimpAttr</span><span class=\"w\"> </span><span class=\"ss\">`special_simps</span><span class=\"w\"> </span><span class=\"s2\">\"Special simps\"</span>\n</code></pre></div>\n<p>and then use <code>@[special_simps]</code> or <code>attribute [special_simps] thm1 thm2 thm3</code> for tagging theorems and finally use <code>simp only [special_simps]</code> (note that you can't use the attribute in the file with the <code>initialize</code> directly though but only in a file that imports it)</p>",
        "id": 544221194,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1760118471
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Creating.20rw.2Fsimp.20sets.20.22on.20the.20fly.22/near/544221194\">said</a>:</p>\n<blockquote>\n<p>note that you can't use the attribute in the file with the <code>initialize</code> directly</p>\n</blockquote>\n<p>yeah, I find this a very annoying \"feature\"</p>",
        "id": 544221320,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760118536
    },
    {
        "content": "<p>can I declare inside a file that I want Lean to treat the code afterwards as part of a new file?</p>",
        "id": 544221365,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1760118551
    },
    {
        "content": "<p>No.</p>",
        "id": 544853804,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1760485940
    },
    {
        "content": "<p>This is of course an unsurprising answer! But it is on the face of it a bit weird that you can't use the attributes in the file where you define them.</p>",
        "id": 545082653,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1760551933
    }
]