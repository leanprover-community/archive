[
    {
        "content": "<p>the idea is to extract the necessary code to make a self-contained runnable example.</p>\n<p>Say we have code to sum a function like</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sum</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">xs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>\n<p>Then running the desired code would give a file that exposes the definitions of foldl and maybe of List. </p>\n<p>This is for <a href=\"http://verilib.org\">verilib.org</a>, to allow 'atomizing' code so people can pull out single verified definitions instead of a whole project, at the cost of a bunch of essentially copy-pasted code coming along for the ride.</p>",
        "id": 488776373,
        "sender_full_name": "Alok Singh",
        "timestamp": 1734072715
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Util/FoldConsts.html#Lean.Expr.getUsedConstants\">https://leanprover-community.github.io/mathlib4_docs/Lean/Util/FoldConsts.html#Lean.Expr.getUsedConstants</a></p>",
        "id": 488781945,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1734075527
    },
    {
        "content": "<p>The ones that work on an element of <code>Lean.ConstantInfo</code> are more specifically \"of a def\".</p>",
        "id": 488782028,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1734075585
    },
    {
        "content": "<p>May be more helpful since it's not obvious how to get names to resolve:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"#go\"</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#go\"</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">resolveGlobalConst</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"no declar found for {n}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">hd</span><span class=\"w\"> </span><span class=\"bp\">::</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">constInfo</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">hd</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">deps</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">constInfo</span><span class=\"bp\">.</span><span class=\"n\">getUsedConstantsAsSet</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"deps := {deps.toArray}\"</span>\n\n<span class=\"bp\">#</span><span class=\"n\">go</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"bp\">.</span><span class=\"n\">mul</span>\n</code></pre></div>",
        "id": 488785450,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1734077137
    },
    {
        "content": "<p>That’s not the transitive deps, just the immediate deps</p>",
        "id": 488815153,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734087668
    },
    {
        "content": "<p>The ImportGraph package has some helper functions for the transitive closure of deps</p>",
        "id": 488816697,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1734088200
    },
    {
        "content": "<p>Here is the relevant function: <a href=\"https://github.com/leanprover-community/import-graph/blob/ed3b856bd8893ade75cafe13e8544d4c2660f377/ImportGraph/RequiredModules.lean#L65\">https://github.com/leanprover-community/import-graph/blob/ed3b856bd8893ade75cafe13e8544d4c2660f377/ImportGraph/RequiredModules.lean#L65</a></p>",
        "id": 488830061,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734093176
    },
    {
        "content": "<p>or for a single name instead of a <code>NameSet</code>: <a href=\"https://github.com/leanprover-community/import-graph/blob/ed3b856bd8893ade75cafe13e8544d4c2660f377/ImportGraph/RequiredModules.lean#L81\">https://github.com/leanprover-community/import-graph/blob/ed3b856bd8893ade75cafe13e8544d4c2660f377/ImportGraph/RequiredModules.lean#L81</a></p>",
        "id": 488830197,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734093240
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243562\">Adam Topaz</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/transitive.20deps.20of.20a.20def.3F/near/488815153\">said</a>:</p>\n<blockquote>\n<p>That’s not the transitive deps, just the immediate deps</p>\n</blockquote>\n<p>Touche; it should recursively map over the results. I wasn't aware there was an import graph library, that's good to know.</p>",
        "id": 488899514,
        "sender_full_name": "Chris Bailey",
        "timestamp": 1734115064
    },
    {
        "content": "<p>Works well (thanks Johan and Adam), now I'm looking to get line/col numbers for a definition.</p>",
        "id": 489314592,
        "sender_full_name": "Alok Singh",
        "timestamp": 1734374342
    },
    {
        "content": "<p>Is there a function that does this? Given a declaration, extract the line/column/file name where it was defined?</p>",
        "id": 489598828,
        "sender_full_name": "Alok Singh",
        "timestamp": 1734483437
    },
    {
        "content": "<p>This info will be present in the info trees.</p>",
        "id": 489599539,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1734483849
    },
    {
        "content": "<p>Thanks, digging into how to construct/extract such a tree now. I found <a href=\"https://github.com/adamtopaz/lean_extras\">https://github.com/adamtopaz/lean_extras</a> (how appropriate) and am reading through it now.</p>",
        "id": 489600783,
        "sender_full_name": "Alok Singh",
        "timestamp": 1734484778
    },
    {
        "content": "<p>There was also <a href=\"#narrow/channel/270676-lean4/topic/Return.20definition.20of.20a.20declaration.3F/near/480819355\">this previous thread</a>.</p>",
        "id": 489937955,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1734606768
    }
]