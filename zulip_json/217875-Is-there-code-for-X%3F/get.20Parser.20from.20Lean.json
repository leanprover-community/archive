[
    {
        "content": "<p>When I was writing a parser, I realized that since Lean comes equipped with powerful parser combinators, it would be great if I could leverage them to obtain a parser more easily.</p>\n<p>With that in mind, I attempted to construct a parser based on Lean’s own parser. The attempt was somewhat successful, but I have the following concerns:</p>\n<ol>\n<li>\n<p><code>parseArith</code> ended up being an <code>unsafe</code> function.</p>\n</li>\n<li>\n<p>The return value of <code>parseArith</code> is wrapped in the <code>TermElabM</code> monad. Ideally, I would like to implement it as a function of type <code>String → Arith</code>.</p>\n</li>\n</ol>\n<p>Is there any way to address these issues?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"sd\">/-- A set of binary operations -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Addition -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Multiplication -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mul</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"sd\">/-- Arithmetic expressions -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Numeric literal -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Application of a binary operator -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- Syntax category for `Arith` -/</span>\n<span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- Custom syntax for easily writing `Arith` expressions -/</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"[arith|\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- A numeric literal is treated as an arithmetic expression</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Arithmetic expressions connected with `+` or `*` are expressions</span>\n<span class=\"w\">  </span><span class=\"c1\">-- The precedence of `+` and `*` is specified</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"s2\">\" * \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Expressions enclosed in parentheses are expressions</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">])</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"sd\">/-- Parse a string using Lean's parser and return an `Arith` expression -/</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`term</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"[arith| {input}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">expr</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"s2\">\"1 + 2\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">actual</span>\n</code></pre></div>",
        "id": 529694713,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753024484
    },
    {
        "content": "<p>I would be happy if I could obtain a parsing function of type <code>String → Arith</code>, even if it has to be <code>unsafe</code>.</p>",
        "id": 529695460,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753025317
    },
    {
        "content": "<p>You can actually do it quite manually:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Parser</span>\n\n<span class=\"sd\">/-- A set of binary operations -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Addition -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Multiplication -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mul</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"sd\">/-- Arithmetic expressions -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Numeric literal -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Application of a binary operator -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">arithParser</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">num</span>\n<span class=\"w\">  </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TrailingParser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trailing_parser</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">arithParser</span><span class=\"w\"> </span><span class=\"mi\">31</span>\n<span class=\"w\">  </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TrailingParser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">trailing_parser</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"s2\">\" * \"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">arithParser</span><span class=\"w\"> </span><span class=\"mi\">36</span>\n<span class=\"w\">  </span><span class=\"n\">paren</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">leading_parser</span><span class=\"o\">:</span><span class=\"n\">maxPrec</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">arithParser</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span>\n\n<span class=\"w\">  </span><span class=\"n\">arithParserFnCore</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ParserFn</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"n\">prattParser</span><span class=\"w\"> </span><span class=\"ss\">`arith</span><span class=\"w\"> </span><span class=\"n\">parsingTables</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">default</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkAntiquot</span><span class=\"w\"> </span><span class=\"s2\">\"arith\"</span><span class=\"w\"> </span><span class=\"ss\">`arith</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">isPseudoKind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">))</span><span class=\"bp\">.</span><span class=\"n\">fn</span>\n<span class=\"w\">  </span><span class=\"n\">arithParser</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">    </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">fn</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">adaptCacheableContextFn</span><span class=\"w\"> </span><span class=\"o\">({</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"k\">with</span><span class=\"w\"> </span><span class=\"n\">prec</span><span class=\"w\"> </span><span class=\"o\">})</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">withCacheFn</span><span class=\"w\"> </span><span class=\"ss\">`arith</span><span class=\"w\"> </span><span class=\"n\">arithParserFnCore</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">parsingTables</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">PrattParsingTables</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">trailingParsers</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">trailingTable</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"bp\">`«+»</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">`«*»</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"mi\">30</span><span class=\"o\">)]</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">    </span><span class=\"n\">leadingParsers</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">leadingTable</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[(</span><span class=\"bp\">`«$»</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maxPrec</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"ss\">`num</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maxPrec</span><span class=\"o\">),</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">`«</span><span class=\"o\">(</span><span class=\"bp\">»</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">paren</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maxPrec</span><span class=\"o\">)]</span><span class=\"bp\">.</span><span class=\"n\">foldl</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">elabArith</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">parseArith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabArith</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabArith</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">parseArith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">b</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabArith</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabArith</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">parseArith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">parseArith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">elabArith</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"unexpected syntax\"</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Insert</span><span class=\"w\"> </span><span class=\"n\">Token</span><span class=\"w\"> </span><span class=\"n\">TokenTable</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"bp\">.</span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">⟩</span>\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Singleton</span><span class=\"w\"> </span><span class=\"n\">Token</span><span class=\"w\"> </span><span class=\"n\">TokenTable</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">insert</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">∅⟩</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">arithFromString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafe</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"c1\">-- we won't use it, right?</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tokens</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TokenTable</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"s2\">\"$\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"+\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"s2\">\"*\"</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"bp\">.</span><span class=\"n\">fn</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkInputContext</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ParserModuleContext</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">anonymous</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"n\">tokens</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkParserState</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">hasError</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">errorMsg</span><span class=\"bp\">.</span><span class=\"n\">get!</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">  </span><span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">elabArith</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">state</span><span class=\"bp\">.</span><span class=\"n\">stxStack</span><span class=\"bp\">.</span><span class=\"n\">back</span><span class=\"bp\">⟩</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">arithFromString</span><span class=\"w\"> </span><span class=\"s2\">\"(3 + 2) * 5\"</span>\n</code></pre></div>\n<p>That way you have a pure function. Also, the <code>unsafe</code> term prevents <code>unsafe</code> propagation, i.e. you can have unsafe code within safe code.</p>",
        "id": 529706299,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753037329
    },
    {
        "content": "<p>oh, nice… Are you a magician?</p>\n<p>why you use Parser, instead of ParserDescr?</p>",
        "id": 529715520,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753049255
    },
    {
        "content": "<p>Is it impossible by using syntax command?</p>",
        "id": 529745018,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753066994
    },
    {
        "content": "<p>alternatively, is it impossible to get Parser from ParserDescr?</p>",
        "id": 529745068,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753067059
    },
    {
        "content": "<p>You can use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Parser.compileParserDescr#doc\">docs#Lean.Parser.compileParserDescr</a> but you need <code>ImportM</code> context for that (in particular an <code>Environment</code>).</p>",
        "id": 529882800,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753101762
    },
    {
        "content": "<p>So not really usable in pure code</p>",
        "id": 529882828,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753101773
    },
    {
        "content": "<p>The code above is roughly what Lean does internally.</p>",
        "id": 529882881,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753101795
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> How would you run an <code>ImportM</code> action in impure code? So that you can use the <code>syntax</code> command.</p>",
        "id": 530684930,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753414246
    },
    {
        "content": "<p>I tried to create an environment with</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`MyModule</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n</code></pre></div>\n<p>But it keeps saying <code>unknown parser category</code> when I tried to run a category parser.</p>",
        "id": 530706873,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753427167
    },
    {
        "content": "<p>Can you provide a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> ?</p>",
        "id": 530762839,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1753446434
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span>  Here's a MWE<br>\n<code>Scratch/Basic.lean</code></p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span>\n\n<span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">plus</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">50</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">51</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n<span class=\"kn\">scoped</span><span class=\"w\"> </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">expandArith</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TSyntax</span><span class=\"w\"> </span><span class=\"ss\">`term</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">i</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">mkStrLit</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"bp\">.</span><span class=\"n\">toString</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">ident</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e1</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e2</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e1</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">expandArith</span><span class=\"w\"> </span><span class=\"n\">e1</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e2</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">expandArith</span><span class=\"w\"> </span><span class=\"n\">e2</span>\n<span class=\"w\">    </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">plus</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e1</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">expandArith</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArithFromString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CoreM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`arith</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">expandArith</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">stx</span><span class=\"bp\">⟩</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{(Syntax.prettyPrint stx)}\"</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">msg</span>\n\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#parse_arith_local\"</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">:</span><span class=\"n\">str</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">liftCoreM</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">parseArithFromString</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">getString</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"n\">e</span>\n\n<span class=\"c1\">-- this works as expected</span>\n<span class=\"bp\">#</span><span class=\"n\">parse_arith_local</span><span class=\"w\"> </span><span class=\"s2\">\"a + (b + c)\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArithFromStringIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Scratch.Basic</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">parseArithFromString</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toFileMap</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parse</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"o\">})</span><span class=\"bp\">.</span><span class=\"n\">toIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"unexpected error\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span>\n\n<span class=\"c1\">-- this does not work</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">parseArithFromStringIO</span><span class=\"w\"> </span><span class=\"s2\">\"a + (b + c)\"</span>\n</code></pre></div>",
        "id": 530828648,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753468575
    },
    {
        "content": "<p>Well you can't import yourself :-) That'd be recursive</p>",
        "id": 530838899,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753473001
    },
    {
        "content": "<p>I've tried doing this from a separate module as well. I can only get it to work if the <code>syntax</code> commands are not <code>scoped</code>. So something like this defined in <code>Main.lean</code> will work as expected:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArithFromStringIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Scratch.Basic</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loadExts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">parseArithFromString</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toFileMap</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Scratch.Arith</span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parse</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"o\">})</span><span class=\"bp\">.</span><span class=\"n\">toIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"unexpected error\"</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">s</span>\n</code></pre></div>\n<p>But I have to remove the <code>scoped</code> keywords from the <code>syntax</code> declaration.</p>",
        "id": 530844320,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753475476
    },
    {
        "content": "<p>I assume the issue is I'm not correctly opening the namespace in the meta functions?</p>",
        "id": 530844586,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753475591
    },
    {
        "content": "<p>I expected this to solve the namespace issue but it doesn't work either:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt;input&gt;\"</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"bp\">.</span><span class=\"n\">toFileMap</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">openDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">.</span><span class=\"n\">simple</span><span class=\"w\"> </span><span class=\"ss\">`Arith</span><span class=\"w\"> </span><span class=\"o\">[]]</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">parse</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"o\">})</span><span class=\"bp\">.</span><span class=\"n\">toIO</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">userError</span><span class=\"w\"> </span><span class=\"s2\">\"unexpected error\"</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 530846820,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753476647
    },
    {
        "content": "<p>There seems to be something called <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.activateScoped#doc\">docs#Lean.activateScoped</a></p>",
        "id": 530846965,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753476720
    },
    {
        "content": "<p>What about adding <code>activateScoped `Arith</code> at the top of <code>parseArithFromString</code> instead?</p>",
        "id": 530847326,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753476931
    },
    {
        "content": "<p>That worked! Thank you so much <span aria-label=\"thank you\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"thank you\">:thank_you:</span></p>",
        "id": 530847542,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753477028
    },
    {
        "content": "<p>I feel like just gained a whole new level of respect for Lean's meta-programming abilities. I thought this setup would need to be a lot more hacky. But this is actually quite nice!</p>",
        "id": 530849138,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753477789
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"873547\">Robin Arnez</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/get.20Parser.20from.20Lean/near/530838899\">said</a>:</p>\n<blockquote>\n<p>Well you can't import yourself :-) That'd be recursive</p>\n</blockquote>\n<p>The self-import actually seems to work in some cases, which blows my mind.</p>",
        "id": 530849946,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753478175
    },
    {
        "content": "<p>Heh I guess if it has a compiled version already</p>",
        "id": 530850080,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753478237
    },
    {
        "content": "<p>But then anybody else building your project won't be able to</p>",
        "id": 530850138,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753478265
    },
    {
        "content": "<p>Just check again after running <code>lake clean</code>. It seems like self-imports are fine if the function where this happens is called from a different file. Wild!</p>",
        "id": 530851151,
        "sender_full_name": "Paul Mure",
        "timestamp": 1753478809
    },
    {
        "content": "<p>Does that mean it is also possible to implement <code>parseArith</code> as a function of type <code>String → IO Arith</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"sd\">/-- A set of binary operations -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Addition -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Multiplication -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mul</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"sd\">/-- Arithmetic expressions -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Numeric literal -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Application of a binary operator -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- Syntax category for `Arith` -/</span>\n<span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- Custom syntax for easily writing `Arith` expressions -/</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"[arith|\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- A numeric literal is treated as an arithmetic expression</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Arithmetic expressions connected with `+` or `*` are expressions</span>\n<span class=\"w\">  </span><span class=\"c1\">-- The precedence of `+` and `*` is specified</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"s2\">\" * \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Expressions enclosed in parentheses are expressions</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">])</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"sd\">/-- Parse a string using Lean's parser and return an `Arith` expression -/</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`term</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"[arith| {input}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">expr</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">actual</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"s2\">\"1 + 2\"</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">actual</span>\n</code></pre></div>",
        "id": 530876069,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753494683
    },
    {
        "content": "<p>hmm... why \"incomplete case\" error occurs?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"sd\">/-- A set of binary operations -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Addition -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Multiplication -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mul</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"sd\">/-- Arithmetic expressions -/</span>\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Numeric literal -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"sd\">/-- Application of an operator -/</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- Syntax category for `Arith` -/</span>\n<span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"sd\">/-- Syntax to define `Arith` expressions more readably -/</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"[arith|\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Numeric literals are expressions</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Expressions joined with `+` or `*` are expressions</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Set parse precedence for `+` and `*`</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"s2\">\" * \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"c1\">-- Expressions enclosed in parentheses are expressions</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"kn\">macro_rules</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">])</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)])</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">([</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">])</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"w\"> </span><span class=\"n\">Qq</span>\n\n<span class=\"sd\">/-- Use Lean's parser to parse a string into an `Arith` expression -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ofExcept</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`term</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"[arith| {input}]\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">evalExpr</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">(</span><span class=\"n\">Arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">expr</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">unsafeRun</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Type</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">α</span><span class=\"w\"> </span><span class=\"n\">m</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafe</span>\n<span class=\"w\">  </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">unsafeRun</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">TermElabM</span><span class=\"bp\">.</span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"n\">input</span>\n\n<span class=\"c\">/-</span><span class=\"cm\"> Incomplete case error occurs -/</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"s2\">\"1 + 2 * 3\"</span>\n</code></pre></div>",
        "id": 531734536,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753843270
    },
    {
        "content": "<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/Lean/Elab/Term.html#Lean.Elab.Term.TermElabM.toIO\">Lean.Elab.Term.TermElabM.toIO</a> is useful here ....?</p>",
        "id": 531739323,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753846296
    },
    {
        "content": "<p><code>TermElabM α</code> and <code>α</code> are not compatible, <code>TermElabM</code> is</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">    </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">      </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">        </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span>\n<span class=\"w\">          </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">Context</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">ST</span><span class=\"bp\">.</span><span class=\"n\">Ref</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Core</span><span class=\"bp\">.</span><span class=\"n\">State</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"bp\">→</span><span class=\"w\"> </span><span class=\"n\">EStateM</span><span class=\"bp\">.</span><span class=\"n\">Result</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">RealWorld</span><span class=\"w\"> </span><span class=\"n\">α</span>\n</code></pre></div>",
        "id": 531788550,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753866260
    },
    {
        "content": "<p>You can't really run a <code>TermElabM</code> in pure code</p>",
        "id": 531788683,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753866295
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 531791560,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753867174
    },
    {
        "content": "<p>Then, would it be possible to define a parser function of type <code>String → IO Arith</code>?<br>\nIf so, I think we could use an unsafe function of type <code>IO α → α</code> to create a function of type <code>String → Arith</code>.</p>",
        "id": 531829398,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1753878300
    },
    {
        "content": "<p>You need an environment which is a bit difficult to get unless you have the necessary olean files somewhere. In other words, it's pretty difficult to make this into an standalone executable.</p>",
        "id": 531841170,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753881528
    },
    {
        "content": "<p>That being said; nobody prevents you from using <code>Lean.mkEmptyEnvironment</code> and adding everything necessary yourself.</p>",
        "id": 531841630,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1753881643
    },
    {
        "content": "<p>I've resolved this problem!!! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>\n<p>Thank you for everyone</p>",
        "id": 543485978,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759830010
    },
    {
        "content": "<h2>How to resolve this?</h2>\n<p>first, make a file named <code>Project/Syntax.lean</code> with following content:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">add</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">mul</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">inductive</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">op</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">lhs</span><span class=\"w\"> </span><span class=\"n\">rhs</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Arith</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">Repr</span>\n\n<span class=\"kn\">section</span><span class=\"w\"> </span><span class=\"n\">arith_syntax</span>\n\n<span class=\"w\">  </span><span class=\"n\">declare_syntax_cat</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"s2\">\"[arith| \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\"]\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span>\n\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">30</span><span class=\"w\"> </span><span class=\"s2\">\" + \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">31</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">35</span><span class=\"w\"> </span><span class=\"s2\">\" * \"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"o\">:</span><span class=\"mi\">36</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"kn\">syntax</span><span class=\"o\">:</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"s2\">\"(\"</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"s2\">\")\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">check_failure</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">check_failure</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">]</span>\n<span class=\"w\">  </span><span class=\"bp\">#</span><span class=\"n\">check_failure</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"o\">]</span>\n\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">arith_syntax</span>\n</code></pre></div>",
        "id": 543486270,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759830090
    },
    {
        "content": "<p>Next, create a file as following:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">LeanByExample</span><span class=\"bp\">.</span><span class=\"n\">Playground</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">partial</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">mkArith</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkArith</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkArith</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">l</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">r</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"bp\">.</span><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"n\">Op</span><span class=\"bp\">.</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkArith</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkArith</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">arith</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">e</span><span class=\"o\">:</span><span class=\"n\">arith</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">mkArith</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">throw</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"unexpected syntax: {stx}\"</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArithOfEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">runParserCategory</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"ss\">`arith</span><span class=\"w\"> </span><span class=\"n\">s</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">arith</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkArith</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">arith</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getEnvIO</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Project.Syntax</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loadExts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">env</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">unsafe</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">unsafeIO</span><span class=\"w\"> </span><span class=\"n\">getEnvIO</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">unsafeCast</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">env</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Except</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"n\">Arith</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">parseArithOfEnv</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">environment</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">parseArith</span><span class=\"w\"> </span><span class=\"s2\">\"1 + 2 * 3\"</span>\n</code></pre></div>",
        "id": 543486516,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759830161
    },
    {
        "content": "<p>btw the safe way to get <code>environment</code> is to</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Project.Syntax</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loadExts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 543486964,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759830287
    },
    {
        "content": "<p>But then you can't use it in the same file, only in files that import the file containing <code>parseArith</code></p>",
        "id": 543487162,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1759830339
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> </p>\n<p>Thank you but your code doesn't work when I run this by <code>lake exe</code>.</p>",
        "id": 543568598,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759852662
    },
    {
        "content": "<p>This is a file named <code>LeanByExample/Declarative/Syntax/Environment.lean</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">LeanByExample</span><span class=\"bp\">.</span><span class=\"n\">Declarative</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`LeanByExample.Declarative.Syntax.Syntax</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">env_of_arith_stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span>\n<span class=\"w\">  </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">fileName</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loadExts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 543568796,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759852709
    },
    {
        "content": "<p>My lakefile is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean_exe</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`Exe.Declarative.Syntax.Parse</span>\n</code></pre></div>\n<p>The content of <code>Exe.Declarative.Syntax.Parse</code> is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">LeanByExample</span><span class=\"bp\">.</span><span class=\"n\">Declarative</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Environment</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">IO</span><span class=\"bp\">.</span><span class=\"n\">println</span><span class=\"w\"> </span><span class=\"s2\">\"Hello, Lean!\"</span>\n</code></pre></div>\n<p>Then this fails:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">parse</span>\n</code></pre></div>",
        "id": 543569055,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759852785
    },
    {
        "content": "<p>error message of <code>lake exe parse</code> is:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"k\">by</span><span class=\"bp\">-</span><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"bp\"></span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"bp\">$!?</span><span class=\"o\">]</span>\n<span class=\"bp\">❯</span><span class=\"w\"> </span><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">parse</span>\n<span class=\"n\">uncaught</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"kn\">prefix</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">LeanByExample'</span>\n\n<span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">LeanByExample'</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">LeanByExample</span><span class=\"bp\">.</span><span class=\"n\">olean'</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">search</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"n\">entries</span><span class=\"o\">:</span>\n</code></pre></div>",
        "id": 543569226,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759852828
    },
    {
        "content": "<p><code>importModules</code> is not compatible with <code>lake exe</code>?</p>",
        "id": 543572515,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759853750
    },
    {
        "content": "<p>I think you need to set <code>supportInterpreter := true</code> in your lakefile for the exe.</p>",
        "id": 543572648,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759853795
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> Thank you, but still same error occurs</p>",
        "id": 543572921,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759853879
    },
    {
        "content": "<p>do you have a repo on github with your project that I could look at?</p>",
        "id": 543573059,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759853925
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> Here: <a href=\"https://github.com/lean-ja/lean-by-example/tree/problematic\">https://github.com/lean-ja/lean-by-example/tree/problematic</a> (not <code>main</code> branch)</p>",
        "id": 543573359,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759854002
    },
    {
        "content": "<p>checkout and run <code>lake exe parse</code></p>",
        "id": 543573400,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759854011
    },
    {
        "content": "<p>okay, thanks. I don't have time to look right now, but I'll try to do it soon.</p>",
        "id": 543573730,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759854102
    },
    {
        "content": "<p>If you want to come up with a more minimal example where it fails, that would be helpful.</p>",
        "id": 543573767,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759854114
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 543573898,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759854153
    },
    {
        "content": "<p>I will create MWE when I have a time, ok</p>",
        "id": 543573981,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759854180
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> </p>\n<p>I've made a MWE.<br>\nsee <a href=\"https://github.com/Seasawher/mwe-environment-error\">https://github.com/Seasawher/mwe-environment-error</a> and run <code>lake exe mwe-environment-error</code></p>",
        "id": 543575244,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759854524
    },
    {
        "content": "<p>Hmmm... I've never tried initializing an environment like that. Why do you need to do that instead of just using <code>importModules</code> in your <code>main</code> function?</p>",
        "id": 543581132,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759856240
    },
    {
        "content": "<p>to make it faster.</p>",
        "id": 543581403,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759856324
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> proposed using initialize block for Environment. This remove unsafe code and make it faster. (Thanks)</p>\n<p>why lake exe fails? Is this a bug?</p>",
        "id": 543582241,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759856552
    },
    {
        "content": "<p>I don't know enough about the internals of the compiler to understand why this fails.</p>",
        "id": 543582441,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759856611
    },
    {
        "content": "<p>ok. Who to ask..? Who has the knowledge on this problem…?</p>",
        "id": 543582744,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759856700
    },
    {
        "content": "<p>The people in #**lean4&gt;  ?</p>",
        "id": 543585184,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1759857394
    },
    {
        "content": "<p>who is working on compiler?</p>",
        "id": 543587317,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759858130
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> Please help me?</p>",
        "id": 543587996,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759858335
    },
    {
        "content": "<p>I think your best bet is indeed to ask in <a class=\"stream\" data-stream-id=\"270676\" href=\"/#narrow/channel/270676-lean4\">#lean4</a>. I'm afraid the answer is going to be \"you can't do it this way, and you should use <code>importModules</code> directly in your <code>IO</code> function\"</p>",
        "id": 543588009,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759858340
    },
    {
        "content": "<p>A couple of things, for one, if you want to actually do this our <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> has already done a library for this in the past: <a href=\"https://github.com/tydeu/lean4-partax\">https://github.com/tydeu/lean4-partax</a>. As for this thing, it's a matter of setting up the search path environment variable correctly I think.</p>",
        "id": 543592862,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1759860048
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> Thank you!</p>\n<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> partax seems to be not updated for long time.  Is there small fix to my code? </p>\n<p>I want to obtain a parser on String from Lean’s builtin parser. And I want to use syntax command and declare_syntax_cat command because they are easy to use for me.</p>",
        "id": 543598478,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759861986
    },
    {
        "content": "<p>And how to fix the search path environment variable?</p>",
        "id": 543599280,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759862306
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">env_of_arith_stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">initSearchPath</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findSysroot</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"n\">importModules</span><span class=\"w\"> </span><span class=\"bp\">#</span><span class=\"o\">[{</span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`MweEnvironmentError.Basic</span><span class=\"o\">}]</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">loadExts</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>This seems to work.</p>",
        "id": 543604310,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759864304
    },
    {
        "content": "<p>And indeed that was the only issue. <code>importModules</code> runs in <code>IO</code>, and you need to tell lean where to find the oleans so that it can find <code>MweEnvironmentError.Basic</code>'s olean.</p>",
        "id": 543604464,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1759864362
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> Thank you!!!</p>",
        "id": 543644051,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759885397
    },
    {
        "content": "<p>deleted</p>",
        "id": 543659435,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759899170
    },
    {
        "content": "<p>deleted</p>",
        "id": 543659906,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759899554
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> <span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> </p>\n<p>When <code>supportInterpreter := true</code> is set, then we can not evaluate compiled binary  directly...?<br>\nIs it impossible to obtain the <code>Environment</code> in the way described above while still keeping the condition that the compiled binary can be executed directly?</p>",
        "id": 543854377,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759971617
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626349\">@Asei Inoue</span> What do you mean by \"can not evaluate the compile binary directly\"?  There are two distinct limitations here:</p>\n<ul>\n<li>With <code>supportIntepreter := true</code>,  Lean is dynamically rather than statically linked to the executable. Thus, to run the executable, <code>libleanshared</code> needs to be available on the system (e.g., in the same directory or in the library path). </li>\n<li>Separately, to use <code>importModules</code> in an executable, the imported module oleans need to be available via <code>LEAN_PATH</code> when the executable is run.</li>\n</ul>\n<p>You can avoid importing modules to run a parser if that parser is builtin (e.g., <code>@[builtin_arith_parser]</code> for your example).</p>",
        "id": 543854819,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759971978
    },
    {
        "content": "<p>In my free time, I have been writing a toy Python interpreter in Lean. The grammar for it is also currently written via <code>syntax</code> and I compile these to builtin parsers , which can then be run in an executable. The code for this may be of interest to you: see <a href=\"https://github.com/tydeu/leanpy/blob/eaffff3f9d598ac9226d99186143bde4c90e4954/LeanPy/Cli/EvalFile.lean#L50\">here</a>.</p>",
        "id": 543855086,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759972181
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> <br>\nThank you for your reply.</p>\n<blockquote>\n<p>What do you mean by \"can not evaluate the compile binary directly\"?</p>\n</blockquote>\n<p><code>.\\.lake\\build\\bin\\mwe.exe</code> in shell does not work. (<code>mwe</code> is exeName)</p>\n<p>see: <a href=\"https://github.com/Seasawher/mwe-environment-error\">https://github.com/Seasawher/mwe-environment-error</a></p>",
        "id": 543855148,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759972233
    },
    {
        "content": "<blockquote>\n<p>You can avoid import modules to run a parser if that parser is builtin</p>\n</blockquote>\n<p>I'm interested in this. How can I make my parser builtin?</p>",
        "id": 543855296,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759972367
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626349\">@Asei Inoue</span> Ah, so you are on Windows. In that case, you need Lean's shared libaries to be collocated with your executable when you run it (or in <code>PATH</code>). When distirbuting an executable on Windows, the usual approach is to have an installer that ships the executable along with its necessary shared libraries (and any other resources the executable uses).</p>",
        "id": 543855303,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759972373
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/get.20Parser.20from.20Lean/near/543855296\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>You can avoid import modules to run a parser if that parser is builtin</p>\n</blockquote>\n<p>I'm interested in this. How can I make my parser builtin?</p>\n</blockquote>\n<p>Upon reflection, while it is may be possible to make your parser builitin, I do not think that would be sufficient for your use case. You are also attempting to evaluate the syntax into an <code>Arith</code> expression via term macros, and that kind of evaluation cannot be builtin in the desired way. Thus, you would still need to <code>importModules</code>.</p>\n<p>If you defined a custom elaboration attribute and used custom elaborators to build your <code>Arith</code>, you could make both the parsers and the elaborators work around this. However, that is rather complex, and I am not confident that the steps can be well-explained simply through Zulip messages. Hopefully, one day, Lean will have a guide for this kind of thing, but it does not right now.</p>",
        "id": 543856295,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759973199
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"315577\">@Mac Malone</span> </p>\n<p>Thank you. By the way, is there another approach?<br>\nFor example, can I dump an Environment term to a file and read a file to get an Environment?<br>\nthen <code>importModules</code> is not needed, I think.</p>",
        "id": 543856634,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759973464
    },
    {
        "content": "<p>That is not possible.</p>",
        "id": 543856664,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759973481
    },
    {
        "content": "<p>(OLeans are the essentially this -- nothing simpler will work here.)</p>",
        "id": 543856684,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759973513
    },
    {
        "content": "<p>Since you are elaborating sophisticated terms in your current code, you need essentially all of what makes Lean, Lean.</p>",
        "id": 543856762,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759973600
    },
    {
        "content": "<p>There are ways parse and elaborate syntax that do not involve elaborating arbitrary terms, but this would lead to signficantly different code than your original example.</p>",
        "id": 543856977,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759973776
    },
    {
        "content": "<p>As such, am not sure it woud still be accomplishing your original goal.</p>",
        "id": 543857022,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759973804
    },
    {
        "content": "<p>so conclusion is:</p>\n<h2>my goal</h2>\n<p>reuse Lean's metaprogramming framework  such as</p>\n<ul>\n<li>parser generated by <code>syntax</code> and <code>declare_syntax_cat</code> </li>\n<li>macro expansion rule defined by <code>macro_rules</code> command</li>\n</ul>\n<p>and get a parser <code>String → Except String α</code> where α is AST</p>\n<h2>restriction</h2>\n<p>This needs <code>importModules</code> and generated binary does not work directly (suitable installer is needed)</p>\n<hr>\n<p>Thank you</p>",
        "id": 543857326,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759974091
    },
    {
        "content": "<p>Sorry I have another question. How to make installer for this?</p>",
        "id": 543857369,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1759974133
    },
    {
        "content": "<p>It has been a long while since I have made a Windows installer, so I am not sure what the best software for this these days is. Perhaps someone else here has some insight (or searching the web might be sufficient).</p>",
        "id": 543862821,
        "sender_full_name": "Mac Malone",
        "timestamp": 1759979076
    }
]