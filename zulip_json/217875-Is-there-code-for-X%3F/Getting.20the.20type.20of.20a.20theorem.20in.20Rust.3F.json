[
    {
        "content": "<p>I'm working on a project where I need to be able to use the types of various theorems from Lean in Rust. For example, if I had</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kd\">@[</span><span class=\"n\">my_export_tag</span><span class=\"kd\">]</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">zero_add_custom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">zero_add</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>\n<p>I would want to receive some structured representation of <code>0 + a = a</code> at compile-time in Rust. (For example, getting the data as something like <code>LeanTree::Eq(LeanTree::Add(LeanTree::Rational(0, 1), LeanTree::Rational('a')), LeanTree::Rational('a'))</code>). Does anything along those lines already exist?</p>\n<p>If something like that doesn't exist, is there a way to en masse export that kind of data as JSON or some other portable format that I can parse into something similar?</p>",
        "id": 485959901,
        "sender_full_name": "Alessandra Simmons",
        "timestamp": 1733262461
    },
    {
        "content": "<p>Does this help?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span>\n\n<span class=\"c1\">-- this probably doesn't produce the Json you want, but you can replace these with custom instances / functions</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span><span class=\"bp\">.</span><span class=\"n\">Preresolved</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Pos</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Substring</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">SourceInfo</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Syntax</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">DataValue</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Literal</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">LevelMVarId</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Level</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">BinderInfo</span>\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MData</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">toJson</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"bp\">.</span><span class=\"n\">toJson</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"bp\">.</span><span class=\"n\">entries</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">ToJson</span><span class=\"w\"> </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Expr</span>\n\n<span class=\"c1\">-- some really thin boilerplate around `inferType`</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"#show_type_json \"</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"bp\">.</span><span class=\"n\">runTermElabM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">vars</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">typ</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Meta</span><span class=\"bp\">.</span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{Lean.ToJson.toJson typ}\"</span>\n\n\n<span class=\"c1\">-- your example</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">zero_add_custom</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">a</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℚ</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">zero_add</span><span class=\"w\"> </span><span class=\"n\">a</span>\n\n<span class=\"bp\">#</span><span class=\"n\">show_type_json</span><span class=\"w\"> </span><span class=\"n\">zero_add_custom</span>\n</code></pre></div>",
        "id": 485963039,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733263610
    },
    {
        "content": "<p>I was about to post a slightly messier version of exactly the same approach. :-)</p>",
        "id": 485963151,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733263656
    },
    {
        "content": "<p>Likely Alessandra wants to drop a lot of this information, and maybe compress iterated <code>Expr.app</code> into an Array of arguments. But it may make sense to do these as JSON-to-JSON transformations, keeping the initial JSON output as faithful as possible to the Lean <code>Expr</code> structure.</p>",
        "id": 485963648,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733263845
    },
    {
        "content": "<p>(The \"bigger picture\" answer to Alessandra's question also being --- no, there isn't something off the shelf for this, but Lean's metaprogramming means that certainly anything in this direction is possible.)</p>",
        "id": 485963807,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733263909
    },
    {
        "content": "<p>I wonder if we should just turn on all those instances above by default, so that next time some asks for <code>#synth Lean.ToJson Lean.Expr</code> it just works.</p>",
        "id": 485964940,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1733264344
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Getting.20the.20type.20of.20a.20theorem.20in.20Rust.3F/near/485963648\">said</a>:</p>\n<blockquote>\n<p>But it may make sense to do these as JSON-to-JSON transformations, keeping the initial JSON output as faithful as possible to the Lean <code>Expr</code> structure.</p>\n</blockquote>\n<p>On the other hand, the transformation might require writing <code>inferType</code> in rust to attach types to subexpressions, in which case doing the processing all on the Lean side is likely to work better</p>",
        "id": 485964977,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733264358
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Getting.20the.20type.20of.20a.20theorem.20in.20Rust.3F/near/485964940\">said</a>:</p>\n<blockquote>\n<p>I wonder if we should just turn on all those instances above by default, so that next time some asks for <code>#synth Lean.ToJson Lean.Expr</code> it just works.</p>\n</blockquote>\n<p>I think the <code>Substring</code> instance is likely dangerous; sometimes you want it to serialize as <code>s.toString</code>, other times you actually want the offset information</p>",
        "id": 485965061,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733264388
    },
    {
        "content": "<p>The <code>Level</code> instance probably would be more user-friendly if it sent <code>.{37}</code> to <code>37</code> rather than</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\"> </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">   </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">     </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">       </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">         </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">          </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">             </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">               </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                 </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                  </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                   </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                    </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                     </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                      </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                       </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                         </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                          </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                           </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                            </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                             </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                              </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                               </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                                </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                                 </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                                  </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                                   </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                                    </span><span class=\"p\">{</span><span class=\"nt\">\"succ\"</span><span class=\"p\">:</span>\n<span class=\"w\">                                     </span><span class=\"s2\">\"zero\"</span><span class=\"p\">}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}</span>\n</code></pre></div>\n</div></div>",
        "id": 485965365,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733264504
    },
    {
        "content": "<p>Similarly for <code>Lean.Literal</code></p>",
        "id": 485965554,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1733264576
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Getting.20the.20type.20of.20a.20theorem.20in.20Rust.3F/near/485963039\">said</a>:</p>\n<blockquote>\n<p>Does this help?</p>\n</blockquote>\n<p>Ah, that's really quite helpful! I'll probably do JSON-to-JSON transformations on something very similar to this, like Kim was recommending. Also,  as a side note, \"wow!\" to instances as a language feature.</p>",
        "id": 485968386,
        "sender_full_name": "Alessandra Simmons",
        "timestamp": 1733265748
    }
]