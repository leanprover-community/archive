[
    {
        "content": "<p>I was working on extracting the arg array of a constant. I found the function <code>getParamNames</code> in the library.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"sd\">/-- Return the parameter names for the given global declaration. -/</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">getParamNames</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">declName</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">forallTelescopeReducing</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstInfo</span><span class=\"w\"> </span><span class=\"n\">declName</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">xs</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">xs</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">localDecl</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">fvarId!</span><span class=\"bp\">.</span><span class=\"n\">getDecl</span>\n<span class=\"w\">      </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">localDecl</span><span class=\"bp\">.</span><span class=\"n\">userName</span>\n</code></pre></div>\n<p>I was trying to make it return not only the userName, but also the type. But the types that depending on local variable appears in the form like <code>_uniq.3</code> if I simply use <code>localDecl.type</code>. </p>\n<p>How to do it correctly?</p>",
        "id": 483008724,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731932971
    },
    {
        "content": "<p>Can you un- <a href=\"https://en.wikipedia.org/wiki/XY_problem\">#xy</a> ?</p>",
        "id": 483016398,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1731934976
    },
    {
        "content": "<p>I have the fullname of a constant and an <code>Environment</code>. What I want to get is the arg array of that constant.</p>\n<p>E.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"n\">Q</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">p</span>\n</code></pre></div>\n<p>I have the fullname <code>test</code> and the environment. I want the desired function <code>getParam</code> to return the arg array as <code>#[(P, Prop), (Q, Prop), (p, P)]</code>. The signature of the function would be <code>Name -&gt; Array (String × String)</code>.</p>",
        "id": 483021403,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731936251
    },
    {
        "content": "<p>If you want to obtain a string you should take a look at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Delaborator.delabConstWithSignature#doc\">docs#Lean.PrettyPrinter.Delaborator.delabConstWithSignature</a></p>",
        "id": 483181735,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1731991749
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"690858\">Daniel Weber</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Extend.20getParamNames/near/483181735\">said</a>:</p>\n<blockquote>\n<p>If you want to obtain a string you should take a look at <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.PrettyPrinter.Delaborator.delabConstWithSignature#doc\">docs#Lean.PrettyPrinter.Delaborator.delabConstWithSignature</a></p>\n</blockquote>\n<p>I found doc-gen4 also use delaborator, but it will exceed time limit for some constants. I'm looking for some other way.</p>",
        "id": 483182694,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731992390
    },
    {
        "content": "<p>I don't think there are other ways to convert an <code>Expr</code> to a <code>String</code> (assuming you don't want to output the whole expression), perhaps you can find the <code>Syntax</code> where it's defined, but that'll be problematic with <code>variable</code>, <code>local notation</code>, etc.</p>",
        "id": 483182944,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1731992518
    },
    {
        "content": "<p>Too bad. I didn't expect it to be that complicated.</p>",
        "id": 483188550,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731996267
    },
    {
        "content": "<p>Why does the delaborator time out? Do you have a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a>?</p>",
        "id": 483188612,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1731996332
    },
    {
        "content": "<p>It's hard to extract a <a href=\"https://leanprover-community.github.io/mwe.html\">#mwe</a> from my code. I was modifying the <code>ExtractData.lean</code> script from LeanDojo. It processes the files in Mathlib one by one. Here is some relevant code:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lake</span>\n\n<span class=\"kn\">namespace</span><span class=\"w\"> </span><span class=\"n\">DocGen</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Stores information about a typed name.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">NameInfo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  The name that has this info attached.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\">  </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  The pretty printed type of this name.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CodeWithInfos</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">An argument to a declaration, e.g. the `(x : Nat)` in `def foo (x : Nat) := x`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Arg</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  The pretty printed binder syntax itself.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">binder</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">CodeWithInfos</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  Whether the binder is implicit.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">implicit</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span>\n\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">A base structure for information about a declaration.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\"> </span><span class=\"kn\">extends</span><span class=\"w\"> </span><span class=\"n\">NameInfo</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"sd\">/--</span>\n<span class=\"sd\">  The list of arguments to the declaration.</span>\n<span class=\"sd\">  -/</span>\n<span class=\"w\">  </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">Arg</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Pretty prints a `Lean.Parser.Term.bracketedBinder`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">prettyPrintBinder</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Syntax</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">PosMap</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">CodeWithInfos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">Parser</span><span class=\"bp\">.</span><span class=\"n\">Term</span><span class=\"bp\">.</span><span class=\"n\">bracketedBinder</span><span class=\"bp\">.</span><span class=\"n\">formatter</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">TaggedText</span><span class=\"bp\">.</span><span class=\"n\">prettyTagged</span><span class=\"w\"> </span><span class=\"n\">fmt</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">    </span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMCtx</span>\n<span class=\"w\">    </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span>\n<span class=\"w\">    </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getCurrNamespace</span>\n<span class=\"w\">    </span><span class=\"n\">openDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOpenDecls</span>\n<span class=\"w\">    </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ngen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getNGen</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">tagCodeInfos</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"n\">tt</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">prettyPrintTermStx</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SubExpr</span><span class=\"bp\">.</span><span class=\"n\">PosMap</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Info</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">CodeWithInfos</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">formatTerm</span><span class=\"w\"> </span><span class=\"n\">stx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tt</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">TaggedText</span><span class=\"bp\">.</span><span class=\"n\">prettyTagged</span><span class=\"w\"> </span><span class=\"n\">fmt</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">    </span><span class=\"n\">mctx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMCtx</span>\n<span class=\"w\">    </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span>\n<span class=\"w\">    </span><span class=\"n\">currNamespace</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getCurrNamespace</span>\n<span class=\"w\">    </span><span class=\"n\">openDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOpenDecls</span>\n<span class=\"w\">    </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">default</span><span class=\"o\">,</span>\n<span class=\"w\">    </span><span class=\"n\">ngen</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getNGen</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Widget</span><span class=\"bp\">.</span><span class=\"n\">tagCodeInfos</span><span class=\"w\"> </span><span class=\"n\">ctx</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"w\"> </span><span class=\"n\">tt</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"bp\">.</span><span class=\"n\">ofConstantVal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ConstantVal</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"n\">Info</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">levelParams</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"n\">mkLevelParam</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"n\">println!</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{v.name}\"</span>\n<span class=\"w\">  </span><span class=\"c1\">-- Use the main signature delaborator. We need to run sanitization, parenthesization, and formatting ourselves</span>\n<span class=\"w\">  </span><span class=\"c1\">-- to be able to extract the pieces of the signature right before they are formatted</span>\n<span class=\"w\">  </span><span class=\"c1\">-- and then format them individually.</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sigStx</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">infos</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">delabCore</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">delab</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"bp\">.</span><span class=\"n\">delabConstWithSignature</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sigStx</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">sanitizeSyntax</span><span class=\"w\"> </span><span class=\"n\">sigStx</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getOptions</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">}</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">sigStx</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">parenthesize</span><span class=\"w\"> </span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"bp\">.</span><span class=\"n\">declSigWithId</span><span class=\"bp\">.</span><span class=\"n\">parenthesizer</span><span class=\"w\"> </span><span class=\"n\">sigStx</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"n\">PrettyPrinter</span><span class=\"bp\">.</span><span class=\"n\">Delaborator</span><span class=\"bp\">.</span><span class=\"n\">declSigWithId</span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"bp\">$_</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">binders</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">type</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sigStx</span>\n<span class=\"w\">    </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"signature pretty printer failure for {v.name}\"</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">binders</span><span class=\"bp\">.</span><span class=\"n\">mapM</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">binder</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">prettyPrintBinder</span><span class=\"w\"> </span><span class=\"n\">binder</span><span class=\"w\"> </span><span class=\"n\">infos</span>\n<span class=\"w\">    </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">Arg</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"n\">fmt</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">!</span><span class=\"n\">binder</span><span class=\"bp\">.</span><span class=\"n\">isOfKind</span><span class=\"w\"> </span><span class=\"ss\">``Parser.Term.explicitBinder</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">prettyPrintTermStx</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"n\">infos</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">toNameInfo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"bp\">.</span><span class=\"n\">name</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">},</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"o\">,</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n<span class=\"kn\">end</span><span class=\"w\"> </span><span class=\"n\">DocGen</span>\n\n<span class=\"bp\">...</span>\n\n<span class=\"sd\">/--</span>\n<span class=\"sd\">Extract premise information from `TermInfo` in `InfoTree`.</span>\n<span class=\"sd\">-/</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">visitTermInfo</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">ti</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TermInfo</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Environment</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TraceM</span><span class=\"w\"> </span><span class=\"n\">Unit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">fullName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">ti</span><span class=\"bp\">.</span><span class=\"n\">expr</span><span class=\"bp\">.</span><span class=\"n\">constName?</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getFileMap</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"bp\">.</span><span class=\"n\">constants</span><span class=\"bp\">.</span><span class=\"n\">find?</span><span class=\"w\"> </span><span class=\"n\">fullName</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"o\">()</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withEnv</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"w\"> </span><span class=\"n\">DocGen</span><span class=\"bp\">.</span><span class=\"n\">Info</span><span class=\"bp\">.</span><span class=\"n\">ofConstantVal</span><span class=\"w\"> </span><span class=\"n\">const</span><span class=\"bp\">.</span><span class=\"n\">toConstantVal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">args</span><span class=\"bp\">.</span><span class=\"n\">map</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"bp\">.</span><span class=\"n\">binder</span><span class=\"bp\">.</span><span class=\"n\">pretty</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">info</span><span class=\"bp\">.</span><span class=\"n\">type</span><span class=\"bp\">.</span><span class=\"n\">pretty</span>\n<span class=\"w\">  </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>This is only part of the code. The process visits every term in that file. I just try to print the constant which caused the time out, but I found that it succeeds when be processed individually. I guess the delaborator's time may be accumulated when processing the whole file?</p>",
        "id": 483191660,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731998284
    },
    {
        "content": "<p>I wonder how to set the maxHeartbeats to be higher. The default is 200000 and I failed to set it with <code>set_option</code>.</p>",
        "id": 483191780,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731998388
    },
    {
        "content": "<p>Here is the error message:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>uncaught<span class=\"w\"> </span>exception:<span class=\"w\"> </span><span class=\"o\">(</span>deterministic<span class=\"o\">)</span><span class=\"w\"> </span>timeout<span class=\"w\"> </span>at<span class=\"w\"> </span><span class=\"sb\">`</span>delab<span class=\"sb\">`</span>,<span class=\"w\"> </span>maximum<span class=\"w\"> </span>number<span class=\"w\"> </span>of<span class=\"w\"> </span>heartbeats<span class=\"w\"> </span><span class=\"o\">(</span><span class=\"m\">200000</span><span class=\"o\">)</span><span class=\"w\"> </span>has<span class=\"w\"> </span>been<span class=\"w\"> </span>reached\nUse<span class=\"w\"> </span><span class=\"sb\">`</span>set_option<span class=\"w\"> </span>maxHeartbeats<span class=\"w\"> </span>&lt;num&gt;<span class=\"sb\">`</span><span class=\"w\"> </span>to<span class=\"w\"> </span><span class=\"nb\">set</span><span class=\"w\"> </span>the<span class=\"w\"> </span>limit.<span class=\"o\">(</span>invalid<span class=\"w\"> </span>MessageData.lazy,<span class=\"w\"> </span>missing<span class=\"w\"> </span>context<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 483193460,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731999362
    },
    {
        "content": "<p>What is the error when you try, say <code>set_option maxHeartbeats 0</code>?</p>",
        "id": 483193853,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1731999564
    },
    {
        "content": "<p><code>set_option maxHeartbeats</code> doesn't work. The scripts is a independent file in the project and is ran by using <code>lake env lean --run</code>.</p>",
        "id": 483194511,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731999861
    },
    {
        "content": "<p>It seems that this option should be passed in another way.</p>",
        "id": 483194566,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1731999897
    },
    {
        "content": "<p>You should place it in the file where you want it to take effect and its effect start from the <code>set_option</code> line.</p>",
        "id": 483194767,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732000005
    },
    {
        "content": "<p>You can limit it to the next declaration via <code>set_option ... in &lt;command&gt;</code>.</p>",
        "id": 483194826,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732000030
    },
    {
        "content": "<p>Oh I found the place where I can modify the config.</p>",
        "id": 483195184,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1732000209
    },
    {
        "content": "<p>For someone who may be interested:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">trace</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">traceM</span><span class=\"bp\">.</span><span class=\"n\">run'</span><span class=\"bp\">.</span><span class=\"n\">toIO</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">fileName</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s!</span><span class=\"s2\">\"{path}\"</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">fileMap</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">FileMap</span><span class=\"bp\">.</span><span class=\"n\">ofString</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">maxHeartbeats</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">2000000000</span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 483195217,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1732000233
    },
    {
        "content": "<p>And it's weird that the <code>2000000000</code> here seems to be <code>2000000</code> in error message.</p>",
        "id": 483195349,
        "sender_full_name": "Yicheng Tao",
        "timestamp": 1732000316
    },
    {
        "content": "<p>There are two \"levels\" of heartBeats: an \"internal\" one that is more fine-grained and a \"user-facing\" one that is <code>&lt;internal&gt;/10^3</code>.</p>",
        "id": 483196014,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1732000636
    }
]