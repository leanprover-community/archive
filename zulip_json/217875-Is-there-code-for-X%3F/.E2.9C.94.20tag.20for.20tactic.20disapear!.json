[
    {
        "content": "<p>I want to make a tactic which uses tag attribute.</p>\n<p>This is a definition of tag attribute.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">myTagAttribute</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TagAttribute</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerTagAttribute</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`my_tag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"test for tag\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I would like to create a tactic that, for every theorem <code>thm</code> tagged with <code>my_tag</code>, tries to execute <code>apply thm</code>, moves on to the next theorem if it fails, and closes the goal if it succeeds. How can I achieve this?</p>",
        "id": 525658579,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750839617
    },
    {
        "content": "<p>I know that all the theorems (Names) tagged with [my_tag] can be enumerated using code like the following, but I don't know what to do after that.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">listAllTagged</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tagAttr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TagAttribute</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">taggedDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tagAttr</span><span class=\"bp\">.</span><span class=\"n\">ext</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">taggedDecls</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tagged</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">listAllTagged</span><span class=\"w\"> </span><span class=\"n\">myTagAttribute</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"decls tagged [my_tag]: {tagged}\"</span>\n</code></pre></div>",
        "id": 525658846,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750839715
    },
    {
        "content": "<p>resolved by myself</p>",
        "id": 525662141,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750840797
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> has marked this topic as resolved.</p>",
        "id": 525662169,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750840806
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> has marked this topic as unresolved.</p>",
        "id": 525697425,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750852990
    },
    {
        "content": "<p>It seems that the tag attribute created using this method results in an empty output from <code>listAllTagged</code> when crossing module boundaries.<br>\nWhy is that? How can I fix it?</p>",
        "id": 525697605,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750853051
    },
    {
        "content": "<p>MWE: </p>\n<h2>Tag1.lean</h2>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">myTagAttribute</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TagAttribute</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerTagAttribute</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">`my_tag</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"test for tag\"</span><span class=\"o\">)</span>\n</code></pre></div>\n<h2>Tag2.lean</h2>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Tag1</span><span class=\"bp\">.</span><span class=\"n\">lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">listAllTagged</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">tagAttr</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">TagAttribute</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">List</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">env</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">taggedDecls</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">tagAttr</span><span class=\"bp\">.</span><span class=\"n\">ext</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"n\">env</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">taggedDecls</span><span class=\"bp\">.</span><span class=\"n\">toList</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">my_tag</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n\n<span class=\"c1\">-- [foo]</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tagged</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">listAllTagged</span><span class=\"w\"> </span><span class=\"n\">myTagAttribute</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{tagged}\"</span>\n</code></pre></div>\n<h2>Tag3.lean</h2>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Tag2</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"c1\">-- []</span>\n<span class=\"n\">run_meta</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tagged</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">listAllTagged</span><span class=\"w\"> </span><span class=\"n\">myTagAttribute</span>\n<span class=\"w\">  </span><span class=\"n\">logInfo</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"{tagged}\"</span>\n</code></pre></div>",
        "id": 525700257,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750854036
    },
    {
        "content": "<p>why the output of <code>listAllTagged</code> in Tag3.lean is empty???</p>\n<p>Lean version: 4.21.0-rc3</p>",
        "id": 525700396,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750854092
    },
    {
        "content": "<p>For <code>TagAttribute</code>s, <code>attr.ext.getState env</code> only returns the local state (in the same file). The state of other modules is in <code>attr.ext.getModuleEntries env modIdx</code></p>",
        "id": 525700592,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750854166
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"873547\">@Robin Arnez</span> </p>\n<p>Thank you!!!</p>\n<p>nice! how to fix this?</p>",
        "id": 525700693,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750854203
    },
    {
        "content": "<p><code>TagAttribute</code> is mostly for <code>hasTag</code>. You probably want to e.g. use a <code>SimpleScopedEnvExtension</code></p>",
        "id": 525701107,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750854348
    },
    {
        "content": "<p>Sorry, I don't know how to fix this problem... <br>\nPlease give me a concrete code example.</p>",
        "id": 525701347,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750854424
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">MyEntry</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span>\n<span class=\"w\">  </span><span class=\"n\">keys</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">DiscrTree</span><span class=\"bp\">.</span><span class=\"n\">Key</span>\n<span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">Inhabited</span>\n\n<span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">myDecls</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">SimpleScopedEnvExtension</span><span class=\"w\"> </span><span class=\"n\">MyEntry</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">DiscrTree</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span>\n<span class=\"w\">  </span><span class=\"n\">registerSimpleScopedEnvExtension</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">initial</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">empty</span>\n<span class=\"w\">    </span><span class=\"n\">addEntry</span><span class=\"w\"> </span><span class=\"n\">es</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">es</span><span class=\"bp\">.</span><span class=\"n\">insertCore</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">keys</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"bp\">.</span><span class=\"n\">name</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">syntax</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myTagAttribute</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"s2\">\"my_tag\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">attr</span>\n\n<span class=\"n\">initialize</span>\n<span class=\"w\">  </span><span class=\"n\">registerBuiltinAttribute</span><span class=\"w\"> </span><span class=\"o\">{</span>\n<span class=\"w\">    </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"ss\">``myTagAttribute</span>\n<span class=\"w\">    </span><span class=\"n\">descr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span>\n<span class=\"w\">    </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"w\"> </span><span class=\"n\">stx</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getConstVal</span><span class=\"w\"> </span><span class=\"n\">nm</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">getPath</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">MetaM</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">Array</span><span class=\"w\"> </span><span class=\"n\">DiscrTree</span><span class=\"bp\">.</span><span class=\"n\">Key</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">withReducible</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">        </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">forallMetaTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"bp\">.</span><span class=\"n\">type</span>\n<span class=\"w\">        </span><span class=\"n\">DiscrTree</span><span class=\"bp\">.</span><span class=\"n\">mkPath</span><span class=\"w\"> </span><span class=\"n\">body</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getPath</span><span class=\"bp\">.</span><span class=\"n\">run'</span>\n<span class=\"w\">      </span><span class=\"n\">modifyEnv</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">myDecls</span><span class=\"bp\">.</span><span class=\"n\">addCore</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"o\">{</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">nm</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">keys</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">}</span><span class=\"w\"> </span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getCurrNamespace</span><span class=\"o\">))</span>\n<span class=\"w\">  </span><span class=\"o\">}</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"try_apply_my_tag\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myDecls</span><span class=\"bp\">.</span><span class=\"n\">getState</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getMainGoal</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">getType</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">withReducible</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"n\">forallTelescopeReducing</span><span class=\"w\"> </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">tree</span><span class=\"bp\">.</span><span class=\"n\">getUnify</span><span class=\"w\"> </span><span class=\"n\">body</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">names</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">try</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">goals</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"bp\">.</span><span class=\"n\">applyConst</span><span class=\"w\"> </span><span class=\"n\">n</span>\n<span class=\"w\">      </span><span class=\"n\">replaceMainGoal</span><span class=\"w\"> </span><span class=\"n\">goals</span>\n<span class=\"w\">      </span><span class=\"n\">return</span>\n<span class=\"w\">    </span><span class=\"n\">catch</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">      </span><span class=\"n\">continue</span>\n<span class=\"w\">  </span><span class=\"n\">throwTacticEx</span><span class=\"w\"> </span><span class=\"ss\">`try_apply_my_tag</span><span class=\"w\"> </span><span class=\"n\">goal</span><span class=\"w\"> </span><span class=\"s2\">\"Could not find a lemma to apply\"</span>\n</code></pre></div>\n<p>Something like this</p>",
        "id": 525704448,
        "sender_full_name": "Robin Arnez",
        "timestamp": 1750855453
    },
    {
        "content": "<p>Thank you!!!!</p>\n<p><code>registerBuiltinAttribute</code> is suitable?</p>\n<p>I think this is not a built-in attribute</p>",
        "id": 525708646,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1750856775
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> has marked this topic as resolved.</p>",
        "id": 525715595,
        "sender_full_name": "Notification Bot",
        "timestamp": 1750858823
    }
]