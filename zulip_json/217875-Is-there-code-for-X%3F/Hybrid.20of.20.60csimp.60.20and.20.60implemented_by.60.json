[
    {
        "content": "<p>Is there an idiom for expressing \"here's a proof that this efficient implementation is equivalent to this reference implementation, given this (necessarily unsafe) assumption that I promise is true\"? The purpose is to \"factor out\" the unsafety into just a single assumption while still proving equivalence as much as is possible</p>\n<p>I find myself writing this rather verbosely as </p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- giving this a name because its common across several \"unsafe\" implementations</span>\n<span class=\"c1\">-- necessarily unprovable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unsafeAssumeAssumption</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lcProof</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFunEfficient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFunUnsafe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myFunEfficient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">unsafeAssumeAssumption</span><span class=\"o\">)</span>\n\n<span class=\"c1\">-- public reference impl</span>\n<span class=\"kd\">@[</span><span class=\"n\">implemented_by</span><span class=\"w\"> </span><span class=\"n\">myFunUnsafe</span><span class=\"kd\">]</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"c1\">-- keep myself honest</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">myFunEfficient_eq_myFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myFun</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">myFunEfficient</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n</code></pre></div>\n<p>I suppose I could cut down on the boilerplate with metaprogramming (something like <code>@[csimp_unsafe_assume myAssumption]</code> but I was wondering if there was an existing idiom for this.</p>",
        "id": 565324119,
        "sender_full_name": "cmlsharp",
        "timestamp": 1766617135
    },
    {
        "content": "<p>Is there even some example in core/batteries/mathlib where we have some kind of proof about the implementation referred to by <code>implemented_by</code>?</p>",
        "id": 565328474,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766622507
    },
    {
        "content": "<p>I don’t know! I’m not sure how general this pattern is but I’ve been writing implementations of Array.scanl/scanr/scanlM/scanrM  (planning on PRing batteries) and the correctness of the efficient versions solely rely on the (unprovable but true) assumption that arr.size &lt; USize.size. It seems desirable to prove that the two versions are equivalent modulo this detail.</p>\n<p>The fact that Array.foldl/foldr/et al don’t do this (and instead merely use implemented_by) led to a bug I reported recently.</p>",
        "id": 565328709,
        "sender_full_name": "cmlsharp",
        "timestamp": 1766622876
    },
    {
        "content": "<p>Now that we fixed these two bugs, surely, there are no more bugs. <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 565328756,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766622997
    },
    {
        "content": "<p>You could make an unsafe csimp maybe? But I guess, the point is to have a proof not be unsafe, to ensure it's an honest proof.</p>",
        "id": 565328787,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766623072
    },
    {
        "content": "<p>Though, you could always cheat with native_decide anyway, so maybe it's okay if you just read that there's only one use of unsafe lcProof? Something like this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- giving this a name because its common across several \"unsafe\" implementations</span>\n<span class=\"c1\">-- necessarily unprovable</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">unsafeAssumeAssumption</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">lcProof</span>\n\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFunEfficient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n<span class=\"kn\">private</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFunUnsafe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">myFunEfficient</span><span class=\"w\"> </span><span class=\"n\">unsafeAssumeAssumption</span>\n\n<span class=\"c1\">-- public reference impl</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFun</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"c1\">-- keep myself honest</span>\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">myFun_eq_myFunEfficient</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myAssumption</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">myFun</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">myFunEfficient</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">...</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">csimp</span><span class=\"kd\">]</span>\n<span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">myFun_eq_myFunUnsafe</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">myFun</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"bp\">@</span><span class=\"n\">myFunUnsafe</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"n\">myFun_eq_myFunEfficient</span><span class=\"w\"> </span><span class=\"n\">unsafeAssumeAssumption</span>\n</code></pre></div>",
        "id": 565328909,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766623245
    },
    {
        "content": "<p>My reasoning for using <code>csimp</code> over <code>implemented_by</code> is that it better communicates your intention that there is a proof (almost) that the implementation is safe.</p>",
        "id": 565329302,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766623915
    },
    {
        "content": "<p><del>Oh, nvm, this doesn't work. \"'unsafe' theorems are not allowed\".</del> But <code>def</code> works.</p>",
        "id": 565329414,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766624169
    },
    {
        "content": "<p>Btw, where you able to make a proof? I've looked a bit at how hard <code>arr.foldlM = arr.foldlMUnsafe</code> would be though I gave up quickly.</p>",
        "id": 565329962,
        "sender_full_name": "Jakub Nowak",
        "timestamp": 1766624854
    },
    {
        "content": "<p>I was able to for an earlier version of scanl/scanr (haven’t tried the monadic versions).  I’ve since changed the implementation a bit and the proof broke, but I don’t think that’s fundamental.</p>\n<p>The main thing I’ve noticed is that USize is really annoying to work with in proofs (at least partially due to a lack of @[simp]/grind lemmas</p>",
        "id": 565330122,
        "sender_full_name": "cmlsharp",
        "timestamp": 1766625140
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Hybrid.20of.20.60csimp.60.20and.20.60implemented_by.60/near/565329414\">said</a>:</p>\n<blockquote>\n<p><del>Oh, nvm, this doesn't work. \"'unsafe' theorems are not allowed\".</del> But <code>def</code> works.</p>\n</blockquote>\n<p>Oh interesting! I didnt realize csimp worked with defs but I guess that makes sense</p>",
        "id": 565331426,
        "sender_full_name": "cmlsharp",
        "timestamp": 1766627302
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"870257\">Jakub Nowak</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Hybrid.20of.20.60csimp.60.20and.20.60implemented_by.60/near/565329962\">said</a>:</p>\n<blockquote>\n<p>Btw, where you able to make a proof? I've looked a bit at how hard <code>arr.foldlM = arr.foldlMUnsafe</code> would be though I gave up quickly.</p>\n</blockquote>\n<p>By the way, if interested I got the proof working for <code>Array.scanlM</code> (<code>Array.scanrM</code> is tougher because it diverges a bit more from the reference impl).</p>\n<p><a href=\"https://github.com/cmlsharp/batteries/blob/9c3dc78597aadefae22d59ca7ef890af566db8e7/Batteries/Data/Array/Basic.lean#L238\">Proof here</a></p>",
        "id": 565870331,
        "sender_full_name": "cmlsharp",
        "timestamp": 1767166149
    }
]