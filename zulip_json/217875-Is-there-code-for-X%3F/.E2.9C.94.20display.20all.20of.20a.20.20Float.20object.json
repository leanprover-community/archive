[
    {
        "content": "<p>The following code results in success, but I think <code>1.0 / 10.0</code> is not equal to <code>0.1</code>.<br>\nI think the Float values are rounded when they are displayed, but is it possible to output the values before rounding?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">#</span><span class=\"n\">guard</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"bp\">.</span><span class=\"mi\">1</span>\n</code></pre></div>",
        "id": 473458622,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727623659
    },
    {
        "content": "<p>It's not? Python and JavaScript both agree that these are equal</p>",
        "id": 473458845,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727623839
    },
    {
        "content": "<p>I believe that floating point numbers must use binary numbers internally, and the operation of dividing by 10 should not be accurately represented.</p>",
        "id": 473458941,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727623887
    },
    {
        "content": "<p>That's true, but <code>1</code> and <code>10</code> are exactly represented, so <code>1.0 / 10.0</code> is the float value that the true <code>0.1</code> rounds to, and that's also what <code>0.1</code> represents</p>",
        "id": 473459051,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727623950
    },
    {
        "content": "<p>You can use</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">toRat0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mf\">10.0</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>to see the exact value of it</p>",
        "id": 473459099,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727624016
    },
    {
        "content": "<p>thanks. But `1.0 / 10.0 : Float is different from 0.1 as a real number, right?</p>",
        "id": 473459201,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727624097
    },
    {
        "content": "<p>But hovering over the <code>0.1</code> there you can see it's a Float, not a Real</p>",
        "id": 473459358,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727624177
    },
    {
        "content": "<p>Sorry I'm asking a bad question.<br>\nWhat I want to know is whether there is any way to measure how much <code>1.0 / 10.0 : Float</code> deviates from <code>0.1</code> (0.1 as the real number we imagine in our head).</p>",
        "id": 473459488,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727624286
    },
    {
        "content": "<p>Real numbers aren't computable, but you can use rational numbers:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n\n<span class=\"c1\">-- (1 : Rat)/180143985094819840</span>\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">toRat0</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mf\">10.0</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mf\">0.1</span>\n</code></pre></div>",
        "id": 473459521,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727624324
    },
    {
        "content": "<p>Thanks for telling me about <code>Float.toRat0</code>. That sounds very useful.</p>\n<p>Is the Float of Lean internally represented as a rational number?</p>",
        "id": 473459657,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727624411
    },
    {
        "content": "<p>No, it's C's <code>double</code>, I think. That's the reason all operations on it are opaque, as different devices can have different floating-point implementations</p>",
        "id": 473459735,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727624476
    },
    {
        "content": "<p>I want to look at the internal data of a Float and see that 1.0 : Float is actually different from 1/10 : Rat. I would like a tool that can calculate the value of <code>1.0 : Float</code> exactly to the nth digit for any n.</p>",
        "id": 473459862,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727624594
    },
    {
        "content": "<p>toRat0 fulfils this purpose, but it would be more pleasing if the decimal point could be examined by increasing the number of digits displayed.</p>",
        "id": 473459900,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727624641
    },
    {
        "content": "<p>You can use this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">Basic</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">NumberTheory</span><span class=\"bp\">.</span><span class=\"n\">Padics</span><span class=\"bp\">.</span><span class=\"n\">PadicVal</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Data</span><span class=\"bp\">.</span><span class=\"n\">String</span><span class=\"bp\">.</span><span class=\"n\">Defs</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">pow2ToBase10</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">floor</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\".\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">padicValNat</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">padicValNat</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">leftpad</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">padicValNat</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">0</span><span class=\"bp\">'</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">toExactDecimal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toRat0</span><span class=\"bp\">.</span><span class=\"n\">pow2ToBase10</span>\n\n<span class=\"bp\">#</span><span class=\"n\">eval</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">toExactDecimal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"w\"> </span><span class=\"mf\">10.0</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 473460360,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727624974
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span> Thank you!! I will try.</p>",
        "id": 473460388,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727624999
    },
    {
        "content": "<p>...so nice!! I want this function in the std library!</p>",
        "id": 473460511,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727625077
    },
    {
        "content": "<p>... I don't understand what <code>Rat.pow2ToBase10</code> does. is it magic?</p>",
        "id": 473460658,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727625207
    },
    {
        "content": "<p>It appears that the notation of the rational number r : Rat as a decimal fraction is obtained without using Float, but the details are not understood...</p>",
        "id": 473460802,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727625342
    },
    {
        "content": "<p>It utilizes the fact that the denominator of a float is a power of two. It uses <code>padicValNat 2 x.den</code> to figure out that power, and then multiplies the numerator and the denominator by <code>5 ^ (padicValNat 2 x.den)</code> to convert the denominator to a power of two. The integer part is just <code>x.floor</code>, and the decimal part is obtained by padding <code>num % den</code> to have the correct number of digits</p>",
        "id": 473460908,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727625406
    },
    {
        "content": "<p>Also I just noticed it's wrong for negative numbers,</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">pow2ToBase10Pos</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">floor</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"s2\">\".\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">padicValNat</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">padicValNat</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)))</span><span class=\"bp\">.</span><span class=\"n\">leftpad</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">padicValNat</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">den</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"mi\">0</span><span class=\"bp\">'</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"bp\">.</span><span class=\"n\">pow2ToBase10</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Rat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"bp\">â‰¤</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">pow2ToBase10Pos</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"s2\">\"-\"</span><span class=\"w\"> </span><span class=\"bp\">++</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">-</span><span class=\"n\">x</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">pow2ToBase10Pos</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"bp\">.</span><span class=\"n\">toExactDecimal</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Float</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">toRat0</span><span class=\"bp\">.</span><span class=\"n\">pow2ToBase10</span>\n</code></pre></div>\n<p>fixes it</p>",
        "id": 473461001,
        "sender_full_name": "Daniel Weber",
        "timestamp": 1727625485
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"690858\">@Daniel Weber</span>  Thank you!!!! I understand why your function works well...!</p>",
        "id": 473461028,
        "sender_full_name": "Asei Inoue",
        "timestamp": 1727625513
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"626349\">Asei Inoue</span> has marked this topic as resolved.</p>",
        "id": 473461035,
        "sender_full_name": "Notification Bot",
        "timestamp": 1727625528
    }
]