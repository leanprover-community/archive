[
    {
        "content": "<p>There is an <code>assert_not_exists</code> command that checks whether a specific declaration is not present in the environment.</p>\n<p>Should there be an analogous <code>assert_not_imported</code> command that checks whether a <em>module</em> is imported or not?</p>",
        "id": 460106722,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723477063
    },
    {
        "content": "<p>Would make sense, I guess</p>",
        "id": 460120396,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1723480987
    },
    {
        "content": "<p>But do you have particular examples in mind already?</p>",
        "id": 460120421,
        "sender_full_name": "Johan Commelin",
        "timestamp": 1723480999
    },
    {
        "content": "<p>This came up in <a href=\"https://github.com/leanprover-community/mathlib4/pull/15732\">#15732</a>, in <code>Mathlib/Algebra/Field/Defs.lean</code></p>",
        "id": 461028948,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723484538
    },
    {
        "content": "<p>Yes, my only usecase is the one that Michael mentioned.</p>",
        "id": 461954793,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723495343
    },
    {
        "content": "<p>I've definitely encountered the problem of wanting to exclude a module, and then having to dig through it for a stable looking declaration to exclude instead, so +1 from me.</p>",
        "id": 461973409,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723503970
    },
    {
        "content": "<p>What if someone renames the module?</p>",
        "id": 462006646,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1723518602
    },
    {
        "content": "<p>Damiano has already been setting up infrastructure to check at the end that everything asserted about eventually exists. I presume such a system would catch that case. A split would be more complicated, and I agree that it seems likely regressions could slip through.</p>",
        "id": 462013084,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723522028
    },
    {
        "content": "<p>Yes, files no longer existing could be caught by the same mechanism that catches declarations no longer existing.  Maybe, once a missing file is detected, the error message could suggest to discuss on Zulip how to proceed.</p>",
        "id": 462018594,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723524834
    },
    {
        "content": "<p>Here is a possible implementation.  Checking for existing files <del>will not</del> works in the online server<del>, I think, since I do not really know how the filepaths work there</del>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Linter</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"assert_not_imported \"</span><span class=\"w\"> </span><span class=\"n\">ids</span><span class=\"o\">:</span><span class=\"n\">ident</span><span class=\"bp\">*</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mods</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">allImportedModuleNames</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">ids</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">mods</span><span class=\"bp\">.</span><span class=\"n\">contains</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">logWarningAt</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"'{id}' is imported\"</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">searchPathRef</span><span class=\"bp\">.</span><span class=\"n\">get</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">findModuleWithExt</span><span class=\"w\"> </span><span class=\"s2\">\"olean\"</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"bp\">.</span><span class=\"n\">getId</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">logWarningAt</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"w\"> </span><span class=\"n\">m!</span><span class=\"s2\">\"'{id}' does not exist\"</span>\n\n<span class=\"n\">assert_not_imported</span>\n<span class=\"w\">  </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Common</span><span class=\"w\">  </span><span class=\"c1\">-- ok</span>\n<span class=\"w\">  </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">Elab</span><span class=\"bp\">.</span><span class=\"n\">Command</span><span class=\"w\">  </span><span class=\"c1\">-- 'Lean.Elab.Command' is imported</span>\n<span class=\"w\">  </span><span class=\"n\">I_do_not_exist</span><span class=\"w\">  </span><span class=\"c1\">-- 'I_do_not_exist.lean' does not exist</span>\n</code></pre></div>\n<p>If someone using a system other than Linux could check that this works as intended there, it would be great!</p>",
        "id": 462035303,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723532235
    },
    {
        "content": "<p>Works on macos!</p>",
        "id": 462090849,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723549555
    },
    {
        "content": "<p>Ok, let me prepare a PR, then!  Since the above works on my computer, it works on MacOs and also works on the online server, how could it possibly fail on any system?  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 462093120,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723550093
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15769\">#15769</a></p>",
        "id": 462095250,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723550593
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15782\">#15782</a> uses this for the file which inspired this thread. :-)</p>",
        "id": 462217368,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723585699
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/tree/MR-use-ane\">branch#MR-use-ane</a> observes three further stale comments, which look like they ought to use this command, but the referenced file <code>Data.Nat.Order.Basic</code> does not exist any more.</p>\n<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> That sounds like you might have performed this split: can you suggest how to update the comment best? I'm unsure whether to update the comment or use <code>assert_not_imported</code> instead, but the current state is surely suboptimal :-)</p>",
        "id": 462217609,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723585819
    },
    {
        "content": "<p><code>Order.Nat.Basic</code> should be the file</p>",
        "id": 462217697,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723585871
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462095250\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15769\">#15769</a></p>\n</blockquote>\n<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/15783\">#15783</a>, I'm proposing a small wording tweak (and changing on warning to an error).</p>",
        "id": 462218381,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723586231
    },
    {
        "content": "<p>Fast reviews are great - but then we should embrace follow-up PRs for any small things we notice later :-)</p>",
        "id": 462218455,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723586262
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462217697\">said</a>:</p>\n<blockquote>\n<p><code>Order.Nat.Basic</code> should be the file</p>\n</blockquote>\n<p>There only exists <code>Order.Nat</code>; do you mean that? (Update: doesn't look like it; that file is virtually empty)</p>",
        "id": 462218733,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723586403
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462217368\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15782\">#15782</a> uses this for the file which inspired this thread. :-)</p>\n</blockquote>\n<p>This looks great!  I just have a small doubt, thinking ahead about the linter: should <code>assert_not_exists</code> and <code>assert_not_imported</code> appear in a specific order, or should they just float to the top of each file, preceded only by imports and doc-strings, but with no fixed relative order between them?</p>",
        "id": 462218921,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723586493
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462218733\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462217697\">said</a>:</p>\n<blockquote>\n<p><code>Order.Nat.Basic</code> should be the file</p>\n</blockquote>\n<p>There only exists <code>Order.Nat</code>; do you mean that? (Update: doesn't look like it; that file is virtually empty)</p>\n</blockquote>\n<p>Ah sorry, <code>Algebra.Order.Nat</code> is what I mean</p>",
        "id": 462219042,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723586542
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462219042\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462218733\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462217697\">said</a>:</p>\n<blockquote>\n<p><code>Order.Nat.Basic</code> should be the file</p>\n</blockquote>\n<p>There only exists <code>Order.Nat</code>; do you mean that? (Update: doesn't look like it; that file is virtually empty)</p>\n</blockquote>\n<p>Ah sorry, <code>Algebra.Order.Nat</code> is what I mean</p>\n</blockquote>\n<p>Doesn't exist either...</p>",
        "id": 462219383,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723586740
    },
    {
        "content": "<p><code>Algebra.Order.Group.Nat</code> <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 462219500,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723586779
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462218921\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462217368\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15782\">#15782</a> uses this for the file which inspired this thread. :-)</p>\n</blockquote>\n<p>This looks great!  I just have a small doubt, thinking ahead about the linter: should <code>assert_not_exists</code> and <code>assert_not_imported</code> appear in a specific order, or should they just float to the top of each file, preceded only by imports and doc-strings, but with no fixed relative order between them?</p>\n</blockquote>\n<p>Good question! I don't feel strongly about ordering them - but also wouldn't mind enforcing some order. (If nothing else, alphabetical comes to mind.)</p>",
        "id": 462219519,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723586791
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462219500\">said</a>:</p>\n<blockquote>\n<p><code>Algebra.Order.Group.Nat</code></p>\n</blockquote>\n<p>Thanks, that solved it. (I needed to prefix with Mathlib, but that's fine.)</p>",
        "id": 462219624,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723586851
    },
    {
        "content": "<p>Fun fact: <code>assert_not_imported assert_not_imported Mathlib.Algebra.Order.Group.Nat</code> leaves no error: is this supposed to happen?<br>\n(Sometimes copy-pasting is useful, I guess...)</p>",
        "id": 462220460,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723587267
    },
    {
        "content": "<p>Ah, assert_not_imported takes a sequence of identifiers as input, but does not guard that the sequence is non-empty!</p>",
        "id": 462222720,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723588517
    },
    {
        "content": "<p>Feel free to fix this, or I'll do it tomorrow, very likely.</p>",
        "id": 462223095,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723588744
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462220460\">said</a>:</p>\n<blockquote>\n<p>Fun fact: <code>assert_not_imported assert_not_imported Mathlib.Algebra.Order.Group.Nat</code> leaves no error: is this supposed to happen?<br>\n(Sometimes copy-pasting is useful, I guess...)</p>\n</blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15795\">#15795</a></p>",
        "id": 462266144,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723613377
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462219519\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462218921\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462217368\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15782\">#15782</a> uses this for the file which inspired this thread. :-)</p>\n</blockquote>\n<p>This looks great!  I just have a small doubt, thinking ahead about the linter: should <code>assert_not_exists</code> and <code>assert_not_imported</code> appear in a specific order, or should they just float to the top of each file, preceded only by imports and doc-strings, but with no fixed relative order between them?</p>\n</blockquote>\n<p>Good question! I don't feel strongly about ordering them - but also wouldn't mind enforcing some order. (If nothing else, alphabetical comes to mind.)</p>\n</blockquote>\n<p>I probably prefer \"imports first, declarations later\" (so, reverse alphabetical, I guess!).  This is also what you did in your PR, I think.</p>",
        "id": 462266496,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723613610
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462266496\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462219519\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"321459\">Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462218921\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"634338\">Michael Rothgang</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462217368\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15782\">#15782</a> uses this for the file which inspired this thread. :-)</p>\n</blockquote>\n<p>This looks great!  I just have a small doubt, thinking ahead about the linter: should <code>assert_not_exists</code> and <code>assert_not_imported</code> appear in a specific order, or should they just float to the top of each file, preceded only by imports and doc-strings, but with no fixed relative order between them?</p>\n</blockquote>\n<p>Good question! I don't feel strongly about ordering them - but also wouldn't mind enforcing some order. (If nothing else, alphabetical comes to mind.)</p>\n</blockquote>\n<p>I probably prefer \"imports first, declarations later\" (so, reverse alphabetical, I guess!).  This is also what you did in your PR, I think.</p>\n</blockquote>\n<p>That's a good argument!</p>",
        "id": 462290366,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723623555
    },
    {
        "content": "<p>The implementation of <code>assert_not_imported x</code> has the issue that it looks for the <code>.olean</code>s of file <code>x</code> and hence reports as non-existing files that simply have not yet been built.</p>",
        "id": 462455274,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723690230
    },
    {
        "content": "<p>This is an issue in CI, when <code>lake build</code> is being run <em>the first time</em>.</p>",
        "id": 462455291,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723690238
    },
    {
        "content": "<p>Of course, searching for the <code>.lean</code> files is an alternative that does not require a build, but does require knowing where to look for them!</p>",
        "id": 462455306,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723690247
    },
    {
        "content": "<p>For something such as <code>assert_not_exists Mathlib.Data.Nat.Basic</code>, this is completely straightforward.  However for <code>assert_not_exists Lean.Elab.Command</code> I was not able to tease out of Lean the filepath to the <code>.lean</code> file, rather than the <code>.olean</code> file that may not yet exist.</p>",
        "id": 462455342,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723690258
    },
    {
        "content": "<p>Does anyone know how to go from <code>Lean.Elab.Command</code> to the location where the file <code>Lean/Elab/Command.lean</code> should be?</p>",
        "id": 462455346,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723690260
    },
    {
        "content": "<p>Haha, I dimly remember having thought about this before, but when I went looking only found:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"c1\">-- TODO allow finding Lean 4 sources from the toolchain.</span>\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">findLean</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mod</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">IO</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">FilePath</span><span class=\"bp\">.</span><span class=\"n\">mk</span><span class=\"w\"> </span><span class=\"o\">((</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">findOLean</span><span class=\"w\"> </span><span class=\"n\">mod</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"bp\">.</span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"s2\">\".lake/build/lib/\"</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">|&gt;.</span><span class=\"n\">withExtension</span><span class=\"w\"> </span><span class=\"s2\">\"lean\"</span>\n</code></pre></div>",
        "id": 462490607,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1723706363
    },
    {
        "content": "<p>I have a version of this somewhere that uses <code>LEAN_SRC_PATH</code>.</p>",
        "id": 462500307,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1723709464
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/assert_not_imported/near/462455274\">said</a>:</p>\n<blockquote>\n<p>The implementation of <code>assert_not_imported x</code> has the issue that it looks for the <code>.olean</code>s of file <code>x</code> and hence reports as non-existing files that simply have not yet been built.</p>\n</blockquote>\n<p>Is this why <a href=\"https://github.com/leanprover-community/mathlib4/pull/11582\">#11582</a> is failing CI?</p>",
        "id": 462513156,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723715094
    },
    {
        "content": "<p>Maybe let's revert <code>assert_not_imported</code> until it's more stable?</p>",
        "id": 462513469,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1723715224
    },
    {
        "content": "<p>I think its fine to leave in for now. It is currently unused. I think it'll get fixed pretty soon (no pressure <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span> ).</p>",
        "id": 462514282,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723715553
    },
    {
        "content": "<p>I am definitely feeling the \"no pressure\"!  <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 462518637,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723717204
    },
    {
        "content": "<p>I really think that this should be easy.  After all, if I write <code>import X</code> in a file in the project, Lean knows where to look for <code>X</code>:</p>\n<ul>\n<li>if it finds <code>olean</code>s, great (and I know how to replicate this);</li>\n<li>if it does not find <code>olean</code>s, it still knows how to locate the potential candidate source  -- this is what I would like to access!</li>\n</ul>",
        "id": 462518814,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723717292
    },
    {
        "content": "<p>Here is a partial explanation of why I did not pick up on this.</p>\n<ul>\n<li>If you have a \"working\" version of Mathlib, then the oleans are there, maybe outdated, but are present.</li>\n<li>If you write a test file, it gets processed by CI, <em>after</em> it built mathlib, and in particular, the appropriate <code>olean</code>s are already there.</li>\n<li>During the regular built, it <em>may</em> be that the <code>olean</code>s for the non-imported files have already been built anyway, and the command finds them!</li>\n</ul>",
        "id": 462519072,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723717417
    },
    {
        "content": "<p>So, it is really only <em>some</em> (likely most, but certainly not all) CI runs that fail.</p>",
        "id": 462519201,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723717472
    },
    {
        "content": "<p>Why not throw an error on linting if the declaration or module doesn’t exist in the environment at that time? I recognize immediate feedback is better but this at least improves the status quo. Or did some one suggest that and I’m just not paying attention…</p>",
        "id": 462534703,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723722999
    },
    {
        "content": "<p>Isn't that what the linter <del>currently does</del>did before the revert, and this failed CI?</p>",
        "id": 462535998,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723723438
    },
    {
        "content": "<p>(Or rather: it fails CI at (seemingly) unpredictable moments, on unrelated PRs.)</p>",
        "id": 462536052,
        "sender_full_name": "Michael Rothgang",
        "timestamp": 1723723445
    },
    {
        "content": "<p>I’ve only ever seen <code>assert_not_exists</code> silently fail when the name is mistyped. Did that get fixed?</p>",
        "id": 462536615,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723723713
    },
    {
        "content": "<p>The command that is causing problems now is just a straightforward \"search for the olean and fail otherwise\", it is not a linter.</p>",
        "id": 462536671,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723723741
    },
    {
        "content": "<p>Also, there are two commands: <code>assert_not_exists</code> that checks declaration names and <code>assert_not_imported</code> that checks modules.</p>",
        "id": 462536723,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723723768
    },
    {
        "content": "<p>The <code>assert_not_exists</code> (for declarations) only checks that a declaration with that name does not exist but does not attempt to check if \"later on\" it will exist.</p>",
        "id": 462536832,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723723805
    },
    {
        "content": "<p>There is a script to check for that, but the issues are now caused by the new import check.</p>",
        "id": 462536897,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723723833
    },
    {
        "content": "<p>I think that the unpredictability of the failure is due to the fact that Lean <em>could</em> have created the <code>olean</code>s for the file (maybe they are now obsolete, but they are still there) or may not have when you issue the command.</p>",
        "id": 462537057,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723723890
    },
    {
        "content": "<p>I think that an easy solution for now is to just not allow <code>assert_not_imported</code> to check for non-mathlib imports and just say that those never exist.</p>",
        "id": 462537152,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723723923
    },
    {
        "content": "<p>In the case of <code>Mathlib</code> files, it is easy enough to search for the <code>.lean</code> files and fail if you find nothing.</p>",
        "id": 462537226,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723723954
    },
    {
        "content": "<p>If you were looking for <code>Lean.Elab.Command</code> the command will tell you that the file does not exist (even though it can check whether or not it is imported).</p>",
        "id": 462537355,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723724014
    },
    {
        "content": "<p>Maybe, for the time being, this is a good compromise: <code>assert_not_imported (in Mathlib)</code>.</p>",
        "id": 462537443,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723724043
    },
    {
        "content": "<p>That will not cause CI issues, it will just flag as incorrectly non-existing files that are in mathlib dependencies.</p>",
        "id": 462537549,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723724079
    },
    {
        "content": "<p>Ok, TL;DR: I am going to modify <code>assert_not_imported x</code> as follows:</p>\n<ul>\n<li>for any <code>x</code>, it complains if <code>x</code> is imported by the current module;</li>\n<li>if <code>x</code> starts with <code>Mathlib.</code>, then also check that the file does indeed exist in <code>Mathlib</code>.</li>\n</ul>\n<p>The gap that this leaves with the \"ideal\" implementation is that it does not report when you are trying to ban a file in a dependency that does not exist.</p>",
        "id": 462539114,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723724519
    },
    {
        "content": "<p>Maybe I am not clear. (Or maybe I am and saying something silly.) I am saying: add an environmental linter which captures the <code>assert_not_exists/imported</code> commands and runs when everything is built.</p>",
        "id": 462541190,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723725099
    },
    {
        "content": "<p>Ah, yes, this was indeed a second step!</p>",
        "id": 462541290,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723725127
    },
    {
        "content": "<p>I <del>was</del>am just trying to \"salvage\" quickly the <code>assert_not_imported</code> command, before adding functionality.</p>",
        "id": 462541376,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723725162
    },
    {
        "content": "<p>Oh. I think using IO opens you up to too many edges cases for not enough gain, especially if there is going to be a second step that validates the overall existence of the name.</p>",
        "id": 462541521,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723725228
    },
    {
        "content": "<p>But I don't feel strongly so take it or leave it. And thanks!</p>",
        "id": 462541626,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723725263
    },
    {
        "content": "<p>So, you are suggesting to not even check if <code>Mathlib...</code> files exist?</p>",
        "id": 462541666,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723725279
    },
    {
        "content": "<p>Yes</p>",
        "id": 462541691,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723725286
    },
    {
        "content": "<p>I think that this should be easy and at least you get immediate feedback if there is an issue with the command.</p>",
        "id": 462541730,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723725301
    },
    {
        "content": "<p>Though maybe you are right.</p>",
        "id": 462541747,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723725310
    },
    {
        "content": "<p>Please just treat as a mild thought</p>",
        "id": 462541794,
        "sender_full_name": "Matthew Ballard",
        "timestamp": 1723725333
    },
    {
        "content": "<p>Ok, I'll PR a first \"fix\" that just discriminates on whether the file is imported or not.</p>",
        "id": 462541822,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723725346
    },
    {
        "content": "<p>When I get around to writing the linter, the logic for the <code>Mathlib.XXX.lean</code> files may be added to the command (or not) and will improve it, if possible.</p>",
        "id": 462541929,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723725385
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/15839\">#15839</a> changes to a minimal implementation: check whether or not the given name is an imported module, with no check of whether the module <em>could</em> be imported, just that it <em>isn't</em> imported.</p>",
        "id": 462546856,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1723727150
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/16002\">#16002</a> adds the eventual check of existence of imports and declarations.</p>",
        "id": 463707272,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1724161709
    }
]