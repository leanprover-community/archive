[
    {
        "content": "<p>is there an option propagation operator, a la <code>?</code> in rust, that will take an <code>Option α</code> to <code>α</code> if <code>some</code> and return <code>none</code> in the function body otherwise? </p>\n<p>i have read through <a href=\"https://leanprover-community.github.io/mathlib4_docs/Init/Data/Option/Basic.html\">Option</a> but did not spot it. i suspect it might be buried in monad methods somewhere, though i also haven't been able to find it in Prelude (but i don't quite know what i'm looking for wrt. monads).</p>",
        "id": 463876380,
        "sender_full_name": "JJ",
        "timestamp": 1724190390
    },
    {
        "content": "<p>This is called the Option monad</p>",
        "id": 463877343,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724190880
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">String</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">toString</span><span class=\"w\"> </span><span class=\"n\">n</span>\n</code></pre></div>",
        "id": 463877409,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724190916
    },
    {
        "content": "<p>This is sugar for the <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=bind#doc\">docs#bind</a></p>",
        "id": 463877498,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724190954
    },
    {
        "content": "<p>ah, okay: unfortunately i don't know anything about monads <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 463878233,
        "sender_full_name": "JJ",
        "timestamp": 1724191135
    },
    {
        "content": "<p>i'll go read through the manual section</p>",
        "id": 463878264,
        "sender_full_name": "JJ",
        "timestamp": 1724191142
    },
    {
        "content": "<p>Don't worry about understanding the abstract notion of a monad to get things done. There are just a few monads that anyone uses in practice (State, Reader, IO, and Option/Except), and the monad concept unifies them enough to be able to write imperative-looking code with this <code>do</code> notation.</p>\n<p>The arrow syntax \"evaluates\" a \"computation\", meanwhile handling state sequencing or other side effects (like exception handling) behind the scenes (by wiring together the correct low-level monad operations). For example, an <code>IO String</code> is a computation that results in a string, evaluatable from within an IO context.</p>\n<p><code>Option Nat</code> is a computation in the sense that the <code>Nat</code> value might be valid or not; <code>none</code> is like throwing an exception to abort the computation.</p>",
        "id": 463881306,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724191811
    },
    {
        "content": "<p>ok cool! got it working. that's real neat. out of curiosity though is there anything for outside of monadic contexts?</p>",
        "id": 463881543,
        "sender_full_name": "JJ",
        "timestamp": 1724191957
    },
    {
        "content": "<p>i guess it is very easy to just be in a monadic context...</p>",
        "id": 463881569,
        "sender_full_name": "JJ",
        "timestamp": 1724191977
    },
    {
        "content": "<p>You could use <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Option.bind#doc\">docs#Option.bind</a> directly</p>",
        "id": 463881613,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192007
    },
    {
        "content": "<p>also, what is the relation between <code>do</code> notation and the for-loop <code>do</code>? the documentation puts them together so i assume they're related, but it doesn't say much about for-loop <code>do</code></p>",
        "id": 463881713,
        "sender_full_name": "JJ",
        "timestamp": 1724192047
    },
    {
        "content": "<p>or <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Option.join#doc\">docs#Option.join</a> with <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Option.map#doc\">docs#Option.map</a></p>\n<p><a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Option.getD#doc\">docs#Option.getD</a> can be useful too, but that's to act as a \"terminator\" for an Option</p>",
        "id": 463881820,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192106
    },
    {
        "content": "<p>It's the same <code>do</code>. The for loop notation integrates into the monad system. That way you don't need a different for loop for every kind of monad.</p>\n<p>If you want to make use of it outside of a \"real\" monad, you can use <code>Id.run do ...</code> to use the so-called \"identity monad\". This is useful sometimes since <code>do</code> notation has some nice features to it.</p>",
        "id": 463882002,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192205
    },
    {
        "content": "<p>For example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">triangle</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 463882062,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192253
    },
    {
        "content": "<p>hmm. so is it like, the <code>do</code> is so that you can access <code>i</code> as <code>Nat</code> rather than <code>Option Nat</code>? (vaguely?)</p>",
        "id": 463882172,
        "sender_full_name": "JJ",
        "timestamp": 1724192308
    },
    {
        "content": "<p>i assume <code>for/in</code> desugars into something directly but i also assume i will probably not be able to make heads and tails of the desugared form, ha</p>",
        "id": 463882215,
        "sender_full_name": "JJ",
        "timestamp": 1724192340
    },
    {
        "content": "<p>(Don't be fooled that this <code>mut</code> might be the Rust <code>mut</code> by the way. It's telling <code>do</code> that you want this to act like it's mutable. In the end, it figures out how to write the functional program that passes the state of <code>a</code> around using a hidden State monad wrapping the current monad. It's great not having to think about the details of this pretty much at all.)</p>",
        "id": 463882305,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192402
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634325\">JJ</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/option.20propagation.20operator/near/463882172\">said</a>:</p>\n<blockquote>\n<p>hmm. so is it like, the <code>do</code> is so that you can access <code>i</code> as <code>Nat</code> rather than <code>Option Nat</code>? (vaguely?)</p>\n</blockquote>\n<p>No, if it were <code>Option</code> you would still have that <code>i</code> is a <code>Nat</code>. All that changes is the return type.</p>\n<p>In the following, <code>failure</code> causes the result to be <code>none</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">triangle'</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"n\">failure</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span>\n</code></pre></div>",
        "id": 463882461,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192490
    },
    {
        "content": "<p>The <code>Id.run</code> thing is just to be able to tell Lean that you definitely want to use the identity monad. Otherwise you get</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>invalid `do` notation, expected type is not a monad application\n  Nat\n</code></pre></div>",
        "id": 463882630,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192566
    },
    {
        "content": "<p>Try experimenting using <code>failure</code> in the identity monad. You'll see</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>failed to synthesize\n  Alternative Id\n</code></pre></div>\n<p>which means that the monad doesn't support this feature. Makes sense -- pure functions can't fail. That's why you'd reach for <code>Option</code>/<code>Except</code>, to be able to represent a failed computation.</p>",
        "id": 463882825,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192676
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634325\">JJ</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/option.20propagation.20operator/near/463882215\">said</a>:</p>\n<blockquote>\n<p>i assume <code>for/in</code> desugars into something directly but i also assume i will probably not be able to make heads and tails of the desugared form, ha</p>\n</blockquote>\n<p>You can see what it expands to with <code>#print</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">triangle</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"n\">n</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"n\">i</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">a</span>\n<span class=\"bp\">#</span><span class=\"n\">print</span><span class=\"w\"> </span><span class=\"n\">triangle</span>\n<span class=\"c\">/-</span>\n<span class=\"cm\">def triangle : Nat → Nat :=</span>\n<span class=\"cm\">fun n =&gt;</span>\n<span class=\"cm\">  (let a := 0;</span>\n<span class=\"cm\">    do</span>\n<span class=\"cm\">    let r ←</span>\n<span class=\"cm\">      let col := { start := 0, stop := n, step := 1 };</span>\n<span class=\"cm\">        forIn col a fun i r =&gt;</span>\n<span class=\"cm\">          let a := r;</span>\n<span class=\"cm\">          let a := a + i;</span>\n<span class=\"cm\">          do</span>\n<span class=\"cm\">          pure PUnit.unit</span>\n<span class=\"cm\">          pure (ForInStep.yield a)</span>\n<span class=\"cm\">    let a : Nat := r</span>\n<span class=\"cm\">    pure a).run</span>\n<span class=\"cm\">-/</span>\n</code></pre></div>",
        "id": 463882930,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192736
    },
    {
        "content": "<p>In the infoview you can hover over things and option-click declarations (on mac, probably alt-click or ctrl-click on windows/linux) to go to their definitions.</p>",
        "id": 463883054,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192793
    },
    {
        "content": "<p>hmm, i still don't get the purpose of <code>do</code> in conjunction with <code>for</code> i think. this example function doesn't compile (i am not sure why) but i don't understand what kind of impurity <code>do</code> would be abstracting over with monads here if it did</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"o\">:=</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"this\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"no-op\"</span>\n<span class=\"w\">  </span><span class=\"s2\">\"that\"</span>\n</code></pre></div>",
        "id": 463883231,
        "sender_full_name": "JJ",
        "timestamp": 1724192891
    },
    {
        "content": "<p>That doesn't compile because <code>for</code> syntax is only allowed inside <code>do</code> blocks, and there is no <code>do</code> on the first line</p>",
        "id": 463883308,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724192935
    },
    {
        "content": "<p>Perhaps you want</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Id</span><span class=\"bp\">.</span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"this\"</span>\n<span class=\"w\">  </span><span class=\"n\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"o\">:</span><span class=\"mi\">5</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"no-op\"</span>\n<span class=\"w\">  </span><span class=\"s2\">\"that\"</span>\n</code></pre></div>",
        "id": 463883380,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724192985
    },
    {
        "content": "<p>ah, and that's what <code>Id.run do</code> is useful for, i see</p>",
        "id": 463883385,
        "sender_full_name": "JJ",
        "timestamp": 1724192988
    },
    {
        "content": "<p>In principle there could be <code>for</code> syntax outside of <code>do</code>, but it's just not defined.</p>",
        "id": 463883388,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724192988
    },
    {
        "content": "<p>Right click a working <code>for</code> and \"go to declaration\". You'll see that it's defined to be a <code>doElem</code>.</p>",
        "id": 463883474,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193013
    },
    {
        "content": "<p>It would be pretty useless outside <code>do</code>, right? Without any side-effects or <code>let mut</code>, I don't know what the syntax would do.</p>",
        "id": 463883532,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724193036
    },
    {
        "content": "<p>Yeah, I was going to followup and say a <code>term</code> version of <code>for</code> would be useless.</p>",
        "id": 463883568,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193053
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/option.20propagation.20operator/near/463883474\">said</a>:</p>\n<blockquote>\n<p>Right click a working <code>for</code> and \"go to declaration\". You'll see that it's defined to be a <code>doElem</code>.</p>\n</blockquote>\n<p>Can this be fixed? Surely it should jump to some information about <code>for</code>?</p>",
        "id": 463883588,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724193066
    },
    {
        "content": "<p>(it jumps to <code>doFor</code> for me)</p>",
        "id": 463883663,
        "sender_full_name": "JJ",
        "timestamp": 1724193101
    },
    {
        "content": "<p>Same for me</p>",
        "id": 463883666,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193102
    },
    {
        "content": "<p>Ah sorry, I misunderstood</p>",
        "id": 463883752,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724193136
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/option.20propagation.20operator/near/463883532\">said</a>:</p>\n<blockquote>\n<p>It would be pretty useless outside <code>do</code>, right? Without any side-effects or <code>let mut</code>, I don't know what the syntax would do.</p>\n</blockquote>\n<p>ah, because you can't return from it, got it. that's interesting. i forgot how mutable-state-oriented my expectations are</p>",
        "id": 463883795,
        "sender_full_name": "JJ",
        "timestamp": 1724193178
    },
    {
        "content": "<p>Right, <code>return</code> is also part of the magic of <code>do</code> notation</p>",
        "id": 463883818,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724193193
    },
    {
        "content": "<p>You can think of <code>do</code> as being an imperative-&gt;functional mini-compiler.</p>",
        "id": 463883858,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193212
    },
    {
        "content": "<blockquote>\n<p>It's great not having to think about the details of this pretty much at all</p>\n</blockquote>\n<p>The missing piece here I think are reader monads, unless there's some syntax I'm unaware of to enter a new context</p>\n<p>edit: I've made a <a href=\"#narrow/stream/270676-lean4/topic/do.20notation.20for.20reader.20monads/near/463884379\">new thread</a></p>",
        "id": 463883890,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1724193239
    },
    {
        "content": "<p>so just to clarify though: <code>for</code> do is actually part of the <code>for</code> syntax and not a regular <code>do</code> right?</p>",
        "id": 463883995,
        "sender_full_name": "JJ",
        "timestamp": 1724193278
    },
    {
        "content": "<p>actually, is <code>do</code> used anywhere other than following a <code>:=</code>?</p>",
        "id": 463884018,
        "sender_full_name": "JJ",
        "timestamp": 1724193298
    },
    {
        "content": "<p>yes, the <code>do</code> in <code>for ... do</code> is part of the <code>for</code> syntax (but morally the <code>do</code> is the same <code>do</code>)</p>",
        "id": 463884043,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193314
    },
    {
        "content": "<p>You can use <code>do</code> anywhere that expects a term.</p>",
        "id": 463884058,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193327
    },
    {
        "content": "<p>It uses the expected type to figure out which monad it's for.</p>",
        "id": 463884088,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193352
    },
    {
        "content": "<p>Contrived example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"bp\">.</span><span class=\"n\">getD</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">;</span><span class=\"w\"> </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n</code></pre></div>",
        "id": 463884204,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193398
    },
    {
        "content": "<p>cool. thanks a bunch, this cleared up wayyy more than i even thought it would</p>",
        "id": 463884245,
        "sender_full_name": "JJ",
        "timestamp": 1724193420
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"634325\">JJ</span> has marked this topic as resolved.</p>",
        "id": 463884275,
        "sender_full_name": "Notification Bot",
        "timestamp": 1724193442
    },
    {
        "content": "<p>i might write up some of this for the docs</p>",
        "id": 463884310,
        "sender_full_name": "JJ",
        "timestamp": 1724193469
    },
    {
        "content": "<p>Just remember that a rite of passage is to write your own monad tutorial :-)  <span aria-label=\"burrito\" class=\"emoji emoji-1f32f\" role=\"img\" title=\"burrito\">:burrito:</span></p>",
        "id": 463884533,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724193573
    },
    {
        "content": "<p>actually, a last question about monads: when i have a <code>def foo : Option Foo := do</code> function, <code>return</code> expects a <code>Foo</code> always. how does one return <code>none</code> directly? is that <code>failure</code> or does <code>failure</code> do extra stuff too?</p>",
        "id": 463885272,
        "sender_full_name": "JJ",
        "timestamp": 1724193938
    },
    {
        "content": "<p>For <code>Option</code>, <code>failure</code> is actually just <code>none</code></p>",
        "id": 463885409,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194003
    },
    {
        "content": "<p>(Make sure to try using <code>none</code> on its own to see!)</p>",
        "id": 463885437,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194027
    },
    {
        "content": "<p>oh well i couldn't figure out how to use none directly in the monadic context! which is why i was curious</p>",
        "id": 463885494,
        "sender_full_name": "JJ",
        "timestamp": 1724194080
    },
    {
        "content": "<p>Notice also that the type of <code>none</code> is <code>{X} -&gt; Option X</code>, so it's perfect for a failure. It's able to return a computation of any type (namely, the \"there is no value\" value)</p>",
        "id": 463885572,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194105
    },
    {
        "content": "<p>Did you try literally replacing <code>failure</code> with <code>none</code>?</p>",
        "id": 463885588,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194118
    },
    {
        "content": "<p>oh... i tried replacing <code>failure</code> with <code>return none</code>, not <code>none</code></p>",
        "id": 463885678,
        "sender_full_name": "JJ",
        "timestamp": 1724194177
    },
    {
        "content": "<p>Yeah, you're not returning <code>none</code>, the computation step is <code>none</code> itself</p>",
        "id": 463885830,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194237
    },
    {
        "content": "<p>This is one of those things you get used to, but also maybe you can see why I wrote <code>failure</code> instead :-)</p>",
        "id": 463885961,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194297
    },
    {
        "content": "<p>yeah i wasn't expecting that to work! is that monad magic?</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">hello</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">foo</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Option</span><span class=\"w\"> </span><span class=\"n\">Bool</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"k\">with</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\">   </span><span class=\"c1\">-- this branch: Bool</span>\n<span class=\"w\">  </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">none</span><span class=\"w\">  </span><span class=\"c1\">-- this branch: Option Bool</span>\n</code></pre></div>",
        "id": 463886057,
        "sender_full_name": "JJ",
        "timestamp": 1724194338
    },
    {
        "content": "<p>there is a coercion from <code>A</code> to <code>Option A</code> which applies <code>some</code></p>",
        "id": 463886137,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724194389
    },
    {
        "content": "<p>Ah, that one is an interaction of a couple features, and arguably these shouldn't interact. (Mario just beat me with what was going to be my second sentence.)</p>",
        "id": 463886191,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194418
    },
    {
        "content": "<p>so not monad magic as much as <code>Option</code> magic specifically</p>",
        "id": 463886193,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724194418
    },
    {
        "content": "<p>oh, totally off topic but i was wondering about coersions. is there a class somewhere for those?</p>",
        "id": 463886223,
        "sender_full_name": "JJ",
        "timestamp": 1724194440
    },
    {
        "content": "<p>once upon a time there was monad magic which did \"auto-pure\" but that doesn't happen anymore</p>",
        "id": 463886274,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724194452
    },
    {
        "content": "<p>There are actually a bunch of classes for coercions, the main one users deal with is <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Coe#doc\">docs#Coe</a></p>",
        "id": 463886298,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724194475
    },
    {
        "content": "<p>see also the module doc on that page</p>",
        "id": 463886336,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1724194500
    },
    {
        "content": "<p>One last monad thing: you'll find both <code>pure x</code> and <code>return x</code>. They mean the same thing, sort of, but the second is for really returning. The difference can pop up in some contexts, where you have <code>do</code>s nested in other <code>do</code>s, and you might find you need to write <code>pure x</code> to avoid exiting early. If you move your cursor to the beginning of <code>return</code>, the <code>do</code> it exits is highlighted in VS Code.</p>",
        "id": 463886413,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194550
    },
    {
        "content": "<p>(In your <code>match</code>, I'd rather see <code>return true</code> or <code>pure true</code> to be explicit. It doesn't matter which in this case. For <code>Option</code>, the <code>pure</code> function is defined to be <code>some</code>.)</p>",
        "id": 463886536,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1724194598
    }
]