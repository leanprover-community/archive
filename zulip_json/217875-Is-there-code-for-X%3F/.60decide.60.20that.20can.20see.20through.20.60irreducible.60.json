[
    {
        "content": "<p>Is there a version of <code>decide</code> that can see through irreducible defs, similar to <code>rfl</code> (when it applies) and <code>native_decide</code>?</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Algebra</span><span class=\"bp\">.</span><span class=\"n\">Group</span><span class=\"bp\">.</span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">structure</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span>\n<span class=\"w\">  </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ℕ</span>\n<span class=\"w\">  </span><span class=\"n\">deriving</span><span class=\"w\"> </span><span class=\"n\">DecidableEq</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">LE</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"kn\">where</span><span class=\"w\"> </span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">n</span>\n\n<span class=\"kn\">instance</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">DecidableRel</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">@</span><span class=\"n\">LE</span><span class=\"bp\">.</span><span class=\"n\">le</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">intro</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">y</span>\n<span class=\"w\">  </span><span class=\"n\">exact</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">decLe</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">n</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">irreducible</span><span class=\"kd\">]</span><span class=\"w\"> </span><span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"n\">x</span><span class=\"bp\">.</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">^</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"bp\">⟩</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">9</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">native_decide</span><span class=\"w\">  </span><span class=\"c1\">-- Works, but is native_decide</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">9</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span><span class=\"w\">  </span><span class=\"c1\">-- Fails</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">9</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">rfl</span><span class=\"w\">  </span><span class=\"c1\">-- Fails</span>\n</code></pre></div>",
        "id": 467630003,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725474949
    },
    {
        "content": "<p>This seems to work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">9</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">with_unfolding_all</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 467631146,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725475239
    },
    {
        "content": "<p>I don't think <code>rfl</code> generally sees through irreducible defs. There's a (mis?)feature where if there are no free variables, it just asks the kernel to do the defeq check. The kernel doesn't know about transparency.</p>",
        "id": 467631333,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725475292
    },
    {
        "content": "<p>You can also do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">unseal</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">9</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">decide</span>\n</code></pre></div>",
        "id": 467631569,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725475351
    },
    {
        "content": "<p>In my actual application I have quite a large number of irreducible defs under the computation.</p>",
        "id": 467632186,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725475504
    },
    {
        "content": "<p>Is there any standard abbreviation for <code>with_unfolding_all decide</code>? It seems very standard to want “do the full computation but use only the kernel”.</p>",
        "id": 467632529,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725475577
    },
    {
        "content": "<p>Actually, I think I don’t understand something. My model of decide is that it tries to convert the expression into something computable, then it computes it. But decide should be able to do that first step without unfolding sqr. Why doesn’t it succeed and then pass to the kernel, which doesn’t know about transparency?</p>",
        "id": 467633017,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725475704
    },
    {
        "content": "<p><code>decide</code> checks that deciding works (using the elaborator's whnf) before passing it to the kernel</p>",
        "id": 467633203,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725475755
    },
    {
        "content": "<p>since tactics need to fail during elaboration time if it can't prove the goal</p>",
        "id": 467633278,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725475777
    },
    {
        "content": "<p>Plus, this lets you do <code>try decide</code> for example</p>",
        "id": 467633326,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725475790
    },
    {
        "content": "<p>We want <code>decide</code> to respect transparency so that you can control what it should try to unfold, so that <code>decide</code> can be used freely without worrying about it timing out on an effectively impossible problem (assuming you've hidden these large unfolding problems behind irreducible defs).</p>",
        "id": 467633941,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725475937
    },
    {
        "content": "<p>That makes sense, but it sounds like it would make <code>decide</code> significantly more than 2x slower than just doing the kernel evaluation twice. Is that right, and is there a way to minimize slowdown once I know the proofs work?</p>",
        "id": 467636585,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725476543
    },
    {
        "content": "<p>If you want, it's straightforward to make a <code>it_is_decided</code> tactic.</p>",
        "id": 467636930,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725476627
    },
    {
        "content": "<p>By the way, the kernel is faster than the elaborator, so it is probably not 2x.</p>",
        "id": 467637101,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725476657
    },
    {
        "content": "<p>That's why I thought it was &gt;2x: if kernel time is K, decide does initial elaborator work E &gt; K, then kernel work K at the end, so E + K &gt; 2K.</p>",
        "id": 467637474,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725476741
    },
    {
        "content": "<p>I'll look at the code for decide to get a sense.</p>",
        "id": 467637668,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725476780
    },
    {
        "content": "<p>Oh, I see, I was counting the elaborator whnf as the base for the factor because that's essential to the tactic interface.</p>",
        "id": 467638120,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725476897
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"it_is_decided!\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">closeMainGoalUsing</span><span class=\"w\"> </span><span class=\"ss\">`it_is_decided</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkDecideProof</span><span class=\"w\"> </span><span class=\"bp\">·</span><span class=\"o\">)</span>\n\n<span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">sqr</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">⟨</span><span class=\"mi\">3</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"bp\">≤</span><span class=\"w\"> </span><span class=\"bp\">⟨</span><span class=\"mi\">9</span><span class=\"bp\">⟩</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">it_is_decided!</span>\n</code></pre></div>",
        "id": 467638131,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725476900
    },
    {
        "content": "<p>This puts the onus on you that it really is true. If it's not, you get a kernel error.</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">example</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span><span class=\"w\"> </span><span class=\"n\">it_is_decided!</span>\n<span class=\"c1\">-- ^ error on `example` itself. \"application type mismatch\"</span>\n</code></pre></div>",
        "id": 467638464,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725477006
    },
    {
        "content": "<p>Is it possible to try the kernel evaluation one earlier time during elaboration, and produce a nicer error if that fails? Then we'd be (asymptotically) at a 2x hit over the bare metal version above. Or are kernel errors harder to recover from?</p>",
        "id": 467638859,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725477157
    },
    {
        "content": "<p>Alas even <code>it_is_decided!</code> fails due to <code>(kernel) deep recursion detected</code> in some of the places I had <code>native_decide</code>, so I'll have to look more closely later.</p>",
        "id": 467640217,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725477581
    },
    {
        "content": "<p>Yes:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Tactic</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"it_is_decided!\"</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">tactic</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">closeMainGoalUsing</span><span class=\"w\"> </span><span class=\"ss\">`it_is_decided</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"c1\">-- zeta reduce to eliminatate dependencies on local definitions</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">zetaReduce</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">instantiateMVars</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"o\">)</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"bp\">.</span><span class=\"n\">hasFVar</span><span class=\"w\"> </span><span class=\"bp\">||</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"bp\">.</span><span class=\"n\">hasMVar</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"expected type must not contain free or meta variables{indentExpr expectedType}\"</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">false</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">ofExceptKernelException</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span>\n<span class=\"w\">      </span><span class=\"n\">Kernel</span><span class=\"bp\">.</span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getEnv</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">{}</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkDecide</span><span class=\"w\"> </span><span class=\"n\">expectedType</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">.</span><span class=\"n\">const</span><span class=\"w\"> </span><span class=\"ss\">``true</span><span class=\"w\"> </span><span class=\"o\">[])</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">    </span><span class=\"n\">throwError</span><span class=\"w\"> </span><span class=\"s2\">\"decidable instance does not reduce to true\"</span>\n<span class=\"w\">  </span><span class=\"n\">mkDecideProof</span><span class=\"w\"> </span><span class=\"n\">expectedType</span>\n</code></pre></div>",
        "id": 467640232,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1725477587
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 467640354,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1725477617
    }
]