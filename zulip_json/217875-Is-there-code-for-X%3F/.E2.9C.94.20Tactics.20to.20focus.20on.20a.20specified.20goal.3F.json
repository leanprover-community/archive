[
    {
        "content": "<p>In a tactic proof, when there are multiple goals open, what tactics are there to specify one of them and then focus on that as the main goal?</p>\n<p>The documentation for <code>show</code> sounds like it should do exactly this — <em>“<code>show t</code> finds the first goal whose target unifies with <code>t</code>. It makes that the main goal, performs the unification, and replaces the target with the unified version of <code>t</code>.”</em> — but for me it only seems to allow picking the first open goal, as seen in the following example:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">mwe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">himp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">himp</span>\n<span class=\"w\">  </span><span class=\"c\">/-</span><span class=\"cm\"> `show q` here fails with “type mismatch: this has type q : Prop but is expected to have type p : Prop” -/</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n<span class=\"w\">  </span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hq</span>\n</code></pre></div>\n<p>Am I misusing <code>show</code> somehow, or misunderstanding its documentation?</p>\n<p>The only tactic I’ve found for picking out a goal like this is <code>case</code>, where you specify the desired goal by its name.  This is great in some situations, especially of course actual recursion/match/case splits — but when the parallel goals arise from applying lemmas with multiple hypotheses, their goal names are often auto-generated and unintuitive, and sometimes not even unique (as in this mwe, both get called <code>a</code>) — so focusing by goal name in these cases seems, at best, fragile and not very readable.</p>\n<p>Focusing by the goal target like <code>show</code> seems to promise would be ideal — readable and robust in almost all cases.  Another nice option would be a way to specify the goal by number/position, which is what I’m used to from Coq (where e.g. <code>4: </code> focuses on the 4th open subgoal) — reasonably robust and readable in many of the situations where specifying by goal name isn’t.</p>",
        "id": 503277346,
        "sender_full_name": "Peter LeFanu Lumsdaine",
        "timestamp": 1741097440
    },
    {
        "content": "<p>Hmm, I think lean 3 <code>show</code> did that, but lean 4 doesn't</p>",
        "id": 503278450,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741097694
    },
    {
        "content": "<p>Does <code>on_goal n =&gt;</code> do what you want?</p>",
        "id": 503278639,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741097738
    },
    {
        "content": "<p><code>on_goal</code> is close and works for some use-cases!  But it has slightly different behaviour from <code>case</code> and <code>show</code> — it applies a tactic bloc to the specified goal, but it doesn’t focus on it in the sense of expecting the goal to be solved.</p>",
        "id": 503280435,
        "sender_full_name": "Peter LeFanu Lumsdaine",
        "timestamp": 1741098194
    },
    {
        "content": "<p>There's also <code>rotate n</code>, as I recall</p>",
        "id": 503280519,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741098214
    },
    {
        "content": "<p>Aha, yes — <code>rotate_left</code>, <code>rotate_right</code> do effectively allow picking out a goal by number.  Thanks, I hadn’t found those!  (Though I’m intrigued by the design choice: what are the use-cases where one really wants to rotate the whole goal list?)</p>",
        "id": 503282716,
        "sender_full_name": "Peter LeFanu Lumsdaine",
        "timestamp": 1741098731
    },
    {
        "content": "<p>and <code>rotate</code> helped me find this relevant older thread: <a href=\"https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/rotate.html\">https://leanprover-community.github.io/archive/stream/287929-mathlib4/topic/rotate.html</a></p>",
        "id": 503282762,
        "sender_full_name": "Peter LeFanu Lumsdaine",
        "timestamp": 1741098747
    },
    {
        "content": "<p>which points up <code>pick_goal n</code> as giving what I’d hoped for focusing on the goal by number!</p>",
        "id": 503283175,
        "sender_full_name": "Peter LeFanu Lumsdaine",
        "timestamp": 1741098856
    },
    {
        "content": "<p>Oh, and this also works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mwe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">himp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">himp</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">goalp</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">goalq</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">goalq</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hq</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">goalp</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n</code></pre></div>",
        "id": 503283832,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741099027
    },
    {
        "content": "<p>That's probably better then going by index anyway</p>",
        "id": 503284041,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1741099079
    },
    {
        "content": "<p>Ah yes, that’s a good pattern I hadn’t thought of!   That and <code>pick_goal</code> together pretty much satisfy what I was after, though it would be even nicer if there were something that worked the way <code>show</code> claims to.</p>",
        "id": 503285658,
        "sender_full_name": "Peter LeFanu Lumsdaine",
        "timestamp": 1741099462
    },
    {
        "content": "<p>You can also do</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">PermuteGoals</span>\n\n<span class=\"kn\">theorem</span><span class=\"w\"> </span><span class=\"n\">mwe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">himp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">himp</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">goalp</span><span class=\"w\"> </span><span class=\"bp\">?</span><span class=\"n\">goalq</span>\n<span class=\"w\">  </span><span class=\"n\">on_goal</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hq</span><span class=\"w\">  </span><span class=\"c1\">-- now you are trapped!</span>\n<span class=\"w\">  </span><span class=\"n\">on_goal</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"bp\">·</span><span class=\"w\"> </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n</code></pre></div>",
        "id": 503285683,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1741099470
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/Tactics.20to.20focus.20on.20a.20specified.20goal.3F/near/503278450\">said</a>:</p>\n<blockquote>\n<p>Hmm, I think lean 3 <code>show</code> did that, but lean 4 doesn't</p>\n</blockquote>\n<p>The code for <code>show</code> <a href=\"https://github.com/leanprover/lean4/blob/69a1d0485e241a494d69d3e2c98ad988f4396dcd/src/Init/Tactics.lean#L793-L797\">here</a> has a comment <code>-- TODO: fix, see comment</code> suggesting this is not intended</p>",
        "id": 503328438,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1741110537
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/batteries/blob/main/Batteries/Tactic/Case.lean#L34\">https://github.com/leanprover-community/batteries/blob/main/Batteries/Tactic/Case.lean#L34</a></p>\n<p>Batteries has a <code>case _ : t =&gt; ...</code> tactic that's a structured version of what <code>show</code>'s docstring claims to do.</p>",
        "id": 503353259,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741118512
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Common</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Batteries</span><span class=\"bp\">.</span><span class=\"n\">Tactic</span><span class=\"bp\">.</span><span class=\"n\">Case</span>\n\n<span class=\"kn\">lemma</span><span class=\"w\"> </span><span class=\"n\">mwe</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">Prop</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">himp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hp</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">hq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">r</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">by</span>\n<span class=\"w\">  </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">himp</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hq</span>\n<span class=\"w\">  </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">apply</span><span class=\"w\"> </span><span class=\"n\">hp</span>\n</code></pre></div>",
        "id": 503353586,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741118637
    },
    {
        "content": "<p>It looks like it's not imported by Mathlib. Seems reasonable to add it to <code>Mathlib.Tactic.Common</code>.</p>",
        "id": 503353691,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1741118661
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"285970\">Peter LeFanu Lumsdaine</span> has marked this topic as resolved.</p>",
        "id": 504138823,
        "sender_full_name": "Notification Bot",
        "timestamp": 1741366126
    }
]