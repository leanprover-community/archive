[
    {
        "content": "<p>so i was too bored so i made <code>f.3</code> work where <code>f : Nat × Nat × Nat</code> (the title is clickbait because it doesn't actually work with explicit <code>Prod.mk</code>, which i deemed there is no point in making it work because you would just write <code>5</code>)</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"bp\">.</span><span class=\"n\">MetavarContext</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"bp\">.</span><span class=\"n\">Init</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Meta</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span>\n\n<span class=\"c1\">-- this will fail for say (2, 3, 5, 7).4 because at that point there is no point</span>\n<span class=\"kn\">elab</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"o\">:</span><span class=\"n\">term</span><span class=\"s2\">\".\"</span><span class=\"n\">n</span><span class=\"o\">:</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"bp\">.</span><span class=\"n\">getNat</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">elabTerm</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">inferType</span><span class=\"w\"> </span><span class=\"n\">t</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">e</span>\n<span class=\"w\">  </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">mut</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"n\">while</span><span class=\"w\"> </span><span class=\"n\">true</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">m₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshExprMVar</span><span class=\"w\"> </span><span class=\"n\">none</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u₁</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshLevelMVar</span>\n<span class=\"w\">    </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">mkFreshLevelMVar</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">isDefEq</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkApp2</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Prod</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">u₁</span><span class=\"o\">,</span><span class=\"w\"> </span><span class=\"n\">u₂</span><span class=\"o\">])</span><span class=\"w\"> </span><span class=\"n\">m₁</span><span class=\"w\"> </span><span class=\"n\">m₂</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">      </span><span class=\"k\">let</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">some</span><span class=\"w\"> </span><span class=\"n\">c'</span><span class=\"w\"> </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">getExprMVarAssignment?</span><span class=\"w\"> </span><span class=\"n\">m₂</span><span class=\"bp\">.</span><span class=\"n\">mvarId!</span><span class=\"w\"> </span><span class=\"bp\">|</span><span class=\"w\"> </span><span class=\"n\">break</span>\n<span class=\"w\">      </span><span class=\"n\">curr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">c'</span>\n<span class=\"w\">      </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"n\">break</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"bp\">∨</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">&lt;</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">throwUnsupportedSyntax</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">e₁</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">rec</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"k\">fun</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"w\"> </span><span class=\"n\">ih</span><span class=\"w\"> </span><span class=\"bp\">↦</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">proj</span><span class=\"w\"> </span><span class=\"ss\">``Prod</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">ih</span>\n<span class=\"w\">  </span><span class=\"k\">have</span><span class=\"w\"> </span><span class=\"n\">e₂</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"bp\">=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"k\">then</span><span class=\"w\"> </span><span class=\"n\">e₁</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">proj</span><span class=\"w\"> </span><span class=\"ss\">``Prod</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">e₁</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"n\">e₂</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n\n<span class=\"kn\">def</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"bp\">×</span><span class=\"w\"> </span><span class=\"n\">Nat</span>\n\n<span class=\"kn\">variable</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"o\">)</span>\n\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"m\">1</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"m\">2</span>\n<span class=\"bp\">#</span><span class=\"n\">check</span><span class=\"w\"> </span><span class=\"n\">g</span><span class=\"bp\">.</span><span class=\"m\">3</span>\n</code></pre></div>",
        "id": 546796172,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271037
    },
    {
        "content": "<p>and this implementation has the flaw that it makes <code>g.1</code> and <code>g.2</code> ambiguous (the first one is avoidable)</p>",
        "id": 546796191,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271060
    },
    {
        "content": "<p>the second one can be worked-around by putting <code>(g.2 : Nat)</code></p>",
        "id": 546796300,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271138
    },
    {
        "content": "<p>or it can be fixed by changing the syntax to say <code>g.get2</code></p>",
        "id": 546796330,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271158
    },
    {
        "content": "<p>or some special hardcoding that only changes the syntax for <code>g.2</code> (it's unfair to change the rest just to fit <code>g.2</code>)</p>",
        "id": 546796345,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271179
    },
    {
        "content": "<p>I did this too</p>",
        "id": 546796429,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761271220
    },
    {
        "content": "<p>let me find it real quick</p>",
        "id": 546796440,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761271228
    },
    {
        "content": "<p>what was your solution to <code>g.2</code>?</p>",
        "id": 546796471,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271244
    },
    {
        "content": "<p>aha i can change the syntax to <code>g.%2</code></p>",
        "id": 546796603,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271326
    },
    {
        "content": "<p>i think this is good</p>",
        "id": 546796606,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271330
    },
    {
        "content": "<p><a href=\"#narrow/channel/116395-maths/topic/thoughts.20on.20elliptic.20curves/near/502148036\">https://leanprover.zulipchat.com/#narrow/channel/116395-maths/topic/thoughts.20on.20elliptic.20curves/near/502148036</a></p>",
        "id": 546796612,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761271332
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/.282.2C.203.2C.205.29.2E3/near/546796471\">said</a>:</p>\n<blockquote>\n<p>what was your solution to <code>g.2</code>?</p>\n</blockquote>\n<p>no solution, unfortunately</p>",
        "id": 546796662,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761271363
    },
    {
        "content": "<p>ah your solution was <code>g..2</code></p>",
        "id": 546796670,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271369
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> on Aaron's linked thread you mentioned that it's not a good idea, and then if I click your link I see Mario's justification of this opinion that x.3 can mean both x.2.1 and x.2.2, which does not apply in this case; do you still hold this belief that this is bad in general?</p>",
        "id": 546797257,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271729
    },
    {
        "content": "<p>The problem now is that x.2 can mean either x.2 or x.2.1 and this is the problem I have no good solution to</p>",
        "id": 546797502,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761271893
    },
    {
        "content": "<p>right, that's also a headache for me</p>",
        "id": 546797538,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271923
    },
    {
        "content": "<p>my current workarounds would be either</p>\n<ol>\n<li>just disable this, only allow <code>.$n</code> for n&gt;2</li>\n<li>or create special syntax just for 2, such as <code>.%2</code> (but keep <code>.3</code>)</li>\n<li>or make special syntax in general, such as <code>.%2</code> and <code>.%3</code></li>\n</ol>",
        "id": 546797617,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761271977
    },
    {
        "content": "<p>but i don't think this <code>.2</code> issue should just overrule the other <code>.3</code> <code>.4</code> <code>.5</code> that would be useful</p>",
        "id": 546797703,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761272041
    },
    {
        "content": "<p>but now x.3 can mean x.2.2 or x.2.2.1</p>",
        "id": 546797874,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761272144
    },
    {
        "content": "<p>this isn't just a problem with 2</p>",
        "id": 546797909,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761272161
    },
    {
        "content": "<p>i don't see why this is a problem, it means different things depending on the type of <code>x</code></p>",
        "id": 546797936,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761272182
    },
    {
        "content": "<p>unless we follow my polyvariable approach and enable say <code>.x .y .z</code> for \"this file locally\"</p>",
        "id": 546797977,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761272210
    },
    {
        "content": "<p><code>enable_prod_notation x y z</code></p>",
        "id": 546798003,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761272226
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110064\">Kenny Lau</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/.282.2C.203.2C.205.29.2E3/near/546797936\">said</a>:</p>\n<blockquote>\n<p>i don't see why this is a problem, it means different things depending on the type of <code>x</code></p>\n</blockquote>\n<p>It means specializing a free variable can change the meaning of the numbers</p>",
        "id": 546798024,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761272249
    },
    {
        "content": "<p>i see, that's a good point, but i think <code>enable_prod_notation</code> would solve this? at least for the elliptic curve case</p>",
        "id": 546798178,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761272368
    },
    {
        "content": "<p>oh I was thinking about more generality than just prod</p>",
        "id": 546798202,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761272389
    },
    {
        "content": "<p>i am aware of the limitations and have deliberately restricted to just <code>Prod</code></p>",
        "id": 546798226,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761272408
    },
    {
        "content": "<p>if it's just prod and you already know how long it is it shouldn't be a problem</p>",
        "id": 546798228,
        "sender_full_name": "Aaron Liu",
        "timestamp": 1761272411
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> if you're here, i think you'd be interested in this thread, what's your opinion in using some sort of notation to hide away the x.2.2.2.1 thing that appears when one works with iterated <code>Prod</code> types?</p>",
        "id": 546799170,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761273183
    },
    {
        "content": "<p><a href=\"https://github.com/search?q=repo%3Aleanprover-community%2Fmathlib4%20%22.2.2%22&amp;type=code\">https://github.com/search?q=repo%3Aleanprover-community%2Fmathlib4%20%22.2.2%22&amp;type=code</a></p>",
        "id": 546799247,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761273249
    },
    {
        "content": "<p>maybe the real usecase is actually <code>\\and</code> statements</p>",
        "id": 546799258,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761273258
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/JipQPZekiNX6woPFtXL_csF2/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/JipQPZekiNX6woPFtXL_csF2/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"771x243\" src=\"/user_uploads/thumbnail/3121/JipQPZekiNX6woPFtXL_csF2/image.png/840x560.webp\"></a></div>",
        "id": 546799516,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761273443
    },
    {
        "content": "<p>I have been biting my tongue in this thread, as what I want to say is: \"Kenny, you are so great at formalizing mathematics, please go and do that instead of introducing fragile and unhelpful notation, that fragments the ecosystem and increases maintenance burden.\"</p>",
        "id": 546799562,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761273483
    },
    {
        "content": "<p>i think one could make a very strong case for replacing these with <code>.%3</code> and <code>.%4</code>...</p>",
        "id": 546799565,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761273484
    },
    {
        "content": "<p>i.e. I personally think this would be a net negative, even before counting the opportunity cost of you doing something useful. :-)</p>",
        "id": 546799643,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1761273546
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/channel/217875-Is-there-code-for-X.3F/topic/.282.2C.203.2C.205.29.2E3/near/546799562\">said</a>:</p>\n<blockquote>\n<p>fragile</p>\n</blockquote>\n<p>what if ... <code>.%3</code> always elaborates to <code>.2.2.1</code> and <code>.%%3</code> will take the place of <code>.2.2</code></p>",
        "id": 546799796,
        "sender_full_name": "Kenny Lau",
        "timestamp": 1761273685
    },
    {
        "content": "<p>Personally, I think that if you want <code>.3</code> to work, then you should define your type to have (at least) 3 fields and let the third one by the one that you want to call <code>.3</code>.</p>\n<p>Touching the way <code>.n</code> works, in the best of cases, leads to not being sure of what projection you are getting.</p>",
        "id": 546848888,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1761297378
    }
]