[
    {
        "content": "<p>We have <code>run_cmd</code> for running commands in <code>CommandElabM</code>, and <code>run_meta</code> for running commands in <code>MetaM</code>. We also have <code>run_tac</code> for running a tactic in <code>TacticM</code> within a tactic block. Do we have anything similar for term elaborators? I want to be able to write <code>def f : Nat := elab_term do ...</code> and construct a term in <code>TermElabM</code> as an <code>Expr</code> explicitly.</p>",
        "id": 472528777,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1727194467
    },
    {
        "content": "<p>FWIW, I came up with this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"n\">Elab</span><span class=\"w\"> </span><span class=\"n\">Term</span><span class=\"w\"> </span><span class=\"k\">in</span>\n<span class=\"n\">elab</span><span class=\"w\"> </span><span class=\"s2\">\"elab_term\"</span><span class=\"w\"> </span><span class=\"n\">seq</span><span class=\"o\">:</span><span class=\"n\">doSeq</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">term</span><span class=\"w\"> </span><span class=\"bp\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">do</span>\n<span class=\"w\">  </span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"n\">unsafe</span><span class=\"w\"> </span><span class=\"n\">evalTerm</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">TermElabM</span><span class=\"w\"> </span><span class=\"n\">Expr</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkApp</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``TermElabM</span><span class=\"o\">)</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">mkConst</span><span class=\"w\"> </span><span class=\"ss\">``Expr</span><span class=\"o\">))</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">←</span><span class=\"w\"> </span><span class=\"bp\">`</span><span class=\"o\">(</span><span class=\"k\">do</span><span class=\"w\"> </span><span class=\"bp\">$</span><span class=\"n\">seq</span><span class=\"o\">))</span>\n\n<span class=\"kd\">def</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Nat</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">elab_term</span>\n<span class=\"w\">  </span><span class=\"n\">return</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">lit</span><span class=\"w\"> </span><span class=\"bp\">&lt;|</span><span class=\"w\"> </span><span class=\"bp\">.</span><span class=\"n\">natVal</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"n\">f</span>\n</code></pre></div>",
        "id": 472530742,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1727195154
    },
    {
        "content": "<p><del>There is already <code>run_elab</code>.</del> Sorry, different use case.</p>",
        "id": 472588505,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1727220874
    },
    {
        "content": "<p>Can you remind me what <code>run_cmd</code> and <code>run_meta</code> do that <code>#eval</code> doesn't?</p>",
        "id": 472588867,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727221208
    },
    {
        "content": "<p>I don’t know. I always end up using <code>#eval show MetaM Unit from do …</code> etc.</p>",
        "id": 472588939,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1727221285
    },
    {
        "content": "<p>Answering your question, I think it might be <code>elab%</code> (see <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.Elab.Command.elabElab#doc\">docs#Lean.Elab.Command.elabElab</a>)</p>",
        "id": 472589033,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727221330
    },
    {
        "content": "<p>(there's also mathlib's <code>eval%</code> for evaluating an expression and inserting the result, but that's not quite what you're asking)</p>",
        "id": 472589108,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727221410
    },
    {
        "content": "<p>Thats a command elab. Would that work for terms?</p>",
        "id": 472589129,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1727221429
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/run_term/near/472588867\">said</a>:</p>\n<blockquote>\n<p>Can you remind me what <code>run_cmd</code> and <code>run_meta</code> do that <code>#eval</code> doesn't?</p>\n</blockquote>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"n\">Lean</span>\n\n<span class=\"kd\">run_cmd</span><span class=\"w\"> </span><span class=\"n\">Lean.logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"works\"</span>\n<span class=\"n\">run_elab</span><span class=\"w\"> </span><span class=\"n\">Lean.logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"also works\"</span>\n<span class=\"n\">run_meta</span><span class=\"w\"> </span><span class=\"n\">Lean.logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"works again\"</span>\n\n\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab.Command.CommandElabM</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean.logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"works\"</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">Lean.Elab.Term.TermElabM</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\">  </span><span class=\"n\">Lean.logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"works but smaller span\"</span>\n<span class=\"k\">#eval</span><span class=\"w\"> </span><span class=\"k\">show</span><span class=\"w\"> </span><span class=\"n\">Lean.Meta.MetaM</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">from</span><span class=\"w\"> </span><span class=\"n\">Lean.logInfo</span><span class=\"w\"> </span><span class=\"s2\">\"does not work\"</span>\n</code></pre></div>",
        "id": 472589184,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727221446
    },
    {
        "content": "<p>The fact logInfo doesn't propagate from MetaM is a bug, I have my eye on fixing it.</p>",
        "id": 472589272,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727221544
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243562\">@Adam Topaz</span> Sorry about that last suggestion. Here it is for real: <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Lean.byElab#doc\">docs#Lean.byElab</a></p>",
        "id": 472589495,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727221708
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 472589544,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1727221760
    },
    {
        "content": "<p>I knew I had seen it before, but I couldn't remember the syntax. I got too excited when <code>elab%</code> matched anything <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>\n<p>It looks like there is also a full suite of <code>run_cmd</code>/<code>run_elab</code>/<code>run_meta</code> (I had thought these were in mathlib, not core)</p>",
        "id": 472589647,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1727221837
    },
    {
        "content": "<p>Should these be mentioned in the docstring of their corresponding monad types?</p>",
        "id": 472589940,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1727222060
    },
    {
        "content": "<p>I think that’s a good idea!</p>",
        "id": 472590276,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1727222357
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/217875-Is-there-code-for-X.3F/topic/run_term/near/472589647\">said</a>:</p>\n<blockquote>\n<p>It looks like there is also a full suite of <code>run_cmd</code>/<code>run_elab</code>/<code>run_meta</code> (I had thought these were in mathlib, not core)</p>\n</blockquote>\n<p>That happens a lot <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span> I originally added these to mathlib but I think <code>run_cmd</code> was wanted upstream and the others went along for the ride</p>",
        "id": 472591326,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1727223110
    }
]